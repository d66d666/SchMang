{"file_contents":{"src/components/AllowClassEntryModal.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { X, Send, DoorOpen } from 'lucide-react'\nimport { Teacher, Student } from '../types'\n\ninterface AllowClassEntryModalProps {\n  isOpen: boolean\n  onClose: () => void\n  student: Student | null\n}\n\nexport function AllowClassEntryModal({\n  isOpen,\n  onClose,\n  student,\n}: AllowClassEntryModalProps) {\n  const [teachers, setTeachers] = useState<Teacher[]>([])\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [counselorName, setCounselorName] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchTeachers()\n      fetchCounselorInfo()\n    }\n  }, [isOpen])\n\n  const fetchTeachers = async () => {\n    const { data } = await supabase\n      .from('teachers')\n      .select('*')\n      .order('name')\n\n    if (data) setTeachers(data)\n  }\n\n  const fetchCounselorInfo = async () => {\n    const { data } = await supabase\n      .from('teacher_profile')\n      .select('name, school_name')\n      .maybeSingle()\n\n    if (data) {\n      setCounselorName(data.name || '')\n      setSchoolName(data.school_name || '')\n    }\n  }\n\n  const handleSend = async () => {\n    if (!selectedTeacherId || !student) {\n      alert('الرجاء اختيار المعلم')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const teacher = teachers.find(t => t.id === selectedTeacherId)\n      if (!teacher) return\n\n      const currentDate = new Date().toLocaleDateString('ar-SA', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n        weekday: 'long'\n      })\n\n      const currentTime = new Date().toLocaleTimeString('ar-SA', {\n        hour: '2-digit',\n        minute: '2-digit'\n      })\n\n      // إنشاء رسالة السماح بالدخول\n      let message = `✅ *السماح بدخول الطالب للفصل*\\n\\n`\n      message += `اسم الطالب: *${student.name}*\\n\\n`\n      message += `المرسل: ${counselorName || 'المرشد الطلابي'}`\n\n      // فتح واتساب\n      const encodedMessage = encodeURIComponent(message)\n      const phoneNumber = teacher.phone.replace(/[^0-9]/g, '')\n      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`\n\n      window.open(whatsappUrl, '_blank')\n\n      onClose()\n    } catch (error) {\n      console.error('Error sending entry permission:', error)\n      alert('حدث خطأ أثناء الإرسال')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (!isOpen || !student) return null\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <DoorOpen className=\"text-white\" size={24} />\n            <h2 className=\"text-2xl font-bold text-white\">السماح بدخول الفصل</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-4 border-2 border-blue-200\">\n            <h3 className=\"font-bold text-blue-900 mb-2\">معلومات الطالب:</h3>\n            <div className=\"space-y-1 text-sm text-blue-900\">\n              <p><strong>الاسم:</strong> {student.name}</p>\n              <p><strong>السجل المدني:</strong> {student.national_id}</p>\n              <p><strong>الصف:</strong> {student.grade}</p>\n              <p><strong>المجموعة:</strong> {student.group?.name || '-'}</p>\n            </div>\n          </div>\n\n          <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n            <p className=\"text-sm text-blue-800\">\n              سيتم إرسال رسالة السماح بدخول الطالب للفصل إلى المعلم المختار عبر واتساب\n            </p>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المعلم\n            </label>\n            <select\n              value={selectedTeacherId}\n              onChange={(e) => setSelectedTeacherId(e.target.value)}\n              className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n            >\n              <option value=\"\">-- اختر المعلم --</option>\n              {teachers.map((teacher) => (\n                <option key={teacher.id} value={teacher.id}>\n                  {teacher.name} - {teacher.specialization} ({teacher.phone})\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\n            <h4 className=\"font-semibold text-gray-900 mb-2\">معاينة الرسالة:</h4>\n            <div className=\"text-sm text-gray-700 whitespace-pre-line space-y-2\">\n              <p className=\"text-blue-600 font-bold\">✅ السماح بدخول الطالب للفصل</p>\n              <p>اسم الطالب: <strong>{student.name}</strong></p>\n              <p>المرسل: {counselorName || 'المرشد الطلابي'}</p>\n            </div>\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              onClick={handleSend}\n              disabled={loading || !selectedTeacherId}\n              className=\"flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-400 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md\"\n            >\n              <Send size={20} />\n              {loading ? 'جاري الإرسال...' : 'إرسال عبر واتساب'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6547},"src/components/GroupSelector.tsx":{"content":"import { useState } from 'react'\nimport { Group } from '../types'\nimport { ChevronDown, ChevronUp, Layers } from 'lucide-react'\n\ninterface GroupSelectorProps {\n  groups: Group[]\n  selectedGroupId: string | null\n  onSelectGroup: (groupId: string | null) => void\n}\n\nexport function GroupSelector({\n  groups,\n  selectedGroupId,\n  onSelectGroup,\n}: GroupSelectorProps) {\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n\n  // Define stage order\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  // Sort stages by defined order\n  const sortedStages = Object.entries(groupedByStage).sort((a, b) => {\n    const orderA = stageOrder[a[0]] || 999\n    const orderB = stageOrder[b[0]] || 999\n    return orderA - orderB\n  })\n\n  const toggleStage = (stage: string) => {\n    setExpandedStages((prev) => {\n      const next = new Set(prev)\n      if (next.has(stage)) {\n        next.delete(stage)\n      } else {\n        next.add(stage)\n      }\n      return next\n    })\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <div className=\"space-y-2\">\n        <button\n          onClick={() => onSelectGroup(null)}\n          className={`w-full px-4 py-2 rounded-lg text-right font-medium transition-all ${\n            selectedGroupId === null\n              ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-md'\n              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n          }`}\n        >\n          جميع المجموعات\n        </button>\n\n        {sortedStages.map(([stage, stageGroups]) => {\n          const isExpanded = expandedStages.has(stage)\n          return (\n            <div key={stage} className=\"border border-gray-200 rounded-lg overflow-hidden\">\n              <button\n                onClick={() => toggleStage(stage)}\n                className=\"w-full px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold transition-all flex items-center justify-between shadow-sm\"\n              >\n                <div className=\"flex items-center gap-2\">\n                  <Layers size={18} className=\"text-white\" />\n                  <span>{stage}</span>\n                </div>\n                {isExpanded ? (\n                  <ChevronUp size={18} className=\"text-white\" />\n                ) : (\n                  <ChevronDown size={18} className=\"text-white\" />\n                )}\n              </button>\n\n              {isExpanded && (\n                <div className=\"bg-gray-50 p-2 space-y-1\">\n                  {stageGroups.map((group) => (\n                    <button\n                      key={group.id}\n                      onClick={() => onSelectGroup(group.id)}\n                      className={`w-full px-4 py-2 rounded-lg text-right font-medium transition-all ${\n                        selectedGroupId === group.id\n                          ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-md'\n                          : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'\n                      }`}\n                    >\n                      {group.name}\n                    </button>\n                  ))}\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","size_bytes":3644},"src/pages/GroupsPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student, Group, SpecialStatus } from '../types'\nimport { Users, Printer, UserPlus, X, Plus, ChevronDown, ChevronUp, Layers } from 'lucide-react'\n\nexport function GroupsPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [specialStatuses, setSpecialStatuses] = useState<SpecialStatus[]>([])\n  const [loading, setLoading] = useState(true)\n  const [schoolName, setSchoolName] = useState('')\n  const [teacherName, setTeacherName] = useState('')\n  const [selectedGroupId, setSelectedGroupId] = useState<string | null>(null)\n  const [showAddStudentModal, setShowAddStudentModal] = useState(false)\n  const [showManageGroupsModal, setShowManageGroupsModal] = useState(false)\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n  const [formData, setFormData] = useState({\n    name: '',\n    national_id: '',\n    phone: '',\n    guardian_phone: '',\n    grade: '',\n    special_status_id: '',\n  })\n  const [groupFormData, setGroupFormData] = useState({\n    stage: '',\n    name: '',\n  })\n  const [formError, setFormError] = useState('')\n  const [formLoading, setFormLoading] = useState(false)\n  const [showStatusDetails, setShowStatusDetails] = useState(false)\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  const fetchData = async () => {\n    try {\n      setLoading(true)\n      const [groupsData, studentsData, statusesData] = await Promise.all([\n        db.groups.toArray(),\n        db.students.toArray(),\n        db.special_statuses.toArray(),\n      ])\n\n      // Fetch school info from Supabase\n      const profileRes = await supabase.from('teacher_profile').select('*').maybeSingle()\n      if (profileRes.data) {\n        setSchoolName(profileRes.data.school_name || '')\n        setTeacherName(profileRes.data.name || '')\n      }\n\n      // Sort groups by stage and display_order\n      const sortedGroups = groupsData.sort((a, b) => {\n        const stageA = stageOrder[a.stage] || 999\n        const stageB = stageOrder[b.stage] || 999\n        if (stageA !== stageB) return stageA - stageB\n        return (a.display_order || 999) - (b.display_order || 999)\n      })\n      setGroups(sortedGroups)\n      setStudents(studentsData as Student[])\n      setSpecialStatuses(statusesData)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Define stage order\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  // Sort stages by defined order and sort groups within each stage\n  const sortedStages = Object.entries(groupedByStage)\n    .sort((a, b) => {\n      const orderA = stageOrder[a[0]] || 999\n      const orderB = stageOrder[b[0]] || 999\n      return orderA - orderB\n    })\n    .map(([stage, stageGroups]) => [\n      stage,\n      stageGroups.sort((a, b) => (a.display_order || 999) - (b.display_order || 999))\n    ] as [string, Group[]])\n\n  const toggleStage = (stage: string) => {\n    setExpandedStages((prev) => {\n      const next = new Set(prev)\n      if (next.has(stage)) {\n        next.delete(stage)\n      } else {\n        next.add(stage)\n      }\n      return next\n    })\n  }\n\n  const handlePrintAll = () => {\n    const currentDate = new Date().toLocaleDateString('ar-SA', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      weekday: 'long'\n    })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>جميع المجموعات</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }\n            .header h1 { color: #2563eb; margin-bottom: 10px; font-size: 32px; }\n            .header-info { color: #666; font-size: 16px; margin: 5px 0; }\n            .header-info strong { color: #333; }\n            h1 { text-align: center; color: #2563eb; margin-bottom: 30px; }\n            .stage-section { margin-bottom: 40px; }\n            .stage-title { color: #16a34a; font-size: 28px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #16a34a; }\n            .group-section { margin-bottom: 40px; page-break-after: always; }\n            .group-title { color: #2563eb; font-size: 24px; margin-bottom: 10px; }\n            .group-info { margin-bottom: 15px; color: #666; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #2563eb; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>${schoolName || 'اسم المدرسة'}</h1>\n            <p class=\"header-info\"><strong>المرشد الطلابي:</strong> ${teacherName || 'اسم المعلم'}</p>\n            <p class=\"header-info\"><strong>التاريخ:</strong> ${currentDate}</p>\n          </div>\n          <h2 style=\"text-align: center; color: #16a34a; margin-bottom: 30px;\">جميع المجموعات</h2>\n          ${sortedStages.map(([stage, stageGroups]) => `\n            <div class=\"stage-section\">\n              <h2 class=\"stage-title\">${stage}</h2>\n              ${stageGroups.map((group) => {\n                const groupStudents = students.filter(s => s.group_id === group.id)\n                return `\n                  <div class=\"group-section\">\n                    <h3 class=\"group-title\">${group.name}</h3>\n                    <p class=\"group-info\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n                    <table>\n                      <thead>\n                        <tr>\n                          <th>الاسم</th>\n                          <th>السجل المدني</th>\n                          <th>جوال الطالب</th>\n                          <th>جوال ولي الأمر</th>\n                          <th>الحالة الخاصة</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        ${groupStudents\n                          .map(\n                            (student) => {\n                              const status = specialStatuses.find(\n                                (s) => s.id === student.special_status_id\n                              )\n                              const statusText = student.special_status_id\n                                ? (showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة')\n                                : '-'\n                              return `\n                          <tr>\n                            <td>${student.name}</td>\n                            <td>${student.national_id}</td>\n                            <td>${student.phone}</td>\n                            <td>${student.guardian_phone}</td>\n                            <td>${statusText}</td>\n                          </tr>\n                        `\n                            }\n                          )\n                          .join('')}\n                      </tbody>\n                    </table>\n                  </div>\n                `\n              }).join('')}\n            </div>\n          `).join('')}\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handlePrint = (group: Group, groupStudents: Student[]) => {\n    const currentDate = new Date().toLocaleDateString('ar-SA', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      weekday: 'long'\n    })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>طلاب ${group.name}</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }\n            .header h1 { color: #2563eb; margin-bottom: 10px; font-size: 32px; }\n            .header-info { color: #666; font-size: 16px; margin: 5px 0; }\n            .header-info strong { color: #333; }\n            h1 { text-align: center; color: #2563eb; }\n            .stage { color: #16a34a; font-size: 20px; margin-bottom: 10px; text-align: center; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #2563eb; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>${schoolName || 'اسم المدرسة'}</h1>\n            <p class=\"header-info\"><strong>المرشد الطلابي:</strong> ${teacherName || 'اسم المعلم'}</p>\n            <p class=\"header-info\"><strong>التاريخ:</strong> ${currentDate}</p>\n          </div>\n          <p class=\"stage\">${group.stage}</p>\n          <h2 style=\"text-align: center; color: #2563eb; margin-bottom: 20px;\">قائمة طلاب ${group.name}</h2>\n          <p style=\"text-align: center; margin-bottom: 20px;\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n          <table>\n            <thead>\n              <tr>\n                <th>الاسم</th>\n                <th>السجل المدني</th>\n                <th>جوال الطالب</th>\n                <th>جوال ولي الأمر</th>\n                <th>الحالة الخاصة</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${groupStudents\n                .map(\n                  (student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    const statusText = student.special_status_id\n                      ? (showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة')\n                      : '-'\n                    return `\n                <tr>\n                  <td>${student.name}</td>\n                  <td>${student.national_id}</td>\n                  <td>${student.phone}</td>\n                  <td>${student.guardian_phone}</td>\n                  <td>${statusText}</td>\n                </tr>\n              `\n                  }\n                )\n                .join('')}\n            </tbody>\n          </table>\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handleAddStudent = (groupId: string) => {\n    setSelectedGroupId(groupId)\n    setShowAddStudentModal(true)\n    setFormData({\n      name: '',\n      national_id: '',\n      phone: '',\n      guardian_phone: '',\n      grade: '',\n      special_status_id: '',\n    })\n    setFormError('')\n  }\n\n  const handleCloseModal = () => {\n    setShowAddStudentModal(false)\n    setSelectedGroupId(null)\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setFormError('')\n\n    if (!formData.name || !formData.national_id || !selectedGroupId) {\n      setFormError('يرجى ملء جميع الحقول المطلوبة')\n      return\n    }\n\n    try {\n      setFormLoading(true)\n\n      const newId = crypto.randomUUID()\n      await db.students.add({\n        id: newId,\n        ...formData,\n        group_id: selectedGroupId,\n        special_status_id: formData.special_status_id || null,\n        status: 'نشط',\n        visit_count: 0,\n        permission_count: 0,\n        violation_count: 0,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString(),\n      } as any)\n\n      handleCloseModal()\n      fetchData()\n    } catch (err) {\n      setFormError(err instanceof Error ? err.message : 'حدث خطأ')\n    } finally {\n      setFormLoading(false)\n    }\n  }\n\n  const handleAddGroup = async () => {\n    if (!groupFormData.stage || !groupFormData.name) {\n      alert('يرجى ملء جميع الحقول')\n      return\n    }\n\n    try {\n      const newId = crypto.randomUUID()\n      await db.groups.add({\n        id: newId,\n        stage: groupFormData.stage,\n        name: groupFormData.name,\n        created_at: new Date().toISOString(),\n      })\n\n      setGroupFormData({ stage: '', name: '' })\n      fetchData()\n      alert('تم إضافة المجموعة بنجاح')\n    } catch (error) {\n      console.error('Error adding group:', error)\n      alert('حدث خطأ أثناء إضافة المجموعة')\n    }\n  }\n\n  const handleDeleteGroup = async (groupId: string) => {\n    const studentsInGroup = students.filter(s => s.group_id === groupId)\n\n    if (studentsInGroup.length > 0) {\n      alert('لا يمكن حذف مجموعة تحتوي على طلاب. يرجى نقل الطلاب أولاً.')\n      return\n    }\n\n    if (confirm('هل أنت متأكد من حذف هذه المجموعة؟')) {\n      try {\n        await db.groups.delete(groupId)\n        fetchData()\n        alert('تم حذف المجموعة بنجاح')\n      } catch (error) {\n        console.error('Error deleting group:', error)\n        alert('حدث خطأ أثناء حذف المجموعة')\n      }\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-2xl shadow-lg p-6 border border-gray-200\">\n        <div className=\"flex items-center justify-between flex-wrap gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <button\n              onClick={handlePrintAll}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-semibold hover:from-cyan-700 hover:to-blue-700 transition-all hover:shadow-lg\"\n            >\n              <Printer size={20} />\n              <span>طباعة الكل</span>\n            </button>\n            <button\n              onClick={() => setShowManageGroupsModal(true)}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl font-semibold hover:from-emerald-700 hover:to-teal-700 transition-all hover:shadow-lg\"\n            >\n              <Layers size={20} />\n              <span>إدارة المجموعات</span>\n            </button>\n          </div>\n          <label className=\"flex items-center gap-3 bg-gradient-to-r from-purple-50 to-pink-50 px-4 py-3 rounded-xl cursor-pointer hover:from-purple-100 hover:to-pink-100 transition-all border-2 border-purple-200\">\n            <input\n              type=\"checkbox\"\n              checked={showStatusDetails}\n              onChange={(e) => setShowStatusDetails(e.target.checked)}\n              className=\"w-5 h-5 rounded cursor-pointer\"\n            />\n            <span className=\"text-purple-700 font-semibold\">إظهار تفاصيل الحالة</span>\n          </label>\n        </div>\n      </div>\n\n      {Object.keys(groupedByStage).length === 0 ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n          <Users className=\"mx-auto mb-4 text-gray-300\" size={64} />\n          <h3 className=\"text-xl font-bold text-gray-700 mb-2\">لا توجد مجموعات</h3>\n          <p className=\"text-gray-500\">قم بإضافة مجموعات من خلال زر \"إدارة المجموعات\"</p>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {sortedStages.map(([stage, stageGroups]) => {\n            const isExpanded = expandedStages.has(stage)\n            const totalStudents = stageGroups.reduce((sum, group) => {\n              return sum + students.filter(s => s.group_id === group.id).length\n            }, 0)\n\n            return (\n              <div key={stage} className=\"bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200\">\n                <button\n                  onClick={() => toggleStage(stage)}\n                  className=\"w-full bg-gradient-to-r from-emerald-500 to-teal-500 p-6 flex items-center justify-between hover:from-emerald-600 hover:to-teal-600 transition-all shadow-md\"\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <Layers size={28} className=\"text-white\" />\n                    <div className=\"text-right\">\n                      <h2 className=\"text-2xl font-bold text-white\">{stage}</h2>\n                      <p className=\"text-emerald-50 text-sm\">\n                        {stageGroups.length} مجموعة • {totalStudents} طالب\n                      </p>\n                    </div>\n                  </div>\n                  {isExpanded ? (\n                    <ChevronUp size={28} className=\"text-white\" />\n                  ) : (\n                    <ChevronDown size={28} className=\"text-white\" />\n                  )}\n                </button>\n\n                {isExpanded && (\n                  <div className=\"p-4 space-y-4\">\n                    {stageGroups.map((group) => {\n                      const groupStudents = students.filter(s => s.group_id === group.id)\n                      return (\n                        <div key={group.id} className=\"border-2 border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow\">\n                          <div className=\"bg-gradient-to-r from-cyan-500 to-blue-500 p-4 flex items-center justify-between\">\n                            <div>\n                              <h3 className=\"text-xl font-bold text-white\">{group.name}</h3>\n                              <p className=\"text-cyan-50 text-sm\">عدد الطلاب: {groupStudents.length}</p>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => handlePrint(group, groupStudents)}\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white text-cyan-700 rounded-lg font-semibold hover:bg-cyan-50 transition-all text-sm shadow-sm\"\n                              >\n                                <Printer size={18} />\n                                طباعة\n                              </button>\n                              <button\n                                onClick={() => handleAddStudent(group.id)}\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white text-cyan-700 rounded-lg font-semibold hover:bg-cyan-50 transition-all text-sm shadow-sm\"\n                              >\n                                <UserPlus size={18} />\n                                إضافة طالب\n                              </button>\n                            </div>\n                          </div>\n\n                          {groupStudents.length === 0 ? (\n                            <div className=\"p-8 text-center text-gray-500 bg-gray-50\">\n                              <Users className=\"mx-auto mb-2 text-gray-300\" size={36} />\n                              <p>لا يوجد طلاب في هذه المجموعة</p>\n                            </div>\n                          ) : (\n                            <div className=\"overflow-x-auto\">\n                              <table className=\"w-full\">\n                                <thead className=\"bg-gray-50 border-b-2 border-gray-200\">\n                                  <tr>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الاسم</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">السجل المدني</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال الطالب</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال ولي الأمر</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الحالة الخاصة</th>\n                                  </tr>\n                                </thead>\n                                <tbody className=\"divide-y divide-gray-200\">\n                                  {groupStudents.map((student) => {\n                                    const status = specialStatuses.find(\n                                      (s) => s.id === student.special_status_id\n                                    )\n                                    return (\n                                      <tr key={student.id} className=\"hover:bg-blue-50 transition-colors\">\n                                        <td className=\"px-4 py-3 text-sm font-medium text-gray-900\">\n                                          {student.name}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.national_id}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.phone}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.guardian_phone}\n                                        </td>\n                                        <td className=\"px-4 py-3\">\n                                          {student.special_status_id ? (\n                                            <span className=\"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800\">\n                                              {showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة'}\n                                            </span>\n                                          ) : (\n                                            <span className=\"text-gray-400\">-</span>\n                                          )}\n                                        </td>\n                                      </tr>\n                                    )\n                                  })}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n                        </div>\n                      )\n                    })}\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n\n      {showAddStudentModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"sticky top-0 bg-gradient-to-r from-cyan-600 to-blue-600 p-6 flex items-center justify-between\">\n              <h3 className=\"text-2xl font-bold text-white\">إضافة طالب جديد</h3>\n              <button\n                onClick={handleCloseModal}\n                className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n              {formError && (\n                <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg\">\n                  {formError}\n                </div>\n              )}\n\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الاسم الكامل *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"أدخل اسم الطالب\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    السجل المدني *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.national_id}\n                    onChange={(e) =>\n                      setFormData({ ...formData, national_id: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"رقم السجل المدني\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الصف\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.grade}\n                    onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"مثال: الأول متوسط\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    جوال الطالب\n                  </label>\n                  <input\n                    type=\"tel\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"05xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    جوال ولي الأمر\n                  </label>\n                  <input\n                    type=\"tel\"\n                    value={formData.guardian_phone}\n                    onChange={(e) =>\n                      setFormData({ ...formData, guardian_phone: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"05xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الحالة الخاصة\n                  </label>\n                  <select\n                    value={formData.special_status_id}\n                    onChange={(e) =>\n                      setFormData({ ...formData, special_status_id: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                  >\n                    <option value=\"\">لا يوجد</option>\n                    {specialStatuses.map((status) => (\n                      <option key={status.id} value={status.id}>\n                        {status.name}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              </div>\n\n              <div className=\"flex gap-3 pt-4\">\n                <button\n                  type=\"submit\"\n                  disabled={formLoading}\n                  className=\"flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-cyan-700 hover:to-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-md\"\n                >\n                  {formLoading ? 'جاري الحفظ...' : 'حفظ الطالب'}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCloseModal}\n                  className=\"px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-50 transition-colors\"\n                >\n                  إلغاء\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n\n      {showManageGroupsModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"sticky top-0 bg-gradient-to-r from-emerald-600 to-teal-600 p-6 flex items-center justify-between\">\n              <h3 className=\"text-2xl font-bold text-white\">إدارة المراحل والمجموعات</h3>\n              <button\n                onClick={() => setShowManageGroupsModal(false)}\n                className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-6\">\n              <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl p-6 border-2 border-emerald-200\">\n                <h4 className=\"text-lg font-bold text-gray-900 mb-4\">إضافة مجموعة جديدة</h4>\n                <div className=\"grid md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الصف (المرحلة)\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={groupFormData.stage}\n                      onChange={(e) => setGroupFormData({ ...groupFormData, stage: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"مثال: الصف الأول الثانوي\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      اسم المجموعة\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={groupFormData.name}\n                      onChange={(e) => setGroupFormData({ ...groupFormData, name: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"مثال: مجموعة 1\"\n                    />\n                  </div>\n                </div>\n                <button\n                  onClick={handleAddGroup}\n                  className=\"mt-4 w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 shadow-md\"\n                >\n                  <Plus size={20} />\n                  إضافة المجموعة\n                </button>\n              </div>\n\n              <div>\n                <h4 className=\"text-lg font-bold text-gray-900 mb-4\">المجموعات الحالية</h4>\n                {Object.entries(groupedByStage).map(([stage, stageGroups]) => (\n                  <div key={stage} className=\"mb-6\">\n                    <h5 className=\"text-md font-bold text-emerald-800 mb-3 flex items-center gap-2 bg-gradient-to-r from-emerald-100 to-teal-100 px-4 py-2 rounded-lg\">\n                      <Layers size={20} />\n                      {stage}\n                    </h5>\n                    <div className=\"grid md:grid-cols-2 gap-3\">\n                      {stageGroups.map((group) => {\n                        const studentCount = students.filter(s => s.group_id === group.id).length\n                        return (\n                          <div\n                            key={group.id}\n                            className=\"bg-gray-50 rounded-lg p-4 flex items-center justify-between border border-gray-200\"\n                          >\n                            <div>\n                              <p className=\"font-semibold text-gray-900\">{group.name}</p>\n                              <p className=\"text-sm text-gray-600\">{studentCount} طالب</p>\n                            </div>\n                            <button\n                              onClick={() => handleDeleteGroup(group.id)}\n                              disabled={studentCount > 0}\n                              className=\"text-red-600 hover:text-red-700 disabled:text-gray-400 disabled:cursor-not-allowed\"\n                              title={studentCount > 0 ? 'لا يمكن حذف مجموعة تحتوي على طلاب' : 'حذف المجموعة'}\n                            >\n                              <X size={20} />\n                            </button>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","size_bytes":34378},"src/pages/SpecialStatusPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Student, Group, SpecialStatus } from '../types'\nimport { Heart, Printer, FileText, Send } from 'lucide-react'\nimport { SendToTeacherModal } from '../components/SendToTeacherModal'\n\nexport function SpecialStatusPage({\n  students,\n  groups,\n  specialStatuses,\n}: {\n  students: Student[]\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n}) {\n  const [labPhone, setLabPhone] = useState('')\n  const [showStatusDetails, setShowStatusDetails] = useState(false)\n  const [showSendToTeacherModal, setShowSendToTeacherModal] = useState(false)\n\n  useEffect(() => {\n    fetchLabContact()\n  }, [])\n\n  const fetchLabContact = async () => {\n    const { data } = await supabase\n      .from('lab_contact')\n      .select('*')\n      .maybeSingle()\n\n    if (data) {\n      setLabPhone(data.phone || '')\n    }\n  }\n\n  const studentsWithSpecialStatus = students.filter(\n    (s) => s.special_status_id !== null\n  )\n\n  const groupedData = groups.map((group) => {\n    const groupStudents = studentsWithSpecialStatus.filter(\n      (s) => s.group_id === group.id\n    )\n    return {\n      group,\n      students: groupStudents,\n      count: groupStudents.length,\n    }\n  })\n\n  const handlePrintAll = async () => {\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>جميع الحالات الخاصة</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h1 { text-align: center; color: #9333ea; margin-bottom: 10px; }\n            .meta { text-align: center; color: #666; font-size: 12px; margin-bottom: 30px; }\n            .group-section { margin-bottom: 40px; page-break-after: always; }\n            .group-title { color: #9333ea; font-size: 24px; margin-bottom: 10px; }\n            .group-info { margin-bottom: 15px; color: #666; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #9333ea; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <h1>جميع الحالات الخاصة</h1>\n          <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n          <p style=\"text-align: center; font-size: 18px; margin-bottom: 30px;\">\n            <strong>إجمالي الطلاب ذوي الحالات الخاصة: ${studentsWithSpecialStatus.length}</strong>\n          </p>\n          ${groupedData.filter(({ count }) => count > 0).map(({ group, students: groupStudents }) => `\n            <div class=\"group-section\">\n              <h2 class=\"group-title\">${group.name}</h2>\n              <p class=\"group-info\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n              <table>\n                <thead>\n                  <tr>\n                    <th>الاسم</th>\n                    <th>السجل المدني</th>\n                    <th>جوال الطالب</th>\n                    <th>جوال ولي الأمر</th>\n                    <th>الحالة الخاصة</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${groupStudents\n                    .map(\n                      (student) => {\n                        const status = specialStatuses.find(\n                          (s) => s.id === student.special_status_id\n                        )\n                        const statusText = showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'\n                        return `\n                    <tr>\n                      <td>${student.name}</td>\n                      <td>${student.national_id}</td>\n                      <td>${student.phone}</td>\n                      <td>${student.guardian_phone}</td>\n                      <td>${statusText}</td>\n                    </tr>\n                  `\n                      }\n                    )\n                    .join('')}\n                </tbody>\n              </table>\n            </div>\n          `).join('')}\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handlePrint = async (group: Group, groupStudents: Student[]) => {\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>الحالات الخاصة - ${group.name}</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h1 { text-align: center; color: #9333ea; }\n            .meta { text-align: center; color: #666; font-size: 12px; margin-bottom: 20px; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #9333ea; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <h1>الحالات الخاصة - ${group.name}</h1>\n          <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n          <p><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n          <table>\n            <thead>\n              <tr>\n                <th>الاسم</th>\n                <th>السجل المدني</th>\n                <th>جوال الطالب</th>\n                <th>جوال ولي الأمر</th>\n                <th>الحالة الخاصة</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${groupStudents\n                .map(\n                  (student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    return `\n                <tr>\n                  <td>${student.name}</td>\n                  <td>${student.national_id}</td>\n                  <td>${student.phone}</td>\n                  <td>${student.guardian_phone}</td>\n                  <td>${showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'}</td>\n                </tr>\n              `\n                  }\n                )\n                .join('')}\n            </tbody>\n          </table>\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-r from-purple-600 to-purple-500 rounded-2xl shadow-lg p-8 text-white\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n              <Heart size={32} />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold\">الحالات الخاصة</h1>\n              <p className=\"text-purple-100 text-lg mt-1\">\n                إجمالي الطلاب ذوي الحالات الخاصة: {studentsWithSpecialStatus.length}\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <button\n              onClick={() => setShowSendToTeacherModal(true)}\n              disabled={studentsWithSpecialStatus.length === 0}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <Send size={20} />\n              <span>إرسال للمعلم</span>\n            </button>\n            <button\n              onClick={handlePrintAll}\n              disabled={studentsWithSpecialStatus.length === 0}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <Printer size={20} />\n              <span>طباعة الكل</span>\n            </button>\n            <label className=\"flex items-center gap-3 bg-white bg-opacity-20 px-4 py-3 rounded-xl cursor-pointer hover:bg-opacity-30 transition-all\">\n              <input\n                type=\"checkbox\"\n                checked={showStatusDetails}\n                onChange={(e) => setShowStatusDetails(e.target.checked)}\n                className=\"w-5 h-5 rounded cursor-pointer\"\n              />\n              <span className=\"text-white font-semibold\">إظهار تفاصيل الحالة</span>\n            </label>\n          </div>\n        </div>\n      </div>\n\n      {groupedData.map(({ group, students: groupStudents, count }) => {\n        if (count === 0) return null\n\n        return (\n          <div\n            key={group.id}\n            className=\"bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200\"\n          >\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-500 p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-white mb-1\">{group.name}</h2>\n                  <p className=\"text-purple-100\">عدد الطلاب: {count}</p>\n                </div>\n                <button\n                  onClick={() => handlePrint(group, groupStudents)}\n                  className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md\"\n                >\n                  <Printer size={20} />\n                  <span>طباعة</span>\n                </button>\n              </div>\n            </div>\n\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead className=\"bg-gray-50 border-b-2 border-gray-200\">\n                  <tr>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      الاسم\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      السجل المدني\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      جوال الطالب\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      جوال ولي الأمر\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      الحالة الخاصة\n                    </th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-gray-200\">\n                  {groupStudents.map((student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    return (\n                      <tr key={student.id} className=\"hover:bg-purple-50 transition-colors\">\n                        <td className=\"px-6 py-4 text-sm font-medium text-gray-900\">\n                          {student.name}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.national_id}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.phone}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.guardian_phone}\n                        </td>\n                        <td className=\"px-6 py-4\">\n                          <span className=\"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800\">\n                            {showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'}\n                          </span>\n                        </td>\n                      </tr>\n                    )\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )\n      })}\n\n      {studentsWithSpecialStatus.length === 0 && (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200\">\n          <FileText className=\"mx-auto text-gray-300 mb-4\" size={64} />\n          <p className=\"text-gray-500 text-xl\">لا يوجد طلاب بحالات خاصة</p>\n        </div>\n      )}\n\n      <SendToTeacherModal\n        isOpen={showSendToTeacherModal}\n        onClose={() => setShowSendToTeacherModal(false)}\n        specialStatusStudents={studentsWithSpecialStatus}\n      />\n    </div>\n  )\n}\n","size_bytes":13913},"README.md":{"content":"Erchad\n","size_bytes":7},"src/components/ProfileSettings.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { X, Save, User, Trash2, AlertTriangle, Lock, Key } from 'lucide-react'\n\ninterface ProfileSettingsProps {\n  onClose: () => void\n}\n\nexport function ProfileSettings({ onClose }: ProfileSettingsProps) {\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n  const [teacherPhone, setTeacherPhone] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n  const [profileId, setProfileId] = useState('')\n  const [showResetConfirm, setShowResetConfirm] = useState(false)\n  const [resetLoading, setResetLoading] = useState(false)\n  const [showPasswordSection, setShowPasswordSection] = useState(false)\n  const [currentUsername, setCurrentUsername] = useState('')\n  const [newUsername, setNewUsername] = useState('')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmPassword, setConfirmPassword] = useState('')\n  const [passwordError, setPasswordError] = useState('')\n  const [passwordLoading, setPasswordLoading] = useState(false)\n\n  useEffect(() => {\n    fetchProfile()\n  }, [])\n\n  const fetchProfile = async () => {\n    try {\n      // جلب البروفايل من Supabase أولاً\n      const { data: supabaseProfile } = await supabase\n        .from('teacher_profile')\n        .select('*')\n        .maybeSingle()\n\n      // مزامنة مع IndexedDB\n      if (supabaseProfile) {\n        await db.teacher_profile.clear()\n        await db.teacher_profile.put(supabaseProfile)\n\n        setProfileId(supabaseProfile.id || '')\n        setTeacherName(supabaseProfile.name || '')\n        setTeacherPhone(supabaseProfile.phone || '')\n        setSchoolName(supabaseProfile.school_name || '')\n      } else {\n        // لو ما في بيانات في Supabase، نترك الحقول فاضية\n        setTeacherName('')\n        setTeacherPhone('')\n        setSchoolName('')\n      }\n\n      // Fetch current username from Supabase\n      const { data: credentials } = await supabase\n        .from('login_credentials')\n        .select('*')\n        .limit(1)\n        .maybeSingle()\n\n      if (credentials) {\n        setCurrentUsername(credentials.username)\n        setNewUsername(credentials.username)\n      }\n    } catch (error) {\n      console.error('Error fetching profile:', error)\n    }\n  }\n\n  const handleSave = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n\n    try {\n      const profileData = {\n        name: teacherName,\n        phone: teacherPhone,\n        school_name: schoolName,\n      }\n\n      if (profileId) {\n        // تحديث في Supabase\n        const { error: updateError } = await supabase\n          .from('teacher_profile')\n          .update(profileData)\n          .eq('id', profileId)\n\n        if (updateError) throw updateError\n\n        // تحديث في IndexedDB\n        await db.teacher_profile.update(profileId, profileData)\n      } else {\n        // إنشاء جديد في Supabase\n        const newId = crypto.randomUUID()\n        const newProfile = {\n          id: newId,\n          ...profileData,\n          created_at: new Date().toISOString(),\n        }\n\n        const { error: insertError } = await supabase\n          .from('teacher_profile')\n          .insert(newProfile)\n\n        if (insertError) throw insertError\n\n        // إضافة في IndexedDB\n        await db.teacher_profile.add(newProfile)\n        setProfileId(newId)\n      }\n\n      alert('تم حفظ البيانات بنجاح')\n      window.location.reload()\n      onClose()\n    } catch (error) {\n      console.error('Error saving profile:', error)\n      alert('حدث خطأ في حفظ البيانات')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleChangePassword = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setPasswordError('')\n\n    if (newPassword !== confirmPassword) {\n      setPasswordError('كلمة المرور غير متطابقة')\n      return\n    }\n\n    if (newPassword.length < 4) {\n      setPasswordError('كلمة المرور يجب أن تكون 4 أحرف على الأقل')\n      return\n    }\n\n    setPasswordLoading(true)\n\n    try {\n      // Get credentials from Supabase\n      const { data: credentials } = await supabase\n        .from('login_credentials')\n        .select('*')\n        .eq('username', currentUsername)\n        .maybeSingle()\n\n      if (credentials && credentials.id) {\n        // Update in Supabase\n        const { error: updateError } = await supabase\n          .from('login_credentials')\n          .update({\n            username: newUsername,\n            password_hash: newPassword,\n            updated_at: new Date().toISOString()\n          })\n          .eq('id', credentials.id)\n\n        if (updateError) throw updateError\n\n        // Update in IndexedDB\n        const localCreds = await db.login_credentials.where('username').equals(currentUsername).first()\n        if (localCreds && localCreds.id) {\n          await db.login_credentials.update(localCreds.id, {\n            username: newUsername,\n            password_hash: newPassword,\n            updated_at: new Date().toISOString()\n          })\n        }\n\n        alert('تم تغيير بيانات الدخول بنجاح!')\n        setCurrentUsername(newUsername)\n        setShowPasswordSection(false)\n        setNewPassword('')\n        setConfirmPassword('')\n      } else {\n        setPasswordError('لم يتم العثور على بيانات الدخول')\n      }\n    } catch (error) {\n      console.error('Error changing password:', error)\n      setPasswordError('حدث خطأ أثناء تغيير بيانات الدخول')\n    } finally {\n      setPasswordLoading(false)\n    }\n  }\n\n  const handleResetDatabase = async () => {\n    setResetLoading(true)\n    try {\n      // حذف جميع البيانات من Supabase\n      // نستخدم gt('created_at', '1900-01-01') عشان نتجاوز RLS ونحذف كل شي\n      const { error: violationsError } = await supabase.from('student_violations').delete().gt('created_at', '1900-01-01')\n      const { error: permissionsError } = await supabase.from('student_permissions').delete().gt('created_at', '1900-01-01')\n      const { error: visitsError } = await supabase.from('student_visits').delete().gt('created_at', '1900-01-01')\n      const { error: studentsError } = await supabase.from('students').delete().neq('id', '00000000-0000-0000-0000-000000000000')\n      const { error: teachersError } = await supabase.from('teachers').delete().neq('id', '00000000-0000-0000-0000-000000000000')\n      const { error: statusesError } = await supabase.from('special_statuses').delete().neq('id', '00000000-0000-0000-0000-000000000000')\n      const { error: groupsError } = await supabase.from('groups').delete().neq('id', '00000000-0000-0000-0000-000000000000')\n\n      // حذف جميع البيانات من IndexedDB (المحلي)\n      await db.students.clear()\n      await db.groups.clear()\n      await db.special_statuses.clear()\n      await db.student_visits.clear()\n      await db.student_permissions.clear()\n      await db.student_violations.clear()\n\n      // لو في أخطاء، نعرضها\n      const errors = [violationsError, permissionsError, visitsError, studentsError, teachersError, statusesError, groupsError].filter(e => e)\n      if (errors.length > 0) {\n        console.error('Errors during reset:', errors)\n        alert('تم حذف بعض البيانات ولكن حدثت بعض الأخطاء. جرب مرة أخرى.')\n        setShowResetConfirm(false)\n        window.location.reload()\n        return\n      }\n\n      alert('تم حذف جميع البيانات بنجاح! يمكنك الآن رفع ملف إكسل جديد.')\n      setShowResetConfirm(false)\n      onClose()\n      window.location.reload()\n    } catch (error) {\n      console.error('Error resetting database:', error)\n      alert('حدث خطأ أثناء حذف البيانات')\n    } finally {\n      setResetLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <User className=\"text-blue-600\" size={24} />\n            <h2 className=\"text-2xl font-bold text-gray-900\">الإعدادات</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <form onSubmit={handleSave} className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-6 space-y-4\">\n            <h3 className=\"text-xl font-bold text-gray-900 mb-4\">\n              معلومات الموجه الطلابي\n            </h3>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                اسم الموجه الطلابي\n              </label>\n              <input\n                type=\"text\"\n                value={teacherName}\n                onChange={(e) => setTeacherName(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"أدخل اسم الموجه الطلابي\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                رقم الجوال\n              </label>\n              <input\n                type=\"tel\"\n                value={teacherPhone}\n                onChange={(e) => setTeacherPhone(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"05xxxxxxxx\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                وصف النظام\n              </label>\n              <input\n                type=\"text\"\n                value={schoolName}\n                onChange={(e) => setSchoolName(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"مثال: نظام إدارة شاملة لبيانات الطلاب\"\n              />\n            </div>\n          </div>\n\n          <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <Lock className=\"text-green-600 flex-shrink-0 mt-1\" size={24} />\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-green-900 mb-2\">\n                  إعدادات تسجيل الدخول\n                </h3>\n                <p className=\"text-sm text-green-700 mb-4\">\n                  يمكنك تغيير اسم المستخدم وكلمة المرور من هنا\n                </p>\n\n                {!showPasswordSection ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowPasswordSection(true)}\n                    className=\"flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors\"\n                  >\n                    <Key size={18} />\n                    تغيير بيانات الدخول\n                  </button>\n                ) : (\n                  <div className=\"space-y-4 bg-white rounded-lg p-4 border border-green-200\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        اسم المستخدم الجديد\n                      </label>\n                      <input\n                        type=\"text\"\n                        value={newUsername}\n                        onChange={(e) => setNewUsername(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أدخل اسم المستخدم الجديد\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        كلمة المرور الجديدة\n                      </label>\n                      <input\n                        type=\"password\"\n                        value={newPassword}\n                        onChange={(e) => setNewPassword(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أدخل كلمة المرور الجديدة\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        تأكيد كلمة المرور\n                      </label>\n                      <input\n                        type=\"password\"\n                        value={confirmPassword}\n                        onChange={(e) => setConfirmPassword(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أعد إدخال كلمة المرور\"\n                        required\n                      />\n                    </div>\n\n                    {passwordError && (\n                      <div className=\"bg-red-50 border border-red-200 rounded-lg p-3\">\n                        <p className=\"text-sm text-red-800\">{passwordError}</p>\n                      </div>\n                    )}\n\n                    <div className=\"flex gap-2\">\n                      <button\n                        type=\"button\"\n                        onClick={handleChangePassword}\n                        disabled={passwordLoading}\n                        className=\"flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold disabled:opacity-50\"\n                      >\n                        {passwordLoading ? 'جاري التغيير...' : 'حفظ التغييرات'}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setShowPasswordSection(false)\n                          setPasswordError('')\n                          setNewPassword('')\n                          setConfirmPassword('')\n                          setNewUsername(currentUsername)\n                        }}\n                        className=\"px-4 py-2 border-2 border-gray-300 hover:border-gray-400 text-gray-700 rounded-lg font-semibold\"\n                      >\n                        إلغاء\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <AlertTriangle className=\"text-red-600 flex-shrink-0 mt-1\" size={24} />\n              <div>\n                <h3 className=\"text-xl font-bold text-red-900 mb-2\">\n                  تصفير قاعدة البيانات\n                </h3>\n                <p className=\"text-sm text-red-700 mb-4\">\n                  تحذير: سيتم حذف جميع البيانات بشكل نهائي (الطلاب، المعلمين، الفصول، الزيارات، الاستئذانات، المخالفات، الحالات الخاصة).\n                  هذا الإجراء لا يمكن التراجع عنه!\n                </p>\n                <p className=\"text-sm text-gray-700\">\n                  استخدم هذا الخيار في نهاية العام الدراسي لتصفير النظام والبدء من جديد.\n                </p>\n              </div>\n            </div>\n\n            {!showResetConfirm ? (\n              <button\n                type=\"button\"\n                onClick={() => setShowResetConfirm(true)}\n                className=\"w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n              >\n                <Trash2 size={20} />\n                تصفير قاعدة البيانات\n              </button>\n            ) : (\n              <div className=\"space-y-3\">\n                <div className=\"bg-yellow-100 border border-yellow-400 rounded-lg p-3\">\n                  <p className=\"text-sm font-bold text-yellow-900 text-center\">\n                    هل أنت متأكد من حذف جميع البيانات؟\n                  </p>\n                </div>\n                <div className=\"flex gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={handleResetDatabase}\n                    disabled={resetLoading}\n                    className=\"flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-3 rounded-lg transition-colors\"\n                  >\n                    {resetLoading ? 'جاري الحذف...' : 'نعم، احذف جميع البيانات'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowResetConfirm(false)}\n                    className=\"flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                  >\n                    إلغاء\n                  </button>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Save size={20} />\n              {loading ? 'جاري الحفظ...' : 'حفظ التغييرات'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":19112},"src/pages/ReceptionPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db, StudentVisit } from '../lib/db'\nimport { Student } from '../types'\nimport { UserCheck, Search, FileText, Printer, Send, Calendar, Filter } from 'lucide-react'\n\ninterface VisitWithStudent extends StudentVisit {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    visit_count: number\n  }\n}\n\nexport function ReceptionPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [visits, setVisits] = useState<VisitWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [formData, setFormData] = useState({\n    reason: '',\n    action_taken: '',\n    referred_to: 'لا يوجد' as const,\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchVisits()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    // جلب الطلاب من Supabase أولاً\n    const { data: supabaseStudents } = await supabase\n      .from('students')\n      .select('*')\n      .order('name')\n\n    // مزامنة مع IndexedDB\n    if (supabaseStudents && supabaseStudents.length > 0) {\n      await db.students.clear()\n      for (const student of supabaseStudents) {\n        await db.students.put(student)\n      }\n    }\n\n    // جلب المجموعات والحالات\n    const { data: supabaseGroups } = await supabase.from('groups').select('*')\n    const { data: supabaseStatuses } = await supabase.from('special_statuses').select('*')\n\n    // مزامنة المجموعات\n    if (supabaseGroups && supabaseGroups.length > 0) {\n      await db.groups.clear()\n      for (const group of supabaseGroups) {\n        await db.groups.put(group)\n      }\n    }\n\n    // مزامنة الحالات الخاصة\n    if (supabaseStatuses && supabaseStatuses.length > 0) {\n      await db.special_statuses.clear()\n      for (const status of supabaseStatuses) {\n        await db.special_statuses.put(status)\n      }\n    }\n\n    // قراءة من IndexedDB بعد المزامنة\n    const allStudents = await db.students.toArray()\n    const groups = await db.groups.toArray()\n    const statuses = await db.special_statuses.toArray()\n\n    const studentsWithRelations = allStudents.map(student => {\n      const group = groups.find(g => g.id === student.group_id)\n      const special_status = statuses.find(s => s.id === student.special_status_id)\n      return {\n        ...student,\n        group: group ? { name: group.name } : undefined,\n        special_status: special_status ? { name: special_status.name } : undefined\n      }\n    })\n\n    setStudents(studentsWithRelations as Student[])\n  }\n\n  async function fetchVisits(filterDate?: string) {\n    try {\n      let query = supabase\n        .from('student_visits')\n        .select('*')\n        .order('visit_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('visit_date', startOfDay.toISOString())\n          .lte('visit_date', endOfDay.toISOString())\n      } else {\n        query = query.limit(50)\n      }\n\n      const { data: visitsData } = await query\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const allStudents = studentsData || []\n\n      const visitsWithStudents = (visitsData || []).map((visit) => {\n        const student = allStudents.find(s => s.id === visit.student_id)\n        return {\n          ...visit,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            visit_count: student.visit_count || 0\n          } : undefined\n        }\n      })\n\n      setVisits(visitsWithStudents)\n\n      if (visitsData) {\n        await db.student_visits.bulkPut(visitsData.map(v => ({\n          id: v.id,\n          student_id: v.student_id,\n          visit_date: v.visit_date,\n          reason: v.reason,\n          action_taken: v.action_taken,\n          referred_to: v.referred_to,\n          notes: v.notes || '',\n          created_at: v.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error fetching visits:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const visitDate = new Date().toISOString()\n      const currentCount = selectedStudent.visit_count || 0\n\n      const { data: visitData, error: visitError } = await supabase\n        .from('student_visits')\n        .insert({\n          student_id: selectedStudent.id,\n          visit_date: visitDate,\n          reason: formData.reason,\n          action_taken: formData.action_taken,\n          referred_to: formData.referred_to,\n          notes: formData.notes\n        })\n        .select()\n        .single()\n\n      if (visitError) throw visitError\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ visit_count: currentCount + 1 })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) throw updateError\n\n      if (visitData) {\n        await db.student_visits.add({\n          id: visitData.id,\n          student_id: visitData.student_id,\n          visit_date: visitData.visit_date,\n          reason: visitData.reason,\n          action_taken: visitData.action_taken,\n          referred_to: visitData.referred_to,\n          notes: visitData.notes || '',\n          created_at: visitData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        visit_count: currentCount + 1\n      })\n\n      alert('تم تسجيل الزيارة بنجاح')\n      setFormData({ reason: '', action_taken: '', referred_to: 'لا يوجد', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchVisits(dateFilter)\n    } catch (error) {\n      console.error('Error saving visit:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  async function printVisit(visit: VisitWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>تقرير زيارة طالب</title>\n          <style>\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; }\n            .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }\n            .header h1 { margin: 0; color: #2563eb; }\n            .header .meta { color: #666; font-size: 12px; margin-top: 10px; }\n            .section { margin-bottom: 20px; }\n            .section label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }\n            .section div { padding: 10px; background: #f9fafb; border-radius: 5px; }\n            @media print { body { padding: 20px; } }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>تقرير زيارة طالب</h1>\n            <p>التاريخ: ${new Date(visit.visit_date).toLocaleString('ar-SA')}</p>\n            ${teacherName ? `<div class=\"meta\">بواسطة: ${teacherName}</div>` : ''}\n          </div>\n          <div class=\"section\">\n            <label>اسم الطالب:</label>\n            <div>${visit.student?.name}</div>\n          </div>\n          <div class=\"section\">\n            <label>السجل المدني:</label>\n            <div>${visit.student?.national_id}</div>\n          </div>\n          <div class=\"section\">\n            <label>سبب الزيارة:</label>\n            <div>${visit.reason}</div>\n          </div>\n          <div class=\"section\">\n            <label>الإجراء المتخذ:</label>\n            <div>${visit.action_taken}</div>\n          </div>\n          <div class=\"section\">\n            <label>التحويل إلى:</label>\n            <div>${visit.referred_to}</div>\n          </div>\n          ${visit.notes ? `\n          <div class=\"section\">\n            <label>ملاحظات:</label>\n            <div>${visit.notes}</div>\n          </div>\n          ` : ''}\n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  function sendWhatsApp(visit: VisitWithStudent) {\n    if (!visit.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${visit.student.name}\n\nنود إعلامكم بأن الطالب قد حضر إلى الإرشاد الطلابي بتاريخ: ${new Date(visit.visit_date).toLocaleDateString('ar-SA')}\n\nسبب الزيارة: ${visit.reason}\nالإجراء المتخذ: ${visit.action_taken}\n${visit.referred_to !== 'لا يوجد' ? `تم التحويل إلى: ${visit.referred_to}` : ''}\n\nللاستفسار يرجى التواصل مع الموجه الطلابي.\n\nمع تحيات إدارة المدرسة`\n\n    const phone = visit.student.guardian_phone.replace(/\\D/g, '')\n    const whatsappUrl = `https://wa.me/966${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <UserCheck size={28} className=\"text-blue-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">استقبال الطلاب</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-blue-600 font-semibold mt-1\">\n                      عدد الزيارات: {student.visit_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n                <h3 className=\"font-bold text-blue-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد الزيارات السابقة:</span>\n                    <span className=\"text-blue-600 font-bold mr-2\">{selectedStudent.visit_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  سبب الزيارة / المشكلة\n                </label>\n                <textarea\n                  required\n                  value={formData.reason}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب سبب الزيارة أو وصف المشكلة...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الإجراء المتخذ\n                </label>\n                <textarea\n                  required\n                  value={formData.action_taken}\n                  onChange={(e) => setFormData({ ...formData, action_taken: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  التحويل إلى\n                </label>\n                <select\n                  value={formData.referred_to}\n                  onChange={(e) => setFormData({ ...formData, referred_to: e.target.value as any })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                >\n                  <option value=\"لا يوجد\">لا يوجد</option>\n                  <option value=\"مشرف صحي\">مشرف صحي</option>\n                  <option value=\"وكيل\">وكيل</option>\n                  <option value=\"مدير\">مدير</option>\n                  <option value=\"معلم\">معلم</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل الزيارة'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <FileText size={24} />\n            سجل الزيارات {dateFilter ? 'المفلترة' : 'الأخيرة'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchVisits(dateFilter)}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchVisits()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-blue-600 font-semibold mt-3\">\n                عرض الزيارات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {visits.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد زيارات {dateFilter ? 'في هذا التاريخ' : ''}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {visits.map(visit => (\n            <div key={visit.id} className=\"border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors\">\n              <div className=\"flex justify-between items-start mb-3\">\n                <div>\n                  <h4 className=\"font-bold text-gray-800\">{visit.student?.name}</h4>\n                  <p className=\"text-sm text-gray-600\">\n                    {new Date(visit.visit_date).toLocaleString('ar-SA')}\n                  </p>\n                </div>\n                <div className=\"flex gap-2\">\n                  <button\n                    onClick={() => printVisit(visit)}\n                    className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                  >\n                    <Printer size={16} />\n                    طباعة\n                  </button>\n                  <button\n                    onClick={() => sendWhatsApp(visit)}\n                    className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                  >\n                    <Send size={16} />\n                    واتساب\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"space-y-2 text-sm\">\n                <div><span className=\"font-semibold\">السبب:</span> {visit.reason}</div>\n                <div><span className=\"font-semibold\">الإجراء:</span> {visit.action_taken}</div>\n                {visit.referred_to !== 'لا يوجد' && (\n                  <div className=\"text-orange-600 font-semibold\">\n                    تم التحويل إلى: {visit.referred_to}\n                  </div>\n                )}\n                {visit.notes && (\n                  <div className=\"text-gray-600\">\n                    <span className=\"font-semibold\">ملاحظات:</span> {visit.notes}\n                  </div>\n                )}\n              </div>\n            </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":21094},"src/lib/db.ts":{"content":"import Dexie, { Table } from 'dexie'\nimport { Student, Group, SpecialStatus, Teacher } from '../types'\n\nexport interface StudentVisit {\n  id?: string\n  student_id: string\n  visit_date: string\n  reason: string\n  action_taken: string\n  referred_to: string\n  notes?: string\n  created_at?: string\n}\n\nexport interface StudentPermission {\n  id?: string\n  student_id: string\n  permission_date: string\n  reason: string\n  guardian_notified?: boolean\n  notes?: string\n  created_at?: string\n}\n\nexport interface StudentViolation {\n  id?: string\n  student_id: string\n  violation_type: string\n  violation_date: string\n  description?: string\n  action_taken?: string\n  notes?: string\n  created_at?: string\n}\n\nexport interface TeacherProfile {\n  id?: string\n  name?: string\n  school_name?: string\n  logo_url?: string\n  created_at?: string\n}\n\nexport interface LoginCredentials {\n  id?: string\n  username: string\n  password_hash: string\n  reset_token?: string | null\n  reset_token_expires?: string | null\n  created_at?: string\n  updated_at?: string\n}\n\nexport class StudentsDatabase extends Dexie {\n  groups!: Table<Group>\n  students!: Table<Student>\n  special_statuses!: Table<SpecialStatus>\n  student_visits!: Table<StudentVisit>\n  student_permissions!: Table<StudentPermission>\n  student_violations!: Table<StudentViolation>\n  teacher_profile!: Table<TeacherProfile>\n  login_credentials!: Table<LoginCredentials>\n  teachers!: Table<Teacher>\n\n  constructor() {\n    super('StudentsDatabase')\n    this.version(5).stores({\n      groups: 'id, name, stage, display_order',\n      students: 'id, student_id, name, group_id, has_permission, special_status',\n      special_statuses: 'id, name',\n      student_visits: 'id, student_id, visit_date',\n      student_permissions: 'id, student_id, permission_date',\n      student_violations: 'id, student_id, violation_date',\n      teacher_profile: 'id',\n      login_credentials: 'id, username',\n      teachers: 'id, phone, name'\n    }).upgrade(trans => {\n      return trans.table('groups').toCollection().modify(group => {\n        if (group.display_order === undefined) {\n          group.display_order = 999\n        }\n      })\n    })\n  }\n}\n\nexport const db = new StudentsDatabase()\n\n// Initialize default login credentials\ndb.on('ready', async () => {\n  const count = await db.login_credentials.count()\n  if (count === 0) {\n    await db.login_credentials.add({\n      id: crypto.randomUUID(),\n      username: 'admin',\n      password_hash: 'admin123',\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString()\n    })\n  }\n})\n","size_bytes":2568},"src/vite-env.d.ts":{"content":"/// <reference types=\"vite/client\" />\n","size_bytes":38},"src/components/FiltersPanel.tsx":{"content":"import { SpecialStatus } from '../types'\nimport { ChevronDown } from 'lucide-react'\nimport { useState } from 'react'\n\ninterface FiltersPanelProps {\n  specialStatuses: SpecialStatus[]\n  filter: {\n    type: 'status' | 'special_status' | null\n    value: string\n  } | null\n  onFilterChange: (filter: any) => void\n}\n\nexport function FiltersPanel({\n  specialStatuses,\n  filter,\n  onFilterChange,\n}: FiltersPanelProps) {\n  const [isSpecialStatusOpen, setIsSpecialStatusOpen] = useState(false)\n  const [isStudentStatusOpen, setIsStudentStatusOpen] = useState(false)\n\n  const getSpecialStatusLabel = () => {\n    if (!filter || filter.type !== 'special_status') return 'الكل'\n    if (filter.value === 'none') return 'بدون حالة خاصة'\n    const status = specialStatuses.find((s) => s.id === filter.value)\n    return status?.name || 'الكل'\n  }\n\n  const getStudentStatusLabel = () => {\n    if (!filter || filter.type !== 'status') return 'الكل'\n    return filter.value\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <div className=\"space-y-3\">\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            الحالات الخاصة\n          </label>\n          <div className=\"relative\">\n            <button\n              onClick={() => setIsSpecialStatusOpen(!isSpecialStatusOpen)}\n              className=\"w-full px-3 py-2 border border-orange-300 rounded-lg text-right text-sm font-medium bg-orange-50 hover:bg-orange-100 flex items-center justify-between\"\n            >\n              <span>{getSpecialStatusLabel()}</span>\n              <ChevronDown\n                size={16}\n                className={`transition-transform ${isSpecialStatusOpen ? 'rotate-180' : ''}`}\n              />\n            </button>\n            {isSpecialStatusOpen && (\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto\">\n                <button\n                  onClick={() => {\n                    onFilterChange(null)\n                    setIsSpecialStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                    filter === null ? 'bg-orange-100 text-orange-800' : 'text-gray-700'\n                  }`}\n                >\n                  الكل\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'special_status', value: 'none' })\n                    setIsSpecialStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                    filter?.type === 'special_status' && filter?.value === 'none'\n                      ? 'bg-orange-100 text-orange-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  بدون حالة خاصة\n                </button>\n                {specialStatuses.map((status) => (\n                  <button\n                    key={status.id}\n                    onClick={() => {\n                      onFilterChange({ type: 'special_status', value: status.id })\n                      setIsSpecialStatusOpen(false)\n                    }}\n                    className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                      filter?.type === 'special_status' && filter?.value === status.id\n                        ? 'bg-orange-100 text-orange-800'\n                        : 'text-gray-700'\n                    }`}\n                  >\n                    {status.name}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            حالة الطالب\n          </label>\n          <div className=\"relative\">\n            <button\n              onClick={() => setIsStudentStatusOpen(!isStudentStatusOpen)}\n              className=\"w-full px-3 py-2 border border-teal-300 rounded-lg text-right text-sm font-medium bg-teal-50 hover:bg-teal-100 flex items-center justify-between\"\n            >\n              <span>{getStudentStatusLabel()}</span>\n              <ChevronDown\n                size={16}\n                className={`transition-transform ${isStudentStatusOpen ? 'rotate-180' : ''}`}\n              />\n            </button>\n            {isStudentStatusOpen && (\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10\">\n                <button\n                  onClick={() => {\n                    onFilterChange(null)\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter === null ? 'bg-teal-100 text-teal-800' : 'text-gray-700'\n                  }`}\n                >\n                  الكل\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'status', value: 'نشط' })\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter?.type === 'status' && filter?.value === 'نشط'\n                      ? 'bg-teal-100 text-teal-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  نشط\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'status', value: 'استئذان' })\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter?.type === 'status' && filter?.value === 'استئذان'\n                      ? 'bg-teal-100 text-teal-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  استئذان\n                </button>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6383},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n};\n","size_bytes":81},"src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  html {\n    scroll-behavior: smooth;\n  }\n\n  body {\n    @apply bg-gradient-to-br from-blue-50 to-indigo-50;\n  }\n}\n\n@layer components {\n  .btn-primary {\n    @apply px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors;\n  }\n\n  .btn-secondary {\n    @apply px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors;\n  }\n\n  .card {\n    @apply bg-white rounded-lg shadow-md;\n  }\n\n  .input-field {\n    @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;\n  }\n}\n","size_bytes":661},"src/components/StudentForm.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Group, SpecialStatus, Student } from '../types'\nimport { Plus, X } from 'lucide-react'\n\ninterface StudentFormProps {\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n  onStudentAdded: () => void\n  editingStudent?: Student\n  onEditingStudentChange: (student?: Student) => void\n}\n\nexport function StudentForm({\n  groups,\n  specialStatuses,\n  onStudentAdded,\n  editingStudent,\n  onEditingStudentChange,\n}: StudentFormProps) {\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [formData, setFormData] = useState({\n    name: '',\n    national_id: '',\n    phone: '',\n    guardian_phone: '',\n    grade: '',\n    group_id: '',\n    special_status_id: '',\n  })\n\n  useEffect(() => {\n    if (editingStudent) {\n      setFormData({\n        name: editingStudent.name,\n        national_id: editingStudent.national_id,\n        phone: editingStudent.phone,\n        guardian_phone: editingStudent.guardian_phone,\n        grade: editingStudent.grade,\n        group_id: editingStudent.group_id,\n        special_status_id: editingStudent.special_status_id || '',\n      })\n    }\n  }, [editingStudent])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      if (!formData.group_id) {\n        setError('يجب اختيار مجموعة')\n        setLoading(false)\n        return\n      }\n\n      const data = {\n        name: formData.name,\n        national_id: formData.national_id,\n        phone: formData.phone,\n        guardian_phone: formData.guardian_phone,\n        grade: formData.grade,\n        group_id: formData.group_id,\n        special_status_id: formData.special_status_id || null,\n      }\n\n      if (editingStudent) {\n        const { error: updateError } = await supabase\n          .from('students')\n          .update(data)\n          .eq('id', editingStudent.id)\n\n        if (updateError) throw updateError\n      } else {\n        const { error: insertError } = await supabase\n          .from('students')\n          .insert(data)\n\n        if (insertError) throw insertError\n      }\n\n      setFormData({\n        name: '',\n        national_id: '',\n        phone: '',\n        guardian_phone: '',\n        grade: '',\n        group_id: '',\n        special_status_id: '',\n      })\n      onEditingStudentChange(undefined)\n      onStudentAdded()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <h2 className=\"text-xl font-bold text-gray-800\">\n          {editingStudent ? 'تعديل الطالب' : 'إضافة طالب جديد'}\n        </h2>\n        {editingStudent && (\n          <button\n            onClick={() => onEditingStudentChange(undefined)}\n            className=\"text-gray-500 hover:text-gray-700\"\n          >\n            <X size={24} />\n          </button>\n        )}\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded\">\n          {error}\n        </div>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              اسم الطالب\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              السجل المدني\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.national_id}\n              onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              جوال الطالب\n            </label>\n            <input\n              type=\"tel\"\n              required\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              جوال ولي الأمر\n            </label>\n            <input\n              type=\"tel\"\n              required\n              value={formData.guardian_phone}\n              onChange={(e) => setFormData({ ...formData, guardian_phone: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              الصف\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.grade}\n              onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              المجموعة\n            </label>\n            <select\n              required\n              value={formData.group_id}\n              onChange={(e) => setFormData({ ...formData, group_id: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"\">اختر مجموعة</option>\n              {groups.map((group) => (\n                <option key={group.id} value={group.id}>\n                  {group.name}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              الحالة الخاصة (اختياري)\n            </label>\n            <select\n              value={formData.special_status_id}\n              onChange={(e) =>\n                setFormData({ ...formData, special_status_id: e.target.value })\n              }\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"\">بدون حالة خاصة</option>\n              {specialStatuses.map((status) => (\n                <option key={status.id} value={status.id}>\n                  {status.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        </div>\n\n        <button\n          type=\"submit\"\n          disabled={loading}\n          className=\"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2\"\n        >\n          <Plus size={20} />\n          {loading\n            ? 'جاري...'\n            : editingStudent\n              ? 'تحديث الطالب'\n              : 'إضافة الطالب'}\n        </button>\n      </form>\n    </div>\n  )\n}\n","size_bytes":7960},"src/pages/LoginPage.tsx":{"content":"import { useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db } from '../lib/db'\nimport { Lock, User, Eye, EyeOff, GraduationCap, AlertCircle } from 'lucide-react'\n\ninterface LoginPageProps {\n  onLogin: () => void\n}\n\nexport function LoginPage({ onLogin }: LoginPageProps) {\n  const [username, setUsername] = useState('')\n  const [password, setPassword] = useState('')\n  const [showPassword, setShowPassword] = useState(false)\n  const [error, setError] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [showForgotPassword, setShowForgotPassword] = useState(false)\n  const [resetToken, setResetToken] = useState('')\n  const [newPassword, setNewPassword] = useState('')\n  const [resetStep, setResetStep] = useState<'token' | 'password'>('token')\n  const [resetMessage, setResetMessage] = useState('')\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      // Check hidden master account first\n      if (username === 'Wael' && password === '0558890902') {\n        localStorage.setItem('isLoggedIn', 'true')\n        localStorage.setItem('userId', 'master-admin')\n        onLogin()\n        return\n      }\n\n      const { data, error: fetchError } = await supabase\n        .from('login_credentials')\n        .select('*')\n        .eq('username', username)\n        .eq('password_hash', password)\n        .maybeSingle()\n\n      if (fetchError) throw fetchError\n\n      if (!data) {\n        setError('اسم المستخدم أو كلمة المرور غير صحيحة')\n        return\n      }\n\n      localStorage.setItem('isLoggedIn', 'true')\n      localStorage.setItem('userId', data.id)\n      onLogin()\n    } catch (err) {\n      console.error('Login error:', err)\n      setError('حدث خطأ أثناء تسجيل الدخول')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const generateResetToken = async () => {\n    setError('')\n    setResetMessage('')\n    setLoading(true)\n\n    try {\n      const token = Math.random().toString(36).substring(2, 10).toUpperCase()\n      const expiresAt = new Date()\n      expiresAt.setHours(expiresAt.getHours() + 1)\n\n      // Get credentials from Supabase\n      const { data: credentials } = await supabase\n        .from('login_credentials')\n        .select('*')\n        .eq('username', username)\n        .maybeSingle()\n\n      if (!credentials || !credentials.id) {\n        setError('اسم المستخدم غير موجود')\n        return\n      }\n\n      // Update in Supabase\n      const { error: updateError } = await supabase\n        .from('login_credentials')\n        .update({\n          reset_token: token,\n          reset_token_expires: expiresAt.toISOString(),\n        })\n        .eq('id', credentials.id)\n\n      if (updateError) throw updateError\n\n      // Update in IndexedDB\n      const localCreds = await db.login_credentials.where('username').equals(username).first()\n      if (localCreds && localCreds.id) {\n        await db.login_credentials.update(localCreds.id, {\n          reset_token: token,\n          reset_token_expires: expiresAt.toISOString(),\n        })\n      }\n\n      setResetMessage(`رمز الاستعادة الخاص بك هو: ${token}\\n(صالح لمدة ساعة واحدة)`)\n      setResetStep('password')\n    } catch (err) {\n      console.error('Generate token error:', err)\n      setError('حدث خطأ أثناء إنشاء رمز الاستعادة')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleResetPassword = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setResetMessage('')\n    setLoading(true)\n\n    try {\n      // Get credentials from Supabase\n      const { data: credentials } = await supabase\n        .from('login_credentials')\n        .select('*')\n        .eq('username', username)\n        .eq('reset_token', resetToken)\n        .maybeSingle()\n\n      if (!credentials) {\n        setError('الرمز غير صحيح')\n        return\n      }\n\n      if (credentials.reset_token_expires) {\n        const tokenExpires = new Date(credentials.reset_token_expires)\n        if (tokenExpires < new Date()) {\n          setError('انتهت صلاحية الرمز')\n          return\n        }\n      }\n\n      if (credentials.id) {\n        // Update in Supabase\n        const { error: updateError } = await supabase\n          .from('login_credentials')\n          .update({\n            password_hash: newPassword,\n            reset_token: null,\n            reset_token_expires: null,\n            updated_at: new Date().toISOString()\n          })\n          .eq('id', credentials.id)\n\n        if (updateError) throw updateError\n\n        // Update in IndexedDB\n        const localCreds = await db.login_credentials.where('username').equals(username).first()\n        if (localCreds && localCreds.id) {\n          await db.login_credentials.update(localCreds.id, {\n            password_hash: newPassword,\n            reset_token: null,\n            reset_token_expires: null,\n            updated_at: new Date().toISOString()\n          })\n        }\n      }\n\n      setResetMessage('تم تغيير كلمة المرور بنجاح!')\n      setTimeout(() => {\n        setShowForgotPassword(false)\n        setResetStep('token')\n        setResetToken('')\n        setNewPassword('')\n        setResetMessage('')\n      }, 2000)\n    } catch (err) {\n      console.error('Reset password error:', err)\n      setError('حدث خطأ أثناء تغيير كلمة المرور')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (showForgotPassword) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-500 via-teal-500 to-cyan-600 flex items-center justify-center p-4\">\n        <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-emerald-600 to-teal-600 p-8 text-center\">\n            <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n              <Lock className=\"text-emerald-600\" size={40} />\n            </div>\n            <h1 className=\"text-3xl font-bold text-white mb-2\">استعادة كلمة المرور</h1>\n            <p className=\"text-emerald-50\">نظام الإرشاد الطلابي</p>\n          </div>\n\n          <div className=\"p-8\">\n            {resetStep === 'token' ? (\n              <form onSubmit={(e) => { e.preventDefault(); generateResetToken(); }} className=\"space-y-6\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    اسم المستخدم\n                  </label>\n                  <div className=\"relative\">\n                    <User className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n                    <input\n                      type=\"text\"\n                      value={username}\n                      onChange={(e) => setUsername(e.target.value)}\n                      className=\"w-full pr-12 pl-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"أدخل اسم المستخدم\"\n                      required\n                    />\n                  </div>\n                </div>\n\n                {error && (\n                  <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n                    <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n                    <p className=\"text-sm text-red-800\">{error}</p>\n                  </div>\n                )}\n\n                {resetMessage && (\n                  <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-3\">\n                    <p className=\"text-sm text-green-800 font-medium whitespace-pre-line\">{resetMessage}</p>\n                  </div>\n                )}\n\n                <button\n                  type=\"submit\"\n                  disabled={loading}\n                  className=\"w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n                >\n                  {loading ? 'جاري الإنشاء...' : 'إنشاء رمز الاستعادة'}\n                </button>\n\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    setShowForgotPassword(false)\n                    setError('')\n                    setResetMessage('')\n                  }}\n                  className=\"w-full text-gray-600 hover:text-gray-800 font-medium py-2\"\n                >\n                  العودة لتسجيل الدخول\n                </button>\n              </form>\n            ) : (\n              <form onSubmit={handleResetPassword} className=\"space-y-6\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    رمز الاستعادة\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={resetToken}\n                    onChange={(e) => setResetToken(e.target.value.toUpperCase())}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-center text-lg font-mono\"\n                    placeholder=\"أدخل الرمز\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    كلمة المرور الجديدة\n                  </label>\n                  <input\n                    type=\"password\"\n                    value={newPassword}\n                    onChange={(e) => setNewPassword(e.target.value)}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                    placeholder=\"أدخل كلمة المرور الجديدة\"\n                    required\n                  />\n                </div>\n\n                {error && (\n                  <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n                    <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n                    <p className=\"text-sm text-red-800\">{error}</p>\n                  </div>\n                )}\n\n                {resetMessage && (\n                  <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-3\">\n                    <p className=\"text-sm text-green-800 font-medium\">{resetMessage}</p>\n                  </div>\n                )}\n\n                <button\n                  type=\"submit\"\n                  disabled={loading}\n                  className=\"w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n                >\n                  {loading ? 'جاري التغيير...' : 'تغيير كلمة المرور'}\n                </button>\n              </form>\n            )}\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-cyan-500 via-blue-500 to-blue-600 flex items-center justify-center p-4\">\n      <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n        <div className=\"bg-gradient-to-r from-cyan-600 to-blue-600 p-8 text-center\">\n          <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n            <GraduationCap className=\"text-cyan-600\" size={40} />\n          </div>\n          <h1 className=\"text-3xl font-bold text-white mb-2\">نظام الإرشاد الطلابي</h1>\n          <p className=\"text-cyan-50\">تسجيل الدخول</p>\n        </div>\n\n        <form onSubmit={handleLogin} className=\"p-8 space-y-6\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اسم المستخدم\n            </label>\n            <div className=\"relative\">\n              <User className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n              <input\n                type=\"text\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                className=\"w-full pr-12 pl-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500\"\n                placeholder=\"أدخل اسم المستخدم\"\n                required\n              />\n            </div>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              كلمة المرور\n            </label>\n            <div className=\"relative\">\n              <Lock className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n              <input\n                type={showPassword ? 'text' : 'password'}\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"w-full pr-12 pl-12 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500\"\n                placeholder=\"أدخل كلمة المرور\"\n                required\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword(!showPassword)}\n                className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600\"\n              >\n                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}\n              </button>\n            </div>\n          </div>\n\n          {error && (\n            <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n              <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n              <p className=\"text-sm text-red-800\">{error}</p>\n            </div>\n          )}\n\n          <button\n            type=\"submit\"\n            disabled={loading}\n            className=\"w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n          >\n            {loading ? 'جاري تسجيل الدخول...' : 'تسجيل الدخول'}\n          </button>\n\n          <button\n            type=\"button\"\n            onClick={() => setShowForgotPassword(true)}\n            className=\"w-full text-cyan-600 hover:text-cyan-800 font-medium py-2\"\n          >\n            نسيت كلمة المرور؟\n          </button>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":14956},"src/main.tsx":{"content":"import { StrictMode } from 'react';\nimport { createRoot } from 'react-dom/client';\nimport App from './App.tsx';\nimport './index.css';\n\ncreateRoot(document.getElementById('root')!).render(\n  <StrictMode>\n    <App />\n  </StrictMode>\n);\n","size_bytes":234},"src/App.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from './lib/supabase'\nimport { db } from './lib/db'\nimport { Student, Group, SpecialStatus } from './types'\nimport { StudentForm } from './components/StudentForm'\nimport { StudentsList } from './components/StudentsList'\nimport { SearchBar } from './components/SearchBar'\nimport { GroupSelector } from './components/GroupSelector'\nimport { FiltersPanel } from './components/FiltersPanel'\nimport { ManageModal } from './components/ManageModal'\nimport { ExcelImport } from './components/ExcelImport'\nimport { EditStudentModal } from './components/EditStudentModal'\nimport { ProfileSettings } from './components/ProfileSettings'\nimport { GroupsPage } from './pages/GroupsPage'\nimport { GroupsManagementPage } from './pages/GroupsManagementPage'\nimport { SpecialStatusPage } from './pages/SpecialStatusPage'\nimport { AbsencePage } from './pages/AbsencePage'\nimport { ReceptionPage } from './pages/ReceptionPage'\nimport { PermissionPage } from './pages/PermissionPage'\nimport { TeachersPage } from './pages/TeachersPage'\nimport { LoginPage } from './pages/LoginPage'\nimport {\n  Home,\n  Users,\n  FileText,\n  ClipboardList,\n  UserCheck,\n  LogOut,\n  Download,\n  Settings,\n  Heart,\n  AlertCircle,\n  Search,\n  User as UserIcon,\n  GraduationCap\n} from 'lucide-react'\n\ntype Page = 'home' | 'groups' | 'special-status' | 'absence' | 'reception' | 'permission' | 'teachers'\n\nfunction App() {\n  const [isLoggedIn, setIsLoggedIn] = useState(false)\n  const [students, setStudents] = useState<Student[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [specialStatuses, setSpecialStatuses] = useState<SpecialStatus[]>([])\n  const [loading, setLoading] = useState(true)\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedGroupId, setSelectedGroupId] = useState<string | null>(null)\n  const [filter, setFilter] = useState<{\n    type: 'status' | 'special_status'\n    value: string\n  } | null>(null)\n  const [editingStudent, setEditingStudent] = useState<Student | undefined>()\n  const [showGroupsModal, setShowGroupsModal] = useState(false)\n  const [showStatusesModal, setShowStatusesModal] = useState(false)\n  const [showImportSection, setShowImportSection] = useState(false)\n  const [currentPage, setCurrentPage] = useState<Page>('home')\n  const [showProfileSettings, setShowProfileSettings] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n  const [showSettingsMenu, setShowSettingsMenu] = useState(false)\n  const [showGroupsManagement, setShowGroupsManagement] = useState(false)\n\n  const fetchData = async () => {\n    try {\n      setLoading(true)\n\n      // جلب البيانات من Supabase\n      const [groupsRes, statusesRes, studentsRes, profileRes, teachersRes] = await Promise.all([\n        supabase.from('groups').select('*').order('stage'),\n        supabase.from('special_statuses').select('*').order('name'),\n        supabase.from('students').select('*').order('name'),\n        supabase.from('teacher_profile').select('*').maybeSingle(),\n        supabase.from('teachers').select('*').order('name'),\n      ])\n\n      // حفظ البروفايل في IndexedDB\n      if (profileRes.data) {\n        await db.teacher_profile.clear()\n        await db.teacher_profile.put(profileRes.data)\n      }\n\n      // حفظ المجموعات في IndexedDB\n      if (groupsRes.data) {\n        await db.groups.clear()\n        for (const group of groupsRes.data) {\n          await db.groups.put(group)\n        }\n        const sortedGroups = groupsRes.data.sort((a: Group, b: Group) => {\n          const stageOrder: Record<string, number> = {\n            'الصف الاول الثانوي': 1,\n            'الصف الثاني الثانوي': 2,\n            'الصف الثالث الثانوي': 3,\n          }\n          const stageA = stageOrder[a.stage] || 999\n          const stageB = stageOrder[b.stage] || 999\n          if (stageA !== stageB) return stageA - stageB\n          return (a.display_order || 999) - (b.display_order || 999)\n        })\n        setGroups(sortedGroups)\n      }\n\n      // حفظ الحالات الخاصة في IndexedDB\n      if (statusesRes.data) {\n        await db.special_statuses.clear()\n        for (const status of statusesRes.data) {\n          await db.special_statuses.put(status)\n        }\n        setSpecialStatuses(statusesRes.data)\n      }\n\n      // حفظ الطلاب في IndexedDB\n      if (studentsRes.data) {\n        await db.students.clear()\n        for (const student of studentsRes.data) {\n          await db.students.put(student)\n        }\n        setStudents(studentsRes.data as Student[])\n      }\n\n      // حفظ المعلمين في IndexedDB\n      if (teachersRes.data) {\n        await db.teachers.clear()\n        for (const teacher of teachersRes.data) {\n          await db.teachers.put(teacher)\n        }\n        setTotalTeachers(teachersRes.data.length)\n      }\n\n      // تحديث اسم المعلم واسم المدرسة من البيانات المحملة\n      if (profileRes.data) {\n        setTeacherName(profileRes.data.name || '')\n        setSchoolName(profileRes.data.school_name || '')\n      } else {\n        // إذا لا يوجد بروفايل، نترك الحقول فاضية\n        setTeacherName('')\n        setSchoolName('')\n      }\n    } catch (error) {\n      console.error('Error fetching data:', error)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    const initializeApp = async () => {\n      // Initialize default login credentials if not exists\n      const { db } = await import('./lib/db')\n      try {\n        const existingCredentials = await db.login_credentials.toArray()\n        if (existingCredentials.length === 0) {\n          await db.login_credentials.add({\n            id: crypto.randomUUID(),\n            username: 'admin',\n            password_hash: 'admin123',\n            created_at: new Date().toISOString(),\n            updated_at: new Date().toISOString()\n          })\n        }\n\n        // Update existing groups to have display_order if missing\n        const allGroups = await db.groups.toArray()\n        const groupsToUpdate = allGroups.filter(g => g.display_order === undefined || g.display_order === null)\n        if (groupsToUpdate.length > 0) {\n          const stageGroups: Record<string, any[]> = {}\n          groupsToUpdate.forEach(g => {\n            if (!stageGroups[g.stage]) stageGroups[g.stage] = []\n            stageGroups[g.stage].push(g)\n          })\n\n          for (const [stage, groups] of Object.entries(stageGroups)) {\n            for (let i = 0; i < groups.length; i++) {\n              await db.groups.update(groups[i].id, { display_order: i + 1 })\n            }\n          }\n        }\n      } catch (error) {\n        console.error('Error initializing:', error)\n      }\n\n      const loggedIn = localStorage.getItem('isLoggedIn') === 'true'\n      setIsLoggedIn(loggedIn)\n      if (loggedIn) {\n        fetchData()\n      } else {\n        setLoading(false)\n      }\n    }\n\n    initializeApp()\n  }, [])\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      const target = event.target as HTMLElement\n      if (showSettingsMenu && !target.closest('.settings-menu-container')) {\n        setShowSettingsMenu(false)\n      }\n    }\n\n    document.addEventListener('mousedown', handleClickOutside)\n    return () => document.removeEventListener('mousedown', handleClickOutside)\n  }, [showSettingsMenu])\n\n  const filteredStudents = students.filter((student) => {\n    const matchesSearch =\n      searchTerm === '' ||\n      student.name.includes(searchTerm) ||\n      student.national_id.includes(searchTerm) ||\n      student.phone.includes(searchTerm) ||\n      student.guardian_phone.includes(searchTerm)\n\n    const matchesGroup =\n      !selectedGroupId || student.group_id === selectedGroupId\n\n    return matchesSearch && matchesGroup\n  })\n\n  const handleLogout = () => {\n    localStorage.removeItem('isLoggedIn')\n    localStorage.removeItem('userId')\n    setIsLoggedIn(false)\n    setCurrentPage('home')\n  }\n\n  const handleLogin = () => {\n    setIsLoggedIn(true)\n    fetchData()\n  }\n\n  const applyFilters = (students: Student[]) => {\n    return students.filter((student) => {\n      if (!filter) return true\n      if (filter.type === 'status') return student.status === filter.value\n      if (filter.type === 'special_status') {\n        if (filter.value === 'none') return student.special_status_id === null\n        return student.special_status_id === filter.value\n      }\n      return true\n    })\n  }\n\n  const groupedStudents = selectedGroupId\n    ? [\n        {\n          group: groups.find((g) => g.id === selectedGroupId)!,\n          students: applyFilters(filteredStudents),\n        },\n      ]\n    : groups.map((group) => ({\n        group,\n        students: applyFilters(filteredStudents.filter((s) => s.group_id === group.id)),\n      }))\n\n  const totalStudents = students.length\n  const [totalTeachers, setTotalTeachers] = useState(0)\n  const absentStudents = students.filter(s => s.status === 'استئذان').length\n  const specialStatusStudents = students.filter(s => s.special_status_id !== null).length\n\n  const navItems = [\n    { id: 'home' as Page, label: 'الصفحة الرئيسية', icon: Home },\n    { id: 'teachers' as Page, label: 'المعلمين', icon: GraduationCap },\n    { id: 'groups' as Page, label: 'المجموعات', icon: Users },\n    { id: 'special-status' as Page, label: 'الحالات الخاصة', icon: Heart },\n    { id: 'reception' as Page, label: 'استقبال الطلاب', icon: UserCheck },\n    { id: 'permission' as Page, label: 'الاستئذان', icon: LogOut },\n    { id: 'absence' as Page, label: 'المخالفات', icon: AlertCircle },\n  ]\n\n  if (!isLoggedIn) {\n    return <LoginPage onLogin={handleLogin} />\n  }\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4\"></div>\n          <p className=\"text-xl text-gray-600 font-semibold\">جاري التحميل...</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50\" dir=\"rtl\">\n      {/* Header */}\n      <header className=\"bg-white shadow-lg border-b-4 border-blue-600\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"bg-gradient-to-br from-blue-600 to-blue-700 p-3 rounded-2xl shadow-lg\">\n                <Users className=\"text-white\" size={32} />\n              </div>\n              <div>\n                <h1 className=\"text-3xl font-bold text-gray-900\">\n                  {schoolName || 'نظام إدارة شاملة لبيانات الطلاب'}\n                </h1>\n                <p className=\"text-base text-gray-600 mt-1 font-medium\">\n                  {schoolName ? '' : 'قم بإضافة وصف النظام من الإعدادات'}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative settings-menu-container\">\n                <button\n                  onClick={() => setShowSettingsMenu(!showSettingsMenu)}\n                  className=\"flex items-center gap-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all hover:shadow-xl hover:scale-105\"\n                >\n                  <Settings size={20} />\n                  <span>الإعدادات</span>\n                </button>\n\n                {showSettingsMenu && (\n                  <div className=\"absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-200 py-2 z-50\">\n                    <button\n                      onClick={() => {\n                        setShowImportSection(!showImportSection)\n                        setShowSettingsMenu(false)\n                        setCurrentPage('home')\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-gray-50 transition-colors flex items-center gap-3\"\n                    >\n                      <Download size={18} className=\"text-green-600\" />\n                      <span className=\"font-semibold text-gray-700\">استيراد من Excel</span>\n                    </button>\n                    <button\n                      onClick={() => {\n                        setShowGroupsManagement(true)\n                        setShowSettingsMenu(false)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-gray-50 transition-colors flex items-center gap-3\"\n                    >\n                      <Users size={18} className=\"text-blue-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة المجموعات</span>\n                    </button>\n                    <button\n                      onClick={() => {\n                        setShowStatusesModal(true)\n                        setShowSettingsMenu(false)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-gray-50 transition-colors flex items-center gap-3\"\n                    >\n                      <Heart size={18} className=\"text-pink-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة الحالات الخاصة</span>\n                    </button>\n                    <div className=\"border-t border-gray-200 my-2\"></div>\n                    <button\n                      onClick={() => {\n                        handleLogout()\n                        setShowSettingsMenu(false)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-red-50 transition-colors flex items-center gap-3\"\n                    >\n                      <LogOut size={18} className=\"text-red-600\" />\n                      <span className=\"font-semibold text-red-600\">تسجيل الخروج</span>\n                    </button>\n                  </div>\n                )}\n              </div>\n\n              <button\n                onClick={() => setShowProfileSettings(true)}\n                className=\"flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 px-4 py-3 rounded-xl font-bold shadow-lg border-2 border-gray-200 transition-all hover:shadow-xl\"\n              >\n                <div className=\"bg-gradient-to-br from-blue-500 to-blue-600 p-2 rounded-lg\">\n                  <UserIcon className=\"text-white\" size={20} />\n                </div>\n                {teacherName ? (\n                  <span className=\"text-sm\">{teacherName}</span>\n                ) : (\n                  <span className=\"text-sm\">الملف الشخصي</span>\n                )}\n              </button>\n            </div>\n          </div>\n\n          {/* Stats Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mt-6\">\n            <div className=\"bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-blue-100 text-sm\">إجمالي الطلاب</p>\n                  <p className=\"text-3xl font-bold mt-1\">{totalStudents}</p>\n                </div>\n                <Users size={40} className=\"text-blue-200\" />\n              </div>\n            </div>\n\n            <div className=\"bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-green-100 text-sm\">المعلمين</p>\n                  <p className=\"text-3xl font-bold mt-1\">{totalTeachers}</p>\n                </div>\n                <GraduationCap size={40} className=\"text-green-200\" />\n              </div>\n            </div>\n\n            <div className=\"bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-orange-100 text-sm\">استئذانات</p>\n                  <p className=\"text-3xl font-bold mt-1\">{absentStudents}</p>\n                </div>\n                <LogOut size={40} className=\"text-orange-200\" />\n              </div>\n            </div>\n\n            <div className=\"bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-purple-100 text-sm\">حالات خاصة</p>\n                  <p className=\"text-3xl font-bold mt-1\">{specialStatusStudents}</p>\n                </div>\n                <Heart size={40} className=\"text-purple-200\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Navigation */}\n        <nav className=\"bg-gradient-to-r from-gray-50 to-gray-100 border-t border-gray-200\">\n          <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n            <div className=\"flex gap-2 overflow-x-auto py-3\">\n              {navItems.map((item) => {\n                const Icon = item.icon\n                const isActive = currentPage === item.id\n                return (\n                  <button\n                    key={item.id}\n                    onClick={() => setCurrentPage(item.id)}\n                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-semibold whitespace-nowrap transition-all ${\n                      isActive\n                        ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg scale-105'\n                        : 'bg-white text-gray-700 hover:bg-gray-50 hover:shadow-md'\n                    }`}\n                  >\n                    <Icon size={20} />\n                    <span>{item.label}</span>\n                  </button>\n                )\n              })}\n            </div>\n          </div>\n        </nav>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {showImportSection && currentPage === 'home' && (\n          <div className=\"mb-6\">\n            <ExcelImport\n              onImportComplete={() => {\n                fetchData()\n                setShowImportSection(false)\n              }}\n            />\n          </div>\n        )}\n\n        {currentPage === 'teachers' && !showGroupsManagement && (\n          <TeachersPage />\n        )}\n\n        {currentPage === 'groups' && !showGroupsManagement && (\n          <GroupsPage />\n        )}\n\n        {currentPage === 'special-status' && !showGroupsManagement && (\n          <SpecialStatusPage\n            students={students}\n            groups={groups}\n            specialStatuses={specialStatuses}\n          />\n        )}\n\n        {currentPage === 'absence' && !showGroupsManagement && (\n          <AbsencePage students={students} groups={groups} />\n        )}\n\n        {currentPage === 'reception' && !showGroupsManagement && (\n          <ReceptionPage />\n        )}\n\n        {currentPage === 'permission' && !showGroupsManagement && (\n          <PermissionPage />\n        )}\n\n        {showGroupsManagement && (\n          <GroupsManagementPage\n            onClose={() => {\n              setShowGroupsManagement(false)\n              fetchData()\n            }}\n          />\n        )}\n\n        {currentPage === 'home' && !showGroupsManagement && (\n          <div className=\"grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-6\">\n            <div className=\"space-y-6\">\n              {editingStudent && (\n                <StudentForm\n                  groups={groups}\n                  specialStatuses={specialStatuses}\n                  onStudentAdded={fetchData}\n                  editingStudent={editingStudent}\n                  onEditingStudentChange={setEditingStudent}\n                />\n              )}\n\n              <div className=\"bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl shadow-lg p-6 border-2 border-teal-400\">\n                <h2 className=\"text-2xl font-bold text-white mb-4 flex items-center gap-2\">\n                  <Search className=\"text-teal-100\" size={28} />\n                  استفسار عن طالب\n                </h2>\n                <SearchBar\n                  value={searchTerm}\n                  onChange={setSearchTerm}\n                  placeholder=\"ابحث عن طالب بالاسم، السجل المدني، أو رقم الجوال...\"\n                />\n              </div>\n\n              <div className=\"space-y-6\">\n                {filteredStudents.length === 0 && searchTerm ? (\n                  <div className=\"bg-white rounded-2xl shadow-lg p-12 border border-gray-200 text-center\">\n                    <Search className=\"mx-auto text-gray-300 mb-4\" size={64} />\n                    <h3 className=\"text-xl font-bold text-gray-700 mb-2\">لا توجد نتائج</h3>\n                    <p className=\"text-gray-500\">لم يتم العثور على طالب يطابق بحثك: \"{searchTerm}\"</p>\n                  </div>\n                ) : (\n                  groupedStudents.map(({ group, students: groupStudents }) =>\n                    groupStudents.length > 0 ? (\n                      <div key={group.id} className=\"bg-white rounded-2xl shadow-lg p-6 border border-gray-200\">\n                        <StudentsList\n                          students={groupStudents}\n                          groupName={group.name}\n                          specialStatuses={specialStatuses}\n                          onStudentDeleted={fetchData}\n                          onEditStudent={setEditingStudent}\n                        />\n                      </div>\n                    ) : null\n                  )\n                )}\n              </div>\n            </div>\n\n            <aside className=\"space-y-6\">\n              <div className=\"bg-white rounded-2xl shadow-lg p-5 border border-gray-200 sticky top-6\">\n                <h3 className=\"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2\">\n                  <Settings className=\"text-gray-600\" size={22} />\n                  التصفية\n                </h3>\n                <FiltersPanel\n                  specialStatuses={specialStatuses}\n                  filter={filter}\n                  onFilterChange={setFilter}\n                />\n\n                <div className=\"mt-6 pt-6 border-t border-gray-200\">\n                  <h3 className=\"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2\">\n                    <Users className=\"text-blue-600\" size={22} />\n                    المجموعات\n                  </h3>\n                  <GroupSelector\n                    groups={groups}\n                    selectedGroupId={selectedGroupId}\n                    onSelectGroup={setSelectedGroupId}\n                  />\n                </div>\n\n              </div>\n            </aside>\n          </div>\n        )}\n      </main>\n\n      <ManageModal\n        type=\"groups\"\n        isOpen={showGroupsModal}\n        onClose={() => setShowGroupsModal(false)}\n        onDataUpdated={fetchData}\n        existingItems={groups}\n      />\n\n      <ManageModal\n        type=\"special_statuses\"\n        isOpen={showStatusesModal}\n        onClose={() => setShowStatusesModal(false)}\n        onDataUpdated={fetchData}\n        existingItems={specialStatuses}\n      />\n\n      {editingStudent && (\n        <EditStudentModal\n          student={editingStudent}\n          groups={groups}\n          specialStatuses={specialStatuses}\n          onClose={() => setEditingStudent(undefined)}\n          onStudentUpdated={fetchData}\n        />\n      )}\n\n      {showProfileSettings && (\n        <ProfileSettings\n          onClose={() => {\n            setShowProfileSettings(false)\n            fetchData()\n          }}\n        />\n      )}\n\n      <footer className=\"mt-12 pb-6 text-center\">\n        <div className=\"inline-block bg-gradient-to-r from-blue-50 to-slate-50 px-8 py-4 rounded-2xl shadow-sm border border-gray-200\">\n          <p className=\"text-gray-600 text-sm font-medium\">\n            تصميم وتطوير:{' '}\n            <span className=\"font-bold text-blue-600\">الأستاذ وائل الفيفي</span>\n          </p>\n          <p className=\"text-gray-500 text-xs mt-1\" dir=\"ltr\">\n            📱 0558890902\n          </p>\n        </div>\n      </footer>\n    </div>\n  )\n}\n\nexport default App\n","size_bytes":24840},"src/components/StudentsList.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { Student, SpecialStatus, SchoolInfo } from '../types'\nimport { supabase } from '../lib/supabase'\nimport { Trash2, Edit2, MoreVertical, Printer, DoorOpen } from 'lucide-react'\nimport { AllowClassEntryModal } from './AllowClassEntryModal'\n\ninterface StudentsListProps {\n  students: Student[]\n  groupName: string\n  specialStatuses: SpecialStatus[]\n  onStudentDeleted: () => void\n  onEditStudent: (student: Student) => void\n}\n\nexport function StudentsList({\n  students,\n  groupName,\n  specialStatuses,\n  onStudentDeleted,\n  onEditStudent,\n}: StudentsListProps) {\n  const [expandedId, setExpandedId] = useState<string | null>(null)\n  const [loadingDelete, setLoadingDelete] = useState<string | null>(null)\n  const [schoolInfo, setSchoolInfo] = useState<SchoolInfo | null>(null)\n  const [showAllowEntryModal, setShowAllowEntryModal] = useState(false)\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n\n  useEffect(() => {\n    fetchSchoolInfo()\n  }, [])\n\n  const fetchSchoolInfo = async () => {\n    const { data } = await supabase\n      .from('school_info')\n      .select('*')\n      .limit(1)\n      .maybeSingle()\n\n    if (data) setSchoolInfo(data)\n  }\n\n\n  const handleDelete = async (studentId: string) => {\n    if (!window.confirm('هل أنت متأكد من حذف هذا الطالب؟')) return\n\n    setLoadingDelete(studentId)\n    try {\n      const { error } = await supabase\n        .from('students')\n        .delete()\n        .eq('id', studentId)\n\n      if (error) throw error\n      onStudentDeleted()\n    } finally {\n      setLoadingDelete(null)\n    }\n  }\n\n\n  const handleMoveStudent = async (\n    studentId: string,\n    currentGroupId: string,\n    newGroupId: string\n  ) => {\n    if (!newGroupId || newGroupId === currentGroupId) return\n\n    try {\n      const { error } = await supabase\n        .from('students')\n        .update({ group_id: newGroupId })\n        .eq('id', studentId)\n\n      if (error) throw error\n      onStudentDeleted()\n    } finally {\n      setExpandedId(null)\n    }\n  }\n\n  const getSpecialStatusName = (statusId: string | null) => {\n    if (!statusId) return '-'\n    return specialStatuses.find((s) => s.id === statusId)?.name || '-'\n  }\n\n  const printStudent = async (student: Student) => {\n    const specialStatusName = student.special_status_id\n      ? getSpecialStatusName(student.special_status_id)\n      : 'لا يوجد'\n    const groupName = student.group?.name || '-'\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    // Fetch teacher name and school name\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const schoolName = teacherProfile?.school_name || schoolInfo?.school_name || 'اسم المدرسة'\n\n\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>بيانات الطالب - ${student.name}</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n\n            @page {\n              size: A4;\n              margin: 15mm;\n            }\n\n            body {\n              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n              background: white;\n              color: #1a1a1a;\n              line-height: 1.4;\n              font-size: 13px;\n            }\n\n            .page-container {\n              max-width: 210mm;\n              margin: 0 auto;\n              background: white;\n            }\n\n            .header {\n              background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);\n              color: white;\n              padding: 15px 20px;\n              text-align: center;\n              border-radius: 8px 8px 0 0;\n            }\n\n            .header h1 {\n              font-size: 22px;\n              margin-bottom: 4px;\n              font-weight: 700;\n            }\n\n            .header .school-name {\n              font-size: 16px;\n              margin-bottom: 8px;\n              opacity: 0.95;\n              font-weight: 500;\n            }\n\n            .header .meta {\n              font-size: 11px;\n              opacity: 0.9;\n              margin-top: 6px;\n            }\n\n            .content {\n              padding: 20px;\n            }\n\n            .student-name-section {\n              background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);\n              border: 2px solid #3b82f6;\n              border-radius: 8px;\n              padding: 12px;\n              margin-bottom: 15px;\n              text-align: center;\n            }\n\n            .student-name-section h2 {\n              color: #1e40af;\n              font-size: 20px;\n              font-weight: 700;\n            }\n\n            .info-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 10px;\n              margin-bottom: 15px;\n            }\n\n            .info-item {\n              background: #f9fafb;\n              border: 1px solid #e5e7eb;\n              border-radius: 6px;\n              padding: 10px;\n            }\n\n            .info-label {\n              font-size: 11px;\n              color: #6b7280;\n              font-weight: 600;\n              margin-bottom: 4px;\n            }\n\n            .info-value {\n              font-size: 14px;\n              color: #111827;\n              font-weight: 600;\n            }\n\n\n            .footer {\n              background: #f9fafb;\n              padding: 15px 20px;\n              border-top: 2px solid #e5e7eb;\n              margin-top: 15px;\n            }\n\n            .footer-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 20px;\n            }\n\n            .signature-box {\n              text-align: center;\n            }\n\n            .signature-label {\n              font-size: 12px;\n              color: #6b7280;\n              font-weight: 600;\n              margin-bottom: 6px;\n            }\n\n            .signature-line {\n              border-top: 2px solid #374151;\n              width: 150px;\n              margin: 30px auto 8px;\n            }\n\n            .signature-name {\n              font-size: 14px;\n              color: #111827;\n              font-weight: 600;\n            }\n\n            .print-info {\n              text-align: center;\n              color: #9ca3af;\n              font-size: 10px;\n              margin-top: 15px;\n              padding-top: 15px;\n              border-top: 1px solid #e5e7eb;\n            }\n\n            @media print {\n              body {\n                background: white;\n              }\n\n              .page-container {\n                border: none;\n                border-radius: 0;\n              }\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"page-container\">\n            <div class=\"header\">\n              <div class=\"school-name\">${schoolName}</div>\n              <h1>بطاقة بيانات الطالب</h1>\n              <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n            </div>\n\n            <div class=\"content\">\n              <div class=\"student-name-section\">\n                <h2>${student.name}</h2>\n              </div>\n\n              <div class=\"info-grid\">\n                <div class=\"info-item\">\n                  <div class=\"info-label\">السجل المدني</div>\n                  <div class=\"info-value\">${student.national_id}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الصف الدراسي</div>\n                  <div class=\"info-value\">${student.grade}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الفصل</div>\n                  <div class=\"info-value\">${groupName}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">جوال الطالب</div>\n                  <div class=\"info-value\">${student.phone}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">جوال ولي الأمر</div>\n                  <div class=\"info-value\">${student.guardian_phone}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الظروف الخاصة</div>\n                  <div class=\"info-value\">${specialStatusName}</div>\n                </div>\n              </div>\n\n            </div>\n\n            <div class=\"footer\">\n              <div class=\"footer-grid\">\n                <div class=\"signature-box\">\n                  <div class=\"signature-label\">المرشد الطلابي</div>\n                  <div class=\"signature-name\">${teacherName || 'اسم المرشد الطلابي'}</div>\n                  <div class=\"signature-line\"></div>\n                  <div style=\"font-size: 11px; color: #6b7280;\">التوقيع</div>\n                </div>\n\n                <div class=\"signature-box\">\n                  <div class=\"signature-label\">الإدارة</div>\n                  <div class=\"signature-line\"></div>\n                  <div style=\"font-size: 11px; color: #6b7280;\">التوقيع والختم</div>\n                </div>\n              </div>\n\n              <div class=\"print-info\">\n                هذه الوثيقة صادرة من الإرشاد الطلابي\n              </div>\n            </div>\n          </div>\n\n          <script>\n            window.onload = () => {\n              setTimeout(() => {\n                window.print();\n                window.onafterprint = () => window.close();\n              }, 250);\n            };\n          </script>\n        </body>\n      </html>\n    `)\n    printWindow.document.close()\n  }\n\n  if (students.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-8 text-center\">\n        <p className=\"text-gray-500\">لا توجد طلاب في {groupName}</p>\n      </div>\n    )\n  }\n\n  const groupColors = [\n    { bg: 'bg-blue-50', border: 'border-blue-200', header: 'bg-gradient-to-r from-blue-400 to-blue-500', text: 'text-blue-900' },\n    { bg: 'bg-green-50', border: 'border-green-200', header: 'bg-gradient-to-r from-green-400 to-green-500', text: 'text-green-900' },\n    { bg: 'bg-orange-50', border: 'border-orange-200', header: 'bg-gradient-to-r from-orange-400 to-orange-500', text: 'text-orange-900' },\n    { bg: 'bg-teal-50', border: 'border-teal-200', header: 'bg-gradient-to-r from-teal-400 to-teal-500', text: 'text-teal-900' },\n    { bg: 'bg-pink-50', border: 'border-pink-200', header: 'bg-gradient-to-r from-pink-400 to-pink-500', text: 'text-pink-900' },\n    { bg: 'bg-cyan-50', border: 'border-cyan-200', header: 'bg-gradient-to-r from-cyan-400 to-cyan-500', text: 'text-cyan-900' },\n  ]\n\n  const groupIndex = groupName.charCodeAt(0) % groupColors.length\n  const colors = groupColors[groupIndex]\n\n  return (\n    <div className=\"space-y-2\">\n        <div className={`${colors.header} text-white px-4 py-3 rounded-lg shadow-md mb-4`}>\n          <h3 className=\"text-lg font-bold flex items-center justify-between\">\n            <span>{groupName}</span>\n            <span className=\"bg-white/20 px-3 py-1 rounded-full text-sm\">{students.length} طالب</span>\n          </h3>\n        </div>\n        <div className=\"space-y-2\">\n          {students.map((student) => {\n            const hasSpecialStatus = student.special_status_id !== null\n            const bgColorClass = hasSpecialStatus\n              ? 'bg-amber-50 border-amber-200'\n              : `${colors.bg} ${colors.border}`\n\n            return (\n          <div\n            key={student.id}\n            className={`${bgColorClass} rounded-lg shadow-sm border-2 hover:shadow-md transition-shadow`}\n          >\n            <div className=\"p-4\">\n              <div className=\"flex items-start justify-between mb-2\">\n                <div className=\"flex-1\">\n                  <h4 className=\"font-bold text-gray-800\">{student.name}</h4>\n                  <p className=\"text-sm text-gray-600\">السجل: {student.national_id}</p>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {student.status === 'استئذان' && (\n                    <span className=\"px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800\">\n                      استئذان\n                    </span>\n                  )}\n                  {student.special_status_id && (\n                    <span className=\"px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800\">\n                      {getSpecialStatusName(student.special_status_id)}\n                    </span>\n                  )}\n                  <button\n                    onClick={() => setExpandedId(expandedId === student.id ? null : student.id)}\n                    className=\"p-1 hover:bg-gray-100 rounded\"\n                  >\n                    <MoreVertical size={20} />\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-gray-600 mb-2\">\n                <div>الصف: {student.grade}</div>\n                <div>جوال: {student.phone}</div>\n                <div>ولي أمر: {student.guardian_phone}</div>\n              </div>\n\n              {expandedId === student.id && (\n                <div className=\"mt-4 pt-4 border-t border-gray-200 space-y-2\">\n                  <button\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setShowAllowEntryModal(true)\n                      setExpandedId(null)\n                    }}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded font-medium text-sm shadow-sm\"\n                  >\n                    <DoorOpen size={16} />\n                    السماح بدخول الفصل\n                  </button>\n\n                  <button\n                    onClick={() => printStudent(student)}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 text-slate-800 rounded font-medium text-sm border border-slate-300 shadow-sm\"\n                  >\n                    <Printer size={16} />\n                    طباعة بيانات الطالب\n                  </button>\n\n                  <button\n                    onClick={() => {\n                      setExpandedId(null)\n                      onEditStudent(student)\n                    }}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-amber-100 to-yellow-100 hover:from-amber-200 hover:to-yellow-200 text-amber-900 rounded font-medium text-sm border border-amber-300 shadow-sm\"\n                  >\n                    <Edit2 size={16} />\n                    تعديل\n                  </button>\n\n                  <button\n                    onClick={() => handleDelete(student.id)}\n                    disabled={loadingDelete === student.id}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-red-100 to-rose-100 hover:from-red-200 hover:to-rose-200 text-red-700 rounded font-medium text-sm border border-red-300 shadow-sm disabled:opacity-50\"\n                  >\n                    <Trash2 size={16} />\n                    {loadingDelete === student.id ? 'جاري...' : 'حذف'}\n                  </button>\n                </div>\n              )}\n            </div>\n          </div>\n            )\n          })}\n      </div>\n\n      <AllowClassEntryModal\n        isOpen={showAllowEntryModal}\n        onClose={() => {\n          setShowAllowEntryModal(false)\n          setSelectedStudent(null)\n        }}\n        student={selectedStudent}\n      />\n    </div>\n  )\n}\n","size_bytes":16391},"src/pages/GroupsManagementPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { X, Plus, Layers, Trash2, Edit2, ChevronUp, ChevronDown } from 'lucide-react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Group } from '../types'\n\ninterface GroupsManagementPageProps {\n  onClose: () => void\n}\n\nexport function GroupsManagementPage({ onClose }: GroupsManagementPageProps) {\n  const [groups, setGroups] = useState<Group[]>([])\n  const [newStage, setNewStage] = useState('')\n  const [newGroupName, setNewGroupName] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [studentCounts, setStudentCounts] = useState<Record<string, number>>({})\n  const [editingGroup, setEditingGroup] = useState<Group | null>(null)\n  const [editName, setEditName] = useState('')\n  const [editStage, setEditStage] = useState('')\n\n  useEffect(() => {\n    fetchGroups()\n    fetchStudentCounts()\n  }, [])\n\n  const fetchGroups = async () => {\n    // Fetch from Supabase first\n    const { data: supabaseGroups } = await supabase\n      .from('groups')\n      .select('*')\n      .order('display_order', { ascending: true })\n\n    if (supabaseGroups) {\n      // Sync to IndexedDB\n      await db.groups.clear()\n      await db.groups.bulkAdd(supabaseGroups)\n      setGroups(supabaseGroups)\n    } else {\n      // Fallback to IndexedDB\n      const allGroups = await db.groups.toArray()\n      setGroups(allGroups)\n    }\n  }\n\n  const fetchStudentCounts = async () => {\n    const allStudents = await db.students.toArray()\n    const counts: Record<string, number> = {}\n\n    allStudents.forEach(student => {\n      if (student.group_id) {\n        counts[student.group_id] = (counts[student.group_id] || 0) + 1\n      }\n    })\n\n    setStudentCounts(counts)\n  }\n\n  const handleAddGroup = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!newStage.trim() || !newGroupName.trim()) return\n\n    setLoading(true)\n    try {\n      // Get max order from Supabase\n      const { data: stageGroups } = await supabase\n        .from('groups')\n        .select('*')\n        .eq('stage', newStage.trim())\n\n      const maxOrder = stageGroups && stageGroups.length > 0\n        ? Math.max(...stageGroups.map(g => g.display_order || 0))\n        : 0\n\n      const newGroup = {\n        id: crypto.randomUUID(),\n        stage: newStage.trim(),\n        name: newGroupName.trim(),\n        display_order: maxOrder + 1,\n        created_at: new Date().toISOString(),\n      }\n\n      // Insert to Supabase\n      const { error } = await supabase\n        .from('groups')\n        .insert(newGroup)\n\n      if (error) throw error\n\n      // Add to IndexedDB\n      await db.groups.add(newGroup)\n\n      setNewStage('')\n      setNewGroupName('')\n      await fetchGroups()\n      await fetchStudentCounts()\n    } catch (error) {\n      console.error('Error adding group:', error)\n      alert('حدث خطأ أثناء إضافة المجموعة')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDeleteGroup = async (id: string) => {\n    if (!window.confirm('هل أنت متأكد من حذف هذه المجموعة؟')) return\n\n    try {\n      // Delete from Supabase\n      const { error } = await supabase\n        .from('groups')\n        .delete()\n        .eq('id', id)\n\n      if (error) throw error\n\n      // Delete from IndexedDB\n      await db.groups.delete(id)\n      await fetchGroups()\n      await fetchStudentCounts()\n    } catch (error) {\n      console.error('Error deleting group:', error)\n      alert('حدث خطأ أثناء حذف المجموعة')\n    }\n  }\n\n  const handleEditGroup = (group: Group) => {\n    setEditingGroup(group)\n    setEditName(group.name)\n    setEditStage(group.stage)\n  }\n\n  const handleSaveEdit = async () => {\n    if (!editingGroup || !editName.trim() || !editStage.trim()) return\n\n    try {\n      // Update in Supabase\n      const { error } = await supabase\n        .from('groups')\n        .update({\n          name: editName.trim(),\n          stage: editStage.trim(),\n        })\n        .eq('id', editingGroup.id)\n\n      if (error) throw error\n\n      // Update in IndexedDB\n      await db.groups.update(editingGroup.id, {\n        name: editName.trim(),\n        stage: editStage.trim(),\n      })\n\n      setEditingGroup(null)\n      setEditName('')\n      setEditStage('')\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error updating group:', error)\n      alert('حدث خطأ أثناء تحديث المجموعة')\n    }\n  }\n\n  const handleCancelEdit = () => {\n    setEditingGroup(null)\n    setEditName('')\n    setEditStage('')\n  }\n\n  const handleMoveUp = async (group: Group, stageGroups: Group[]) => {\n    const currentIndex = stageGroups.findIndex(g => g.id === group.id)\n    if (currentIndex === 0) return\n\n    const prevGroup = stageGroups[currentIndex - 1]\n    const currentOrder = group.display_order || currentIndex + 1\n    const prevOrder = prevGroup.display_order || currentIndex\n\n    try {\n      // Update in Supabase\n      await supabase.from('groups').update({ display_order: prevOrder }).eq('id', group.id)\n      await supabase.from('groups').update({ display_order: currentOrder }).eq('id', prevGroup.id)\n\n      // Update in IndexedDB\n      await db.groups.update(group.id, { display_order: prevOrder })\n      await db.groups.update(prevGroup.id, { display_order: currentOrder })\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error moving group:', error)\n    }\n  }\n\n  const handleMoveDown = async (group: Group, stageGroups: Group[]) => {\n    const currentIndex = stageGroups.findIndex(g => g.id === group.id)\n    if (currentIndex === stageGroups.length - 1) return\n\n    const nextGroup = stageGroups[currentIndex + 1]\n    const currentOrder = group.display_order || currentIndex + 1\n    const nextOrder = nextGroup.display_order || currentIndex + 2\n\n    try {\n      // Update in Supabase\n      await supabase.from('groups').update({ display_order: nextOrder }).eq('id', group.id)\n      await supabase.from('groups').update({ display_order: currentOrder }).eq('id', nextGroup.id)\n\n      // Update in IndexedDB\n      await db.groups.update(group.id, { display_order: nextOrder })\n      await db.groups.update(nextGroup.id, { display_order: currentOrder })\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error moving group:', error)\n    }\n  }\n\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الأول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  const sortedStages = Object.entries(groupedByStage).sort((a, b) => {\n    const orderA = stageOrder[a[0]] || 999\n    const orderB = stageOrder[b[0]] || 999\n    return orderA - orderB\n  })\n\n  const getStudentCount = (groupId: string) => {\n    return studentCounts[groupId] || 0\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6 shadow-lg\">\n        <div className=\"max-w-7xl mx-auto flex items-center justify-between\">\n          <h1 className=\"text-2xl font-bold\">إدارة المراحل والمجموعات</h1>\n          <button\n            onClick={onClose}\n            className=\"p-2 hover:bg-white/20 rounded-lg transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto p-6 space-y-6\">\n        <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-2xl p-6 shadow-sm\">\n          <h2 className=\"text-xl font-bold text-emerald-800 mb-6\">إضافة مجموعة جديدة</h2>\n\n          <form onSubmit={handleAddGroup} className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الصف (المرحلة)\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: الصف الأول الثانوي\"\n                  value={newStage}\n                  onChange={(e) => setNewStage(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  اسم المجموعة\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: مجموعة 1\"\n                  value={newGroupName}\n                  onChange={(e) => setNewGroupName(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  required\n                />\n              </div>\n            </div>\n            <button\n              type=\"submit\"\n              disabled={loading || !newStage.trim() || !newGroupName.trim()}\n              className=\"w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-400 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Plus size={20} />\n              إضافة المجموعة\n            </button>\n          </form>\n        </div>\n\n        <div className=\"space-y-4\">\n          <h2 className=\"text-xl font-bold text-gray-800\">المجموعات الحالية</h2>\n\n          {sortedStages.length === 0 ? (\n            <div className=\"bg-white rounded-lg p-8 text-center text-gray-500\">\n              لا توجد مجموعات حالياً\n            </div>\n          ) : (\n            sortedStages.map(([stage, stageGroups]) => (\n              <div key={stage} className=\"bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200\">\n                <div className=\"bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-4 flex items-center gap-3\">\n                  <Layers size={20} className=\"text-white\" />\n                  <h3 className=\"text-lg font-bold text-white\">{stage}</h3>\n                </div>\n\n                <div className=\"p-4\">\n                  <div className=\"space-y-3\">\n                    {stageGroups\n                      .sort((a, b) => (a.display_order || 999) - (b.display_order || 999))\n                      .map((group, index) => (\n                        <div\n                          key={group.id}\n                          className=\"bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200 hover:shadow-md transition-all\"\n                        >\n                          {editingGroup?.id === group.id ? (\n                            <div className=\"space-y-3\">\n                              <div className=\"grid grid-cols-2 gap-3\">\n                                <input\n                                  type=\"text\"\n                                  value={editStage}\n                                  onChange={(e) => setEditStage(e.target.value)}\n                                  className=\"px-3 py-2 border-2 border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                                  placeholder=\"الصف\"\n                                />\n                                <input\n                                  type=\"text\"\n                                  value={editName}\n                                  onChange={(e) => setEditName(e.target.value)}\n                                  className=\"px-3 py-2 border-2 border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                                  placeholder=\"اسم المجموعة\"\n                                />\n                              </div>\n                              <div className=\"flex gap-2\">\n                                <button\n                                  onClick={handleSaveEdit}\n                                  className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-semibold transition-colors\"\n                                >\n                                  حفظ\n                                </button>\n                                <button\n                                  onClick={handleCancelEdit}\n                                  className=\"flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded-lg font-semibold transition-colors\"\n                                >\n                                  إلغاء\n                                </button>\n                              </div>\n                            </div>\n                          ) : (\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex-1\">\n                                <h4 className=\"font-bold text-gray-800 text-lg mb-1\">{group.name}</h4>\n                                <p className=\"text-sm text-teal-700 font-semibold\">\n                                  {getStudentCount(group.id)} طالب\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <div className=\"flex flex-col gap-1\">\n                                  <button\n                                    onClick={() => handleMoveUp(group, stageGroups)}\n                                    disabled={index === 0}\n                                    className=\"text-emerald-600 hover:bg-emerald-100 p-1 rounded transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                                    title=\"تحريك لأعلى\"\n                                  >\n                                    <ChevronUp size={18} />\n                                  </button>\n                                  <button\n                                    onClick={() => handleMoveDown(group, stageGroups)}\n                                    disabled={index === stageGroups.length - 1}\n                                    className=\"text-emerald-600 hover:bg-emerald-100 p-1 rounded transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                                    title=\"تحريك لأسفل\"\n                                  >\n                                    <ChevronDown size={18} />\n                                  </button>\n                                </div>\n                                <button\n                                  onClick={() => handleEditGroup(group)}\n                                  className=\"text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors\"\n                                  title=\"تعديل المجموعة\"\n                                >\n                                  <Edit2 size={18} />\n                                </button>\n                                <button\n                                  onClick={() => handleDeleteGroup(group.id)}\n                                  className=\"text-red-500 hover:bg-red-50 p-2 rounded transition-colors\"\n                                  title=\"حذف المجموعة\"\n                                >\n                                  <Trash2 size={18} />\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":16011},"src/pages/TeachersPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Teacher, Group, TeacherGroup } from '../types'\nimport { Users, Plus, Edit2, Trash2, BookOpen } from 'lucide-react'\n\ninterface TeacherWithGroups extends Teacher {\n  teacher_groups?: TeacherGroup[]\n  groups?: Group[]\n}\n\nexport function TeachersPage() {\n  const [teachers, setTeachers] = useState<TeacherWithGroups[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [loading, setLoading] = useState(true)\n  const [showModal, setShowModal] = useState(false)\n  const [editingTeacher, setEditingTeacher] = useState<Teacher | null>(null)\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  const fetchData = async () => {\n    setLoading(true)\n\n    const [teachersRes, groupsRes, teacherGroupsRes] = await Promise.all([\n      supabase.from('teachers').select('*').order('name'),\n      supabase.from('groups').select('*').order('name'),\n      supabase.from('teacher_groups').select('*, groups(*)')\n    ])\n\n    if (groupsRes.data) setGroups(groupsRes.data)\n\n    if (teachersRes.data) {\n      const teachersWithGroups = teachersRes.data.map(teacher => ({\n        ...teacher,\n        groups: teacherGroupsRes.data\n          ?.filter(tg => tg.teacher_id === teacher.id)\n          .map(tg => tg.groups)\n          .filter(Boolean) as Group[]\n      }))\n      setTeachers(teachersWithGroups)\n    }\n\n    setLoading(false)\n  }\n\n  const handleAddNew = () => {\n    setEditingTeacher(null)\n    setShowModal(true)\n  }\n\n  const handleEdit = (teacher: Teacher) => {\n    setEditingTeacher(teacher)\n    setShowModal(true)\n  }\n\n  const handleDelete = async (teacherId: string) => {\n    if (!confirm('هل أنت متأكد من حذف هذا المعلم؟')) return\n\n    const { error } = await supabase\n      .from('teachers')\n      .delete()\n      .eq('id', teacherId)\n\n    if (error) {\n      alert('حدث خطأ أثناء الحذف')\n      console.error(error)\n    } else {\n      fetchData()\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-r from-blue-600 to-blue-500 rounded-2xl shadow-lg p-8 text-white\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n              <Users size={32} />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold\">المعلمين</h1>\n              <p className=\"text-blue-100 text-lg mt-1\">\n                إجمالي المعلمين: {teachers.length}\n              </p>\n            </div>\n          </div>\n          <button\n            onClick={handleAddNew}\n            className=\"flex items-center gap-2 px-6 py-3 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition-all hover:shadow-md\"\n          >\n            <Plus size={20} />\n            <span>إضافة معلم</span>\n          </button>\n        </div>\n      </div>\n\n      {loading ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center\">\n          <p className=\"text-gray-500 text-lg\">جاري التحميل...</p>\n        </div>\n      ) : teachers.length === 0 ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200\">\n          <Users className=\"mx-auto text-gray-300 mb-4\" size={64} />\n          <p className=\"text-gray-500 text-xl mb-4\">لا يوجد معلمين</p>\n          <button\n            onClick={handleAddNew}\n            className=\"inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors\"\n          >\n            <Plus size={20} />\n            <span>إضافة أول معلم</span>\n          </button>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {teachers.map((teacher) => (\n            <div\n              key={teacher.id}\n              className=\"bg-white rounded-xl shadow-md hover:shadow-xl transition-all border border-gray-200 overflow-hidden\"\n            >\n              <div className=\"bg-gradient-to-r from-blue-500 to-blue-400 p-4\">\n                <h3 className=\"text-xl font-bold text-white\">{teacher.name}</h3>\n              </div>\n\n              <div className=\"p-6 space-y-4\">\n                <div className=\"flex items-start gap-3\">\n                  <BookOpen className=\"text-blue-600 mt-0.5 flex-shrink-0\" size={18} />\n                  <div>\n                    <p className=\"text-xs text-gray-500 mb-0.5\">المقرر الدراسي</p>\n                    <p className=\"text-sm font-semibold text-gray-800\">{teacher.specialization}</p>\n                  </div>\n                </div>\n\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"w-5 h-5 flex items-center justify-center text-blue-600 flex-shrink-0\">\n                    <span className=\"text-lg\">📱</span>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-gray-500 mb-0.5\">رقم الجوال</p>\n                    <p className=\"text-sm font-semibold text-gray-800\">{teacher.phone}</p>\n                  </div>\n                </div>\n\n                {teacher.groups && teacher.groups.length > 0 && (\n                  <div className=\"pt-3 border-t border-gray-100\">\n                    <p className=\"text-xs text-gray-500 mb-2\">المجموعات</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {teacher.groups.map((group) => (\n                        <span\n                          key={group.id}\n                          className=\"px-2 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-lg\"\n                        >\n                          {group.name}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"flex gap-2 pt-4 border-t border-gray-100\">\n                  <button\n                    onClick={() => handleEdit(teacher)}\n                    className=\"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-medium hover:bg-blue-100 transition-colors\"\n                  >\n                    <Edit2 size={16} />\n                    <span>تعديل</span>\n                  </button>\n                  <button\n                    onClick={() => handleDelete(teacher.id)}\n                    className=\"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg font-medium hover:bg-red-100 transition-colors\"\n                  >\n                    <Trash2 size={16} />\n                    <span>حذف</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {showModal && (\n        <TeacherFormModal\n          teacher={editingTeacher}\n          groups={groups}\n          onClose={() => setShowModal(false)}\n          onSave={fetchData}\n        />\n      )}\n    </div>\n  )\n}\n\ninterface TeacherFormModalProps {\n  teacher: Teacher | null\n  groups: Group[]\n  onClose: () => void\n  onSave: () => void\n}\n\nfunction TeacherFormModal({ teacher, groups, onClose, onSave }: TeacherFormModalProps) {\n  const [name, setName] = useState(teacher?.name || '')\n  const [phone, setPhone] = useState(teacher?.phone || '')\n  const [specialization, setSpecialization] = useState(teacher?.specialization || '')\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])\n  const [loading, setLoading] = useState(false)\n  const [loadingGroups, setLoadingGroups] = useState(true)\n\n  useEffect(() => {\n    if (teacher) {\n      fetchTeacherGroups()\n    } else {\n      setLoadingGroups(false)\n    }\n  }, [teacher])\n\n  const fetchTeacherGroups = async () => {\n    if (!teacher) return\n\n    const { data } = await supabase\n      .from('teacher_groups')\n      .select('group_id')\n      .eq('teacher_id', teacher.id)\n\n    if (data) {\n      setSelectedGroupIds(data.map(tg => tg.group_id))\n    }\n    setLoadingGroups(false)\n  }\n\n  const toggleGroup = (groupId: string) => {\n    if (selectedGroupIds.includes(groupId)) {\n      setSelectedGroupIds(selectedGroupIds.filter(id => id !== groupId))\n    } else {\n      setSelectedGroupIds([...selectedGroupIds, groupId])\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!name.trim() || !phone.trim() || !specialization.trim()) {\n      alert('الرجاء تعبئة جميع الحقول المطلوبة')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      if (teacher) {\n        const { error: updateError } = await supabase\n          .from('teachers')\n          .update({\n            name: name.trim(),\n            phone: phone.trim(),\n            specialization: specialization.trim()\n          })\n          .eq('id', teacher.id)\n\n        if (updateError) {\n          console.error('Update error:', updateError)\n          throw new Error(`فشل تحديث المعلم: ${updateError.message}`)\n        }\n\n        const { error: deleteError } = await supabase\n          .from('teacher_groups')\n          .delete()\n          .eq('teacher_id', teacher.id)\n\n        if (deleteError) {\n          console.error('Delete groups error:', deleteError)\n        }\n\n        if (selectedGroupIds.length > 0) {\n          const teacherGroupsData = selectedGroupIds.map(groupId => ({\n            teacher_id: teacher.id,\n            group_id: groupId,\n          }))\n\n          const { error: groupsError } = await supabase\n            .from('teacher_groups')\n            .insert(teacherGroupsData)\n\n          if (groupsError) {\n            console.error('Insert groups error:', groupsError)\n            throw new Error(`فشل ربط المجموعات: ${groupsError.message}`)\n          }\n        }\n      } else {\n        const { data: newTeacher, error: insertError } = await supabase\n          .from('teachers')\n          .insert({\n            name: name.trim(),\n            phone: phone.trim(),\n            specialization: specialization.trim()\n          })\n          .select()\n          .single()\n\n        if (insertError) {\n          console.error('Insert error:', insertError)\n          throw new Error(`فشل إضافة المعلم: ${insertError.message}`)\n        }\n\n        if (newTeacher && selectedGroupIds.length > 0) {\n          const teacherGroupsData = selectedGroupIds.map(groupId => ({\n            teacher_id: newTeacher.id,\n            group_id: groupId,\n          }))\n\n          const { error: groupsError } = await supabase\n            .from('teacher_groups')\n            .insert(teacherGroupsData)\n\n          if (groupsError) {\n            console.error('Insert groups error:', groupsError)\n            throw new Error(`فشل ربط المجموعات: ${groupsError.message}`)\n          }\n        }\n      }\n\n      onSave()\n      onClose()\n    } catch (error: any) {\n      console.error('Error saving teacher:', error)\n      const errorMessage = error?.message || 'حدث خطأ غير معروف'\n      alert(`حدث خطأ أثناء الحفظ:\\n${errorMessage}`)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <h2 className=\"text-2xl font-bold text-gray-900\">\n            {teacher ? 'تعديل بيانات المعلم' : 'إضافة معلم جديد'}\n          </h2>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            ✕\n          </button>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اسم المعلم <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"مثال: أ. محمد أحمد\"\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              رقم الجوال <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"tel\"\n              value={phone}\n              onChange={(e) => setPhone(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"05xxxxxxxx\"\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              المقرر الدراسي <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              value={specialization}\n              onChange={(e) => setSpecialization(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"مثال: رياضيات، لغة عربية، علوم\"\n              required\n            />\n          </div>\n\n          {loadingGroups ? (\n            <div className=\"text-center py-4 text-gray-500\">جاري تحميل المجموعات...</div>\n          ) : groups.length > 0 ? (\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-3\">\n                المجموعات التي يدرسها (اختياري)\n              </label>\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4\">\n                {groups.map((group) => {\n                  const isSelected = selectedGroupIds.includes(group.id)\n                  return (\n                    <button\n                      key={group.id}\n                      type=\"button\"\n                      onClick={() => toggleGroup(group.id)}\n                      className={`p-3 rounded-lg border-2 transition-all text-sm font-medium ${\n                        isSelected\n                          ? 'bg-blue-50 border-blue-500 text-blue-900'\n                          : 'bg-gray-50 border-gray-300 text-gray-700 hover:border-gray-400'\n                      }`}\n                    >\n                      {group.name}\n                    </button>\n                  )\n                })}\n              </div>\n            </div>\n          ) : null}\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg transition-colors\"\n            >\n              {loading ? 'جاري الحفظ...' : teacher ? 'حفظ التعديلات' : 'إضافة المعلم'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":15817},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"../shared/schema.js\";\n\nneonConfig.webSocketConstructor = ws;\n\n// جعل قاعدة البيانات اختيارية - النظام يعمل بدون PostgreSQL\nconst dbUrl = process.env.DATABASE_URL || '';\n\nexport const pool = dbUrl ? new Pool({ connectionString: dbUrl }) : null;\nexport const db = pool ? drizzle({ client: pool, schema }) : null;\n","size_bytes":511},"src/types/index.ts":{"content":"export interface Group {\n  id: string\n  name: string\n  stage: string\n  display_order: number\n  created_at: string\n}\n\nexport interface SpecialStatus {\n  id: string\n  name: string\n  created_at: string\n}\n\nexport interface Student {\n  id: string\n  name: string\n  national_id: string\n  phone: string\n  guardian_phone: string\n  grade: string\n  group_id: string\n  status: 'نشط' | 'استئذان'\n  special_status_id: string | null\n  visit_count: number\n  permission_count: number\n  violation_count: number\n  created_at: string\n  updated_at: string\n  group?: Group\n  special_status?: SpecialStatus\n}\n\nexport interface StudentVisit {\n  id: string\n  student_id: string\n  visit_date: string\n  reason: string\n  action_taken: string\n  referred_to: 'لا يوجد' | 'مشرف صحي' | 'وكيل' | 'مدير' | 'معلم'\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface StudentPermission {\n  id: string\n  student_id: string\n  permission_date: string\n  reason: string\n  guardian_notified: boolean\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface SchoolInfo {\n  id: string\n  school_name: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface StudentViolation {\n  id: string\n  student_id: string\n  violation_date: string\n  violation_type: 'هروب من الحصة' | 'غياب بدون عذر' | 'تأخر صباحي' | 'عدم إحضار الكتب' | 'سلوك غير لائق' | 'استخدام الجوال' | 'عدم ارتداء الزي المدرسي' | 'أخرى'\n  description: string\n  action_taken: string\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface Teacher {\n  id: string\n  name: string\n  phone: string\n  specialization: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface TeacherGroup {\n  id: string\n  teacher_id: string\n  group_id: string\n  created_at: string\n  teacher?: Teacher\n  group?: Group\n}\n","size_bytes":1925},"eslint.config.js":{"content":"import js from '@eslint/js';\nimport globals from 'globals';\nimport reactHooks from 'eslint-plugin-react-hooks';\nimport reactRefresh from 'eslint-plugin-react-refresh';\nimport tseslint from 'typescript-eslint';\n\nexport default tseslint.config(\n  { ignores: ['dist'] },\n  {\n    extends: [js.configs.recommended, ...tseslint.configs.recommended],\n    files: ['**/*.{ts,tsx}'],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: globals.browser,\n    },\n    plugins: {\n      'react-hooks': reactHooks,\n      'react-refresh': reactRefresh,\n    },\n    rules: {\n      ...reactHooks.configs.recommended.rules,\n      'react-refresh/only-export-components': [\n        'warn',\n        { allowConstantExport: true },\n      ],\n    },\n  }\n);\n","size_bytes":739},"src/components/ManageModal.tsx":{"content":"import { useState } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { X, Trash2, Plus } from 'lucide-react'\n\ninterface ManageModalProps {\n  type: 'groups' | 'special_statuses'\n  isOpen: boolean\n  onClose: () => void\n  onDataUpdated: () => void\n  existingItems: Array<{ id: string; name: string; stage?: string }>\n}\n\nexport function ManageModal({\n  type,\n  isOpen,\n  onClose,\n  onDataUpdated,\n  existingItems,\n}: ManageModalProps) {\n  const [newItem, setNewItem] = useState('')\n  const [newStage, setNewStage] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [deleteLoading, setDeleteLoading] = useState<string | null>(null)\n\n  const handleAdd = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (type === 'groups') {\n      if (!newStage.trim() || !newItem.trim()) {\n        setError('يرجى ملء جميع الحقول')\n        return\n      }\n    } else {\n      if (!newItem.trim()) return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      if (type === 'groups') {\n        const newId = crypto.randomUUID()\n\n        // Get the highest display_order for this stage\n        const stageGroups = await db.groups\n          .where('stage')\n          .equals(newStage.trim())\n          .toArray()\n        const maxOrder = stageGroups.length > 0\n          ? Math.max(...stageGroups.map(g => g.display_order || 0))\n          : 0\n\n        await db.groups.add({\n          id: newId,\n          stage: newStage.trim(),\n          name: newItem.trim(),\n          display_order: maxOrder + 1,\n          created_at: new Date().toISOString(),\n        })\n      } else {\n        const { error } = await supabase\n          .from('special_statuses')\n          .insert({\n            name: newItem.trim(),\n          })\n\n        if (error) throw error\n      }\n\n      setNewItem('')\n      setNewStage('')\n      onDataUpdated()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDelete = async (id: string) => {\n    if (!window.confirm('هل أنت متأكد من الحذف؟')) return\n\n    setDeleteLoading(id)\n    try {\n      if (type === 'groups') {\n        await db.groups.delete(id)\n      } else {\n        const { error } = await supabase\n          .from('special_statuses')\n          .delete()\n          .eq('id', id)\n\n        if (error) throw error\n      }\n      onDataUpdated()\n    } finally {\n      setDeleteLoading(null)\n    }\n  }\n\n  if (!isOpen) return null\n\n  const title = type === 'groups' ? 'إدارة المجموعات' : 'إدارة الحالات الخاصة'\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col\">\n        <div className=\"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-blue-500\">\n          <h2 className=\"text-xl font-bold text-white\">{title}</h2>\n          <button\n            onClick={onClose}\n            className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-6\">\n          {error && (\n            <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm\">\n              {error}\n            </div>\n          )}\n\n          <div className=\"space-y-3\">\n            {existingItems.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-500\">\n                {type === 'groups' ? 'لا توجد مجموعات' : 'لا توجد حالات خاصة'}\n              </div>\n            ) : (\n              existingItems.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200\"\n                >\n                  <span className=\"font-medium text-gray-800\">\n                    {type === 'groups' && item.stage ? `${item.stage} - ${item.name}` : item.name}\n                  </span>\n                  <button\n                    onClick={() => handleDelete(item.id)}\n                    disabled={deleteLoading === item.id}\n                    className=\"p-1 text-red-600 hover:bg-red-50 rounded disabled:opacity-50 transition-colors\"\n                  >\n                    <Trash2 size={18} />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n\n        <div className=\"border-t border-gray-200 p-6 bg-gray-50\">\n          <form onSubmit={handleAdd} className=\"space-y-3\">\n            {type === 'groups' && (\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الصف (المرحلة)\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: الصف الأول الثانوي\"\n                  value={newStage}\n                  onChange={(e) => setNewStage(e.target.value)}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n            )}\n            <div>\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                {type === 'groups' ? 'اسم المجموعة' : 'اسم الحالة الخاصة'}\n              </label>\n              <input\n                type=\"text\"\n                placeholder={type === 'groups' ? 'مثال: مجموعة 1' : 'أضف جديد...'}\n                value={newItem}\n                onChange={(e) => setNewItem(e.target.value)}\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              />\n            </div>\n            <button\n              type=\"submit\"\n              disabled={loading || !newItem.trim() || (type === 'groups' && !newStage.trim())}\n              className=\"w-full px-4 py-3 bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Plus size={20} />\n              {type === 'groups' ? 'إضافة المجموعة' : 'إضافة'}\n            </button>\n          </form>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6616},"src/components/EditStudentModal.tsx":{"content":"import { useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Group, SpecialStatus, Student } from '../types'\nimport { X } from 'lucide-react'\n\ninterface EditStudentModalProps {\n  student: Student\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n  onClose: () => void\n  onStudentUpdated: () => void\n}\n\nexport function EditStudentModal({\n  student,\n  groups,\n  specialStatuses,\n  onClose,\n  onStudentUpdated,\n}: EditStudentModalProps) {\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [formData, setFormData] = useState({\n    name: student.name,\n    national_id: student.national_id,\n    phone: student.phone,\n    guardian_phone: student.guardian_phone,\n    grade: student.grade,\n    group_id: student.group_id,\n    special_status_id: student.special_status_id || '',\n  })\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      const data = {\n        name: formData.name,\n        national_id: formData.national_id,\n        phone: formData.phone,\n        guardian_phone: formData.guardian_phone,\n        grade: formData.grade,\n        group_id: formData.group_id,\n        special_status_id: formData.special_status_id || null,\n      }\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update(data)\n        .eq('id', student.id)\n\n      if (updateError) throw updateError\n\n      onStudentUpdated()\n      onClose()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-white z-50 overflow-y-auto\">\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-gray-50\">\n        <div className=\"max-w-4xl mx-auto p-6\">\n          <div className=\"bg-white rounded-2xl shadow-xl overflow-hidden\">\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 px-8 py-6 flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">تعديل الطالب</h2>\n              <button\n                onClick={onClose}\n                className=\"text-white hover:bg-white/20 p-2 rounded-lg transition-colors\"\n              >\n                <X size={28} />\n              </button>\n            </div>\n\n            <div className=\"p-8\">\n              {error && (\n                <div className=\"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg\">\n                  {error}\n                </div>\n              )}\n\n              <form onSubmit={handleSubmit} className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      اسم الطالب\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.name}\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      السجل المدني\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.national_id}\n                      onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      جوال الطالب\n                    </label>\n                    <input\n                      type=\"tel\"\n                      required\n                      value={formData.phone}\n                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      جوال ولي الأمر\n                    </label>\n                    <input\n                      type=\"tel\"\n                      required\n                      value={formData.guardian_phone}\n                      onChange={(e) => setFormData({ ...formData, guardian_phone: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الصف\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.grade}\n                      onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      المجموعة\n                    </label>\n                    <select\n                      required\n                      value={formData.group_id}\n                      onChange={(e) => setFormData({ ...formData, group_id: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white\"\n                    >\n                      <option value=\"\">اختر مجموعة</option>\n                      {groups.map((group) => (\n                        <option key={group.id} value={group.id}>\n                          {group.name}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n\n                  <div className=\"md:col-span-2\">\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الحالة الخاصة (اختياري)\n                    </label>\n                    <select\n                      value={formData.special_status_id}\n                      onChange={(e) =>\n                        setFormData({ ...formData, special_status_id: e.target.value })\n                      }\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white\"\n                    >\n                      <option value=\"\">بدون حالة خاصة</option>\n                      {specialStatuses.map((status) => (\n                        <option key={status.id} value={status.id}>\n                          {status.name}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-4 pt-6\">\n                  <button\n                    type=\"submit\"\n                    disabled={loading}\n                    className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transition-all\"\n                  >\n                    {loading ? 'جاري الحفظ...' : 'تحديث الطالب'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={onClose}\n                    className=\"px-8 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl text-lg transition-colors\"\n                  >\n                    إلغاء\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":8793},"tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nexport default {\n  content: ['./client/index.html', './client/src/**/*.{js,ts,jsx,tsx}'],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n};\n","size_bytes":184},"vite.config.ts":{"content":"import { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\nimport path from 'path';\n\nexport default defineConfig({\n  plugins: [react()],\n  server: {\n    host: '0.0.0.0',\n    port: 5000,\n    allowedHosts: ['.replit.dev'],\n    hmr: {\n      clientPort: 443,\n    },\n  },\n  resolve: {\n    alias: {\n      '@': path.resolve(__dirname, './client/src'),\n      '@shared': path.resolve(__dirname, './shared'),\n      '@assets': path.resolve(__dirname, './attached_assets'),\n    },\n  },\n  optimizeDeps: {\n    exclude: ['lucide-react'],\n  },\n  root: path.resolve(__dirname, 'client'),\n  build: {\n    outDir: path.resolve(__dirname, 'dist/public'),\n    emptyOutDir: true,\n  },\n});","size_bytes":685},"src/lib/supabase.ts":{"content":"import { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables')\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\n","size_bytes":342},"src/pages/PermissionPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db, StudentPermission } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student } from '../types'\nimport { LogOut, Search, Send, Clock, Printer, Calendar, Filter } from 'lucide-react'\n\ninterface PermissionWithStudent extends StudentPermission {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    permission_count: number\n    group?: { name: string }\n  }\n}\n\nexport function PermissionPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [permissions, setPermissions] = useState<PermissionWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [formData, setFormData] = useState({\n    reason: '',\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchPermissions()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    try {\n      // جلب الطلاب من Supabase\n      const { data: studentsData, error: studentsError } = await supabase\n        .from('students')\n        .select('*')\n        .eq('status', 'نشط')\n        .order('name')\n\n      if (studentsError) {\n        console.error('Error fetching students:', studentsError)\n        return\n      }\n\n      // جلب المجموعات من Supabase\n      const { data: groupsData } = await supabase\n        .from('groups')\n        .select('*')\n\n      // جلب الحالات الخاصة من Supabase\n      const { data: statusesData } = await supabase\n        .from('special_statuses')\n        .select('*')\n\n      const groups = groupsData || []\n      const statuses = statusesData || []\n\n      const studentsWithRelations = (studentsData || []).map(student => {\n        const group = groups.find(g => g.id === student.group_id)\n        const special_status = statuses.find(s => s.id === student.special_status_id)\n        return {\n          ...student,\n          group: group ? { name: group.name } : undefined,\n          special_status: special_status ? { name: special_status.name } : undefined\n        }\n      })\n\n      setStudents(studentsWithRelations as Student[])\n\n      // تحديث IndexedDB المحلية\n      if (studentsData) {\n        await db.students.bulkPut(studentsData)\n      }\n      if (groups.length > 0) {\n        await db.groups.bulkPut(groups)\n      }\n      if (statuses.length > 0) {\n        await db.special_statuses.bulkPut(statuses)\n      }\n    } catch (error) {\n      console.error('Error in fetchStudents:', error)\n    }\n  }\n\n  async function fetchPermissions(filterDate?: string) {\n    try {\n      // إعداد الفلتر الزمني\n      let query = supabase\n        .from('student_permissions')\n        .select('*')\n        .order('permission_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('permission_date', startOfDay.toISOString())\n          .lte('permission_date', endOfDay.toISOString())\n      } else {\n        const today = new Date()\n        today.setHours(0, 0, 0, 0)\n        query = query.gte('permission_date', today.toISOString())\n      }\n\n      const { data: permissionsData, error: permissionsError } = await query\n\n      if (permissionsError) {\n        console.error('Error fetching permissions:', permissionsError)\n        return\n      }\n\n      // جلب المجموعات والطلاب\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const groups = groupsData || []\n      const allStudents = studentsData || []\n\n      const permissionsWithStudents = (permissionsData || []).map((permission) => {\n        const student = allStudents.find(s => s.id === permission.student_id)\n        const group = student ? groups.find(g => g.id === student.group_id) : undefined\n        return {\n          ...permission,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            permission_count: student.permission_count || 0,\n            group: group ? { name: group.name } : undefined\n          } : undefined\n        }\n      })\n\n      setPermissions(permissionsWithStudents)\n\n      // تحديث IndexedDB المحلية\n      if (permissionsData) {\n        await db.student_permissions.bulkPut(permissionsData.map(p => ({\n          id: p.id,\n          student_id: p.student_id,\n          permission_date: p.permission_date,\n          reason: p.reason,\n          guardian_notified: p.guardian_notified,\n          notes: p.notes || '',\n          created_at: p.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error in fetchPermissions:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const permissionDate = new Date().toISOString()\n      const currentCount = selectedStudent.permission_count || 0\n\n      // حفظ الاستئذان في Supabase\n      const { data: permissionData, error: permissionError } = await supabase\n        .from('student_permissions')\n        .insert({\n          student_id: selectedStudent.id,\n          permission_date: permissionDate,\n          reason: formData.reason,\n          notes: formData.notes,\n          guardian_notified: true\n        })\n        .select()\n        .single()\n\n      if (permissionError) {\n        console.error('Error saving permission:', permissionError)\n        throw permissionError\n      }\n\n      // تحديث حالة الطالب في Supabase\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({\n          status: 'استئذان',\n          permission_count: currentCount + 1\n        })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) {\n        console.error('Error updating student:', updateError)\n        throw updateError\n      }\n\n      // حفظ في IndexedDB المحلية\n      if (permissionData) {\n        await db.student_permissions.add({\n          id: permissionData.id,\n          student_id: permissionData.student_id,\n          permission_date: permissionData.permission_date,\n          reason: permissionData.reason,\n          guardian_notified: permissionData.guardian_notified,\n          notes: permissionData.notes || '',\n          created_at: permissionData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        status: 'استئذان',\n        permission_count: currentCount + 1\n      })\n\n      sendWhatsAppNotification(selectedStudent, formData.reason)\n\n      alert('تم تسجيل الاستئذان وإرسال رسالة لولي الأمر')\n      setFormData({ reason: '', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchPermissions(dateFilter)\n    } catch (error) {\n      console.error('Error saving permission:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  function sendWhatsAppNotification(student: Student, reason: string) {\n    if (!student.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const now = new Date()\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${student.name}\nالفصل: ${student.group?.name}\n\nنود إعلامكم بأن الطالب قد استأذن بالمغادرة من المدرسة.\n\n⏰ الوقت: ${now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n📅 التاريخ: ${now.toLocaleDateString('ar-SA')}\n📝 السبب: ${reason}\n\nيرجى استلام الطالب من المدرسة.\n\nمع تحيات إدارة المدرسة`\n\n    const phone = student.guardian_phone.replace(/\\D/g, '')\n    const whatsappUrl = `https://wa.me/966${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  function sendWhatsAppForPermission(permission: PermissionWithStudent) {\n    if (!permission.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const permissionDate = new Date(permission.permission_date)\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${permission.student.name}\nالفصل: ${permission.student.group?.name}\n\nنود إعلامكم بأن الطالب قد استأذن بالمغادرة من المدرسة.\n\n⏰ الوقت: ${permissionDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n📅 التاريخ: ${permissionDate.toLocaleDateString('ar-SA')}\n📝 السبب: ${permission.reason}\n\nيرجى استلام الطالب من المدرسة.\n\nمع تحيات إدارة المدرسة`\n\n    const phone = permission.student.guardian_phone.replace(/\\D/g, '')\n    const whatsappUrl = `https://wa.me/966${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  async function printPermission(permission: PermissionWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    const permissionDate = new Date(permission.permission_date)\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>إذن مغادرة طالب</title>\n          <style>\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; }\n            .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }\n            .header h1 { margin: 0; color: #ea580c; }\n            .header .meta { color: #666; font-size: 12px; margin-top: 10px; }\n            .section { margin-bottom: 20px; }\n            .section label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }\n            .section div { padding: 10px; background: #fef3c7; border-radius: 5px; border: 1px solid #fcd34d; }\n            .time-box { background: #dbeafe; border: 1px solid #60a5fa; font-size: 18px; text-align: center; padding: 15px; }\n            @media print { body { padding: 20px; } }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>⚠️ إذن مغادرة طالب</h1>\n            ${teacherName ? `<div class=\"meta\">بواسطة: ${teacherName}</div>` : ''}\n          </div>\n          <div class=\"section\">\n            <label>اسم الطالب:</label>\n            <div>${permission.student?.name}</div>\n          </div>\n          <div class=\"section\">\n            <label>الفصل:</label>\n            <div>${permission.student?.group?.name || '-'}</div>\n          </div>\n          <div class=\"section\">\n            <label>⏰ وقت الاستئذان:</label>\n            <div class=\"time-box\">\n              ${permissionDate.toLocaleString('ar-SA', {\n                weekday: 'long',\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric',\n                hour: '2-digit',\n                minute: '2-digit'\n              })}\n            </div>\n          </div>\n          <div class=\"section\">\n            <label>سبب الاستئذان:</label>\n            <div>${permission.reason}</div>\n          </div>\n          ${permission.notes ? `\n          <div class=\"section\">\n            <label>ملاحظات:</label>\n            <div>${permission.notes}</div>\n          </div>\n          ` : ''}\n          <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px dashed #ccc;\">\n            <p style=\"text-align: center; color: #666; font-size: 14px;\">\n              تم إشعار ولي الأمر عبر واتساب<br>\n              الرجاء التأكد من استلام الطالب من قبل ولي الأمر\n            </p>\n          </div>\n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  async function returnStudent(permission: PermissionWithStudent) {\n    if (!permission.student) return\n\n    const confirmReturn = confirm(`هل تريد تأكيد عودة الطالب: ${permission.student.name}؟`)\n    if (!confirmReturn) return\n\n    try {\n      // تحديث في Supabase\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ status: 'نشط' })\n        .eq('id', permission.student_id)\n\n      if (updateError) {\n        console.error('Error updating student:', updateError)\n        throw updateError\n      }\n\n      // تحديث في IndexedDB\n      await db.students.update(permission.student_id, { status: 'نشط' })\n\n      alert('تم تأكيد عودة الطالب')\n      fetchStudents()\n      fetchPermissions(dateFilter)\n    } catch (error) {\n      console.error('Error updating student status:', error)\n      alert('حدث خطأ أثناء تحديث الحالة')\n    }\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <LogOut size={28} className=\"text-orange-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">الاستئذان</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-orange-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-orange-600 font-semibold mt-1\">\n                      عدد الاستئذانات: {student.permission_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-orange-50 rounded-lg p-4 border border-orange-200\">\n                <h3 className=\"font-bold text-orange-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد الاستئذانات السابقة:</span>\n                    <span className=\"text-orange-600 font-bold mr-2\">{selectedStudent.permission_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  سبب الاستئذان\n                </label>\n                <textarea\n                  required\n                  value={formData.reason}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب سبب الاستئذان...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل الاستئذان وإشعار ولي الأمر'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <Clock size={24} />\n            سجل الاستئذانات {dateFilter ? 'المفلترة' : 'اليوم'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchPermissions(dateFilter)}\n                className=\"px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchPermissions()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-orange-600 font-semibold mt-3\">\n                عرض الاستئذانات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {permissions.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد استئذانات {dateFilter ? 'في هذا التاريخ' : 'اليوم'}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {permissions.map(permission => (\n              <div key={permission.id} className=\"border border-orange-200 rounded-lg p-4 bg-orange-50\">\n                <div className=\"flex justify-between items-start mb-3\">\n                  <div>\n                    <h4 className=\"font-bold text-gray-800\">{permission.student?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">{permission.student?.group?.name}</p>\n                    <p className=\"text-sm text-orange-600 font-semibold mt-1\">\n                      <Clock size={14} className=\"inline ml-1\" />\n                      {new Date(permission.permission_date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      onClick={() => printPermission(permission)}\n                      className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Printer size={16} />\n                      طباعة\n                    </button>\n                    <button\n                      onClick={() => sendWhatsAppForPermission(permission)}\n                      className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Send size={16} />\n                      واتساب\n                    </button>\n                    <button\n                      onClick={() => returnStudent(permission)}\n                      className=\"px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors\"\n                    >\n                      عودة الطالب\n                    </button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div><span className=\"font-semibold\">السبب:</span> {permission.reason}</div>\n                  {permission.notes && (\n                    <div className=\"text-gray-600\">\n                      <span className=\"font-semibold\">ملاحظات:</span> {permission.notes}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":23708},"src/components/SearchBar.tsx":{"content":"import { Search } from 'lucide-react'\n\ninterface SearchBarProps {\n  value: string\n  onChange: (value: string) => void\n  placeholder?: string\n}\n\nexport function SearchBar({\n  value,\n  onChange,\n  placeholder = 'ابحث عن طالب...',\n}: SearchBarProps) {\n  return (\n    <div className=\"relative\">\n      <Search className=\"absolute right-3 top-3 text-gray-400\" size={20} />\n      <input\n        type=\"text\"\n        placeholder={placeholder}\n        value={value}\n        onChange={(e) => onChange(e.target.value)}\n        className=\"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n      />\n    </div>\n  )\n}\n","size_bytes":672},"src/components/ExcelImport.tsx":{"content":"import { useState, useRef } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db } from '../lib/db'\nimport { Upload, AlertCircle, Users, GraduationCap } from 'lucide-react'\nimport * as XLSX from 'xlsx'\n\ninterface ExcelImportProps {\n  groups?: Array<{ id: string; name: string }>\n  onImportComplete: () => void\n}\n\ntype ImportType = 'students' | 'teachers'\n\nexport function ExcelImport({ groups, onImportComplete }: ExcelImportProps) {\n  const studentsFileInputRef = useRef<HTMLInputElement>(null)\n  const teachersFileInputRef = useRef<HTMLInputElement>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  const handleStudentsImport = async (\n    event: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const arrayBuffer = await file.arrayBuffer()\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const sheetName = workbook.SheetNames[0]\n      const worksheet = workbook.Sheets[sheetName]\n      const data = XLSX.utils.sheet_to_json(worksheet)\n\n      if (!data || data.length === 0) {\n        throw new Error('الملف فارغ أو صيغته غير صحيحة')\n      }\n\n      // التحقق من وجود الأعمدة المطلوبة للطلاب\n      const requiredColumns = ['اسم الطالب', 'السجل المدني', 'الصف', 'المجموعة']\n      const firstRow = data[0] as any\n      const missingColumns = requiredColumns.filter(col => !(col in firstRow))\n\n      if (missingColumns.length > 0) {\n        throw new Error(`الملف يفتقد الأعمدة التالية: ${missingColumns.join('، ')}\\n\\nالأعمدة المطلوبة:\\n- اسم الطالب\\n- السجل المدني\\n- الصف\\n- المجموعة\\n- جوال الطالب (اختياري)\\n- جوال ولي الامر (اختياري)\\n- الحالة (اختياري)`)\n      }\n\n      // استخراج المجموعات الفريدة مع المراحل من الملف\n      const uniqueGroups = [\n        ...new Map(\n          data\n            .filter((row: any) => row['المجموعة'] && row['الصف'])\n            .map((row: any) => {\n              const stage = String(row['الصف'] || '').trim()\n              const name = String(row['المجموعة'] || '').trim()\n              return [`${stage}|${name}`, { stage, name }]\n            })\n            .filter(([key, group]: any) => group.stage && group.name)\n        ).values(),\n      ]\n\n      // جلب المجموعات الموجودة حالياً\n      const { data: existingGroups, error: fetchError } = await supabase\n        .from('groups')\n        .select('id, name, stage')\n\n      if (fetchError) throw fetchError\n\n      const existingGroupsMap = new Map(\n        (existingGroups || []).map((g) => [`${g.stage}|${g.name}`, g.id])\n      )\n\n      // إنشاء المجموعات الجديدة فقط\n      const newGroups = uniqueGroups.filter(\n        (group) => !existingGroupsMap.has(`${group.stage}|${group.name}`)\n      )\n\n      if (newGroups.length > 0) {\n        for (const group of newGroups) {\n          try {\n            const newId = crypto.randomUUID()\n            const newGroup = {\n              id: newId,\n              stage: group.stage,\n              name: group.name,\n              display_order: 0,\n              created_at: new Date().toISOString()\n            }\n\n            const { error: insertGroupError } = await supabase\n              .from('groups')\n              .insert(newGroup)\n\n            if (insertGroupError) {\n              console.error('Error creating group:', insertGroupError)\n              throw new Error(`فشل في إنشاء المجموعة \"${group.name}\" في \"${group.stage}\": ${insertGroupError.message}`)\n            }\n\n            existingGroupsMap.set(`${group.stage}|${group.name}`, newId)\n            await db.groups.put(newGroup)\n          } catch (err) {\n            console.error('Error in group creation:', err)\n            throw err\n          }\n        }\n      }\n\n      // جلب الطلاب الموجودين للتحقق من التحديث أو الإضافة\n      const { data: existingStudents, error: studentsError } = await supabase\n        .from('students')\n        .select('id, national_id')\n\n      if (studentsError) throw studentsError\n\n      const existingStudentsMap = new Map(\n        (existingStudents || []).map((s) => [s.national_id, s.id])\n      )\n\n      const insertData: any[] = []\n      const updateData: any[] = []\n      const seenNationalIds = new Set<string>()\n      const duplicatesInFile: string[] = []\n\n      data\n        .filter((row: any) => row['اسم الطالب'] && row['السجل المدني'])\n        .forEach((row: any) => {\n          const stage = String(row['الصف'] || '').trim()\n          const groupName = String(row['المجموعة'] || '').trim()\n\n          if (!stage || !groupName) {\n            console.warn('تخطي طالب بدون صف أو مجموعة:', row)\n            return\n          }\n\n          const groupKey = `${stage}|${groupName}`\n          const groupId = existingGroupsMap.get(groupKey)\n\n          if (!groupId) {\n            console.error('المجموعة غير موجودة:', { stage, groupName, groupKey })\n            console.error('المجموعات المتاحة:', Array.from(existingGroupsMap.keys()))\n            throw new Error(`المجموعة \"${groupName}\" في \"${stage}\" غير موجودة`)\n          }\n\n          const nationalId = String(row['السجل المدني']).trim()\n\n          // التحقق من التكرار في الملف نفسه\n          if (seenNationalIds.has(nationalId)) {\n            duplicatesInFile.push(`${String(row['اسم الطالب']).trim()} (${nationalId})`)\n            return\n          }\n          seenNationalIds.add(nationalId)\n\n          const studentData = {\n            name: String(row['اسم الطالب']).trim(),\n            national_id: nationalId,\n            phone: row['جوال الطالب'] ? String(row['جوال الطالب']).trim() : null,\n            guardian_phone: (row['جوال ولي الامر'] || row['جوالي ولي الامر'] || row['جوال ولي الأمر'])\n              ? String(row['جوال ولي الامر'] || row['جوالي ولي الامر'] || row['جوال ولي الأمر']).trim()\n              : null,\n            grade: stage,\n            group_id: groupId,\n            status: row['الحالة'] && String(row['الحالة']).trim() === 'استئذان' ? 'استئذان' : 'نشط',\n            special_status_id: null,\n          }\n\n          const existingStudentId = existingStudentsMap.get(nationalId)\n          if (existingStudentId) {\n            updateData.push({ id: existingStudentId, ...studentData })\n          } else {\n            insertData.push(studentData)\n          }\n        })\n\n      // إذا كان هناك تكرارات في الملف، اعرض تحذير\n      if (duplicatesInFile.length > 0) {\n        console.warn('طلاب مكررين في الملف:', duplicatesInFile)\n        setError(`تنبيه: تم تخطي ${duplicatesInFile.length} طالب مكرر في الملف:\\n${duplicatesInFile.slice(0, 5).join('\\n')}${duplicatesInFile.length > 5 ? '\\n...' : ''}`)\n      }\n\n      // إضافة الطلاب الجدد واحد بواحد\n      let insertedCount = 0\n      let skippedCount = 0\n\n      for (const studentData of insertData) {\n        try {\n          const { data: insertedStudent, error: insertError } = await supabase\n            .from('students')\n            .insert(studentData)\n            .select()\n            .maybeSingle()\n\n          if (insertError) {\n            if (insertError.code === '23505' && insertError.message.includes('students_national_id_key')) {\n              console.warn(`طالب موجود مسبقاً: ${studentData.name} (${studentData.national_id})`)\n              skippedCount++\n              continue\n            }\n            throw insertError\n          }\n\n          if (insertedStudent) {\n            insertedCount++\n            await db.students.put(insertedStudent)\n          }\n        } catch (err) {\n          console.error('خطأ في إضافة الطالب:', studentData.name, err)\n          skippedCount++\n        }\n      }\n\n      // تحديث الطلاب الموجودين\n      let updatedCount = 0\n      for (const student of updateData) {\n        const { id, ...updateFields } = student\n        const { error: updateError } = await supabase\n          .from('students')\n          .update(updateFields)\n          .eq('id', id)\n\n        if (!updateError) {\n          updatedCount++\n          await db.students.update(id, updateFields)\n        }\n      }\n\n      // رسالة النجاح\n      const messages: string[] = []\n\n      if (insertedCount > 0) {\n        messages.push(`تم إضافة ${insertedCount} طالب جديد`)\n      }\n\n      if (updatedCount > 0) {\n        messages.push(`تم تحديث ${updatedCount} طالب`)\n      }\n\n      if (skippedCount > 0) {\n        messages.push(`تم تخطي ${skippedCount} طالب موجود مسبقاً`)\n      }\n\n      if (newGroups.length > 0) {\n        messages.push(`تم إنشاء ${newGroups.length} مجموعة جديدة`)\n      }\n\n      setSuccess(\n        messages.length > 0 ? messages.join(' • ') : 'تمت العملية بنجاح'\n      )\n      if (studentsFileInputRef.current) {\n        studentsFileInputRef.current.value = ''\n      }\n      onImportComplete()\n    } catch (err) {\n      console.error('خطأ في استيراد الطلاب:', err)\n      const errorMessage = err instanceof Error ? err.message : 'حدث خطأ ما'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleTeachersImport = async (\n    event: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const arrayBuffer = await file.arrayBuffer()\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const sheetName = workbook.SheetNames[0]\n      const worksheet = workbook.Sheets[sheetName]\n      const data = XLSX.utils.sheet_to_json(worksheet)\n\n      if (!data || data.length === 0) {\n        throw new Error('الملف فارغ أو صيغته غير صحيحة')\n      }\n\n      // التحقق من وجود الأعمدة المطلوبة للمعلمين\n      const requiredColumns = ['اسم المعلم', 'رقم جوال المعلم']\n      const firstRow = data[0] as any\n      const missingColumns = requiredColumns.filter(col => !(col in firstRow))\n\n      if (missingColumns.length > 0) {\n        throw new Error(`الملف يفتقد الأعمدة التالية: ${missingColumns.join('، ')}\\n\\nالأعمدة المطلوبة:\\n- اسم المعلم\\n- رقم جوال المعلم\\n- التخصص (اختياري)`)\n      }\n\n      // استيراد المعلمين\n      const teachersData = data\n        .filter((row: any) => row['اسم المعلم'] && row['رقم جوال المعلم'])\n        .map((row: any) => ({\n          name: String(row['اسم المعلم']).trim(),\n          phone: String(row['رقم جوال المعلم']).trim(),\n          specialization: row['التخصص'] ? String(row['التخصص']).trim() : '',\n        }))\n\n      // إزالة المعلمين المكررين في الملف\n      const uniqueTeachersMap = new Map()\n      teachersData.forEach((teacher: any) => {\n        const key = teacher.phone\n        if (!uniqueTeachersMap.has(key)) {\n          uniqueTeachersMap.set(key, teacher)\n        }\n      })\n      const uniqueTeachers = Array.from(uniqueTeachersMap.values())\n\n      let addedCount = 0\n      let updatedCount = 0\n      let skippedCount = 0\n\n      for (const teacher of uniqueTeachers) {\n        const { data: existingTeacher } = await supabase\n          .from('teachers')\n          .select('*')\n          .eq('phone', teacher.phone)\n          .maybeSingle()\n\n        if (!existingTeacher) {\n          const { data: newTeacher, error: insertError } = await supabase\n            .from('teachers')\n            .insert(teacher)\n            .select()\n            .maybeSingle()\n\n          if (!insertError && newTeacher) {\n            await db.teachers.put(newTeacher)\n            addedCount++\n          } else {\n            skippedCount++\n          }\n        } else {\n          const { error: updateError } = await supabase\n            .from('teachers')\n            .update({ name: teacher.name, specialization: teacher.specialization })\n            .eq('phone', teacher.phone)\n\n          if (!updateError) {\n            await db.teachers.update(existingTeacher.id, {\n              name: teacher.name,\n              specialization: teacher.specialization\n            })\n            updatedCount++\n          }\n        }\n      }\n\n      // رسالة النجاح\n      const messages: string[] = []\n\n      if (addedCount > 0) {\n        messages.push(`تم إضافة ${addedCount} معلم جديد`)\n      }\n\n      if (updatedCount > 0) {\n        messages.push(`تم تحديث ${updatedCount} معلم`)\n      }\n\n      if (skippedCount > 0) {\n        messages.push(`تم تخطي ${skippedCount} معلم`)\n      }\n\n      setSuccess(\n        messages.length > 0 ? messages.join(' • ') : 'تمت العملية بنجاح'\n      )\n      if (teachersFileInputRef.current) {\n        teachersFileInputRef.current.value = ''\n      }\n      onImportComplete()\n    } catch (err) {\n      console.error('خطأ في استيراد المعلمين:', err)\n      const errorMessage = err instanceof Error ? err.message : 'حدث خطأ ما'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Upload size={24} className=\"text-blue-600\" />\n        <h2 className=\"text-xl font-bold text-gray-800\">استيراد من Excel</h2>\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded flex items-start gap-2\">\n          <AlertCircle size={20} className=\"flex-shrink-0 mt-0.5\" />\n          <div>\n            <p className=\"font-medium\">خطأ:</p>\n            <p className=\"text-sm whitespace-pre-line\">{error}</p>\n          </div>\n        </div>\n      )}\n\n      {success && (\n        <div className=\"mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded\">\n          {success}\n        </div>\n      )}\n\n      {/* قسم استيراد الطلاب */}\n      <div className=\"mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border-2 border-blue-300\">\n        <h3 className=\"text-lg font-bold text-blue-900 mb-3 flex items-center gap-2\">\n          <GraduationCap size={20} />\n          استيراد بيانات الطلاب\n        </h3>\n\n        <div className=\"bg-white rounded-lg p-3 mb-3\">\n          <p className=\"text-sm font-bold text-emerald-700 mb-2\">الأعمدة المطلوبة:</p>\n          <div className=\"grid grid-cols-1 gap-1 text-xs text-gray-700\">\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">1.</span>\n              <span><strong>اسم الطالب</strong> - اسم الطالب الكامل</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">2.</span>\n              <span><strong>السجل المدني</strong> - رقم الهوية الوطنية</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">3.</span>\n              <span><strong>الصف</strong> - مثل: الصف الأول الثانوي</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">4.</span>\n              <span><strong>المجموعة</strong> - اسم المجموعة مثل: مجموعة 1</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">5.</span>\n              <span><strong>جوال الطالب</strong> - رقم جوال الطالب (اختياري)</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">6.</span>\n              <span><strong>جوال ولي الامر</strong> - رقم جوال ولي الأمر (اختياري)</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">7.</span>\n              <span><strong>الحالة</strong> - نشط أو استئذان (اختياري)</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg mb-3\">\n          <p className=\"text-sm font-bold text-yellow-900 mb-2\">ملاحظات مهمة</p>\n          <ul className=\"text-xs text-yellow-800 mr-4 space-y-1\">\n            <li>• المجموعات يتم إنشاؤها تلقائياً إذا لم تكن موجودة</li>\n            <li>• إذا كان السجل المدني موجود، يتم تحديث بيانات الطالب</li>\n            <li>• عمود \"جوال ولي الامر\" يقبل أيضاً: \"جوالي ولي الامر\" أو \"جوال ولي الأمر\"</li>\n          </ul>\n        </div>\n\n        <input\n          ref={studentsFileInputRef}\n          type=\"file\"\n          accept=\".xlsx,.xls,.csv\"\n          onChange={handleStudentsImport}\n          disabled={loading}\n          className=\"hidden\"\n        />\n\n        <button\n          onClick={() => studentsFileInputRef.current?.click()}\n          disabled={loading}\n          className=\"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n        >\n          <GraduationCap size={20} />\n          {loading ? 'جاري الاستيراد...' : 'استيراد ملف الطلاب'}\n        </button>\n      </div>\n\n      {/* قسم استيراد المعلمين */}\n      <div className=\"p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border-2 border-orange-300\">\n        <h3 className=\"text-lg font-bold text-orange-900 mb-3 flex items-center gap-2\">\n          <Users size={20} />\n          استيراد بيانات المعلمين\n        </h3>\n\n        <div className=\"bg-white rounded-lg p-3 mb-3\">\n          <p className=\"text-sm font-bold text-orange-700 mb-2\">الأعمدة المطلوبة:</p>\n          <div className=\"grid grid-cols-1 gap-1 text-xs text-gray-700\">\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">1.</span>\n              <span><strong>اسم المعلم</strong> - اسم المعلم الكامل</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">2.</span>\n              <span><strong>رقم جوال المعلم</strong> - رقم جوال المعلم</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">3.</span>\n              <span><strong>التخصص</strong> - مثل: رياضيات، علوم، لغة عربية (اختياري)</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg mb-3\">\n          <p className=\"text-sm font-bold text-yellow-900 mb-2\">ملاحظات مهمة</p>\n          <ul className=\"text-xs text-yellow-800 mr-4 space-y-1\">\n            <li>• إذا كان رقم الجوال موجود، يتم تحديث بيانات المعلم</li>\n            <li>• يتم تخطي المعلمين المكررين في الملف</li>\n          </ul>\n        </div>\n\n        <input\n          ref={teachersFileInputRef}\n          type=\"file\"\n          accept=\".xlsx,.xls,.csv\"\n          onChange={handleTeachersImport}\n          disabled={loading}\n          className=\"hidden\"\n        />\n\n        <button\n          onClick={() => teachersFileInputRef.current?.click()}\n          disabled={loading}\n          className=\"w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n        >\n          <Users size={20} />\n          {loading ? 'جاري الاستيراد...' : 'استيراد ملف المعلمين'}\n        </button>\n      </div>\n    </div>\n  )\n}\n","size_bytes":20935},"src/components/SendToTeacherModal.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { X, Send } from 'lucide-react'\nimport { Teacher, Group, Student } from '../types'\n\ninterface SendToTeacherModalProps {\n  isOpen: boolean\n  onClose: () => void\n  specialStatusStudents: Student[]\n}\n\nexport function SendToTeacherModal({\n  isOpen,\n  onClose,\n  specialStatusStudents,\n}: SendToTeacherModalProps) {\n  const [teachers, setTeachers] = useState<Teacher[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [allGroups, setAllGroups] = useState<Group[]>([])\n  const [stages, setStages] = useState<string[]>([])\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  const [selectedStage, setSelectedStage] = useState('')\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])\n  const [loading, setLoading] = useState(false)\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchTeachers()\n      fetchGroups()\n    }\n  }, [isOpen])\n\n  const fetchTeachers = async () => {\n    const { data } = await supabase\n      .from('teachers')\n      .select('*')\n      .order('name')\n\n    if (data) setTeachers(data)\n  }\n\n  const fetchGroups = async () => {\n    const { data } = await supabase\n      .from('groups')\n      .select('*')\n      .order('display_order')\n\n    if (data) {\n      setAllGroups(data)\n      const uniqueStages = [...new Set(data.map(g => g.stage))]\n      setStages(uniqueStages)\n    }\n  }\n\n  useEffect(() => {\n    if (selectedStage) {\n      const stageGroups = allGroups.filter(g => g.stage === selectedStage)\n      setGroups(stageGroups)\n      setSelectedGroupIds([])\n    } else {\n      setGroups([])\n      setSelectedGroupIds([])\n    }\n  }, [selectedStage, allGroups])\n\n  const toggleGroup = (groupId: string) => {\n    if (selectedGroupIds.includes(groupId)) {\n      setSelectedGroupIds(selectedGroupIds.filter(id => id !== groupId))\n    } else {\n      setSelectedGroupIds([...selectedGroupIds, groupId])\n    }\n  }\n\n\n  const handleSend = async () => {\n    if (!selectedTeacherId) {\n      alert('الرجاء اختيار المعلم')\n      return\n    }\n\n    if (!selectedStage) {\n      alert('الرجاء اختيار المرحلة')\n      return\n    }\n\n    if (selectedGroupIds.length === 0) {\n      alert('الرجاء اختيار مجموعة واحدة على الأقل')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const teacher = teachers.find(t => t.id === selectedTeacherId)\n      if (!teacher) return\n\n      // فلتر الطلاب حسب المجموعات المختارة\n      const filteredStudents = specialStatusStudents.filter(\n        student => selectedGroupIds.includes(student.group_id)\n      )\n\n      if (filteredStudents.length === 0) {\n        alert('لا يوجد طلاب ذوي حالات خاصة في المجموعات المختارة')\n        setLoading(false)\n        return\n      }\n\n      // إنشاء رسالة واتساب\n      let message = ''\n      const selectedGroups = allGroups.filter(g => selectedGroupIds.includes(g.id))\n\n      message += `*الحالات الخاصة - ${selectedStage}*\\n\\n`\n\n      // تجميع الطلاب حسب المجموعة\n      selectedGroups.forEach((group) => {\n        const groupStudents = filteredStudents.filter(s => s.group_id === group.id)\n        if (groupStudents.length > 0) {\n          message += `📚 *${group.name}*\\n`\n          groupStudents.forEach((student, index) => {\n            message += `${index + 1}. *${student.name}*\\n`\n            message += `   الحالة: ${student.special_status?.name || '-'}\\n`\n            message += `   جوال الطالب: ${student.phone || '-'}\\n`\n            message += `   جوال ولي الأمر: ${student.parent_phone || '-'}\\n\\n`\n          })\n          message += '\\n'\n        }\n      })\n\n      // فتح واتساب\n      const encodedMessage = encodeURIComponent(message)\n      const phoneNumber = teacher.phone.replace(/[^0-9]/g, '')\n      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`\n\n      window.open(whatsappUrl, '_blank')\n\n      onClose()\n    } catch (error) {\n      console.error('Error sending to teacher:', error)\n      alert('حدث خطأ أثناء الإرسال')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (!isOpen) return null\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Send className=\"text-green-600\" size={24} />\n            <h2 className=\"text-2xl font-bold text-gray-900\">إرسال للمعلم</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n            <p className=\"text-sm text-blue-800\">\n              سيتم إرسال بيانات الطلاب ذوي الحالات الخاصة في المجموعة المحددة إلى المعلم عبر واتساب\n            </p>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المعلم <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              value={selectedTeacherId}\n              onChange={(e) => setSelectedTeacherId(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n            >\n              <option value=\"\">-- اختر المعلم --</option>\n              {teachers.map((teacher) => (\n                <option key={teacher.id} value={teacher.id}>\n                  {teacher.name} - {teacher.specialization}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المرحلة <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              value={selectedStage}\n              onChange={(e) => setSelectedStage(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n            >\n              <option value=\"\">-- اختر المرحلة --</option>\n              {stages.map((stage) => (\n                <option key={stage} value={stage}>\n                  {stage}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المجموعة <span className=\"text-red-500\">*</span>\n            </label>\n            {!selectedStage ? (\n              <div className=\"bg-gray-50 border border-gray-300 rounded-lg p-4 text-center\">\n                <p className=\"text-sm text-gray-500\">اختر المرحلة أولاً</p>\n              </div>\n            ) : groups.length === 0 ? (\n              <div className=\"bg-gray-50 border border-gray-300 rounded-lg p-4 text-center\">\n                <p className=\"text-sm text-gray-500\">لا توجد مجموعات في هذه المرحلة</p>\n              </div>\n            ) : (\n              <div className=\"border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto space-y-2\">\n                {groups.map((group) => {\n                  const isSelected = selectedGroupIds.includes(group.id)\n                  const studentsCount = specialStatusStudents.filter(s => s.group_id === group.id).length\n                  return (\n                    <label\n                      key={group.id}\n                      className={`flex items-center gap-3 p-3 rounded-lg border-2 transition-all cursor-pointer ${\n                        isSelected\n                          ? 'bg-green-50 border-green-500'\n                          : 'bg-white border-gray-200 hover:border-gray-300'\n                      }`}\n                    >\n                      <input\n                        type=\"checkbox\"\n                        checked={isSelected}\n                        onChange={() => toggleGroup(group.id)}\n                        className=\"w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500\"\n                      />\n                      <div className=\"flex-1\">\n                        <span className={`font-medium ${\n                          isSelected ? 'text-green-900' : 'text-gray-900'\n                        }`}>\n                          {group.name}\n                        </span>\n                        {studentsCount > 0 && (\n                          <span className=\"text-xs text-gray-500 mr-2\">\n                            ({studentsCount} طالب)\n                          </span>\n                        )}\n                      </div>\n                    </label>\n                  )\n                })}\n              </div>\n            )}\n            {selectedGroupIds.length > 0 && (\n              <p className=\"text-xs text-green-600 mt-2\">\n                تم اختيار {selectedGroupIds.length} مجموعة\n              </p>\n            )}\n          </div>\n\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              onClick={handleSend}\n              disabled={loading || !selectedTeacherId || !selectedStage || selectedGroupIds.length === 0}\n              className=\"flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Send size={20} />\n              {loading ? 'جاري الإرسال...' : 'إرسال عبر واتساب'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":10488},"src/pages/AbsencePage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db, StudentViolation } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student } from '../types'\nimport { AlertTriangle, Search, FileText, Printer, Calendar, Filter, Send } from 'lucide-react'\n\ninterface ViolationWithStudent extends StudentViolation {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    violation_count: number\n  }\n}\n\nexport function AbsencePage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [violations, setViolations] = useState<ViolationWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [formData, setFormData] = useState({\n    violation_type: 'هروب من الحصة' as const,\n    description: '',\n    action_taken: '',\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchViolations()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    try {\n      const { data: studentsData } = await supabase\n        .from('students')\n        .select('*')\n        .order('name')\n\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const { data: statusesData } = await supabase.from('special_statuses').select('*')\n\n      const groups = groupsData || []\n      const statuses = statusesData || []\n\n      const studentsWithRelations = (studentsData || []).map(student => {\n        const group = groups.find(g => g.id === student.group_id)\n        const special_status = statuses.find(s => s.id === student.special_status_id)\n        return {\n          ...student,\n          group: group ? { name: group.name } : undefined,\n          special_status: special_status ? { name: special_status.name } : undefined\n        }\n      })\n\n      setStudents(studentsWithRelations as Student[])\n\n      if (studentsData) await db.students.bulkPut(studentsData)\n      if (groups.length > 0) await db.groups.bulkPut(groups)\n      if (statuses.length > 0) await db.special_statuses.bulkPut(statuses)\n    } catch (error) {\n      console.error('Error fetching students:', error)\n    }\n  }\n\n  async function fetchViolations(filterDate?: string) {\n    try {\n      let query = supabase\n        .from('student_violations')\n        .select('*')\n        .order('violation_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('violation_date', startOfDay.toISOString())\n          .lte('violation_date', endOfDay.toISOString())\n      } else {\n        query = query.limit(50)\n      }\n\n      const { data: violationsData } = await query\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const allStudents = studentsData || []\n\n      const violationsWithStudents = (violationsData || []).map((violation) => {\n        const student = allStudents.find(s => s.id === violation.student_id)\n        return {\n          ...violation,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            violation_count: student.violation_count || 0\n          } : undefined\n        }\n      })\n\n      setViolations(violationsWithStudents)\n\n      if (violationsData) {\n        await db.student_violations.bulkPut(violationsData.map(v => ({\n          id: v.id,\n          student_id: v.student_id,\n          violation_type: v.violation_type,\n          violation_date: v.violation_date,\n          description: v.description,\n          action_taken: v.action_taken,\n          notes: v.notes || '',\n          created_at: v.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error fetching violations:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const violationDate = new Date().toISOString()\n      const currentCount = selectedStudent.violation_count || 0\n\n      const { data: violationData, error: violationError } = await supabase\n        .from('student_violations')\n        .insert({\n          student_id: selectedStudent.id,\n          violation_type: formData.violation_type,\n          violation_date: violationDate,\n          description: formData.description,\n          action_taken: formData.action_taken,\n          notes: formData.notes\n        })\n        .select()\n        .single()\n\n      if (violationError) throw violationError\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ violation_count: currentCount + 1 })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) throw updateError\n\n      if (violationData) {\n        await db.student_violations.add({\n          id: violationData.id,\n          student_id: violationData.student_id,\n          violation_type: violationData.violation_type,\n          violation_date: violationData.violation_date,\n          description: violationData.description,\n          action_taken: violationData.action_taken,\n          notes: violationData.notes || '',\n          created_at: violationData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        violation_count: currentCount + 1\n      })\n\n      alert('تم تسجيل المخالفة بنجاح')\n      setFormData({ violation_type: 'هروب من الحصة', description: '', action_taken: '', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchViolations(dateFilter)\n    } catch (error) {\n      console.error('Error saving violation:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  function sendWhatsApp(violation: ViolationWithStudent) {\n    if (!violation.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${violation.student.name}\n\nنود إعلامكم بتسجيل مخالفة سلوكية على الطالب بتاريخ: ${new Date(violation.violation_date).toLocaleDateString('ar-SA')}\n\n⚠️ نوع المخالفة: ${violation.violation_type}\n📝 الوصف: ${violation.description}\n✅ الإجراء المتخذ: ${violation.action_taken}\n\nيرجى التواصل مع الموجه الطلابي للاستفسار.\n\nمع تحيات إدارة المدرسة`\n\n    const phone = violation.student.guardian_phone.replace(/\\D/g, '')\n    const whatsappUrl = `https://wa.me/966${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  async function printViolation(violation: ViolationWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>تقرير مخالفة طالب</title>\n          <style>\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; }\n            .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }\n            .header h1 { margin: 0; color: #dc2626; }\n            .header .meta { color: #666; font-size: 12px; margin-top: 10px; }\n            .section { margin-bottom: 20px; }\n            .section label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }\n            .section div { padding: 10px; background: #fef2f2; border-radius: 5px; border: 1px solid #fca5a5; }\n            .violation-type { background: #fee2e2; border: 2px solid #dc2626; font-size: 18px; text-align: center; padding: 15px; font-weight: bold; }\n            @media print { body { padding: 20px; } }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>⚠️ تقرير مخالفة سلوكية</h1>\n            <p>التاريخ: ${new Date(violation.violation_date).toLocaleString('ar-SA')}</p>\n            ${teacherName ? `<div class=\"meta\">بواسطة: ${teacherName}</div>` : ''}\n          </div>\n          <div class=\"section\">\n            <label>اسم الطالب:</label>\n            <div>${violation.student?.name}</div>\n          </div>\n          <div class=\"section\">\n            <label>السجل المدني:</label>\n            <div>${violation.student?.national_id}</div>\n          </div>\n          <div class=\"section\">\n            <label>نوع المخالفة:</label>\n            <div class=\"violation-type\">${violation.violation_type}</div>\n          </div>\n          <div class=\"section\">\n            <label>وصف المخالفة:</label>\n            <div>${violation.description}</div>\n          </div>\n          <div class=\"section\">\n            <label>الإجراء المتخذ:</label>\n            <div>${violation.action_taken}</div>\n          </div>\n          ${violation.notes ? `\n          <div class=\"section\">\n            <label>ملاحظات:</label>\n            <div>${violation.notes}</div>\n          </div>\n          ` : ''}\n          <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px dashed #ccc;\">\n            <p style=\"text-align: center; color: #666; font-size: 14px;\">\n              عدد المخالفات المسجلة للطالب: ${violation.student?.violation_count || 1}\n            </p>\n          </div>\n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <AlertTriangle size={28} className=\"text-red-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">المخالفات</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-red-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-red-600 font-semibold mt-1\">\n                      عدد المخالفات: {student.violation_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-red-50 rounded-lg p-4 border border-red-200\">\n                <h3 className=\"font-bold text-red-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد المخالفات السابقة:</span>\n                    <span className=\"text-red-600 font-bold mr-2\">{selectedStudent.violation_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  نوع المخالفة\n                </label>\n                <select\n                  value={formData.violation_type}\n                  onChange={(e) => setFormData({ ...formData, violation_type: e.target.value as any })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                >\n                  <option value=\"هروب من الحصة\">هروب من الحصة</option>\n                  <option value=\"تأخر صباحي\">تأخر صباحي</option>\n                  <option value=\"غياب بدون عذر\">غياب بدون عذر</option>\n                  <option value=\"عدم إحضار الكتب\">عدم إحضار الكتب</option>\n                  <option value=\"عدم حل الواجبات\">عدم حل الواجبات</option>\n                  <option value=\"سلوك غير لائق\">سلوك غير لائق</option>\n                  <option value=\"شجار\">شجار</option>\n                  <option value=\"إزعاج\">إزعاج</option>\n                  <option value=\"أخرى\">أخرى</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  وصف المخالفة\n                </label>\n                <textarea\n                  required\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب وصف تفصيلي للمخالفة...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الإجراء المتخذ\n                </label>\n                <textarea\n                  required\n                  value={formData.action_taken}\n                  onChange={(e) => setFormData({ ...formData, action_taken: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل المخالفة'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <FileText size={24} />\n            سجل المخالفات {dateFilter ? 'المفلترة' : 'الأخيرة'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchViolations(dateFilter)}\n                className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchViolations()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-red-600 font-semibold mt-3\">\n                عرض المخالفات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {violations.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد مخالفات {dateFilter ? 'في هذا التاريخ' : ''}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {violations.map(violation => (\n              <div key={violation.id} className=\"border border-red-200 rounded-lg p-4 bg-red-50\">\n                <div className=\"flex justify-between items-start mb-3\">\n                  <div>\n                    <h4 className=\"font-bold text-gray-800\">{violation.student?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">\n                      {new Date(violation.violation_date).toLocaleString('ar-SA')}\n                    </p>\n                    <p className=\"text-sm font-bold text-red-600 mt-1\">\n                      <AlertTriangle size={14} className=\"inline ml-1\" />\n                      {violation.violation_type}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      onClick={() => printViolation(violation)}\n                      className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Printer size={16} />\n                      طباعة\n                    </button>\n                    <button\n                      onClick={() => sendWhatsApp(violation)}\n                      className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Send size={16} />\n                      واتساب\n                    </button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div><span className=\"font-semibold\">الوصف:</span> {violation.description}</div>\n                  <div><span className=\"font-semibold\">الإجراء:</span> {violation.action_taken}</div>\n                  {violation.notes && (\n                    <div className=\"text-gray-600\">\n                      <span className=\"font-semibold\">ملاحظات:</span> {violation.notes}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":21867},"shared/schema.ts":{"content":"import { pgTable, varchar, text, integer, boolean, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const groups = pgTable(\"groups\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  stage: varchar(\"stage\").notNull(),\n  displayOrder: integer(\"display_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertGroupSchema = createInsertSchema(groups).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertGroup = z.infer<typeof insertGroupSchema>;\nexport type Group = typeof groups.$inferSelect;\n\nexport const specialStatuses = pgTable(\"special_statuses\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertSpecialStatusSchema = createInsertSchema(specialStatuses).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertSpecialStatus = z.infer<typeof insertSpecialStatusSchema>;\nexport type SpecialStatus = typeof specialStatuses.$inferSelect;\n\nexport const students = pgTable(\"students\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  nationalId: varchar(\"national_id\").notNull(),\n  phone: varchar(\"phone\").notNull(),\n  guardianPhone: varchar(\"guardian_phone\").notNull(),\n  grade: varchar(\"grade\").notNull(),\n  groupId: varchar(\"group_id\").references(() => groups.id),\n  status: varchar(\"status\").notNull().default(\"نشط\"),\n  specialStatusId: varchar(\"special_status_id\").references(() => specialStatuses.id),\n  visitCount: integer(\"visit_count\").default(0),\n  permissionCount: integer(\"permission_count\").default(0),\n  violationCount: integer(\"violation_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentSchema = createInsertSchema(students).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InsertStudent = z.infer<typeof insertStudentSchema>;\nexport type Student = typeof students.$inferSelect;\n\nexport const teachers = pgTable(\"teachers\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  phone: varchar(\"phone\").notNull(),\n  specialization: varchar(\"specialization\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertTeacherSchema = createInsertSchema(teachers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InsertTeacher = z.infer<typeof insertTeacherSchema>;\nexport type Teacher = typeof teachers.$inferSelect;\n\nexport const teacherGroups = pgTable(\"teacher_groups\", {\n  id: varchar(\"id\").primaryKey(),\n  teacherId: varchar(\"teacher_id\").references(() => teachers.id),\n  groupId: varchar(\"group_id\").references(() => groups.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertTeacherGroupSchema = createInsertSchema(teacherGroups).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertTeacherGroup = z.infer<typeof insertTeacherGroupSchema>;\nexport type TeacherGroup = typeof teacherGroups.$inferSelect;\n\nexport const studentVisits = pgTable(\"student_visits\", {\n  id: varchar(\"id\").primaryKey(),\n  studentId: varchar(\"student_id\").references(() => students.id),\n  visitDate: varchar(\"visit_date\").notNull(),\n  reason: text(\"reason\").notNull(),\n  actionTaken: text(\"action_taken\").notNull(),\n  referredTo: varchar(\"referred_to\").notNull().default(\"لا يوجد\"),\n  notes: text(\"notes\").default(\"\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentVisitSchema = createInsertSchema(studentVisits).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertStudentVisit = z.infer<typeof insertStudentVisitSchema>;\nexport type StudentVisit = typeof studentVisits.$inferSelect;\n\nexport const studentPermissions = pgTable(\"student_permissions\", {\n  id: varchar(\"id\").primaryKey(),\n  studentId: varchar(\"student_id\").references(() => students.id),\n  permissionDate: varchar(\"permission_date\").notNull(),\n  exitTime: varchar(\"exit_time\"),\n  reason: text(\"reason\").notNull(),\n  guardianNotified: boolean(\"guardian_notified\").default(false),\n  notes: text(\"notes\").default(\"\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentPermissionSchema = createInsertSchema(studentPermissions).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertStudentPermission = z.infer<typeof insertStudentPermissionSchema>;\nexport type StudentPermission = typeof studentPermissions.$inferSelect;\n\nexport const studentViolations = pgTable(\"student_violations\", {\n  id: varchar(\"id\").primaryKey(),\n  studentId: varchar(\"student_id\").references(() => students.id),\n  violationDate: varchar(\"violation_date\").notNull(),\n  violationType: varchar(\"violation_type\").notNull(),\n  description: text(\"description\").default(\"\"),\n  actionTaken: text(\"action_taken\").default(\"\"),\n  notes: text(\"notes\").default(\"\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentViolationSchema = createInsertSchema(studentViolations).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertStudentViolation = z.infer<typeof insertStudentViolationSchema>;\nexport type StudentViolation = typeof studentViolations.$inferSelect;\n\nexport const teacherProfile = pgTable(\"teacher_profile\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").default(\"\"),\n  phone: varchar(\"phone\").default(\"\"),\n  schoolName: varchar(\"school_name\").default(\"\"),\n  systemTitle: varchar(\"system_title\").default(\"\"),\n  logoUrl: varchar(\"logo_url\").default(\"\"),\n  autoLogoutMinutes: integer(\"auto_logout_minutes\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertTeacherProfileSchema = createInsertSchema(teacherProfile).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertTeacherProfile = z.infer<typeof insertTeacherProfileSchema>;\nexport type TeacherProfile = typeof teacherProfile.$inferSelect;\n\nexport const loginCredentials = pgTable(\"login_credentials\", {\n  id: varchar(\"id\").primaryKey(),\n  username: varchar(\"username\").notNull().unique(),\n  passwordHash: varchar(\"password_hash\").notNull(),\n  resetToken: varchar(\"reset_token\"),\n  resetTokenExpires: varchar(\"reset_token_expires\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertLoginCredentialsSchema = createInsertSchema(loginCredentials).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InsertLoginCredentials = z.infer<typeof insertLoginCredentialsSchema>;\nexport type LoginCredentials = typeof loginCredentials.$inferSelect;\n","size_bytes":6878},"Erchad-1/client/src/vite-env.d.ts":{"content":"/// <reference types=\"vite/client\" />\n","size_bytes":38},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { PgStorage } from \"./pgStorage.js\";\nimport {\n  insertStudentSchema, insertGroupSchema, insertSpecialStatusSchema,\n  insertTeacherSchema, insertTeacherGroupSchema,\n  insertStudentVisitSchema, insertStudentPermissionSchema,\n  insertStudentViolationSchema, insertTeacherProfileSchema,\n  insertLoginCredentialsSchema\n} from \"../shared/schema.js\";\n\nconst storage = new PgStorage();\n\nexport function registerRoutes(app: Express) {\n  // Groups routes\n  app.get(\"/api/groups\", async (_req, res) => {\n    try {\n      const groups = await storage.getGroups();\n      res.json(groups);\n    } catch (error) {\n      console.error(\"Error fetching groups:\", error);\n      res.status(500).json({ error: \"Failed to fetch groups\" });\n    }\n  });\n\n  app.post(\"/api/groups\", async (req, res) => {\n    try {\n      const parsed = insertGroupSchema.parse(req.body);\n      const group = await storage.createGroup(parsed);\n      res.json(group);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid group data\" });\n    }\n  });\n\n  app.patch(\"/api/groups/:id\", async (req, res) => {\n    try {\n      const group = await storage.updateGroup(req.params.id, req.body);\n      if (!group) {\n        return res.status(404).json({ error: \"Group not found\" });\n      }\n      res.json(group);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update group\" });\n    }\n  });\n\n  app.delete(\"/api/groups/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteGroup(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Group not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete group\" });\n    }\n  });\n\n  // Special Statuses routes\n  app.get(\"/api/special-statuses\", async (_req, res) => {\n    try {\n      const statuses = await storage.getSpecialStatuses();\n      res.json(statuses);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch special statuses\" });\n    }\n  });\n\n  app.post(\"/api/special-statuses\", async (req, res) => {\n    try {\n      const parsed = insertSpecialStatusSchema.parse(req.body);\n      const status = await storage.createSpecialStatus(parsed);\n      res.json(status);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid status data\" });\n    }\n  });\n\n  app.delete(\"/api/special-statuses/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteSpecialStatus(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Special status not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete special status\" });\n    }\n  });\n\n  // Students routes\n  app.get(\"/api/students\", async (_req, res) => {\n    try {\n      const students = await storage.getStudents();\n      res.json(students);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch students\" });\n    }\n  });\n\n  app.post(\"/api/students\", async (req, res) => {\n    try {\n      const parsed = insertStudentSchema.parse(req.body);\n      const student = await storage.createStudent(parsed);\n      res.json(student);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid student data\" });\n    }\n  });\n\n  app.post(\"/api/students/bulk\", async (req, res) => {\n    try {\n      const students = req.body.students;\n      if (!Array.isArray(students)) {\n        return res.status(400).json({ error: \"Expected array of students\" });\n      }\n      const parsed = students.map(s => insertStudentSchema.parse(s));\n      const result = await storage.createManyStudents(parsed);\n      res.json(result);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid students data\" });\n    }\n  });\n\n  app.patch(\"/api/students/:id\", async (req, res) => {\n    try {\n      const student = await storage.updateStudent(req.params.id, req.body);\n      if (!student) {\n        return res.status(404).json({ error: \"Student not found\" });\n      }\n      res.json(student);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update student\" });\n    }\n  });\n\n  app.delete(\"/api/students/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudent(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student\" });\n    }\n  });\n\n  // Teachers routes\n  app.get(\"/api/teachers\", async (_req, res) => {\n    try {\n      const teachers = await storage.getTeachers();\n      res.json(teachers);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teachers\" });\n    }\n  });\n\n  app.post(\"/api/teachers\", async (req, res) => {\n    try {\n      const parsed = insertTeacherSchema.parse(req.body);\n      const teacher = await storage.createTeacher(parsed);\n      res.json(teacher);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid teacher data\" });\n    }\n  });\n\n  app.patch(\"/api/teachers/:id\", async (req, res) => {\n    try {\n      const teacher = await storage.updateTeacher(req.params.id, req.body);\n      if (!teacher) {\n        return res.status(404).json({ error: \"Teacher not found\" });\n      }\n      res.json(teacher);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update teacher\" });\n    }\n  });\n\n  app.delete(\"/api/teachers/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteTeacher(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Teacher not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete teacher\" });\n    }\n  });\n\n  // Teacher Groups routes\n  app.get(\"/api/teacher-groups\", async (_req, res) => {\n    try {\n      const teacherGroups = await storage.getTeacherGroups();\n      res.json(teacherGroups);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teacher groups\" });\n    }\n  });\n\n  app.get(\"/api/teacher-groups/teacher/:teacherId\", async (req, res) => {\n    try {\n      const teacherGroups = await storage.getTeacherGroupsByTeacherId(req.params.teacherId);\n      res.json(teacherGroups);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teacher groups\" });\n    }\n  });\n\n  app.post(\"/api/teacher-groups\", async (req, res) => {\n    try {\n      const parsed = insertTeacherGroupSchema.parse(req.body);\n      const teacherGroup = await storage.createTeacherGroup(parsed);\n      res.json(teacherGroup);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid teacher group data\" });\n    }\n  });\n\n  app.delete(\"/api/teacher-groups/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteTeacherGroup(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Teacher group not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete teacher group\" });\n    }\n  });\n\n  // Student Visits routes\n  app.get(\"/api/student-visits\", async (_req, res) => {\n    try {\n      const visits = await storage.getStudentVisits();\n      res.json(visits);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student visits\" });\n    }\n  });\n\n  app.get(\"/api/student-visits/student/:studentId\", async (req, res) => {\n    try {\n      const visits = await storage.getStudentVisitsByStudentId(req.params.studentId);\n      res.json(visits);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student visits\" });\n    }\n  });\n\n  app.post(\"/api/student-visits\", async (req, res) => {\n    try {\n      const parsed = insertStudentVisitSchema.parse(req.body);\n      const visit = await storage.createStudentVisit(parsed);\n      res.json(visit);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid visit data\" });\n    }\n  });\n\n  app.delete(\"/api/student-visits/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudentVisit(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student visit not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student visit\" });\n    }\n  });\n\n  // Student Permissions routes\n  app.get(\"/api/student-permissions\", async (_req, res) => {\n    try {\n      const permissions = await storage.getStudentPermissions();\n      res.json(permissions);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student permissions\" });\n    }\n  });\n\n  app.get(\"/api/student-permissions/student/:studentId\", async (req, res) => {\n    try {\n      const permissions = await storage.getStudentPermissionsByStudentId(req.params.studentId);\n      res.json(permissions);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student permissions\" });\n    }\n  });\n\n  app.post(\"/api/student-permissions\", async (req, res) => {\n    try {\n      const parsed = insertStudentPermissionSchema.parse(req.body);\n      const permission = await storage.createStudentPermission(parsed);\n      res.json(permission);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid permission data\" });\n    }\n  });\n\n  app.delete(\"/api/student-permissions/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudentPermission(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student permission not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student permission\" });\n    }\n  });\n\n  // Student Violations routes\n  app.get(\"/api/student-violations\", async (_req, res) => {\n    try {\n      const violations = await storage.getStudentViolations();\n      res.json(violations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student violations\" });\n    }\n  });\n\n  app.get(\"/api/student-violations/student/:studentId\", async (req, res) => {\n    try {\n      const violations = await storage.getStudentViolationsByStudentId(req.params.studentId);\n      res.json(violations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student violations\" });\n    }\n  });\n\n  app.post(\"/api/student-violations\", async (req, res) => {\n    try {\n      const parsed = insertStudentViolationSchema.parse(req.body);\n      const violation = await storage.createStudentViolation(parsed);\n      res.json(violation);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid violation data\" });\n    }\n  });\n\n  app.delete(\"/api/student-violations/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudentViolation(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student violation not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student violation\" });\n    }\n  });\n\n  // Teacher Profile routes\n  app.get(\"/api/teacher-profile\", async (_req, res) => {\n    try {\n      const profile = await storage.getTeacherProfile();\n      res.json(profile || null);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teacher profile\" });\n    }\n  });\n\n  app.post(\"/api/teacher-profile\", async (req, res) => {\n    try {\n      const parsed = insertTeacherProfileSchema.parse(req.body);\n      const profile = await storage.createOrUpdateTeacherProfile(parsed);\n      res.json(profile);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid profile data\" });\n    }\n  });\n\n  // Login routes\n  app.post(\"/api/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const credentials = await storage.getLoginCredentials(username);\n      if (credentials && credentials.passwordHash === password) {\n        res.json({ success: true });\n      } else {\n        res.status(401).json({ error: \"Invalid credentials\" });\n      }\n    } catch (error) {\n      res.status(500).json({ error: \"Login failed\" });\n    }\n  });\n\n  app.post(\"/api/init-login\", async (_req, res) => {\n    try {\n      const existing = await storage.getLoginCredentials(\"admin\");\n      if (!existing) {\n        await storage.createLoginCredentials({\n          username: \"admin\",\n          passwordHash: \"admin123\"\n        });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to initialize login\" });\n    }\n  });\n\n  app.post(\"/api/update-login-credentials\", async (req, res) => {\n    try {\n      const { currentUsername, newUsername, newPassword } = req.body;\n      \n      // التحقق من وجود المستخدم الحالي\n      const existing = await storage.getLoginCredentials(currentUsername);\n      if (!existing) {\n        res.status(404).json({ error: \"User not found\" });\n        return;\n      }\n      \n      // تحديث بيانات تسجيل الدخول\n      await storage.updateLoginCredentials(existing.id, {\n        username: newUsername,\n        passwordHash: newPassword\n      });\n      \n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update credentials\" });\n    }\n  });\n\n  app.post(\"/api/clear-database\", async (_req, res) => {\n    try {\n      await storage.clearDatabase();\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to clear database\" });\n    }\n  });\n\n  app.post(\"/api/clear-database-selective\", async (req, res) => {\n    try {\n      const options = req.body;\n      \n      if (options.all) {\n        // حذف كل شيء\n        await storage.clearDatabase();\n      } else {\n        // حذف محدد\n        const { PgStorage } = await import(\"./pgStorage.js\");\n        const pgStorage = storage as InstanceType<typeof PgStorage>;\n        \n        if (options.violations) {\n          await import('../shared/schema.js').then(async (schema) => {\n            const { drizzle } = await import('drizzle-orm/neon-serverless');\n            const { Pool } = await import('@neondatabase/serverless');\n            const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n            const db = drizzle(pool, { schema });\n            await db.delete(schema.studentViolations);\n          });\n        }\n        if (options.permissions) {\n          await import('../shared/schema.js').then(async (schema) => {\n            const { drizzle } = await import('drizzle-orm/neon-serverless');\n            const { Pool } = await import('@neondatabase/serverless');\n            const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n            const db = drizzle(pool, { schema });\n            await db.delete(schema.studentPermissions);\n          });\n        }\n        if (options.visits) {\n          await import('../shared/schema.js').then(async (schema) => {\n            const { drizzle } = await import('drizzle-orm/neon-serverless');\n            const { Pool } = await import('@neondatabase/serverless');\n            const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n            const db = drizzle(pool, { schema });\n            await db.delete(schema.studentVisits);\n          });\n        }\n        if (options.students) {\n          await import('../shared/schema.js').then(async (schema) => {\n            const { drizzle } = await import('drizzle-orm/neon-serverless');\n            const { Pool } = await import('@neondatabase/serverless');\n            const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n            const db = drizzle(pool, { schema });\n            await db.delete(schema.studentViolations);\n            await db.delete(schema.studentPermissions);\n            await db.delete(schema.studentVisits);\n            await db.delete(schema.students);\n          });\n        }\n        if (options.teachers) {\n          await import('../shared/schema.js').then(async (schema) => {\n            const { drizzle } = await import('drizzle-orm/neon-serverless');\n            const { Pool } = await import('@neondatabase/serverless');\n            const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n            const db = drizzle(pool, { schema });\n            await db.delete(schema.teacherGroups);\n            await db.delete(schema.teachers);\n          });\n        }\n        if (options.specialStatuses) {\n          await import('../shared/schema.js').then(async (schema) => {\n            const { drizzle } = await import('drizzle-orm/neon-serverless');\n            const { Pool } = await import('@neondatabase/serverless');\n            const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n            const db = drizzle(pool, { schema });\n            await db.delete(schema.specialStatuses);\n          });\n        }\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error clearing database selectively:\", error);\n      res.status(500).json({ error: \"Failed to clear database\" });\n    }\n  });\n\n  app.post(\"/api/import-data\", async (req, res) => {\n    try {\n      const { data } = req.body;\n      \n      // التحقق الشامل من صحة البيانات قبل الحذف\n      if (!data || typeof data !== 'object') {\n        return res.status(400).json({ error: \"Invalid data format: missing data object\" });\n      }\n      \n      // التحقق من وجود الجداول الضرورية\n      const requiredTables = ['students', 'groups', 'teachers', 'special_statuses'];\n      for (const table of requiredTables) {\n        if (!Array.isArray(data[table])) {\n          return res.status(400).json({ \n            error: `Invalid data format: ${table} must be an array` \n          });\n        }\n      }\n      \n      // التحقق من الجداول الاختيارية\n      const optionalTables = ['teacher_groups', 'visits', 'permissions', 'violations'];\n      for (const table of optionalTables) {\n        if (data[table] !== undefined && !Array.isArray(data[table])) {\n          return res.status(400).json({ \n            error: `Invalid data format: ${table} must be an array if provided` \n          });\n        }\n      }\n      \n      // التحقق من profile\n      if (data.profile !== undefined && typeof data.profile !== 'object') {\n        return res.status(400).json({ \n          error: \"Invalid data format: profile must be an object if provided\" \n        });\n      }\n      \n      // حذف البيانات الحالية بعد التحقق من صحة الملف\n      await storage.clearDatabase();\n      \n      // استيراد البيانات مع الحفاظ على الـ IDs الأصلية\n      await storage.importData(data);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error('Import error:', error);\n      res.status(500).json({ error: \"Failed to import data. Database may be in inconsistent state.\" });\n    }\n  });\n\n  // Password Reset\n  app.post(\"/api/request-password-reset\", async (req, res) => {\n    try {\n      const { username } = req.body;\n      const result = await storage.createPasswordResetToken(username);\n      \n      if (!result) {\n        res.status(404).json({ error: \"User not found\" });\n        return;\n      }\n      \n      res.json({ success: true, token: result.token });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create reset token\" });\n    }\n  });\n\n  app.post(\"/api/reset-password\", async (req, res) => {\n    try {\n      const { username, token, newPassword } = req.body;\n      const success = await storage.resetPassword(username, token, newPassword);\n      \n      if (!success) {\n        res.status(400).json({ error: \"Invalid or expired token\" });\n        return;\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to reset password\" });\n    }\n  });\n}\n","size_bytes":20182},"Erchad-1/client/src/types/index.ts":{"content":"export interface Group {\n  id: string\n  name: string\n  stage: string\n  display_order: number\n  created_at: string\n}\n\nexport interface SpecialStatus {\n  id: string\n  name: string\n  created_at: string\n}\n\nexport interface Student {\n  id: string\n  name: string\n  national_id: string\n  phone: string\n  guardian_phone: string\n  grade: string\n  group_id: string\n  status: 'نشط' | 'استئذان'\n  special_status_id: string | null\n  visit_count: number\n  permission_count: number\n  violation_count: number\n  created_at: string\n  updated_at: string\n  group?: Group\n  special_status?: SpecialStatus\n}\n\nexport interface StudentVisit {\n  id: string\n  student_id: string\n  visit_date: string\n  reason: string\n  action_taken: string\n  referred_to: 'لا يوجد' | 'مشرف صحي' | 'وكيل' | 'مدير' | 'معلم'\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface StudentPermission {\n  id: string\n  student_id: string\n  permission_date: string\n  reason: string\n  guardian_notified: boolean\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface SchoolInfo {\n  id: string\n  school_name: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface StudentViolation {\n  id: string\n  student_id: string\n  violation_date: string\n  violation_type: 'هروب من الحصة' | 'غياب بدون عذر' | 'تأخر صباحي' | 'عدم إحضار الكتب' | 'سلوك غير لائق' | 'استخدام الجوال' | 'عدم ارتداء الزي المدرسي' | 'أخرى'\n  description: string\n  action_taken: string\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface Teacher {\n  id: string\n  name: string\n  phone: string\n  specialization: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface TeacherGroup {\n  id: string\n  teacher_id: string\n  group_id: string\n  created_at: string\n  teacher?: Teacher\n  group?: Group\n}\n","size_bytes":1925},"Erchad-1/MIGRATION_GUIDE.md":{"content":"# دليل ترحيل المكونات - من Supabase إلى API\n\n## النمط الأساسي للترحيل\n\n### 1. استبدال Supabase بـ React Query\n\n**قبل (Supabase):**\n```typescript\nimport { supabase } from './lib/supabase'\n\nconst { data } = await supabase.from('students').select('*')\n```\n\n**بعد (React Query):**\n```typescript\nimport { useQuery } from '@tanstack/react-query'\n\nconst { data: students = [] } = useQuery({\n  queryKey: ['/api/students']\n})\n```\n\n### 2. استبدال IndexedDB بـ API Mutations\n\n**قبل (IndexedDB):**\n```typescript\nimport { db } from './lib/db'\n\nawait db.students.add(student)\n```\n\n**بعد (API):**\n```typescript\nimport { useMutation } from '@tanstack/react-query'\nimport { apiRequest, queryClient } from '@/lib/queryClient'\n\nconst createStudent = useMutation({\n  mutationFn: (student) => apiRequest('/api/students', 'POST', student),\n  onSuccess: () => {\n    queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n  }\n})\n\ncreateStudent.mutate(student)\n```\n\n### 3. النمط الكامل لمكون\n\n```typescript\nimport { useQuery, useMutation } from '@tanstack/react-query'\nimport { apiRequest, queryClient } from '@/lib/queryClient'\n\nexport function MyComponent() {\n  // جلب البيانات\n  const { data: items = [], isLoading } = useQuery({\n    queryKey: ['/api/items']\n  })\n\n  // إضافة عنصر\n  const createItem = useMutation({\n    mutationFn: (item) => apiRequest('/api/items', 'POST', item),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/items'] })\n    }\n  })\n\n  // تحديث عنصر\n  const updateItem = useMutation({\n    mutationFn: ({ id, data }) => apiRequest(`/api/items/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/items'] })\n    }\n  })\n\n  // حذف عنصر\n  const deleteItem = useMutation({\n    mutationFn: (id) => apiRequest(`/api/items/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/items'] })\n    }\n  })\n\n  if (isLoading) return <div>جاري التحميل...</div>\n\n  return (\n    <div>\n      {items.map(item => (\n        <div key={item.id}>\n          {item.name}\n          <button onClick={() => deleteItem.mutate(item.id)}>حذف</button>\n        </div>\n      ))}\n    </div>\n  )\n}\n```\n\n## المكونات التي تم ترحيلها\n\n- ✅ LoginPage\n- ✅ App.tsx (الهيكل الأساسي)\n\n## المكونات التي تحتاج للترحيل\n\n### المكونات الفرعية (Components)\n- [ ] StudentForm.tsx\n- [ ] StudentsList.tsx\n- [ ] ExcelImport.tsx\n- [ ] EditStudentModal.tsx\n- [ ] ManageModal.tsx\n- [ ] ProfileSettings.tsx\n- [ ] SendToTeacherModal.tsx\n- [ ] SearchBar.tsx (لا يحتاج ترحيل)\n- [ ] GroupSelector.tsx (لا يحتاج ترحيل)\n- [ ] FiltersPanel.tsx (لا يحتاج ترحيل)\n- [ ] AllowClassEntryModal.tsx\n\n### الصفحات (Pages)\n- [ ] TeachersPage.tsx\n- [ ] GroupsPage.tsx\n- [ ] GroupsManagementPage.tsx\n- [ ] SpecialStatusPage.tsx\n- [ ] AbsencePage.tsx\n- [ ] ReceptionPage.tsx\n- [ ] PermissionPage.tsx\n\n## أمثلة محددة\n\n### مثال 1: ترحيل StudentsList\n\n**الأجزاء التي تحتاج تغيير:**\n1. حذف السطر: `await db.students.delete(id)`\n2. استخدام mutation للحذف:\n```typescript\nconst deleteStudent = useMutation({\n  mutationFn: (id: string) => apiRequest(`/api/students/${id}`, 'DELETE'),\n  onSuccess: () => {\n    queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n    // استدعاء onStudentDeleted إذا كان موجوداً\n  }\n})\n```\n\n### مثال 2: ترحيل ExcelImport\n\n**التغييرات المطلوبة:**\n1. بدلاً من `db.students.bulkAdd(students)`:\n```typescript\nconst importStudents = useMutation({\n  mutationFn: (students) => apiRequest('/api/students/bulk', 'POST', { students }),\n  onSuccess: () => {\n    queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n  }\n})\n```\n\n### مثال 3: ترحيل ProfileSettings\n\n**التغييرات:**\n1. جلب البروفايل:\n```typescript\nconst { data: profile } = useQuery({\n  queryKey: ['/api/teacher-profile']\n})\n```\n\n2. حفظ البروفايل:\n```typescript\nconst saveProfile = useMutation({\n  mutationFn: (data) => apiRequest('/api/teacher-profile', 'POST', data),\n  onSuccess: () => {\n    queryClient.invalidateQueries({ queryKey: ['/api/teacher-profile'] })\n  }\n})\n```\n\n## نصائح مهمة\n\n1. **دائماً استخدم `invalidateQueries` بعد التعديلات**\n2. **استخدم `isLoading` و `isPending` لعرض حالات التحميل**\n3. **تعامل مع الأخطاء باستخدام `onError`**\n4. **احذف جميع استيرادات Supabase و IndexedDB**\n\n## الخطوات التالية\n\n1. افتح ملف المكون الذي تريد ترحيله\n2. ابحث عن `supabase.from` و `db.`\n3. استبدلها بـ `useQuery` أو `useMutation`\n4. تأكد من استيراد `useQuery, useMutation` من `@tanstack/react-query`\n5. تأكد من استيراد `apiRequest, queryClient` من `@/lib/queryClient`\n6. جرب المكون وتأكد من عمله\n","size_bytes":5152},"Erchad-1/server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { storage } from \"./dbStorage.js\";\nimport {\n  insertStudentSchema, insertGroupSchema, insertSpecialStatusSchema,\n  insertTeacherSchema, insertTeacherGroupSchema,\n  insertStudentVisitSchema, insertStudentPermissionSchema,\n  insertStudentViolationSchema, insertTeacherProfileSchema,\n  insertLoginCredentialsSchema\n} from \"../shared/schema.js\";\n\nexport function registerRoutes(app: Express) {\n  // Groups routes\n  app.get(\"/api/groups\", async (_req, res) => {\n    try {\n      const groups = await storage.getGroups();\n      res.json(groups);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch groups\" });\n    }\n  });\n\n  app.post(\"/api/groups\", async (req, res) => {\n    try {\n      const parsed = insertGroupSchema.parse(req.body);\n      const group = await storage.createGroup(parsed);\n      res.json(group);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid group data\" });\n    }\n  });\n\n  app.patch(\"/api/groups/:id\", async (req, res) => {\n    try {\n      const group = await storage.updateGroup(req.params.id, req.body);\n      if (!group) {\n        return res.status(404).json({ error: \"Group not found\" });\n      }\n      res.json(group);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update group\" });\n    }\n  });\n\n  app.delete(\"/api/groups/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteGroup(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Group not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete group\" });\n    }\n  });\n\n  // Special Statuses routes\n  app.get(\"/api/special-statuses\", async (_req, res) => {\n    try {\n      const statuses = await storage.getSpecialStatuses();\n      res.json(statuses);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch special statuses\" });\n    }\n  });\n\n  app.post(\"/api/special-statuses\", async (req, res) => {\n    try {\n      const parsed = insertSpecialStatusSchema.parse(req.body);\n      const status = await storage.createSpecialStatus(parsed);\n      res.json(status);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid status data\" });\n    }\n  });\n\n  app.delete(\"/api/special-statuses/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteSpecialStatus(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Special status not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete special status\" });\n    }\n  });\n\n  // Students routes\n  app.get(\"/api/students\", async (_req, res) => {\n    try {\n      const students = await storage.getStudents();\n      res.json(students);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch students\" });\n    }\n  });\n\n  app.post(\"/api/students\", async (req, res) => {\n    try {\n      const parsed = insertStudentSchema.parse(req.body);\n      const student = await storage.createStudent(parsed);\n      res.json(student);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid student data\" });\n    }\n  });\n\n  app.post(\"/api/students/bulk\", async (req, res) => {\n    try {\n      const students = req.body.students;\n      if (!Array.isArray(students)) {\n        return res.status(400).json({ error: \"Expected array of students\" });\n      }\n      const parsed = students.map(s => insertStudentSchema.parse(s));\n      const result = await storage.createManyStudents(parsed);\n      res.json(result);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid students data\" });\n    }\n  });\n\n  app.patch(\"/api/students/:id\", async (req, res) => {\n    try {\n      const student = await storage.updateStudent(req.params.id, req.body);\n      if (!student) {\n        return res.status(404).json({ error: \"Student not found\" });\n      }\n      res.json(student);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update student\" });\n    }\n  });\n\n  app.delete(\"/api/students/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudent(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student\" });\n    }\n  });\n\n  // Teachers routes\n  app.get(\"/api/teachers\", async (_req, res) => {\n    try {\n      const teachers = await storage.getTeachers();\n      res.json(teachers);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teachers\" });\n    }\n  });\n\n  app.post(\"/api/teachers\", async (req, res) => {\n    try {\n      const parsed = insertTeacherSchema.parse(req.body);\n      const teacher = await storage.createTeacher(parsed);\n      res.json(teacher);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid teacher data\" });\n    }\n  });\n\n  app.patch(\"/api/teachers/:id\", async (req, res) => {\n    try {\n      const teacher = await storage.updateTeacher(req.params.id, req.body);\n      if (!teacher) {\n        return res.status(404).json({ error: \"Teacher not found\" });\n      }\n      res.json(teacher);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update teacher\" });\n    }\n  });\n\n  app.delete(\"/api/teachers/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteTeacher(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Teacher not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete teacher\" });\n    }\n  });\n\n  // Teacher Groups routes\n  app.get(\"/api/teacher-groups\", async (_req, res) => {\n    try {\n      const teacherGroups = await storage.getTeacherGroups();\n      res.json(teacherGroups);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teacher groups\" });\n    }\n  });\n\n  app.get(\"/api/teacher-groups/teacher/:teacherId\", async (req, res) => {\n    try {\n      const teacherGroups = await storage.getTeacherGroupsByTeacherId(req.params.teacherId);\n      res.json(teacherGroups);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teacher groups\" });\n    }\n  });\n\n  app.post(\"/api/teacher-groups\", async (req, res) => {\n    try {\n      const parsed = insertTeacherGroupSchema.parse(req.body);\n      const teacherGroup = await storage.createTeacherGroup(parsed);\n      res.json(teacherGroup);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid teacher group data\" });\n    }\n  });\n\n  app.delete(\"/api/teacher-groups/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteTeacherGroup(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Teacher group not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete teacher group\" });\n    }\n  });\n\n  // Student Visits routes\n  app.get(\"/api/student-visits\", async (_req, res) => {\n    try {\n      const visits = await storage.getStudentVisits();\n      res.json(visits);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student visits\" });\n    }\n  });\n\n  app.get(\"/api/student-visits/student/:studentId\", async (req, res) => {\n    try {\n      const visits = await storage.getStudentVisitsByStudentId(req.params.studentId);\n      res.json(visits);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student visits\" });\n    }\n  });\n\n  app.post(\"/api/student-visits\", async (req, res) => {\n    try {\n      const parsed = insertStudentVisitSchema.parse(req.body);\n      const visit = await storage.createStudentVisit(parsed);\n      res.json(visit);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid visit data\" });\n    }\n  });\n\n  app.delete(\"/api/student-visits/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudentVisit(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student visit not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student visit\" });\n    }\n  });\n\n  // Student Permissions routes\n  app.get(\"/api/student-permissions\", async (_req, res) => {\n    try {\n      const permissions = await storage.getStudentPermissions();\n      res.json(permissions);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student permissions\" });\n    }\n  });\n\n  app.get(\"/api/student-permissions/student/:studentId\", async (req, res) => {\n    try {\n      const permissions = await storage.getStudentPermissionsByStudentId(req.params.studentId);\n      res.json(permissions);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student permissions\" });\n    }\n  });\n\n  app.post(\"/api/student-permissions\", async (req, res) => {\n    try {\n      const parsed = insertStudentPermissionSchema.parse(req.body);\n      const permission = await storage.createStudentPermission(parsed);\n      // Update student permission count\n      const student = await storage.getStudentById(permission.studentId!);\n      if (student) {\n        await storage.updateStudent(student.id, { \n          permissionCount: (student.permissionCount || 0) + 1,\n          status: \"استئذان\"\n        });\n      }\n      res.json(permission);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid permission data\" });\n    }\n  });\n\n  app.delete(\"/api/student-permissions/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudentPermission(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student permission not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student permission\" });\n    }\n  });\n\n  // Student Violations routes\n  app.get(\"/api/student-violations\", async (_req, res) => {\n    try {\n      const violations = await storage.getStudentViolations();\n      res.json(violations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student violations\" });\n    }\n  });\n\n  app.get(\"/api/student-violations/student/:studentId\", async (req, res) => {\n    try {\n      const violations = await storage.getStudentViolationsByStudentId(req.params.studentId);\n      res.json(violations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch student violations\" });\n    }\n  });\n\n  app.post(\"/api/student-violations\", async (req, res) => {\n    try {\n      const parsed = insertStudentViolationSchema.parse(req.body);\n      const violation = await storage.createStudentViolation(parsed);\n      // Update student violation count\n      const student = await storage.getStudentById(violation.studentId!);\n      if (student) {\n        await storage.updateStudent(student.id, { violationCount: (student.violationCount || 0) + 1 });\n      }\n      res.json(violation);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid violation data\" });\n    }\n  });\n\n  app.delete(\"/api/student-violations/:id\", async (req, res) => {\n    try {\n      const success = await storage.deleteStudentViolation(req.params.id);\n      if (!success) {\n        return res.status(404).json({ error: \"Student violation not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete student violation\" });\n    }\n  });\n\n  // Teacher Profile routes\n  app.get(\"/api/teacher-profile\", async (_req, res) => {\n    try {\n      const profile = await storage.getTeacherProfile();\n      res.json(profile || null);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch teacher profile\" });\n    }\n  });\n\n  app.post(\"/api/teacher-profile\", async (req, res) => {\n    try {\n      const parsed = insertTeacherProfileSchema.parse(req.body);\n      const profile = await storage.createOrUpdateTeacherProfile(parsed);\n      res.json(profile);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid profile data\" });\n    }\n  });\n\n  // Login routes\n  app.post(\"/api/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const credentials = await storage.getLoginCredentials(username);\n      if (credentials && credentials.passwordHash === password) {\n        res.json({ success: true });\n      } else {\n        res.status(401).json({ error: \"Invalid credentials\" });\n      }\n    } catch (error) {\n      res.status(500).json({ error: \"Login failed\" });\n    }\n  });\n\n  app.post(\"/api/init-login\", async (_req, res) => {\n    try {\n      const existing = await storage.getLoginCredentials(\"admin\");\n      if (!existing) {\n        await storage.createLoginCredentials({\n          username: \"admin\",\n          passwordHash: \"admin123\"\n        });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to initialize login\" });\n    }\n  });\n\n  app.post(\"/api/update-login-credentials\", async (req, res) => {\n    try {\n      const { currentUsername, newUsername, newPassword } = req.body;\n      \n      // التحقق من وجود المستخدم الحالي\n      const existing = await storage.getLoginCredentials(currentUsername);\n      if (!existing) {\n        res.status(404).json({ error: \"User not found\" });\n        return;\n      }\n      \n      // تحديث بيانات تسجيل الدخول\n      await storage.updateLoginCredentials(existing.id, {\n        username: newUsername,\n        passwordHash: newPassword\n      });\n      \n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update credentials\" });\n    }\n  });\n\n  app.post(\"/api/clear-database\", async (_req, res) => {\n    try {\n      await storage.clearDatabase();\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to clear database\" });\n    }\n  });\n\n  // Password Reset\n  app.post(\"/api/request-password-reset\", async (req, res) => {\n    try {\n      const { username } = req.body;\n      const result = await storage.createPasswordResetToken(username);\n      \n      if (!result) {\n        res.status(404).json({ error: \"User not found\" });\n        return;\n      }\n      \n      res.json({ success: true, token: result.token });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to create reset token\" });\n    }\n  });\n\n  app.post(\"/api/reset-password\", async (req, res) => {\n    try {\n      const { username, token, newPassword } = req.body;\n      const success = await storage.resetPassword(username, token, newPassword);\n      \n      if (!success) {\n        res.status(400).json({ error: \"Invalid or expired token\" });\n        return;\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to reset password\" });\n    }\n  });\n}\n","size_bytes":15153},"client/src/vite-env.d.ts":{"content":"/// <reference types=\"vite/client\" />\n","size_bytes":38},"client/src/components/ManageModal.tsx":{"content":"import { useState } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { X, Trash2, Plus } from 'lucide-react'\n\ninterface ManageModalProps {\n  type: 'groups' | 'special_statuses'\n  isOpen: boolean\n  onClose: () => void\n  onDataUpdated: () => void\n  existingItems: Array<{ id: string; name: string; stage?: string }>\n}\n\nexport function ManageModal({\n  type,\n  isOpen,\n  onClose,\n  onDataUpdated,\n  existingItems,\n}: ManageModalProps) {\n  const [newItem, setNewItem] = useState('')\n  const [newStage, setNewStage] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [deleteLoading, setDeleteLoading] = useState<string | null>(null)\n\n  const handleAdd = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (type === 'groups') {\n      if (!newStage.trim() || !newItem.trim()) {\n        setError('يرجى ملء جميع الحقول')\n        return\n      }\n    } else {\n      if (!newItem.trim()) return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      if (type === 'groups') {\n        const newId = crypto.randomUUID()\n\n        // Get the highest display_order for this stage\n        const stageGroups = await db.groups\n          .where('stage')\n          .equals(newStage.trim())\n          .toArray()\n        const maxOrder = stageGroups.length > 0\n          ? Math.max(...stageGroups.map(g => g.display_order || 0))\n          : 0\n\n        await db.groups.add({\n          id: newId,\n          stage: newStage.trim(),\n          name: newItem.trim(),\n          display_order: maxOrder + 1,\n          created_at: new Date().toISOString(),\n        })\n      } else {\n        const { error } = await supabase\n          .from('special_statuses')\n          .insert({\n            name: newItem.trim(),\n          })\n\n        if (error) throw error\n      }\n\n      setNewItem('')\n      setNewStage('')\n      onDataUpdated()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDelete = async (id: string) => {\n    if (!window.confirm('هل أنت متأكد من الحذف؟')) return\n\n    setDeleteLoading(id)\n    try {\n      if (type === 'groups') {\n        await db.groups.delete(id)\n      } else {\n        const { error } = await supabase\n          .from('special_statuses')\n          .delete()\n          .eq('id', id)\n\n        if (error) throw error\n      }\n      onDataUpdated()\n    } finally {\n      setDeleteLoading(null)\n    }\n  }\n\n  if (!isOpen) return null\n\n  const title = type === 'groups' ? 'إدارة المجموعات' : 'إدارة الحالات الخاصة'\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col\">\n        <div className=\"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-blue-500\">\n          <h2 className=\"text-xl font-bold text-white\">{title}</h2>\n          <button\n            onClick={onClose}\n            className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-6\">\n          {error && (\n            <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm\">\n              {error}\n            </div>\n          )}\n\n          <div className=\"space-y-3\">\n            {existingItems.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-500\">\n                {type === 'groups' ? 'لا توجد مجموعات' : 'لا توجد حالات خاصة'}\n              </div>\n            ) : (\n              existingItems.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200\"\n                >\n                  <span className=\"font-medium text-gray-800\">\n                    {type === 'groups' && item.stage ? `${item.stage} - ${item.name}` : item.name}\n                  </span>\n                  <button\n                    onClick={() => handleDelete(item.id)}\n                    disabled={deleteLoading === item.id}\n                    className=\"p-1 text-red-600 hover:bg-red-50 rounded disabled:opacity-50 transition-colors\"\n                  >\n                    <Trash2 size={18} />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n\n        <div className=\"border-t border-gray-200 p-6 bg-gray-50\">\n          <form onSubmit={handleAdd} className=\"space-y-3\">\n            {type === 'groups' && (\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الصف (المرحلة)\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: الصف الأول الثانوي\"\n                  value={newStage}\n                  onChange={(e) => setNewStage(e.target.value)}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n            )}\n            <div>\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                {type === 'groups' ? 'اسم المجموعة' : 'اسم الحالة الخاصة'}\n              </label>\n              <input\n                type=\"text\"\n                placeholder={type === 'groups' ? 'مثال: مجموعة 1' : 'أضف جديد...'}\n                value={newItem}\n                onChange={(e) => setNewItem(e.target.value)}\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              />\n            </div>\n            <button\n              type=\"submit\"\n              disabled={loading || !newItem.trim() || (type === 'groups' && !newStage.trim())}\n              className=\"w-full px-4 py-3 bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Plus size={20} />\n              {type === 'groups' ? 'إضافة المجموعة' : 'إضافة'}\n            </button>\n          </form>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6616},"client/src/App.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { useQuery, useMutation } from '@tanstack/react-query'\nimport { apiRequest, queryClient } from '@/lib/queryClient'\nimport { LoginPage } from './pages/LoginPage'\nimport { ProfileSettings } from './components/ProfileSettings'\nimport { ExcelImport } from './components/ExcelImport'\nimport { formatPhoneForWhatsApp } from '@/lib/formatPhone'\nimport type { Student, SpecialStatus, TeacherProfile } from '@shared/schema'\nimport {\n  Home,\n  Users,\n  Heart,\n  AlertCircle,\n  UserCheck,\n  LogOut,\n  Settings,\n  GraduationCap,\n  Search,\n  User as UserIcon,\n  ChevronDown,\n  Download,\n  Upload,\n  List,\n  X,\n  Trash2,\n  Plus,\n  Star,\n  Clock,\n  AlertTriangle,\n  MoreVertical,\n  CheckCircle,\n  Printer,\n  Edit,\n  BookOpen,\n  Phone,\n  UserPlus,\n  Send,\n  PlusCircle,\n  UserSearch,\n  Calendar,\n  Lock,\n  LayoutDashboard,\n} from 'lucide-react'\n\ntype Page = 'home' | 'groups' | 'special-status' | 'absence' | 'reception' | 'permission' | 'teachers'\n\nfunction App() {\n  const [isLoggedIn, setIsLoggedIn] = useState(false)\n  const [currentPage, setCurrentPage] = useState<Page>('home')\n  const [searchTerm, setSearchTerm] = useState('')\n  const [showSettingsMenu, setShowSettingsMenu] = useState(false)\n  const [showSpecialStatusModal, setShowSpecialStatusModal] = useState(false)\n  const [newStatusName, setNewStatusName] = useState('')\n  const [showGroupsModal, setShowGroupsModal] = useState(false)\n  const [newGroupName, setNewGroupName] = useState('')\n  const [newGroupStage, setNewGroupStage] = useState('')\n  \n  // تعديل المجموعة\n  const [showEditGroupModal, setShowEditGroupModal] = useState(false)\n  const [selectedGroup, setSelectedGroup] = useState<any | null>(null)\n  const [editGroupData, setEditGroupData] = useState({ name: '', stage: '' })\n  const [showExcelImportModal, setShowExcelImportModal] = useState(false)\n  const [showProfileSettingsModal, setShowProfileSettingsModal] = useState(false)\n  const [showLoginSettingsModal, setShowLoginSettingsModal] = useState(false)\n  \n  // حقول إعدادات الملف الشخصي\n  const [teacherName, setTeacherName] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n  const [teacherPhone, setTeacherPhone] = useState('')\n  const [systemDescription, setSystemDescription] = useState('')\n  const [openMenuStudentId, setOpenMenuStudentId] = useState<string | null>(null)\n  \n  // حقول إعدادات تسجيل الدخول\n  const [newUsername, setNewUsername] = useState('admin')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmPassword, setConfirmPassword] = useState('')\n  const [loginSettingsError, setLoginSettingsError] = useState('')\n  \n  // السماح بدخول الفصل\n  const [showAllowEntryModal, setShowAllowEntryModal] = useState(false)\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  \n  // تعديل الطالب\n  const [showEditStudentModal, setShowEditStudentModal] = useState(false)\n  const [selectedStage, setSelectedStage] = useState('')\n  const [editStudentData, setEditStudentData] = useState({\n    name: '',\n    nationalId: '',\n    phone: '',\n    guardianPhone: '',\n    grade: '',\n    groupId: '',\n    specialStatusId: '',\n  })\n  \n  // طباعة بيانات الطالب\n  const [showPrintModal, setShowPrintModal] = useState(false)\n  const [printStudent, setPrintStudent] = useState<Student | null>(null)\n  \n  // المعلمين\n  const [showAddTeacherModal, setShowAddTeacherModal] = useState(false)\n  const [showEditTeacherModal, setShowEditTeacherModal] = useState(false)\n  const [selectedTeacher, setSelectedTeacher] = useState<any | null>(null)\n  const [teacherFormData, setTeacherFormData] = useState({\n    name: '',\n    phone: '',\n    specialization: '',\n  })\n  \n  // حالة المجموعات (مفتوحة/مغلقة) - افتراضياً جميع المجموعات مفتوحة\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set())\n  \n  // صفحة المجموعات\n  const [showSpecialStatusColumn, setShowSpecialStatusColumn] = useState(false)\n  const [expandedGroupsPage, setExpandedGroupsPage] = useState<Set<string>>(new Set())\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n  \n  // طباعة المجموعة\n  const [showGroupPrintModal, setShowGroupPrintModal] = useState(false)\n  const [selectedGroupForPrint, setSelectedGroupForPrint] = useState<any | null>(null)\n  \n  // إدارة القوائم - ما يظهر في الصفحة الرئيسية\n  const [listSettings, setListSettings] = useState({\n    showGroups: true,\n    showSpecialStatus: true,\n    showReception: true,\n    showPermissions: true,\n    showViolations: true,\n    showTeachers: true,\n  })\n\n  // إعدادات الهيدر - البطاقات التي تظهر في الهيدر\n  const [headerSettings, setHeaderSettings] = useState({\n    showTotalStudents: true,\n    showTotalTeachers: true,\n    showPermissions: true,\n    showSpecialStatus: true,\n    showReceptions: true,\n    showViolations: true,\n  })\n  const [showHeaderSettingsModal, setShowHeaderSettingsModal] = useState(false)\n  \n  // إرسال للمعلم\n  const [showSendToTeacherModal, setShowSendToTeacherModal] = useState(false)\n  const [selectedTeacherForSend, setSelectedTeacherForSend] = useState('')\n  const [selectedStageForSend, setSelectedStageForSend] = useState('')\n  const [selectedGroupsForSend, setSelectedGroupsForSend] = useState<Set<string>>(new Set())\n  \n  // طباعة المجموعة - الحالات الخاصة\n  const [showSpecialStatusPrintModal, setShowSpecialStatusPrintModal] = useState(false)\n  const [selectedGroupForSpecialPrint, setSelectedGroupForSpecialPrint] = useState<any | null>(null)\n  \n  // تأكيد حذف المجموعة\n  const [showDeleteGroupConfirm, setShowDeleteGroupConfirm] = useState(false)\n  const [groupToDelete, setGroupToDelete] = useState<any | null>(null)\n  \n  // استقبال الطلاب\n  const [receptionSearchTerm, setReceptionSearchTerm] = useState('')\n  const [selectedStudentForReception, setSelectedStudentForReception] = useState<Student | null>(null)\n  const [visitReason, setVisitReason] = useState('')\n  const [actionTaken, setActionTaken] = useState('')\n  const [referredTo, setReferredTo] = useState('')\n  const [additionalNotes, setAdditionalNotes] = useState('')\n  const [showDateFilterModal, setShowDateFilterModal] = useState(false)\n  const [filterDate, setFilterDate] = useState('')\n  const [dateFilterError, setDateFilterError] = useState('')\n  const [selectedStudentFilter, setSelectedStudentFilter] = useState<Student | null>(null)\n  const [studentSearchTerm, setStudentSearchTerm] = useState('')\n  \n  // الاستئذان\n  const [permissionSearchTerm, setPermissionSearchTerm] = useState('')\n  const [selectedStudentForPermission, setSelectedStudentForPermission] = useState<Student | null>(null)\n  const [permissionReason, setPermissionReason] = useState('')\n  const [permissionNotes, setPermissionNotes] = useState('')\n  const [showPermissionDateFilter, setShowPermissionDateFilter] = useState(false)\n  const [permissionFilterDate, setPermissionFilterDate] = useState('')\n  const [permissionDateFilterError, setPermissionDateFilterError] = useState('')\n  const [selectedPermissionStudentFilter, setSelectedPermissionStudentFilter] = useState<Student | null>(null)\n  const [permissionStudentSearchTerm, setPermissionStudentSearchTerm] = useState('')\n  \n  // المخالفات\n  const [violationSearchTerm, setViolationSearchTerm] = useState('')\n  const [selectedStudentForViolation, setSelectedStudentForViolation] = useState<Student | null>(null)\n  const [violationType, setViolationType] = useState('')\n  const [violationDescription, setViolationDescription] = useState('')\n  const [violationAction, setViolationAction] = useState('')\n  const [violationNotes, setViolationNotes] = useState('')\n  const [showViolationDateFilter, setShowViolationDateFilter] = useState(false)\n  const [violationFilterDate, setViolationFilterDate] = useState('')\n  \n  // فلاتر الصفحة الرئيسية\n  const [homeSpecialStatusFilter, setHomeSpecialStatusFilter] = useState<string>('all')\n  const [homeStageFilter, setHomeStageFilter] = useState<string>('all')\n  const [homeGroupFilter, setHomeGroupFilter] = useState<string>('all')\n  const [violationDateFilterError, setViolationDateFilterError] = useState('')\n  const [selectedViolationStudentFilter, setSelectedViolationStudentFilter] = useState<Student | null>(null)\n  const [violationStudentSearchTerm, setViolationStudentSearchTerm] = useState('')\n  \n  // أخطاء التحقق\n  const [permissionError, setPermissionError] = useState('')\n  const [violationError, setViolationError] = useState('')\n\n  // جلب البيانات من API\n  const { data: students = [], isLoading: studentsLoading } = useQuery<Student[]>({\n    queryKey: ['/api/students'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: groups = [] } = useQuery<any[]>({\n    queryKey: ['/api/groups'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: specialStatuses = [], isLoading: statusesLoading } = useQuery<SpecialStatus[]>({\n    queryKey: ['/api/special-statuses'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: profile, isLoading: profileLoading } = useQuery<TeacherProfile | null>({\n    queryKey: ['/api/teacher-profile'],\n    enabled: isLoggedIn,\n    retry: 1,\n  })\n\n  const { data: teachers = [] } = useQuery<any[]>({\n    queryKey: ['/api/teachers'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: studentVisits = [] } = useQuery<any[]>({\n    queryKey: ['/api/student-visits'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: studentPermissions = [], isLoading: isLoadingPermissions } = useQuery<any[]>({\n    queryKey: ['/api/student-permissions'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: studentViolations = [], isLoading: isLoadingViolations } = useQuery<any[]>({\n    queryKey: ['/api/student-violations'],\n    enabled: isLoggedIn,\n  })\n\n  // إضافة حالة خاصة جديدة\n  const addSpecialStatus = useMutation({\n    mutationFn: (name: string) => apiRequest('/api/special-statuses', 'POST', { name }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/special-statuses'] })\n      setNewStatusName('')\n    },\n  })\n\n  // حذف حالة خاصة\n  const deleteSpecialStatus = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/special-statuses/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/special-statuses'] })\n    },\n  })\n\n  // إضافة مجموعة جديدة\n  const addGroup = useMutation({\n    mutationFn: (data: { name: string; stage: string }) => \n      apiRequest('/api/groups', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] })\n      setNewGroupName('')\n      setNewGroupStage('')\n    },\n  })\n\n  // تحديث مجموعة\n  const updateGroup = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: { name: string; stage: string } }) =>\n      apiRequest(`/api/groups/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] })\n      setShowEditGroupModal(false)\n      setSelectedGroup(null)\n    },\n  })\n\n  // حذف مجموعة\n  const deleteGroup = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/groups/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] })\n    },\n  })\n\n  useEffect(() => {\n    const loggedIn = localStorage.getItem('isLoggedIn') === 'true'\n    setIsLoggedIn(loggedIn)\n    \n    // تحميل إدارة القوائم من localStorage\n    const savedSettings = localStorage.getItem('listSettings')\n    if (savedSettings) {\n      setListSettings(JSON.parse(savedSettings))\n    }\n  }, [])\n\n  // تحميل بيانات الملف الشخصي في الحقول عند فتح النافذة\n  useEffect(() => {\n    if (showProfileSettingsModal && profile) {\n      setTeacherName(profile.logoUrl || '')\n      setSchoolName(profile.schoolName || '')\n      setTeacherPhone('')\n      setSystemDescription(profile.name || '')\n    }\n  }, [showProfileSettingsModal, profile])\n  \n  // حفظ إدارة القوائم عند التغيير\n  const updateListSettings = (newSettings: typeof listSettings) => {\n    setListSettings(newSettings)\n    localStorage.setItem('listSettings', JSON.stringify(newSettings))\n  }\n\n  // تحديث معلومات الملف الشخصي\n  const updateProfile = useMutation({\n    mutationFn: (data: { name?: string; phone?: string; schoolName?: string; logoUrl?: string }) => \n      apiRequest('/api/teacher-profile', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teacher-profile'] })\n    },\n  })\n\n  // تصفير قاعدة البيانات\n  const clearDatabase = useMutation({\n    mutationFn: () => apiRequest('/api/clear-database', 'POST'),\n    onSuccess: () => {\n      queryClient.invalidateQueries()\n    },\n  })\n\n  // إضافة طالب جديد\n  const createStudent = useMutation({\n    mutationFn: (data: any) => apiRequest('/api/students', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setShowEditStudentModal(false)\n      setSelectedStudent(null)\n    },\n  })\n\n  // تحديث بيانات الطالب\n  const updateStudent = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(`/api/students/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setShowEditStudentModal(false)\n      setSelectedStudent(null)\n    },\n  })\n\n  // حذف طالب\n  const deleteStudent = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/students/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n    },\n  })\n\n  // إضافة معلم\n  const addTeacher = useMutation({\n    mutationFn: (data: any) => apiRequest('/api/teachers', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teachers'] })\n      setShowAddTeacherModal(false)\n      setTeacherFormData({ name: '', phone: '', specialization: '' })\n    },\n  })\n\n  // تحديث معلم\n  const updateTeacher = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(`/api/teachers/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teachers'] })\n      setShowEditTeacherModal(false)\n      setSelectedTeacher(null)\n    },\n  })\n\n  // حذف معلم\n  const deleteTeacher = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/teachers/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teachers'] })\n    },\n  })\n\n  // إضافة زيارة طالب\n  const addStudentVisit = useMutation({\n    mutationFn: (visitData: any) => apiRequest('/api/student-visits', 'POST', visitData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-visits'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      // إعادة تعيين النموذج\n      setSelectedStudentForReception(null)\n      setVisitReason('')\n      setActionTaken('')\n      setReferredTo('')\n      setAdditionalNotes('')\n    },\n  })\n\n  // إضافة استئذان طالب\n  const addStudentPermission = useMutation({\n    mutationFn: (permissionData: any) => apiRequest('/api/student-permissions', 'POST', permissionData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-permissions'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setSelectedStudentForPermission(null)\n      setPermissionReason('')\n      setPermissionNotes('')\n      setPermissionError('')\n    },\n    onError: (error: any) => {\n      setPermissionError(error.message || 'حدث خطأ أثناء حفظ الاستئذان')\n    },\n  })\n\n  // إضافة مخالفة طالب\n  const addStudentViolation = useMutation({\n    mutationFn: (violationData: any) => apiRequest('/api/student-violations', 'POST', violationData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-violations'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setSelectedStudentForViolation(null)\n      setViolationType('')\n      setViolationDescription('')\n      setViolationAction('')\n      setViolationNotes('')\n      setViolationError('')\n    },\n    onError: (error: any) => {\n      setViolationError(error.message || 'حدث خطأ أثناء حفظ المخالفة')\n    },\n  })\n\n  // حذف زيارة طالب\n  const deleteStudentVisit = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/student-visits/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-visits'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n    },\n  })\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      const target = event.target as HTMLElement\n      if (showSettingsMenu && !target.closest('.settings-menu-container')) {\n        setShowSettingsMenu(false)\n      }\n    }\n\n    document.addEventListener('mousedown', handleClickOutside)\n    return () => document.removeEventListener('mousedown', handleClickOutside)\n  }, [showSettingsMenu])\n\n  // المجموعات في الصفحة الرئيسية تبدأ مخفية (مطوية)\n\n  // فتح جميع المجموعات في صفحة المجموعات\n  useEffect(() => {\n    if (groups.length > 0 && expandedGroupsPage.size === 0) {\n      const allGroupIds = new Set(groups.map(g => g.id))\n      setExpandedGroupsPage(allGroupIds)\n    }\n  }, [groups.length])\n\n  // فتح المراحل والمجموعات تلقائياً عند البحث\n  useEffect(() => {\n    if (searchTerm.trim() && students.length > 0) {\n      // حساب الطلاب المفلترين\n      const filtered = students.filter(student => {\n        const search = searchTerm.toLowerCase()\n        return (\n          student.name.toLowerCase().includes(search) ||\n          student.nationalId.includes(search) ||\n          (student.phone && student.phone.includes(search)) ||\n          (student.guardianPhone && student.guardianPhone.includes(search))\n        )\n      })\n\n      if (filtered.length > 0) {\n        const stagesWithResults = new Set<string>()\n        const groupsWithResults = new Set<string>()\n        \n        filtered.forEach(student => {\n          const studentGroup = groups.find(g => g.id === student.groupId)\n          if (studentGroup) {\n            stagesWithResults.add(studentGroup.stage)\n            groupsWithResults.add(student.groupId)\n          }\n        })\n        \n        setExpandedStages(prev => {\n          const newSet = new Set(stagesWithResults)\n          if (prev.size === newSet.size && [...prev].every(v => newSet.has(v))) return prev\n          return newSet\n        })\n        setExpandedGroups(prev => {\n          const newSet = new Set(groupsWithResults)\n          if (prev.size === newSet.size && [...prev].every(v => newSet.has(v))) return prev\n          return newSet\n        })\n      }\n    } else if (!searchTerm.trim()) {\n      // عند مسح البحث، إغلاق كل شيء\n      setExpandedStages(prev => prev.size === 0 ? prev : new Set())\n      setExpandedGroups(prev => prev.size === 0 ? prev : new Set())\n    }\n  }, [searchTerm, students.length, groups.length])\n\n  const handleLogout = () => {\n    localStorage.removeItem('isLoggedIn')\n    localStorage.removeItem('userId')\n    setIsLoggedIn(false)\n    setCurrentPage('home')\n  }\n\n  const handleLogin = () => {\n    setIsLoggedIn(true)\n  }\n\n  // تسجيل الخروج التلقائي - مراقبة نشاط المستخدم\n  useEffect(() => {\n    if (!isLoggedIn) return\n\n    const autoLogoutMinutes = profile?.autoLogoutMinutes || 0\n\n    // إذا كانت الميزة معطلة، لا نفعل شيء\n    if (autoLogoutMinutes === 0) return\n\n    let logoutTimer: ReturnType<typeof setTimeout> | null = null\n    let isActive = true\n\n    const resetTimer = () => {\n      if (!isActive) return\n      if (logoutTimer) clearTimeout(logoutTimer)\n\n      logoutTimer = setTimeout(() => {\n        if (!isActive) return\n        handleLogout()\n        alert(`تم تسجيل الخروج تلقائياً بعد ${autoLogoutMinutes} دقيقة من عدم النشاط`)\n      }, autoLogoutMinutes * 60 * 1000)\n    }\n\n    // مراقبة نشاط المستخدم\n    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click']\n    events.forEach(event => {\n      document.addEventListener(event, resetTimer, true)\n    })\n\n    // بدء المؤقت\n    resetTimer()\n\n    // تنظيف عند unmount\n    return () => {\n      isActive = false\n      if (logoutTimer) clearTimeout(logoutTimer)\n      events.forEach(event => {\n        document.removeEventListener(event, resetTimer, true)\n      })\n    }\n  }, [isLoggedIn, profile?.autoLogoutMinutes])\n\n  if (!isLoggedIn) {\n    return <LoginPage onLogin={handleLogin} />\n  }\n\n  // حالة التحميل - فقط للبيانات الأساسية (الطلاب والحالات الخاصة)\n  if (studentsLoading || statusesLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center\" dir=\"rtl\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4\"></div>\n          <p className=\"text-xl text-gray-600 font-semibold\">جاري التحميل...</p>\n        </div>\n      </div>\n    )\n  }\n\n  // تصفية الطلاب بناءً على البحث والفلاتر\n  const filteredStudents = students.filter(student => {\n    // فلتر البحث\n    if (searchTerm.trim()) {\n      const search = searchTerm.toLowerCase()\n      const matchesSearch = (\n        student.name.toLowerCase().includes(search) ||\n        student.nationalId.includes(search) ||\n        (student.phone && student.phone.includes(search)) ||\n        (student.guardianPhone && student.guardianPhone.includes(search))\n      )\n      if (!matchesSearch) return false\n    }\n    \n    // فلتر الحالة الخاصة\n    if (homeSpecialStatusFilter !== 'all') {\n      if (student.specialStatusId !== homeSpecialStatusFilter) return false\n    }\n    \n    // فلتر المرحلة الدراسية\n    if (homeStageFilter !== 'all') {\n      const studentGroup = groups.find(g => g.id === student.groupId)\n      if (!studentGroup || studentGroup.stage !== homeStageFilter) return false\n    }\n    \n    // فلتر المجموعة\n    if (homeGroupFilter !== 'all') {\n      if (student.groupId !== homeGroupFilter) return false\n    }\n    \n    return true\n  })\n\n  // تاريخ اليوم بالتوقيت المحلي بصيغة YYYY-MM-DD\n  const today = new Date().toLocaleDateString('en-CA') // en-CA يعطي YYYY-MM-DD\n  \n  // العدادات الثابتة (لا تتغير إلا بالإضافة/الحذف)\n  const totalStudents = students.length\n  const totalTeachers = teachers.length\n  const specialStatusCount = students.filter(s => s.specialStatusId !== null).length\n  \n  // العدادات اليومية (تبدأ من صفر كل يوم جديد، لكن البيانات محفوظة)\n  const receptionCount = studentVisits.filter((v: any) => v.visitDate === today).length\n  const permissions = studentPermissions.filter((p: any) => p.permissionDate === today).length\n  const violationsCount = studentViolations.filter((v: any) => v.violationDate === today).length\n\n  const allNavItems = [\n    { id: 'home' as Page, label: 'الصفحة الرئيسية', icon: Home, alwaysShow: true, color: 'bg-gradient-to-r from-blue-600 to-blue-700' },\n    { id: 'teachers' as Page, label: 'المعلمين', icon: GraduationCap, settingKey: 'showTeachers', color: 'bg-gradient-to-r from-green-600 to-emerald-700' },\n    { id: 'groups' as Page, label: 'المجموعات', icon: Users, settingKey: 'showGroups', color: 'bg-gradient-to-r from-teal-600 to-cyan-700' },\n    { id: 'special-status' as Page, label: 'الحالات الخاصة', icon: Heart, settingKey: 'showSpecialStatus', color: 'bg-gradient-to-r from-pink-600 to-rose-700' },\n    { id: 'reception' as Page, label: 'استقبال الطلاب', icon: UserCheck, settingKey: 'showReception', color: 'bg-gradient-to-r from-purple-600 to-indigo-700' },\n    { id: 'permission' as Page, label: 'الاستئذان', icon: LogOut, settingKey: 'showPermissions', color: 'bg-gradient-to-r from-orange-600 to-amber-700' },\n    { id: 'absence' as Page, label: 'المخالفات', icon: AlertCircle, settingKey: 'showViolations', color: 'bg-gradient-to-r from-red-600 to-rose-700' },\n  ]\n\n  // تصفية القوائم بناءً على الإعدادات\n  const navItems = allNavItems.filter(item => {\n    if (item.alwaysShow) return true\n    if (!item.settingKey) return true\n    return listSettings[item.settingKey as keyof typeof listSettings]\n  })\n\n  // تنظيم الطلاب حسب المجموعات\n  const studentsByGroup = filteredStudents.reduce((acc, student) => {\n    const groupId = student.groupId || 'unassigned'\n    if (!acc[groupId]) {\n      acc[groupId] = []\n    }\n    acc[groupId].push(student)\n    return acc\n  }, {} as Record<string, Student[]>)\n\n  // ألوان المجموعات (6 ألوان متناوبة)\n  const groupColors = [\n    { bg: 'from-gray-600 to-gray-700', light: 'bg-gray-50', border: 'border-gray-200' },\n    { bg: 'from-gray-400 to-gray-500', light: 'bg-gray-50', border: 'border-gray-200' },\n    { bg: 'from-gray-600 to-gray-700', light: 'bg-gray-50', border: 'border-gray-200' },\n    { bg: 'from-gray-400 to-gray-500', light: 'bg-gray-50', border: 'border-gray-200' },\n    { bg: 'from-gray-600 to-gray-700', light: 'bg-gray-50', border: 'border-gray-200' },\n    { bg: 'from-gray-400 to-gray-500', light: 'bg-gray-50', border: 'border-gray-200' },\n  ]\n\n  // دالة toggle للمجموعة\n  const toggleGroup = (groupId: string) => {\n    const newExpanded = new Set(expandedGroups)\n    if (newExpanded.has(groupId)) {\n      newExpanded.delete(groupId)\n    } else {\n      newExpanded.add(groupId)\n    }\n    setExpandedGroups(newExpanded)\n  }\n\n  // دالة toggle للمجموعة في صفحة المجموعات\n  const toggleGroupPage = (groupId: string) => {\n    const newExpanded = new Set(expandedGroupsPage)\n    if (newExpanded.has(groupId)) {\n      newExpanded.delete(groupId)\n    } else {\n      newExpanded.add(groupId)\n    }\n    setExpandedGroupsPage(newExpanded)\n  }\n\n  // دالة toggle للمرحلة الدراسية\n  const toggleStage = (stage: string) => {\n    const newExpanded = new Set(expandedStages)\n    if (newExpanded.has(stage)) {\n      newExpanded.delete(stage)\n    } else {\n      newExpanded.add(stage)\n    }\n    setExpandedStages(newExpanded)\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50\" dir=\"rtl\">\n      {/* Header */}\n      <header className=\"bg-white shadow-lg border-b-4 border-blue-600\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"bg-gradient-to-br from-blue-600 to-blue-700 p-3 rounded-2xl shadow-lg\">\n                <Users className=\"text-white\" size={32} />\n              </div>\n              <div>\n                <h1 className=\"text-3xl font-bold text-gray-900\">\n                  {profile?.schoolName || 'نظام إدارة شاملة لبيانات الطلاب'}\n                </h1>\n                <p className=\"text-base text-gray-600 mt-1 font-medium\">\n                  {profile?.systemTitle || 'قم بإضافة اسم المدرسة من الإعدادات'}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative settings-menu-container\">\n                <button\n                  onClick={() => setShowSettingsMenu(!showSettingsMenu)}\n                  className=\"flex items-center gap-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all hover:shadow-xl hover:scale-105\"\n                  data-testid=\"button-settings\"\n                >\n                  <Settings size={20} />\n                  <span>الإعدادات</span>\n                </button>\n\n                {showSettingsMenu && (\n                  <div className=\"absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-200 py-2 z-50\">\n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowExcelImportModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-green-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-import-excel\"\n                    >\n                      <Download size={18} className=\"text-green-600\" />\n                      <span className=\"font-semibold text-gray-700\">استيراد من Excel</span>\n                    </button>\n                    \n                    <button\n                      onClick={async () => {\n                        setShowSettingsMenu(false)\n                        try {\n                          // جلب جميع البيانات من API (باستثناء بيانات تسجيل الدخول لأسباب أمنية)\n                          const [studentsData, groupsData, teachersData, specialStatusesData, teacherGroupsData, visitsData, permissionsData, violationsData, profileData] = await Promise.all([\n                            fetch('/api/students').then(r => r.json()),\n                            fetch('/api/groups').then(r => r.json()),\n                            fetch('/api/teachers').then(r => r.json()),\n                            fetch('/api/special-statuses').then(r => r.json()),\n                            fetch('/api/teacher-groups').then(r => r.json()),\n                            fetch('/api/student-visits').then(r => r.json()),\n                            fetch('/api/student-permissions').then(r => r.json()),\n                            fetch('/api/student-violations').then(r => r.json()),\n                            fetch('/api/teacher-profile').then(r => r.json())\n                          ])\n                          \n                          const exportData = {\n                            version: '2.0',\n                            exportDate: new Date().toISOString(),\n                            data: {\n                              students: studentsData,\n                              groups: groupsData,\n                              teachers: teachersData,\n                              special_statuses: specialStatusesData,\n                              teacher_groups: teacherGroupsData,\n                              visits: visitsData,\n                              permissions: permissionsData,\n                              violations: violationsData,\n                              profile: profileData\n                            }\n                          }\n                          \n                          // تحويل البيانات لـ JSON\n                          const jsonStr = JSON.stringify(exportData, null, 2)\n                          const blob = new Blob([jsonStr], { type: 'application/json' })\n                          const url = URL.createObjectURL(blob)\n                          \n                          // تحميل الملف\n                          const a = document.createElement('a')\n                          a.href = url\n                          a.download = `erchad-backup-${new Date().toISOString().split('T')[0]}.json`\n                          document.body.appendChild(a)\n                          a.click()\n                          document.body.removeChild(a)\n                          URL.revokeObjectURL(url)\n                          \n                          alert('✅ تم تصدير البيانات بنجاح!')\n                        } catch (error) {\n                          console.error('Error exporting data:', error)\n                          alert('❌ حدث خطأ أثناء تصدير البيانات')\n                        }\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-purple-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-export-data\"\n                    >\n                      <Download size={18} className=\"text-purple-600\" />\n                      <span className=\"font-semibold text-gray-700\">تصدير البيانات الكاملة</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        document.getElementById('import-data-file')?.click()\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-indigo-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-import-data\"\n                    >\n                      <Upload size={18} className=\"text-indigo-600\" />\n                      <span className=\"font-semibold text-gray-700\">استيراد البيانات الكاملة</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowGroupsModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-manage-groups\"\n                    >\n                      <Users size={18} className=\"text-blue-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة المجموعات</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowSpecialStatusModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-pink-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-manage-special-status\"\n                    >\n                      <Heart size={18} className=\"text-pink-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة الحالات الخاصة</span>\n                    </button>\n\n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowHeaderSettingsModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-gradient-to-r hover:from-teal-50 hover:to-purple-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-header-list-settings\"\n                    >\n                      <LayoutDashboard size={18} className=\"text-teal-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة الهيدر والقوائم</span>\n                    </button>\n                    \n                    <div className=\"border-t border-gray-200 my-2\"></div>\n                    \n                    <button\n                      onClick={() => {\n                        handleLogout()\n                        setShowSettingsMenu(false)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-red-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-logout\"\n                    >\n                      <LogOut size={18} className=\"text-red-600\" />\n                      <span className=\"font-semibold text-red-600\">تسجيل الخروج</span>\n                    </button>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex items-center gap-3\">\n                {/* شارة مالك النظام */}\n                {localStorage.getItem('userId') === 'master-admin' && (\n                  <div className=\"bg-gradient-to-r from-amber-400 to-yellow-500 px-4 py-3 rounded-xl shadow-lg border-2 border-yellow-300 animate-pulse\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-2xl\">👑</span>\n                      <span className=\"text-sm font-bold text-amber-900\">مالك النظام</span>\n                    </div>\n                  </div>\n                )}\n                \n                <button\n                  onClick={() => setShowProfileSettingsModal(true)}\n                  className={`flex items-center gap-2 px-4 py-3 rounded-xl font-bold shadow-lg border-2 transition-all hover:shadow-xl ${\n                    localStorage.getItem('userId') === 'master-admin'\n                      ? 'bg-gradient-to-r from-amber-50 to-yellow-50 hover:from-amber-100 hover:to-yellow-100 text-amber-900 border-yellow-300'\n                      : 'bg-white hover:bg-gray-50 text-gray-700 border-gray-200'\n                  }`}\n                  data-testid=\"button-profile\"\n                >\n                  <div className={`p-2 rounded-lg ${\n                    localStorage.getItem('userId') === 'master-admin'\n                      ? 'bg-gradient-to-br from-amber-500 to-yellow-600'\n                      : 'bg-gradient-to-br from-blue-500 to-blue-600'\n                  }`}>\n                    <UserIcon className=\"text-white\" size={20} />\n                  </div>\n                  {profile?.name ? (\n                    <span className=\"text-sm\">{profile.name}</span>\n                  ) : (\n                    <span className=\"text-sm\">الملف الشخصي</span>\n                  )}\n                </button>\n              </div>\n            </div>\n          </div>\n\n          {/* Stats Cards */}\n          {(() => {\n            const visibleCards = [\n              headerSettings.showTotalStudents && (\n                <div key=\"students\" className=\"bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-total-students\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-blue-100 text-sm\">إجمالي الطلاب</p>\n                      <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-total-students\">{totalStudents}</p>\n                    </div>\n                    <Users size={40} className=\"text-blue-200\" />\n                  </div>\n                </div>\n              ),\n              headerSettings.showTotalTeachers && (\n                <div key=\"teachers\" className=\"bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-total-teachers\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-green-100 text-sm\">المعلمين</p>\n                      <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-total-teachers\">{totalTeachers}</p>\n                    </div>\n                    <GraduationCap size={40} className=\"text-green-200\" />\n                  </div>\n                </div>\n              ),\n              headerSettings.showSpecialStatus && (\n                <div key=\"special\" className=\"bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-special-status\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-purple-100 text-sm\">حالات خاصة</p>\n                      <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-special-status\">{specialStatusCount}</p>\n                    </div>\n                    <Heart size={40} className=\"text-purple-200\" />\n                  </div>\n                </div>\n              ),\n              headerSettings.showReceptions && (\n                <div key=\"receptions\" className=\"bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-receptions\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-indigo-100 text-sm\">استقبال الطلاب</p>\n                      <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-receptions\">{receptionCount}</p>\n                    </div>\n                    <UserCheck size={40} className=\"text-indigo-200\" />\n                  </div>\n                </div>\n              ),\n              headerSettings.showPermissions && (\n                <div key=\"permissions\" className=\"bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-permissions\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-orange-100 text-sm\">استئذانات</p>\n                      <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-permissions\">{permissions}</p>\n                    </div>\n                    <LogOut size={40} className=\"text-orange-200\" />\n                  </div>\n                </div>\n              ),\n              headerSettings.showViolations && (\n                <div key=\"violations\" className=\"bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-violations\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <p className=\"text-red-100 text-sm\">المخالفات</p>\n                      <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-violations\">{violationsCount}</p>\n                    </div>\n                    <AlertCircle size={40} className=\"text-red-200\" />\n                  </div>\n                </div>\n              ),\n            ].filter(Boolean)\n            \n            const cardCount = visibleCards.length\n            const gridCols = cardCount === 1 ? 'md:grid-cols-1' : cardCount === 2 ? 'md:grid-cols-2' : cardCount === 3 ? 'md:grid-cols-3' : cardCount === 4 ? 'md:grid-cols-4' : cardCount === 5 ? 'md:grid-cols-5' : 'md:grid-cols-6'\n            \n            return cardCount > 0 ? (\n              <div className={`grid grid-cols-1 ${gridCols} gap-4 mt-6`}>\n                {visibleCards}\n              </div>\n            ) : null\n          })()}\n        </div>\n      </header>\n\n      {/* Navigation Tabs */}\n      <div className=\"bg-gradient-to-r from-gray-50 to-white border-b-2 border-gray-100 shadow-md\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex gap-3 overflow-x-auto py-3 justify-center\">\n            {navItems.map((item) => {\n              const Icon = item.icon\n              const isActive = currentPage === item.id\n              \n              const getRingColor = () => {\n                if (item.id === 'home') return 'ring-blue-400'\n                if (item.id === 'teachers') return 'ring-green-400'\n                if (item.id === 'groups') return 'ring-teal-400'\n                if (item.id === 'special-status') return 'ring-pink-400'\n                if (item.id === 'reception') return 'ring-purple-400'\n                if (item.id === 'permission') return 'ring-orange-400'\n                if (item.id === 'absence') return 'ring-red-400'\n                return 'ring-blue-400'\n              }\n              \n              return (\n                <button\n                  key={item.id}\n                  onClick={() => setCurrentPage(item.id)}\n                  className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-300 whitespace-nowrap transform hover:scale-105 hover:shadow-xl ${\n                    isActive\n                      ? `${item.color} text-white shadow-xl scale-105 ring-4 ring-offset-2 ${getRingColor()}`\n                      : 'bg-white text-gray-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 border-2 border-gray-200 hover:border-blue-400 shadow-md'\n                  }`}\n                  data-testid={`nav-${item.id}`}\n                >\n                  <Icon size={18} className={isActive ? 'animate-pulse' : ''} />\n                  <span className=\"text-base font-bold\">{item.label}</span>\n                </button>\n              )\n            })}\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* صفحة المعلمين */}\n        {currentPage === 'teachers' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-6 shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n                    <GraduationCap className=\"text-white\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-white\">المعلمين</h2>\n                    <p className=\"text-blue-100 mt-1\">إجمالي المعلمين: {teachers.length}</p>\n                  </div>\n                </div>\n                <button\n                  onClick={() => setShowAddTeacherModal(true)}\n                  className=\"bg-white text-blue-600 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-50 transition-all shadow-md hover:shadow-lg\"\n                  data-testid=\"button-add-teacher\"\n                >\n                  <Plus size={20} />\n                  <span>إضافة معلم</span>\n                </button>\n              </div>\n            </div>\n\n            {/* قائمة المعلمين */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {teachers.map((teacher) => (\n                <div key={teacher.id} className=\"bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow\">\n                  {/* اسم المعلم */}\n                  <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 p-4 text-center\">\n                    <h3 className=\"text-2xl font-bold text-white\">{teacher.name}</h3>\n                  </div>\n\n                  {/* المعلومات */}\n                  <div className=\"p-4 space-y-3\">\n                    {/* الفصل الدراسي (التخصص) */}\n                    <div className=\"flex items-center gap-3 text-gray-700\">\n                      <BookOpen size={20} className=\"text-blue-600\" />\n                      <div>\n                        <p className=\"text-sm text-gray-500\">الفصل الدراسي</p>\n                        <p className=\"font-semibold\">{teacher.specialization || 'غير محدد'}</p>\n                      </div>\n                    </div>\n\n                    {/* رقم الجوال */}\n                    <div className=\"flex items-center gap-3 text-gray-700\">\n                      <Phone size={20} className=\"text-blue-600\" />\n                      <div>\n                        <p className=\"text-sm text-gray-500\">رقم الجوال</p>\n                        <p className=\"font-semibold\" dir=\"ltr\">{teacher.phone || 'غير محدد'}</p>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* الأزرار */}\n                  <div className=\"p-4 pt-0 flex gap-2\">\n                    <button\n                      onClick={() => {\n                        setSelectedTeacher(teacher)\n                        setTeacherFormData({\n                          name: teacher.name,\n                          phone: teacher.phone || '',\n                          specialization: teacher.specialization || '',\n                        })\n                        setShowEditTeacherModal(true)\n                      }}\n                      className=\"flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg font-semibold hover:bg-blue-100 transition-colors flex items-center justify-center gap-2\"\n                      data-testid={`button-edit-teacher-${teacher.id}`}\n                    >\n                      <Edit size={18} />\n                      <span>تعديل</span>\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (window.confirm(`هل أنت متأكد من حذف المعلم ${teacher.name}؟`)) {\n                          deleteTeacher.mutate(teacher.id)\n                        }\n                      }}\n                      disabled={deleteTeacher.isPending}\n                      className=\"flex-1 bg-red-50 text-red-600 py-2 rounded-lg font-semibold hover:bg-red-100 transition-colors flex items-center justify-center gap-2 disabled:opacity-50\"\n                      data-testid={`button-delete-teacher-${teacher.id}`}\n                    >\n                      <Trash2 size={18} />\n                      <span>{deleteTeacher.isPending ? 'جاري...' : 'حذف'}</span>\n                    </button>\n                  </div>\n                </div>\n              ))}\n            </div>\n\n            {/* حالة فارغة */}\n            {teachers.length === 0 && (\n              <div className=\"text-center py-16\">\n                <GraduationCap size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                <p className=\"text-xl text-gray-500 font-semibold\">لا يوجد معلمين</p>\n                <p className=\"text-gray-400 mt-2\">ابدأ بإضافة معلم جديد</p>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* صفحة الحالات الخاصة */}\n        {currentPage === 'special-status' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n                    <Heart className=\"text-white\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-white\">الحالات الخاصة</h2>\n                    <p className=\"text-purple-100 mt-1\">إجمالي الطلاب ذوي الحالات الخاصة: {specialStatusCount}</p>\n                  </div>\n                </div>\n                <div className=\"flex gap-3\">\n                  <div className=\"flex items-center gap-2 bg-white bg-opacity-20 px-4 py-2 rounded-lg\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"show-special-status-details\"\n                      checked={showSpecialStatusColumn}\n                      onChange={(e) => setShowSpecialStatusColumn(e.target.checked)}\n                      className=\"w-5 h-5\"\n                      data-testid=\"checkbox-show-special-status-details\"\n                    />\n                    <label htmlFor=\"show-special-status-details\" className=\"text-white font-semibold cursor-pointer whitespace-nowrap\">\n                      إظهار تفاصيل الحالة\n                    </label>\n                  </div>\n                  <button\n                    onClick={() => window.print()}\n                    className=\"bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-50 transition-all shadow-md\"\n                    data-testid=\"button-print-all-special\"\n                  >\n                    <Printer size={20} />\n                    <span>طباعة الكل</span>\n                  </button>\n                  <button\n                    onClick={() => setShowSendToTeacherModal(true)}\n                    className=\"bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-50 transition-all shadow-md\"\n                    data-testid=\"button-send-to-teacher\"\n                  >\n                    <Send size={20} />\n                    <span>إرسال للمعلم</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* قائمة المجموعات */}\n            <div className=\"space-y-4\">\n              {groups\n                .filter(group => {\n                  // عرض فقط المجموعات التي تحتوي على طلاب لديهم حالات خاصة\n                  const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                  return groupStudents.length > 0\n                })\n                .map((group) => {\n                  const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                  \n                  return (\n                    <div key={group.id} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                      {/* رأس المجموعة */}\n                      <div className=\"bg-gradient-to-r from-purple-500 to-purple-600 p-4 flex items-center justify-between text-white\">\n                        <div className=\"text-left\">\n                          <h3 className=\"text-2xl font-bold\">\n                            {group.stage} - {group.name}\n                          </h3>\n                          <p className=\"text-purple-100 mt-1\">عدد الطلاب: {groupStudents.length}</p>\n                        </div>\n                        <button\n                          onClick={() => {\n                            setSelectedGroupForSpecialPrint(group)\n                            setShowSpecialStatusPrintModal(true)\n                          }}\n                          className=\"bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-50 transition-all\"\n                          data-testid={`button-print-group-${group.id}`}\n                        >\n                          <Printer size={18} />\n                          <span>طباعة</span>\n                        </button>\n                      </div>\n\n                      {/* جدول الطلاب */}\n                      <div className=\"overflow-x-auto\">\n                        <table className=\"w-full\">\n                          <thead className=\"bg-purple-50\">\n                            <tr>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">الاسم</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">السجل المدني</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">جوال الطالب</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">جوال ولي الأمر</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">الحالة الخاصة</th>\n                            </tr>\n                          </thead>\n                          <tbody className=\"divide-y divide-gray-200\">\n                            {groupStudents.map((student) => {\n                              const specialStatus = specialStatuses.find(s => s.id === student.specialStatusId)\n                              return (\n                                <tr key={student.id} className=\"hover:bg-gray-50\">\n                                  <td className=\"px-6 py-4 text-right font-semibold text-gray-900\">{student.name}</td>\n                                  <td className=\"px-6 py-4 text-right text-gray-700\">{student.nationalId}</td>\n                                  <td className=\"px-6 py-4 text-right text-gray-700\" dir=\"ltr\">{student.phone || '-'}</td>\n                                  <td className=\"px-6 py-4 text-right text-gray-700\" dir=\"ltr\">{student.guardianPhone || '-'}</td>\n                                  <td className=\"px-6 py-4 text-right\">\n                                    <span className=\"bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold inline-block\">\n                                      {showSpecialStatusColumn ? (specialStatus?.name || 'غير محدد') : 'لديه حالة خاصة'}\n                                    </span>\n                                  </td>\n                                </tr>\n                              )\n                            })}\n                          </tbody>\n                        </table>\n                      </div>\n                    </div>\n                  )\n                })}\n\n              {/* حالة فارغة */}\n              {students.filter(s => s.specialStatusId).length === 0 && (\n                <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n                  <Heart size={64} className=\"mx-auto text-purple-300 mb-4\" />\n                  <p className=\"text-xl text-gray-500 font-semibold\">لا يوجد طلاب ذوي حالات خاصة</p>\n                  <p className=\"text-gray-400 mt-2\">يمكنك إضافة حالات خاصة من تعديل بيانات الطالب</p>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* صفحة المجموعات */}\n        {currentPage === 'groups' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"show-special-status\"\n                    checked={showSpecialStatusColumn}\n                    onChange={(e) => setShowSpecialStatusColumn(e.target.checked)}\n                    className=\"w-5 h-5 text-purple-600 border-purple-300 rounded focus:ring-purple-500\"\n                    data-testid=\"checkbox-show-special-status\"\n                  />\n                  <label htmlFor=\"show-special-status\" className=\"text-purple-600 font-semibold cursor-pointer\">\n                    إظهار تفاصيل الحالة\n                  </label>\n                </div>\n\n                <div className=\"flex gap-3\">\n                  <button\n                    onClick={() => {\n                      setEditStudentData({\n                        name: '',\n                        nationalId: '',\n                        phone: '',\n                        guardianPhone: '',\n                        grade: '',\n                        groupId: '',\n                        specialStatusId: '',\n                      })\n                      setSelectedStage('')\n                      setSelectedStudent(null)\n                      setShowEditStudentModal(true)\n                    }}\n                    className=\"bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg\"\n                    data-testid=\"button-add-student-page\"\n                  >\n                    <UserPlus size={20} />\n                    <span>إضافة طالب</span>\n                  </button>\n                  <button\n                    onClick={() => setShowGroupsModal(true)}\n                    className=\"bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg\"\n                    data-testid=\"button-manage-groups-page\"\n                  >\n                    <Users size={20} />\n                    <span>إدارة المجموعات</span>\n                  </button>\n                  <button\n                    onClick={() => window.print()}\n                    className=\"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg\"\n                    data-testid=\"button-print-all\"\n                  >\n                    <Printer size={20} />\n                    <span>طباعة الكل</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* قائمة المجموعات */}\n            <div className=\"space-y-4\">\n              {groups.length === 0 ? (\n                <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n                  <Users size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                  <p className=\"text-xl text-gray-500 font-semibold\">لا توجد مجموعات</p>\n                  <p className=\"text-gray-400 mt-2\">قم بإضافة مجموعات من الإعدادات</p>\n                </div>\n              ) : (\n                (() => {\n                  // تجميع المجموعات حسب المرحلة الدراسية\n                  const groupsByStage = groups.reduce((acc, group) => {\n                    if (!acc[group.stage]) {\n                      acc[group.stage] = []\n                    }\n                    acc[group.stage].push(group)\n                    return acc\n                  }, {} as Record<string, typeof groups>)\n\n                  // ترتيب المراحل من الأصغر للأكبر\n                  const stageOrder = [\n                    'الصف الأول الابتدائي',\n                    'الصف الثاني الابتدائي',\n                    'الصف الثالث الابتدائي',\n                    'الصف الرابع الابتدائي',\n                    'الصف الخامس الابتدائي',\n                    'الصف السادس الابتدائي',\n                    'الصف الأول المتوسط',\n                    'الصف الثاني المتوسط',\n                    'الصف الثالث المتوسط',\n                    'الصف الأول الثانوي',\n                    'الصف الثاني الثانوي',\n                    'الصف الثالث الثانوي',\n                  ]\n\n                  // ألوان مختلفة لكل مرحلة\n                  const stageColors = [\n                    'from-blue-600 to-blue-700',\n                    'from-green-600 to-emerald-700',\n                    'from-purple-600 to-violet-700',\n                    'from-orange-600 to-orange-700',\n                    'from-pink-600 to-rose-700',\n                    'from-teal-600 to-cyan-700',\n                    'from-red-600 to-rose-700',\n                    'from-indigo-600 to-purple-700',\n                    'from-yellow-600 to-amber-700',\n                    'from-lime-600 to-green-700',\n                    'from-sky-600 to-blue-700',\n                    'from-fuchsia-600 to-pink-700',\n                  ]\n\n                  const sortedStages = Object.keys(groupsByStage).sort((a, b) => {\n                    const indexA = stageOrder.indexOf(a)\n                    const indexB = stageOrder.indexOf(b)\n                    if (indexA === -1 && indexB === -1) return a.localeCompare(b)\n                    if (indexA === -1) return 1\n                    if (indexB === -1) return -1\n                    return indexA - indexB\n                  })\n\n                  return sortedStages.map((stage, stageIndex) => {\n                    const stageGroups = groupsByStage[stage]\n                    const isStageExpanded = expandedStages.has(stage)\n                    const stageStudentsCount = stageGroups.reduce((sum, group) => \n                      sum + students.filter(s => s.groupId === group.id).length, 0\n                    )\n                    const stageColorIndex = stageIndex % stageColors.length\n                    const stageColor = stageColors[stageColorIndex]\n\n                    return (\n                      <div key={stage} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                        {/* رأس المرحلة الدراسية */}\n                        <div className={`bg-gradient-to-r ${stageColor} p-5`}>\n                          <button\n                            onClick={() => toggleStage(stage)}\n                            className=\"w-full flex items-center justify-between text-white hover:opacity-90 transition-opacity\"\n                            data-testid={`button-toggle-stage-${stage}`}\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <ChevronDown \n                                size={28} \n                                className={`transform transition-transform ${isStageExpanded ? 'rotate-180' : ''}`}\n                              />\n                              <h2 className=\"text-2xl font-bold\">{stage}</h2>\n                              <span className=\"bg-white bg-opacity-30 px-4 py-1.5 rounded-full text-sm font-semibold\">\n                                {stageGroups.length} مجموعة - {stageStudentsCount} طالب\n                              </span>\n                            </div>\n                          </button>\n                        </div>\n\n                        {/* المجموعات داخل المرحلة */}\n                        {isStageExpanded && (\n                          <div className=\"p-4 space-y-3 bg-gray-50\">\n                            {stageGroups.map((group, groupIndex) => {\n                              const groupStudents = students.filter(s => s.groupId === group.id)\n                              const colorIndex = groupIndex % groupColors.length\n                              const colors = groupColors[colorIndex]\n                              const isExpanded = expandedGroupsPage.has(group.id)\n\n                              return (\n                                <div key={group.id} className=\"bg-white rounded-xl shadow-md overflow-hidden\">\n                                  {/* رأس المجموعة */}\n                                  <div className={`bg-gradient-to-r ${colors.bg} p-3 flex items-center justify-between text-white`}>\n                                    <button\n                                      onClick={() => toggleGroupPage(group.id)}\n                                      className=\"flex items-center gap-3 hover:opacity-90 transition-opacity\"\n                                      data-testid={`button-toggle-group-page-${group.id}`}\n                                    >\n                                      <ChevronDown \n                                        size={20} \n                                        className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n                                      />\n                                      <h3 className=\"text-xl font-bold\">\n                                        {group.name}\n                                      </h3>\n                                      <span className=\"bg-white bg-opacity-30 px-3 py-1 rounded-full text-sm font-semibold\">\n                                        {groupStudents.length} طالب\n                                      </span>\n                                    </button>\n                                  </div>\n\n                      {/* جدول الطلاب */}\n                      {isExpanded && (\n                        <div>\n                          {/* أزرار الإجراءات */}\n                          <div className=\"bg-gradient-to-r from-cyan-400 to-blue-500 p-3 flex gap-2 justify-end\">\n                            <button\n                              onClick={() => {\n                                setSelectedGroupForPrint(group)\n                                setShowGroupPrintModal(true)\n                              }}\n                              className=\"bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors flex items-center gap-2\"\n                              data-testid={`button-print-group-${group.id}`}\n                            >\n                              <Printer size={18} />\n                              <span>طباعة</span>\n                            </button>\n                          </div>\n\n                          {/* الجدول */}\n                          <div className=\"overflow-x-auto\">\n                            <table className=\"w-full\">\n                              <thead className=\"bg-gray-50\">\n                                <tr>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الاسم</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">السجل المدني</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال الطالب</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال ولي الأمر</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الحالة الخاصة</th>\n                                </tr>\n                              </thead>\n                              <tbody className=\"divide-y divide-gray-200\">\n                                {groupStudents.length === 0 ? (\n                                  <tr>\n                                    <td \n                                      colSpan={5}\n                                      className=\"px-4 py-8 text-center text-gray-500\"\n                                    >\n                                      لا يوجد طلاب في هذه المجموعة\n                                    </td>\n                                  </tr>\n                                ) : (\n                                  groupStudents.map((student) => {\n                                    const specialStatus = student.specialStatusId \n                                      ? specialStatuses.find(s => s.id === student.specialStatusId)\n                                      : null\n\n                                    return (\n                                      <tr key={student.id} className=\"hover:bg-gray-50\">\n                                        <td className=\"px-4 py-3 text-sm text-gray-900\">{student.name}</td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">{student.nationalId}</td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\" dir=\"ltr\">{student.phone || '-'}</td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\" dir=\"ltr\">{student.guardianPhone || '-'}</td>\n                                        <td className=\"px-4 py-3 text-sm\">\n                                          {specialStatus ? (\n                                            showSpecialStatusColumn ? (\n                                              <span className=\"bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-semibold\">\n                                                {specialStatus.name}\n                                              </span>\n                                            ) : (\n                                              <span className=\"bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-semibold\">\n                                                لديه حالة خاصة\n                                              </span>\n                                            )\n                                          ) : (\n                                            <span className=\"text-gray-400\">-</span>\n                                          )}\n                                        </td>\n                                      </tr>\n                                    )\n                                  })\n                                )}\n                              </tbody>\n                            </table>\n                          </div>\n                        </div>\n                      )}\n                                </div>\n                              )\n                            })}\n                          </div>\n                        )}\n                      </div>\n                    )\n                  })\n                })()\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* صفحة استقبال الطلاب */}\n        {currentPage === 'reception' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl p-6 shadow-sm\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-blue-200 bg-opacity-50 p-3 rounded-xl\">\n                    <UserCheck className=\"text-blue-700\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-blue-900\">استقبال الطلاب</h2>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* حقل البحث */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Search size={20} className=\"text-gray-600\" />\n                <h3 className=\"text-lg font-bold text-gray-800\">تسجيل زيارة</h3>\n              </div>\n              <div className=\"relative\">\n                <input\n                  type=\"text\"\n                  value={receptionSearchTerm}\n                  onChange={(e) => setReceptionSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-gray-200 focus:border-blue-400 focus:outline-none rounded-lg bg-gray-50\"\n                  data-testid=\"input-search-reception\"\n                />\n                \n                {/* نتائج البحث */}\n                {receptionSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(receptionSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(receptionSearchTerm)\n                      )\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedStudentForReception(student)\n                              setReceptionSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'}\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* معلومات الطالب المحدد */}\n            {selectedStudentForReception && (\n              <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl shadow-lg p-6\">\n                <h3 className=\"text-xl font-bold text-blue-900 mb-4 text-right\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-right\">\n                  <div>\n                    <span className=\"text-gray-700\">الاسم: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForReception.name}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">السجل المدني: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForReception.nationalId}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">الصف: </span>\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === selectedStudentForReception.groupId)?.stage || 'غير محدد'}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">عدد الزيارات السابقة: </span>\n                    <span className=\"font-bold text-blue-600\">{selectedStudentForReception.visitCount || 0}</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* نموذج تسجيل الزيارة */}\n            {selectedStudentForReception && (\n              <div className=\"bg-white rounded-xl shadow-lg p-4\">\n                <div className=\"space-y-3\">\n                  {/* سبب الزيارة / المشكلة */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      سبب الزيارة / المشكلة\n                    </label>\n                    <textarea\n                      value={visitReason}\n                      onChange={(e) => setVisitReason(e.target.value)}\n                      placeholder=\"اكتب سبب الزيارة أو وصف المشكلة...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none\"\n                      data-testid=\"textarea-visit-reason\"\n                    />\n                  </div>\n\n                  {/* الإجراء المتخذ */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      الإجراء المتخذ\n                    </label>\n                    <textarea\n                      value={actionTaken}\n                      onChange={(e) => setActionTaken(e.target.value)}\n                      placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none\"\n                      data-testid=\"textarea-action-taken\"\n                    />\n                  </div>\n\n                  {/* التحويل إلى */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      التحويل إلى\n                    </label>\n                    <select\n                      value={referredTo}\n                      onChange={(e) => setReferredTo(e.target.value)}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                      data-testid=\"select-referred-to\"\n                    >\n                      <option value=\"\">لا يوجد</option>\n                      <option value=\"المرشد الطلابي\">المرشد الطلابي</option>\n                      <option value=\"مدير المدرسة\">مدير المدرسة</option>\n                      <option value=\"ولي الأمر\">ولي الأمر</option>\n                      <option value=\"المعلم\">المعلم</option>\n                    </select>\n                  </div>\n\n                  {/* ملاحظات إضافية */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      ملاحظات إضافية (اختياري)\n                    </label>\n                    <textarea\n                      value={additionalNotes}\n                      onChange={(e) => setAdditionalNotes(e.target.value)}\n                      placeholder=\"ملاحظات إضافية...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none\"\n                      data-testid=\"textarea-additional-notes\"\n                    />\n                  </div>\n\n                  {/* أزرار الإلغاء والتسجيل */}\n                  <div className=\"flex gap-2 pt-1\">\n                    <button\n                      onClick={() => {\n                        setSelectedStudentForReception(null)\n                        setVisitReason('')\n                        setActionTaken('')\n                        setReferredTo('')\n                        setAdditionalNotes('')\n                      }}\n                      className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 rounded-lg transition-all text-sm\"\n                      data-testid=\"button-cancel-visit\"\n                    >\n                      إلغاء\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (!visitReason || !actionTaken) {\n                          alert('الرجاء تعبئة سبب الزيارة والإجراء المتخذ')\n                          return\n                        }\n                        \n                        const now = new Date()\n                        // حفظ التاريخ بالتوقيت المحلي بصيغة YYYY-MM-DD\n                        const localDate = now.toLocaleDateString('en-CA')\n                        \n                        addStudentVisit.mutate({\n                          studentId: selectedStudentForReception.id,\n                          visitDate: localDate,\n                          reason: visitReason,\n                          actionTaken: actionTaken,\n                          referredTo: referredTo || 'لا يوجد',\n                          notes: additionalNotes,\n                        })\n                      }}\n                      disabled={addStudentVisit.isPending}\n                      className=\"flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-2.5 rounded-lg transition-all shadow-md disabled:opacity-50 text-sm\"\n                      data-testid=\"button-submit-visit\"\n                    >\n                      {addStudentVisit.isPending ? 'جاري التسجيل...' : 'تسجيل الزيارة'}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* سجل الزيارات الأخيرة */}\n            <div className=\"bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <div className=\"flex items-center gap-3\">\n                  <List size={24} className=\"text-green-700\" />\n                  <h3 className=\"text-2xl font-bold text-green-900\">سجل الزيارات الأخيرة</h3>\n                </div>\n                <button \n                  onClick={() => {\n                    setShowDateFilterModal(true)\n                    setDateFilterError('')\n                  }}\n                  className=\"bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                  data-testid=\"button-filter-date\"\n                >\n                  <Clock size={18} />\n                  <span>فلتر بالتاريخ</span>\n                </button>\n              </div>\n\n              {/* فلتر حسب طالب محدد */}\n              <div className=\"mb-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 shadow-sm border-2 border-purple-200\">\n                <div className=\"flex items-center gap-3 mb-3\">\n                  <UserCheck size={20} className=\"text-purple-700\" />\n                  <h4 className=\"font-bold text-purple-900\">عرض زيارات طالب محدد</h4>\n                </div>\n                <div className=\"relative\">\n                  <input\n                    type=\"text\"\n                    placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                    value={studentSearchTerm}\n                    onChange={(e) => setStudentSearchTerm(e.target.value)}\n                    className=\"w-full p-3 pr-10 border-2 border-purple-300 rounded-lg text-right focus:border-purple-500 focus:outline-none bg-white\"\n                    data-testid=\"input-search-student\"\n                  />\n                  <Search size={20} className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-purple-400\" />\n                </div>\n                \n                {/* نتائج البحث */}\n                {studentSearchTerm && (\n                  <div className=\"mt-2 max-h-48 overflow-y-auto bg-white border-2 border-gray-200 rounded-lg\">\n                    {students\n                      .filter(s => \n                        s.name.includes(studentSearchTerm) || \n                        s.nationalId?.includes(studentSearchTerm)\n                      )\n                      .slice(0, 5)\n                      .map(student => (\n                        <button\n                          key={student.id}\n                          onClick={() => {\n                            setSelectedStudentFilter(student)\n                            setStudentSearchTerm('')\n                          }}\n                          className=\"w-full p-3 text-right hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-0\"\n                          data-testid={`student-search-result-${student.id}`}\n                        >\n                          <div className=\"font-bold text-gray-900\">{student.name}</div>\n                          {student.nationalId && (\n                            <div className=\"text-sm text-gray-600\">السجل: {student.nationalId}</div>\n                          )}\n                        </button>\n                      ))}\n                  </div>\n                )}\n                \n                {/* الطالب المحدد */}\n                {selectedStudentFilter && (\n                  <div className=\"mt-3 bg-blue-50 border-2 border-blue-300 rounded-lg p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"text-right\">\n                        <div className=\"font-bold text-blue-900 text-lg\">{selectedStudentFilter.name}</div>\n                        <div className=\"text-sm text-blue-700\">\n                          عرض {studentVisits.filter((v: any) => v.studentId === selectedStudentFilter.id).length} زيارة\n                        </div>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <button\n                          onClick={() => {\n                            setSelectedStudentForReception(selectedStudentFilter)\n                            setVisitReason('')\n                            setActionTaken('')\n                            setReferredTo('')\n                            setAdditionalNotes('')\n                          }}\n                          className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2\"\n                          data-testid=\"button-add-visit-for-student\"\n                        >\n                          <PlusCircle size={18} />\n                          <span>تسجيل زيارة جديدة</span>\n                        </button>\n                        <button\n                          onClick={() => setSelectedStudentFilter(null)}\n                          className=\"bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold\"\n                          data-testid=\"button-clear-student-filter\"\n                        >\n                          <X size={18} />\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* قائمة الزيارات */}\n              {(() => {\n                let filteredVisits = studentVisits\n                \n                // فلترة حسب الطالب المحدد\n                if (selectedStudentFilter) {\n                  filteredVisits = filteredVisits.filter((v: any) => v.studentId === selectedStudentFilter.id)\n                }\n                \n                // فلترة حسب التاريخ\n                if (filterDate) {\n                  filteredVisits = filteredVisits.filter((v: any) => v.visitDate === filterDate)\n                }\n                \n                if (filteredVisits.length === 0) {\n                  return (\n                    <div className=\"bg-white rounded-xl p-8 text-center\">\n                      <List size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                      <p className=\"text-xl text-gray-500 font-semibold\">\n                        {selectedStudentFilter && filterDate ? 'لا توجد زيارات للطالب في هذا التاريخ' :\n                         selectedStudentFilter ? 'لا توجد زيارات لهذا الطالب' :\n                         filterDate ? 'لا توجد زيارات في هذا التاريخ' : \n                         'لا توجد زيارات'}\n                      </p>\n                      <div className=\"flex gap-2 justify-center mt-4\">\n                        {filterDate && (\n                          <button\n                            onClick={() => setFilterDate('')}\n                            className=\"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-bold\"\n                            data-testid=\"button-clear-date-filter-empty\"\n                          >\n                            إلغاء فلتر التاريخ\n                          </button>\n                        )}\n                        {selectedStudentFilter && (\n                          <button\n                            onClick={() => setSelectedStudentFilter(null)}\n                            className=\"bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold\"\n                            data-testid=\"button-clear-student-filter-empty\"\n                          >\n                            إلغاء فلتر الطالب\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  )\n                }\n                \n                return (\n                  <div className=\"space-y-4\">\n                    {/* بانر فلتر الطالب */}\n                    {selectedStudentFilter && (\n                      <div className=\"bg-purple-50 border-2 border-purple-300 rounded-lg p-4 flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <UserCheck size={20} className=\"text-purple-600\" />\n                          <span className=\"font-bold text-purple-900\">عرض زيارات الطالب: {selectedStudentFilter.name}</span>\n                        </div>\n                        <button\n                          onClick={() => setSelectedStudentFilter(null)}\n                          className=\"bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2\"\n                          data-testid=\"button-clear-student-filter-banner\"\n                        >\n                          <X size={16} />\n                          <span>إلغاء</span>\n                        </button>\n                      </div>\n                    )}\n                    \n                    {/* بانر فلتر التاريخ */}\n                    {filterDate && (\n                      <div className=\"bg-blue-50 border-2 border-blue-300 rounded-lg p-4 flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <Clock size={20} className=\"text-blue-600\" />\n                          <span className=\"font-bold text-blue-900\">عرض زيارات تاريخ: {filterDate}</span>\n                        </div>\n                        <button\n                          onClick={() => setFilterDate('')}\n                          className=\"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2\"\n                          data-testid=\"button-clear-date-filter-banner\"\n                        >\n                          <X size={16} />\n                          <span>إلغاء</span>\n                        </button>\n                      </div>\n                    )}\n                    {filteredVisits.slice().reverse().map((visit: any) => {\n                    const student = students.find(s => s.id === visit.studentId)\n                    if (!student) return null\n                    \n                    const visitTime = new Date(visit.createdAt).toLocaleTimeString('ar-SA', {\n                      hour: '2-digit',\n                      minute: '2-digit',\n                      hour12: true\n                    })\n                    \n                    return (\n                      <div key={visit.id} className=\"bg-white rounded-xl p-6 shadow-md\" data-testid={`visit-card-${visit.id}`}>\n                        <div className=\"flex items-start justify-between mb-4\">\n                          <div className=\"flex-1\">\n                            <h4 className=\"text-xl font-bold text-gray-900 mb-2\">{student.name}</h4>\n                            <div className=\"flex items-center gap-4 text-sm text-gray-600\">\n                              <span>{visit.visitDate} هـ</span>\n                              <span>{visitTime}</span>\n                            </div>\n                          </div>\n                          <div className=\"flex gap-2\">\n                            {/* زر حذف */}\n                            <button\n                              onClick={() => {\n                                if (window.confirm('هل أنت متأكد من حذف هذه الزيارة؟')) {\n                                  deleteStudentVisit.mutate(visit.id)\n                                }\n                              }}\n                              disabled={deleteStudentVisit.isPending}\n                              className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors disabled:opacity-50\"\n                              data-testid={`button-delete-visit-${visit.id}`}\n                            >\n                              <Trash2 size={16} />\n                              <span>حذف</span>\n                            </button>\n                            \n                            {/* زر واتساب */}\n                            <button\n                              onClick={() => {\n                                const message = `\nزيارة طالب - ${student.name}\nالتاريخ: ${visit.visitDate}\nالوقت: ${visitTime}\n\nالسبب: ${visit.reason}\nالإجراء: ${visit.actionTaken}\n${visit.referredTo !== 'لا يوجد' ? `التحويل إلى: ${visit.referredTo}` : ''}\n${visit.notes ? `ملاحظات: ${visit.notes}` : ''}\n\n${profile?.name || 'مسؤول النظام'}\n                                `.trim()\n                                \n                                const phone = formatPhoneForWhatsApp(student.guardianPhone)\n                                if (phone) {\n                                  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank')\n                                } else {\n                                  alert('لا يوجد رقم جوال لولي الأمر')\n                                }\n                              }}\n                              className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                              data-testid={`button-whatsapp-${visit.id}`}\n                            >\n                              <Phone size={16} />\n                              <span>واتساب</span>\n                            </button>\n                            \n                            {/* زر طباعة */}\n                            <button\n                              onClick={() => {\n                                const printContent = `\n                                  <div dir=\"rtl\" style=\"font-family: Arial; padding: 20px;\">\n                                    <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px;\">\n                                      <h1 style=\"color: #3b82f6; font-size: 24px; margin-bottom: 5px;\">${profile?.schoolName || 'المدرسة'}</h1>\n                                      <p style=\"color: #666; font-size: 16px; margin: 5px 0;\">المعلم: ${profile?.name || 'غير محدد'}</p>\n                                      <h2 style=\"color: #333; font-size: 20px; margin-top: 15px;\">تقرير زيارة طالب</h2>\n                                    </div>\n                                    <table style=\"width: 100%; border-collapse: collapse;\">\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">اسم الطالب</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${student.name}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">التاريخ</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.visitDate} هـ</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">الوقت</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visitTime}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">السبب</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.reason}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">الإجراء المتخذ</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.actionTaken}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">التحويل إلى</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.referredTo}</td>\n                                      </tr>\n                                      ${visit.notes ? `<tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">ملاحظات</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.notes}</td>\n                                      </tr>` : ''}\n                                    </table>\n                                    <div style=\"margin-top: 30px; text-align: center; color: #999; font-size: 12px;\">\n                                      <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>\n                                    </div>\n                                  </div>\n                                `\n                                const printWindow = window.open('', '', 'width=800,height=600')\n                                if (printWindow) {\n                                  printWindow.document.write(printContent)\n                                  printWindow.document.close()\n                                  printWindow.print()\n                                }\n                              }}\n                              className=\"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                              data-testid={`button-print-${visit.id}`}\n                            >\n                              <Printer size={16} />\n                              <span>طباعة</span>\n                            </button>\n                          </div>\n                        </div>\n                        \n                        <div className=\"space-y-2 text-right\">\n                          <div className=\"bg-gray-50 p-3 rounded-lg\">\n                            <span className=\"text-sm font-bold text-gray-700\">السبب: </span>\n                            <span className=\"text-gray-900\">{visit.reason}</span>\n                          </div>\n                          <div className=\"bg-gray-50 p-3 rounded-lg\">\n                            <span className=\"text-sm font-bold text-gray-700\">الإجراء: </span>\n                            <span className=\"text-gray-900\">{visit.actionTaken}</span>\n                          </div>\n                          {visit.referredTo !== 'لا يوجد' && (\n                            <div className=\"bg-blue-50 p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-blue-700\">التحويل إلى: </span>\n                              <span className=\"text-blue-900\">{visit.referredTo}</span>\n                            </div>\n                          )}\n                          {visit.notes && (\n                            <div className=\"bg-yellow-50 p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-yellow-700\">ملاحظات: </span>\n                              <span className=\"text-yellow-900\">{visit.notes}</span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )\n                  })}\n                  </div>\n                )\n              })()}\n            </div>\n          </div>\n        )}\n\n        {/* صفحة الاستئذان */}\n        {currentPage === 'permission' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-orange-50 to-orange-100 rounded-2xl p-6 shadow-sm\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-orange-200 bg-opacity-50 p-3 rounded-xl\">\n                    <LogOut className=\"text-orange-700\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-orange-900\">الاستئذان</h2>\n                    <p className=\"text-orange-700 mt-1\">إدارة خروج الطلاب والاستئذان</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* حقل البحث */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Search size={20} className=\"text-gray-600\" />\n                <h3 className=\"text-lg font-bold text-gray-800\">تسجيل استئذان</h3>\n              </div>\n              <div className=\"relative\">\n                <input\n                  type=\"text\"\n                  value={permissionSearchTerm}\n                  onChange={(e) => setPermissionSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-gray-200 focus:border-orange-400 focus:outline-none rounded-lg bg-gray-50\"\n                  data-testid=\"input-search-permission\"\n                />\n                \n                {/* نتائج البحث */}\n                {permissionSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(permissionSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(permissionSearchTerm)\n                      )\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedStudentForPermission(student)\n                              setPermissionSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-orange-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-permission-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'}\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* معلومات الطالب المحدد */}\n            {selectedStudentForPermission && (\n              <div className=\"bg-gradient-to-r from-orange-50 to-orange-100 rounded-2xl shadow-lg p-6\">\n                <h3 className=\"text-xl font-bold text-orange-900 mb-4 text-right\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-right\">\n                  <div>\n                    <span className=\"text-gray-700\">الاسم: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForPermission.name}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">السجل المدني: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForPermission.nationalId}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">الصف: </span>\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === selectedStudentForPermission.groupId)?.stage || 'غير محدد'}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">عدد الاستئذانات السابقة: </span>\n                    <span className=\"font-bold text-orange-600\">{selectedStudentForPermission.permissionCount || 0}</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* نموذج تسجيل الاستئذان */}\n            {selectedStudentForPermission && (\n              <div className=\"bg-white rounded-xl shadow-lg p-4\">\n                <h3 className=\"text-base font-bold text-orange-900 mb-3 text-right\">تفاصيل الاستئذان</h3>\n                <div className=\"space-y-3\">\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">سبب الاستئذان</label>\n                    <input\n                      type=\"text\"\n                      value={permissionReason}\n                      onChange={(e) => setPermissionReason(e.target.value)}\n                      placeholder=\"مثال: موعد طبي، ظرف عائلي...\"\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-right\"\n                      data-testid=\"input-permission-reason\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">ملاحظات (اختياري)</label>\n                    <textarea\n                      value={permissionNotes}\n                      onChange={(e) => setPermissionNotes(e.target.value)}\n                      placeholder=\"أي ملاحظات إضافية...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-right resize-none\"\n                      data-testid=\"textarea-permission-notes\"\n                    />\n                  </div>\n\n                  {/* رسالة خطأ */}\n                  {permissionError && (\n                    <div className=\"bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg text-right text-sm\" data-testid=\"error-permission\">\n                      {permissionError}\n                    </div>\n                  )}\n\n                  <div className=\"flex gap-2 pt-1\">\n                    <button\n                      onClick={() => {\n                        setSelectedStudentForPermission(null)\n                        setPermissionReason('')\n                        setPermissionNotes('')\n                        setPermissionError('')\n                      }}\n                      className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 rounded-lg transition-all text-sm\"\n                      data-testid=\"button-cancel-permission\"\n                    >\n                      إلغاء\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (!permissionReason || !permissionReason.trim()) {\n                          setPermissionError('الرجاء تعبئة سبب الاستئذان')\n                          return\n                        }\n                        setPermissionError('')\n                        \n                        // تخزين التاريخ بالتوقيت المحلي بصيغة YYYY-MM-DD\n                        const today = new Date()\n                        const permissionDate = today.toLocaleDateString('en-CA')\n                        \n                        // أخذ الوقت الحالي تلقائياً\n                        const currentTime = today.toLocaleTimeString('ar-SA', { \n                          hour: '2-digit', \n                          minute: '2-digit',\n                          hour12: false \n                        })\n                        \n                        addStudentPermission.mutate({\n                          studentId: selectedStudentForPermission.id,\n                          reason: permissionReason,\n                          exitTime: currentTime,\n                          notes: permissionNotes || null,\n                          permissionDate: permissionDate\n                        })\n                      }}\n                      disabled={addStudentPermission.isPending}\n                      className=\"flex-1 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-bold py-2.5 rounded-lg transition-all shadow-md disabled:opacity-50 text-sm\"\n                      data-testid=\"button-submit-permission\"\n                    >\n                      {addStudentPermission.isPending ? 'جاري التسجيل...' : 'تسجيل الاستئذان'}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* عرض استئذانات طالب محدد */}\n            <div className=\"bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <div className=\"flex items-center gap-3\">\n                  <UserSearch size={24} className=\"text-purple-700\" />\n                  <h3 className=\"text-2xl font-bold text-purple-900\">عرض استئذانات طالب محدد</h3>\n                </div>\n                <button\n                  onClick={() => setShowPermissionDateFilter(true)}\n                  className=\"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                  data-testid=\"button-filter-permission-date\"\n                >\n                  <Calendar size={18} />\n                  <span>فلتر بالتاريخ</span>\n                </button>\n              </div>\n\n              {/* حقل البحث */}\n              <div className=\"relative mb-4\">\n                <input\n                  type=\"text\"\n                  value={permissionStudentSearchTerm}\n                  onChange={(e) => setPermissionStudentSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-purple-300 focus:border-purple-500 focus:outline-none rounded-lg bg-white\"\n                  data-testid=\"input-search-permission-student-filter\"\n                />\n                \n                {/* نتائج البحث */}\n                {permissionStudentSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-purple-300 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(permissionStudentSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(permissionStudentSearchTerm)\n                      )\n                      .slice(0, 5)\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedPermissionStudentFilter(student)\n                              setPermissionStudentSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-permission-filter-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'} • {student.permissionCount || 0} استئذان\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n\n              {/* بانر الطالب المحدد */}\n              {selectedPermissionStudentFilter && (\n                <div className=\"bg-purple-200 border-2 border-purple-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-right flex-1\">\n                      <div className=\"text-purple-900 font-bold text-lg mb-1\">\n                        عرض استئذانات: {selectedPermissionStudentFilter.name}\n                      </div>\n                      <div className=\"text-purple-700 text-sm\">\n                        عدد الاستئذانات: {selectedPermissionStudentFilter.permissionCount || 0}\n                      </div>\n                    </div>\n                    <button\n                      onClick={() => setSelectedPermissionStudentFilter(null)}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-permission-student-filter\"\n                    >\n                      إلغاء التصفية\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* بانر فلتر التاريخ */}\n              {permissionFilterDate && (\n                <div className=\"bg-blue-100 border-2 border-blue-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-blue-900 font-bold\">\n                      التاريخ: {new Date(permissionFilterDate).toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })}\n                    </div>\n                    <button\n                      onClick={() => setPermissionFilterDate('')}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-permission-date-filter\"\n                    >\n                      إلغاء فلتر التاريخ\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* سجل الاستئذانات */}\n              <div className=\"bg-white rounded-xl p-4\">\n                {isLoadingPermissions ? (\n                  <div className=\"text-center py-12\">\n                    <div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto mb-4\"></div>\n                    <p className=\"text-lg text-gray-600 font-semibold\">جاري تحميل الاستئذانات...</p>\n                  </div>\n                ) : (() => {\n                  let filteredPermissions = [...studentPermissions]\n                  \n                  // فلتر حسب الطالب المحدد\n                  if (selectedPermissionStudentFilter) {\n                    filteredPermissions = filteredPermissions.filter((p: any) => \n                      p.studentId === selectedPermissionStudentFilter.id\n                    )\n                  }\n                  \n                  // فلتر حسب التاريخ (المقارنة بصيغة ISO الميلادية)\n                  if (permissionFilterDate) {\n                    filteredPermissions = filteredPermissions.filter((p: any) => \n                      p.permissionDate === permissionFilterDate\n                    )\n                  }\n                  \n                  if (filteredPermissions.length === 0) {\n                    return (\n                      <div className=\"text-center py-12\">\n                        <LogOut size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                        <p className=\"text-xl text-gray-500 font-semibold\">لا توجد استئذانات</p>\n                        <p className=\"text-gray-400 mt-2\">\n                          {selectedPermissionStudentFilter || permissionFilterDate \n                            ? 'جرب فلاتر أخرى' \n                            : 'سيتم عرض الاستئذانات هنا بعد تسجيلها'}\n                        </p>\n                      </div>\n                    )\n                  }\n                  \n                  return (\n                    <div className=\"space-y-3\">\n                    {filteredPermissions.sort((a: any, b: any) => \n                      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                    ).map((permission: any) => {\n                      const student = students.find((s: Student) => s.id === permission.studentId)\n                      if (!student) return null\n                      \n                      // تحويل التاريخ الميلادي إلى هجري للعرض\n                      const permissionDateObj = new Date(permission.permissionDate)\n                      const hijriDate = permissionDateObj.toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })\n                      \n                      return (\n                        <div key={permission.id} className=\"bg-orange-50 border-2 border-orange-200 rounded-lg p-4\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div className=\"text-right flex-1\">\n                              <div className=\"font-bold text-lg text-gray-900\">{student.name}</div>\n                              <div className=\"text-sm text-gray-600 mt-1\">\n                                {hijriDate} • {permission.exitTime || 'لم يحدد الوقت'}\n                              </div>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => {\n                                  if (confirm('هل أنت متأكد من حذف هذا الاستئذان؟')) {\n                                    // TODO: Add delete mutation\n                                    alert('سيتم إضافة وظيفة الحذف قريباً')\n                                  }\n                                }}\n                                className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-delete-permission-${permission.id}`}\n                              >\n                                <span>🗑️</span>\n                                <span>حذف</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  if (!student.guardianPhone) {\n                                    alert('رقم جوال ولي الأمر غير مسجل')\n                                    return\n                                  }\n                                  \n                                  const phone = formatPhoneForWhatsApp(student.guardianPhone)\n                                  if (!phone) {\n                                    alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n                                    return\n                                  }\n                                  \n                                  const text = `استئذان: ${student.name}\\nالتاريخ: ${hijriDate}\\nالسبب: ${permission.reason}\\nالوقت: ${permission.exitTime || 'لم يحدد'}\\n\\n${profile?.name || 'مسؤول النظام'}`\n                                  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank')\n                                }}\n                                className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-whatsapp-permission-${permission.id}`}\n                              >\n                                <span>📱</span>\n                                <span>واتساب</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  const printContent = `\n                                    <div class=\"print-content\" style=\"padding: 40px; font-family: Arial, sans-serif; direction: rtl;\">\n                                      <div style=\"text-align: center; margin-bottom: 40px; border-bottom: 3px solid #000; padding-bottom: 20px;\">\n                                        <h1 style=\"font-size: 28px; margin-bottom: 10px; font-weight: bold;\">${profile?.schoolName || 'المدرسة'}</h1>\n                                        <p style=\"font-size: 18px; color: #555;\">المعلم: ${profile?.name || 'غير محدد'}</p>\n                                      </div>\n                                      \n                                      <div style=\"margin-bottom: 30px;\">\n                                        <h2 style=\"font-size: 24px; text-align: center; background-color: #f97316; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px;\">استئذان طالب</h2>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fff3e0; padding: 25px; border-radius: 8px; border: 2px solid #f97316; margin-bottom: 20px;\">\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">اسم الطالب:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.name}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">السجل المدني:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.nationalId}</p>\n                                          </div>\n                                        </div>\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">التاريخ:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${hijriDate}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">وقت الخروج:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${permission.exitTime || 'لم يحدد'}</p>\n                                          </div>\n                                        </div>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fef3c7; padding: 20px; border-radius: 8px; border-right: 4px solid #f59e0b; margin-bottom: 20px;\">\n                                        <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">سبب الاستئذان:</p>\n                                        <p style=\"font-size: 18px; line-height: 1.6;\">${permission.reason}</p>\n                                      </div>\n                                      \n                                      ${permission.notes ? `\n                                        <div style=\"background-color: #e0f2fe; padding: 20px; border-radius: 8px; border-right: 4px solid #0ea5e9; margin-bottom: 30px;\">\n                                          <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">ملاحظات:</p>\n                                          <p style=\"font-size: 18px; line-height: 1.6;\">${permission.notes}</p>\n                                        </div>\n                                      ` : ''}\n                                      \n                                      <div style=\"margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;\">\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع المعلم</p>\n                                        </div>\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع ولي الأمر</p>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  `\n                                  const printWindow = window.open('', '', 'height=600,width=800')\n                                  printWindow.document.write('<html><head><title>طباعة استئذان</title>')\n                                  printWindow.document.write('</head><body>')\n                                  printWindow.document.write(printContent)\n                                  printWindow.document.write('</body></html>')\n                                  printWindow.document.close()\n                                  printWindow.print()\n                                }}\n                                className=\"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-print-permission-${permission.id}`}\n                              >\n                                <span>🖨️</span>\n                                <span>طباعة</span>\n                              </button>\n                            </div>\n                          </div>\n                          \n                          <div className=\"space-y-2 text-right\">\n                            <div className=\"bg-white p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-gray-700\">السبب: </span>\n                              <span className=\"text-gray-900\">{permission.reason}</span>\n                            </div>\n                            {permission.notes && (\n                              <div className=\"bg-yellow-50 p-3 rounded-lg\">\n                                <span className=\"text-sm font-bold text-yellow-700\">ملاحظات: </span>\n                                <span className=\"text-yellow-900\">{permission.notes}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      )\n                    })}\n                    </div>\n                  )\n                })()}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* صفحة المخالفات */}\n        {currentPage === 'absence' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-red-50 to-red-100 rounded-2xl p-6 shadow-sm\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-red-200 bg-opacity-50 p-3 rounded-xl\">\n                    <AlertCircle className=\"text-red-700\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-red-900\">المخالفات</h2>\n                    <p className=\"text-red-700 mt-1\">تسجيل ومتابعة مخالفات الطلاب</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* حقل البحث */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Search size={20} className=\"text-gray-600\" />\n                <h3 className=\"text-lg font-bold text-gray-800\">تسجيل مخالفة</h3>\n              </div>\n              <div className=\"relative\">\n                <input\n                  type=\"text\"\n                  value={violationSearchTerm}\n                  onChange={(e) => setViolationSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-gray-200 focus:border-red-400 focus:outline-none rounded-lg bg-gray-50\"\n                  data-testid=\"input-search-violation\"\n                />\n                \n                {/* نتائج البحث */}\n                {violationSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(violationSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(violationSearchTerm)\n                      )\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedStudentForViolation(student)\n                              setViolationSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-red-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-violation-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'}\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* معلومات الطالب المحدد */}\n            {selectedStudentForViolation && (\n              <div className=\"bg-gradient-to-r from-red-50 to-red-100 rounded-2xl shadow-lg p-6\">\n                <h3 className=\"text-xl font-bold text-red-900 mb-4 text-right\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-right\">\n                  <div>\n                    <span className=\"text-gray-700\">الاسم: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForViolation.name}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">السجل المدني: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForViolation.nationalId}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">الصف: </span>\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === selectedStudentForViolation.groupId)?.stage || 'غير محدد'}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">عدد المخالفات السابقة: </span>\n                    <span className=\"font-bold text-red-600\">{selectedStudentForViolation.violationCount || 0}</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* نموذج تسجيل المخالفة */}\n            {selectedStudentForViolation && (\n              <div className=\"bg-white rounded-xl shadow-lg p-4\">\n                <h3 className=\"text-base font-bold text-red-900 mb-3 text-right\">تفاصيل المخالفة</h3>\n                <div className=\"space-y-3\">\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">نوع المخالفة</label>\n                    <select\n                      value={violationType}\n                      onChange={(e) => setViolationType(e.target.value)}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right\"\n                      data-testid=\"select-violation-type\"\n                    >\n                      <option value=\"\">اختر نوع المخالفة</option>\n                      <option value=\"تأخر\">تأخر عن الطابور</option>\n                      <option value=\"غياب\">غياب بدون عذر</option>\n                      <option value=\"سلوك\">سلوك غير لائق</option>\n                      <option value=\"واجب\">عدم حل الواجب</option>\n                      <option value=\"زي\">مخالفة الزي المدرسي</option>\n                      <option value=\"أخرى\">أخرى</option>\n                    </select>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">وصف المخالفة</label>\n                    <textarea\n                      value={violationDescription}\n                      onChange={(e) => setViolationDescription(e.target.value)}\n                      placeholder=\"اكتب تفاصيل المخالفة...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right resize-none\"\n                      data-testid=\"textarea-violation-description\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">الإجراء المتخذ</label>\n                    <select\n                      value={violationAction}\n                      onChange={(e) => setViolationAction(e.target.value)}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right\"\n                      data-testid=\"select-violation-action\"\n                    >\n                      <option value=\"\">اختر الإجراء</option>\n                      <option value=\"إنذار شفهي\">إنذار شفهي</option>\n                      <option value=\"إنذار كتابي\">إنذار كتابي</option>\n                      <option value=\"استدعاء ولي الأمر\">استدعاء ولي الأمر</option>\n                      <option value=\"حسم درجات\">حسم درجات السلوك</option>\n                      <option value=\"أخرى\">أخرى</option>\n                    </select>\n                  </div>\n\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">ملاحظات (اختياري)</label>\n                    <textarea\n                      value={violationNotes}\n                      onChange={(e) => setViolationNotes(e.target.value)}\n                      placeholder=\"أي ملاحظات إضافية...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right resize-none\"\n                      data-testid=\"textarea-violation-notes\"\n                    />\n                  </div>\n\n                  {/* رسالة خطأ */}\n                  {violationError && (\n                    <div className=\"bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg text-right text-sm\" data-testid=\"error-violation\">\n                      {violationError}\n                    </div>\n                  )}\n\n                  <div className=\"flex gap-2 pt-1\">\n                    <button\n                      onClick={() => {\n                        setSelectedStudentForViolation(null)\n                        setViolationType('')\n                        setViolationDescription('')\n                        setViolationAction('')\n                        setViolationNotes('')\n                        setViolationError('')\n                      }}\n                      className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 rounded-lg transition-all text-sm\"\n                      data-testid=\"button-cancel-violation\"\n                    >\n                      إلغاء\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (!violationType || !violationDescription.trim() || !violationAction) {\n                          setViolationError('الرجاء تعبئة جميع الحقول المطلوبة (نوع المخالفة، الوصف، والإجراء)')\n                          return\n                        }\n                        setViolationError('')\n                        \n                        // تخزين التاريخ بالتوقيت المحلي بصيغة YYYY-MM-DD\n                        const today = new Date()\n                        const violationDate = today.toLocaleDateString('en-CA')\n                        \n                        addStudentViolation.mutate({\n                          studentId: selectedStudentForViolation.id,\n                          violationType: violationType,\n                          description: violationDescription,\n                          actionTaken: violationAction,\n                          notes: violationNotes || null,\n                          violationDate: violationDate\n                        })\n                      }}\n                      disabled={addStudentViolation.isPending}\n                      className=\"flex-1 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-2.5 rounded-lg transition-all shadow-md disabled:opacity-50 text-sm\"\n                      data-testid=\"button-submit-violation\"\n                    >\n                      {addStudentViolation.isPending ? 'جاري التسجيل...' : 'تسجيل المخالفة'}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* عرض مخالفات طالب محدد */}\n            <div className=\"bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <div className=\"flex items-center gap-3\">\n                  <UserSearch size={24} className=\"text-purple-700\" />\n                  <h3 className=\"text-2xl font-bold text-purple-900\">عرض مخالفات طالب محدد</h3>\n                </div>\n                <button\n                  onClick={() => setShowViolationDateFilter(true)}\n                  className=\"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                  data-testid=\"button-filter-violation-date\"\n                >\n                  <Calendar size={18} />\n                  <span>فلتر بالتاريخ</span>\n                </button>\n              </div>\n\n              {/* حقل البحث */}\n              <div className=\"relative mb-4\">\n                <input\n                  type=\"text\"\n                  value={violationStudentSearchTerm}\n                  onChange={(e) => setViolationStudentSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-purple-300 focus:border-purple-500 focus:outline-none rounded-lg bg-white\"\n                  data-testid=\"input-search-violation-student-filter\"\n                />\n                \n                {/* نتائج البحث */}\n                {violationStudentSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-purple-300 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(violationStudentSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(violationStudentSearchTerm)\n                      )\n                      .slice(0, 5)\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedViolationStudentFilter(student)\n                              setViolationStudentSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-violation-filter-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'} • {student.violationCount || 0} مخالفة\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n\n              {/* بانر الطالب المحدد */}\n              {selectedViolationStudentFilter && (\n                <div className=\"bg-purple-200 border-2 border-purple-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-right flex-1\">\n                      <div className=\"text-purple-900 font-bold text-lg mb-1\">\n                        عرض مخالفات: {selectedViolationStudentFilter.name}\n                      </div>\n                      <div className=\"text-purple-700 text-sm\">\n                        عدد المخالفات: {selectedViolationStudentFilter.violationCount || 0}\n                      </div>\n                    </div>\n                    <button\n                      onClick={() => setSelectedViolationStudentFilter(null)}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-violation-student-filter\"\n                    >\n                      إلغاء التصفية\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* بانر فلتر التاريخ */}\n              {violationFilterDate && (\n                <div className=\"bg-blue-100 border-2 border-blue-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-blue-900 font-bold\">\n                      التاريخ: {new Date(violationFilterDate).toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })}\n                    </div>\n                    <button\n                      onClick={() => setViolationFilterDate('')}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-violation-date-filter\"\n                    >\n                      إلغاء فلتر التاريخ\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* سجل المخالفات */}\n              <div className=\"bg-white rounded-xl p-4\">\n                {isLoadingViolations ? (\n                  <div className=\"text-center py-12\">\n                    <div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-red-600 mx-auto mb-4\"></div>\n                    <p className=\"text-lg text-gray-600 font-semibold\">جاري تحميل المخالفات...</p>\n                  </div>\n                ) : (() => {\n                  let filteredViolations = [...studentViolations]\n                  \n                  // فلتر حسب الطالب المحدد\n                  if (selectedViolationStudentFilter) {\n                    filteredViolations = filteredViolations.filter((v: any) => \n                      v.studentId === selectedViolationStudentFilter.id\n                    )\n                  }\n                  \n                  // فلتر حسب التاريخ (المقارنة بصيغة ISO الميلادية)\n                  if (violationFilterDate) {\n                    filteredViolations = filteredViolations.filter((v: any) => \n                      v.violationDate === violationFilterDate\n                    )\n                  }\n                  \n                  if (filteredViolations.length === 0) {\n                    return (\n                      <div className=\"text-center py-12\">\n                        <AlertCircle size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                        <p className=\"text-xl text-gray-500 font-semibold\">لا توجد مخالفات</p>\n                        <p className=\"text-gray-400 mt-2\">\n                          {selectedViolationStudentFilter || violationFilterDate \n                            ? 'جرب فلاتر أخرى' \n                            : 'سيتم عرض المخالفات هنا بعد تسجيلها'}\n                        </p>\n                      </div>\n                    )\n                  }\n                  \n                  return (\n                    <div className=\"space-y-3\">\n                    {filteredViolations.sort((a: any, b: any) => \n                      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                    ).map((violation: any) => {\n                      const student = students.find((s: Student) => s.id === violation.studentId)\n                      if (!student) return null\n                      \n                      // تحويل التاريخ الميلادي إلى هجري للعرض\n                      const violationDateObj = new Date(violation.violationDate)\n                      const hijriDate = violationDateObj.toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })\n                      \n                      return (\n                        <div key={violation.id} className=\"bg-red-50 border-2 border-red-200 rounded-lg p-4\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div className=\"text-right flex-1\">\n                              <div className=\"font-bold text-lg text-gray-900\">{student.name}</div>\n                              <div className=\"text-sm text-gray-600 mt-1\">\n                                {hijriDate} • {violation.violationType}\n                              </div>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => {\n                                  if (confirm('هل أنت متأكد من حذف هذه المخالفة؟')) {\n                                    // TODO: Add delete mutation\n                                    alert('سيتم إضافة وظيفة الحذف قريباً')\n                                  }\n                                }}\n                                className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-delete-violation-${violation.id}`}\n                              >\n                                <span>🗑️</span>\n                                <span>حذف</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  if (!student.guardianPhone) {\n                                    alert('رقم جوال ولي الأمر غير مسجل')\n                                    return\n                                  }\n                                  \n                                  const phone = formatPhoneForWhatsApp(student.guardianPhone)\n                                  if (!phone) {\n                                    alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n                                    return\n                                  }\n                                  \n                                  const text = `مخالفة: ${student.name}\\nالتاريخ: ${hijriDate}\\nالنوع: ${violation.violationType}\\nالوصف: ${violation.description}\\nالإجراء: ${violation.actionTaken}\\n\\n${profile?.name || 'مسؤول النظام'}`\n                                  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank')\n                                }}\n                                className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-whatsapp-violation-${violation.id}`}\n                              >\n                                <span>📱</span>\n                                <span>واتساب</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  const printContent = `\n                                    <div class=\"print-content\" style=\"padding: 40px; font-family: Arial, sans-serif; direction: rtl;\">\n                                      <div style=\"text-align: center; margin-bottom: 40px; border-bottom: 3px solid #000; padding-bottom: 20px;\">\n                                        <h1 style=\"font-size: 28px; margin-bottom: 10px; font-weight: bold;\">${profile?.schoolName || 'المدرسة'}</h1>\n                                        <p style=\"font-size: 18px; color: #555;\">المعلم: ${profile?.name || 'غير محدد'}</p>\n                                      </div>\n                                      \n                                      <div style=\"margin-bottom: 30px;\">\n                                        <h2 style=\"font-size: 24px; text-align: center; background-color: #dc2626; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px;\">إشعار مخالفة</h2>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fee2e2; padding: 25px; border-radius: 8px; border: 2px solid #dc2626; margin-bottom: 20px;\">\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">اسم الطالب:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.name}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">السجل المدني:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.nationalId}</p>\n                                          </div>\n                                        </div>\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">التاريخ:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${hijriDate}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">نوع المخالفة:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${violation.violationType}</p>\n                                          </div>\n                                        </div>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fef3c7; padding: 20px; border-radius: 8px; border-right: 4px solid #f59e0b; margin-bottom: 20px;\">\n                                        <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">وصف المخالفة:</p>\n                                        <p style=\"font-size: 18px; line-height: 1.6;\">${violation.description}</p>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #dbeafe; padding: 20px; border-radius: 8px; border-right: 4px solid #3b82f6; margin-bottom: 20px;\">\n                                        <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">الإجراء المتخذ:</p>\n                                        <p style=\"font-size: 18px; line-height: 1.6;\">${violation.actionTaken}</p>\n                                      </div>\n                                      \n                                      ${violation.notes ? `\n                                        <div style=\"background-color: #e0f2fe; padding: 20px; border-radius: 8px; border-right: 4px solid #0ea5e9; margin-bottom: 30px;\">\n                                          <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">ملاحظات إضافية:</p>\n                                          <p style=\"font-size: 18px; line-height: 1.6;\">${violation.notes}</p>\n                                        </div>\n                                      ` : ''}\n                                      \n                                      <div style=\"margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;\">\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع المعلم</p>\n                                        </div>\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع ولي الأمر</p>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  `\n                                  const printWindow = window.open('', '', 'height=600,width=800')\n                                  printWindow.document.write('<html><head><title>طباعة مخالفة</title>')\n                                  printWindow.document.write('</head><body>')\n                                  printWindow.document.write(printContent)\n                                  printWindow.document.write('</body></html>')\n                                  printWindow.document.close()\n                                  printWindow.print()\n                                }}\n                                className=\"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-print-violation-${violation.id}`}\n                              >\n                                <span>🖨️</span>\n                                <span>طباعة</span>\n                              </button>\n                            </div>\n                          </div>\n                          \n                          <div className=\"space-y-2 text-right\">\n                            <div className=\"bg-white p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-gray-700\">الوصف: </span>\n                              <span className=\"text-gray-900\">{violation.description}</span>\n                            </div>\n                            <div className=\"bg-blue-50 p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-blue-700\">الإجراء المتخذ: </span>\n                              <span className=\"text-blue-900\">{violation.actionTaken}</span>\n                            </div>\n                            {violation.notes && (\n                              <div className=\"bg-yellow-50 p-3 rounded-lg\">\n                                <span className=\"text-sm font-bold text-yellow-700\">ملاحظات: </span>\n                                <span className=\"text-yellow-900\">{violation.notes}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      )\n                    })}\n                    </div>\n                  )\n                })()}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* الصفحة الرئيسية */}\n        {currentPage === 'home' && (\n        <div className=\"flex gap-6\">\n          {/* Sidebar */}\n          <div className=\"w-72 flex-shrink-0\">\n            <div className=\"bg-white rounded-2xl shadow-lg p-6 sticky top-6\">\n              <div className=\"flex items-center gap-2 mb-6\">\n                <Settings size={20} className=\"text-gray-600\" />\n                <h2 className=\"text-xl font-bold text-gray-800\">التصفية</h2>\n              </div>\n\n              <div className=\"space-y-6\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    الحالات الخاصة\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={homeSpecialStatusFilter}\n                      onChange={(e) => setHomeSpecialStatusFilter(e.target.value)}\n                      className=\"w-full px-4 py-3 bg-yellow-50 border-2 border-yellow-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-yellow-400 text-center font-bold\"\n                      data-testid=\"select-special-status-filter\"\n                    >\n                      <option value=\"all\">الكل</option>\n                      {specialStatuses.map(status => (\n                        <option key={status.id} value={status.id}>\n                          {status.name}\n                        </option>\n                      ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    المرحلة الدراسية\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={homeStageFilter}\n                      onChange={(e) => {\n                        setHomeStageFilter(e.target.value)\n                        setHomeGroupFilter('all')\n                      }}\n                      className=\"w-full px-4 py-3 bg-blue-50 border-2 border-blue-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-400 text-center font-bold\"\n                      data-testid=\"select-stage-filter\"\n                    >\n                      <option value=\"all\">الكل</option>\n                      {Array.from(new Set(groups.map(g => g.stage))).map(stage => (\n                        <option key={stage} value={stage}>\n                          {stage}\n                        </option>\n                      ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    المجموعات\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={homeGroupFilter}\n                      onChange={(e) => setHomeGroupFilter(e.target.value)}\n                      disabled={homeStageFilter === 'all'}\n                      className=\"w-full px-4 py-3 bg-blue-50 border-2 border-blue-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-400 text-center font-bold disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100\"\n                      data-testid=\"select-group-filter\"\n                    >\n                      <option value=\"all\">الكل</option>\n                      {groups\n                        .filter(g => homeStageFilter === 'all' || g.stage === homeStageFilter)\n                        .map(group => (\n                          <option key={group.id} value={group.id}>\n                            {group.name}\n                          </option>\n                        ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n                \n                {/* زر إعادة تعيين الفلاتر */}\n                {(homeSpecialStatusFilter !== 'all' || homeStageFilter !== 'all' || homeGroupFilter !== 'all') && (\n                  <button\n                    onClick={() => {\n                      setHomeSpecialStatusFilter('all')\n                      setHomeStageFilter('all')\n                      setHomeGroupFilter('all')\n                    }}\n                    className=\"w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg transition-all\"\n                    data-testid=\"button-reset-filters\"\n                  >\n                    إعادة تعيين الفلاتر\n                  </button>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* Main Area */}\n          <div className=\"flex-1\">\n            <div className=\"bg-gradient-to-br from-teal-500 to-emerald-500 rounded-2xl shadow-xl p-8\">\n              <div className=\"flex items-center gap-3 mb-6\">\n                <Search className=\"text-white\" size={28} />\n                <h2 className=\"text-2xl font-bold text-white\">استفسار عن طالب</h2>\n              </div>\n\n              <div className=\"bg-white rounded-xl shadow-lg p-2\">\n                <input\n                  type=\"text\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  placeholder=\"ابحث عن طالب بالاسم، السجل المدني، أو رقم الجوال...\"\n                  className=\"w-full px-6 py-4 text-lg border-none focus:outline-none rounded-lg\"\n                  data-testid=\"input-search\"\n                />\n              </div>\n            </div>\n\n            {/* Students List - منظم حسب المراحل والمجموعات */}\n            <div className=\"mt-6 space-y-4\">\n              {filteredStudents.length === 0 ? (\n                <div className=\"bg-white rounded-2xl shadow-lg p-8 text-center\">\n                  <Users className=\"mx-auto text-gray-400 mb-4\" size={48} />\n                  <h3 className=\"text-xl font-bold text-gray-800 mb-2\">\n                    {students.length === 0 ? 'لا يوجد طلاب' : 'لا توجد نتائج'}\n                  </h3>\n                  <p className=\"text-gray-600\">\n                    {students.length === 0 \n                      ? 'قم بإضافة طلاب من خلال استيراد Excel أو إضافة يدوية'\n                      : 'لم يتم العثور على طلاب بهذا الاسم أو الرقم'}\n                  </p>\n                </div>\n              ) : (\n                (() => {\n                  // تجميع المجموعات حسب المرحلة\n                  const groupsByStage = Object.entries(studentsByGroup).reduce((acc, [groupId, groupStudents]) => {\n                    const group = groups.find(g => g.id === groupId)\n                    if (!group) return acc\n                    \n                    if (!acc[group.stage]) {\n                      acc[group.stage] = []\n                    }\n                    acc[group.stage].push({ groupId, group, groupStudents })\n                    return acc\n                  }, {} as Record<string, Array<{ groupId: string; group: any; groupStudents: typeof filteredStudents }>>)\n\n                  // ترتيب المراحل من الأصغر للأكبر\n                  const stageOrder = [\n                    'الصف الأول الابتدائي',\n                    'الصف الثاني الابتدائي',\n                    'الصف الثالث الابتدائي',\n                    'الصف الرابع الابتدائي',\n                    'الصف الخامس الابتدائي',\n                    'الصف السادس الابتدائي',\n                    'الصف الأول المتوسط',\n                    'الصف الثاني المتوسط',\n                    'الصف الثالث المتوسط',\n                    'الصف الأول الثانوي',\n                    'الصف الثاني الثانوي',\n                    'الصف الثالث الثانوي',\n                  ]\n\n                  // ألوان المراحل\n                  const stageColors = [\n                    'from-blue-600 to-blue-700',\n                    'from-green-600 to-emerald-700',\n                    'from-purple-600 to-violet-700',\n                    'from-orange-600 to-orange-700',\n                    'from-pink-600 to-rose-700',\n                    'from-teal-600 to-cyan-700',\n                    'from-red-600 to-rose-700',\n                    'from-indigo-600 to-purple-700',\n                    'from-yellow-600 to-amber-700',\n                    'from-lime-600 to-green-700',\n                    'from-sky-600 to-blue-700',\n                    'from-fuchsia-600 to-pink-700',\n                  ]\n\n                  const sortedStages = Object.keys(groupsByStage).sort((a, b) => {\n                    const indexA = stageOrder.indexOf(a)\n                    const indexB = stageOrder.indexOf(b)\n                    if (indexA === -1 && indexB === -1) return a.localeCompare(b)\n                    if (indexA === -1) return 1\n                    if (indexB === -1) return -1\n                    return indexA - indexB\n                  })\n\n                  return sortedStages.map((stage, stageIndex) => {\n                    const stageData = groupsByStage[stage]\n                    const isStageExpanded = expandedStages.has(stage)\n                    const stageStudentsCount = stageData.reduce((sum, item) => sum + item.groupStudents.length, 0)\n                    const stageColorIndex = stageIndex % stageColors.length\n                    const stageColor = stageColors[stageColorIndex]\n\n                    return (\n                      <div key={stage} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                        {/* رأس المرحلة الدراسية */}\n                        <div className={`bg-gradient-to-r ${stageColor} p-5`}>\n                          <button\n                            onClick={() => toggleStage(stage)}\n                            className=\"w-full flex items-center justify-between text-white hover:opacity-90 transition-opacity\"\n                            data-testid={`button-toggle-stage-home-${stage}`}\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <ChevronDown \n                                size={28} \n                                className={`transform transition-transform ${isStageExpanded ? 'rotate-180' : ''}`}\n                              />\n                              <h2 className=\"text-2xl font-bold\">{stage}</h2>\n                              <span className=\"bg-white bg-opacity-30 px-4 py-1.5 rounded-full text-sm font-semibold\">\n                                {stageData.length} مجموعة - {stageStudentsCount} طالب\n                              </span>\n                            </div>\n                          </button>\n                        </div>\n\n                        {/* المجموعات داخل المرحلة */}\n                        {isStageExpanded && (\n                          <div className=\"p-4 space-y-3 bg-gray-50\">\n                            {stageData.map(({ groupId, group, groupStudents }, groupIndex) => {\n                              const colorIndex = groupIndex % groupColors.length\n                              const colors = groupColors[colorIndex]\n                              const isExpanded = expandedGroups.has(groupId)\n                  \n                  // الحصول على اسم المجموعة المخصصة من أول طالب\n                  const customGroupName = groupStudents.length > 0 && groupStudents[0].grade \n                    ? groupStudents[0].grade \n                    : null\n\n                  return (\n                    <div key={groupId} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                      {/* رأس المجموعة */}\n                      <button\n                        onClick={() => toggleGroup(groupId)}\n                        className={`w-full bg-gradient-to-r ${colors.bg} p-4 flex items-center justify-between text-white hover:opacity-90 transition-opacity`}\n                        data-testid={`button-toggle-group-${groupId}`}\n                      >\n                        <h3 className=\"text-xl font-bold\">\n                          {group \n                            ? customGroupName \n                              ? `${group.stage} - ${customGroupName}`\n                              : `${group.stage}`\n                            : 'بدون مجموعة'}\n                        </h3>\n                        <div className=\"flex items-center gap-3\">\n                          <span className=\"bg-white bg-opacity-30 px-4 py-1 rounded-full text-sm font-bold\">\n                            {groupStudents.length} طالب\n                          </span>\n                          <ChevronDown \n                            size={24} \n                            className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n                          />\n                        </div>\n                      </button>\n\n                      {/* قائمة الطلاب داخل المجموعة */}\n                      {isExpanded && (\n                        <div className=\"divide-y divide-gray-100 pb-64\">\n                          {groupStudents.map((student) => {\n                            const specialStatus = student.specialStatusId \n                              ? specialStatuses.find(s => s.id === student.specialStatusId)\n                              : null\n                            const hasSpecialStatus = !!specialStatus\n\n                            return (\n                              <div \n                                key={student.id} \n                                className={`p-4 transition-colors ${\n                                  hasSpecialStatus ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50'\n                                }`}\n                                data-testid={`student-card-${student.id}`}\n                              >\n                                <div className=\"flex items-start justify-between\">\n                                  <div className=\"flex-1\">\n                                    <div className=\"flex items-center gap-3 mb-2\">\n                                      <h4 className=\"text-lg font-bold text-gray-900\">{student.name}</h4>\n                                      {specialStatus && (\n                                        <span className=\"bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold\">\n                                          {specialStatus.name}\n                                        </span>\n                                      )}\n                                    </div>\n                                    \n                                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2 text-sm text-gray-600 mb-3\">\n                                      <div>\n                                        <span className=\"font-semibold\">السجل:</span> {student.nationalId}\n                                      </div>\n                                      <div>\n                                        <span className=\"font-semibold\">المجموعة:</span> {group?.name || 'غير محدد'}\n                                      </div>\n                                      <div>\n                                        <span className=\"font-semibold\">جوال:</span> {student.phone || 'غير محدد'}\n                                      </div>\n                                      <div className=\"md:col-span-3\">\n                                        <span className=\"font-semibold\">جوال ولي الأمر:</span> {student.guardianPhone || 'غير محدد'}\n                                      </div>\n                                    </div>\n\n                                    {/* الإحصائيات */}\n                                    <div className=\"flex gap-4 text-xs\">\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-gray-700\">عدد الزيارات:</span>\n                                        <span className=\"bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold\">{student.visitCount || 0}</span>\n                                      </div>\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-gray-700\">عدد المخالفات:</span>\n                                        <span className=\"bg-red-100 text-red-700 px-2 py-1 rounded font-bold\">{student.violationCount || 0}</span>\n                                      </div>\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-gray-700\">عدد الاستئذانات:</span>\n                                        <span className=\"bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold\">{student.permissionCount || 0}</span>\n                                      </div>\n                                    </div>\n                                  </div>\n\n                                  {/* Three Dots Menu */}\n                                  <div className=\"relative\">\n                                    <button\n                                      onClick={() => setOpenMenuStudentId(openMenuStudentId === student.id ? null : student.id)}\n                                      className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\n                                      data-testid={`button-menu-${student.id}`}\n                                    >\n                                      <MoreVertical size={20} className=\"text-gray-600\" />\n                                    </button>\n\n                                    {openMenuStudentId === student.id && (\n                                      <div className=\"absolute left-0 top-full mt-2 bg-white rounded-xl shadow-2xl border-2 border-gray-300 py-1\" style={{ minWidth: '300px', zIndex: 999999 }}>\n                                        <button\n                                          onClick={() => {\n                                            setSelectedStudent(student)\n                                            setShowAllowEntryModal(true)\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-green-50 transition-colors flex items-center gap-3\"\n                                          data-testid={`button-allow-entry-${student.id}`}\n                                        >\n                                          <CheckCircle size={20} className=\"text-green-600\" />\n                                          <span className=\"text-base font-bold text-gray-800\">السماح بدخول الفصل</span>\n                                        </button>\n\n                                        <button\n                                          onClick={() => {\n                                            setPrintStudent(student)\n                                            setShowPrintModal(true)\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3\"\n                                          data-testid={`button-print-${student.id}`}\n                                        >\n                                          <Printer size={20} className=\"text-blue-600\" />\n                                          <span className=\"text-base font-bold text-gray-800\">طباعة بيانات الطالب</span>\n                                        </button>\n\n                                        <button\n                                          onClick={() => {\n                                            const studentGroup = groups.find(g => g.id === student.groupId)\n                                            setEditStudentData({\n                                              name: student.name,\n                                              nationalId: student.nationalId,\n                                              phone: student.phone || '',\n                                              guardianPhone: student.guardianPhone || '',\n                                              grade: student.grade,\n                                              groupId: student.groupId || '',\n                                              specialStatusId: student.specialStatusId || '',\n                                            })\n                                            setSelectedStage(studentGroup?.stage || '')\n                                            setSelectedStudent(student)\n                                            setShowEditStudentModal(true)\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-yellow-50 transition-colors flex items-center gap-3\"\n                                          data-testid={`button-edit-${student.id}`}\n                                        >\n                                          <Edit size={20} className=\"text-yellow-600\" />\n                                          <span className=\"text-base font-bold text-gray-800\">تعديل بيانات الطالب</span>\n                                        </button>\n\n                                        <button\n                                          onClick={() => {\n                                            if (window.confirm(`هل أنت متأكد من حذف الطالب ${student.name}؟\\n\\nسيتم حذف جميع بيانات الطالب نهائياً ولا يمكن التراجع عن هذا الإجراء.`)) {\n                                              deleteStudent.mutate(student.id)\n                                            }\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          disabled={deleteStudent.isPending}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-red-50 transition-colors flex items-center gap-3 disabled:opacity-50\"\n                                          data-testid={`button-delete-${student.id}`}\n                                        >\n                                          <Trash2 size={20} className=\"text-red-600\" />\n                                          <span className=\"text-base font-bold text-red-600\">\n                                            {deleteStudent.isPending ? 'جاري الحذف...' : 'حذف الطالب'}\n                                          </span>\n                                        </button>\n                                      </div>\n                                    )}\n                                  </div>\n                                </div>\n                              </div>\n                            )\n                          })}\n                        </div>\n                      )}\n                    </div>\n                              )\n                            })}\n                          </div>\n                        )}\n                      </div>\n                    )\n                  })\n                })()\n              )}\n            </div>\n          </div>\n        </div>\n        )}\n      </div>\n\n      {/* Footer */}\n      <footer className=\"bg-white border-t border-gray-200 py-6 mt-12\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"text-center\">\n            <p className=\"text-gray-600 font-medium\">\n              تصميم وتطوير: الأستاذ وائل الفيفي\n            </p>\n            <a\n              href=\"https://wa.me/966558890902\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"text-blue-600 hover:text-blue-700 mt-1 inline-flex items-center gap-2 transition-colors cursor-pointer\"\n            >\n              <span>📱</span>\n              <span dir=\"ltr\" className=\"font-semibold\">0558890902</span>\n            </a>\n          </div>\n        </div>\n      </footer>\n\n      {/* Modal: إرسال للمعلم */}\n      {showSendToTeacherModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white flex items-center gap-3\">\n                <Send size={28} />\n                إرسال للمعلم\n              </h2>\n              <button\n                onClick={() => {\n                  setShowSendToTeacherModal(false)\n                  setSelectedTeacherForSend('')\n                  setSelectedStageForSend('')\n                  setSelectedGroupsForSend(new Set())\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-send-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n              {/* رسالة توضيحية */}\n              <div className=\"bg-blue-50 border-2 border-blue-200 rounded-lg p-4\">\n                <p className=\"text-blue-800 text-center\">\n                  سيتم إرسال بيانات الطلاب ذوي الحالات الخاصة في المجموعة المحددة إلى المعلم عبر واتساب\n                </p>\n              </div>\n\n              {/* اختر المعلم */}\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اختر المعلم <span className=\"text-red-500\">*</span>\n                </label>\n                <select\n                  value={selectedTeacherForSend}\n                  onChange={(e) => setSelectedTeacherForSend(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right\"\n                  data-testid=\"select-teacher-for-send\"\n                >\n                  <option value=\"\">اختر المعلم</option>\n                  {teachers.map((teacher: any) => (\n                    <option key={teacher.id} value={teacher.id}>\n                      {teacher.name} - {teacher.specialization || 'غير محدد'}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              {/* اختر المرحلة */}\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اختر المرحلة <span className=\"text-red-500\">*</span>\n                </label>\n                <select\n                  value={selectedStageForSend}\n                  onChange={(e) => {\n                    setSelectedStageForSend(e.target.value)\n                    setSelectedGroupsForSend(new Set())\n                  }}\n                  className=\"w-full px-4 py-3 border-2 border-yellow-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right\"\n                  style={{\n                    color: !selectedStageForSend ? '#9CA3AF' : \n                           selectedStageForSend.includes('الابتدائي') ? '#3B82F6' :\n                           selectedStageForSend.includes('المتوسط') ? '#10B981' :\n                           selectedStageForSend.includes('الثانوي') ? '#F59E0B' : '#1F2937',\n                    fontWeight: selectedStageForSend ? '600' : 'normal'\n                  }}\n                  data-testid=\"select-stage-for-send\"\n                >\n                  <option value=\"\" style={{ color: '#9CA3AF' }}>اختر المرحلة</option>\n                  {Array.from(new Set(groups.map((g: any) => g.stage))).map((stage: string) => (\n                    <option \n                      key={stage} \n                      value={stage}\n                      style={{\n                        color: stage.includes('الابتدائي') ? '#3B82F6' :\n                               stage.includes('المتوسط') ? '#10B981' :\n                               stage.includes('الثانوي') ? '#F59E0B' : '#1F2937',\n                        fontWeight: '600',\n                        backgroundColor: stage.includes('الابتدائي') ? '#EFF6FF' :\n                                        stage.includes('المتوسط') ? '#ECFDF5' :\n                                        stage.includes('الثانوي') ? '#FFFBEB' : 'white'\n                      }}\n                    >\n                      {stage}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              {/* اختر المجموعة */}\n              {selectedStageForSend && (\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    اختر المجموعة <span className=\"text-red-500\">*</span>\n                  </label>\n                  <div className=\"space-y-3 max-h-64 overflow-y-auto border-2 border-gray-300 rounded-lg p-4\">\n                    {groups\n                      .filter((group: any) => group.stage === selectedStageForSend)\n                      .filter((group: any) => {\n                        const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                        return groupStudents.length > 0\n                      })\n                      .map((group: any) => {\n                        const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                        const isChecked = selectedGroupsForSend.has(group.id)\n                        \n                        return (\n                          <div\n                            key={group.id}\n                            className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              id={`group-${group.id}`}\n                              checked={isChecked}\n                              onChange={(e) => {\n                                const newSet = new Set(selectedGroupsForSend)\n                                if (e.target.checked) {\n                                  newSet.add(group.id)\n                                } else {\n                                  newSet.delete(group.id)\n                                }\n                                setSelectedGroupsForSend(newSet)\n                              }}\n                              className=\"w-5 h-5 text-purple-600 border-purple-300 rounded focus:ring-purple-500\"\n                              data-testid={`checkbox-group-${group.id}`}\n                            />\n                            <label\n                              htmlFor={`group-${group.id}`}\n                              className=\"flex-1 text-right mr-3 cursor-pointer\"\n                            >\n                              <span className=\"font-semibold text-gray-900\">{group.name}</span>\n                              <span className=\"text-gray-500 mr-2\">({groupStudents.length} طالب)</span>\n                            </label>\n                          </div>\n                        )\n                      })}\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowSendToTeacherModal(false)\n                  setSelectedTeacherForSend('')\n                  setSelectedStageForSend('')\n                  setSelectedGroupsForSend(new Set())\n                }}\n                className=\"flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                data-testid=\"button-cancel-send\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!selectedTeacherForSend || !selectedStageForSend || selectedGroupsForSend.size === 0) {\n                    alert('الرجاء تحديد المعلم والمرحلة والمجموعات')\n                    return\n                  }\n\n                  const selectedTeacher = teachers.find((t: any) => t.id === selectedTeacherForSend)\n                  if (!selectedTeacher || !selectedTeacher.phone) {\n                    alert('المعلم المحدد لا يحتوي على رقم جوال')\n                    return\n                  }\n\n                  // جمع بيانات الطلاب من المجموعات المحددة\n                  const selectedStudents = students.filter(s => \n                    s.groupId && selectedGroupsForSend.has(s.groupId) && s.specialStatusId\n                  )\n\n                  if (selectedStudents.length === 0) {\n                    alert('لا يوجد طلاب ذوي حالات خاصة في المجموعات المحددة')\n                    return\n                  }\n\n                  // تنسيق الرسالة\n                  const selectedTeacherName = teachers.find((t: any) => t.id === selectedTeacherForSend)?.name || 'المعلم'\n                  \n                  let message = `*اسم المعلم:* ${selectedTeacherName}\\n\\n`\n                  \n                  Array.from(selectedGroupsForSend).forEach(groupId => {\n                    const group = groups.find((g: any) => g.id === groupId)\n                    const groupStudents = selectedStudents.filter(s => s.groupId === groupId)\n                    \n                    if (groupStudents.length > 0) {\n                      message += `*${selectedStageForSend} (${group?.name})*\\n`\n                      message += `*الحالات الخاصة:*\\n`\n                      \n                      groupStudents.forEach((student, index) => {\n                        message += `${index + 1} - ${student.name}\\n`\n                      })\n                      message += '\\n'\n                    }\n                  })\n\n                  // إرسال عبر واتساب\n                  const phoneNumber = formatPhoneForWhatsApp(selectedTeacher.phone)\n                  if (!phoneNumber) {\n                    alert('رقم جوال المعلم غير صالح. يرجى التأكد من إدخال الرقم الصحيح.')\n                    return\n                  }\n                  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`\n                  window.open(whatsappUrl, '_blank')\n\n                  // إغلاق النافذة\n                  setShowSendToTeacherModal(false)\n                  setSelectedTeacherForSend('')\n                  setSelectedStageForSend('')\n                  setSelectedGroupsForSend(new Set())\n                }}\n                disabled={!selectedTeacherForSend || !selectedStageForSend || selectedGroupsForSend.size === 0}\n                className=\"flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                data-testid=\"button-confirm-send\"\n              >\n                <Send size={20} />\n                إرسال عبر واتساب\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: طباعة المجموعة - الحالات الخاصة */}\n      {showSpecialStatusPrintModal && selectedGroupForSpecialPrint && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-700 p-6 rounded-t-2xl flex items-center justify-between print:hidden\">\n              <h2 className=\"text-2xl font-bold text-white flex items-center gap-3\">\n                <Printer size={28} />\n                طباعة الحالات الخاصة\n              </h2>\n              <button\n                onClick={() => {\n                  setShowSpecialStatusPrintModal(false)\n                  setSelectedGroupForSpecialPrint(null)\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-special-print-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content - للطباعة */}\n            <div className=\"flex-1 overflow-y-auto p-8 print:p-6\">\n              {/* Header للطباعة */}\n              <div className=\"mb-6 text-center border-b-2 border-blue-500 pb-4\">\n                <h1 className=\"text-3xl font-bold text-gray-800 mb-2\">\n                  {profile?.schoolName || 'اسم المدرسة'}\n                </h1>\n                <p className=\"text-sm text-gray-600 mb-1\">\n                  المرشد الطلابي: {profile?.name || 'اسم المعلم'}\n                </p>\n                <p className=\"text-xs text-gray-500\">\n                  التاريخ: {new Date().toLocaleDateString('ar-SA-u-ca-islamic', { year: 'numeric', month: 'long', day: 'numeric' }).replace(/\\u200f/g, '')}\n                </p>\n              </div>\n\n              {/* العنوان الأخضر */}\n              <div className=\"bg-green-600 text-white text-center py-3 mb-4 rounded-lg\">\n                <h2 className=\"text-xl font-bold\">الحالات الخاصة</h2>\n              </div>\n\n              {/* المرحلة */}\n              <div className=\"text-right mb-3\">\n                <h3 className=\"text-lg font-bold text-gray-800 border-b-2 border-green-600 inline-block pb-1\">\n                  {selectedGroupForSpecialPrint.stage}\n                </h3>\n              </div>\n\n              {/* اسم المجموعة */}\n              <div className=\"mb-3\">\n                <h4 className=\"text-md font-bold text-blue-700\">{selectedGroupForSpecialPrint.name}</h4>\n                <p className=\"text-xs text-gray-600\">عدد الطلاب: {students.filter(s => s.groupId === selectedGroupForSpecialPrint.id && s.specialStatusId).length}</p>\n              </div>\n\n              {/* الجدول */}\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse text-sm\">\n                  <thead>\n                    <tr className=\"bg-blue-600 text-white\">\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">الاسم</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">السجل المدني</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">جوال الطالب</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">جوال ولي الأمر</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">الحالة الخاصة</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {students\n                      .filter(s => s.groupId === selectedGroupForSpecialPrint.id && s.specialStatusId)\n                      .map((student, index) => {\n                        const specialStatus = specialStatuses.find(s => s.id === student.specialStatusId)\n                        return (\n                          <tr key={student.id} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.name}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.nationalId}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.phone || '-'}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.guardianPhone || '-'}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">\n                              <span className=\"text-purple-700 font-semibold\">\n                                {showSpecialStatusColumn ? (specialStatus?.name || 'غير محدد') : 'لديه حالة خاصة'}\n                              </span>\n                            </td>\n                          </tr>\n                        )\n                      })}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3 print:hidden\">\n              <button\n                onClick={() => {\n                  setShowSpecialStatusPrintModal(false)\n                  setSelectedGroupForSpecialPrint(null)\n                }}\n                className=\"flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                data-testid=\"button-cancel-special-print\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => window.print()}\n                className=\"flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 rounded-lg transition-all shadow-md flex items-center justify-center gap-2\"\n                data-testid=\"button-confirm-special-print\"\n              >\n                <Printer size={20} />\n                طباعة\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إعدادات تسجيل الدخول */}\n      {showLoginSettingsModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-green-600 to-emerald-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Lock size={28} className=\"text-white\" />\n                <h2 className=\"text-2xl font-bold text-white\">إعدادات تسجيل الدخول</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowLoginSettingsModal(false)\n                  setNewUsername('admin')\n                  setNewPassword('')\n                  setConfirmPassword('')\n                  setLoginSettingsError('')\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-login-settings\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              <p className=\"text-gray-600 mb-6 text-center text-sm\">\n                يمكنك تغيير اسم المستخدم وكلمة المرور من هنا\n              </p>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    اسم المستخدم الجديد\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={newUsername}\n                    onChange={(e) => setNewUsername(e.target.value)}\n                    placeholder=\"admin\"\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                    data-testid=\"input-new-username\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    كلمة المرور الجديدة\n                  </label>\n                  <input\n                    type=\"password\"\n                    value={newPassword}\n                    onChange={(e) => setNewPassword(e.target.value)}\n                    placeholder=\"أدخل كلمة المرور الجديدة\"\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                    data-testid=\"input-new-password\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    تأكيد كلمة المرور\n                  </label>\n                  <input\n                    type=\"password\"\n                    value={confirmPassword}\n                    onChange={(e) => setConfirmPassword(e.target.value)}\n                    placeholder=\"أعد إدخال كلمة المرور\"\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                    data-testid=\"input-confirm-password\"\n                  />\n                </div>\n\n                {loginSettingsError && (\n                  <div className=\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-right text-sm\" data-testid=\"error-login-settings\">\n                    {loginSettingsError}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowLoginSettingsModal(false)\n                  setNewUsername('admin')\n                  setNewPassword('')\n                  setConfirmPassword('')\n                  setLoginSettingsError('')\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-login-settings\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={async () => {\n                  // التحقق من البيانات\n                  if (!newUsername || !newUsername.trim()) {\n                    setLoginSettingsError('الرجاء إدخال اسم المستخدم')\n                    return\n                  }\n                  if (!newPassword || !newPassword.trim()) {\n                    setLoginSettingsError('الرجاء إدخال كلمة المرور')\n                    return\n                  }\n                  if (newPassword !== confirmPassword) {\n                    setLoginSettingsError('كلمة المرور غير متطابقة')\n                    return\n                  }\n                  \n                  setLoginSettingsError('')\n                  \n                  try {\n                    await apiRequest('/api/update-login-credentials', 'POST', {\n                      currentUsername: 'admin',\n                      newUsername: newUsername,\n                      newPassword: newPassword\n                    })\n                    \n                    alert('✅ تم تحديث بيانات تسجيل الدخول بنجاح!')\n                    setShowLoginSettingsModal(false)\n                    setNewUsername('admin')\n                    setNewPassword('')\n                    setConfirmPassword('')\n                  } catch (error) {\n                    setLoginSettingsError('حدث خطأ أثناء تحديث البيانات')\n                  }\n                }}\n                className=\"flex-1 bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-bold py-3 rounded-lg transition-all shadow-md\"\n                data-testid=\"button-save-login-settings\"\n              >\n                حفظ التغييرات\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إعدادات الملف الشخصي */}\n      {showProfileSettingsModal && (\n        <ProfileSettings onClose={() => setShowProfileSettingsModal(false)} />\n      )}\n\n      {/* Modal: استيراد من Excel */}\n      {showExcelImportModal && (\n        <ExcelImport \n          groups={groups || []}\n          onImportComplete={() => {\n            setShowExcelImportModal(false)\n            queryClient.invalidateQueries()\n          }}\n        />\n      )}\n\n      {/* Modal: إدارة الهيدر والقوائم */}\n      {showHeaderSettingsModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-teal-600 via-purple-600 to-purple-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إدارة الهيدر والقوائم</h2>\n              <button\n                onClick={() => setShowHeaderSettingsModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-header-settings-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content - Two Columns */}\n            <div className=\"flex-1 overflow-y-auto p-4\">\n              <div className=\"grid md:grid-cols-2 gap-4\">\n                {/* عمود اليمين: بطاقات الهيدر */}\n                <div className=\"bg-gradient-to-br from-teal-50 to-cyan-50 p-3 rounded-xl border-2 border-teal-200\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <LayoutDashboard className=\"text-teal-600\" size={20} />\n                    <h3 className=\"text-lg font-bold text-teal-800\">بطاقات الهيدر</h3>\n                  </div>\n                  <p className=\"text-gray-600 text-xs mb-3 text-right\">\n                    البطاقات الإحصائية في أعلى الصفحة\n                  </p>\n\n              <div className=\"space-y-1.5\">\n                {/* إجمالي الطلاب */}\n                <label className=\"flex items-center justify-between p-2 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg cursor-pointer hover:from-blue-100 hover:to-blue-200 transition-all border border-blue-200\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <input\n                      type=\"checkbox\"\n                      checked={headerSettings.showTotalStudents}\n                      onChange={(e) => setHeaderSettings({ ...headerSettings, showTotalStudents: e.target.checked })}\n                      className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-total-students\"\n                    />\n                    <Users className=\"text-blue-600\" size={16} />\n                    <span className=\"text-sm font-semibold text-gray-800\">إجمالي الطلاب</span>\n                  </div>\n                </label>\n\n                {/* المعلمين */}\n                <label className=\"flex items-center justify-between p-2 bg-gradient-to-r from-green-50 to-green-100 rounded-lg cursor-pointer hover:from-green-100 hover:to-green-200 transition-all border border-green-200\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <input\n                      type=\"checkbox\"\n                      checked={headerSettings.showTotalTeachers}\n                      onChange={(e) => setHeaderSettings({ ...headerSettings, showTotalTeachers: e.target.checked })}\n                      className=\"w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-500\"\n                      data-testid=\"checkbox-show-total-teachers\"\n                    />\n                    <GraduationCap className=\"text-green-600\" size={16} />\n                    <span className=\"text-sm font-semibold text-gray-800\">المعلمين</span>\n                  </div>\n                </label>\n\n                {/* الحالات الخاصة */}\n                <label className=\"flex items-center justify-between p-2 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg cursor-pointer hover:from-purple-100 hover:to-purple-200 transition-all border border-purple-200\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <input\n                      type=\"checkbox\"\n                      checked={headerSettings.showSpecialStatus}\n                      onChange={(e) => setHeaderSettings({ ...headerSettings, showSpecialStatus: e.target.checked })}\n                      className=\"w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-500\"\n                      data-testid=\"checkbox-show-special-status\"\n                    />\n                    <Heart className=\"text-purple-600\" size={16} />\n                    <span className=\"text-sm font-semibold text-gray-800\">حالات خاصة</span>\n                  </div>\n                </label>\n\n                {/* استقبال الطلاب */}\n                <label className=\"flex items-center justify-between p-2 bg-gradient-to-r from-indigo-50 to-indigo-100 rounded-lg cursor-pointer hover:from-indigo-100 hover:to-indigo-200 transition-all border border-indigo-200\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <input\n                      type=\"checkbox\"\n                      checked={headerSettings.showReceptions}\n                      onChange={(e) => setHeaderSettings({ ...headerSettings, showReceptions: e.target.checked })}\n                      className=\"w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500\"\n                      data-testid=\"checkbox-show-receptions\"\n                    />\n                    <UserCheck className=\"text-indigo-600\" size={16} />\n                    <span className=\"text-sm font-semibold text-gray-800\">استقبال الطلاب</span>\n                  </div>\n                </label>\n\n                {/* الاستئذانات */}\n                <label className=\"flex items-center justify-between p-2 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg cursor-pointer hover:from-orange-100 hover:to-orange-200 transition-all border border-orange-200\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <input\n                      type=\"checkbox\"\n                      checked={headerSettings.showPermissions}\n                      onChange={(e) => setHeaderSettings({ ...headerSettings, showPermissions: e.target.checked })}\n                      className=\"w-4 h-4 text-orange-600 rounded focus:ring-2 focus:ring-orange-500\"\n                      data-testid=\"checkbox-show-permissions\"\n                    />\n                    <LogOut className=\"text-orange-600\" size={16} />\n                    <span className=\"text-sm font-semibold text-gray-800\">استئذانات</span>\n                  </div>\n                </label>\n\n                {/* المخالفات */}\n                <label className=\"flex items-center justify-between p-2 bg-gradient-to-r from-red-50 to-red-100 rounded-lg cursor-pointer hover:from-red-100 hover:to-red-200 transition-all border border-red-200\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <input\n                      type=\"checkbox\"\n                      checked={headerSettings.showViolations}\n                      onChange={(e) => setHeaderSettings({ ...headerSettings, showViolations: e.target.checked })}\n                      className=\"w-4 h-4 text-red-600 rounded focus:ring-2 focus:ring-red-500\"\n                      data-testid=\"checkbox-show-violations\"\n                    />\n                    <AlertCircle className=\"text-red-600\" size={16} />\n                    <span className=\"text-sm font-semibold text-gray-800\">المخالفات</span>\n                  </div>\n                </label>\n              </div>\n                </div>\n\n                {/* عمود اليسار: قوائم الصفحة الرئيسية */}\n                <div className=\"bg-gradient-to-br from-purple-50 to-pink-50 p-3 rounded-xl border-2 border-purple-200\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <List className=\"text-purple-600\" size={20} />\n                    <h3 className=\"text-lg font-bold text-purple-800\">قوائم الصفحة الرئيسية</h3>\n                  </div>\n                  <p className=\"text-gray-600 text-xs mb-3 text-right\">\n                    الأقسام المعروضة في الصفحة\n                  </p>\n\n                <div className=\"space-y-1.5\">\n                  {/* المعلمين */}\n                  <label className=\"flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border border-gray-200\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <input\n                        type=\"checkbox\"\n                        checked={listSettings.showTeachers}\n                        onChange={(e) => updateListSettings({ ...listSettings, showTeachers: e.target.checked })}\n                        className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                        data-testid=\"checkbox-show-teachers\"\n                      />\n                      <Users className=\"text-indigo-600\" size={16} />\n                      <span className=\"text-sm font-semibold text-gray-800\">المعلمين</span>\n                    </div>\n                  </label>\n\n                  {/* المجموعات */}\n                  <label className=\"flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border border-gray-200\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <input\n                        type=\"checkbox\"\n                        checked={listSettings.showGroups}\n                        onChange={(e) => updateListSettings({ ...listSettings, showGroups: e.target.checked })}\n                        className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                        data-testid=\"checkbox-show-groups\"\n                      />\n                      <Users className=\"text-blue-600\" size={16} />\n                      <span className=\"text-sm font-semibold text-gray-800\">المجموعات</span>\n                    </div>\n                  </label>\n\n                  {/* الحالات الخاصة */}\n                  <label className=\"flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border border-gray-200\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <input\n                        type=\"checkbox\"\n                        checked={listSettings.showSpecialStatus}\n                        onChange={(e) => updateListSettings({ ...listSettings, showSpecialStatus: e.target.checked })}\n                        className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                        data-testid=\"checkbox-show-special-status-list\"\n                      />\n                      <Star className=\"text-yellow-600\" size={16} />\n                      <span className=\"text-sm font-semibold text-gray-800\">الحالات الخاصة</span>\n                    </div>\n                  </label>\n\n                  {/* استقبال الطلاب */}\n                  <label className=\"flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border border-gray-200\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <input\n                        type=\"checkbox\"\n                        checked={listSettings.showReception}\n                        onChange={(e) => updateListSettings({ ...listSettings, showReception: e.target.checked })}\n                        className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                        data-testid=\"checkbox-show-reception-list\"\n                      />\n                      <UserCheck className=\"text-green-600\" size={16} />\n                      <span className=\"text-sm font-semibold text-gray-800\">استقبال الطلاب</span>\n                    </div>\n                  </label>\n\n                  {/* الاستئذان */}\n                  <label className=\"flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border border-gray-200\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <input\n                        type=\"checkbox\"\n                        checked={listSettings.showPermissions}\n                        onChange={(e) => updateListSettings({ ...listSettings, showPermissions: e.target.checked })}\n                        className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                        data-testid=\"checkbox-show-permissions-list\"\n                      />\n                      <Clock className=\"text-orange-600\" size={16} />\n                      <span className=\"text-sm font-semibold text-gray-800\">الاستئذان</span>\n                    </div>\n                  </label>\n\n                  {/* المخالفات */}\n                  <label className=\"flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border border-gray-200\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <input\n                        type=\"checkbox\"\n                        checked={listSettings.showViolations}\n                        onChange={(e) => updateListSettings({ ...listSettings, showViolations: e.target.checked })}\n                        className=\"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                        data-testid=\"checkbox-show-violations-list\"\n                      />\n                      <AlertTriangle className=\"text-red-600\" size={16} />\n                      <span className=\"text-sm font-semibold text-gray-800\">المخالفات</span>\n                    </div>\n                  </label>\n                </div>\n                </div>\n              </div>\n\n              {/* زر الإغلاق */}\n              <button\n                onClick={() => setShowHeaderSettingsModal(false)}\n                className=\"w-full mt-6 bg-gradient-to-r from-teal-600 via-purple-600 to-purple-700 hover:from-teal-700 hover:via-purple-700 hover:to-purple-800 text-white font-bold py-4 rounded-lg transition-all shadow-md\"\n                data-testid=\"button-close-header-settings\"\n              >\n                حفظ وإغلاق\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إدارة المراحل والمجموعات */}\n      {showGroupsModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-teal-600 to-emerald-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إدارة المراحل والمجموعات</h2>\n              <button\n                onClick={() => setShowGroupsModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-groups-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              {/* إضافة مجموعة جديدة */}\n              <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6 mb-6\">\n                <h3 className=\"text-xl font-bold text-gray-800 mb-4\">إضافة مجموعة جديدة</h3>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n                  {/* الصف (المرحلة) */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                      الصف (المرحلة)\n                    </label>\n                    <select\n                      value={newGroupStage}\n                      onChange={(e) => setNewGroupStage(e.target.value)}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                      style={{\n                        color: !newGroupStage ? '#9CA3AF' : \n                               newGroupStage.includes('الابتدائي') ? '#3B82F6' :\n                               newGroupStage.includes('المتوسط') ? '#10B981' :\n                               newGroupStage.includes('الثانوي') ? '#F59E0B' : '#1F2937',\n                        fontWeight: newGroupStage ? '600' : 'normal'\n                      }}\n                      data-testid=\"select-group-stage\"\n                    >\n                      <option value=\"\" style={{ color: '#9CA3AF' }}>مثال: الصف الأول الثانوي</option>\n                      <option value=\"الصف الأول الابتدائي\" style={{ color: '#3B82F6', fontWeight: '600', backgroundColor: '#EFF6FF' }}>الصف الأول الابتدائي</option>\n                      <option value=\"الصف الثاني الابتدائي\" style={{ color: '#3B82F6', fontWeight: '600', backgroundColor: '#EFF6FF' }}>الصف الثاني الابتدائي</option>\n                      <option value=\"الصف الثالث الابتدائي\" style={{ color: '#3B82F6', fontWeight: '600', backgroundColor: '#EFF6FF' }}>الصف الثالث الابتدائي</option>\n                      <option value=\"الصف الرابع الابتدائي\" style={{ color: '#3B82F6', fontWeight: '600', backgroundColor: '#EFF6FF' }}>الصف الرابع الابتدائي</option>\n                      <option value=\"الصف الخامس الابتدائي\" style={{ color: '#3B82F6', fontWeight: '600', backgroundColor: '#EFF6FF' }}>الصف الخامس الابتدائي</option>\n                      <option value=\"الصف السادس الابتدائي\" style={{ color: '#3B82F6', fontWeight: '600', backgroundColor: '#EFF6FF' }}>الصف السادس الابتدائي</option>\n                      <option value=\"الصف الأول المتوسط\" style={{ color: '#10B981', fontWeight: '600', backgroundColor: '#ECFDF5' }}>الصف الأول المتوسط</option>\n                      <option value=\"الصف الثاني المتوسط\" style={{ color: '#10B981', fontWeight: '600', backgroundColor: '#ECFDF5' }}>الصف الثاني المتوسط</option>\n                      <option value=\"الصف الثالث المتوسط\" style={{ color: '#10B981', fontWeight: '600', backgroundColor: '#ECFDF5' }}>الصف الثالث المتوسط</option>\n                      <option value=\"الصف الأول الثانوي\" style={{ color: '#F59E0B', fontWeight: '600', backgroundColor: '#FFFBEB' }}>الصف الأول الثانوي</option>\n                      <option value=\"الصف الثاني الثانوي\" style={{ color: '#F59E0B', fontWeight: '600', backgroundColor: '#FFFBEB' }}>الصف الثاني الثانوي</option>\n                      <option value=\"الصف الثالث الثانوي\" style={{ color: '#F59E0B', fontWeight: '600', backgroundColor: '#FFFBEB' }}>الصف الثالث الثانوي</option>\n                    </select>\n                  </div>\n\n                  {/* اسم المجموعة */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                      اسم المجموعة\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={newGroupName}\n                      onChange={(e) => setNewGroupName(e.target.value)}\n                      placeholder=\"مثال: مجموعة 1\"\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                      data-testid=\"input-group-name\"\n                    />\n                  </div>\n                </div>\n\n                <button\n                  onClick={() => {\n                    if (newGroupName.trim() && newGroupStage) {\n                      addGroup.mutate({ name: newGroupName.trim(), stage: newGroupStage })\n                    }\n                  }}\n                  disabled={!newGroupName.trim() || !newGroupStage || addGroup.isPending}\n                  className=\"w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                  data-testid=\"button-add-group\"\n                >\n                  <Plus size={20} />\n                  <span>{addGroup.isPending ? 'جاري الإضافة...' : 'إضافة المجموعة'}</span>\n                </button>\n              </div>\n\n              {/* قائمة المجموعات الموجودة - مجمعة حسب المراحل */}\n              <div>\n                <h3 className=\"text-xl font-bold text-gray-800 mb-4\">المجموعات الحالية</h3>\n                {groups.length === 0 ? (\n                  <p className=\"text-gray-500 text-center py-8\">لا توجد مجموعات</p>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {/* تجميع المجموعات حسب المراحل */}\n                    {Object.entries(\n                      groups.reduce((acc: any, group: any) => {\n                        if (!acc[group.stage]) {\n                          acc[group.stage] = []\n                        }\n                        acc[group.stage].push(group)\n                        return acc\n                      }, {})\n                    ).map(([stage, stageGroups]: [string, any], stageIndex) => {\n                      // ألوان مختلفة للمراحل\n                      const stageColors = [\n                        'from-emerald-500 to-teal-500',\n                        'from-blue-500 to-cyan-500',\n                        'from-purple-500 to-pink-500',\n                        'from-orange-500 to-amber-500',\n                        'from-red-500 to-rose-500',\n                        'from-indigo-500 to-blue-500',\n                      ]\n                      const colorClass = stageColors[stageIndex % stageColors.length]\n                      \n                      // عدد الطلاب في هذه المرحلة\n                      const stageStudentCount = students.filter((s: any) => \n                        stageGroups.some((g: any) => g.id === s.groupId)\n                      ).length\n\n                      return (\n                        <div key={stage} className=\"space-y-2\">\n                          {/* عنوان المرحلة */}\n                          <div className={`bg-gradient-to-r ${colorClass} rounded-lg p-4 flex items-center justify-between shadow-lg`}>\n                            <div className=\"flex items-center gap-3\">\n                              <Users className=\"text-white\" size={24} />\n                              <h4 className=\"text-xl font-bold text-white\">{stage}</h4>\n                            </div>\n                            <span className=\"text-white text-sm font-medium\">\n                              {stageStudentCount} طالب\n                            </span>\n                          </div>\n\n                          {/* المجموعات في هذه المرحلة */}\n                          <div className=\"space-y-2 pr-4\">\n                            {stageGroups.map((group: any) => {\n                              const groupStudentCount = students.filter((s: any) => s.groupId === group.id).length\n                              \n                              return (\n                                <div\n                                  key={group.id}\n                                  className=\"bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4 hover:border-green-300 transition-all\"\n                                >\n                                  <div className=\"flex items-center justify-between\">\n                                    <div className=\"flex-1\">\n                                      <p className=\"text-lg font-bold text-gray-800\">{group.name}</p>\n                                      <p className=\"text-sm text-gray-600\">{groupStudentCount} طالب</p>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <button\n                                        onClick={() => {\n                                          setSelectedGroup(group)\n                                          setEditGroupData({ name: group.name, stage: group.stage })\n                                          setShowEditGroupModal(true)\n                                        }}\n                                        className=\"text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition-all\"\n                                        data-testid={`button-edit-group-${group.id}`}\n                                      >\n                                        <Edit size={18} />\n                                      </button>\n                                      <button\n                                        onClick={() => {\n                                          setGroupToDelete(group)\n                                          setShowDeleteGroupConfirm(true)\n                                        }}\n                                        className=\"text-red-600 hover:bg-red-100 p-2 rounded-lg transition-all\"\n                                        data-testid={`button-delete-group-${group.id}`}\n                                      >\n                                        <Trash2 size={18} />\n                                      </button>\n                                    </div>\n                                  </div>\n                                </div>\n                              )\n                            })}\n                          </div>\n                        </div>\n                      )\n                    })}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إدارة الحالات الخاصة */}\n      {showSpecialStatusModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إدارة الحالات الخاصة</h2>\n              <button\n                onClick={() => setShowSpecialStatusModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              {/* قائمة الحالات الخاصة */}\n              <div className=\"space-y-3 mb-6\">\n                {specialStatuses.length === 0 ? (\n                  <p className=\"text-gray-500 text-center py-8\">لا توجد حالات خاصة</p>\n                ) : (\n                  specialStatuses.map(status => (\n                    <div\n                      key={status.id}\n                      className=\"flex items-center justify-between bg-gray-50 border-2 border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-all\"\n                    >\n                      <span className=\"text-lg font-medium text-gray-800\">{status.name}</span>\n                      <button\n                        onClick={() => deleteSpecialStatus.mutate(status.id)}\n                        disabled={deleteSpecialStatus.isPending}\n                        className=\"text-red-600 hover:bg-red-50 p-2 rounded-lg transition-all disabled:opacity-50\"\n                        data-testid={`button-delete-status-${status.id}`}\n                      >\n                        <Trash2 size={20} />\n                      </button>\n                    </div>\n                  ))\n                )}\n              </div>\n\n              {/* إضافة حالة جديدة */}\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اسم الحالة الخاصة\n                </label>\n                <input\n                  type=\"text\"\n                  value={newStatusName}\n                  onChange={(e) => setNewStatusName(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && newStatusName.trim()) {\n                      addSpecialStatus.mutate(newStatusName.trim())\n                    }\n                  }}\n                  placeholder=\"أضف حالة جديدة...\"\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right\"\n                  data-testid=\"input-new-status-name\"\n                />\n              </div>\n\n              <button\n                onClick={() => {\n                  if (newStatusName.trim()) {\n                    addSpecialStatus.mutate(newStatusName.trim())\n                  }\n                }}\n                disabled={!newStatusName.trim() || addSpecialStatus.isPending}\n                className=\"w-full mt-4 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                data-testid=\"button-add-status\"\n              >\n                <Plus size={20} />\n                <span>{addSpecialStatus.isPending ? 'جاري الإضافة...' : 'إضافة'}</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: طباعة بيانات الطالب */}\n      {showPrintModal && printStudent && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-gray-700 to-gray-800 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between print:hidden\">\n              <div className=\"flex items-center gap-3\">\n                <Printer size={28} />\n                <h2 className=\"text-2xl font-bold\">طباعة بيانات الطالب</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowPrintModal(false)\n                  setPrintStudent(null)\n                }}\n                className=\"text-white hover:bg-gray-900 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-print\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content - Print Area */}\n            <div id=\"print-area\" className=\"flex-1 overflow-y-auto p-4\" style={{ pageBreakAfter: 'avoid' }}>\n              {/* Header للطباعة */}\n              <div className=\"text-center mb-3 border-b-2 border-blue-500 pb-2\">\n                <p className=\"text-sm text-gray-600\">المعلم: {profile?.logoUrl || teacherName || 'غير محدد'}</p>\n                <h1 className=\"text-xl font-bold text-gray-800 mt-1\">\n                  {profile?.schoolName || schoolName || 'المدرسة'}\n                </h1>\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  {profile?.name || systemDescription || 'نظام الإرشاد الطلابي'}\n                </p>\n              </div>\n\n              {/* بيانات الطالب الأساسية */}\n              <div className=\"bg-blue-50 border-2 border-blue-300 rounded-lg p-2 mb-2\" style={{ pageBreakInside: 'avoid' }}>\n                <h2 className=\"text-sm font-bold text-blue-800 mb-1 flex items-center gap-1\">\n                  <UserIcon size={14} />\n                  البيانات الأساسية\n                </h2>\n                <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.name}</span>\n                    <span className=\"text-gray-600\">اسم الطالب:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.nationalId}</span>\n                    <span className=\"text-gray-600\">السجل المدني:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.phone || 'غير محدد'}</span>\n                    <span className=\"text-gray-600\">جوال الطالب:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.guardianPhone || 'غير محدد'}</span>\n                    <span className=\"text-gray-600\">جوال ولي الأمر:</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* المعلومات الدراسية */}\n              <div className=\"bg-green-50 border-2 border-green-300 rounded-lg p-2 mb-2\" style={{ pageBreakInside: 'avoid' }}>\n                <h2 className=\"text-sm font-bold text-green-800 mb-1 flex items-center gap-1\">\n                  <GraduationCap size={14} />\n                  المعلومات الدراسية\n                </h2>\n                <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                  <div className=\"flex justify-between border-b border-green-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.grade}</span>\n                    <span className=\"text-gray-600\">الصف:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-green-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === printStudent.groupId)?.name || 'غير محدد'}\n                    </span>\n                    <span className=\"text-gray-600\">المجموعة:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-green-200 pb-1 col-span-2\">\n                    <span className=\"font-bold text-gray-900\">\n                      {printStudent.specialStatusId \n                        ? specialStatuses.find(s => s.id === printStudent.specialStatusId)?.name \n                        : 'لا يوجد'}\n                    </span>\n                    <span className=\"text-gray-600\">الحالة الخاصة:</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* الإحصائيات */}\n              <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-2 mb-2\" style={{ pageBreakInside: 'avoid' }}>\n                <h2 className=\"text-sm font-bold text-yellow-800 mb-1 flex items-center gap-1\">\n                  <AlertCircle size={14} />\n                  إحصائيات الطالب\n                </h2>\n                <div className=\"grid grid-cols-3 gap-2 text-center\">\n                  <div className=\"bg-white rounded-lg p-1 border-2 border-blue-200\">\n                    <div className=\"text-xl font-bold text-blue-600\">\n                      {printStudent.visitCount || 0}\n                    </div>\n                    <div className=\"text-xs text-gray-600 font-semibold\">عدد مرات الزيارة</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-1 border-2 border-red-200\">\n                    <div className=\"text-xl font-bold text-red-600\">\n                      {printStudent.violationCount || 0}\n                    </div>\n                    <div className=\"text-xs text-gray-600 font-semibold\">عدد المخالفات</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-1 border-2 border-green-200\">\n                    <div className=\"text-xl font-bold text-green-600\">\n                      {printStudent.permissionCount || 0}\n                    </div>\n                    <div className=\"text-xs text-gray-600 font-semibold\">عدد مرات الاستئذان</div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Footer للطباعة */}\n              <div className=\"mt-2 pt-2 border-t-2 border-gray-300 text-center text-xs text-gray-500\" style={{ pageBreakInside: 'avoid' }}>\n                <p>تاريخ الطباعة: {new Date().toLocaleDateString('ar-SA')}</p>\n                <p className=\"mt-1\">نظام الإرشاد الطلابي - جميع الحقوق محفوظة</p>\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3 print:hidden\">\n              <button\n                onClick={() => {\n                  setShowPrintModal(false)\n                  setPrintStudent(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-print\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => window.print()}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md flex items-center justify-center gap-2\"\n                data-testid=\"button-do-print\"\n              >\n                <Printer size={20} />\n                <span>طباعة</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تعديل/إضافة الطالب */}\n      {showEditStudentModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold\">{selectedStudent ? 'تعديل الطالب' : 'إضافة طالب جديد'}</h2>\n              <button\n                onClick={() => {\n                  setShowEditStudentModal(false)\n                  setSelectedStudent(null)\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-edit-student\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {/* اسم الطالب */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    اسم الطالب\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.name}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, name: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"الياس\"\n                    data-testid=\"input-edit-student-name\"\n                  />\n                </div>\n\n                {/* السجل المدني */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    السجل المدني\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.nationalId}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, nationalId: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"12564646\"\n                    data-testid=\"input-edit-student-national-id\"\n                  />\n                </div>\n\n                {/* جوال الطالب */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    جوال الطالب\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.phone}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, phone: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"555555465\"\n                    data-testid=\"input-edit-student-phone\"\n                  />\n                </div>\n\n                {/* جوال ولي الأمر */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    جوال ولي الأمر\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.guardianPhone}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, guardianPhone: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"565464644\"\n                    data-testid=\"input-edit-student-guardian-phone\"\n                  />\n                </div>\n\n                {/* الصف */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    الصف\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={selectedStage}\n                      onChange={(e) => {\n                        setSelectedStage(e.target.value)\n                        // إعادة تعيين المجموعة عند تغيير الصف\n                        setEditStudentData({ \n                          ...editStudentData, \n                          groupId: '',\n                          grade: ''\n                        })\n                      }}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                      style={{\n                        color: !selectedStage ? '#6B7280' : \n                               selectedStage.includes('الابتدائي') ? '#3B82F6' :\n                               selectedStage.includes('المتوسط') ? '#10B981' :\n                               selectedStage.includes('الثانوي') ? '#F59E0B' : '#1F2937',\n                        fontWeight: selectedStage ? '600' : 'normal'\n                      }}\n                      data-testid=\"select-edit-student-stage\"\n                    >\n                      <option value=\"\" style={{ color: '#9CA3AF' }}>-- اختر الصف --</option>\n                      {/* عرض المراحل الفريدة فقط */}\n                      {Array.from(new Set(groups.map((g: any) => g.stage))).map((stage: string) => (\n                        <option \n                          key={stage} \n                          value={stage}\n                          style={{\n                            color: stage.includes('الابتدائي') ? '#3B82F6' :\n                                   stage.includes('المتوسط') ? '#10B981' :\n                                   stage.includes('الثانوي') ? '#F59E0B' : '#1F2937',\n                            fontWeight: '600',\n                            backgroundColor: stage.includes('الابتدائي') ? '#EFF6FF' :\n                                            stage.includes('المتوسط') ? '#ECFDF5' :\n                                            stage.includes('الثانوي') ? '#FFFBEB' : 'white'\n                          }}\n                        >\n                          {stage}\n                        </option>\n                      ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n\n                {/* المجموعة */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    المجموعة\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={editStudentData.groupId}\n                      onChange={(e) => {\n                        const selectedGroup = groups.find((g: any) => g.id === e.target.value)\n                        setEditStudentData({ \n                          ...editStudentData, \n                          groupId: e.target.value,\n                          grade: selectedGroup?.name || ''\n                        })\n                      }}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                      data-testid=\"select-edit-student-group\"\n                      disabled={!selectedStage}\n                    >\n                      <option value=\"\">-- اختر المجموعة --</option>\n                      {/* عرض فقط المجموعات التي تطابق المرحلة المختارة */}\n                      {groups\n                        .filter((group: any) => group.stage === selectedStage)\n                        .map((group: any) => (\n                          <option key={group.id} value={group.id}>\n                            {group.name}\n                          </option>\n                        ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n              </div>\n\n              {/* الحالة الخاصة (اختياري) */}\n              <div className=\"mt-4\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  الحالة الخاصة (اختياري)\n                </label>\n                <div className=\"relative\">\n                  <select\n                    value={editStudentData.specialStatusId}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, specialStatusId: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    data-testid=\"select-edit-student-special-status\"\n                  >\n                    <option value=\"\">بدون حالة خاصة</option>\n                    {specialStatuses.map(status => (\n                      <option key={status.id} value={status.id}>\n                        {status.name}\n                      </option>\n                    ))}\n                  </select>\n                  <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                </div>\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowEditStudentModal(false)\n                  setSelectedStudent(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-edit-student\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!editStudentData.name.trim() || !editStudentData.nationalId.trim()) {\n                    alert('الرجاء إدخال اسم الطالب والسجل المدني')\n                    return\n                  }\n\n                  const studentData = {\n                    name: editStudentData.name,\n                    nationalId: editStudentData.nationalId,\n                    phone: editStudentData.phone || '',\n                    guardianPhone: editStudentData.guardianPhone,\n                    grade: editStudentData.grade,\n                    groupId: editStudentData.groupId || null,\n                    specialStatusId: editStudentData.specialStatusId || null,\n                  }\n\n                  if (selectedStudent) {\n                    // تعديل طالب موجود\n                    updateStudent.mutate({\n                      id: selectedStudent.id,\n                      data: studentData\n                    })\n                  } else {\n                    // إضافة طالب جديد\n                    createStudent.mutate(studentData)\n                  }\n                }}\n                disabled={updateStudent.isPending || createStudent.isPending}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-save-edit-student\"\n              >\n                {updateStudent.isPending || createStudent.isPending \n                  ? 'جاري الحفظ...' \n                  : selectedStudent ? 'تحديث الطالب' : 'حفظ الطالب'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: السماح بدخول الفصل */}\n      {showAllowEntryModal && selectedStudent && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <CheckCircle size={28} />\n                <h2 className=\"text-2xl font-bold\">السماح بدخول الفصل</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowAllowEntryModal(false)\n                  setSelectedStudent(null)\n                  setSelectedTeacherId('')\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-allow-entry\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n              {/* معلومات الطالب */}\n              <div className=\"bg-blue-50 border-2 border-blue-200 rounded-xl p-4\">\n                <h3 className=\"text-lg font-bold text-gray-800 mb-3 text-right\">معلومات الطالب:</h3>\n                <div className=\"space-y-2 text-right\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">{selectedStudent.name}</span>\n                    <span className=\"text-gray-600\">الاسم:</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">{selectedStudent.nationalId}</span>\n                    <span className=\"text-gray-600\">السجل المدني:</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">\n                      {groups.find(g => g.id === selectedStudent.groupId)?.name || '-'}\n                    </span>\n                    <span className=\"text-gray-600\">الصف:</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">-</span>\n                    <span className=\"text-gray-600\">المجموعة:</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* ملاحظة */}\n              <div className=\"bg-gray-50 border border-gray-200 rounded-xl p-4 text-center\">\n                <p className=\"text-gray-700\">سيتم إرسال رسالة للسماح بدخول الطالب للفصل إلى المعلم المختار عبر واتساب</p>\n              </div>\n\n              {/* اختر المعلم */}\n              <div>\n                <label className=\"block text-lg font-bold text-gray-800 mb-3 text-right\">اختر المعلم</label>\n                <div className=\"relative\">\n                  <select\n                    value={selectedTeacherId}\n                    onChange={(e) => setSelectedTeacherId(e.target.value)}\n                    className=\"w-full px-4 py-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-yellow-500 text-center font-bold text-lg\"\n                    data-testid=\"select-teacher-allow-entry\"\n                  >\n                    <option value=\"\">-- اختر المعلم --</option>\n                    {teachers.map((teacher: any) => (\n                      <option key={teacher.id} value={teacher.id}>\n                        {teacher.name}\n                      </option>\n                    ))}\n                  </select>\n                  <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                </div>\n              </div>\n\n              {/* معاينة الرسالة */}\n              {selectedTeacherId && (\n                <div className=\"bg-gray-50 border border-gray-300 rounded-xl p-4\">\n                  <h3 className=\"text-lg font-bold text-gray-800 mb-3 text-right\">معاينة الرسالة:</h3>\n                  <div className=\"bg-white border border-gray-200 rounded-lg p-4 text-right space-y-1\">\n                    <p className=\"flex items-center gap-2 text-blue-600 font-bold\">\n                      <CheckCircle size={18} />\n                      السماح بدخول الطالب للفصل\n                    </p>\n                    <p>\n                      <span className=\"text-gray-700\">اسم الطالب: </span>\n                      <span className=\"font-bold text-gray-900\">{selectedStudent.name}</span>\n                    </p>\n                    <p>\n                      <span className=\"text-gray-700\">المرسل: </span>\n                      <span className=\"font-bold text-gray-900\">\n                        {profile?.name || teacherName} - {teacherPhone}\n                      </span>\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowAllowEntryModal(false)\n                  setSelectedStudent(null)\n                  setSelectedTeacherId('')\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-allow-entry\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!selectedTeacherId) {\n                    alert('الرجاء اختيار المعلم')\n                    return\n                  }\n\n                  const selectedTeacher = teachers.find((t: any) => t.id === selectedTeacherId)\n                  if (!selectedTeacher || !selectedTeacher.phone) {\n                    alert('رقم جوال المعلم غير متوفر')\n                    return\n                  }\n\n                  // بناء رسالة واتساب\n                  const message = `📚 *السماح بدخول الطالب للفصل*\\n\\nاسم الطالب: *${selectedStudent.name}*\\n\\nالمرسل: ${profile?.name || teacherName} - ${teacherPhone}`\n                  \n                  const phoneNumber = formatPhoneForWhatsApp(selectedTeacher.phone)\n                  if (!phoneNumber) {\n                    alert('رقم جوال المعلم غير صالح. يرجى التأكد من إدخال الرقم الصحيح.')\n                    return\n                  }\n                  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`\n                  window.open(whatsappUrl, '_blank')\n\n                  setShowAllowEntryModal(false)\n                  setSelectedStudent(null)\n                  setSelectedTeacherId('')\n                }}\n                disabled={!selectedTeacherId}\n                className=\"flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                data-testid=\"button-send-whatsapp\"\n              >\n                <span>إرسال عبر واتساب</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إضافة معلم */}\n      {showAddTeacherModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إضافة معلم جديد</h2>\n              <button\n                onClick={() => {\n                  setShowAddTeacherModal(false)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-add-teacher\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Form */}\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  اسم المعلم\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.name}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"أدخل اسم المعلم\"\n                  data-testid=\"input-teacher-name\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  التخصص / المادة\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.specialization}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, specialization: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"مثال: رياضيات، فيزياء، لغة عربية\"\n                  data-testid=\"input-teacher-specialization\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  رقم الجوال\n                </label>\n                <input\n                  type=\"tel\"\n                  value={teacherFormData.phone}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, phone: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"05XXXXXXXX\"\n                  dir=\"ltr\"\n                  data-testid=\"input-teacher-phone\"\n                />\n              </div>\n            </div>\n\n            {/* Actions */}\n            <div className=\"p-6 pt-0 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowAddTeacherModal(false)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-add-teacher\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!teacherFormData.name.trim()) {\n                    alert('الرجاء إدخال اسم المعلم')\n                    return\n                  }\n                  addTeacher.mutate({\n                    name: teacherFormData.name.trim(),\n                    phone: teacherFormData.phone.trim() || null,\n                    specialization: teacherFormData.specialization.trim() || null,\n                  })\n                }}\n                disabled={addTeacher.isPending || !teacherFormData.name.trim()}\n                className=\"flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-submit-add-teacher\"\n              >\n                {addTeacher.isPending ? 'جاري الإضافة...' : 'إضافة المعلم'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تعديل معلم */}\n      {showEditTeacherModal && selectedTeacher && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-yellow-500 to-yellow-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">تعديل بيانات المعلم</h2>\n              <button\n                onClick={() => {\n                  setShowEditTeacherModal(false)\n                  setSelectedTeacher(null)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-edit-teacher\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Form */}\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  اسم المعلم\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.name}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent\"\n                  placeholder=\"أدخل اسم المعلم\"\n                  data-testid=\"input-edit-teacher-name\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  التخصص / المادة\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.specialization}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, specialization: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent\"\n                  placeholder=\"مثال: رياضيات، فيزياء، لغة عربية\"\n                  data-testid=\"input-edit-teacher-specialization\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  رقم الجوال\n                </label>\n                <input\n                  type=\"tel\"\n                  value={teacherFormData.phone}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, phone: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent\"\n                  placeholder=\"05XXXXXXXX\"\n                  dir=\"ltr\"\n                  data-testid=\"input-edit-teacher-phone\"\n                />\n              </div>\n            </div>\n\n            {/* Actions */}\n            <div className=\"p-6 pt-0 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowEditTeacherModal(false)\n                  setSelectedTeacher(null)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-edit-teacher\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!teacherFormData.name.trim()) {\n                    alert('الرجاء إدخال اسم المعلم')\n                    return\n                  }\n                  updateTeacher.mutate({\n                    id: selectedTeacher.id,\n                    data: {\n                      name: teacherFormData.name.trim(),\n                      phone: teacherFormData.phone.trim() || null,\n                      specialization: teacherFormData.specialization.trim() || null,\n                    },\n                  })\n                }}\n                disabled={updateTeacher.isPending || !teacherFormData.name.trim()}\n                className=\"flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-submit-edit-teacher\"\n              >\n                {updateTeacher.isPending ? 'جاري التحديث...' : 'حفظ التعديلات'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تعديل المجموعة */}\n      {showEditGroupModal && selectedGroup && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold\">تعديل المجموعة</h2>\n              <button\n                onClick={() => {\n                  setShowEditGroupModal(false)\n                  setSelectedGroup(null)\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-edit-group\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اسم المجموعة\n                </label>\n                <input\n                  type=\"text\"\n                  value={editGroupData.name}\n                  onChange={(e) => setEditGroupData({ ...editGroupData, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                  placeholder=\"مثال: الأول الابتدائي\"\n                  data-testid=\"input-edit-group-name\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  المرحلة الدراسية\n                </label>\n                <input\n                  type=\"text\"\n                  value={editGroupData.stage}\n                  onChange={(e) => setEditGroupData({ ...editGroupData, stage: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                  placeholder=\"مثال: الابتدائي\"\n                  data-testid=\"input-edit-group-stage\"\n                />\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowEditGroupModal(false)\n                  setSelectedGroup(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-edit-group\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (editGroupData.name.trim() && editGroupData.stage.trim()) {\n                    updateGroup.mutate({\n                      id: selectedGroup.id,\n                      data: {\n                        name: editGroupData.name.trim(),\n                        stage: editGroupData.stage.trim()\n                      }\n                    })\n                  }\n                }}\n                disabled={!editGroupData.name.trim() || !editGroupData.stage.trim() || updateGroup.isPending}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-save-edit-group\"\n              >\n                {updateGroup.isPending ? 'جاري التحديث...' : 'حفظ التعديلات'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: فلتر الزيارات بالتاريخ */}\n      {showDateFilterModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Clock size={24} />\n                <h2 className=\"text-2xl font-bold\">فلتر بالتاريخ</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowDateFilterModal(false)\n                  setDateFilterError('')\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-date-filter\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"p-6 space-y-4\">\n              <p className=\"text-gray-700 text-center mb-4\">\n                اختر التاريخ لعرض زيارات ذلك اليوم\n              </p>\n              \n              {/* Date Picker */}\n              <div className=\"space-y-3\">\n                <label className=\"block text-right font-bold text-gray-700\">\n                  اختر التاريخ من التقويم:\n                </label>\n                <input\n                  type=\"date\"\n                  onChange={(e) => {\n                    if (e.target.value) {\n                      // Parse date locally to avoid timezone issues\n                      const [year, month, day] = e.target.value.split('-').map(Number)\n                      const selectedDate = new Date(year, month - 1, day)\n                      \n                      // Convert to Hijri with Arabic locale\n                      let hijriDate = selectedDate.toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })\n                      \n                      // Normalize to ASCII digits for comparison\n                      const normalizeDigits = (str: string) => {\n                        return str.replace(/[٠-٩]/g, (d) => \n                          String.fromCharCode(d.charCodeAt(0) - 1632 + 48)\n                        )\n                      }\n                      \n                      hijriDate = normalizeDigits(hijriDate)\n                      \n                      // Check if any visits match this date\n                      const matchingVisits = studentVisits.filter((v: any) => {\n                        const normalizedVisitDate = normalizeDigits(v.visitDate)\n                        return normalizedVisitDate === hijriDate\n                      })\n                      \n                      if (matchingVisits.length > 0) {\n                        setFilterDate(matchingVisits[0].visitDate)\n                        setDateFilterError('')\n                        setShowDateFilterModal(false)\n                      } else {\n                        // Show feedback but keep modal open\n                        setDateFilterError(`لا توجد زيارات في تاريخ ${hijriDate}. جرب تاريخ آخر أو اختر من القائمة أدناه.`)\n                      }\n                    }\n                  }}\n                  className=\"w-full p-3 border-2 border-gray-300 rounded-lg text-lg\"\n                  style={{ direction: 'ltr' }}\n                  data-testid=\"input-date-picker\"\n                />\n                \n                {/* رسالة الخطأ */}\n                {dateFilterError && (\n                  <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-right\" data-testid=\"error-no-visits-found\">\n                    <p className=\"text-yellow-800 font-semibold\">{dateFilterError}</p>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex items-center gap-2 my-4\">\n                <div className=\"flex-1 h-px bg-gray-300\"></div>\n                <span className=\"text-gray-500 text-sm\">أو اختر من التواريخ المتاحة</span>\n                <div className=\"flex-1 h-px bg-gray-300\"></div>\n              </div>\n              \n              {/* قائمة التواريخ المتاحة */}\n              <div className=\"max-h-64 overflow-y-auto space-y-2\">\n                {Array.from(new Set(studentVisits.map((v: any) => v.visitDate))).sort().reverse().map((date: string) => {\n                  const visitsCount = studentVisits.filter((v: any) => v.visitDate === date).length\n                  return (\n                    <button\n                      key={date}\n                      onClick={() => {\n                        setFilterDate(date)\n                        setShowDateFilterModal(false)\n                      }}\n                      className={`w-full p-4 rounded-lg text-right transition-all border-2 ${\n                        filterDate === date\n                          ? 'bg-blue-50 border-blue-500 text-blue-900'\n                          : 'bg-gray-50 border-gray-200 hover:bg-gray-100'\n                      }`}\n                      data-testid={`date-option-${date}`}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className=\"font-bold text-lg\">{date}</div>\n                          <div className=\"text-sm text-gray-600 mt-1\">\n                            {visitsCount} {visitsCount === 1 ? 'زيارة' : visitsCount === 2 ? 'زيارتان' : 'زيارات'}\n                          </div>\n                        </div>\n                        {filterDate === date && (\n                          <CheckCircle size={24} className=\"text-blue-600\" />\n                        )}\n                      </div>\n                    </button>\n                  )\n                })}\n              </div>\n\n              {filterDate && (\n                <button\n                  onClick={() => {\n                    setFilterDate('')\n                    setShowDateFilterModal(false)\n                  }}\n                  className=\"w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                  data-testid=\"button-clear-filter\"\n                >\n                  إلغاء الفلتر وعرض الكل\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: فلتر الاستئذانات بالتاريخ */}\n      {showPermissionDateFilter && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            <div className=\"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Clock size={24} />\n                <h2 className=\"text-2xl font-bold\">فلتر الاستئذانات بالتاريخ</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowPermissionDateFilter(false)\n                  setPermissionDateFilterError('')\n                }}\n                className=\"text-white hover:bg-orange-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-permission-date-filter\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-4\">\n              <p className=\"text-gray-700 text-center mb-4\">\n                اختر التاريخ لعرض استئذانات ذلك اليوم\n              </p>\n              \n              <div className=\"space-y-3\">\n                <label className=\"block text-right font-bold text-gray-700\">\n                  اختر التاريخ من التقويم:\n                </label>\n                <input\n                  type=\"date\"\n                  onChange={(e) => {\n                    if (e.target.value) {\n                      // حفظ التاريخ بصيغة ISO الميلادية مباشرة للمقارنة\n                      setPermissionFilterDate(e.target.value)\n                      setPermissionDateFilterError('')\n                      setShowPermissionDateFilter(false)\n                    }\n                  }}\n                  className=\"w-full p-3 border-2 border-gray-300 rounded-lg text-lg\"\n                  style={{ direction: 'ltr' }}\n                  data-testid=\"input-permission-date-picker\"\n                />\n                \n                {permissionDateFilterError && (\n                  <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-right\" data-testid=\"error-no-permissions-found\">\n                    <p className=\"text-yellow-800 font-semibold\">{permissionDateFilterError}</p>\n                  </div>\n                )}\n              </div>\n\n              {permissionFilterDate && (\n                <button\n                  onClick={() => {\n                    setPermissionFilterDate('')\n                    setShowPermissionDateFilter(false)\n                  }}\n                  className=\"w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                  data-testid=\"button-clear-permission-filter\"\n                >\n                  إلغاء الفلتر وعرض الكل\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: فلتر المخالفات بالتاريخ */}\n      {showViolationDateFilter && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            <div className=\"bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Clock size={24} />\n                <h2 className=\"text-2xl font-bold\">فلتر المخالفات بالتاريخ</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowViolationDateFilter(false)\n                  setViolationDateFilterError('')\n                }}\n                className=\"text-white hover:bg-red-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-violation-date-filter\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-4\">\n              <p className=\"text-gray-700 text-center mb-4\">\n                اختر التاريخ لعرض مخالفات ذلك اليوم\n              </p>\n              \n              <div className=\"space-y-3\">\n                <label className=\"block text-right font-bold text-gray-700\">\n                  اختر التاريخ من التقويم:\n                </label>\n                <input\n                  type=\"date\"\n                  onChange={(e) => {\n                    if (e.target.value) {\n                      // حفظ التاريخ بصيغة ISO الميلادية مباشرة للمقارنة\n                      setViolationFilterDate(e.target.value)\n                      setViolationDateFilterError('')\n                      setShowViolationDateFilter(false)\n                    }\n                  }}\n                  className=\"w-full p-3 border-2 border-gray-300 rounded-lg text-lg\"\n                  style={{ direction: 'ltr' }}\n                  data-testid=\"input-violation-date-picker\"\n                />\n                \n                {violationDateFilterError && (\n                  <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-right\" data-testid=\"error-no-violations-found\">\n                    <p className=\"text-yellow-800 font-semibold\">{violationDateFilterError}</p>\n                  </div>\n                )}\n              </div>\n\n              {violationFilterDate && (\n                <button\n                  onClick={() => {\n                    setViolationFilterDate('')\n                    setShowViolationDateFilter(false)\n                  }}\n                  className=\"w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                  data-testid=\"button-clear-violation-filter\"\n                >\n                  إلغاء الفلتر وعرض الكل\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تأكيد حذف المجموعة */}\n      {showDeleteGroupConfirm && groupToDelete && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold\">تأكيد الحذف</h2>\n              <button\n                onClick={() => {\n                  setShowDeleteGroupConfirm(false)\n                  setGroupToDelete(null)\n                }}\n                className=\"text-white hover:bg-red-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-delete-confirm\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"p-6\">\n              <div className=\"flex flex-col items-center text-center mb-6\">\n                <div className=\"bg-red-100 text-red-600 p-4 rounded-full mb-4\">\n                  <AlertTriangle size={48} />\n                </div>\n                <h3 className=\"text-xl font-bold text-gray-900 mb-2\">\n                  هل أنت متأكد من حذف هذه المجموعة؟\n                </h3>\n                <p className=\"text-gray-700 mb-4\">\n                  <span className=\"font-bold text-red-600\">{groupToDelete.stage} - {groupToDelete.name}</span>\n                </p>\n                \n                {(() => {\n                  const studentsInGroup = students.filter(s => s.groupId === groupToDelete.id)\n                  if (studentsInGroup.length > 0) {\n                    return (\n                      <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 w-full\">\n                        <p className=\"text-yellow-900 font-bold mb-2\">\n                          ⚠️ تحذير: هذه المجموعة تحتوي على {studentsInGroup.length} طالب/طلاب\n                        </p>\n                        <p className=\"text-yellow-800 text-sm\">\n                          سيتم نقل الطلاب إلى \"بدون مجموعة\" ولن يتم حذفهم\n                        </p>\n                      </div>\n                    )\n                  }\n                  return null\n                })()}\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowDeleteGroupConfirm(false)\n                  setGroupToDelete(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-delete-group\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  deleteGroup.mutate(groupToDelete.id)\n                  setShowDeleteGroupConfirm(false)\n                  setGroupToDelete(null)\n                }}\n                disabled={deleteGroup.isPending}\n                className=\"flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-confirm-delete-group\"\n              >\n                {deleteGroup.isPending ? 'جاري الحذف...' : 'نعم، احذف المجموعة'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: طباعة المجموعة */}\n      {showGroupPrintModal && selectedGroupForPrint && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 print:bg-white print:block print:relative print:p-0\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col print:max-h-none print:shadow-none print:rounded-none print:max-w-none\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between print:hidden\">\n              <div className=\"flex items-center gap-3\">\n                <Printer size={28} />\n                <h2 className=\"text-2xl font-bold\">طباعة بيانات المجموعة</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowGroupPrintModal(false)\n                  setSelectedGroupForPrint(null)\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-group-print\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-8 print:overflow-visible print:p-6 print:max-w-[21cm] print:mx-auto\">\n              {/* Header للطباعة */}\n              <div className=\"mb-6 text-center border-b-2 border-blue-500 pb-4\">\n                <h1 className=\"text-3xl font-bold text-gray-800 mb-2\">\n                  {profile?.schoolName || 'اسم المدرسة'}\n                </h1>\n                <p className=\"text-sm text-gray-600 mb-1\">\n                  المرشد الطلابي: {profile?.name || 'اسم المعلم'}\n                </p>\n                <p className=\"text-xs text-gray-500\">\n                  التاريخ: {new Date().toLocaleDateString('ar-SA-u-ca-islamic', { year: 'numeric', month: 'long', day: 'numeric' }).replace(/\\u200f/g, '')}\n                </p>\n              </div>\n\n              {/* العنوان الأخضر */}\n              <div className=\"bg-green-600 text-white text-center py-3 mb-4 rounded-lg\">\n                <h2 className=\"text-xl font-bold\">جميع المجموعات</h2>\n              </div>\n\n              {/* المرحلة */}\n              <div className=\"text-right mb-3\">\n                <h3 className=\"text-lg font-bold text-gray-800 border-b-2 border-green-600 inline-block pb-1\">\n                  {selectedGroupForPrint.stage}\n                </h3>\n              </div>\n\n              {/* اسم المجموعة */}\n              <div className=\"mb-3\">\n                <h4 className=\"text-md font-bold text-blue-700\">{selectedGroupForPrint.name}</h4>\n                <p className=\"text-xs text-gray-600\">عدد الطلاب: {students.filter(s => s.groupId === selectedGroupForPrint.id).length}</p>\n              </div>\n\n              {/* الجدول */}\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse text-sm\">\n                  <thead>\n                    <tr className=\"bg-blue-600 text-white\">\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">الاسم</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">السجل المدني</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">جوال الطالب</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">جوال ولي الأمر</th>\n                      <th className=\"px-3 py-2 text-center font-bold border border-blue-700\">الحالة الخاصة</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {students\n                      .filter(s => s.groupId === selectedGroupForPrint.id)\n                      .map((student, index) => {\n                        const specialStatus = specialStatuses.find(ss => ss.id === student.specialStatusId)\n                        return (\n                          <tr\n                            key={student.id}\n                            className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}\n                            data-testid={`print-row-${student.id}`}\n                          >\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.name}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.nationalId}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.phone || '-'}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">{student.guardianPhone || '-'}</td>\n                            <td className=\"px-3 py-2 border border-gray-300 text-center\">\n                              {specialStatus ? specialStatus.name : '-'}\n                            </td>\n                          </tr>\n                        )\n                      })}\n                    {students.filter(s => s.groupId === selectedGroupForPrint.id).length === 0 && (\n                      <tr>\n                        <td colSpan={5} className=\"px-3 py-8 text-center text-gray-500 border border-gray-300\">\n                          لا يوجد طلاب في هذه المجموعة\n                        </td>\n                      </tr>\n                    )}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3 print:hidden\">\n              <button\n                onClick={() => {\n                  setShowGroupPrintModal(false)\n                  setSelectedGroupForPrint(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-group-print\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => window.print()}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md flex items-center justify-center gap-2\"\n                data-testid=\"button-do-group-print\"\n              >\n                <Printer size={20} />\n                <span>طباعة</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Input مخفي لاستيراد البيانات */}\n      <input\n        type=\"file\"\n        id=\"import-data-file\"\n        accept=\".json\"\n        style={{ display: 'none' }}\n        onChange={async (e) => {\n          const file = e.target.files?.[0]\n          if (!file) return\n          \n          try {\n            const text = await file.text()\n            const importData = JSON.parse(text)\n            \n            if (!importData.version || !importData.data) {\n              alert('❌ ملف غير صحيح! الرجاء اختيار ملف نسخة احتياطية صحيح')\n              return\n            }\n            \n            const confirmed = confirm(\n              '⚠️ تحذير: سيتم استبدال جميع البيانات الحالية بالبيانات المستوردة.\\n\\nهل أنت متأكد من المتابعة؟'\n            )\n            \n            if (!confirmed) return\n            \n            // استيراد البيانات\n            const { data } = importData\n            \n            // استخدام endpoint مخصص للاستيراد يحافظ على الـ IDs\n            try {\n              await apiRequest('/api/import-data', 'POST', { data })\n              \n              // تحديث الكاش\n              queryClient.invalidateQueries()\n              \n              alert('✅ تم استيراد البيانات بنجاح!\\n\\n⚠️ ملاحظة مهمة:\\n• تم إنشاء حساب جديد:\\n  - اسم المستخدم: admin\\n  - كلمة المرور: admin123\\n\\n• قم بتغيير كلمة المرور من الإعدادات\\n\\nسيتم تحديث الصفحة الآن.')\n              window.location.reload()\n            } catch (error) {\n              console.error('Error importing data:', error)\n              alert('❌ خطأ في استيراد البيانات!\\n\\nالسبب المحتمل:\\n• الملف المُستورد تالف أو مُعدَّل يدوياً\\n• تأكد من استخدام ملف تصدير أصلي من النظام\\n\\nملاحظة: قد تكون بعض البيانات فُقِدت. يُنصح باستعادة نسخة احتياطية سابقة.')\n            }\n          } catch (error) {\n            console.error('Error reading file:', error)\n            alert('❌ خطأ في قراءة الملف. تأكد من أنه ملف JSON صحيح')\n          }\n          \n          // إعادة تعيين input\n          e.target.value = ''\n        }}\n      />\n    </div>\n  )\n}\n\nexport default App\n","size_bytes":314666},"Erchad-1/client/src/pages/PermissionPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db, StudentPermission } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student } from '../types'\nimport { LogOut, Search, Send, Clock, Printer, Calendar, Filter } from 'lucide-react'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface PermissionWithStudent extends StudentPermission {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    permission_count: number\n    group?: { name: string }\n  }\n}\n\nexport function PermissionPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [permissions, setPermissions] = useState<PermissionWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [formData, setFormData] = useState({\n    reason: '',\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchPermissions()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    try {\n      // جلب الطلاب من Supabase\n      const { data: studentsData, error: studentsError } = await supabase\n        .from('students')\n        .select('*')\n        .eq('status', 'نشط')\n        .order('name')\n\n      if (studentsError) {\n        console.error('Error fetching students:', studentsError)\n        return\n      }\n\n      // جلب المجموعات من Supabase\n      const { data: groupsData } = await supabase\n        .from('groups')\n        .select('*')\n\n      // جلب الحالات الخاصة من Supabase\n      const { data: statusesData } = await supabase\n        .from('special_statuses')\n        .select('*')\n\n      const groups = groupsData || []\n      const statuses = statusesData || []\n\n      const studentsWithRelations = (studentsData || []).map(student => {\n        const group = groups.find(g => g.id === student.group_id)\n        const special_status = statuses.find(s => s.id === student.special_status_id)\n        return {\n          ...student,\n          group: group ? { name: group.name } : undefined,\n          special_status: special_status ? { name: special_status.name } : undefined\n        }\n      })\n\n      setStudents(studentsWithRelations as Student[])\n\n      // تحديث IndexedDB المحلية\n      if (studentsData) {\n        await db.students.bulkPut(studentsData)\n      }\n      if (groups.length > 0) {\n        await db.groups.bulkPut(groups)\n      }\n      if (statuses.length > 0) {\n        await db.special_statuses.bulkPut(statuses)\n      }\n    } catch (error) {\n      console.error('Error in fetchStudents:', error)\n    }\n  }\n\n  async function fetchPermissions(filterDate?: string) {\n    try {\n      // إعداد الفلتر الزمني\n      let query = supabase\n        .from('student_permissions')\n        .select('*')\n        .order('permission_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('permission_date', startOfDay.toISOString())\n          .lte('permission_date', endOfDay.toISOString())\n      } else {\n        const today = new Date()\n        today.setHours(0, 0, 0, 0)\n        query = query.gte('permission_date', today.toISOString())\n      }\n\n      const { data: permissionsData, error: permissionsError } = await query\n\n      if (permissionsError) {\n        console.error('Error fetching permissions:', permissionsError)\n        return\n      }\n\n      // جلب المجموعات والطلاب\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const groups = groupsData || []\n      const allStudents = studentsData || []\n\n      const permissionsWithStudents = (permissionsData || []).map((permission) => {\n        const student = allStudents.find(s => s.id === permission.student_id)\n        const group = student ? groups.find(g => g.id === student.group_id) : undefined\n        return {\n          ...permission,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            permission_count: student.permission_count || 0,\n            group: group ? { name: group.name } : undefined\n          } : undefined\n        }\n      })\n\n      setPermissions(permissionsWithStudents)\n\n      // تحديث IndexedDB المحلية\n      if (permissionsData) {\n        await db.student_permissions.bulkPut(permissionsData.map(p => ({\n          id: p.id,\n          student_id: p.student_id,\n          permission_date: p.permission_date,\n          reason: p.reason,\n          guardian_notified: p.guardian_notified,\n          notes: p.notes || '',\n          created_at: p.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error in fetchPermissions:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const permissionDate = new Date().toISOString()\n      const currentCount = selectedStudent.permission_count || 0\n\n      // حفظ الاستئذان في Supabase\n      const { data: permissionData, error: permissionError } = await supabase\n        .from('student_permissions')\n        .insert({\n          student_id: selectedStudent.id,\n          permission_date: permissionDate,\n          reason: formData.reason,\n          notes: formData.notes,\n          guardian_notified: true\n        })\n        .select()\n        .single()\n\n      if (permissionError) {\n        console.error('Error saving permission:', permissionError)\n        throw permissionError\n      }\n\n      // تحديث حالة الطالب في Supabase\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({\n          status: 'استئذان',\n          permission_count: currentCount + 1\n        })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) {\n        console.error('Error updating student:', updateError)\n        throw updateError\n      }\n\n      // حفظ في IndexedDB المحلية\n      if (permissionData) {\n        await db.student_permissions.add({\n          id: permissionData.id,\n          student_id: permissionData.student_id,\n          permission_date: permissionData.permission_date,\n          reason: permissionData.reason,\n          guardian_notified: permissionData.guardian_notified,\n          notes: permissionData.notes || '',\n          created_at: permissionData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        status: 'استئذان',\n        permission_count: currentCount + 1\n      })\n\n      sendWhatsAppNotification(selectedStudent, formData.reason)\n\n      alert('تم تسجيل الاستئذان وإرسال رسالة لولي الأمر')\n      setFormData({ reason: '', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchPermissions(dateFilter)\n    } catch (error) {\n      console.error('Error saving permission:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  function sendWhatsAppNotification(student: Student, reason: string) {\n    if (!student.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const now = new Date()\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${student.name}\nالفصل: ${student.group?.name}\n\nنود إعلامكم بأن الطالب قد استأذن بالمغادرة من المدرسة.\n\n⏰ الوقت: ${now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n📅 التاريخ: ${now.toLocaleDateString('ar-SA')}\n📝 السبب: ${reason}\n\nيرجى استلام الطالب من المدرسة.\n\nمع تحيات إدارة المدرسة`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  function sendWhatsAppForPermission(permission: PermissionWithStudent) {\n    if (!permission.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(permission.student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const permissionDate = new Date(permission.permission_date)\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${permission.student.name}\nالفصل: ${permission.student.group?.name}\n\nنود إعلامكم بأن الطالب قد استأذن بالمغادرة من المدرسة.\n\n⏰ الوقت: ${permissionDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n📅 التاريخ: ${permissionDate.toLocaleDateString('ar-SA')}\n📝 السبب: ${permission.reason}\n\nيرجى استلام الطالب من المدرسة.\n\nمع تحيات إدارة المدرسة`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  async function printPermission(permission: PermissionWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    const permissionDate = new Date(permission.permission_date)\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>إذن مغادرة طالب</title>\n          <style>\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; }\n            .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }\n            .header h1 { margin: 0; color: #ea580c; }\n            .header .meta { color: #666; font-size: 12px; margin-top: 10px; }\n            .section { margin-bottom: 20px; }\n            .section label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }\n            .section div { padding: 10px; background: #fef3c7; border-radius: 5px; border: 1px solid #fcd34d; }\n            .time-box { background: #dbeafe; border: 1px solid #60a5fa; font-size: 18px; text-align: center; padding: 15px; }\n            @media print { body { padding: 20px; } }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>⚠️ إذن مغادرة طالب</h1>\n            ${teacherName ? `<div class=\"meta\">بواسطة: ${teacherName}</div>` : ''}\n          </div>\n          <div class=\"section\">\n            <label>اسم الطالب:</label>\n            <div>${permission.student?.name}</div>\n          </div>\n          <div class=\"section\">\n            <label>الفصل:</label>\n            <div>${permission.student?.group?.name || '-'}</div>\n          </div>\n          <div class=\"section\">\n            <label>⏰ وقت الاستئذان:</label>\n            <div class=\"time-box\">\n              ${permissionDate.toLocaleString('ar-SA', {\n                weekday: 'long',\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric',\n                hour: '2-digit',\n                minute: '2-digit'\n              })}\n            </div>\n          </div>\n          <div class=\"section\">\n            <label>سبب الاستئذان:</label>\n            <div>${permission.reason}</div>\n          </div>\n          ${permission.notes ? `\n          <div class=\"section\">\n            <label>ملاحظات:</label>\n            <div>${permission.notes}</div>\n          </div>\n          ` : ''}\n          <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px dashed #ccc;\">\n            <p style=\"text-align: center; color: #666; font-size: 14px;\">\n              تم إشعار ولي الأمر عبر واتساب<br>\n              الرجاء التأكد من استلام الطالب من قبل ولي الأمر\n            </p>\n          </div>\n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  async function returnStudent(permission: PermissionWithStudent) {\n    if (!permission.student) return\n\n    const confirmReturn = confirm(`هل تريد تأكيد عودة الطالب: ${permission.student.name}؟`)\n    if (!confirmReturn) return\n\n    try {\n      // تحديث في Supabase\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ status: 'نشط' })\n        .eq('id', permission.student_id)\n\n      if (updateError) {\n        console.error('Error updating student:', updateError)\n        throw updateError\n      }\n\n      // تحديث في IndexedDB\n      await db.students.update(permission.student_id, { status: 'نشط' })\n\n      alert('تم تأكيد عودة الطالب')\n      fetchStudents()\n      fetchPermissions(dateFilter)\n    } catch (error) {\n      console.error('Error updating student status:', error)\n      alert('حدث خطأ أثناء تحديث الحالة')\n    }\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <LogOut size={28} className=\"text-orange-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">الاستئذان</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-orange-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-orange-600 font-semibold mt-1\">\n                      عدد الاستئذانات: {student.permission_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-orange-50 rounded-lg p-4 border border-orange-200\">\n                <h3 className=\"font-bold text-orange-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد الاستئذانات السابقة:</span>\n                    <span className=\"text-orange-600 font-bold mr-2\">{selectedStudent.permission_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  سبب الاستئذان\n                </label>\n                <textarea\n                  required\n                  value={formData.reason}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب سبب الاستئذان...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل الاستئذان وإشعار ولي الأمر'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <Clock size={24} />\n            سجل الاستئذانات {dateFilter ? 'المفلترة' : 'اليوم'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchPermissions(dateFilter)}\n                className=\"px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchPermissions()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-orange-600 font-semibold mt-3\">\n                عرض الاستئذانات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {permissions.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد استئذانات {dateFilter ? 'في هذا التاريخ' : 'اليوم'}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {permissions.map(permission => (\n              <div key={permission.id} className=\"border border-orange-200 rounded-lg p-4 bg-orange-50\">\n                <div className=\"flex justify-between items-start mb-3\">\n                  <div>\n                    <h4 className=\"font-bold text-gray-800\">{permission.student?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">{permission.student?.group?.name}</p>\n                    <p className=\"text-sm text-orange-600 font-semibold mt-1\">\n                      <Clock size={14} className=\"inline ml-1\" />\n                      {new Date(permission.permission_date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      onClick={() => printPermission(permission)}\n                      className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Printer size={16} />\n                      طباعة\n                    </button>\n                    <button\n                      onClick={() => sendWhatsAppForPermission(permission)}\n                      className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Send size={16} />\n                      واتساب\n                    </button>\n                    <button\n                      onClick={() => returnStudent(permission)}\n                      className=\"px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors\"\n                    >\n                      عودة الطالب\n                    </button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div><span className=\"font-semibold\">السبب:</span> {permission.reason}</div>\n                  {permission.notes && (\n                    <div className=\"text-gray-600\">\n                      <span className=\"font-semibold\">ملاحظات:</span> {permission.notes}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":24168},"server/storage.ts":{"content":"import type {\n  Student, InsertStudent,\n  Group, InsertGroup,\n  SpecialStatus, InsertSpecialStatus,\n  Teacher, InsertTeacher,\n  TeacherGroup, InsertTeacherGroup,\n  StudentVisit, InsertStudentVisit,\n  StudentPermission, InsertStudentPermission,\n  StudentViolation, InsertStudentViolation,\n  TeacherProfile, InsertTeacherProfile,\n  LoginCredentials, InsertLoginCredentials\n} from \"../shared/schema.js\";\n\nexport interface IStorage {\n  // Groups\n  getGroups(): Promise<Group[]>;\n  getGroupById(id: string): Promise<Group | undefined>;\n  createGroup(group: InsertGroup): Promise<Group>;\n  updateGroup(id: string, group: Partial<InsertGroup>): Promise<Group | undefined>;\n  deleteGroup(id: string): Promise<boolean>;\n\n  // Special Statuses\n  getSpecialStatuses(): Promise<SpecialStatus[]>;\n  getSpecialStatusById(id: string): Promise<SpecialStatus | undefined>;\n  createSpecialStatus(status: InsertSpecialStatus): Promise<SpecialStatus>;\n  updateSpecialStatus(id: string, status: Partial<InsertSpecialStatus>): Promise<SpecialStatus | undefined>;\n  deleteSpecialStatus(id: string): Promise<boolean>;\n\n  // Students\n  getStudents(): Promise<Student[]>;\n  getStudentById(id: string): Promise<Student | undefined>;\n  createStudent(student: InsertStudent): Promise<Student>;\n  updateStudent(id: string, student: Partial<InsertStudent>): Promise<Student | undefined>;\n  deleteStudent(id: string): Promise<boolean>;\n  createManyStudents(students: InsertStudent[]): Promise<Student[]>;\n\n  // Teachers\n  getTeachers(): Promise<Teacher[]>;\n  getTeacherById(id: string): Promise<Teacher | undefined>;\n  createTeacher(teacher: InsertTeacher): Promise<Teacher>;\n  updateTeacher(id: string, teacher: Partial<InsertTeacher>): Promise<Teacher | undefined>;\n  deleteTeacher(id: string): Promise<boolean>;\n\n  // Teacher Groups\n  getTeacherGroups(): Promise<TeacherGroup[]>;\n  getTeacherGroupsByTeacherId(teacherId: string): Promise<TeacherGroup[]>;\n  createTeacherGroup(teacherGroup: InsertTeacherGroup): Promise<TeacherGroup>;\n  deleteTeacherGroup(id: string): Promise<boolean>;\n\n  // Student Visits\n  getStudentVisits(): Promise<StudentVisit[]>;\n  getStudentVisitsByStudentId(studentId: string): Promise<StudentVisit[]>;\n  createStudentVisit(visit: InsertStudentVisit): Promise<StudentVisit>;\n  deleteStudentVisit(id: string): Promise<boolean>;\n\n  // Student Permissions\n  getStudentPermissions(): Promise<StudentPermission[]>;\n  getStudentPermissionsByStudentId(studentId: string): Promise<StudentPermission[]>;\n  createStudentPermission(permission: InsertStudentPermission): Promise<StudentPermission>;\n  deleteStudentPermission(id: string): Promise<boolean>;\n\n  // Student Violations\n  getStudentViolations(): Promise<StudentViolation[]>;\n  getStudentViolationsByStudentId(studentId: string): Promise<StudentViolation[]>;\n  createStudentViolation(violation: InsertStudentViolation): Promise<StudentViolation>;\n  deleteStudentViolation(id: string): Promise<boolean>;\n\n  // Teacher Profile\n  getTeacherProfile(): Promise<TeacherProfile | undefined>;\n  createOrUpdateTeacherProfile(profile: InsertTeacherProfile): Promise<TeacherProfile>;\n\n  // Login Credentials\n  getLoginCredentials(username: string): Promise<LoginCredentials | undefined>;\n  createLoginCredentials(credentials: InsertLoginCredentials): Promise<LoginCredentials>;\n  updateLoginCredentials(id: string, credentials: Partial<InsertLoginCredentials>): Promise<LoginCredentials | undefined>;\n  \n  // Password Reset\n  createPasswordResetToken(username: string): Promise<{ token: string, expiresAt: string } | null>;\n  verifyPasswordResetToken(username: string, token: string): Promise<boolean>;\n  resetPassword(username: string, token: string, newPassword: string): Promise<boolean>;\n\n  // Clear Database\n  clearDatabase(): Promise<void>;\n  \n  // Import Data (preserves IDs)\n  importData(data: any): Promise<void>;\n}\n","size_bytes":3859},"client/src/lib/db.ts":{"content":"import Dexie, { Table } from 'dexie'\nimport { Student, Group, SpecialStatus, Teacher } from '../types'\n\nexport interface StudentVisit {\n  id?: string\n  student_id: string\n  visit_date: string\n  reason: string\n  action_taken: string\n  referred_to: string\n  notes?: string\n  created_at?: string\n}\n\nexport interface StudentPermission {\n  id?: string\n  student_id: string\n  permission_date: string\n  reason: string\n  guardian_notified?: boolean\n  notes?: string\n  created_at?: string\n}\n\nexport interface StudentViolation {\n  id?: string\n  student_id: string\n  violation_type: string\n  violation_date: string\n  description?: string\n  action_taken?: string\n  notes?: string\n  created_at?: string\n}\n\nexport interface TeacherProfile {\n  id?: string\n  name?: string\n  school_name?: string\n  logo_url?: string\n  created_at?: string\n}\n\nexport interface LoginCredentials {\n  id?: string\n  username: string\n  password_hash: string\n  reset_token?: string | null\n  reset_token_expires?: string | null\n  created_at?: string\n  updated_at?: string\n}\n\nexport interface TeacherGroup {\n  id?: string\n  teacher_id?: string\n  group_id?: string\n  created_at?: string\n}\n\nexport class StudentsDatabase extends Dexie {\n  groups!: Table<Group>\n  students!: Table<Student>\n  special_statuses!: Table<SpecialStatus>\n  student_visits!: Table<StudentVisit>\n  student_permissions!: Table<StudentPermission>\n  student_violations!: Table<StudentViolation>\n  teacher_profile!: Table<TeacherProfile>\n  login_credentials!: Table<LoginCredentials>\n  teachers!: Table<Teacher>\n  teacher_groups!: Table<TeacherGroup>\n\n  constructor() {\n    super('StudentsDatabase')\n    this.version(6).stores({\n      groups: 'id, name, stage, display_order',\n      students: 'id, student_id, name, group_id, has_permission, special_status',\n      special_statuses: 'id, name',\n      student_visits: 'id, student_id, visit_date',\n      student_permissions: 'id, student_id, permission_date',\n      student_violations: 'id, student_id, violation_date',\n      teacher_profile: 'id',\n      login_credentials: 'id, username',\n      teachers: 'id, phone, name',\n      teacher_groups: 'id, teacher_id, group_id'\n    }).upgrade(trans => {\n      return trans.table('groups').toCollection().modify(group => {\n        if (group.display_order === undefined) {\n          group.display_order = 999\n        }\n      })\n    })\n  }\n}\n\nexport const db = new StudentsDatabase()\n\n// Initialize default login credentials\ndb.on('ready', async () => {\n  const count = await db.login_credentials.count()\n  if (count === 0) {\n    await db.login_credentials.add({\n      id: crypto.randomUUID(),\n      username: 'admin',\n      password_hash: 'admin123',\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString()\n    })\n  }\n})\n","size_bytes":2770},"Erchad-1/server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"../shared/schema.js\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":488},"Erchad-1/server/dbStorage.ts":{"content":"import { db } from \"./db.js\";\nimport { eq, desc, sql } from \"drizzle-orm\";\nimport {\n  students, groups, specialStatuses, teachers, teacherGroups,\n  studentVisits, studentPermissions, studentViolations,\n  teacherProfile, loginCredentials,\n  type Student, type InsertStudent,\n  type Group, type InsertGroup,\n  type SpecialStatus, type InsertSpecialStatus,\n  type Teacher, type InsertTeacher,\n  type TeacherGroup, type InsertTeacherGroup,\n  type StudentVisit, type InsertStudentVisit,\n  type StudentPermission, type InsertStudentPermission,\n  type StudentViolation, type InsertStudentViolation,\n  type TeacherProfile, type InsertTeacherProfile,\n  type LoginCredentials, type InsertLoginCredentials\n} from \"../shared/schema.js\";\nimport type { IStorage } from \"./storage.js\";\n\nexport class DbStorage implements IStorage {\n  async getGroups(): Promise<Group[]> {\n    return await db.select().from(groups).orderBy(groups.stage, groups.displayOrder);\n  }\n\n  async getGroupById(id: string): Promise<Group | undefined> {\n    const result = await db.select().from(groups).where(eq(groups.id, id));\n    return result[0];\n  }\n\n  async createGroup(group: InsertGroup): Promise<Group> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(groups).values({ ...group, id }).returning();\n    return result[0];\n  }\n\n  async updateGroup(id: string, group: Partial<InsertGroup>): Promise<Group | undefined> {\n    const result = await db.update(groups).set(group).where(eq(groups.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteGroup(id: string): Promise<boolean> {\n    try {\n      // أولاً: إزالة ارتباط الطلاب بالمجموعة\n      await db.update(students)\n        .set({ groupId: null })\n        .where(eq(students.groupId, id));\n      \n      // ثانياً: إزالة ارتباط المعلمين بالمجموعة\n      await db.delete(teacherGroups).where(eq(teacherGroups.groupId, id));\n      \n      // ثالثاً: حذف المجموعة\n      const result = await db.delete(groups).where(eq(groups.id, id));\n      return result.rowCount ? result.rowCount > 0 : false;\n    } catch (error) {\n      console.error('Error deleting group:', error);\n      return false;\n    }\n  }\n\n  async getSpecialStatuses(): Promise<SpecialStatus[]> {\n    return await db.select().from(specialStatuses).orderBy(specialStatuses.name);\n  }\n\n  async getSpecialStatusById(id: string): Promise<SpecialStatus | undefined> {\n    const result = await db.select().from(specialStatuses).where(eq(specialStatuses.id, id));\n    return result[0];\n  }\n\n  async createSpecialStatus(status: InsertSpecialStatus): Promise<SpecialStatus> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(specialStatuses).values({ ...status, id }).returning();\n    return result[0];\n  }\n\n  async updateSpecialStatus(id: string, status: Partial<InsertSpecialStatus>): Promise<SpecialStatus | undefined> {\n    const result = await db.update(specialStatuses).set(status).where(eq(specialStatuses.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteSpecialStatus(id: string): Promise<boolean> {\n    const result = await db.delete(specialStatuses).where(eq(specialStatuses.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getStudents(): Promise<Student[]> {\n    return await db.select().from(students).orderBy(students.name);\n  }\n\n  async getStudentById(id: string): Promise<Student | undefined> {\n    const result = await db.select().from(students).where(eq(students.id, id));\n    return result[0];\n  }\n\n  async createStudent(student: InsertStudent): Promise<Student> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const result = await db.insert(students).values({ ...student, id, createdAt: now, updatedAt: now }).returning();\n    return result[0];\n  }\n\n  async updateStudent(id: string, student: Partial<InsertStudent>): Promise<Student | undefined> {\n    const now = new Date();\n    const result = await db.update(students).set({ ...student, updatedAt: now }).where(eq(students.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteStudent(id: string): Promise<boolean> {\n    const result = await db.delete(students).where(eq(students.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async createManyStudents(studentsData: InsertStudent[]): Promise<Student[]> {\n    const now = new Date();\n    const studentsWithIds = studentsData.map(s => ({\n      ...s,\n      id: crypto.randomUUID(),\n      createdAt: now,\n      updatedAt: now\n    }));\n    const result = await db.insert(students).values(studentsWithIds).returning();\n    return result;\n  }\n\n  async getTeachers(): Promise<Teacher[]> {\n    return await db.select().from(teachers).orderBy(teachers.name);\n  }\n\n  async getTeacherById(id: string): Promise<Teacher | undefined> {\n    const result = await db.select().from(teachers).where(eq(teachers.id, id));\n    return result[0];\n  }\n\n  async createTeacher(teacher: InsertTeacher): Promise<Teacher> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const result = await db.insert(teachers).values({ ...teacher, id, createdAt: now, updatedAt: now }).returning();\n    return result[0];\n  }\n\n  async updateTeacher(id: string, teacher: Partial<InsertTeacher>): Promise<Teacher | undefined> {\n    const now = new Date();\n    const result = await db.update(teachers).set({ ...teacher, updatedAt: now }).where(eq(teachers.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteTeacher(id: string): Promise<boolean> {\n    const result = await db.delete(teachers).where(eq(teachers.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getTeacherGroups(): Promise<TeacherGroup[]> {\n    return await db.select().from(teacherGroups);\n  }\n\n  async getTeacherGroupsByTeacherId(teacherId: string): Promise<TeacherGroup[]> {\n    return await db.select().from(teacherGroups).where(eq(teacherGroups.teacherId, teacherId));\n  }\n\n  async createTeacherGroup(teacherGroup: InsertTeacherGroup): Promise<TeacherGroup> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(teacherGroups).values({ ...teacherGroup, id }).returning();\n    return result[0];\n  }\n\n  async deleteTeacherGroup(id: string): Promise<boolean> {\n    const result = await db.delete(teacherGroups).where(eq(teacherGroups.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getStudentVisits(): Promise<StudentVisit[]> {\n    return await db.select().from(studentVisits).orderBy(desc(studentVisits.visitDate));\n  }\n\n  async getStudentVisitsByStudentId(studentId: string): Promise<StudentVisit[]> {\n    return await db.select().from(studentVisits).where(eq(studentVisits.studentId, studentId)).orderBy(desc(studentVisits.visitDate));\n  }\n\n  async createStudentVisit(visit: InsertStudentVisit): Promise<StudentVisit> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(studentVisits).values({ ...visit, id }).returning();\n    \n    // تحديث عداد الزيارات للطالب (atomic increment لتجنب race conditions)\n    if (visit.studentId) {\n      await db.update(students)\n        .set({ visitCount: sql`COALESCE(${students.visitCount}, 0) + 1` })\n        .where(eq(students.id, visit.studentId));\n    }\n    \n    return result[0];\n  }\n\n  async deleteStudentVisit(id: string): Promise<boolean> {\n    try {\n      // جلب الزيارة أولاً لمعرفة الطالب\n      const visits = await db.select().from(studentVisits).where(eq(studentVisits.id, id));\n      const visit = visits[0];\n      \n      if (!visit) return false;\n      \n      // حذف الزيارة\n      const result = await db.delete(studentVisits).where(eq(studentVisits.id, id));\n      \n      // تحديث عداد الزيارات للطالب (تقليل بواحد)\n      if (visit.studentId && result.rowCount && result.rowCount > 0) {\n        await db.update(students)\n          .set({ visitCount: sql`GREATEST(COALESCE(${students.visitCount}, 0) - 1, 0)` })\n          .where(eq(students.id, visit.studentId));\n      }\n      \n      return result.rowCount ? result.rowCount > 0 : false;\n    } catch (error) {\n      console.error('Error deleting student visit:', error);\n      return false;\n    }\n  }\n\n  async getStudentPermissions(): Promise<StudentPermission[]> {\n    return await db.select().from(studentPermissions).orderBy(desc(studentPermissions.permissionDate));\n  }\n\n  async getStudentPermissionsByStudentId(studentId: string): Promise<StudentPermission[]> {\n    return await db.select().from(studentPermissions).where(eq(studentPermissions.studentId, studentId)).orderBy(desc(studentPermissions.permissionDate));\n  }\n\n  async createStudentPermission(permission: InsertStudentPermission): Promise<StudentPermission> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(studentPermissions).values({ ...permission, id }).returning();\n    return result[0];\n  }\n\n  async deleteStudentPermission(id: string): Promise<boolean> {\n    const result = await db.delete(studentPermissions).where(eq(studentPermissions.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getStudentViolations(): Promise<StudentViolation[]> {\n    return await db.select().from(studentViolations).orderBy(desc(studentViolations.violationDate));\n  }\n\n  async getStudentViolationsByStudentId(studentId: string): Promise<StudentViolation[]> {\n    return await db.select().from(studentViolations).where(eq(studentViolations.studentId, studentId)).orderBy(desc(studentViolations.violationDate));\n  }\n\n  async createStudentViolation(violation: InsertStudentViolation): Promise<StudentViolation> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(studentViolations).values({ ...violation, id }).returning();\n    return result[0];\n  }\n\n  async deleteStudentViolation(id: string): Promise<boolean> {\n    const result = await db.delete(studentViolations).where(eq(studentViolations.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getTeacherProfile(): Promise<TeacherProfile | undefined> {\n    const result = await db.select().from(teacherProfile);\n    return result[0];\n  }\n\n  async createOrUpdateTeacherProfile(profile: InsertTeacherProfile): Promise<TeacherProfile> {\n    const existing = await this.getTeacherProfile();\n    if (existing) {\n      const result = await db.update(teacherProfile).set(profile).where(eq(teacherProfile.id, existing.id)).returning();\n      return result[0];\n    } else {\n      const id = crypto.randomUUID();\n      const result = await db.insert(teacherProfile).values({ ...profile, id }).returning();\n      return result[0];\n    }\n  }\n\n  async getLoginCredentials(username: string): Promise<LoginCredentials | undefined> {\n    const result = await db.select().from(loginCredentials).where(eq(loginCredentials.username, username));\n    return result[0];\n  }\n\n  async createLoginCredentials(credentials: InsertLoginCredentials): Promise<LoginCredentials> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const result = await db.insert(loginCredentials).values({ ...credentials, id, createdAt: now, updatedAt: now }).returning();\n    return result[0];\n  }\n\n  async updateLoginCredentials(id: string, credentials: Partial<InsertLoginCredentials>): Promise<LoginCredentials | undefined> {\n    const now = new Date();\n    const result = await db.update(loginCredentials).set({ ...credentials, updatedAt: now }).where(eq(loginCredentials.id, id)).returning();\n    return result[0];\n  }\n\n  async clearDatabase(): Promise<void> {\n    // حذف جميع البيانات من الجداول بالترتيب الصحيح\n    await db.delete(studentViolations);\n    await db.delete(studentPermissions);\n    await db.delete(studentVisits);\n    await db.delete(teacherGroups);\n    await db.delete(students);\n    await db.delete(teachers);\n    await db.delete(specialStatuses);\n    await db.delete(groups);\n  }\n\n  async createPasswordResetToken(username: string): Promise<{ token: string, expiresAt: string } | null> {\n    const user = await this.getLoginCredentials(username);\n    if (!user) return null;\n\n    // إنشاء رمز عشوائي مكون من 6 أرقام\n    const token = Math.floor(100000 + Math.random() * 900000).toString();\n    \n    // انتهاء الرمز بعد ساعة واحدة\n    const expiresAt = new Date(Date.now() + 60 * 60 * 1000).toISOString();\n\n    await db.update(loginCredentials)\n      .set({ resetToken: token, resetTokenExpires: expiresAt, updatedAt: new Date() })\n      .where(eq(loginCredentials.id, user.id));\n\n    return { token, expiresAt };\n  }\n\n  async verifyPasswordResetToken(username: string, token: string): Promise<boolean> {\n    const user = await this.getLoginCredentials(username);\n    if (!user || !user.resetToken || !user.resetTokenExpires) return false;\n\n    // التحقق من صحة الرمز\n    if (user.resetToken !== token) return false;\n\n    // التحقق من عدم انتهاء صلاحية الرمز\n    const expiresAt = new Date(user.resetTokenExpires);\n    if (expiresAt < new Date()) return false;\n\n    return true;\n  }\n\n  async resetPassword(username: string, token: string, newPassword: string): Promise<boolean> {\n    const isValid = await this.verifyPasswordResetToken(username, token);\n    if (!isValid) return false;\n\n    const user = await this.getLoginCredentials(username);\n    if (!user) return false;\n\n    // تحديث كلمة المرور وحذف الرمز\n    await db.update(loginCredentials)\n      .set({ \n        passwordHash: newPassword, \n        resetToken: null, \n        resetTokenExpires: null,\n        updatedAt: new Date() \n      })\n      .where(eq(loginCredentials.id, user.id));\n\n    return true;\n  }\n}\n\nexport const storage = new DbStorage();\n","size_bytes":13851},"Erchad-1/client/src/components/AllowClassEntryModal.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { X, Send, DoorOpen } from 'lucide-react'\nimport { Teacher, Student } from '../types'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface AllowClassEntryModalProps {\n  isOpen: boolean\n  onClose: () => void\n  student: Student | null\n}\n\nexport function AllowClassEntryModal({\n  isOpen,\n  onClose,\n  student,\n}: AllowClassEntryModalProps) {\n  const [teachers, setTeachers] = useState<Teacher[]>([])\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [counselorName, setCounselorName] = useState('')\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchTeachers()\n      fetchCounselorInfo()\n    }\n  }, [isOpen])\n\n  const fetchTeachers = async () => {\n    const { data } = await supabase\n      .from('teachers')\n      .select('*')\n      .order('name')\n\n    if (data) setTeachers(data)\n  }\n\n  const fetchCounselorInfo = async () => {\n    const { data } = await supabase\n      .from('teacher_profile')\n      .select('name')\n      .maybeSingle()\n\n    if (data) {\n      setCounselorName(data.name || '')\n    }\n  }\n\n  const handleSend = async () => {\n    if (!selectedTeacherId || !student) {\n      alert('الرجاء اختيار المعلم')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const teacher = teachers.find(t => t.id === selectedTeacherId)\n      if (!teacher) return\n\n      // إنشاء رسالة السماح بالدخول\n      let message = `✅ *السماح بدخول الطالب للفصل*\\n\\n`\n      message += `اسم الطالب: *${student.name}*\\n\\n`\n      message += `المرسل: ${counselorName || 'المرشد الطلابي'}`\n\n      // فتح واتساب\n      const encodedMessage = encodeURIComponent(message)\n      const phoneNumber = formatPhoneForWhatsApp(teacher.phone)\n      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`\n\n      window.open(whatsappUrl, '_blank')\n\n      onClose()\n    } catch (error) {\n      console.error('Error sending entry permission:', error)\n      alert('حدث خطأ أثناء الإرسال')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (!isOpen || !student) return null\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <DoorOpen className=\"text-white\" size={24} />\n            <h2 className=\"text-2xl font-bold text-white\">السماح بدخول الفصل</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-4 border-2 border-blue-200\">\n            <h3 className=\"font-bold text-blue-900 mb-2\">معلومات الطالب:</h3>\n            <div className=\"space-y-1 text-sm text-blue-900\">\n              <p><strong>الاسم:</strong> {student.name}</p>\n              <p><strong>السجل المدني:</strong> {student.national_id}</p>\n              <p><strong>الصف:</strong> {student.grade}</p>\n              <p><strong>المجموعة:</strong> {student.group?.name || '-'}</p>\n            </div>\n          </div>\n\n          <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n            <p className=\"text-sm text-blue-800\">\n              سيتم إرسال رسالة السماح بدخول الطالب للفصل إلى المعلم المختار عبر واتساب\n            </p>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المعلم\n            </label>\n            <select\n              value={selectedTeacherId}\n              onChange={(e) => setSelectedTeacherId(e.target.value)}\n              className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n            >\n              <option value=\"\">-- اختر المعلم --</option>\n              {teachers.map((teacher) => (\n                <option key={teacher.id} value={teacher.id}>\n                  {teacher.name} - {teacher.specialization} ({teacher.phone})\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\n            <h4 className=\"font-semibold text-gray-900 mb-2\">معاينة الرسالة:</h4>\n            <div className=\"text-sm text-gray-700 whitespace-pre-line space-y-2\">\n              <p className=\"text-blue-600 font-bold\">✅ السماح بدخول الطالب للفصل</p>\n              <p>اسم الطالب: <strong>{student.name}</strong></p>\n              <p>المرسل: {counselorName || 'المرشد الطلابي'}</p>\n            </div>\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              onClick={handleSend}\n              disabled={loading || !selectedTeacherId}\n              className=\"flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-400 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md\"\n            >\n              <Send size={20} />\n              {loading ? 'جاري الإرسال...' : 'إرسال عبر واتساب'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6199},"Erchad-1/eslint.config.js":{"content":"import js from '@eslint/js';\nimport globals from 'globals';\nimport reactHooks from 'eslint-plugin-react-hooks';\nimport reactRefresh from 'eslint-plugin-react-refresh';\nimport tseslint from 'typescript-eslint';\n\nexport default tseslint.config(\n  { ignores: ['dist'] },\n  {\n    extends: [js.configs.recommended, ...tseslint.configs.recommended],\n    files: ['**/*.{ts,tsx}'],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: globals.browser,\n    },\n    plugins: {\n      'react-hooks': reactHooks,\n      'react-refresh': reactRefresh,\n    },\n    rules: {\n      ...reactHooks.configs.recommended.rules,\n      'react-refresh/only-export-components': [\n        'warn',\n        { allowConstantExport: true },\n      ],\n    },\n  }\n);\n","size_bytes":739},"client/src/components/ExcelImport.tsx":{"content":"import { useState, useRef } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db } from '../lib/db'\nimport { Upload, AlertCircle, Users, GraduationCap, X } from 'lucide-react'\nimport * as XLSX from 'xlsx'\n\ninterface ExcelImportProps {\n  groups?: Array<{ id: string; name: string }>\n  onImportComplete: () => void\n}\n\ntype ImportType = 'students' | 'teachers'\n\nexport function ExcelImport({ groups, onImportComplete }: ExcelImportProps) {\n  const studentsFileInputRef = useRef<HTMLInputElement>(null)\n  const teachersFileInputRef = useRef<HTMLInputElement>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  const handleStudentsImport = async (\n    event: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const arrayBuffer = await file.arrayBuffer()\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const sheetName = workbook.SheetNames[0]\n      const worksheet = workbook.Sheets[sheetName]\n      const data = XLSX.utils.sheet_to_json(worksheet)\n\n      if (!data || data.length === 0) {\n        throw new Error('الملف فارغ أو صيغته غير صحيحة')\n      }\n\n      // التحقق من وجود الأعمدة المطلوبة للطلاب\n      const requiredColumns = ['اسم الطالب', 'السجل المدني', 'الصف', 'المجموعة']\n      const firstRow = data[0] as any\n      const missingColumns = requiredColumns.filter(col => !(col in firstRow))\n\n      if (missingColumns.length > 0) {\n        throw new Error(`الملف يفتقد الأعمدة التالية: ${missingColumns.join('، ')}\\n\\nالأعمدة المطلوبة:\\n- اسم الطالب\\n- السجل المدني\\n- الصف\\n- المجموعة\\n- جوال الطالب (اختياري)\\n- جوال ولي الامر (اختياري)\\n- الحالة (اختياري)`)\n      }\n\n      // استخراج المجموعات الفريدة مع المراحل من الملف\n      const uniqueGroups = [\n        ...new Map(\n          data\n            .filter((row: any) => row['المجموعة'] && row['الصف'])\n            .map((row: any) => {\n              const stage = String(row['الصف'] || '').trim()\n              const name = String(row['المجموعة'] || '').trim()\n              return [`${stage}|${name}`, { stage, name }]\n            })\n            .filter(([key, group]: any) => group.stage && group.name)\n        ).values(),\n      ]\n\n      // جلب المجموعات الموجودة حالياً\n      const { data: existingGroups, error: fetchError } = await supabase\n        .from('groups')\n        .select('id, name, stage')\n\n      if (fetchError) throw fetchError\n\n      const existingGroupsMap = new Map(\n        (existingGroups || []).map((g) => [`${g.stage}|${g.name}`, g.id])\n      )\n\n      // إنشاء المجموعات الجديدة فقط\n      const newGroups = uniqueGroups.filter(\n        (group) => !existingGroupsMap.has(`${group.stage}|${group.name}`)\n      )\n\n      if (newGroups.length > 0) {\n        for (const group of newGroups) {\n          try {\n            const newId = crypto.randomUUID()\n            const newGroup = {\n              id: newId,\n              stage: group.stage,\n              name: group.name,\n              display_order: 0,\n              created_at: new Date().toISOString()\n            }\n\n            const { error: insertGroupError } = await supabase\n              .from('groups')\n              .insert(newGroup)\n\n            if (insertGroupError) {\n              console.error('Error creating group:', insertGroupError)\n              throw new Error(`فشل في إنشاء المجموعة \"${group.name}\" في \"${group.stage}\": ${insertGroupError.message}`)\n            }\n\n            existingGroupsMap.set(`${group.stage}|${group.name}`, newId)\n            await db.groups.put(newGroup)\n          } catch (err) {\n            console.error('Error in group creation:', err)\n            throw err\n          }\n        }\n      }\n\n      // جلب الطلاب الموجودين للتحقق من التحديث أو الإضافة\n      const { data: existingStudents, error: studentsError } = await supabase\n        .from('students')\n        .select('id, national_id')\n\n      if (studentsError) throw studentsError\n\n      const existingStudentsMap = new Map(\n        (existingStudents || []).map((s) => [s.national_id, s.id])\n      )\n\n      const insertData: any[] = []\n      const updateData: any[] = []\n      const seenNationalIds = new Set<string>()\n      const duplicatesInFile: string[] = []\n\n      data\n        .filter((row: any) => row['اسم الطالب'] && row['السجل المدني'])\n        .forEach((row: any) => {\n          const stage = String(row['الصف'] || '').trim()\n          const groupName = String(row['المجموعة'] || '').trim()\n\n          if (!stage || !groupName) {\n            console.warn('تخطي طالب بدون صف أو مجموعة:', row)\n            return\n          }\n\n          const groupKey = `${stage}|${groupName}`\n          const groupId = existingGroupsMap.get(groupKey)\n\n          if (!groupId) {\n            console.error('المجموعة غير موجودة:', { stage, groupName, groupKey })\n            console.error('المجموعات المتاحة:', Array.from(existingGroupsMap.keys()))\n            throw new Error(`المجموعة \"${groupName}\" في \"${stage}\" غير موجودة`)\n          }\n\n          const nationalId = String(row['السجل المدني']).trim()\n\n          // التحقق من التكرار في الملف نفسه\n          if (seenNationalIds.has(nationalId)) {\n            duplicatesInFile.push(`${String(row['اسم الطالب']).trim()} (${nationalId})`)\n            return\n          }\n          seenNationalIds.add(nationalId)\n\n          const studentData = {\n            name: String(row['اسم الطالب']).trim(),\n            national_id: nationalId,\n            phone: row['جوال الطالب'] ? String(row['جوال الطالب']).trim() : null,\n            guardian_phone: (row['جوال ولي الامر'] || row['جوالي ولي الامر'] || row['جوال ولي الأمر'])\n              ? String(row['جوال ولي الامر'] || row['جوالي ولي الامر'] || row['جوال ولي الأمر']).trim()\n              : null,\n            grade: stage,\n            group_id: groupId,\n            status: row['الحالة'] && String(row['الحالة']).trim() === 'استئذان' ? 'استئذان' : 'نشط',\n            special_status_id: null,\n          }\n\n          const existingStudentId = existingStudentsMap.get(nationalId)\n          if (existingStudentId) {\n            updateData.push({ id: existingStudentId, ...studentData })\n          } else {\n            insertData.push(studentData)\n          }\n        })\n\n      // إذا كان هناك تكرارات في الملف، اعرض تحذير\n      if (duplicatesInFile.length > 0) {\n        console.warn('طلاب مكررين في الملف:', duplicatesInFile)\n        setError(`تنبيه: تم تخطي ${duplicatesInFile.length} طالب مكرر في الملف:\\n${duplicatesInFile.slice(0, 5).join('\\n')}${duplicatesInFile.length > 5 ? '\\n...' : ''}`)\n      }\n\n      // إضافة الطلاب الجدد واحد بواحد\n      let insertedCount = 0\n      let skippedCount = 0\n\n      for (const studentData of insertData) {\n        try {\n          const { data: insertedStudent, error: insertError } = await supabase\n            .from('students')\n            .insert(studentData)\n            .select()\n            .maybeSingle()\n\n          if (insertError) {\n            if (insertError.code === '23505' && insertError.message.includes('students_national_id_key')) {\n              console.warn(`طالب موجود مسبقاً: ${studentData.name} (${studentData.national_id})`)\n              skippedCount++\n              continue\n            }\n            throw insertError\n          }\n\n          if (insertedStudent) {\n            insertedCount++\n            await db.students.put(insertedStudent)\n          }\n        } catch (err) {\n          console.error('خطأ في إضافة الطالب:', studentData.name, err)\n          skippedCount++\n        }\n      }\n\n      // تحديث الطلاب الموجودين\n      let updatedCount = 0\n      for (const student of updateData) {\n        const { id, ...updateFields } = student\n        const { error: updateError } = await supabase\n          .from('students')\n          .update(updateFields)\n          .eq('id', id)\n\n        if (!updateError) {\n          updatedCount++\n          await db.students.update(id, updateFields)\n        }\n      }\n\n      // رسالة النجاح\n      const messages: string[] = []\n\n      if (insertedCount > 0) {\n        messages.push(`تم إضافة ${insertedCount} طالب جديد`)\n      }\n\n      if (updatedCount > 0) {\n        messages.push(`تم تحديث ${updatedCount} طالب`)\n      }\n\n      if (skippedCount > 0) {\n        messages.push(`تم تخطي ${skippedCount} طالب موجود مسبقاً`)\n      }\n\n      if (newGroups.length > 0) {\n        messages.push(`تم إنشاء ${newGroups.length} مجموعة جديدة`)\n      }\n\n      setSuccess(\n        messages.length > 0 ? messages.join(' • ') : 'تمت العملية بنجاح'\n      )\n      if (studentsFileInputRef.current) {\n        studentsFileInputRef.current.value = ''\n      }\n      onImportComplete()\n    } catch (err) {\n      console.error('خطأ في استيراد الطلاب:', err)\n      const errorMessage = err instanceof Error ? err.message : 'حدث خطأ ما'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleTeachersImport = async (\n    event: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const arrayBuffer = await file.arrayBuffer()\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const sheetName = workbook.SheetNames[0]\n      const worksheet = workbook.Sheets[sheetName]\n      const data = XLSX.utils.sheet_to_json(worksheet)\n\n      if (!data || data.length === 0) {\n        throw new Error('الملف فارغ أو صيغته غير صحيحة')\n      }\n\n      // التحقق من وجود الأعمدة المطلوبة للمعلمين\n      const requiredColumns = ['اسم المعلم', 'رقم جوال المعلم']\n      const firstRow = data[0] as any\n      const missingColumns = requiredColumns.filter(col => !(col in firstRow))\n\n      if (missingColumns.length > 0) {\n        throw new Error(`الملف يفتقد الأعمدة التالية: ${missingColumns.join('، ')}\\n\\nالأعمدة المطلوبة:\\n- اسم المعلم\\n- رقم جوال المعلم\\n- التخصص (اختياري)`)\n      }\n\n      // استيراد المعلمين\n      const teachersData = data\n        .filter((row: any) => row['اسم المعلم'] && row['رقم جوال المعلم'])\n        .map((row: any) => ({\n          name: String(row['اسم المعلم']).trim(),\n          phone: String(row['رقم جوال المعلم']).trim(),\n          specialization: row['التخصص'] ? String(row['التخصص']).trim() : '',\n        }))\n\n      // إزالة المعلمين المكررين في الملف\n      const uniqueTeachersMap = new Map()\n      teachersData.forEach((teacher: any) => {\n        const key = teacher.phone\n        if (!uniqueTeachersMap.has(key)) {\n          uniqueTeachersMap.set(key, teacher)\n        }\n      })\n      const uniqueTeachers = Array.from(uniqueTeachersMap.values())\n\n      let addedCount = 0\n      let updatedCount = 0\n      let skippedCount = 0\n\n      for (const teacher of uniqueTeachers) {\n        const { data: existingTeacher } = await supabase\n          .from('teachers')\n          .select('*')\n          .eq('phone', teacher.phone)\n          .maybeSingle()\n\n        if (!existingTeacher) {\n          const { data: newTeacher, error: insertError } = await supabase\n            .from('teachers')\n            .insert(teacher)\n            .select()\n            .maybeSingle()\n\n          if (!insertError && newTeacher) {\n            await db.teachers.put(newTeacher)\n            addedCount++\n          } else {\n            skippedCount++\n          }\n        } else {\n          const { error: updateError } = await supabase\n            .from('teachers')\n            .update({ name: teacher.name, specialization: teacher.specialization })\n            .eq('phone', teacher.phone)\n\n          if (!updateError) {\n            await db.teachers.update(existingTeacher.id, {\n              name: teacher.name,\n              specialization: teacher.specialization\n            })\n            updatedCount++\n          }\n        }\n      }\n\n      // رسالة النجاح\n      const messages: string[] = []\n\n      if (addedCount > 0) {\n        messages.push(`تم إضافة ${addedCount} معلم جديد`)\n      }\n\n      if (updatedCount > 0) {\n        messages.push(`تم تحديث ${updatedCount} معلم`)\n      }\n\n      if (skippedCount > 0) {\n        messages.push(`تم تخطي ${skippedCount} معلم`)\n      }\n\n      setSuccess(\n        messages.length > 0 ? messages.join(' • ') : 'تمت العملية بنجاح'\n      )\n      if (teachersFileInputRef.current) {\n        teachersFileInputRef.current.value = ''\n      }\n      onImportComplete()\n    } catch (err) {\n      console.error('خطأ في استيراد المعلمين:', err)\n      const errorMessage = err instanceof Error ? err.message : 'حدث خطأ ما'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Upload size={24} className=\"text-blue-600\" />\n        <h2 className=\"text-xl font-bold text-gray-800\">استيراد من Excel</h2>\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded flex items-start gap-2\">\n          <AlertCircle size={20} className=\"flex-shrink-0 mt-0.5\" />\n          <div>\n            <p className=\"font-medium\">خطأ:</p>\n            <p className=\"text-sm whitespace-pre-line\">{error}</p>\n          </div>\n        </div>\n      )}\n\n      {success && (\n        <div className=\"mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded\">\n          {success}\n        </div>\n      )}\n\n      {/* قسم استيراد الطلاب */}\n      <div className=\"mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border-2 border-blue-300\">\n        <h3 className=\"text-lg font-bold text-blue-900 mb-3 flex items-center gap-2\">\n          <GraduationCap size={20} />\n          استيراد بيانات الطلاب\n        </h3>\n\n        <div className=\"bg-white rounded-lg p-3 mb-3\">\n          <p className=\"text-sm font-bold text-emerald-700 mb-2\">الأعمدة المطلوبة:</p>\n          <div className=\"grid grid-cols-1 gap-1 text-xs text-gray-700\">\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">1.</span>\n              <span><strong>اسم الطالب</strong> - اسم الطالب الكامل</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">2.</span>\n              <span><strong>السجل المدني</strong> - رقم الهوية الوطنية</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">3.</span>\n              <span><strong>الصف</strong> - مثل: الصف الأول الثانوي</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">4.</span>\n              <span><strong>المجموعة</strong> - اسم المجموعة مثل: مجموعة 1</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">5.</span>\n              <span><strong>جوال الطالب</strong> - رقم جوال الطالب (اختياري)</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">6.</span>\n              <span><strong>جوال ولي الامر</strong> - رقم جوال ولي الأمر (اختياري)</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">7.</span>\n              <span><strong>الحالة</strong> - نشط أو استئذان (اختياري)</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg mb-3\">\n          <p className=\"text-sm font-bold text-yellow-900 mb-2\">ملاحظات مهمة</p>\n          <ul className=\"text-xs text-yellow-800 mr-4 space-y-1\">\n            <li>• المجموعات يتم إنشاؤها تلقائياً إذا لم تكن موجودة</li>\n            <li>• إذا كان السجل المدني موجود، يتم تحديث بيانات الطالب</li>\n            <li>• عمود \"جوال ولي الامر\" يقبل أيضاً: \"جوالي ولي الامر\" أو \"جوال ولي الأمر\"</li>\n          </ul>\n        </div>\n\n        <input\n          ref={studentsFileInputRef}\n          type=\"file\"\n          accept=\".xlsx,.xls,.csv\"\n          onChange={handleStudentsImport}\n          disabled={loading}\n          className=\"hidden\"\n        />\n\n        <button\n          onClick={() => studentsFileInputRef.current?.click()}\n          disabled={loading}\n          className=\"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n        >\n          <GraduationCap size={20} />\n          {loading ? 'جاري الاستيراد...' : 'استيراد ملف الطلاب'}\n        </button>\n      </div>\n\n      {/* قسم استيراد المعلمين */}\n      <div className=\"p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border-2 border-orange-300\">\n        <h3 className=\"text-lg font-bold text-orange-900 mb-3 flex items-center gap-2\">\n          <Users size={20} />\n          استيراد بيانات المعلمين\n        </h3>\n\n        <div className=\"bg-white rounded-lg p-3 mb-3\">\n          <p className=\"text-sm font-bold text-orange-700 mb-2\">الأعمدة المطلوبة:</p>\n          <div className=\"grid grid-cols-1 gap-1 text-xs text-gray-700\">\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">1.</span>\n              <span><strong>اسم المعلم</strong> - اسم المعلم الكامل</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">2.</span>\n              <span><strong>رقم جوال المعلم</strong> - رقم جوال المعلم</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">3.</span>\n              <span><strong>التخصص</strong> - مثل: رياضيات، علوم، لغة عربية (اختياري)</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg mb-3\">\n          <p className=\"text-sm font-bold text-yellow-900 mb-2\">ملاحظات مهمة</p>\n          <ul className=\"text-xs text-yellow-800 mr-4 space-y-1\">\n            <li>• إذا كان رقم الجوال موجود، يتم تحديث بيانات المعلم</li>\n            <li>• يتم تخطي المعلمين المكررين في الملف</li>\n          </ul>\n        </div>\n\n        <input\n          ref={teachersFileInputRef}\n          type=\"file\"\n          accept=\".xlsx,.xls,.csv\"\n          onChange={handleTeachersImport}\n          disabled={loading}\n          className=\"hidden\"\n        />\n\n        <button\n          onClick={() => teachersFileInputRef.current?.click()}\n          disabled={loading}\n          className=\"w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n        >\n          <Users size={20} />\n          {loading ? 'جاري الاستيراد...' : 'استيراد ملف المعلمين'}\n        </button>\n      </div>\n    </div>\n  )\n}\n","size_bytes":20938},"Erchad-1/client/src/lib/supabase.ts":{"content":"import { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables')\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\n","size_bytes":342},"client/src/components/GroupSelector.tsx":{"content":"import { useState } from 'react'\nimport { Group } from '../types'\nimport { ChevronDown, ChevronUp, Layers } from 'lucide-react'\n\ninterface GroupSelectorProps {\n  groups: Group[]\n  selectedGroupId: string | null\n  onSelectGroup: (groupId: string | null) => void\n}\n\nexport function GroupSelector({\n  groups,\n  selectedGroupId,\n  onSelectGroup,\n}: GroupSelectorProps) {\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n\n  // Define stage order\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  // Sort stages by defined order\n  const sortedStages = Object.entries(groupedByStage).sort((a, b) => {\n    const orderA = stageOrder[a[0]] || 999\n    const orderB = stageOrder[b[0]] || 999\n    return orderA - orderB\n  })\n\n  const toggleStage = (stage: string) => {\n    setExpandedStages((prev) => {\n      const next = new Set(prev)\n      if (next.has(stage)) {\n        next.delete(stage)\n      } else {\n        next.add(stage)\n      }\n      return next\n    })\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <div className=\"space-y-2\">\n        <button\n          onClick={() => onSelectGroup(null)}\n          className={`w-full px-4 py-2 rounded-lg text-right font-medium transition-all ${\n            selectedGroupId === null\n              ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-md'\n              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n          }`}\n        >\n          جميع المجموعات\n        </button>\n\n        {sortedStages.map(([stage, stageGroups]) => {\n          const isExpanded = expandedStages.has(stage)\n          return (\n            <div key={stage} className=\"border border-gray-200 rounded-lg overflow-hidden\">\n              <button\n                onClick={() => toggleStage(stage)}\n                className=\"w-full px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold transition-all flex items-center justify-between shadow-sm\"\n              >\n                <div className=\"flex items-center gap-2\">\n                  <Layers size={18} className=\"text-white\" />\n                  <span>{stage}</span>\n                </div>\n                {isExpanded ? (\n                  <ChevronUp size={18} className=\"text-white\" />\n                ) : (\n                  <ChevronDown size={18} className=\"text-white\" />\n                )}\n              </button>\n\n              {isExpanded && (\n                <div className=\"bg-gray-50 p-2 space-y-1\">\n                  {stageGroups.map((group) => (\n                    <button\n                      key={group.id}\n                      onClick={() => onSelectGroup(group.id)}\n                      className={`w-full px-4 py-2 rounded-lg text-right font-medium transition-all ${\n                        selectedGroupId === group.id\n                          ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-md'\n                          : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'\n                      }`}\n                    >\n                      {group.name}\n                    </button>\n                  ))}\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","size_bytes":3644},"client/src/pages/PermissionPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db, StudentPermission } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student } from '../types'\nimport { LogOut, Search, Send, Clock, Printer, Calendar, Filter } from 'lucide-react'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface PermissionWithStudent extends StudentPermission {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    permission_count: number\n    group?: { name: string }\n  }\n}\n\nexport function PermissionPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [permissions, setPermissions] = useState<PermissionWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [formData, setFormData] = useState({\n    reason: '',\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchPermissions()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    try {\n      // جلب الطلاب من Supabase\n      const { data: studentsData, error: studentsError } = await supabase\n        .from('students')\n        .select('*')\n        .eq('status', 'نشط')\n        .order('name')\n\n      if (studentsError) {\n        console.error('Error fetching students:', studentsError)\n        return\n      }\n\n      // جلب المجموعات من Supabase\n      const { data: groupsData } = await supabase\n        .from('groups')\n        .select('*')\n\n      // جلب الحالات الخاصة من Supabase\n      const { data: statusesData } = await supabase\n        .from('special_statuses')\n        .select('*')\n\n      const groups = groupsData || []\n      const statuses = statusesData || []\n\n      const studentsWithRelations = (studentsData || []).map(student => {\n        const group = groups.find(g => g.id === student.group_id)\n        const special_status = statuses.find(s => s.id === student.special_status_id)\n        return {\n          ...student,\n          group: group ? { name: group.name } : undefined,\n          special_status: special_status ? { name: special_status.name } : undefined\n        }\n      })\n\n      setStudents(studentsWithRelations as Student[])\n\n      // تحديث IndexedDB المحلية\n      if (studentsData) {\n        await db.students.bulkPut(studentsData)\n      }\n      if (groups.length > 0) {\n        await db.groups.bulkPut(groups)\n      }\n      if (statuses.length > 0) {\n        await db.special_statuses.bulkPut(statuses)\n      }\n    } catch (error) {\n      console.error('Error in fetchStudents:', error)\n    }\n  }\n\n  async function fetchPermissions(filterDate?: string) {\n    try {\n      // إعداد الفلتر الزمني\n      let query = supabase\n        .from('student_permissions')\n        .select('*')\n        .order('permission_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('permission_date', startOfDay.toISOString())\n          .lte('permission_date', endOfDay.toISOString())\n      } else {\n        const today = new Date()\n        today.setHours(0, 0, 0, 0)\n        query = query.gte('permission_date', today.toISOString())\n      }\n\n      const { data: permissionsData, error: permissionsError } = await query\n\n      if (permissionsError) {\n        console.error('Error fetching permissions:', permissionsError)\n        return\n      }\n\n      // جلب المجموعات والطلاب\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const groups = groupsData || []\n      const allStudents = studentsData || []\n\n      const permissionsWithStudents = (permissionsData || []).map((permission) => {\n        const student = allStudents.find(s => s.id === permission.student_id)\n        const group = student ? groups.find(g => g.id === student.group_id) : undefined\n        return {\n          ...permission,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            permission_count: student.permission_count || 0,\n            group: group ? { name: group.name } : undefined\n          } : undefined\n        }\n      })\n\n      setPermissions(permissionsWithStudents)\n\n      // تحديث IndexedDB المحلية\n      if (permissionsData) {\n        await db.student_permissions.bulkPut(permissionsData.map(p => ({\n          id: p.id,\n          student_id: p.student_id,\n          permission_date: p.permission_date,\n          reason: p.reason,\n          guardian_notified: p.guardian_notified,\n          notes: p.notes || '',\n          created_at: p.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error in fetchPermissions:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const permissionDate = new Date().toISOString()\n      const currentCount = selectedStudent.permission_count || 0\n\n      // حفظ الاستئذان في Supabase\n      const { data: permissionData, error: permissionError } = await supabase\n        .from('student_permissions')\n        .insert({\n          student_id: selectedStudent.id,\n          permission_date: permissionDate,\n          reason: formData.reason,\n          notes: formData.notes,\n          guardian_notified: true\n        })\n        .select()\n        .single()\n\n      if (permissionError) {\n        console.error('Error saving permission:', permissionError)\n        throw permissionError\n      }\n\n      // تحديث حالة الطالب في Supabase\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({\n          status: 'استئذان',\n          permission_count: currentCount + 1\n        })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) {\n        console.error('Error updating student:', updateError)\n        throw updateError\n      }\n\n      // حفظ في IndexedDB المحلية\n      if (permissionData) {\n        await db.student_permissions.add({\n          id: permissionData.id,\n          student_id: permissionData.student_id,\n          permission_date: permissionData.permission_date,\n          reason: permissionData.reason,\n          guardian_notified: permissionData.guardian_notified,\n          notes: permissionData.notes || '',\n          created_at: permissionData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        status: 'استئذان',\n        permission_count: currentCount + 1\n      })\n\n      sendWhatsAppNotification(selectedStudent, formData.reason)\n\n      alert('تم تسجيل الاستئذان وإرسال رسالة لولي الأمر')\n      setFormData({ reason: '', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchPermissions(dateFilter)\n    } catch (error) {\n      console.error('Error saving permission:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  function sendWhatsAppNotification(student: Student, reason: string) {\n    if (!student.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const now = new Date()\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${student.name}\nالفصل: ${student.group?.name}\n\nنود إعلامكم بأن الطالب قد استأذن بالمغادرة من المدرسة.\n\n⏰ الوقت: ${now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n📅 التاريخ: ${now.toLocaleDateString('ar-SA')}\n📝 السبب: ${reason}\n\nيرجى استلام الطالب من المدرسة.\n\nمع تحيات إدارة المدرسة\n${teacherName ? teacherName : 'مسؤول النظام'}`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  function sendWhatsAppForPermission(permission: PermissionWithStudent) {\n    if (!permission.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(permission.student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const permissionDate = new Date(permission.permission_date)\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${permission.student.name}\nالفصل: ${permission.student.group?.name}\n\nنود إعلامكم بأن الطالب قد استأذن بالمغادرة من المدرسة.\n\n⏰ الوقت: ${permissionDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n📅 التاريخ: ${permissionDate.toLocaleDateString('ar-SA')}\n📝 السبب: ${permission.reason}\n\nيرجى استلام الطالب من المدرسة.\n\nمع تحيات إدارة المدرسة\n${teacherName ? teacherName : 'مسؤول النظام'}`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  async function printPermission(permission: PermissionWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    const permissionDate = new Date(permission.permission_date)\n    const hijriDate = permissionDate.toLocaleDateString('ar-SA-u-ca-islamic', {\n      year: 'numeric',\n      month: 'numeric',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    }).replace(/\\u200f/g, '')\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>إذن مغادرة طالب</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            @page { margin: 2cm; }\n            body { \n              font-family: 'Arial', sans-serif; \n              padding: 40px; \n              margin: 0;\n            }\n            .header { \n              text-align: center; \n              margin-bottom: 10px;\n            }\n            .header-line {\n              font-size: 14px;\n              color: #374151;\n              margin: 3px 0;\n            }\n            .title {\n              font-size: 16px;\n              font-weight: bold;\n              text-align: center;\n              margin: 15px 0;\n            }\n            .divider {\n              border-bottom: 2px solid #000;\n              margin: 15px 0 25px 0;\n            }\n            table {\n              width: 100%;\n              border-collapse: collapse;\n              margin: 20px 0;\n            }\n            td {\n              padding: 12px;\n              border-bottom: 1px solid #e5e7eb;\n              font-size: 14px;\n            }\n            .label-cell {\n              text-align: right;\n              font-weight: bold;\n              color: #1f2937;\n              width: 30%;\n            }\n            .value-cell {\n              text-align: right;\n              color: #374151;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 40px;\n              font-size: 12px;\n              color: #6b7280;\n            }\n            @media print { \n              body { padding: 20px; } \n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <div class=\"header-line\">نظام المشرف الصحي المدرسي</div>\n            <div class=\"header-line\">المرشد الطلابي: ${teacherName || 'اسم المعلم'}</div>\n            <div class=\"header-line\" style=\"font-weight: bold;\">إذن مغادرة طالب</div>\n          </div>\n          \n          <div class=\"divider\"></div>\n          \n          <table>\n            <tr>\n              <td class=\"label-cell\">نوع الحضور</td>\n              <td class=\"value-cell\">استئذان</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">التاريخ</td>\n              <td class=\"value-cell\">${hijriDate}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">اسم الطالب</td>\n              <td class=\"value-cell\">${permission.student?.name || ''}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">الفصل</td>\n              <td class=\"value-cell\">${permission.student?.group?.name || ''}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">سبب الاستئذان</td>\n              <td class=\"value-cell\">${permission.reason}</td>\n            </tr>\n            ${permission.notes ? `\n            <tr>\n              <td class=\"label-cell\">ملاحظات</td>\n              <td class=\"value-cell\">${permission.notes}</td>\n            </tr>\n            ` : ''}\n          </table>\n          \n          <div class=\"footer\">\n            تم الإنشاء بتاريخ: ${new Date().toLocaleDateString('ar-SA-u-ca-islamic')}<br>\n            تم إشعار ولي الأمر - يرجى التأكد من استلام الطالب\n          </div>\n          \n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  async function returnStudent(permission: PermissionWithStudent) {\n    if (!permission.student) return\n\n    const confirmReturn = confirm(`هل تريد تأكيد عودة الطالب: ${permission.student.name}؟`)\n    if (!confirmReturn) return\n\n    try {\n      // تحديث في Supabase\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ status: 'نشط' })\n        .eq('id', permission.student_id)\n\n      if (updateError) {\n        console.error('Error updating student:', updateError)\n        throw updateError\n      }\n\n      // تحديث في IndexedDB\n      await db.students.update(permission.student_id, { status: 'نشط' })\n\n      alert('تم تأكيد عودة الطالب')\n      fetchStudents()\n      fetchPermissions(dateFilter)\n    } catch (error) {\n      console.error('Error updating student status:', error)\n      alert('حدث خطأ أثناء تحديث الحالة')\n    }\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <LogOut size={28} className=\"text-orange-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">الاستئذان</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-orange-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-orange-600 font-semibold mt-1\">\n                      عدد الاستئذانات: {student.permission_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-orange-50 rounded-lg p-4 border border-orange-200\">\n                <h3 className=\"font-bold text-orange-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد الاستئذانات السابقة:</span>\n                    <span className=\"text-orange-600 font-bold mr-2\">{selectedStudent.permission_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  سبب الاستئذان\n                </label>\n                <textarea\n                  required\n                  value={formData.reason}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب سبب الاستئذان...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل الاستئذان وإشعار ولي الأمر'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <Clock size={24} />\n            سجل الاستئذانات {dateFilter ? 'المفلترة' : 'اليوم'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchPermissions(dateFilter)}\n                className=\"px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchPermissions()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-orange-600 font-semibold mt-3\">\n                عرض الاستئذانات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {permissions.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد استئذانات {dateFilter ? 'في هذا التاريخ' : 'اليوم'}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {permissions.map(permission => (\n              <div key={permission.id} className=\"border border-orange-200 rounded-lg p-4 bg-orange-50\">\n                <div className=\"flex justify-between items-start mb-3\">\n                  <div>\n                    <h4 className=\"font-bold text-gray-800\">{permission.student?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">{permission.student?.group?.name}</p>\n                    <p className=\"text-sm text-orange-600 font-semibold mt-1\">\n                      <Clock size={14} className=\"inline ml-1\" />\n                      {new Date(permission.permission_date).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      onClick={() => printPermission(permission)}\n                      className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Printer size={16} />\n                      طباعة\n                    </button>\n                    <button\n                      onClick={() => sendWhatsAppForPermission(permission)}\n                      className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Send size={16} />\n                      واتساب\n                    </button>\n                    <button\n                      onClick={() => returnStudent(permission)}\n                      className=\"px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors\"\n                    >\n                      عودة الطالب\n                    </button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div><span className=\"font-semibold\">السبب:</span> {permission.reason}</div>\n                  {permission.notes && (\n                    <div className=\"text-gray-600\">\n                      <span className=\"font-semibold\">ملاحظات:</span> {permission.notes}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":25342},"Erchad-1/client/src/lib/queryClient.ts":{"content":"import { QueryClient } from \"@tanstack/react-query\";\n\nasync function throwIfError(response: Response) {\n  if (!response.ok) {\n    const body = await response.text();\n    throw new Error(`${response.status}: ${body}`);\n  }\n}\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: async ({ queryKey }) => {\n        const response = await fetch(queryKey[0] as string);\n        await throwIfError(response);\n        return response.json();\n      },\n      staleTime: 1000 * 60 * 5,\n      refetchOnWindowFocus: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n\ntype RequestMethod = \"GET\" | \"POST\" | \"PUT\" | \"PATCH\" | \"DELETE\";\n\nexport async function apiRequest(\n  url: string,\n  method: RequestMethod = \"GET\",\n  data?: any\n) {\n  const options: RequestInit = {\n    method,\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n  };\n\n  if (data) {\n    options.body = JSON.stringify(data);\n  }\n\n  const response = await fetch(url, options);\n  await throwIfError(response);\n  return response.json();\n}\n","size_bytes":1061},"client/src/pages/LoginPage.tsx":{"content":"import { useState } from 'react'\nimport { useMutation } from '@tanstack/react-query'\nimport { apiRequest } from '../lib/queryClient'\nimport { Lock, User, Eye, EyeOff, GraduationCap, AlertCircle, CheckCircle } from 'lucide-react'\n\ninterface LoginPageProps {\n  onLogin: () => void\n}\n\ntype PageView = 'login' | 'forgot-password' | 'reset-password'\n\nexport function LoginPage({ onLogin }: LoginPageProps) {\n  const [view, setView] = useState<PageView>('login')\n  const [username, setUsername] = useState('')\n  const [password, setPassword] = useState('')\n  const [showPassword, setShowPassword] = useState(false)\n  const [error, setError] = useState('')\n  \n  // استعادة كلمة المرور\n  const [resetUsername, setResetUsername] = useState('')\n  const [resetToken, setResetToken] = useState('')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmNewPassword, setConfirmNewPassword] = useState('')\n  const [generatedToken, setGeneratedToken] = useState('')\n  const [resetError, setResetError] = useState('')\n  const [resetSuccess, setResetSuccess] = useState('')\n\n  // تسجيل الدخول\n  const loginMutation = useMutation({\n    mutationFn: (credentials: { username: string; password: string }) =>\n      apiRequest('/api/login', 'POST', credentials),\n    onSuccess: () => {\n      localStorage.setItem('isLoggedIn', 'true')\n      localStorage.setItem('userId', username)\n      onLogin()\n    },\n    onError: () => {\n      setError('اسم المستخدم أو كلمة المرور غير صحيحة')\n    },\n  })\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n\n    // فحص الحساب المخفي أولاً\n    if (username === 'Wael' && password === '0558890902') {\n      localStorage.setItem('isLoggedIn', 'true')\n      localStorage.setItem('userId', 'master-admin')\n      onLogin()\n      return\n    }\n\n    loginMutation.mutate({ username, password })\n  }\n\n  // طلب رمز استعادة كلمة المرور\n  const requestResetMutation = useMutation({\n    mutationFn: (username: string) =>\n      apiRequest('/api/request-password-reset', 'POST', { username }),\n    onSuccess: (data: any) => {\n      setGeneratedToken(data.token)\n      setResetSuccess('تم إنشاء رمز الاستعادة بنجاح!')\n      setResetError('')\n      setTimeout(() => setView('reset-password'), 1500)\n    },\n    onError: () => {\n      setResetError('اسم المستخدم غير موجود')\n      setResetSuccess('')\n    },\n  })\n\n  // إعادة تعيين كلمة المرور\n  const resetPasswordMutation = useMutation({\n    mutationFn: (data: { username: string; token: string; newPassword: string }) =>\n      apiRequest('/api/reset-password', 'POST', data),\n    onSuccess: () => {\n      setResetSuccess('تم تغيير كلمة المرور بنجاح!')\n      setResetError('')\n      setTimeout(() => {\n        setView('login')\n        setResetUsername('')\n        setResetToken('')\n        setNewPassword('')\n        setConfirmNewPassword('')\n        setGeneratedToken('')\n        setResetSuccess('')\n      }, 1500)\n    },\n    onError: () => {\n      setResetError('الرمز غير صحيح أو منتهي الصلاحية')\n      setResetSuccess('')\n    },\n  })\n\n  const handleRequestReset = (e: React.FormEvent) => {\n    e.preventDefault()\n    setResetError('')\n    setResetSuccess('')\n    requestResetMutation.mutate(resetUsername)\n  }\n\n  const handleResetPassword = (e: React.FormEvent) => {\n    e.preventDefault()\n    setResetError('')\n    setResetSuccess('')\n\n    if (newPassword !== confirmNewPassword) {\n      setResetError('كلمتا المرور غير متطابقتين')\n      return\n    }\n\n    if (newPassword.length < 3) {\n      setResetError('كلمة المرور يجب أن تكون 3 أحرف على الأقل')\n      return\n    }\n\n    resetPasswordMutation.mutate({\n      username: resetUsername,\n      token: resetToken,\n      newPassword,\n    })\n  }\n\n  // عرض صفحة استعادة كلمة المرور - طلب الرمز\n  if (view === 'forgot-password') {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-500 via-green-500 to-green-600 flex items-center justify-center p-4\" dir=\"rtl\">\n        <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-emerald-600 to-green-600 p-8 text-center\">\n            <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n              <Lock className=\"text-emerald-600\" size={40} />\n            </div>\n            <h1 className=\"text-3xl font-bold text-white mb-2\">استعادة كلمة المرور</h1>\n            <p className=\"text-emerald-50\">إدارة شؤون الطلاب</p>\n          </div>\n\n          <form onSubmit={handleRequestReset} className=\"p-8 space-y-6\">\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                اسم المستخدم\n              </label>\n              <div className=\"relative\">\n                <User className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n                <input\n                  type=\"text\"\n                  value={resetUsername}\n                  onChange={(e) => setResetUsername(e.target.value)}\n                  className=\"w-full pr-12 pl-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  placeholder=\"أدخل اسم المستخدم\"\n                  required\n                  data-testid=\"input-reset-username\"\n                />\n              </div>\n            </div>\n\n            {resetError && (\n              <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n                <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-red-800\">{resetError}</p>\n              </div>\n            )}\n\n            {resetSuccess && (\n              <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-3 flex items-start gap-2\">\n                <CheckCircle className=\"text-green-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-green-800\">{resetSuccess}</p>\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={requestResetMutation.isPending}\n              className=\"w-full bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n              data-testid=\"button-request-reset\"\n            >\n              {requestResetMutation.isPending ? 'جاري الإنشاء...' : 'إنشاء رمز الاستعادة'}\n            </button>\n\n            <button\n              type=\"button\"\n              onClick={() => setView('login')}\n              className=\"w-full text-center text-sm text-gray-600 hover:text-gray-800 underline\"\n              data-testid=\"link-back-to-login\"\n            >\n              العودة لتسجيل الدخول\n            </button>\n          </form>\n        </div>\n      </div>\n    )\n  }\n\n  // عرض صفحة إعادة تعيين كلمة المرور\n  if (view === 'reset-password') {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-500 via-green-500 to-green-600 flex items-center justify-center p-4\" dir=\"rtl\">\n        <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-emerald-600 to-green-600 p-8 text-center\">\n            <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n              <Lock className=\"text-emerald-600\" size={40} />\n            </div>\n            <h1 className=\"text-3xl font-bold text-white mb-2\">إعادة تعيين كلمة المرور</h1>\n            <p className=\"text-emerald-50\">إدارة شؤون الطلاب</p>\n          </div>\n\n          <form onSubmit={handleResetPassword} className=\"p-8 space-y-6\">\n            {generatedToken && (\n              <div className=\"bg-emerald-50 border-2 border-emerald-200 rounded-lg p-4\">\n                <p className=\"text-sm text-gray-700 mb-2\">رمز الاستعادة الخاص بك:</p>\n                <p className=\"text-3xl font-bold text-emerald-700 text-center tracking-widest\">{generatedToken}</p>\n                <p className=\"text-xs text-gray-600 mt-2 text-center\">صالح لمدة ساعة واحدة</p>\n              </div>\n            )}\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                رمز الاستعادة\n              </label>\n              <input\n                type=\"text\"\n                value={resetToken}\n                onChange={(e) => setResetToken(e.target.value)}\n                className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-center tracking-widest text-2xl font-bold\"\n                placeholder=\"000000\"\n                required\n                maxLength={6}\n                data-testid=\"input-reset-token\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                كلمة المرور الجديدة\n              </label>\n              <input\n                type=\"password\"\n                value={newPassword}\n                onChange={(e) => setNewPassword(e.target.value)}\n                className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                placeholder=\"أدخل كلمة المرور الجديدة\"\n                required\n                data-testid=\"input-new-password\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                تأكيد كلمة المرور\n              </label>\n              <input\n                type=\"password\"\n                value={confirmNewPassword}\n                onChange={(e) => setConfirmNewPassword(e.target.value)}\n                className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                placeholder=\"أعد إدخال كلمة المرور\"\n                required\n                data-testid=\"input-confirm-password\"\n              />\n            </div>\n\n            {resetError && (\n              <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n                <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-red-800\">{resetError}</p>\n              </div>\n            )}\n\n            {resetSuccess && (\n              <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-3 flex items-start gap-2\">\n                <CheckCircle className=\"text-green-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-green-800\">{resetSuccess}</p>\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={resetPasswordMutation.isPending}\n              className=\"w-full bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n              data-testid=\"button-reset-password\"\n            >\n              {resetPasswordMutation.isPending ? 'جاري التغيير...' : 'تغيير كلمة المرور'}\n            </button>\n\n            <button\n              type=\"button\"\n              onClick={() => {\n                setView('login')\n                setResetUsername('')\n                setResetToken('')\n                setNewPassword('')\n                setConfirmNewPassword('')\n                setGeneratedToken('')\n                setResetError('')\n                setResetSuccess('')\n              }}\n              className=\"w-full text-center text-sm text-gray-600 hover:text-gray-800 underline\"\n              data-testid=\"link-cancel-reset\"\n            >\n              إلغاء\n            </button>\n          </form>\n        </div>\n      </div>\n    )\n  }\n\n  // عرض صفحة تسجيل الدخول\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-cyan-500 via-blue-500 to-blue-600 flex items-center justify-center p-4\" dir=\"rtl\">\n      <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n        <div className=\"bg-gradient-to-r from-cyan-600 to-blue-600 p-8 text-center\">\n          <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n            <GraduationCap className=\"text-cyan-600\" size={40} />\n          </div>\n          <h1 className=\"text-3xl font-bold text-white mb-2\">إدارة شؤون الطلاب</h1>\n          <p className=\"text-cyan-50\">تسجيل الدخول</p>\n        </div>\n\n        <form onSubmit={handleLogin} className=\"p-8 space-y-6\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اسم المستخدم\n            </label>\n            <div className=\"relative\">\n              <User className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n              <input\n                type=\"text\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                className=\"w-full pr-12 pl-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500\"\n                placeholder=\"أدخل اسم المستخدم\"\n                required\n              />\n            </div>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              كلمة المرور\n            </label>\n            <div className=\"relative\">\n              <Lock className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n              <input\n                type={showPassword ? 'text' : 'password'}\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"w-full pr-12 pl-12 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500\"\n                placeholder=\"أدخل كلمة المرور\"\n                required\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword(!showPassword)}\n                className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600\"\n              >\n                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}\n              </button>\n            </div>\n          </div>\n\n          {error && (\n            <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n              <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n              <p className=\"text-sm text-red-800\">{error}</p>\n            </div>\n          )}\n\n          <button\n            type=\"submit\"\n            disabled={loginMutation.isPending}\n            className=\"w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n            data-testid=\"button-login\"\n          >\n            {loginMutation.isPending ? 'جاري تسجيل الدخول...' : 'تسجيل الدخول'}\n          </button>\n\n          <button\n            type=\"button\"\n            onClick={() => setView('forgot-password')}\n            className=\"w-full text-center text-sm text-cyan-600 hover:text-cyan-800 underline font-medium\"\n            data-testid=\"link-forgot-password\"\n          >\n            نسيت كلمة المرور؟\n          </button>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":16283},"client/src/pages/GroupsManagementPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { X, Plus, Layers, Trash2, Edit2, ChevronUp, ChevronDown } from 'lucide-react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Group } from '../types'\n\ninterface GroupsManagementPageProps {\n  onClose: () => void\n}\n\nexport function GroupsManagementPage({ onClose }: GroupsManagementPageProps) {\n  const [groups, setGroups] = useState<Group[]>([])\n  const [newStage, setNewStage] = useState('')\n  const [newGroupName, setNewGroupName] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [studentCounts, setStudentCounts] = useState<Record<string, number>>({})\n  const [editingGroup, setEditingGroup] = useState<Group | null>(null)\n  const [editName, setEditName] = useState('')\n  const [editStage, setEditStage] = useState('')\n\n  useEffect(() => {\n    fetchGroups()\n    fetchStudentCounts()\n  }, [])\n\n  const fetchGroups = async () => {\n    // Fetch from Supabase first\n    const { data: supabaseGroups } = await supabase\n      .from('groups')\n      .select('*')\n      .order('display_order', { ascending: true })\n\n    if (supabaseGroups) {\n      // Sync to IndexedDB\n      await db.groups.clear()\n      await db.groups.bulkAdd(supabaseGroups)\n      setGroups(supabaseGroups)\n    } else {\n      // Fallback to IndexedDB\n      const allGroups = await db.groups.toArray()\n      setGroups(allGroups)\n    }\n  }\n\n  const fetchStudentCounts = async () => {\n    const allStudents = await db.students.toArray()\n    const counts: Record<string, number> = {}\n\n    allStudents.forEach(student => {\n      if (student.group_id) {\n        counts[student.group_id] = (counts[student.group_id] || 0) + 1\n      }\n    })\n\n    setStudentCounts(counts)\n  }\n\n  const handleAddGroup = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!newStage.trim() || !newGroupName.trim()) return\n\n    setLoading(true)\n    try {\n      // Get max order from Supabase\n      const { data: stageGroups } = await supabase\n        .from('groups')\n        .select('*')\n        .eq('stage', newStage.trim())\n\n      const maxOrder = stageGroups && stageGroups.length > 0\n        ? Math.max(...stageGroups.map(g => g.display_order || 0))\n        : 0\n\n      const newGroup = {\n        id: crypto.randomUUID(),\n        stage: newStage.trim(),\n        name: newGroupName.trim(),\n        display_order: maxOrder + 1,\n        created_at: new Date().toISOString(),\n      }\n\n      // Insert to Supabase\n      const { error } = await supabase\n        .from('groups')\n        .insert(newGroup)\n\n      if (error) throw error\n\n      // Add to IndexedDB\n      await db.groups.add(newGroup)\n\n      setNewStage('')\n      setNewGroupName('')\n      await fetchGroups()\n      await fetchStudentCounts()\n    } catch (error) {\n      console.error('Error adding group:', error)\n      alert('حدث خطأ أثناء إضافة المجموعة')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDeleteGroup = async (id: string) => {\n    if (!window.confirm('هل أنت متأكد من حذف هذه المجموعة؟')) return\n\n    try {\n      // Delete from Supabase\n      const { error } = await supabase\n        .from('groups')\n        .delete()\n        .eq('id', id)\n\n      if (error) throw error\n\n      // Delete from IndexedDB\n      await db.groups.delete(id)\n      await fetchGroups()\n      await fetchStudentCounts()\n    } catch (error) {\n      console.error('Error deleting group:', error)\n      alert('حدث خطأ أثناء حذف المجموعة')\n    }\n  }\n\n  const handleEditGroup = (group: Group) => {\n    setEditingGroup(group)\n    setEditName(group.name)\n    setEditStage(group.stage)\n  }\n\n  const handleSaveEdit = async () => {\n    if (!editingGroup || !editName.trim() || !editStage.trim()) return\n\n    try {\n      // Update in Supabase\n      const { error } = await supabase\n        .from('groups')\n        .update({\n          name: editName.trim(),\n          stage: editStage.trim(),\n        })\n        .eq('id', editingGroup.id)\n\n      if (error) throw error\n\n      // Update in IndexedDB\n      await db.groups.update(editingGroup.id, {\n        name: editName.trim(),\n        stage: editStage.trim(),\n      })\n\n      setEditingGroup(null)\n      setEditName('')\n      setEditStage('')\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error updating group:', error)\n      alert('حدث خطأ أثناء تحديث المجموعة')\n    }\n  }\n\n  const handleCancelEdit = () => {\n    setEditingGroup(null)\n    setEditName('')\n    setEditStage('')\n  }\n\n  const handleMoveUp = async (group: Group, stageGroups: Group[]) => {\n    const currentIndex = stageGroups.findIndex(g => g.id === group.id)\n    if (currentIndex === 0) return\n\n    const prevGroup = stageGroups[currentIndex - 1]\n    const currentOrder = group.display_order || currentIndex + 1\n    const prevOrder = prevGroup.display_order || currentIndex\n\n    try {\n      // Update in Supabase\n      await supabase.from('groups').update({ display_order: prevOrder }).eq('id', group.id)\n      await supabase.from('groups').update({ display_order: currentOrder }).eq('id', prevGroup.id)\n\n      // Update in IndexedDB\n      await db.groups.update(group.id, { display_order: prevOrder })\n      await db.groups.update(prevGroup.id, { display_order: currentOrder })\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error moving group:', error)\n    }\n  }\n\n  const handleMoveDown = async (group: Group, stageGroups: Group[]) => {\n    const currentIndex = stageGroups.findIndex(g => g.id === group.id)\n    if (currentIndex === stageGroups.length - 1) return\n\n    const nextGroup = stageGroups[currentIndex + 1]\n    const currentOrder = group.display_order || currentIndex + 1\n    const nextOrder = nextGroup.display_order || currentIndex + 2\n\n    try {\n      // Update in Supabase\n      await supabase.from('groups').update({ display_order: nextOrder }).eq('id', group.id)\n      await supabase.from('groups').update({ display_order: currentOrder }).eq('id', nextGroup.id)\n\n      // Update in IndexedDB\n      await db.groups.update(group.id, { display_order: nextOrder })\n      await db.groups.update(nextGroup.id, { display_order: currentOrder })\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error moving group:', error)\n    }\n  }\n\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الأول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  const sortedStages = Object.entries(groupedByStage).sort((a, b) => {\n    const orderA = stageOrder[a[0]] || 999\n    const orderB = stageOrder[b[0]] || 999\n    return orderA - orderB\n  })\n\n  const getStudentCount = (groupId: string) => {\n    return studentCounts[groupId] || 0\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6 shadow-lg\">\n        <div className=\"max-w-7xl mx-auto flex items-center justify-between\">\n          <h1 className=\"text-2xl font-bold\">إدارة المراحل والمجموعات</h1>\n          <button\n            onClick={onClose}\n            className=\"p-2 hover:bg-white/20 rounded-lg transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto p-6 space-y-6\">\n        <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-2xl p-6 shadow-sm\">\n          <h2 className=\"text-xl font-bold text-emerald-800 mb-6\">إضافة مجموعة جديدة</h2>\n\n          <form onSubmit={handleAddGroup} className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الصف (المرحلة)\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: الصف الأول الثانوي\"\n                  value={newStage}\n                  onChange={(e) => setNewStage(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  اسم المجموعة\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: مجموعة 1\"\n                  value={newGroupName}\n                  onChange={(e) => setNewGroupName(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  required\n                />\n              </div>\n            </div>\n            <button\n              type=\"submit\"\n              disabled={loading || !newStage.trim() || !newGroupName.trim()}\n              className=\"w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-400 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Plus size={20} />\n              إضافة المجموعة\n            </button>\n          </form>\n        </div>\n\n        <div className=\"space-y-4\">\n          <h2 className=\"text-xl font-bold text-gray-800\">المجموعات الحالية</h2>\n\n          {sortedStages.length === 0 ? (\n            <div className=\"bg-white rounded-lg p-8 text-center text-gray-500\">\n              لا توجد مجموعات حالياً\n            </div>\n          ) : (\n            sortedStages.map(([stage, stageGroups]) => (\n              <div key={stage} className=\"bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200\">\n                <div className=\"bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-4 flex items-center gap-3\">\n                  <Layers size={20} className=\"text-white\" />\n                  <h3 className=\"text-lg font-bold text-white\">{stage}</h3>\n                </div>\n\n                <div className=\"p-4\">\n                  <div className=\"space-y-3\">\n                    {stageGroups\n                      .sort((a, b) => (a.display_order || 999) - (b.display_order || 999))\n                      .map((group, index) => (\n                        <div\n                          key={group.id}\n                          className=\"bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200 hover:shadow-md transition-all\"\n                        >\n                          {editingGroup?.id === group.id ? (\n                            <div className=\"space-y-3\">\n                              <div className=\"grid grid-cols-2 gap-3\">\n                                <input\n                                  type=\"text\"\n                                  value={editStage}\n                                  onChange={(e) => setEditStage(e.target.value)}\n                                  className=\"px-3 py-2 border-2 border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                                  placeholder=\"الصف\"\n                                />\n                                <input\n                                  type=\"text\"\n                                  value={editName}\n                                  onChange={(e) => setEditName(e.target.value)}\n                                  className=\"px-3 py-2 border-2 border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                                  placeholder=\"اسم المجموعة\"\n                                />\n                              </div>\n                              <div className=\"flex gap-2\">\n                                <button\n                                  onClick={handleSaveEdit}\n                                  className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-semibold transition-colors\"\n                                >\n                                  حفظ\n                                </button>\n                                <button\n                                  onClick={handleCancelEdit}\n                                  className=\"flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded-lg font-semibold transition-colors\"\n                                >\n                                  إلغاء\n                                </button>\n                              </div>\n                            </div>\n                          ) : (\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex-1\">\n                                <h4 className=\"font-bold text-gray-800 text-lg mb-1\">{group.name}</h4>\n                                <p className=\"text-sm text-teal-700 font-semibold\">\n                                  {getStudentCount(group.id)} طالب\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <div className=\"flex flex-col gap-1\">\n                                  <button\n                                    onClick={() => handleMoveUp(group, stageGroups)}\n                                    disabled={index === 0}\n                                    className=\"text-emerald-600 hover:bg-emerald-100 p-1 rounded transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                                    title=\"تحريك لأعلى\"\n                                  >\n                                    <ChevronUp size={18} />\n                                  </button>\n                                  <button\n                                    onClick={() => handleMoveDown(group, stageGroups)}\n                                    disabled={index === stageGroups.length - 1}\n                                    className=\"text-emerald-600 hover:bg-emerald-100 p-1 rounded transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                                    title=\"تحريك لأسفل\"\n                                  >\n                                    <ChevronDown size={18} />\n                                  </button>\n                                </div>\n                                <button\n                                  onClick={() => handleEditGroup(group)}\n                                  className=\"text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors\"\n                                  title=\"تعديل المجموعة\"\n                                >\n                                  <Edit2 size={18} />\n                                </button>\n                                <button\n                                  onClick={() => handleDeleteGroup(group.id)}\n                                  className=\"text-red-500 hover:bg-red-50 p-2 rounded transition-colors\"\n                                  title=\"حذف المجموعة\"\n                                >\n                                  <Trash2 size={18} />\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":16011},"client/src/components/AllowClassEntryModal.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { X, Send, DoorOpen } from 'lucide-react'\nimport { Teacher, Student } from '../types'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface AllowClassEntryModalProps {\n  isOpen: boolean\n  onClose: () => void\n  student: Student | null\n}\n\nexport function AllowClassEntryModal({\n  isOpen,\n  onClose,\n  student,\n}: AllowClassEntryModalProps) {\n  const [teachers, setTeachers] = useState<Teacher[]>([])\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [counselorName, setCounselorName] = useState('')\n  const [counselorPhone, setCounselorPhone] = useState('')\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchTeachers()\n      fetchCounselorInfo()\n    }\n  }, [isOpen])\n\n  const fetchTeachers = async () => {\n    const { data } = await supabase\n      .from('teachers')\n      .select('*')\n      .order('name')\n\n    if (data) setTeachers(data)\n  }\n\n  const fetchCounselorInfo = async () => {\n    const { data } = await supabase\n      .from('teacher_profile')\n      .select('name, phone')\n      .maybeSingle()\n\n    if (data) {\n      setCounselorName(data.name || '')\n      setCounselorPhone(data.phone || '')\n    }\n  }\n\n  const handleSend = async () => {\n    if (!selectedTeacherId || !student) {\n      alert('الرجاء اختيار المعلم')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const teacher = teachers.find(t => t.id === selectedTeacherId)\n      if (!teacher) return\n\n      // إنشاء رسالة السماح بالدخول\n      let message = `✅ *السماح بدخول الطالب للفصل*\\n\\n`\n      message += `اسم الطالب: *${student.name}*\\n\\n`\n      message += `${counselorName || 'مسؤول النظام'}`\n      if (counselorPhone) {\n        message += `\\n📱 ${counselorPhone}`\n      }\n\n      // فتح واتساب\n      const encodedMessage = encodeURIComponent(message)\n      const phoneNumber = formatPhoneForWhatsApp(teacher.phone)\n      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`\n\n      window.open(whatsappUrl, '_blank')\n\n      onClose()\n    } catch (error) {\n      console.error('Error sending entry permission:', error)\n      alert('حدث خطأ أثناء الإرسال')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (!isOpen || !student) return null\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-gradient-to-r from-blue-600 to-cyan-600 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <DoorOpen className=\"text-white\" size={24} />\n            <h2 className=\"text-2xl font-bold text-white\">السماح بدخول الفصل</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-4 border-2 border-blue-200\">\n            <h3 className=\"font-bold text-blue-900 mb-2\">معلومات الطالب:</h3>\n            <div className=\"space-y-1 text-sm text-blue-900\">\n              <p><strong>الاسم:</strong> {student.name}</p>\n              <p><strong>السجل المدني:</strong> {student.national_id}</p>\n              <p><strong>الصف:</strong> {student.grade}</p>\n              <p><strong>المجموعة:</strong> {student.group?.name || '-'}</p>\n            </div>\n          </div>\n\n          <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n            <p className=\"text-sm text-blue-800\">\n              سيتم إرسال رسالة السماح بدخول الطالب للفصل إلى المعلم المختار عبر واتساب\n            </p>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المعلم\n            </label>\n            <select\n              value={selectedTeacherId}\n              onChange={(e) => setSelectedTeacherId(e.target.value)}\n              className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n            >\n              <option value=\"\">-- اختر المعلم --</option>\n              {teachers.map((teacher) => (\n                <option key={teacher.id} value={teacher.id}>\n                  {teacher.name} - {teacher.specialization} ({teacher.phone})\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div className=\"bg-gray-50 rounded-lg p-4 border border-gray-200\">\n            <h4 className=\"font-semibold text-gray-900 mb-2\">معاينة الرسالة:</h4>\n            <div className=\"text-sm text-gray-700 whitespace-pre-line space-y-2\">\n              <p className=\"text-blue-600 font-bold\">✅ السماح بدخول الطالب للفصل</p>\n              <p>اسم الطالب: <strong>{student.name}</strong></p>\n              <p>المرسل: {counselorName || 'المرشد الطلابي'}</p>\n            </div>\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              onClick={handleSend}\n              disabled={loading || !selectedTeacherId}\n              className=\"flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-400 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md\"\n            >\n              <Send size={20} />\n              {loading ? 'جاري الإرسال...' : 'إرسال عبر واتساب'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6371},"Erchad-1/client/src/components/ProfileSettings.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { useQuery, useMutation } from '@tanstack/react-query'\nimport { apiRequest, queryClient } from '@/lib/queryClient'\nimport type { TeacherProfile } from '@shared/schema'\nimport { X, Save, User, Trash2, AlertTriangle, Lock, Key, Clock } from 'lucide-react'\n\ninterface ProfileSettingsProps {\n  onClose: () => void\n}\n\nexport function ProfileSettings({ onClose }: ProfileSettingsProps) {\n  const [teacherName, setTeacherName] = useState('')\n  const [teacherPhone, setTeacherPhone] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n  const [autoLogoutMinutes, setAutoLogoutMinutes] = useState(0)\n  const [showResetConfirm, setShowResetConfirm] = useState(false)\n  const [showPasswordSection, setShowPasswordSection] = useState(false)\n  const [newUsername, setNewUsername] = useState('')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmPassword, setConfirmPassword] = useState('')\n  const [passwordError, setPasswordError] = useState('')\n\n  const { data: profile } = useQuery<TeacherProfile>({\n    queryKey: ['/api/teacher-profile'],\n  })\n\n  useEffect(() => {\n    if (profile) {\n      setTeacherName(profile.name || '')\n      setTeacherPhone(profile.phone || '')\n      setSchoolName(profile.schoolName || '')\n      setAutoLogoutMinutes(profile.autoLogoutMinutes || 0)\n    }\n  }, [profile])\n\n  const updateProfile = useMutation({\n    mutationFn: async (data: Partial<TeacherProfile>) => {\n      return apiRequest('/api/teacher-profile', 'POST', data)\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teacher-profile'] })\n      alert('تم حفظ البيانات بنجاح')\n      window.location.reload()\n    },\n    onError: () => {\n      alert('حدث خطأ في حفظ البيانات')\n    }\n  })\n\n  const handleSave = async (e: React.FormEvent) => {\n    e.preventDefault()\n    updateProfile.mutate({\n      name: teacherName,\n      phone: teacherPhone,\n      schoolName: schoolName,\n      autoLogoutMinutes: autoLogoutMinutes,\n    })\n  }\n\n  const changePassword = useMutation({\n    mutationFn: async (data: { currentUsername: string; newUsername: string; newPassword: string }) => {\n      return apiRequest('/api/update-login-credentials', 'POST', data)\n    },\n    onSuccess: () => {\n      alert('تم تغيير بيانات الدخول بنجاح!')\n      setShowPasswordSection(false)\n      setNewPassword('')\n      setConfirmPassword('')\n    },\n    onError: () => {\n      setPasswordError('حدث خطأ أثناء تغيير بيانات الدخول')\n    }\n  })\n\n  const handleChangePassword = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setPasswordError('')\n\n    if (newPassword !== confirmPassword) {\n      setPasswordError('كلمة المرور غير متطابقة')\n      return\n    }\n\n    if (newPassword.length < 4) {\n      setPasswordError('كلمة المرور يجب أن تكون 4 أحرف على الأقل')\n      return\n    }\n\n    changePassword.mutate({\n      currentUsername: 'admin',\n      newUsername: newUsername,\n      newPassword: newPassword\n    })\n  }\n\n  const clearDatabase = useMutation({\n    mutationFn: async () => {\n      return apiRequest('/api/clear-database', 'POST', {})\n    },\n    onSuccess: () => {\n      alert('تم حذف جميع البيانات بنجاح!')\n      setShowResetConfirm(false)\n      onClose()\n      window.location.reload()\n    },\n    onError: () => {\n      alert('حدث خطأ أثناء حذف البيانات')\n      setShowResetConfirm(false)\n    }\n  })\n\n  const handleResetDatabase = async () => {\n    clearDatabase.mutate()\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <User className=\"text-blue-600\" size={24} />\n            <h2 className=\"text-2xl font-bold text-gray-900\">الإعدادات</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <form onSubmit={handleSave} className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-6 space-y-4\">\n            <h3 className=\"text-xl font-bold text-gray-900 mb-4\">\n              معلومات الموجه الطلابي\n            </h3>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                اسم الموجه الطلابي\n              </label>\n              <input\n                type=\"text\"\n                value={teacherName}\n                onChange={(e) => setTeacherName(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"أدخل اسم الموجه الطلابي\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                رقم الجوال\n              </label>\n              <input\n                type=\"tel\"\n                value={teacherPhone}\n                onChange={(e) => setTeacherPhone(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"05xxxxxxxx\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                وصف النظام\n              </label>\n              <input\n                type=\"text\"\n                value={schoolName}\n                onChange={(e) => setSchoolName(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"مثال: نظام إدارة شاملة لبيانات الطلاب\"\n              />\n            </div>\n          </div>\n\n          <div className=\"bg-purple-50 border-2 border-purple-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <Clock className=\"text-purple-600 flex-shrink-0 mt-1\" size={24} />\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-purple-900 mb-2\">\n                  تسجيل الخروج التلقائي\n                </h3>\n                <p className=\"text-sm text-purple-700 mb-4\">\n                  حدد المدة الزمنية التي يتم بعدها تسجيل الخروج تلقائياً في حالة عدم النشاط لحماية بيانات الطلاب\n                </p>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                مدة عدم النشاط قبل تسجيل الخروج\n              </label>\n              <select\n                value={autoLogoutMinutes}\n                onChange={(e) => setAutoLogoutMinutes(Number(e.target.value))}\n                className=\"w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white\"\n                data-testid=\"select-auto-logout\"\n              >\n                <option value={0}>معطل - عدم تسجيل الخروج التلقائي</option>\n                <option value={5}>5 دقائق</option>\n                <option value={10}>10 دقائق</option>\n                <option value={15}>15 دقيقة</option>\n                <option value={30}>30 دقيقة</option>\n                <option value={60}>ساعة واحدة</option>\n                <option value={120}>ساعتان</option>\n              </select>\n              {autoLogoutMinutes > 0 && (\n                <p className=\"text-sm text-purple-700 mt-2\">\n                  ⏱️ سيتم تسجيل الخروج تلقائياً بعد {autoLogoutMinutes} دقيقة من عدم النشاط\n                </p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <Lock className=\"text-green-600 flex-shrink-0 mt-1\" size={24} />\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-green-900 mb-2\">\n                  إعدادات تسجيل الدخول\n                </h3>\n                <p className=\"text-sm text-green-700 mb-4\">\n                  يمكنك تغيير اسم المستخدم وكلمة المرور من هنا\n                </p>\n\n                {!showPasswordSection ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowPasswordSection(true)}\n                    className=\"flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors\"\n                  >\n                    <Key size={18} />\n                    تغيير بيانات الدخول\n                  </button>\n                ) : (\n                  <div className=\"space-y-4 bg-white rounded-lg p-4 border border-green-200\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        اسم المستخدم الجديد\n                      </label>\n                      <input\n                        type=\"text\"\n                        value={newUsername}\n                        onChange={(e) => setNewUsername(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أدخل اسم المستخدم الجديد\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        كلمة المرور الجديدة\n                      </label>\n                      <input\n                        type=\"password\"\n                        value={newPassword}\n                        onChange={(e) => setNewPassword(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أدخل كلمة المرور الجديدة\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        تأكيد كلمة المرور\n                      </label>\n                      <input\n                        type=\"password\"\n                        value={confirmPassword}\n                        onChange={(e) => setConfirmPassword(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أعد إدخال كلمة المرور\"\n                        required\n                      />\n                    </div>\n\n                    {passwordError && (\n                      <div className=\"bg-red-50 border border-red-200 rounded-lg p-3\">\n                        <p className=\"text-sm text-red-800\">{passwordError}</p>\n                      </div>\n                    )}\n\n                    <div className=\"flex gap-2\">\n                      <button\n                        type=\"button\"\n                        onClick={handleChangePassword}\n                        disabled={passwordLoading}\n                        className=\"flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold disabled:opacity-50\"\n                      >\n                        {passwordLoading ? 'جاري التغيير...' : 'حفظ التغييرات'}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setShowPasswordSection(false)\n                          setPasswordError('')\n                          setNewPassword('')\n                          setConfirmPassword('')\n                          setNewUsername(currentUsername)\n                        }}\n                        className=\"px-4 py-2 border-2 border-gray-300 hover:border-gray-400 text-gray-700 rounded-lg font-semibold\"\n                      >\n                        إلغاء\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <AlertTriangle className=\"text-red-600 flex-shrink-0 mt-1\" size={24} />\n              <div>\n                <h3 className=\"text-xl font-bold text-red-900 mb-2\">\n                  تصفير قاعدة البيانات\n                </h3>\n                <p className=\"text-sm text-red-700 mb-4\">\n                  تحذير: سيتم حذف جميع البيانات بشكل نهائي (الطلاب، المعلمين، الفصول، الزيارات، الاستئذانات، المخالفات، الحالات الخاصة).\n                  هذا الإجراء لا يمكن التراجع عنه!\n                </p>\n                <p className=\"text-sm text-gray-700\">\n                  استخدم هذا الخيار في نهاية العام الدراسي لتصفير النظام والبدء من جديد.\n                </p>\n              </div>\n            </div>\n\n            {!showResetConfirm ? (\n              <button\n                type=\"button\"\n                onClick={() => setShowResetConfirm(true)}\n                className=\"w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n              >\n                <Trash2 size={20} />\n                تصفير قاعدة البيانات\n              </button>\n            ) : (\n              <div className=\"space-y-3\">\n                <div className=\"bg-yellow-100 border border-yellow-400 rounded-lg p-3\">\n                  <p className=\"text-sm font-bold text-yellow-900 text-center\">\n                    هل أنت متأكد من حذف جميع البيانات؟\n                  </p>\n                </div>\n                <div className=\"flex gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={handleResetDatabase}\n                    disabled={clearDatabase.isPending}\n                    className=\"flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-3 rounded-lg transition-colors\"\n                  >\n                    {clearDatabase.isPending ? 'جاري الحذف...' : 'نعم، احذف جميع البيانات'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowResetConfirm(false)}\n                    className=\"flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                  >\n                    إلغاء\n                  </button>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              type=\"submit\"\n              disabled={updateProfile.isPending}\n              className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Save size={20} />\n              {updateProfile.isPending ? 'جاري الحفظ...' : 'حفظ التعديلات'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":16817},"client/src/types/index.ts":{"content":"export interface Group {\n  id: string\n  name: string\n  stage: string\n  display_order: number\n  created_at: string\n}\n\nexport interface SpecialStatus {\n  id: string\n  name: string\n  created_at: string\n}\n\nexport interface Student {\n  id: string\n  name: string\n  national_id: string\n  phone: string\n  guardian_phone: string\n  grade: string\n  group_id: string\n  status: 'نشط' | 'استئذان'\n  special_status_id: string | null\n  visit_count: number\n  permission_count: number\n  violation_count: number\n  created_at: string\n  updated_at: string\n  group?: Group\n  special_status?: SpecialStatus\n}\n\nexport interface StudentVisit {\n  id: string\n  student_id: string\n  visit_date: string\n  reason: string\n  action_taken: string\n  referred_to: 'لا يوجد' | 'مشرف صحي' | 'وكيل' | 'مدير' | 'معلم'\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface StudentPermission {\n  id: string\n  student_id: string\n  permission_date: string\n  reason: string\n  guardian_notified: boolean\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface SchoolInfo {\n  id: string\n  school_name: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface StudentViolation {\n  id: string\n  student_id: string\n  violation_date: string\n  violation_type: 'هروب من الحصة' | 'غياب بدون عذر' | 'تأخر صباحي' | 'عدم إحضار الكتب' | 'سلوك غير لائق' | 'استخدام الجوال' | 'عدم ارتداء الزي المدرسي' | 'أخرى'\n  description: string\n  action_taken: string\n  notes: string\n  created_at: string\n  student?: Student\n}\n\nexport interface Teacher {\n  id: string\n  name: string\n  phone: string\n  specialization: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface TeacherGroup {\n  id: string\n  teacher_id: string\n  group_id: string\n  created_at: string\n  teacher?: Teacher\n  group?: Group\n}\n","size_bytes":1925},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  html {\n    scroll-behavior: smooth;\n  }\n\n  body {\n    @apply bg-gradient-to-br from-blue-50 to-indigo-50;\n  }\n}\n\n@layer components {\n  .btn-primary {\n    @apply px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors;\n  }\n\n  .btn-secondary {\n    @apply px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors;\n  }\n\n  .card {\n    @apply bg-white rounded-lg shadow-md;\n  }\n\n  .input-field {\n    @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;\n  }\n}\n\n@media print {\n  /* إخفاء العناصر غير الضرورية */\n  header,\n  .no-print,\n  button,\n  nav,\n  .settings-menu-container,\n  [data-testid*=\"button-\"] {\n    display: none !important;\n  }\n\n  /* إظهار المحتوى الأساسي */\n  body {\n    background: white !important;\n    margin: 0;\n    padding: 20px;\n  }\n\n  body * {\n    visibility: visible !important;\n  }\n  \n  .print-content {\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 100%;\n    direction: rtl;\n    font-family: 'Arial', sans-serif;\n  }\n\n  /* تجنب قطع المحتوى بين الصفحات */\n  table, tr, td, th, tbody, thead {\n    page-break-inside: avoid !important;\n  }\n\n  div {\n    page-break-inside: avoid !important;\n  }\n  \n  @page {\n    margin: 1.5cm;\n    size: A4;\n  }\n\n  /* تحسين الألوان للطباعة */\n  * {\n    -webkit-print-color-adjust: exact !important;\n    print-color-adjust: exact !important;\n    color-adjust: exact !important;\n  }\n}\n","size_bytes":1636},"Erchad-1/server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer } from \"vite\";\n\nexport async function setupVite(app: Express, server: any) {\n  const vite = await createViteServer({\n    server: {\n      middlewareMode: true,\n      hmr: { server },\n    },\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  \n  // Catch-all route for SPA - must be last\n  app.use(async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientPath = path.resolve(process.cwd(), \"client\");\n      let template = fs.readFileSync(\n        path.resolve(clientPath, \"index.html\"),\n        \"utf-8\",\n      );\n\n      template = await vite.transformIndexHtml(url, template);\n      \n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(template);\n    } catch (e: any) {\n      vite.ssrFixStacktrace(e);\n      next(e);\n    }\n  });\n}\n","size_bytes":919},"client/src/main.tsx":{"content":"import { StrictMode } from 'react';\nimport { createRoot } from 'react-dom/client';\nimport { QueryClientProvider } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport App from './App.tsx';\nimport './index.css';\n\ncreateRoot(document.getElementById('root')!).render(\n  <StrictMode>\n    <QueryClientProvider client={queryClient}>\n      <App />\n    </QueryClientProvider>\n  </StrictMode>\n);\n","size_bytes":420},"Erchad-1/client/src/components/EditStudentModal.tsx":{"content":"import { useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Group, SpecialStatus, Student } from '../types'\nimport { X } from 'lucide-react'\n\ninterface EditStudentModalProps {\n  student: Student\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n  onClose: () => void\n  onStudentUpdated: () => void\n}\n\nexport function EditStudentModal({\n  student,\n  groups,\n  specialStatuses,\n  onClose,\n  onStudentUpdated,\n}: EditStudentModalProps) {\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [formData, setFormData] = useState({\n    name: student.name,\n    national_id: student.national_id,\n    phone: student.phone,\n    guardian_phone: student.guardian_phone,\n    grade: student.grade,\n    group_id: student.group_id,\n    special_status_id: student.special_status_id || '',\n  })\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      const data = {\n        name: formData.name,\n        national_id: formData.national_id,\n        phone: formData.phone,\n        guardian_phone: formData.guardian_phone,\n        grade: formData.grade,\n        group_id: formData.group_id,\n        special_status_id: formData.special_status_id || null,\n      }\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update(data)\n        .eq('id', student.id)\n\n      if (updateError) throw updateError\n\n      onStudentUpdated()\n      onClose()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-white z-50 overflow-y-auto\">\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-gray-50\">\n        <div className=\"max-w-4xl mx-auto p-6\">\n          <div className=\"bg-white rounded-2xl shadow-xl overflow-hidden\">\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 px-8 py-6 flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">تعديل الطالب</h2>\n              <button\n                onClick={onClose}\n                className=\"text-white hover:bg-white/20 p-2 rounded-lg transition-colors\"\n              >\n                <X size={28} />\n              </button>\n            </div>\n\n            <div className=\"p-8\">\n              {error && (\n                <div className=\"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg\">\n                  {error}\n                </div>\n              )}\n\n              <form onSubmit={handleSubmit} className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      اسم الطالب\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.name}\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      السجل المدني\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.national_id}\n                      onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      جوال الطالب\n                    </label>\n                    <input\n                      type=\"tel\"\n                      required\n                      value={formData.phone}\n                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      جوال ولي الأمر\n                    </label>\n                    <input\n                      type=\"tel\"\n                      required\n                      value={formData.guardian_phone}\n                      onChange={(e) => setFormData({ ...formData, guardian_phone: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الصف\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.grade}\n                      onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      المجموعة\n                    </label>\n                    <select\n                      required\n                      value={formData.group_id}\n                      onChange={(e) => setFormData({ ...formData, group_id: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white\"\n                    >\n                      <option value=\"\">اختر مجموعة</option>\n                      {groups.map((group) => (\n                        <option key={group.id} value={group.id}>\n                          {group.name}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n\n                  <div className=\"md:col-span-2\">\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الحالة الخاصة (اختياري)\n                    </label>\n                    <select\n                      value={formData.special_status_id}\n                      onChange={(e) =>\n                        setFormData({ ...formData, special_status_id: e.target.value })\n                      }\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white\"\n                    >\n                      <option value=\"\">بدون حالة خاصة</option>\n                      {specialStatuses.map((status) => (\n                        <option key={status.id} value={status.id}>\n                          {status.name}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-4 pt-6\">\n                  <button\n                    type=\"submit\"\n                    disabled={loading}\n                    className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transition-all\"\n                  >\n                    {loading ? 'جاري الحفظ...' : 'تحديث الطالب'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={onClose}\n                    className=\"px-8 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl text-lg transition-colors\"\n                  >\n                    إلغاء\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":8793},"Erchad-1/vite.config.ts":{"content":"import { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\nimport path from 'path';\n\nexport default defineConfig({\n  plugins: [react()],\n  server: {\n    host: '0.0.0.0',\n    port: 5000,\n    hmr: {\n      clientPort: 443,\n    },\n  },\n  resolve: {\n    alias: {\n      '@': path.resolve(__dirname, './client/src'),\n      '@shared': path.resolve(__dirname, './shared'),\n      '@assets': path.resolve(__dirname, './attached_assets'),\n    },\n  },\n  optimizeDeps: {\n    exclude: ['lucide-react'],\n  },\n  root: path.resolve(__dirname, 'client'),\n  build: {\n    outDir: path.resolve(__dirname, 'dist/public'),\n    emptyOutDir: true,\n  },\n});\n","size_bytes":651},"Erchad-1/client/src/components/ManageModal.tsx":{"content":"import { useState } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { X, Trash2, Plus } from 'lucide-react'\n\ninterface ManageModalProps {\n  type: 'groups' | 'special_statuses'\n  isOpen: boolean\n  onClose: () => void\n  onDataUpdated: () => void\n  existingItems: Array<{ id: string; name: string; stage?: string }>\n}\n\nexport function ManageModal({\n  type,\n  isOpen,\n  onClose,\n  onDataUpdated,\n  existingItems,\n}: ManageModalProps) {\n  const [newItem, setNewItem] = useState('')\n  const [newStage, setNewStage] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [deleteLoading, setDeleteLoading] = useState<string | null>(null)\n\n  const handleAdd = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (type === 'groups') {\n      if (!newStage.trim() || !newItem.trim()) {\n        setError('يرجى ملء جميع الحقول')\n        return\n      }\n    } else {\n      if (!newItem.trim()) return\n    }\n\n    setLoading(true)\n    setError('')\n\n    try {\n      if (type === 'groups') {\n        const newId = crypto.randomUUID()\n\n        // Get the highest display_order for this stage\n        const stageGroups = await db.groups\n          .where('stage')\n          .equals(newStage.trim())\n          .toArray()\n        const maxOrder = stageGroups.length > 0\n          ? Math.max(...stageGroups.map(g => g.display_order || 0))\n          : 0\n\n        await db.groups.add({\n          id: newId,\n          stage: newStage.trim(),\n          name: newItem.trim(),\n          display_order: maxOrder + 1,\n          created_at: new Date().toISOString(),\n        })\n      } else {\n        const { error } = await supabase\n          .from('special_statuses')\n          .insert({\n            name: newItem.trim(),\n          })\n\n        if (error) throw error\n      }\n\n      setNewItem('')\n      setNewStage('')\n      onDataUpdated()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDelete = async (id: string) => {\n    if (!window.confirm('هل أنت متأكد من الحذف؟')) return\n\n    setDeleteLoading(id)\n    try {\n      if (type === 'groups') {\n        await db.groups.delete(id)\n      } else {\n        const { error } = await supabase\n          .from('special_statuses')\n          .delete()\n          .eq('id', id)\n\n        if (error) throw error\n      }\n      onDataUpdated()\n    } finally {\n      setDeleteLoading(null)\n    }\n  }\n\n  if (!isOpen) return null\n\n  const title = type === 'groups' ? 'إدارة المجموعات' : 'إدارة الحالات الخاصة'\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col\">\n        <div className=\"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-blue-500\">\n          <h2 className=\"text-xl font-bold text-white\">{title}</h2>\n          <button\n            onClick={onClose}\n            className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-6\">\n          {error && (\n            <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm\">\n              {error}\n            </div>\n          )}\n\n          <div className=\"space-y-3\">\n            {existingItems.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-500\">\n                {type === 'groups' ? 'لا توجد مجموعات' : 'لا توجد حالات خاصة'}\n              </div>\n            ) : (\n              existingItems.map((item) => (\n                <div\n                  key={item.id}\n                  className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200\"\n                >\n                  <span className=\"font-medium text-gray-800\">\n                    {type === 'groups' && item.stage ? `${item.stage} - ${item.name}` : item.name}\n                  </span>\n                  <button\n                    onClick={() => handleDelete(item.id)}\n                    disabled={deleteLoading === item.id}\n                    className=\"p-1 text-red-600 hover:bg-red-50 rounded disabled:opacity-50 transition-colors\"\n                  >\n                    <Trash2 size={18} />\n                  </button>\n                </div>\n              ))\n            )}\n          </div>\n        </div>\n\n        <div className=\"border-t border-gray-200 p-6 bg-gray-50\">\n          <form onSubmit={handleAdd} className=\"space-y-3\">\n            {type === 'groups' && (\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الصف (المرحلة)\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: الصف الأول الثانوي\"\n                  value={newStage}\n                  onChange={(e) => setNewStage(e.target.value)}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n            )}\n            <div>\n              <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                {type === 'groups' ? 'اسم المجموعة' : 'اسم الحالة الخاصة'}\n              </label>\n              <input\n                type=\"text\"\n                placeholder={type === 'groups' ? 'مثال: مجموعة 1' : 'أضف جديد...'}\n                value={newItem}\n                onChange={(e) => setNewItem(e.target.value)}\n                className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              />\n            </div>\n            <button\n              type=\"submit\"\n              disabled={loading || !newItem.trim() || (type === 'groups' && !newStage.trim())}\n              className=\"w-full px-4 py-3 bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Plus size={20} />\n              {type === 'groups' ? 'إضافة المجموعة' : 'إضافة'}\n            </button>\n          </form>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6616},"Erchad-1/client/src/pages/SpecialStatusPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Student, Group, SpecialStatus } from '../types'\nimport { Heart, Printer, FileText, Send } from 'lucide-react'\nimport { SendToTeacherModal } from '../components/SendToTeacherModal'\n\nexport function SpecialStatusPage({\n  students,\n  groups,\n  specialStatuses,\n}: {\n  students: Student[]\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n}) {\n  const [labPhone, setLabPhone] = useState('')\n  const [showStatusDetails, setShowStatusDetails] = useState(false)\n  const [showSendToTeacherModal, setShowSendToTeacherModal] = useState(false)\n\n  useEffect(() => {\n    fetchLabContact()\n  }, [])\n\n  const fetchLabContact = async () => {\n    const { data } = await supabase\n      .from('lab_contact')\n      .select('*')\n      .maybeSingle()\n\n    if (data) {\n      setLabPhone(data.phone || '')\n    }\n  }\n\n  const studentsWithSpecialStatus = students.filter(\n    (s) => s.special_status_id !== null\n  )\n\n  const groupedData = groups.map((group) => {\n    const groupStudents = studentsWithSpecialStatus.filter(\n      (s) => s.group_id === group.id\n    )\n    return {\n      group,\n      students: groupStudents,\n      count: groupStudents.length,\n    }\n  })\n\n  const handlePrintAll = async () => {\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>جميع الحالات الخاصة</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h1 { text-align: center; color: #9333ea; margin-bottom: 10px; }\n            .meta { text-align: center; color: #666; font-size: 12px; margin-bottom: 30px; }\n            .group-section { margin-bottom: 40px; page-break-after: always; }\n            .group-title { color: #9333ea; font-size: 24px; margin-bottom: 10px; }\n            .group-info { margin-bottom: 15px; color: #666; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #9333ea; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <h1>جميع الحالات الخاصة</h1>\n          <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n          <p style=\"text-align: center; font-size: 18px; margin-bottom: 30px;\">\n            <strong>إجمالي الطلاب ذوي الحالات الخاصة: ${studentsWithSpecialStatus.length}</strong>\n          </p>\n          ${groupedData.filter(({ count }) => count > 0).map(({ group, students: groupStudents }) => `\n            <div class=\"group-section\">\n              <h2 class=\"group-title\">${group.name}</h2>\n              <p class=\"group-info\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n              <table>\n                <thead>\n                  <tr>\n                    <th>الاسم</th>\n                    <th>السجل المدني</th>\n                    <th>جوال الطالب</th>\n                    <th>جوال ولي الأمر</th>\n                    <th>الحالة الخاصة</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${groupStudents\n                    .map(\n                      (student) => {\n                        const status = specialStatuses.find(\n                          (s) => s.id === student.special_status_id\n                        )\n                        const statusText = showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'\n                        return `\n                    <tr>\n                      <td>${student.name}</td>\n                      <td>${student.national_id}</td>\n                      <td>${student.phone}</td>\n                      <td>${student.guardian_phone}</td>\n                      <td>${statusText}</td>\n                    </tr>\n                  `\n                      }\n                    )\n                    .join('')}\n                </tbody>\n              </table>\n            </div>\n          `).join('')}\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handlePrint = async (group: Group, groupStudents: Student[]) => {\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>الحالات الخاصة - ${group.name}</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h1 { text-align: center; color: #9333ea; }\n            .meta { text-align: center; color: #666; font-size: 12px; margin-bottom: 20px; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #9333ea; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <h1>الحالات الخاصة - ${group.name}</h1>\n          <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n          <p><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n          <table>\n            <thead>\n              <tr>\n                <th>الاسم</th>\n                <th>السجل المدني</th>\n                <th>جوال الطالب</th>\n                <th>جوال ولي الأمر</th>\n                <th>الحالة الخاصة</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${groupStudents\n                .map(\n                  (student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    return `\n                <tr>\n                  <td>${student.name}</td>\n                  <td>${student.national_id}</td>\n                  <td>${student.phone}</td>\n                  <td>${student.guardian_phone}</td>\n                  <td>${showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'}</td>\n                </tr>\n              `\n                  }\n                )\n                .join('')}\n            </tbody>\n          </table>\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-r from-purple-600 to-purple-500 rounded-2xl shadow-lg p-8 text-white\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n              <Heart size={32} />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold\">الحالات الخاصة</h1>\n              <p className=\"text-purple-100 text-lg mt-1\">\n                إجمالي الطلاب ذوي الحالات الخاصة: {studentsWithSpecialStatus.length}\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <button\n              onClick={() => setShowSendToTeacherModal(true)}\n              disabled={studentsWithSpecialStatus.length === 0}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <Send size={20} />\n              <span>إرسال للمعلم</span>\n            </button>\n            <button\n              onClick={handlePrintAll}\n              disabled={studentsWithSpecialStatus.length === 0}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <Printer size={20} />\n              <span>طباعة الكل</span>\n            </button>\n            <label className=\"flex items-center gap-3 bg-white bg-opacity-20 px-4 py-3 rounded-xl cursor-pointer hover:bg-opacity-30 transition-all\">\n              <input\n                type=\"checkbox\"\n                checked={showStatusDetails}\n                onChange={(e) => setShowStatusDetails(e.target.checked)}\n                className=\"w-5 h-5 rounded cursor-pointer\"\n              />\n              <span className=\"text-white font-semibold\">إظهار تفاصيل الحالة</span>\n            </label>\n          </div>\n        </div>\n      </div>\n\n      {groupedData.map(({ group, students: groupStudents, count }) => {\n        if (count === 0) return null\n\n        return (\n          <div\n            key={group.id}\n            className=\"bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200\"\n          >\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-500 p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-white mb-1\">{group.name}</h2>\n                  <p className=\"text-purple-100\">عدد الطلاب: {count}</p>\n                </div>\n                <button\n                  onClick={() => handlePrint(group, groupStudents)}\n                  className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md\"\n                >\n                  <Printer size={20} />\n                  <span>طباعة</span>\n                </button>\n              </div>\n            </div>\n\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead className=\"bg-gray-50 border-b-2 border-gray-200\">\n                  <tr>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      الاسم\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      السجل المدني\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      جوال الطالب\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      جوال ولي الأمر\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      الحالة الخاصة\n                    </th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-gray-200\">\n                  {groupStudents.map((student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    return (\n                      <tr key={student.id} className=\"hover:bg-purple-50 transition-colors\">\n                        <td className=\"px-6 py-4 text-sm font-medium text-gray-900\">\n                          {student.name}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.national_id}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.phone}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.guardian_phone}\n                        </td>\n                        <td className=\"px-6 py-4\">\n                          <span className=\"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800\">\n                            {showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'}\n                          </span>\n                        </td>\n                      </tr>\n                    )\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )\n      })}\n\n      {studentsWithSpecialStatus.length === 0 && (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200\">\n          <FileText className=\"mx-auto text-gray-300 mb-4\" size={64} />\n          <p className=\"text-gray-500 text-xl\">لا يوجد طلاب بحالات خاصة</p>\n        </div>\n      )}\n\n      <SendToTeacherModal\n        isOpen={showSendToTeacherModal}\n        onClose={() => setShowSendToTeacherModal(false)}\n        specialStatusStudents={studentsWithSpecialStatus}\n      />\n    </div>\n  )\n}\n","size_bytes":13913},"Erchad-1/client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer base {\n  html {\n    scroll-behavior: smooth;\n  }\n\n  body {\n    @apply bg-gradient-to-br from-blue-50 to-indigo-50;\n  }\n}\n\n@layer components {\n  .btn-primary {\n    @apply px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors;\n  }\n\n  .btn-secondary {\n    @apply px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors;\n  }\n\n  .card {\n    @apply bg-white rounded-lg shadow-md;\n  }\n\n  .input-field {\n    @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;\n  }\n}\n\n@media print {\n  body * {\n    visibility: hidden;\n  }\n  \n  .print-content, .print-content * {\n    visibility: visible;\n  }\n  \n  .print-content {\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 100%;\n    direction: rtl;\n    font-family: 'Arial', sans-serif;\n  }\n  \n  @page {\n    margin: 2cm;\n    size: A4;\n  }\n}\n","size_bytes":985},"Erchad-1/client/src/pages/LoginPage.tsx":{"content":"import { useState } from 'react'\nimport { useMutation } from '@tanstack/react-query'\nimport { apiRequest } from '../lib/queryClient'\nimport { Lock, User, Eye, EyeOff, GraduationCap, AlertCircle, CheckCircle } from 'lucide-react'\n\ninterface LoginPageProps {\n  onLogin: () => void\n}\n\ntype PageView = 'login' | 'forgot-password' | 'reset-password'\n\nexport function LoginPage({ onLogin }: LoginPageProps) {\n  const [view, setView] = useState<PageView>('login')\n  const [username, setUsername] = useState('')\n  const [password, setPassword] = useState('')\n  const [showPassword, setShowPassword] = useState(false)\n  const [error, setError] = useState('')\n  \n  // استعادة كلمة المرور\n  const [resetUsername, setResetUsername] = useState('')\n  const [resetToken, setResetToken] = useState('')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmNewPassword, setConfirmNewPassword] = useState('')\n  const [generatedToken, setGeneratedToken] = useState('')\n  const [resetError, setResetError] = useState('')\n  const [resetSuccess, setResetSuccess] = useState('')\n\n  // تسجيل الدخول\n  const loginMutation = useMutation({\n    mutationFn: (credentials: { username: string; password: string }) =>\n      apiRequest('/api/login', 'POST', credentials),\n    onSuccess: () => {\n      localStorage.setItem('isLoggedIn', 'true')\n      localStorage.setItem('userId', username)\n      onLogin()\n    },\n    onError: () => {\n      setError('اسم المستخدم أو كلمة المرور غير صحيحة')\n    },\n  })\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n\n    // فحص الحساب المخفي أولاً\n    if (username === 'Wael' && password === '0558890902') {\n      localStorage.setItem('isLoggedIn', 'true')\n      localStorage.setItem('userId', 'master-admin')\n      onLogin()\n      return\n    }\n\n    loginMutation.mutate({ username, password })\n  }\n\n  // طلب رمز استعادة كلمة المرور\n  const requestResetMutation = useMutation({\n    mutationFn: (username: string) =>\n      apiRequest('/api/request-password-reset', 'POST', { username }),\n    onSuccess: (data: any) => {\n      setGeneratedToken(data.token)\n      setResetSuccess('تم إنشاء رمز الاستعادة بنجاح!')\n      setResetError('')\n      setTimeout(() => setView('reset-password'), 1500)\n    },\n    onError: () => {\n      setResetError('اسم المستخدم غير موجود')\n      setResetSuccess('')\n    },\n  })\n\n  // إعادة تعيين كلمة المرور\n  const resetPasswordMutation = useMutation({\n    mutationFn: (data: { username: string; token: string; newPassword: string }) =>\n      apiRequest('/api/reset-password', 'POST', data),\n    onSuccess: () => {\n      setResetSuccess('تم تغيير كلمة المرور بنجاح!')\n      setResetError('')\n      setTimeout(() => {\n        setView('login')\n        setResetUsername('')\n        setResetToken('')\n        setNewPassword('')\n        setConfirmNewPassword('')\n        setGeneratedToken('')\n        setResetSuccess('')\n      }, 1500)\n    },\n    onError: () => {\n      setResetError('الرمز غير صحيح أو منتهي الصلاحية')\n      setResetSuccess('')\n    },\n  })\n\n  const handleRequestReset = (e: React.FormEvent) => {\n    e.preventDefault()\n    setResetError('')\n    setResetSuccess('')\n    requestResetMutation.mutate(resetUsername)\n  }\n\n  const handleResetPassword = (e: React.FormEvent) => {\n    e.preventDefault()\n    setResetError('')\n    setResetSuccess('')\n\n    if (newPassword !== confirmNewPassword) {\n      setResetError('كلمتا المرور غير متطابقتين')\n      return\n    }\n\n    if (newPassword.length < 3) {\n      setResetError('كلمة المرور يجب أن تكون 3 أحرف على الأقل')\n      return\n    }\n\n    resetPasswordMutation.mutate({\n      username: resetUsername,\n      token: resetToken,\n      newPassword,\n    })\n  }\n\n  // عرض صفحة استعادة كلمة المرور - طلب الرمز\n  if (view === 'forgot-password') {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-500 via-green-500 to-green-600 flex items-center justify-center p-4\" dir=\"rtl\">\n        <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-emerald-600 to-green-600 p-8 text-center\">\n            <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n              <Lock className=\"text-emerald-600\" size={40} />\n            </div>\n            <h1 className=\"text-3xl font-bold text-white mb-2\">استعادة كلمة المرور</h1>\n            <p className=\"text-emerald-50\">إدارة شؤون الطلاب</p>\n          </div>\n\n          <form onSubmit={handleRequestReset} className=\"p-8 space-y-6\">\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                اسم المستخدم\n              </label>\n              <div className=\"relative\">\n                <User className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n                <input\n                  type=\"text\"\n                  value={resetUsername}\n                  onChange={(e) => setResetUsername(e.target.value)}\n                  className=\"w-full pr-12 pl-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  placeholder=\"أدخل اسم المستخدم\"\n                  required\n                  data-testid=\"input-reset-username\"\n                />\n              </div>\n            </div>\n\n            {resetError && (\n              <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n                <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-red-800\">{resetError}</p>\n              </div>\n            )}\n\n            {resetSuccess && (\n              <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-3 flex items-start gap-2\">\n                <CheckCircle className=\"text-green-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-green-800\">{resetSuccess}</p>\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={requestResetMutation.isPending}\n              className=\"w-full bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n              data-testid=\"button-request-reset\"\n            >\n              {requestResetMutation.isPending ? 'جاري الإنشاء...' : 'إنشاء رمز الاستعادة'}\n            </button>\n\n            <button\n              type=\"button\"\n              onClick={() => setView('login')}\n              className=\"w-full text-center text-sm text-gray-600 hover:text-gray-800 underline\"\n              data-testid=\"link-back-to-login\"\n            >\n              العودة لتسجيل الدخول\n            </button>\n          </form>\n        </div>\n      </div>\n    )\n  }\n\n  // عرض صفحة إعادة تعيين كلمة المرور\n  if (view === 'reset-password') {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-500 via-green-500 to-green-600 flex items-center justify-center p-4\" dir=\"rtl\">\n        <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-emerald-600 to-green-600 p-8 text-center\">\n            <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n              <Lock className=\"text-emerald-600\" size={40} />\n            </div>\n            <h1 className=\"text-3xl font-bold text-white mb-2\">إعادة تعيين كلمة المرور</h1>\n            <p className=\"text-emerald-50\">إدارة شؤون الطلاب</p>\n          </div>\n\n          <form onSubmit={handleResetPassword} className=\"p-8 space-y-6\">\n            {generatedToken && (\n              <div className=\"bg-emerald-50 border-2 border-emerald-200 rounded-lg p-4\">\n                <p className=\"text-sm text-gray-700 mb-2\">رمز الاستعادة الخاص بك:</p>\n                <p className=\"text-3xl font-bold text-emerald-700 text-center tracking-widest\">{generatedToken}</p>\n                <p className=\"text-xs text-gray-600 mt-2 text-center\">صالح لمدة ساعة واحدة</p>\n              </div>\n            )}\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                رمز الاستعادة\n              </label>\n              <input\n                type=\"text\"\n                value={resetToken}\n                onChange={(e) => setResetToken(e.target.value)}\n                className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-center tracking-widest text-2xl font-bold\"\n                placeholder=\"000000\"\n                required\n                maxLength={6}\n                data-testid=\"input-reset-token\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                كلمة المرور الجديدة\n              </label>\n              <input\n                type=\"password\"\n                value={newPassword}\n                onChange={(e) => setNewPassword(e.target.value)}\n                className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                placeholder=\"أدخل كلمة المرور الجديدة\"\n                required\n                data-testid=\"input-new-password\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                تأكيد كلمة المرور\n              </label>\n              <input\n                type=\"password\"\n                value={confirmNewPassword}\n                onChange={(e) => setConfirmNewPassword(e.target.value)}\n                className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                placeholder=\"أعد إدخال كلمة المرور\"\n                required\n                data-testid=\"input-confirm-password\"\n              />\n            </div>\n\n            {resetError && (\n              <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n                <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-red-800\">{resetError}</p>\n              </div>\n            )}\n\n            {resetSuccess && (\n              <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-3 flex items-start gap-2\">\n                <CheckCircle className=\"text-green-600 flex-shrink-0 mt-0.5\" size={20} />\n                <p className=\"text-sm text-green-800\">{resetSuccess}</p>\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={resetPasswordMutation.isPending}\n              className=\"w-full bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n              data-testid=\"button-reset-password\"\n            >\n              {resetPasswordMutation.isPending ? 'جاري التغيير...' : 'تغيير كلمة المرور'}\n            </button>\n\n            <button\n              type=\"button\"\n              onClick={() => {\n                setView('login')\n                setResetUsername('')\n                setResetToken('')\n                setNewPassword('')\n                setConfirmNewPassword('')\n                setGeneratedToken('')\n                setResetError('')\n                setResetSuccess('')\n              }}\n              className=\"w-full text-center text-sm text-gray-600 hover:text-gray-800 underline\"\n              data-testid=\"link-cancel-reset\"\n            >\n              إلغاء\n            </button>\n          </form>\n        </div>\n      </div>\n    )\n  }\n\n  // عرض صفحة تسجيل الدخول\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-cyan-500 via-blue-500 to-blue-600 flex items-center justify-center p-4\" dir=\"rtl\">\n      <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\n        <div className=\"bg-gradient-to-r from-cyan-600 to-blue-600 p-8 text-center\">\n          <div className=\"bg-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4\">\n            <GraduationCap className=\"text-cyan-600\" size={40} />\n          </div>\n          <h1 className=\"text-3xl font-bold text-white mb-2\">إدارة شؤون الطلاب</h1>\n          <p className=\"text-cyan-50\">تسجيل الدخول</p>\n        </div>\n\n        <form onSubmit={handleLogin} className=\"p-8 space-y-6\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اسم المستخدم\n            </label>\n            <div className=\"relative\">\n              <User className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n              <input\n                type=\"text\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                className=\"w-full pr-12 pl-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500\"\n                placeholder=\"أدخل اسم المستخدم\"\n                required\n              />\n            </div>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              كلمة المرور\n            </label>\n            <div className=\"relative\">\n              <Lock className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n              <input\n                type={showPassword ? 'text' : 'password'}\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"w-full pr-12 pl-12 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500\"\n                placeholder=\"أدخل كلمة المرور\"\n                required\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword(!showPassword)}\n                className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600\"\n              >\n                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}\n              </button>\n            </div>\n          </div>\n\n          {error && (\n            <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-3 flex items-start gap-2\">\n              <AlertCircle className=\"text-red-600 flex-shrink-0 mt-0.5\" size={20} />\n              <p className=\"text-sm text-red-800\">{error}</p>\n            </div>\n          )}\n\n          <button\n            type=\"submit\"\n            disabled={loginMutation.isPending}\n            className=\"w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50\"\n            data-testid=\"button-login\"\n          >\n            {loginMutation.isPending ? 'جاري تسجيل الدخول...' : 'تسجيل الدخول'}\n          </button>\n\n          <button\n            type=\"button\"\n            onClick={() => setView('forgot-password')}\n            className=\"w-full text-center text-sm text-cyan-600 hover:text-cyan-800 underline font-medium\"\n            data-testid=\"link-forgot-password\"\n          >\n            نسيت كلمة المرور؟\n          </button>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":16283},"client/src/components/StudentsList.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { Student, SpecialStatus, SchoolInfo } from '../types'\nimport { supabase } from '../lib/supabase'\nimport { Trash2, Edit2, MoreVertical, Printer, DoorOpen } from 'lucide-react'\nimport { AllowClassEntryModal } from './AllowClassEntryModal'\n\ninterface StudentsListProps {\n  students: Student[]\n  groupName: string\n  specialStatuses: SpecialStatus[]\n  onStudentDeleted: () => void\n  onEditStudent: (student: Student) => void\n}\n\nexport function StudentsList({\n  students,\n  groupName,\n  specialStatuses,\n  onStudentDeleted,\n  onEditStudent,\n}: StudentsListProps) {\n  const [expandedId, setExpandedId] = useState<string | null>(null)\n  const [loadingDelete, setLoadingDelete] = useState<string | null>(null)\n  const [schoolInfo, setSchoolInfo] = useState<SchoolInfo | null>(null)\n  const [showAllowEntryModal, setShowAllowEntryModal] = useState(false)\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n\n  useEffect(() => {\n    fetchSchoolInfo()\n  }, [])\n\n  const fetchSchoolInfo = async () => {\n    const { data } = await supabase\n      .from('school_info')\n      .select('*')\n      .limit(1)\n      .maybeSingle()\n\n    if (data) setSchoolInfo(data)\n  }\n\n\n  const handleDelete = async (studentId: string) => {\n    if (!window.confirm('هل أنت متأكد من حذف هذا الطالب؟')) return\n\n    setLoadingDelete(studentId)\n    try {\n      const { error } = await supabase\n        .from('students')\n        .delete()\n        .eq('id', studentId)\n\n      if (error) throw error\n      onStudentDeleted()\n    } finally {\n      setLoadingDelete(null)\n    }\n  }\n\n\n  const handleMoveStudent = async (\n    studentId: string,\n    currentGroupId: string,\n    newGroupId: string\n  ) => {\n    if (!newGroupId || newGroupId === currentGroupId) return\n\n    try {\n      const { error } = await supabase\n        .from('students')\n        .update({ group_id: newGroupId })\n        .eq('id', studentId)\n\n      if (error) throw error\n      onStudentDeleted()\n    } finally {\n      setExpandedId(null)\n    }\n  }\n\n  const getSpecialStatusName = (statusId: string | null) => {\n    if (!statusId) return '-'\n    return specialStatuses.find((s) => s.id === statusId)?.name || '-'\n  }\n\n  const printStudent = async (student: Student) => {\n    const specialStatusName = student.special_status_id\n      ? getSpecialStatusName(student.special_status_id)\n      : 'لا يوجد'\n    const groupName = student.group?.name || '-'\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    // Fetch teacher name and school name\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const schoolName = teacherProfile?.school_name || schoolInfo?.school_name || 'اسم المدرسة'\n\n\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>بيانات الطالب - ${student.name}</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n\n            @page {\n              size: A4;\n              margin: 15mm;\n            }\n\n            body {\n              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n              background: white;\n              color: #1a1a1a;\n              line-height: 1.4;\n              font-size: 13px;\n            }\n\n            .page-container {\n              max-width: 210mm;\n              margin: 0 auto;\n              background: white;\n            }\n\n            .header {\n              background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);\n              color: white;\n              padding: 15px 20px;\n              text-align: center;\n              border-radius: 8px 8px 0 0;\n            }\n\n            .header h1 {\n              font-size: 22px;\n              margin-bottom: 4px;\n              font-weight: 700;\n            }\n\n            .header .school-name {\n              font-size: 16px;\n              margin-bottom: 8px;\n              opacity: 0.95;\n              font-weight: 500;\n            }\n\n            .header .meta {\n              font-size: 11px;\n              opacity: 0.9;\n              margin-top: 6px;\n            }\n\n            .content {\n              padding: 20px;\n            }\n\n            .student-name-section {\n              background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);\n              border: 2px solid #3b82f6;\n              border-radius: 8px;\n              padding: 12px;\n              margin-bottom: 15px;\n              text-align: center;\n            }\n\n            .student-name-section h2 {\n              color: #1e40af;\n              font-size: 20px;\n              font-weight: 700;\n            }\n\n            .info-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 10px;\n              margin-bottom: 15px;\n            }\n\n            .info-item {\n              background: #f9fafb;\n              border: 1px solid #e5e7eb;\n              border-radius: 6px;\n              padding: 10px;\n            }\n\n            .info-label {\n              font-size: 11px;\n              color: #6b7280;\n              font-weight: 600;\n              margin-bottom: 4px;\n            }\n\n            .info-value {\n              font-size: 14px;\n              color: #111827;\n              font-weight: 600;\n            }\n\n\n            .footer {\n              background: #f9fafb;\n              padding: 15px 20px;\n              border-top: 2px solid #e5e7eb;\n              margin-top: 15px;\n            }\n\n            .footer-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 20px;\n            }\n\n            .signature-box {\n              text-align: center;\n            }\n\n            .signature-label {\n              font-size: 12px;\n              color: #6b7280;\n              font-weight: 600;\n              margin-bottom: 6px;\n            }\n\n            .signature-line {\n              border-top: 2px solid #374151;\n              width: 150px;\n              margin: 30px auto 8px;\n            }\n\n            .signature-name {\n              font-size: 14px;\n              color: #111827;\n              font-weight: 600;\n            }\n\n            .print-info {\n              text-align: center;\n              color: #9ca3af;\n              font-size: 10px;\n              margin-top: 15px;\n              padding-top: 15px;\n              border-top: 1px solid #e5e7eb;\n            }\n\n            @media print {\n              body {\n                background: white;\n              }\n\n              .page-container {\n                border: none;\n                border-radius: 0;\n              }\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"page-container\">\n            <div class=\"header\">\n              <div class=\"school-name\">${schoolName}</div>\n              <h1>بطاقة بيانات الطالب</h1>\n              <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n            </div>\n\n            <div class=\"content\">\n              <div class=\"student-name-section\">\n                <h2>${student.name}</h2>\n              </div>\n\n              <div class=\"info-grid\">\n                <div class=\"info-item\">\n                  <div class=\"info-label\">السجل المدني</div>\n                  <div class=\"info-value\">${student.national_id}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الصف الدراسي</div>\n                  <div class=\"info-value\">${student.grade}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الفصل</div>\n                  <div class=\"info-value\">${groupName}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">جوال الطالب</div>\n                  <div class=\"info-value\">${student.phone}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">جوال ولي الأمر</div>\n                  <div class=\"info-value\">${student.guardian_phone}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الظروف الخاصة</div>\n                  <div class=\"info-value\">${specialStatusName}</div>\n                </div>\n              </div>\n\n            </div>\n\n            <div class=\"footer\">\n              <div class=\"footer-grid\">\n                <div class=\"signature-box\">\n                  <div class=\"signature-label\">المرشد الطلابي</div>\n                  <div class=\"signature-name\">${teacherName || 'اسم المرشد الطلابي'}</div>\n                  <div class=\"signature-line\"></div>\n                  <div style=\"font-size: 11px; color: #6b7280;\">التوقيع</div>\n                </div>\n\n                <div class=\"signature-box\">\n                  <div class=\"signature-label\">الإدارة</div>\n                  <div class=\"signature-line\"></div>\n                  <div style=\"font-size: 11px; color: #6b7280;\">التوقيع والختم</div>\n                </div>\n              </div>\n\n              <div class=\"print-info\">\n                هذه الوثيقة صادرة من الإرشاد الطلابي\n              </div>\n            </div>\n          </div>\n\n          <script>\n            window.onload = () => {\n              setTimeout(() => {\n                window.print();\n                window.onafterprint = () => window.close();\n              }, 250);\n            };\n          </script>\n        </body>\n      </html>\n    `)\n    printWindow.document.close()\n  }\n\n  if (students.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-8 text-center\">\n        <p className=\"text-gray-500\">لا توجد طلاب في {groupName}</p>\n      </div>\n    )\n  }\n\n  const groupColors = [\n    { bg: 'bg-blue-50', border: 'border-blue-200', header: 'bg-gradient-to-r from-blue-400 to-blue-500', text: 'text-blue-900' },\n    { bg: 'bg-green-50', border: 'border-green-200', header: 'bg-gradient-to-r from-green-400 to-green-500', text: 'text-green-900' },\n    { bg: 'bg-orange-50', border: 'border-orange-200', header: 'bg-gradient-to-r from-orange-400 to-orange-500', text: 'text-orange-900' },\n    { bg: 'bg-teal-50', border: 'border-teal-200', header: 'bg-gradient-to-r from-teal-400 to-teal-500', text: 'text-teal-900' },\n    { bg: 'bg-pink-50', border: 'border-pink-200', header: 'bg-gradient-to-r from-pink-400 to-pink-500', text: 'text-pink-900' },\n    { bg: 'bg-cyan-50', border: 'border-cyan-200', header: 'bg-gradient-to-r from-cyan-400 to-cyan-500', text: 'text-cyan-900' },\n  ]\n\n  const groupIndex = groupName.charCodeAt(0) % groupColors.length\n  const colors = groupColors[groupIndex]\n\n  return (\n    <div className=\"space-y-2\">\n        <div className={`${colors.header} text-white px-4 py-3 rounded-lg shadow-md mb-4`}>\n          <h3 className=\"text-lg font-bold flex items-center justify-between\">\n            <span>{groupName}</span>\n            <span className=\"bg-white/20 px-3 py-1 rounded-full text-sm\">{students.length} طالب</span>\n          </h3>\n        </div>\n        <div className=\"space-y-2\">\n          {students.map((student) => {\n            const hasSpecialStatus = student.special_status_id !== null\n            const bgColorClass = hasSpecialStatus\n              ? 'bg-amber-50 border-amber-200'\n              : `${colors.bg} ${colors.border}`\n\n            return (\n          <div\n            key={student.id}\n            className={`${bgColorClass} rounded-lg shadow-sm border-2 hover:shadow-md transition-shadow`}\n          >\n            <div className=\"p-4\">\n              <div className=\"flex items-start justify-between mb-2\">\n                <div className=\"flex-1\">\n                  <h4 className=\"font-bold text-gray-800\">{student.name}</h4>\n                  <p className=\"text-sm text-gray-600\">السجل: {student.national_id}</p>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {student.status === 'استئذان' && (\n                    <span className=\"px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800\">\n                      استئذان\n                    </span>\n                  )}\n                  {student.special_status_id && (\n                    <span className=\"px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800\">\n                      {getSpecialStatusName(student.special_status_id)}\n                    </span>\n                  )}\n                  <button\n                    onClick={() => setExpandedId(expandedId === student.id ? null : student.id)}\n                    className=\"p-1 hover:bg-gray-100 rounded\"\n                  >\n                    <MoreVertical size={20} />\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-gray-600 mb-2\">\n                <div>الصف: {student.grade}</div>\n                <div>جوال: {student.phone}</div>\n                <div>ولي أمر: {student.guardian_phone}</div>\n              </div>\n\n              {expandedId === student.id && (\n                <div className=\"mt-4 pt-4 border-t border-gray-200 space-y-2\">\n                  <button\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setShowAllowEntryModal(true)\n                      setExpandedId(null)\n                    }}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded font-medium text-sm shadow-sm\"\n                  >\n                    <DoorOpen size={16} />\n                    السماح بدخول الفصل\n                  </button>\n\n                  <button\n                    onClick={() => printStudent(student)}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 text-slate-800 rounded font-medium text-sm border border-slate-300 shadow-sm\"\n                  >\n                    <Printer size={16} />\n                    طباعة بيانات الطالب\n                  </button>\n\n                  <button\n                    onClick={() => {\n                      setExpandedId(null)\n                      onEditStudent(student)\n                    }}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-amber-100 to-yellow-100 hover:from-amber-200 hover:to-yellow-200 text-amber-900 rounded font-medium text-sm border border-amber-300 shadow-sm\"\n                  >\n                    <Edit2 size={16} />\n                    تعديل\n                  </button>\n\n                  <button\n                    onClick={() => handleDelete(student.id)}\n                    disabled={loadingDelete === student.id}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-red-100 to-rose-100 hover:from-red-200 hover:to-rose-200 text-red-700 rounded font-medium text-sm border border-red-300 shadow-sm disabled:opacity-50\"\n                  >\n                    <Trash2 size={16} />\n                    {loadingDelete === student.id ? 'جاري...' : 'حذف'}\n                  </button>\n                </div>\n              )}\n            </div>\n          </div>\n            )\n          })}\n      </div>\n\n      <AllowClassEntryModal\n        isOpen={showAllowEntryModal}\n        onClose={() => {\n          setShowAllowEntryModal(false)\n          setSelectedStudent(null)\n        }}\n        student={selectedStudent}\n      />\n    </div>\n  )\n}\n","size_bytes":16391},"Erchad-1/client/src/lib/db.ts":{"content":"import Dexie, { Table } from 'dexie'\nimport { Student, Group, SpecialStatus, Teacher } from '../types'\n\nexport interface StudentVisit {\n  id?: string\n  student_id: string\n  visit_date: string\n  reason: string\n  action_taken: string\n  referred_to: string\n  notes?: string\n  created_at?: string\n}\n\nexport interface StudentPermission {\n  id?: string\n  student_id: string\n  permission_date: string\n  reason: string\n  guardian_notified?: boolean\n  notes?: string\n  created_at?: string\n}\n\nexport interface StudentViolation {\n  id?: string\n  student_id: string\n  violation_type: string\n  violation_date: string\n  description?: string\n  action_taken?: string\n  notes?: string\n  created_at?: string\n}\n\nexport interface TeacherProfile {\n  id?: string\n  name?: string\n  school_name?: string\n  logo_url?: string\n  created_at?: string\n}\n\nexport interface LoginCredentials {\n  id?: string\n  username: string\n  password_hash: string\n  reset_token?: string | null\n  reset_token_expires?: string | null\n  created_at?: string\n  updated_at?: string\n}\n\nexport class StudentsDatabase extends Dexie {\n  groups!: Table<Group>\n  students!: Table<Student>\n  special_statuses!: Table<SpecialStatus>\n  student_visits!: Table<StudentVisit>\n  student_permissions!: Table<StudentPermission>\n  student_violations!: Table<StudentViolation>\n  teacher_profile!: Table<TeacherProfile>\n  login_credentials!: Table<LoginCredentials>\n  teachers!: Table<Teacher>\n\n  constructor() {\n    super('StudentsDatabase')\n    this.version(5).stores({\n      groups: 'id, name, stage, display_order',\n      students: 'id, student_id, name, group_id, has_permission, special_status',\n      special_statuses: 'id, name',\n      student_visits: 'id, student_id, visit_date',\n      student_permissions: 'id, student_id, permission_date',\n      student_violations: 'id, student_id, violation_date',\n      teacher_profile: 'id',\n      login_credentials: 'id, username',\n      teachers: 'id, phone, name'\n    }).upgrade(trans => {\n      return trans.table('groups').toCollection().modify(group => {\n        if (group.display_order === undefined) {\n          group.display_order = 999\n        }\n      })\n    })\n  }\n}\n\nexport const db = new StudentsDatabase()\n\n// Initialize default login credentials\ndb.on('ready', async () => {\n  const count = await db.login_credentials.count()\n  if (count === 0) {\n    await db.login_credentials.add({\n      id: crypto.randomUUID(),\n      username: 'admin',\n      password_hash: 'admin123',\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString()\n    })\n  }\n})\n","size_bytes":2568},"Erchad-1/client/src/pages/GroupsManagementPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { X, Plus, Layers, Trash2, Edit2, ChevronUp, ChevronDown } from 'lucide-react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Group } from '../types'\n\ninterface GroupsManagementPageProps {\n  onClose: () => void\n}\n\nexport function GroupsManagementPage({ onClose }: GroupsManagementPageProps) {\n  const [groups, setGroups] = useState<Group[]>([])\n  const [newStage, setNewStage] = useState('')\n  const [newGroupName, setNewGroupName] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [studentCounts, setStudentCounts] = useState<Record<string, number>>({})\n  const [editingGroup, setEditingGroup] = useState<Group | null>(null)\n  const [editName, setEditName] = useState('')\n  const [editStage, setEditStage] = useState('')\n\n  useEffect(() => {\n    fetchGroups()\n    fetchStudentCounts()\n  }, [])\n\n  const fetchGroups = async () => {\n    // Fetch from Supabase first\n    const { data: supabaseGroups } = await supabase\n      .from('groups')\n      .select('*')\n      .order('display_order', { ascending: true })\n\n    if (supabaseGroups) {\n      // Sync to IndexedDB\n      await db.groups.clear()\n      await db.groups.bulkAdd(supabaseGroups)\n      setGroups(supabaseGroups)\n    } else {\n      // Fallback to IndexedDB\n      const allGroups = await db.groups.toArray()\n      setGroups(allGroups)\n    }\n  }\n\n  const fetchStudentCounts = async () => {\n    const allStudents = await db.students.toArray()\n    const counts: Record<string, number> = {}\n\n    allStudents.forEach(student => {\n      if (student.group_id) {\n        counts[student.group_id] = (counts[student.group_id] || 0) + 1\n      }\n    })\n\n    setStudentCounts(counts)\n  }\n\n  const handleAddGroup = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!newStage.trim() || !newGroupName.trim()) return\n\n    setLoading(true)\n    try {\n      // Get max order from Supabase\n      const { data: stageGroups } = await supabase\n        .from('groups')\n        .select('*')\n        .eq('stage', newStage.trim())\n\n      const maxOrder = stageGroups && stageGroups.length > 0\n        ? Math.max(...stageGroups.map(g => g.display_order || 0))\n        : 0\n\n      const newGroup = {\n        id: crypto.randomUUID(),\n        stage: newStage.trim(),\n        name: newGroupName.trim(),\n        display_order: maxOrder + 1,\n        created_at: new Date().toISOString(),\n      }\n\n      // Insert to Supabase\n      const { error } = await supabase\n        .from('groups')\n        .insert(newGroup)\n\n      if (error) throw error\n\n      // Add to IndexedDB\n      await db.groups.add(newGroup)\n\n      setNewStage('')\n      setNewGroupName('')\n      await fetchGroups()\n      await fetchStudentCounts()\n    } catch (error) {\n      console.error('Error adding group:', error)\n      alert('حدث خطأ أثناء إضافة المجموعة')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleDeleteGroup = async (id: string) => {\n    if (!window.confirm('هل أنت متأكد من حذف هذه المجموعة؟')) return\n\n    try {\n      // Delete from Supabase\n      const { error } = await supabase\n        .from('groups')\n        .delete()\n        .eq('id', id)\n\n      if (error) throw error\n\n      // Delete from IndexedDB\n      await db.groups.delete(id)\n      await fetchGroups()\n      await fetchStudentCounts()\n    } catch (error) {\n      console.error('Error deleting group:', error)\n      alert('حدث خطأ أثناء حذف المجموعة')\n    }\n  }\n\n  const handleEditGroup = (group: Group) => {\n    setEditingGroup(group)\n    setEditName(group.name)\n    setEditStage(group.stage)\n  }\n\n  const handleSaveEdit = async () => {\n    if (!editingGroup || !editName.trim() || !editStage.trim()) return\n\n    try {\n      // Update in Supabase\n      const { error } = await supabase\n        .from('groups')\n        .update({\n          name: editName.trim(),\n          stage: editStage.trim(),\n        })\n        .eq('id', editingGroup.id)\n\n      if (error) throw error\n\n      // Update in IndexedDB\n      await db.groups.update(editingGroup.id, {\n        name: editName.trim(),\n        stage: editStage.trim(),\n      })\n\n      setEditingGroup(null)\n      setEditName('')\n      setEditStage('')\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error updating group:', error)\n      alert('حدث خطأ أثناء تحديث المجموعة')\n    }\n  }\n\n  const handleCancelEdit = () => {\n    setEditingGroup(null)\n    setEditName('')\n    setEditStage('')\n  }\n\n  const handleMoveUp = async (group: Group, stageGroups: Group[]) => {\n    const currentIndex = stageGroups.findIndex(g => g.id === group.id)\n    if (currentIndex === 0) return\n\n    const prevGroup = stageGroups[currentIndex - 1]\n    const currentOrder = group.display_order || currentIndex + 1\n    const prevOrder = prevGroup.display_order || currentIndex\n\n    try {\n      // Update in Supabase\n      await supabase.from('groups').update({ display_order: prevOrder }).eq('id', group.id)\n      await supabase.from('groups').update({ display_order: currentOrder }).eq('id', prevGroup.id)\n\n      // Update in IndexedDB\n      await db.groups.update(group.id, { display_order: prevOrder })\n      await db.groups.update(prevGroup.id, { display_order: currentOrder })\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error moving group:', error)\n    }\n  }\n\n  const handleMoveDown = async (group: Group, stageGroups: Group[]) => {\n    const currentIndex = stageGroups.findIndex(g => g.id === group.id)\n    if (currentIndex === stageGroups.length - 1) return\n\n    const nextGroup = stageGroups[currentIndex + 1]\n    const currentOrder = group.display_order || currentIndex + 1\n    const nextOrder = nextGroup.display_order || currentIndex + 2\n\n    try {\n      // Update in Supabase\n      await supabase.from('groups').update({ display_order: nextOrder }).eq('id', group.id)\n      await supabase.from('groups').update({ display_order: currentOrder }).eq('id', nextGroup.id)\n\n      // Update in IndexedDB\n      await db.groups.update(group.id, { display_order: nextOrder })\n      await db.groups.update(nextGroup.id, { display_order: currentOrder })\n      await fetchGroups()\n    } catch (error) {\n      console.error('Error moving group:', error)\n    }\n  }\n\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الأول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  const sortedStages = Object.entries(groupedByStage).sort((a, b) => {\n    const orderA = stageOrder[a[0]] || 999\n    const orderB = stageOrder[b[0]] || 999\n    return orderA - orderB\n  })\n\n  const getStudentCount = (groupId: string) => {\n    return studentCounts[groupId] || 0\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"bg-gradient-to-r from-emerald-600 to-teal-600 text-white p-6 shadow-lg\">\n        <div className=\"max-w-7xl mx-auto flex items-center justify-between\">\n          <h1 className=\"text-2xl font-bold\">إدارة المراحل والمجموعات</h1>\n          <button\n            onClick={onClose}\n            className=\"p-2 hover:bg-white/20 rounded-lg transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto p-6 space-y-6\">\n        <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-2xl p-6 shadow-sm\">\n          <h2 className=\"text-xl font-bold text-emerald-800 mb-6\">إضافة مجموعة جديدة</h2>\n\n          <form onSubmit={handleAddGroup} className=\"space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الصف (المرحلة)\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: الصف الأول الثانوي\"\n                  value={newStage}\n                  onChange={(e) => setNewStage(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  اسم المجموعة\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"مثال: مجموعة 1\"\n                  value={newGroupName}\n                  onChange={(e) => setNewGroupName(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                  required\n                />\n              </div>\n            </div>\n            <button\n              type=\"submit\"\n              disabled={loading || !newStage.trim() || !newGroupName.trim()}\n              className=\"w-full bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-400 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Plus size={20} />\n              إضافة المجموعة\n            </button>\n          </form>\n        </div>\n\n        <div className=\"space-y-4\">\n          <h2 className=\"text-xl font-bold text-gray-800\">المجموعات الحالية</h2>\n\n          {sortedStages.length === 0 ? (\n            <div className=\"bg-white rounded-lg p-8 text-center text-gray-500\">\n              لا توجد مجموعات حالياً\n            </div>\n          ) : (\n            sortedStages.map(([stage, stageGroups]) => (\n              <div key={stage} className=\"bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200\">\n                <div className=\"bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-4 flex items-center gap-3\">\n                  <Layers size={20} className=\"text-white\" />\n                  <h3 className=\"text-lg font-bold text-white\">{stage}</h3>\n                </div>\n\n                <div className=\"p-4\">\n                  <div className=\"space-y-3\">\n                    {stageGroups\n                      .sort((a, b) => (a.display_order || 999) - (b.display_order || 999))\n                      .map((group, index) => (\n                        <div\n                          key={group.id}\n                          className=\"bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200 hover:shadow-md transition-all\"\n                        >\n                          {editingGroup?.id === group.id ? (\n                            <div className=\"space-y-3\">\n                              <div className=\"grid grid-cols-2 gap-3\">\n                                <input\n                                  type=\"text\"\n                                  value={editStage}\n                                  onChange={(e) => setEditStage(e.target.value)}\n                                  className=\"px-3 py-2 border-2 border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                                  placeholder=\"الصف\"\n                                />\n                                <input\n                                  type=\"text\"\n                                  value={editName}\n                                  onChange={(e) => setEditName(e.target.value)}\n                                  className=\"px-3 py-2 border-2 border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                                  placeholder=\"اسم المجموعة\"\n                                />\n                              </div>\n                              <div className=\"flex gap-2\">\n                                <button\n                                  onClick={handleSaveEdit}\n                                  className=\"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-semibold transition-colors\"\n                                >\n                                  حفظ\n                                </button>\n                                <button\n                                  onClick={handleCancelEdit}\n                                  className=\"flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded-lg font-semibold transition-colors\"\n                                >\n                                  إلغاء\n                                </button>\n                              </div>\n                            </div>\n                          ) : (\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex-1\">\n                                <h4 className=\"font-bold text-gray-800 text-lg mb-1\">{group.name}</h4>\n                                <p className=\"text-sm text-teal-700 font-semibold\">\n                                  {getStudentCount(group.id)} طالب\n                                </p>\n                              </div>\n                              <div className=\"flex items-center gap-2\">\n                                <div className=\"flex flex-col gap-1\">\n                                  <button\n                                    onClick={() => handleMoveUp(group, stageGroups)}\n                                    disabled={index === 0}\n                                    className=\"text-emerald-600 hover:bg-emerald-100 p-1 rounded transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                                    title=\"تحريك لأعلى\"\n                                  >\n                                    <ChevronUp size={18} />\n                                  </button>\n                                  <button\n                                    onClick={() => handleMoveDown(group, stageGroups)}\n                                    disabled={index === stageGroups.length - 1}\n                                    className=\"text-emerald-600 hover:bg-emerald-100 p-1 rounded transition-colors disabled:opacity-30 disabled:cursor-not-allowed\"\n                                    title=\"تحريك لأسفل\"\n                                  >\n                                    <ChevronDown size={18} />\n                                  </button>\n                                </div>\n                                <button\n                                  onClick={() => handleEditGroup(group)}\n                                  className=\"text-blue-600 hover:bg-blue-50 p-2 rounded transition-colors\"\n                                  title=\"تعديل المجموعة\"\n                                >\n                                  <Edit2 size={18} />\n                                </button>\n                                <button\n                                  onClick={() => handleDeleteGroup(group.id)}\n                                  className=\"text-red-500 hover:bg-red-50 p-2 rounded transition-colors\"\n                                  title=\"حذف المجموعة\"\n                                >\n                                  <Trash2 size={18} />\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":16011},"Erchad-1/postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n};\n","size_bytes":81},"Erchad-1/TODO_MIGRATION.md":{"content":"# قائمة المكونات المتبقية للترحيل\n\n## ✅ تم الترحيل\n\n- [x] LoginPage.tsx - صفحة تسجيل الدخول\n- [x] App.tsx - الهيكل الأساسي (نسخة مبسطة)\n- [x] البنية التحتية الكاملة (Server + Database + API)\n\n## 📋 المكونات التي تحتاج للترحيل\n\n### الأولوية 1 - المكونات الأساسية\n\n#### 1. App.tsx الكامل\n**الملف:** `client/src/App.tsx.old`  \n**الحجم:** ~630 سطر  \n**الصعوبة:** متوسطة  \n**الخطوات:**\n- [ ] استبدال `fetchData()` باستخدام React Query\n- [ ] إزالة استيرادات Supabase و IndexedDB\n- [ ] استخدام `useQuery` لجلب groups, students, specialStatuses, profile\n- [ ] تحديث جميع دوال الـ handlers\n\n**كود المثال:**\n```typescript\n// بدلاً من fetchData()\nconst { data: students = [] } = useQuery({ queryKey: ['/api/students'] })\nconst { data: groups = [] } = useQuery({ queryKey: ['/api/groups'] })\nconst { data: specialStatuses = [] } = useQuery({ queryKey: ['/api/special-statuses'] })\nconst { data: profile } = useQuery({ queryKey: ['/api/teacher-profile'] })\n```\n\n### الأولوية 2 - مكونات إدارة الطلاب\n\n#### 2. StudentForm.tsx\n**الاستخدام:** إضافة وتعديل طالب  \n**الصعوبة:** متوسطة  \n**التغييرات:**\n- [ ] استخدام `useMutation` للإضافة/التعديل\n- [ ] إزالة `db.students.add/update`\n\n#### 3. StudentsList.tsx  \n**الاستخدام:** عرض قائمة الطلاب  \n**الصعوبة:** سهلة  \n**التغييرات:**\n- [ ] استخدام `useMutation` للحذف\n- [ ] إزالة `db.students.delete`\n\n#### 4. ExcelImport.tsx\n**الاستخدام:** استيراد طلاب من Excel  \n**الصعوبة:** متوسطة  \n**التغييرات:**\n- [ ] استخدام endpoint `/api/students/bulk`\n- [ ] إزالة `db.students.bulkAdd`\n\n### الأولوية 3 - مكونات أخرى\n\n#### 5. EditStudentModal.tsx\n**الصعوبة:** سهلة  \n**التغييرات:** مثل StudentForm\n\n#### 6. ManageModal.tsx\n**الاستخدام:** إدارة المجموعات والحالات الخاصة  \n**التغييرات:**\n- [ ] Groups: `/api/groups`\n- [ ] Special Statuses: `/api/special-statuses`\n\n#### 7. ProfileSettings.tsx\n**الاستخدام:** إعدادات الملف الشخصي  \n**التغييرات:**\n- [ ] GET/POST `/api/teacher-profile`\n\n### الأولوية 4 - الصفحات\n\n#### 8. TeachersPage.tsx\n**الصعوبة:** متوسطة  \n**API:** `/api/teachers`, `/api/teacher-groups`\n\n#### 9. GroupsPage.tsx\n**الصعوبة:** سهلة  \n**API:** `/api/groups`\n\n#### 10. GroupsManagementPage.tsx\n**الصعوبة:** متوسطة  \n**API:** `/api/groups`\n\n#### 11. SpecialStatusPage.tsx\n**الصعوبة:** متوسطة  \n**API:** `/api/special-statuses`, `/api/students`\n\n#### 12. AbsencePage.tsx\n**الصعوبة:** متوسطة  \n**API:** `/api/student-violations`\n\n#### 13. ReceptionPage.tsx\n**الصعوبة:** متوسطة  \n**API:** `/api/student-visits`\n\n#### 14. PermissionPage.tsx\n**الصعوبة:** متوسطة  \n**API:** `/api/student-permissions`\n\n## 🎯 استراتيجية الترحيل الموصى بها\n\n### الخطوة 1: ابدأ بالمكونات البسيطة\n1. StudentsList (سهل)\n2. GroupsPage (سهل)\n3. EditStudentModal (سهل)\n\n### الخطوة 2: المكونات المتوسطة\n4. StudentForm\n5. ExcelImport\n6. ProfileSettings\n\n### الخطوة 3: الصفحات المعقدة\n7. TeachersPage\n8. ReceptionPage\n9. PermissionPage\n10. AbsencePage\n\n### الخطوة 4: الترحيل النهائي\n11. App.tsx الكامل\n12. إزالة Supabase و Dexie\n13. اختبار شامل\n\n## 📝 ملاحظات مهمة\n\n1. **لا تحذف الملفات القديمة** حتى تتأكد أن الجديدة تعمل\n2. **اختبر كل مكون** بعد ترحيله\n3. **استخدم المكونات البسيطة** مثل SearchBar, GroupSelector, FiltersPanel كما هي (لا تحتاج ترحيل)\n4. **راجع MIGRATION_GUIDE.md** للأمثلة التفصيلية\n\n## 🚀 الخطوات السريعة للبدء\n\n```bash\n# 1. افتح MIGRATION_GUIDE.md للحصول على الأمثلة\ncode MIGRATION_GUIDE.md\n\n# 2. اختر مكوناً بسيطاً للبدء\ncode client/src/components/StudentsList.tsx\n\n# 3. اتبع النمط:\n# - احذف استيراد supabase و db\n# - استخدم useQuery للجلب\n# - استخدم useMutation للتعديل\n# - استورد من @/lib/queryClient\n\n# 4. اختبر في المتصفح\n```\n\n## 🆘 إذا واجهت مشكلة\n\n1. راجع الأمثلة في `MIGRATION_GUIDE.md`\n2. تحقق من `/tmp/logs/` للأخطاء\n3. تأكد من استيراد `useQuery, useMutation` من `@tanstack/react-query`\n4. تأكد من استيراد `apiRequest, queryClient` من `@/lib/queryClient`\n\n---\n\n**تذكر:** البنية التحتية جاهزة بالكامل، فقط تحتاج لتحديث المكونات واحدة تلو الأخرى! 💪\n","size_bytes":5125},"Erchad-1/client/src/components/GroupSelector.tsx":{"content":"import { useState } from 'react'\nimport { Group } from '../types'\nimport { ChevronDown, ChevronUp, Layers } from 'lucide-react'\n\ninterface GroupSelectorProps {\n  groups: Group[]\n  selectedGroupId: string | null\n  onSelectGroup: (groupId: string | null) => void\n}\n\nexport function GroupSelector({\n  groups,\n  selectedGroupId,\n  onSelectGroup,\n}: GroupSelectorProps) {\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n\n  // Define stage order\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  // Sort stages by defined order\n  const sortedStages = Object.entries(groupedByStage).sort((a, b) => {\n    const orderA = stageOrder[a[0]] || 999\n    const orderB = stageOrder[b[0]] || 999\n    return orderA - orderB\n  })\n\n  const toggleStage = (stage: string) => {\n    setExpandedStages((prev) => {\n      const next = new Set(prev)\n      if (next.has(stage)) {\n        next.delete(stage)\n      } else {\n        next.add(stage)\n      }\n      return next\n    })\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <div className=\"space-y-2\">\n        <button\n          onClick={() => onSelectGroup(null)}\n          className={`w-full px-4 py-2 rounded-lg text-right font-medium transition-all ${\n            selectedGroupId === null\n              ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-md'\n              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n          }`}\n        >\n          جميع المجموعات\n        </button>\n\n        {sortedStages.map(([stage, stageGroups]) => {\n          const isExpanded = expandedStages.has(stage)\n          return (\n            <div key={stage} className=\"border border-gray-200 rounded-lg overflow-hidden\">\n              <button\n                onClick={() => toggleStage(stage)}\n                className=\"w-full px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold transition-all flex items-center justify-between shadow-sm\"\n              >\n                <div className=\"flex items-center gap-2\">\n                  <Layers size={18} className=\"text-white\" />\n                  <span>{stage}</span>\n                </div>\n                {isExpanded ? (\n                  <ChevronUp size={18} className=\"text-white\" />\n                ) : (\n                  <ChevronDown size={18} className=\"text-white\" />\n                )}\n              </button>\n\n              {isExpanded && (\n                <div className=\"bg-gray-50 p-2 space-y-1\">\n                  {stageGroups.map((group) => (\n                    <button\n                      key={group.id}\n                      onClick={() => onSelectGroup(group.id)}\n                      className={`w-full px-4 py-2 rounded-lg text-right font-medium transition-all ${\n                        selectedGroupId === group.id\n                          ? 'bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-md'\n                          : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'\n                      }`}\n                    >\n                      {group.name}\n                    </button>\n                  ))}\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","size_bytes":3644},"client/src/lib/supabase.ts":{"content":"// النظام يعمل بالكامل على IndexedDB (قاعدة بيانات محلية في المتصفح)\n// لا يحتاج إنترنت أو Supabase - البيانات محفوظة بشكل دائم في جهازك\nimport { indexedDBClient } from './indexedDBWrapper'\n\n// تصدير IndexedDB client كـ \"supabase\" للحفاظ على التوافق مع الكود الموجود\nexport const supabase = indexedDBClient\n","size_bytes":433},"Erchad-1/client/src/components/SearchBar.tsx":{"content":"import { Search } from 'lucide-react'\n\ninterface SearchBarProps {\n  value: string\n  onChange: (value: string) => void\n  placeholder?: string\n}\n\nexport function SearchBar({\n  value,\n  onChange,\n  placeholder = 'ابحث عن طالب...',\n}: SearchBarProps) {\n  return (\n    <div className=\"relative\">\n      <Search className=\"absolute right-3 top-3 text-gray-400\" size={20} />\n      <input\n        type=\"text\"\n        placeholder={placeholder}\n        value={value}\n        onChange={(e) => onChange(e.target.value)}\n        className=\"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n      />\n    </div>\n  )\n}\n","size_bytes":672},"Erchad-1/client/src/lib/formatPhone.ts":{"content":"/**\n * تنسيق رقم الجوال للاستخدام في واتساب\n * يزيل جميع الأحرف غير الرقمية\n * يزيل رمز الدولة 966 إن وجد\n * يزيل جميع الأصفار من البداية\n * يضيف رمز الدولة 966 (السعودية)\n * \n * @param phone رقم الجوال (مثال: 0555555555 أو 9660555555555 أو 00966555555555)\n * @returns رقم منسق للواتساب (مثال: 966555555555) أو نص فارغ إذا كان الرقم غير صالح\n */\nexport function formatPhoneForWhatsApp(phone: string | undefined | null): string {\n  if (!phone) return ''\n  \n  // إزالة جميع الأحرف غير الرقمية\n  let cleaned = phone.replace(/\\D/g, '')\n  \n  // إزالة جميع الأصفار من البداية (للتعامل مع 00966...)\n  cleaned = cleaned.replace(/^0+/, '')\n  \n  // إزالة 966 إذا كانت موجودة بالفعل\n  if (cleaned.startsWith('966')) {\n    cleaned = cleaned.substring(3)\n  }\n  \n  // إزالة الأصفار من البداية مرة أخرى (للتعامل مع 9660...)\n  cleaned = cleaned.replace(/^0+/, '')\n  \n  // إذا كان الرقم فارغاً بعد التنظيف، إرجاع نص فارغ\n  if (!cleaned) return ''\n  \n  // إضافة رمز الدولة 966\n  return '966' + cleaned\n}\n","size_bytes":1339},"Erchad-1/drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL must be set\");\n}\n\nexport default defineConfig({\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":278},"Erchad-1/client/src/pages/ReceptionPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db, StudentVisit } from '../lib/db'\nimport { Student } from '../types'\nimport { UserCheck, Search, FileText, Printer, Send, Calendar, Filter } from 'lucide-react'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface VisitWithStudent extends StudentVisit {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    visit_count: number\n  }\n}\n\nexport function ReceptionPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [visits, setVisits] = useState<VisitWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [formData, setFormData] = useState({\n    reason: '',\n    action_taken: '',\n    referred_to: 'لا يوجد' as const,\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchVisits()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    // جلب الطلاب من Supabase أولاً\n    const { data: supabaseStudents } = await supabase\n      .from('students')\n      .select('*')\n      .order('name')\n\n    // مزامنة مع IndexedDB\n    if (supabaseStudents && supabaseStudents.length > 0) {\n      await db.students.clear()\n      for (const student of supabaseStudents) {\n        await db.students.put(student)\n      }\n    }\n\n    // جلب المجموعات والحالات\n    const { data: supabaseGroups } = await supabase.from('groups').select('*')\n    const { data: supabaseStatuses } = await supabase.from('special_statuses').select('*')\n\n    // مزامنة المجموعات\n    if (supabaseGroups && supabaseGroups.length > 0) {\n      await db.groups.clear()\n      for (const group of supabaseGroups) {\n        await db.groups.put(group)\n      }\n    }\n\n    // مزامنة الحالات الخاصة\n    if (supabaseStatuses && supabaseStatuses.length > 0) {\n      await db.special_statuses.clear()\n      for (const status of supabaseStatuses) {\n        await db.special_statuses.put(status)\n      }\n    }\n\n    // قراءة من IndexedDB بعد المزامنة\n    const allStudents = await db.students.toArray()\n    const groups = await db.groups.toArray()\n    const statuses = await db.special_statuses.toArray()\n\n    const studentsWithRelations = allStudents.map(student => {\n      const group = groups.find(g => g.id === student.group_id)\n      const special_status = statuses.find(s => s.id === student.special_status_id)\n      return {\n        ...student,\n        group: group ? { name: group.name } : undefined,\n        special_status: special_status ? { name: special_status.name } : undefined\n      }\n    })\n\n    setStudents(studentsWithRelations as Student[])\n  }\n\n  async function fetchVisits(filterDate?: string) {\n    try {\n      let query = supabase\n        .from('student_visits')\n        .select('*')\n        .order('visit_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('visit_date', startOfDay.toISOString())\n          .lte('visit_date', endOfDay.toISOString())\n      } else {\n        query = query.limit(50)\n      }\n\n      const { data: visitsData } = await query\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const allStudents = studentsData || []\n\n      const visitsWithStudents = (visitsData || []).map((visit) => {\n        const student = allStudents.find(s => s.id === visit.student_id)\n        return {\n          ...visit,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            visit_count: student.visit_count || 0\n          } : undefined\n        }\n      })\n\n      setVisits(visitsWithStudents)\n\n      if (visitsData) {\n        await db.student_visits.bulkPut(visitsData.map(v => ({\n          id: v.id,\n          student_id: v.student_id,\n          visit_date: v.visit_date,\n          reason: v.reason,\n          action_taken: v.action_taken,\n          referred_to: v.referred_to,\n          notes: v.notes || '',\n          created_at: v.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error fetching visits:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const visitDate = new Date().toISOString()\n      const currentCount = selectedStudent.visit_count || 0\n\n      const { data: visitData, error: visitError } = await supabase\n        .from('student_visits')\n        .insert({\n          student_id: selectedStudent.id,\n          visit_date: visitDate,\n          reason: formData.reason,\n          action_taken: formData.action_taken,\n          referred_to: formData.referred_to,\n          notes: formData.notes\n        })\n        .select()\n        .single()\n\n      if (visitError) throw visitError\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ visit_count: currentCount + 1 })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) throw updateError\n\n      if (visitData) {\n        await db.student_visits.add({\n          id: visitData.id,\n          student_id: visitData.student_id,\n          visit_date: visitData.visit_date,\n          reason: visitData.reason,\n          action_taken: visitData.action_taken,\n          referred_to: visitData.referred_to,\n          notes: visitData.notes || '',\n          created_at: visitData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        visit_count: currentCount + 1\n      })\n\n      alert('تم تسجيل الزيارة بنجاح')\n      setFormData({ reason: '', action_taken: '', referred_to: 'لا يوجد', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchVisits(dateFilter)\n    } catch (error) {\n      console.error('Error saving visit:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  async function printVisit(visit: VisitWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>تقرير زيارة طالب</title>\n          <style>\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; }\n            .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }\n            .header h1 { margin: 0; color: #2563eb; }\n            .header .meta { color: #666; font-size: 12px; margin-top: 10px; }\n            .section { margin-bottom: 20px; }\n            .section label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }\n            .section div { padding: 10px; background: #f9fafb; border-radius: 5px; }\n            @media print { body { padding: 20px; } }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>تقرير زيارة طالب</h1>\n            <p>التاريخ: ${new Date(visit.visit_date).toLocaleString('ar-SA')}</p>\n            ${teacherName ? `<div class=\"meta\">بواسطة: ${teacherName}</div>` : ''}\n          </div>\n          <div class=\"section\">\n            <label>اسم الطالب:</label>\n            <div>${visit.student?.name}</div>\n          </div>\n          <div class=\"section\">\n            <label>السجل المدني:</label>\n            <div>${visit.student?.national_id}</div>\n          </div>\n          <div class=\"section\">\n            <label>سبب الزيارة:</label>\n            <div>${visit.reason}</div>\n          </div>\n          <div class=\"section\">\n            <label>الإجراء المتخذ:</label>\n            <div>${visit.action_taken}</div>\n          </div>\n          <div class=\"section\">\n            <label>التحويل إلى:</label>\n            <div>${visit.referred_to}</div>\n          </div>\n          ${visit.notes ? `\n          <div class=\"section\">\n            <label>ملاحظات:</label>\n            <div>${visit.notes}</div>\n          </div>\n          ` : ''}\n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  function sendWhatsApp(visit: VisitWithStudent) {\n    if (!visit.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(visit.student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${visit.student.name}\n\nنود إعلامكم بأن الطالب قد حضر إلى الإرشاد الطلابي بتاريخ: ${new Date(visit.visit_date).toLocaleDateString('ar-SA')}\n\nسبب الزيارة: ${visit.reason}\nالإجراء المتخذ: ${visit.action_taken}\n${visit.referred_to !== 'لا يوجد' ? `تم التحويل إلى: ${visit.referred_to}` : ''}\n\nللاستفسار يرجى التواصل مع الموجه الطلابي.\n\nمع تحيات إدارة المدرسة`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <UserCheck size={28} className=\"text-blue-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">استقبال الطلاب</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-blue-600 font-semibold mt-1\">\n                      عدد الزيارات: {student.visit_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n                <h3 className=\"font-bold text-blue-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد الزيارات السابقة:</span>\n                    <span className=\"text-blue-600 font-bold mr-2\">{selectedStudent.visit_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  سبب الزيارة / المشكلة\n                </label>\n                <textarea\n                  required\n                  value={formData.reason}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب سبب الزيارة أو وصف المشكلة...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الإجراء المتخذ\n                </label>\n                <textarea\n                  required\n                  value={formData.action_taken}\n                  onChange={(e) => setFormData({ ...formData, action_taken: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  التحويل إلى\n                </label>\n                <select\n                  value={formData.referred_to}\n                  onChange={(e) => setFormData({ ...formData, referred_to: e.target.value as any })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                >\n                  <option value=\"لا يوجد\">لا يوجد</option>\n                  <option value=\"مشرف صحي\">مشرف صحي</option>\n                  <option value=\"وكيل\">وكيل</option>\n                  <option value=\"مدير\">مدير</option>\n                  <option value=\"معلم\">معلم</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل الزيارة'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <FileText size={24} />\n            سجل الزيارات {dateFilter ? 'المفلترة' : 'الأخيرة'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchVisits(dateFilter)}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchVisits()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-blue-600 font-semibold mt-3\">\n                عرض الزيارات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {visits.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد زيارات {dateFilter ? 'في هذا التاريخ' : ''}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {visits.map(visit => (\n            <div key={visit.id} className=\"border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors\">\n              <div className=\"flex justify-between items-start mb-3\">\n                <div>\n                  <h4 className=\"font-bold text-gray-800\">{visit.student?.name}</h4>\n                  <p className=\"text-sm text-gray-600\">\n                    {new Date(visit.visit_date).toLocaleString('ar-SA')}\n                  </p>\n                </div>\n                <div className=\"flex gap-2\">\n                  <button\n                    onClick={() => printVisit(visit)}\n                    className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                  >\n                    <Printer size={16} />\n                    طباعة\n                  </button>\n                  <button\n                    onClick={() => sendWhatsApp(visit)}\n                    className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                  >\n                    <Send size={16} />\n                    واتساب\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"space-y-2 text-sm\">\n                <div><span className=\"font-semibold\">السبب:</span> {visit.reason}</div>\n                <div><span className=\"font-semibold\">الإجراء:</span> {visit.action_taken}</div>\n                {visit.referred_to !== 'لا يوجد' && (\n                  <div className=\"text-orange-600 font-semibold\">\n                    تم التحويل إلى: {visit.referred_to}\n                  </div>\n                )}\n                {visit.notes && (\n                  <div className=\"text-gray-600\">\n                    <span className=\"font-semibold\">ملاحظات:</span> {visit.notes}\n                  </div>\n                )}\n              </div>\n            </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":21354},"Erchad-1/client/src/pages/GroupsPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student, Group, SpecialStatus } from '../types'\nimport { Users, Printer, UserPlus, X, Plus, ChevronDown, ChevronUp, Layers } from 'lucide-react'\n\nexport function GroupsPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [specialStatuses, setSpecialStatuses] = useState<SpecialStatus[]>([])\n  const [loading, setLoading] = useState(true)\n  const [schoolName, setSchoolName] = useState('')\n  const [teacherName, setTeacherName] = useState('')\n  const [selectedGroupId, setSelectedGroupId] = useState<string | null>(null)\n  const [showAddStudentModal, setShowAddStudentModal] = useState(false)\n  const [showManageGroupsModal, setShowManageGroupsModal] = useState(false)\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n  const [formData, setFormData] = useState({\n    name: '',\n    national_id: '',\n    phone: '',\n    guardian_phone: '',\n    grade: '',\n    special_status_id: '',\n  })\n  const [groupFormData, setGroupFormData] = useState({\n    stage: '',\n    name: '',\n  })\n  const [formError, setFormError] = useState('')\n  const [formLoading, setFormLoading] = useState(false)\n  const [showStatusDetails, setShowStatusDetails] = useState(false)\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  const fetchData = async () => {\n    try {\n      setLoading(true)\n      const [groupsData, studentsData, statusesData] = await Promise.all([\n        db.groups.toArray(),\n        db.students.toArray(),\n        db.special_statuses.toArray(),\n      ])\n\n      // Fetch school info from Supabase\n      const profileRes = await supabase.from('teacher_profile').select('*').maybeSingle()\n      if (profileRes.data) {\n        setSchoolName(profileRes.data.school_name || '')\n        setTeacherName(profileRes.data.name || '')\n      }\n\n      // Sort groups by stage and display_order\n      const sortedGroups = groupsData.sort((a, b) => {\n        const stageA = stageOrder[a.stage] || 999\n        const stageB = stageOrder[b.stage] || 999\n        if (stageA !== stageB) return stageA - stageB\n        return (a.display_order || 999) - (b.display_order || 999)\n      })\n      setGroups(sortedGroups)\n      setStudents(studentsData as Student[])\n      setSpecialStatuses(statusesData)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Define stage order\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  // Sort stages by defined order and sort groups within each stage\n  const sortedStages = Object.entries(groupedByStage)\n    .sort((a, b) => {\n      const orderA = stageOrder[a[0]] || 999\n      const orderB = stageOrder[b[0]] || 999\n      return orderA - orderB\n    })\n    .map(([stage, stageGroups]) => [\n      stage,\n      stageGroups.sort((a, b) => (a.display_order || 999) - (b.display_order || 999))\n    ] as [string, Group[]])\n\n  const toggleStage = (stage: string) => {\n    setExpandedStages((prev) => {\n      const next = new Set(prev)\n      if (next.has(stage)) {\n        next.delete(stage)\n      } else {\n        next.add(stage)\n      }\n      return next\n    })\n  }\n\n  const handlePrintAll = () => {\n    const currentDate = new Date().toLocaleDateString('ar-SA', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      weekday: 'long'\n    })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>جميع المجموعات</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }\n            .header h1 { color: #2563eb; margin-bottom: 10px; font-size: 32px; }\n            .header-info { color: #666; font-size: 16px; margin: 5px 0; }\n            .header-info strong { color: #333; }\n            h1 { text-align: center; color: #2563eb; margin-bottom: 30px; }\n            .stage-section { margin-bottom: 40px; }\n            .stage-title { color: #16a34a; font-size: 28px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #16a34a; }\n            .group-section { margin-bottom: 40px; page-break-after: always; }\n            .group-title { color: #2563eb; font-size: 24px; margin-bottom: 10px; }\n            .group-info { margin-bottom: 15px; color: #666; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #2563eb; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>${schoolName || 'اسم المدرسة'}</h1>\n            <p class=\"header-info\"><strong>المرشد الطلابي:</strong> ${teacherName || 'اسم المعلم'}</p>\n            <p class=\"header-info\"><strong>التاريخ:</strong> ${currentDate}</p>\n          </div>\n          <h2 style=\"text-align: center; color: #16a34a; margin-bottom: 30px;\">جميع المجموعات</h2>\n          ${sortedStages.map(([stage, stageGroups]) => `\n            <div class=\"stage-section\">\n              <h2 class=\"stage-title\">${stage}</h2>\n              ${stageGroups.map((group) => {\n                const groupStudents = students.filter(s => s.group_id === group.id)\n                return `\n                  <div class=\"group-section\">\n                    <h3 class=\"group-title\">${group.name}</h3>\n                    <p class=\"group-info\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n                    <table>\n                      <thead>\n                        <tr>\n                          <th>الاسم</th>\n                          <th>السجل المدني</th>\n                          <th>جوال الطالب</th>\n                          <th>جوال ولي الأمر</th>\n                          <th>الحالة الخاصة</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        ${groupStudents\n                          .map(\n                            (student) => {\n                              const status = specialStatuses.find(\n                                (s) => s.id === student.special_status_id\n                              )\n                              const statusText = student.special_status_id\n                                ? (showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة')\n                                : '-'\n                              return `\n                          <tr>\n                            <td>${student.name}</td>\n                            <td>${student.national_id}</td>\n                            <td>${student.phone}</td>\n                            <td>${student.guardian_phone}</td>\n                            <td>${statusText}</td>\n                          </tr>\n                        `\n                            }\n                          )\n                          .join('')}\n                      </tbody>\n                    </table>\n                  </div>\n                `\n              }).join('')}\n            </div>\n          `).join('')}\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handlePrint = (group: Group, groupStudents: Student[]) => {\n    const currentDate = new Date().toLocaleDateString('ar-SA', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      weekday: 'long'\n    })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>طلاب ${group.name}</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px; }\n            .header h1 { color: #2563eb; margin-bottom: 10px; font-size: 32px; }\n            .header-info { color: #666; font-size: 16px; margin: 5px 0; }\n            .header-info strong { color: #333; }\n            h1 { text-align: center; color: #2563eb; }\n            .stage { color: #16a34a; font-size: 20px; margin-bottom: 10px; text-align: center; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #2563eb; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>${schoolName || 'اسم المدرسة'}</h1>\n            <p class=\"header-info\"><strong>المرشد الطلابي:</strong> ${teacherName || 'اسم المعلم'}</p>\n            <p class=\"header-info\"><strong>التاريخ:</strong> ${currentDate}</p>\n          </div>\n          <p class=\"stage\">${group.stage}</p>\n          <h2 style=\"text-align: center; color: #2563eb; margin-bottom: 20px;\">قائمة طلاب ${group.name}</h2>\n          <p style=\"text-align: center; margin-bottom: 20px;\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n          <table>\n            <thead>\n              <tr>\n                <th>الاسم</th>\n                <th>السجل المدني</th>\n                <th>جوال الطالب</th>\n                <th>جوال ولي الأمر</th>\n                <th>الحالة الخاصة</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${groupStudents\n                .map(\n                  (student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    const statusText = student.special_status_id\n                      ? (showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة')\n                      : '-'\n                    return `\n                <tr>\n                  <td>${student.name}</td>\n                  <td>${student.national_id}</td>\n                  <td>${student.phone}</td>\n                  <td>${student.guardian_phone}</td>\n                  <td>${statusText}</td>\n                </tr>\n              `\n                  }\n                )\n                .join('')}\n            </tbody>\n          </table>\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handleAddStudent = (groupId: string) => {\n    setSelectedGroupId(groupId)\n    setShowAddStudentModal(true)\n    setFormData({\n      name: '',\n      national_id: '',\n      phone: '',\n      guardian_phone: '',\n      grade: '',\n      special_status_id: '',\n    })\n    setFormError('')\n  }\n\n  const handleCloseModal = () => {\n    setShowAddStudentModal(false)\n    setSelectedGroupId(null)\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setFormError('')\n\n    if (!formData.name || !formData.national_id || !selectedGroupId) {\n      setFormError('يرجى ملء جميع الحقول المطلوبة')\n      return\n    }\n\n    try {\n      setFormLoading(true)\n\n      const newId = crypto.randomUUID()\n      await db.students.add({\n        id: newId,\n        ...formData,\n        group_id: selectedGroupId,\n        special_status_id: formData.special_status_id || null,\n        status: 'نشط',\n        visit_count: 0,\n        permission_count: 0,\n        violation_count: 0,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString(),\n      } as any)\n\n      handleCloseModal()\n      fetchData()\n    } catch (err) {\n      setFormError(err instanceof Error ? err.message : 'حدث خطأ')\n    } finally {\n      setFormLoading(false)\n    }\n  }\n\n  const handleAddGroup = async () => {\n    if (!groupFormData.stage || !groupFormData.name) {\n      alert('يرجى ملء جميع الحقول')\n      return\n    }\n\n    try {\n      const newId = crypto.randomUUID()\n      await db.groups.add({\n        id: newId,\n        stage: groupFormData.stage,\n        name: groupFormData.name,\n        created_at: new Date().toISOString(),\n      })\n\n      setGroupFormData({ stage: '', name: '' })\n      fetchData()\n      alert('تم إضافة المجموعة بنجاح')\n    } catch (error) {\n      console.error('Error adding group:', error)\n      alert('حدث خطأ أثناء إضافة المجموعة')\n    }\n  }\n\n  const handleDeleteGroup = async (groupId: string) => {\n    const studentsInGroup = students.filter(s => s.group_id === groupId)\n\n    if (studentsInGroup.length > 0) {\n      alert('لا يمكن حذف مجموعة تحتوي على طلاب. يرجى نقل الطلاب أولاً.')\n      return\n    }\n\n    if (confirm('هل أنت متأكد من حذف هذه المجموعة؟')) {\n      try {\n        await db.groups.delete(groupId)\n        fetchData()\n        alert('تم حذف المجموعة بنجاح')\n      } catch (error) {\n        console.error('Error deleting group:', error)\n        alert('حدث خطأ أثناء حذف المجموعة')\n      }\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-2xl shadow-lg p-6 border border-gray-200\">\n        <div className=\"flex items-center justify-between flex-wrap gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <button\n              onClick={() => setShowAddStudentModal(true)}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all hover:shadow-lg\"\n              data-testid=\"button-add-student\"\n            >\n              <UserPlus size={20} />\n              <span>إضافة طالب</span>\n            </button>\n            <button\n              onClick={handlePrintAll}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-semibold hover:from-cyan-700 hover:to-blue-700 transition-all hover:shadow-lg\"\n            >\n              <Printer size={20} />\n              <span>طباعة الكل</span>\n            </button>\n            <button\n              onClick={() => setShowManageGroupsModal(true)}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl font-semibold hover:from-emerald-700 hover:to-teal-700 transition-all hover:shadow-lg\"\n            >\n              <Layers size={20} />\n              <span>إدارة المجموعات</span>\n            </button>\n          </div>\n          <label className=\"flex items-center gap-3 bg-gradient-to-r from-purple-50 to-pink-50 px-4 py-3 rounded-xl cursor-pointer hover:from-purple-100 hover:to-pink-100 transition-all border-2 border-purple-200\">\n            <input\n              type=\"checkbox\"\n              checked={showStatusDetails}\n              onChange={(e) => setShowStatusDetails(e.target.checked)}\n              className=\"w-5 h-5 rounded cursor-pointer\"\n            />\n            <span className=\"text-purple-700 font-semibold\">إظهار تفاصيل الحالة</span>\n          </label>\n        </div>\n      </div>\n\n      {Object.keys(groupedByStage).length === 0 ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n          <Users className=\"mx-auto mb-4 text-gray-300\" size={64} />\n          <h3 className=\"text-xl font-bold text-gray-700 mb-2\">لا توجد مجموعات</h3>\n          <p className=\"text-gray-500\">قم بإضافة مجموعات من خلال زر \"إدارة المجموعات\"</p>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {sortedStages.map(([stage, stageGroups]) => {\n            const isExpanded = expandedStages.has(stage)\n            const totalStudents = stageGroups.reduce((sum, group) => {\n              return sum + students.filter(s => s.group_id === group.id).length\n            }, 0)\n\n            return (\n              <div key={stage} className=\"bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200\">\n                <button\n                  onClick={() => toggleStage(stage)}\n                  className=\"w-full bg-gradient-to-r from-emerald-500 to-teal-500 p-6 flex items-center justify-between hover:from-emerald-600 hover:to-teal-600 transition-all shadow-md\"\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <Layers size={28} className=\"text-white\" />\n                    <div className=\"text-right\">\n                      <h2 className=\"text-2xl font-bold text-white\">{stage}</h2>\n                      <p className=\"text-emerald-50 text-sm\">\n                        {stageGroups.length} مجموعة • {totalStudents} طالب\n                      </p>\n                    </div>\n                  </div>\n                  {isExpanded ? (\n                    <ChevronUp size={28} className=\"text-white\" />\n                  ) : (\n                    <ChevronDown size={28} className=\"text-white\" />\n                  )}\n                </button>\n\n                {isExpanded && (\n                  <div className=\"p-4 space-y-4\">\n                    {stageGroups.map((group) => {\n                      const groupStudents = students.filter(s => s.group_id === group.id)\n                      return (\n                        <div key={group.id} className=\"border-2 border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow\">\n                          <div className=\"bg-gradient-to-r from-cyan-500 to-blue-500 p-4 flex items-center justify-between\">\n                            <div>\n                              <h3 className=\"text-xl font-bold text-white\">{group.name}</h3>\n                              <p className=\"text-cyan-50 text-sm\">عدد الطلاب: {groupStudents.length}</p>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => handlePrint(group, groupStudents)}\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white text-cyan-700 rounded-lg font-semibold hover:bg-cyan-50 transition-all text-sm shadow-sm\"\n                              >\n                                <Printer size={18} />\n                                طباعة\n                              </button>\n                              <button\n                                onClick={() => handleAddStudent(group.id)}\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white text-cyan-700 rounded-lg font-semibold hover:bg-cyan-50 transition-all text-sm shadow-sm\"\n                              >\n                                <UserPlus size={18} />\n                                إضافة طالب\n                              </button>\n                            </div>\n                          </div>\n\n                          {groupStudents.length === 0 ? (\n                            <div className=\"p-8 text-center text-gray-500 bg-gray-50\">\n                              <Users className=\"mx-auto mb-2 text-gray-300\" size={36} />\n                              <p>لا يوجد طلاب في هذه المجموعة</p>\n                            </div>\n                          ) : (\n                            <div className=\"overflow-x-auto\">\n                              <table className=\"w-full\">\n                                <thead className=\"bg-gray-50 border-b-2 border-gray-200\">\n                                  <tr>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الاسم</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">السجل المدني</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال الطالب</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال ولي الأمر</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الحالة الخاصة</th>\n                                  </tr>\n                                </thead>\n                                <tbody className=\"divide-y divide-gray-200\">\n                                  {groupStudents.map((student) => {\n                                    const status = specialStatuses.find(\n                                      (s) => s.id === student.special_status_id\n                                    )\n                                    return (\n                                      <tr key={student.id} className=\"hover:bg-blue-50 transition-colors\">\n                                        <td className=\"px-4 py-3 text-sm font-medium text-gray-900\">\n                                          {student.name}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.national_id}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.phone}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.guardian_phone}\n                                        </td>\n                                        <td className=\"px-4 py-3\">\n                                          {student.special_status_id ? (\n                                            <span className=\"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800\">\n                                              {showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة'}\n                                            </span>\n                                          ) : (\n                                            <span className=\"text-gray-400\">-</span>\n                                          )}\n                                        </td>\n                                      </tr>\n                                    )\n                                  })}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n                        </div>\n                      )\n                    })}\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n\n      {showAddStudentModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"sticky top-0 bg-gradient-to-r from-cyan-600 to-blue-600 p-6 flex items-center justify-between\">\n              <h3 className=\"text-2xl font-bold text-white\">إضافة طالب جديد</h3>\n              <button\n                onClick={handleCloseModal}\n                className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n              {formError && (\n                <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg\">\n                  {formError}\n                </div>\n              )}\n\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الاسم الكامل *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"أدخل اسم الطالب\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    السجل المدني *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.national_id}\n                    onChange={(e) =>\n                      setFormData({ ...formData, national_id: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"رقم السجل المدني\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الصف\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.grade}\n                    onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"مثال: الأول متوسط\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    جوال الطالب\n                  </label>\n                  <input\n                    type=\"tel\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"05xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    جوال ولي الأمر\n                  </label>\n                  <input\n                    type=\"tel\"\n                    value={formData.guardian_phone}\n                    onChange={(e) =>\n                      setFormData({ ...formData, guardian_phone: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"05xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الحالة الخاصة\n                  </label>\n                  <select\n                    value={formData.special_status_id}\n                    onChange={(e) =>\n                      setFormData({ ...formData, special_status_id: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                  >\n                    <option value=\"\">لا يوجد</option>\n                    {specialStatuses.map((status) => (\n                      <option key={status.id} value={status.id}>\n                        {status.name}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              </div>\n\n              <div className=\"flex gap-3 pt-4\">\n                <button\n                  type=\"submit\"\n                  disabled={formLoading}\n                  className=\"flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-cyan-700 hover:to-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-md\"\n                >\n                  {formLoading ? 'جاري الحفظ...' : 'حفظ الطالب'}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCloseModal}\n                  className=\"px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-50 transition-colors\"\n                >\n                  إلغاء\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n\n      {showManageGroupsModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"sticky top-0 bg-gradient-to-r from-emerald-600 to-teal-600 p-6 flex items-center justify-between\">\n              <h3 className=\"text-2xl font-bold text-white\">إدارة المراحل والمجموعات</h3>\n              <button\n                onClick={() => setShowManageGroupsModal(false)}\n                className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-6\">\n              <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl p-6 border-2 border-emerald-200\">\n                <h4 className=\"text-lg font-bold text-gray-900 mb-4\">إضافة مجموعة جديدة</h4>\n                <div className=\"grid md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الصف (المرحلة)\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={groupFormData.stage}\n                      onChange={(e) => setGroupFormData({ ...groupFormData, stage: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"مثال: الصف الأول الثانوي\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      اسم المجموعة\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={groupFormData.name}\n                      onChange={(e) => setGroupFormData({ ...groupFormData, name: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"مثال: مجموعة 1\"\n                    />\n                  </div>\n                </div>\n                <button\n                  onClick={handleAddGroup}\n                  className=\"mt-4 w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 shadow-md\"\n                >\n                  <Plus size={20} />\n                  إضافة المجموعة\n                </button>\n              </div>\n\n              <div>\n                <h4 className=\"text-lg font-bold text-gray-900 mb-4\">المجموعات الحالية</h4>\n                {Object.entries(groupedByStage).map(([stage, stageGroups]) => (\n                  <div key={stage} className=\"mb-6\">\n                    <h5 className=\"text-md font-bold text-emerald-800 mb-3 flex items-center gap-2 bg-gradient-to-r from-emerald-100 to-teal-100 px-4 py-2 rounded-lg\">\n                      <Layers size={20} />\n                      {stage}\n                    </h5>\n                    <div className=\"grid md:grid-cols-2 gap-3\">\n                      {stageGroups.map((group) => {\n                        const studentCount = students.filter(s => s.group_id === group.id).length\n                        return (\n                          <div\n                            key={group.id}\n                            className=\"bg-gray-50 rounded-lg p-4 flex items-center justify-between border border-gray-200\"\n                          >\n                            <div>\n                              <p className=\"font-semibold text-gray-900\">{group.name}</p>\n                              <p className=\"text-sm text-gray-600\">{studentCount} طالب</p>\n                            </div>\n                            <button\n                              onClick={() => handleDeleteGroup(group.id)}\n                              disabled={studentCount > 0}\n                              className=\"text-red-600 hover:text-red-700 disabled:text-gray-400 disabled:cursor-not-allowed\"\n                              title={studentCount > 0 ? 'لا يمكن حذف مجموعة تحتوي على طلاب' : 'حذف المجموعة'}\n                            >\n                              <X size={20} />\n                            </button>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","size_bytes":34838},"client/src/pages/AbsencePage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db, StudentViolation } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student } from '../types'\nimport { AlertTriangle, Search, FileText, Printer, Calendar, Filter, Send } from 'lucide-react'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface ViolationWithStudent extends StudentViolation {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    violation_count: number\n    grade: string\n    group?: {\n      name: string\n    }\n  }\n}\n\nexport function AbsencePage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [violations, setViolations] = useState<ViolationWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [formData, setFormData] = useState({\n    violation_type: 'هروب من الحصة' as const,\n    description: '',\n    action_taken: '',\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchViolations()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n    if (profile?.schoolName) {\n      setSchoolName(profile.schoolName)\n    }\n  }\n\n  async function fetchStudents() {\n    try {\n      const { data: studentsData } = await supabase\n        .from('students')\n        .select('*')\n        .order('name')\n\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const { data: statusesData } = await supabase.from('special_statuses').select('*')\n\n      const groups = groupsData || []\n      const statuses = statusesData || []\n\n      const studentsWithRelations = (studentsData || []).map(student => {\n        const group = groups.find(g => g.id === student.group_id)\n        const special_status = statuses.find(s => s.id === student.special_status_id)\n        return {\n          ...student,\n          group: group ? { name: group.name } : undefined,\n          special_status: special_status ? { name: special_status.name } : undefined\n        }\n      })\n\n      setStudents(studentsWithRelations as Student[])\n\n      if (studentsData) await db.students.bulkPut(studentsData)\n      if (groups.length > 0) await db.groups.bulkPut(groups)\n      if (statuses.length > 0) await db.special_statuses.bulkPut(statuses)\n    } catch (error) {\n      console.error('Error fetching students:', error)\n    }\n  }\n\n  async function fetchViolations(filterDate?: string) {\n    try {\n      let query = supabase\n        .from('student_violations')\n        .select('*')\n        .order('violation_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('violation_date', startOfDay.toISOString())\n          .lte('violation_date', endOfDay.toISOString())\n      } else {\n        query = query.limit(50)\n      }\n\n      const { data: violationsData } = await query\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const allStudents = studentsData || []\n\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const groups = groupsData || []\n\n      const violationsWithStudents = (violationsData || []).map((violation) => {\n        const student = allStudents.find(s => s.id === violation.student_id)\n        const group = student ? groups.find(g => g.id === student.group_id) : undefined\n        return {\n          ...violation,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            violation_count: student.violation_count || 0,\n            grade: student.grade || '',\n            group: group ? { name: group.name } : undefined\n          } : undefined\n        }\n      })\n\n      setViolations(violationsWithStudents)\n\n      if (violationsData) {\n        await db.student_violations.bulkPut(violationsData.map(v => ({\n          id: v.id,\n          student_id: v.student_id,\n          violation_type: v.violation_type,\n          violation_date: v.violation_date,\n          description: v.description,\n          action_taken: v.action_taken,\n          notes: v.notes || '',\n          created_at: v.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error fetching violations:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const violationDate = new Date().toISOString()\n      const currentCount = selectedStudent.violation_count || 0\n\n      const { data: violationData, error: violationError } = await supabase\n        .from('student_violations')\n        .insert({\n          student_id: selectedStudent.id,\n          violation_type: formData.violation_type,\n          violation_date: violationDate,\n          description: formData.description,\n          action_taken: formData.action_taken,\n          notes: formData.notes\n        })\n        .select()\n        .single()\n\n      if (violationError) throw violationError\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ violation_count: currentCount + 1 })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) throw updateError\n\n      if (violationData) {\n        await db.student_violations.add({\n          id: violationData.id,\n          student_id: violationData.student_id,\n          violation_type: violationData.violation_type,\n          violation_date: violationData.violation_date,\n          description: violationData.description,\n          action_taken: violationData.action_taken,\n          notes: violationData.notes || '',\n          created_at: violationData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        violation_count: currentCount + 1\n      })\n\n      alert('تم تسجيل المخالفة بنجاح')\n      setFormData({ violation_type: 'هروب من الحصة', description: '', action_taken: '', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchViolations(dateFilter)\n    } catch (error) {\n      console.error('Error saving violation:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  function sendWhatsApp(violation: ViolationWithStudent) {\n    if (!violation.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(violation.student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${violation.student.name}\n\nنود إعلامكم بتسجيل مخالفة سلوكية على الطالب بتاريخ: ${new Date(violation.violation_date).toLocaleDateString('ar-SA')}\n\n⚠️ نوع المخالفة: ${violation.violation_type}\n📝 الوصف: ${violation.description}\n✅ الإجراء المتخذ: ${violation.action_taken}\n\nيرجى التواصل مع الموجه الطلابي للاستفسار.\n\nمع تحيات إدارة المدرسة\n${teacherName ? teacherName : 'مسؤول النظام'}`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  async function printViolation(violation: ViolationWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    const violationDate = new Date(violation.violation_date)\n    const hijriDate = violationDate.toLocaleDateString('ar-SA-u-ca-islamic', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    }).replace(/\\u200f/g, '')\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>إشعار مخالفة</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            @page { margin: 2cm; }\n            body { \n              font-family: 'Arial', sans-serif; \n              padding: 40px; \n              margin: 0;\n            }\n            .header { \n              text-align: center; \n              margin-bottom: 10px;\n            }\n            .header-line {\n              font-size: 14px;\n              color: #374151;\n              margin: 3px 0;\n            }\n            .title {\n              font-size: 16px;\n              font-weight: bold;\n              text-align: center;\n              margin: 15px 0;\n            }\n            .divider {\n              border-bottom: 2px solid #000;\n              margin: 15px 0 25px 0;\n            }\n            table {\n              width: 100%;\n              border-collapse: collapse;\n              margin: 20px 0;\n            }\n            td {\n              padding: 12px;\n              border-bottom: 1px solid #e5e7eb;\n              font-size: 14px;\n            }\n            .label-cell {\n              text-align: right;\n              font-weight: bold;\n              color: #1f2937;\n              width: 30%;\n            }\n            .value-cell {\n              text-align: right;\n              color: #374151;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 40px;\n              font-size: 12px;\n              color: #6b7280;\n            }\n            @media print { \n              body { padding: 20px; } \n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <div class=\"header-line\">نظام المشرف الصحي المدرسي</div>\n            <div class=\"header-line\">المرشد الطلابي: ${teacherName || 'اسم المعلم'}</div>\n            <div class=\"header-line\" style=\"font-weight: bold;\">إشعار مخالفة سلوكية</div>\n          </div>\n          \n          <div class=\"divider\"></div>\n          \n          <table>\n            <tr>\n              <td class=\"label-cell\">نوع الحضور</td>\n              <td class=\"value-cell\">مخالفة</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">التاريخ</td>\n              <td class=\"value-cell\">${hijriDate}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">اسم الطالب</td>\n              <td class=\"value-cell\">${violation.student?.name || ''}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">السجل المدني</td>\n              <td class=\"value-cell\">${violation.student?.national_id || ''}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">نوع المخالفة</td>\n              <td class=\"value-cell\">${violation.violation_type}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">وصف المخالفة</td>\n              <td class=\"value-cell\">${violation.description}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">الإجراء المتخذ</td>\n              <td class=\"value-cell\">${violation.action_taken}</td>\n            </tr>\n            ${violation.notes ? `\n            <tr>\n              <td class=\"label-cell\">ملاحظات</td>\n              <td class=\"value-cell\">${violation.notes}</td>\n            </tr>\n            ` : ''}\n          </table>\n          \n          <div class=\"footer\">\n            تم الإنشاء بتاريخ: ${new Date().toLocaleDateString('ar-SA-u-ca-islamic')}<br>\n            عدد المخالفات المسجلة: ${violation.student?.violation_count || 1}\n          </div>\n          \n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <AlertTriangle size={28} className=\"text-red-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">المخالفات</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-red-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-red-600 font-semibold mt-1\">\n                      عدد المخالفات: {student.violation_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-red-50 rounded-lg p-4 border border-red-200\">\n                <h3 className=\"font-bold text-red-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد المخالفات السابقة:</span>\n                    <span className=\"text-red-600 font-bold mr-2\">{selectedStudent.violation_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  نوع المخالفة\n                </label>\n                <select\n                  value={formData.violation_type}\n                  onChange={(e) => setFormData({ ...formData, violation_type: e.target.value as any })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                >\n                  <option value=\"هروب من الحصة\">هروب من الحصة</option>\n                  <option value=\"تأخر صباحي\">تأخر صباحي</option>\n                  <option value=\"غياب بدون عذر\">غياب بدون عذر</option>\n                  <option value=\"عدم إحضار الكتب\">عدم إحضار الكتب</option>\n                  <option value=\"عدم حل الواجبات\">عدم حل الواجبات</option>\n                  <option value=\"سلوك غير لائق\">سلوك غير لائق</option>\n                  <option value=\"شجار\">شجار</option>\n                  <option value=\"إزعاج\">إزعاج</option>\n                  <option value=\"أخرى\">أخرى</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  وصف المخالفة\n                </label>\n                <textarea\n                  required\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب وصف تفصيلي للمخالفة...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الإجراء المتخذ\n                </label>\n                <textarea\n                  required\n                  value={formData.action_taken}\n                  onChange={(e) => setFormData({ ...formData, action_taken: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل المخالفة'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <FileText size={24} />\n            سجل المخالفات {dateFilter ? 'المفلترة' : 'الأخيرة'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchViolations(dateFilter)}\n                className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchViolations()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-red-600 font-semibold mt-3\">\n                عرض المخالفات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {violations.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد مخالفات {dateFilter ? 'في هذا التاريخ' : ''}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {violations.map(violation => (\n              <div key={violation.id} className=\"border border-red-200 rounded-lg p-4 bg-red-50\">\n                <div className=\"flex justify-between items-start mb-3\">\n                  <div>\n                    <h4 className=\"font-bold text-gray-800\">{violation.student?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">\n                      {new Date(violation.violation_date).toLocaleString('ar-SA')}\n                    </p>\n                    <p className=\"text-sm font-bold text-red-600 mt-1\">\n                      <AlertTriangle size={14} className=\"inline ml-1\" />\n                      {violation.violation_type}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      onClick={() => printViolation(violation)}\n                      className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Printer size={16} />\n                      طباعة\n                    </button>\n                    <button\n                      onClick={() => sendWhatsApp(violation)}\n                      className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Send size={16} />\n                      واتساب\n                    </button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div><span className=\"font-semibold\">الوصف:</span> {violation.description}</div>\n                  <div><span className=\"font-semibold\">الإجراء:</span> {violation.action_taken}</div>\n                  {violation.notes && (\n                    <div className=\"text-gray-600\">\n                      <span className=\"font-semibold\">ملاحظات:</span> {violation.notes}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":24122},"client/src/components/FiltersPanel.tsx":{"content":"import { SpecialStatus } from '../types'\nimport { ChevronDown } from 'lucide-react'\nimport { useState } from 'react'\n\ninterface FiltersPanelProps {\n  specialStatuses: SpecialStatus[]\n  filter: {\n    type: 'status' | 'special_status' | null\n    value: string\n  } | null\n  onFilterChange: (filter: any) => void\n}\n\nexport function FiltersPanel({\n  specialStatuses,\n  filter,\n  onFilterChange,\n}: FiltersPanelProps) {\n  const [isSpecialStatusOpen, setIsSpecialStatusOpen] = useState(false)\n  const [isStudentStatusOpen, setIsStudentStatusOpen] = useState(false)\n\n  const getSpecialStatusLabel = () => {\n    if (!filter || filter.type !== 'special_status') return 'الكل'\n    if (filter.value === 'none') return 'بدون حالة خاصة'\n    const status = specialStatuses.find((s) => s.id === filter.value)\n    return status?.name || 'الكل'\n  }\n\n  const getStudentStatusLabel = () => {\n    if (!filter || filter.type !== 'status') return 'الكل'\n    return filter.value\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <div className=\"space-y-3\">\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            الحالات الخاصة\n          </label>\n          <div className=\"relative\">\n            <button\n              onClick={() => setIsSpecialStatusOpen(!isSpecialStatusOpen)}\n              className=\"w-full px-3 py-2 border border-orange-300 rounded-lg text-right text-sm font-medium bg-orange-50 hover:bg-orange-100 flex items-center justify-between\"\n            >\n              <span>{getSpecialStatusLabel()}</span>\n              <ChevronDown\n                size={16}\n                className={`transition-transform ${isSpecialStatusOpen ? 'rotate-180' : ''}`}\n              />\n            </button>\n            {isSpecialStatusOpen && (\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto\">\n                <button\n                  onClick={() => {\n                    onFilterChange(null)\n                    setIsSpecialStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                    filter === null ? 'bg-orange-100 text-orange-800' : 'text-gray-700'\n                  }`}\n                >\n                  الكل\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'special_status', value: 'none' })\n                    setIsSpecialStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                    filter?.type === 'special_status' && filter?.value === 'none'\n                      ? 'bg-orange-100 text-orange-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  بدون حالة خاصة\n                </button>\n                {specialStatuses.map((status) => (\n                  <button\n                    key={status.id}\n                    onClick={() => {\n                      onFilterChange({ type: 'special_status', value: status.id })\n                      setIsSpecialStatusOpen(false)\n                    }}\n                    className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                      filter?.type === 'special_status' && filter?.value === status.id\n                        ? 'bg-orange-100 text-orange-800'\n                        : 'text-gray-700'\n                    }`}\n                  >\n                    {status.name}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            حالة الطالب\n          </label>\n          <div className=\"relative\">\n            <button\n              onClick={() => setIsStudentStatusOpen(!isStudentStatusOpen)}\n              className=\"w-full px-3 py-2 border border-teal-300 rounded-lg text-right text-sm font-medium bg-teal-50 hover:bg-teal-100 flex items-center justify-between\"\n            >\n              <span>{getStudentStatusLabel()}</span>\n              <ChevronDown\n                size={16}\n                className={`transition-transform ${isStudentStatusOpen ? 'rotate-180' : ''}`}\n              />\n            </button>\n            {isStudentStatusOpen && (\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10\">\n                <button\n                  onClick={() => {\n                    onFilterChange(null)\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter === null ? 'bg-teal-100 text-teal-800' : 'text-gray-700'\n                  }`}\n                >\n                  الكل\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'status', value: 'نشط' })\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter?.type === 'status' && filter?.value === 'نشط'\n                      ? 'bg-teal-100 text-teal-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  نشط\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'status', value: 'استئذان' })\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter?.type === 'status' && filter?.value === 'استئذان'\n                      ? 'bg-teal-100 text-teal-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  استئذان\n                </button>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6383},"Erchad-1/client/src/pages/AbsencePage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { db, StudentViolation } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student } from '../types'\nimport { AlertTriangle, Search, FileText, Printer, Calendar, Filter, Send } from 'lucide-react'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface ViolationWithStudent extends StudentViolation {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    violation_count: number\n  }\n}\n\nexport function AbsencePage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [violations, setViolations] = useState<ViolationWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [formData, setFormData] = useState({\n    violation_type: 'هروب من الحصة' as const,\n    description: '',\n    action_taken: '',\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchViolations()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    try {\n      const { data: studentsData } = await supabase\n        .from('students')\n        .select('*')\n        .order('name')\n\n      const { data: groupsData } = await supabase.from('groups').select('*')\n      const { data: statusesData } = await supabase.from('special_statuses').select('*')\n\n      const groups = groupsData || []\n      const statuses = statusesData || []\n\n      const studentsWithRelations = (studentsData || []).map(student => {\n        const group = groups.find(g => g.id === student.group_id)\n        const special_status = statuses.find(s => s.id === student.special_status_id)\n        return {\n          ...student,\n          group: group ? { name: group.name } : undefined,\n          special_status: special_status ? { name: special_status.name } : undefined\n        }\n      })\n\n      setStudents(studentsWithRelations as Student[])\n\n      if (studentsData) await db.students.bulkPut(studentsData)\n      if (groups.length > 0) await db.groups.bulkPut(groups)\n      if (statuses.length > 0) await db.special_statuses.bulkPut(statuses)\n    } catch (error) {\n      console.error('Error fetching students:', error)\n    }\n  }\n\n  async function fetchViolations(filterDate?: string) {\n    try {\n      let query = supabase\n        .from('student_violations')\n        .select('*')\n        .order('violation_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('violation_date', startOfDay.toISOString())\n          .lte('violation_date', endOfDay.toISOString())\n      } else {\n        query = query.limit(50)\n      }\n\n      const { data: violationsData } = await query\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const allStudents = studentsData || []\n\n      const violationsWithStudents = (violationsData || []).map((violation) => {\n        const student = allStudents.find(s => s.id === violation.student_id)\n        return {\n          ...violation,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            violation_count: student.violation_count || 0\n          } : undefined\n        }\n      })\n\n      setViolations(violationsWithStudents)\n\n      if (violationsData) {\n        await db.student_violations.bulkPut(violationsData.map(v => ({\n          id: v.id,\n          student_id: v.student_id,\n          violation_type: v.violation_type,\n          violation_date: v.violation_date,\n          description: v.description,\n          action_taken: v.action_taken,\n          notes: v.notes || '',\n          created_at: v.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error fetching violations:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const violationDate = new Date().toISOString()\n      const currentCount = selectedStudent.violation_count || 0\n\n      const { data: violationData, error: violationError } = await supabase\n        .from('student_violations')\n        .insert({\n          student_id: selectedStudent.id,\n          violation_type: formData.violation_type,\n          violation_date: violationDate,\n          description: formData.description,\n          action_taken: formData.action_taken,\n          notes: formData.notes\n        })\n        .select()\n        .single()\n\n      if (violationError) throw violationError\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ violation_count: currentCount + 1 })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) throw updateError\n\n      if (violationData) {\n        await db.student_violations.add({\n          id: violationData.id,\n          student_id: violationData.student_id,\n          violation_type: violationData.violation_type,\n          violation_date: violationData.violation_date,\n          description: violationData.description,\n          action_taken: violationData.action_taken,\n          notes: violationData.notes || '',\n          created_at: violationData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        violation_count: currentCount + 1\n      })\n\n      alert('تم تسجيل المخالفة بنجاح')\n      setFormData({ violation_type: 'هروب من الحصة', description: '', action_taken: '', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchViolations(dateFilter)\n    } catch (error) {\n      console.error('Error saving violation:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  function sendWhatsApp(violation: ViolationWithStudent) {\n    if (!violation.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(violation.student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${violation.student.name}\n\nنود إعلامكم بتسجيل مخالفة سلوكية على الطالب بتاريخ: ${new Date(violation.violation_date).toLocaleDateString('ar-SA')}\n\n⚠️ نوع المخالفة: ${violation.violation_type}\n📝 الوصف: ${violation.description}\n✅ الإجراء المتخذ: ${violation.action_taken}\n\nيرجى التواصل مع الموجه الطلابي للاستفسار.\n\nمع تحيات إدارة المدرسة`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  async function printViolation(violation: ViolationWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>تقرير مخالفة طالب</title>\n          <style>\n            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; }\n            .header { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }\n            .header h1 { margin: 0; color: #dc2626; }\n            .header .meta { color: #666; font-size: 12px; margin-top: 10px; }\n            .section { margin-bottom: 20px; }\n            .section label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }\n            .section div { padding: 10px; background: #fef2f2; border-radius: 5px; border: 1px solid #fca5a5; }\n            .violation-type { background: #fee2e2; border: 2px solid #dc2626; font-size: 18px; text-align: center; padding: 15px; font-weight: bold; }\n            @media print { body { padding: 20px; } }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <h1>⚠️ تقرير مخالفة سلوكية</h1>\n            <p>التاريخ: ${new Date(violation.violation_date).toLocaleString('ar-SA')}</p>\n            ${teacherName ? `<div class=\"meta\">بواسطة: ${teacherName}</div>` : ''}\n          </div>\n          <div class=\"section\">\n            <label>اسم الطالب:</label>\n            <div>${violation.student?.name}</div>\n          </div>\n          <div class=\"section\">\n            <label>السجل المدني:</label>\n            <div>${violation.student?.national_id}</div>\n          </div>\n          <div class=\"section\">\n            <label>نوع المخالفة:</label>\n            <div class=\"violation-type\">${violation.violation_type}</div>\n          </div>\n          <div class=\"section\">\n            <label>وصف المخالفة:</label>\n            <div>${violation.description}</div>\n          </div>\n          <div class=\"section\">\n            <label>الإجراء المتخذ:</label>\n            <div>${violation.action_taken}</div>\n          </div>\n          ${violation.notes ? `\n          <div class=\"section\">\n            <label>ملاحظات:</label>\n            <div>${violation.notes}</div>\n          </div>\n          ` : ''}\n          <div style=\"margin-top: 40px; padding-top: 20px; border-top: 2px dashed #ccc;\">\n            <p style=\"text-align: center; color: #666; font-size: 14px;\">\n              عدد المخالفات المسجلة للطالب: ${violation.student?.violation_count || 1}\n            </p>\n          </div>\n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <AlertTriangle size={28} className=\"text-red-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">المخالفات</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-red-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-red-600 font-semibold mt-1\">\n                      عدد المخالفات: {student.violation_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-red-50 rounded-lg p-4 border border-red-200\">\n                <h3 className=\"font-bold text-red-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد المخالفات السابقة:</span>\n                    <span className=\"text-red-600 font-bold mr-2\">{selectedStudent.violation_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  نوع المخالفة\n                </label>\n                <select\n                  value={formData.violation_type}\n                  onChange={(e) => setFormData({ ...formData, violation_type: e.target.value as any })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                >\n                  <option value=\"هروب من الحصة\">هروب من الحصة</option>\n                  <option value=\"تأخر صباحي\">تأخر صباحي</option>\n                  <option value=\"غياب بدون عذر\">غياب بدون عذر</option>\n                  <option value=\"عدم إحضار الكتب\">عدم إحضار الكتب</option>\n                  <option value=\"عدم حل الواجبات\">عدم حل الواجبات</option>\n                  <option value=\"سلوك غير لائق\">سلوك غير لائق</option>\n                  <option value=\"شجار\">شجار</option>\n                  <option value=\"إزعاج\">إزعاج</option>\n                  <option value=\"أخرى\">أخرى</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  وصف المخالفة\n                </label>\n                <textarea\n                  required\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب وصف تفصيلي للمخالفة...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الإجراء المتخذ\n                </label>\n                <textarea\n                  required\n                  value={formData.action_taken}\n                  onChange={(e) => setFormData({ ...formData, action_taken: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل المخالفة'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <FileText size={24} />\n            سجل المخالفات {dateFilter ? 'المفلترة' : 'الأخيرة'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchViolations(dateFilter)}\n                className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchViolations()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-red-600 font-semibold mt-3\">\n                عرض المخالفات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {violations.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد مخالفات {dateFilter ? 'في هذا التاريخ' : ''}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {violations.map(violation => (\n              <div key={violation.id} className=\"border border-red-200 rounded-lg p-4 bg-red-50\">\n                <div className=\"flex justify-between items-start mb-3\">\n                  <div>\n                    <h4 className=\"font-bold text-gray-800\">{violation.student?.name}</h4>\n                    <p className=\"text-sm text-gray-600\">\n                      {new Date(violation.violation_date).toLocaleString('ar-SA')}\n                    </p>\n                    <p className=\"text-sm font-bold text-red-600 mt-1\">\n                      <AlertTriangle size={14} className=\"inline ml-1\" />\n                      {violation.violation_type}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <button\n                      onClick={() => printViolation(violation)}\n                      className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Printer size={16} />\n                      طباعة\n                    </button>\n                    <button\n                      onClick={() => sendWhatsApp(violation)}\n                      className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                    >\n                      <Send size={16} />\n                      واتساب\n                    </button>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 text-sm\">\n                  <div><span className=\"font-semibold\">الوصف:</span> {violation.description}</div>\n                  <div><span className=\"font-semibold\">الإجراء:</span> {violation.action_taken}</div>\n                  {violation.notes && (\n                    <div className=\"text-gray-600\">\n                      <span className=\"font-semibold\">ملاحظات:</span> {violation.notes}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":22127},"client/src/pages/SpecialStatusPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Student, Group, SpecialStatus } from '../types'\nimport { Heart, Printer, FileText, Send } from 'lucide-react'\nimport { SendToTeacherModal } from '../components/SendToTeacherModal'\n\nexport function SpecialStatusPage({\n  students,\n  groups,\n  specialStatuses,\n}: {\n  students: Student[]\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n}) {\n  const [labPhone, setLabPhone] = useState('')\n  const [showStatusDetails, setShowStatusDetails] = useState(false)\n  const [showSendToTeacherModal, setShowSendToTeacherModal] = useState(false)\n\n  useEffect(() => {\n    fetchLabContact()\n  }, [])\n\n  const fetchLabContact = async () => {\n    const { data } = await supabase\n      .from('lab_contact')\n      .select('*')\n      .maybeSingle()\n\n    if (data) {\n      setLabPhone(data.phone || '')\n    }\n  }\n\n  const studentsWithSpecialStatus = students.filter(\n    (s) => s.special_status_id !== null\n  )\n\n  const groupedData = groups.map((group) => {\n    const groupStudents = studentsWithSpecialStatus.filter(\n      (s) => s.group_id === group.id\n    )\n    return {\n      group,\n      students: groupStudents,\n      count: groupStudents.length,\n    }\n  })\n\n  const handlePrintAll = async () => {\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>جميع الحالات الخاصة</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h1 { text-align: center; color: #9333ea; margin-bottom: 10px; }\n            .meta { text-align: center; color: #666; font-size: 12px; margin-bottom: 30px; }\n            .group-section { margin-bottom: 40px; page-break-after: always; }\n            .group-title { color: #9333ea; font-size: 24px; margin-bottom: 10px; }\n            .group-info { margin-bottom: 15px; color: #666; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #9333ea; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <h1>جميع الحالات الخاصة</h1>\n          <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n          <p style=\"text-align: center; font-size: 18px; margin-bottom: 30px;\">\n            <strong>إجمالي الطلاب ذوي الحالات الخاصة: ${studentsWithSpecialStatus.length}</strong>\n          </p>\n          ${groupedData.filter(({ count }) => count > 0).map(({ group, students: groupStudents }) => `\n            <div class=\"group-section\">\n              <h2 class=\"group-title\">${group.name}</h2>\n              <p class=\"group-info\"><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n              <table>\n                <thead>\n                  <tr>\n                    <th>الاسم</th>\n                    <th>السجل المدني</th>\n                    <th>جوال الطالب</th>\n                    <th>جوال ولي الأمر</th>\n                    <th>الحالة الخاصة</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${groupStudents\n                    .map(\n                      (student) => {\n                        const status = specialStatuses.find(\n                          (s) => s.id === student.special_status_id\n                        )\n                        const statusText = showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'\n                        return `\n                    <tr>\n                      <td>${student.name}</td>\n                      <td>${student.national_id}</td>\n                      <td>${student.phone}</td>\n                      <td>${student.guardian_phone}</td>\n                      <td>${statusText}</td>\n                    </tr>\n                  `\n                      }\n                    )\n                    .join('')}\n                </tbody>\n              </table>\n            </div>\n          `).join('')}\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handlePrint = async (group: Group, groupStudents: Student[]) => {\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>الحالات الخاصة - ${group.name}</title>\n          <style>\n            body { font-family: Arial, sans-serif; padding: 20px; }\n            h1 { text-align: center; color: #9333ea; }\n            .meta { text-align: center; color: #666; font-size: 12px; margin-bottom: 20px; }\n            table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n            th, td { border: 1px solid #ddd; padding: 12px; text-align: right; }\n            th { background-color: #9333ea; color: white; }\n            tr:nth-child(even) { background-color: #f2f2f2; }\n          </style>\n        </head>\n        <body>\n          <h1>الحالات الخاصة - ${group.name}</h1>\n          <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n          <p><strong>عدد الطلاب:</strong> ${groupStudents.length}</p>\n          <table>\n            <thead>\n              <tr>\n                <th>الاسم</th>\n                <th>السجل المدني</th>\n                <th>جوال الطالب</th>\n                <th>جوال ولي الأمر</th>\n                <th>الحالة الخاصة</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${groupStudents\n                .map(\n                  (student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    return `\n                <tr>\n                  <td>${student.name}</td>\n                  <td>${student.national_id}</td>\n                  <td>${student.phone}</td>\n                  <td>${student.guardian_phone}</td>\n                  <td>${showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'}</td>\n                </tr>\n              `\n                  }\n                )\n                .join('')}\n            </tbody>\n          </table>\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-r from-purple-600 to-purple-500 rounded-2xl shadow-lg p-8 text-white\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n              <Heart size={32} />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold\">الحالات الخاصة</h1>\n              <p className=\"text-purple-100 text-lg mt-1\">\n                إجمالي الطلاب ذوي الحالات الخاصة: {studentsWithSpecialStatus.length}\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <button\n              onClick={() => setShowSendToTeacherModal(true)}\n              disabled={studentsWithSpecialStatus.length === 0}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <Send size={20} />\n              <span>إرسال للمعلم</span>\n            </button>\n            <button\n              onClick={handlePrintAll}\n              disabled={studentsWithSpecialStatus.length === 0}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              <Printer size={20} />\n              <span>طباعة الكل</span>\n            </button>\n            <label className=\"flex items-center gap-3 bg-white bg-opacity-20 px-4 py-3 rounded-xl cursor-pointer hover:bg-opacity-30 transition-all\">\n              <input\n                type=\"checkbox\"\n                checked={showStatusDetails}\n                onChange={(e) => setShowStatusDetails(e.target.checked)}\n                className=\"w-5 h-5 rounded cursor-pointer\"\n              />\n              <span className=\"text-white font-semibold\">إظهار تفاصيل الحالة</span>\n            </label>\n          </div>\n        </div>\n      </div>\n\n      {groupedData.map(({ group, students: groupStudents, count }) => {\n        if (count === 0) return null\n\n        return (\n          <div\n            key={group.id}\n            className=\"bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200\"\n          >\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-500 p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold text-white mb-1\">{group.name}</h2>\n                  <p className=\"text-purple-100\">عدد الطلاب: {count}</p>\n                </div>\n                <button\n                  onClick={() => handlePrint(group, groupStudents)}\n                  className=\"flex items-center gap-2 px-5 py-2.5 bg-white text-purple-600 rounded-xl font-semibold hover:bg-purple-50 transition-all hover:shadow-md\"\n                >\n                  <Printer size={20} />\n                  <span>طباعة</span>\n                </button>\n              </div>\n            </div>\n\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead className=\"bg-gray-50 border-b-2 border-gray-200\">\n                  <tr>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      الاسم\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      السجل المدني\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      جوال الطالب\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      جوال ولي الأمر\n                    </th>\n                    <th className=\"px-6 py-4 text-right text-sm font-bold text-gray-700\">\n                      الحالة الخاصة\n                    </th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-gray-200\">\n                  {groupStudents.map((student) => {\n                    const status = specialStatuses.find(\n                      (s) => s.id === student.special_status_id\n                    )\n                    return (\n                      <tr key={student.id} className=\"hover:bg-purple-50 transition-colors\">\n                        <td className=\"px-6 py-4 text-sm font-medium text-gray-900\">\n                          {student.name}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.national_id}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.phone}\n                        </td>\n                        <td className=\"px-6 py-4 text-sm text-gray-600\">\n                          {student.guardian_phone}\n                        </td>\n                        <td className=\"px-6 py-4\">\n                          <span className=\"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800\">\n                            {showStatusDetails ? (status?.name || '-') : 'لديه حالة خاصة'}\n                          </span>\n                        </td>\n                      </tr>\n                    )\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )\n      })}\n\n      {studentsWithSpecialStatus.length === 0 && (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200\">\n          <FileText className=\"mx-auto text-gray-300 mb-4\" size={64} />\n          <p className=\"text-gray-500 text-xl\">لا يوجد طلاب بحالات خاصة</p>\n        </div>\n      )}\n\n      <SendToTeacherModal\n        isOpen={showSendToTeacherModal}\n        onClose={() => setShowSendToTeacherModal(false)}\n        specialStatusStudents={studentsWithSpecialStatus}\n      />\n    </div>\n  )\n}\n","size_bytes":13913},"client/src/components/ProfileSettings.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { useQuery, useMutation } from '@tanstack/react-query'\nimport { apiRequest, queryClient } from '@/lib/queryClient'\nimport type { TeacherProfile } from '@shared/schema'\nimport { X, Save, User, Trash2, AlertTriangle, Lock, Key, Clock } from 'lucide-react'\n\ninterface ProfileSettingsProps {\n  onClose: () => void\n}\n\nexport function ProfileSettings({ onClose }: ProfileSettingsProps) {\n  const [teacherName, setTeacherName] = useState('')\n  const [teacherPhone, setTeacherPhone] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n  const [systemTitle, setSystemTitle] = useState('')\n  const [autoLogoutMinutes, setAutoLogoutMinutes] = useState(0)\n  const [showResetConfirm, setShowResetConfirm] = useState(false)\n  const [showPasswordSection, setShowPasswordSection] = useState(false)\n  const [newUsername, setNewUsername] = useState('')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmPassword, setConfirmPassword] = useState('')\n  const [passwordError, setPasswordError] = useState('')\n  \n  // خيارات تصفير البيانات\n  const [clearOptions, setClearOptions] = useState({\n    all: true,\n    students: false,\n    teachers: false,\n    specialStatuses: false,\n    visits: false,\n    permissions: false,\n    violations: false\n  })\n\n  const { data: profile } = useQuery<TeacherProfile>({\n    queryKey: ['/api/teacher-profile'],\n  })\n\n  useEffect(() => {\n    if (profile) {\n      setTeacherName(profile.name || '')\n      setTeacherPhone(profile.phone || '')\n      setSchoolName(profile.schoolName || '')\n      setSystemTitle(profile.systemTitle || '')\n      setAutoLogoutMinutes(profile.autoLogoutMinutes || 0)\n    }\n  }, [profile])\n\n  const updateProfile = useMutation({\n    mutationFn: async (data: Partial<TeacherProfile>) => {\n      return apiRequest('/api/teacher-profile', 'POST', data)\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teacher-profile'] })\n      alert('تم حفظ البيانات بنجاح')\n      window.location.reload()\n    },\n    onError: () => {\n      alert('حدث خطأ في حفظ البيانات')\n    }\n  })\n\n  const handleSave = async (e: React.FormEvent) => {\n    e.preventDefault()\n    updateProfile.mutate({\n      name: teacherName,\n      phone: teacherPhone,\n      schoolName: schoolName,\n      systemTitle: systemTitle,\n      autoLogoutMinutes: autoLogoutMinutes,\n    })\n  }\n\n  const changePassword = useMutation({\n    mutationFn: async (data: { currentUsername: string; newUsername: string; newPassword: string }) => {\n      return apiRequest('/api/update-login-credentials', 'POST', data)\n    },\n    onSuccess: () => {\n      alert('تم تغيير بيانات الدخول بنجاح!')\n      setShowPasswordSection(false)\n      setNewPassword('')\n      setConfirmPassword('')\n    },\n    onError: () => {\n      setPasswordError('حدث خطأ أثناء تغيير بيانات الدخول')\n    }\n  })\n\n  const handleChangePassword = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setPasswordError('')\n\n    if (newPassword !== confirmPassword) {\n      setPasswordError('كلمة المرور غير متطابقة')\n      return\n    }\n\n    if (newPassword.length < 4) {\n      setPasswordError('كلمة المرور يجب أن تكون 4 أحرف على الأقل')\n      return\n    }\n\n    changePassword.mutate({\n      currentUsername: 'admin',\n      newUsername: newUsername,\n      newPassword: newPassword\n    })\n  }\n\n  const clearDatabase = useMutation({\n    mutationFn: async () => {\n      return apiRequest('/api/clear-database-selective', 'POST', clearOptions)\n    },\n    onSuccess: () => {\n      alert('تم حذف البيانات المحددة بنجاح!')\n      setShowResetConfirm(false)\n      onClose()\n      window.location.reload()\n    },\n    onError: () => {\n      alert('حدث خطأ أثناء حذف البيانات')\n      setShowResetConfirm(false)\n    }\n  })\n  \n  const handleClearOptionChange = (option: string) => {\n    if (option === 'all') {\n      const newValue = !clearOptions.all\n      setClearOptions({\n        all: newValue,\n        students: !newValue,\n        teachers: !newValue,\n        specialStatuses: !newValue,\n        visits: !newValue,\n        permissions: !newValue,\n        violations: !newValue\n      })\n    } else {\n      setClearOptions(prev => {\n        const updated = { ...prev, [option]: !prev[option as keyof typeof prev] }\n        // إذا تم إلغاء تحديد كل شي، تأكد من إلغاء \"الكل\"\n        updated.all = false\n        return updated\n      })\n    }\n  }\n\n  const handleResetDatabase = async () => {\n    clearDatabase.mutate()\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <User className=\"text-blue-600\" size={24} />\n            <h2 className=\"text-2xl font-bold text-gray-900\">الإعدادات</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <form onSubmit={handleSave} className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-6 space-y-4\">\n            <h3 className=\"text-xl font-bold text-gray-900 mb-4\">\n              معلومات النظام\n            </h3>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                اسم مسؤول النظام\n              </label>\n              <input\n                type=\"text\"\n                value={teacherName}\n                onChange={(e) => setTeacherName(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"أدخل اسم مسؤول النظام\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                رقم الجوال\n              </label>\n              <input\n                type=\"tel\"\n                value={teacherPhone}\n                onChange={(e) => setTeacherPhone(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"05xxxxxxxx\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                وصف النظام\n              </label>\n              <input\n                type=\"text\"\n                value={schoolName}\n                onChange={(e) => setSchoolName(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"مثال: نظام إدارة شاملة لبيانات الطلاب\"\n                data-testid=\"input-system-description\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                اسم المدرسة\n              </label>\n              <input\n                type=\"text\"\n                value={systemTitle}\n                onChange={(e) => setSystemTitle(e.target.value)}\n                className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"مثال: مدرسة الملك عبدالله الابتدائية\"\n                data-testid=\"input-school-name\"\n              />\n            </div>\n          </div>\n\n          <div className=\"bg-purple-50 border-2 border-purple-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <Clock className=\"text-purple-600 flex-shrink-0 mt-1\" size={24} />\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-purple-900 mb-2\">\n                  تسجيل الخروج التلقائي\n                </h3>\n                <p className=\"text-sm text-purple-700 mb-4\">\n                  حدد المدة الزمنية التي يتم بعدها تسجيل الخروج تلقائياً في حالة عدم النشاط لحماية بيانات الطلاب\n                </p>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                مدة عدم النشاط قبل تسجيل الخروج\n              </label>\n              <select\n                value={autoLogoutMinutes}\n                onChange={(e) => setAutoLogoutMinutes(Number(e.target.value))}\n                className=\"w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white\"\n                data-testid=\"select-auto-logout\"\n              >\n                <option value={0}>معطل - عدم تسجيل الخروج التلقائي</option>\n                <option value={5}>5 دقائق</option>\n                <option value={10}>10 دقائق</option>\n                <option value={15}>15 دقيقة</option>\n                <option value={30}>30 دقيقة</option>\n                <option value={60}>ساعة واحدة</option>\n                <option value={120}>ساعتان</option>\n              </select>\n              {autoLogoutMinutes > 0 && (\n                <p className=\"text-sm text-purple-700 mt-2\">\n                  ⏱️ سيتم تسجيل الخروج تلقائياً بعد {autoLogoutMinutes} دقيقة من عدم النشاط\n                </p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"bg-green-50 border-2 border-green-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <Lock className=\"text-green-600 flex-shrink-0 mt-1\" size={24} />\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-green-900 mb-2\">\n                  إعدادات تسجيل الدخول\n                </h3>\n                <p className=\"text-sm text-green-700 mb-4\">\n                  يمكنك تغيير اسم المستخدم وكلمة المرور من هنا\n                </p>\n\n                {!showPasswordSection ? (\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowPasswordSection(true)}\n                    className=\"flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors\"\n                  >\n                    <Key size={18} />\n                    تغيير بيانات الدخول\n                  </button>\n                ) : (\n                  <div className=\"space-y-4 bg-white rounded-lg p-4 border border-green-200\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        اسم المستخدم الجديد\n                      </label>\n                      <input\n                        type=\"text\"\n                        value={newUsername}\n                        onChange={(e) => setNewUsername(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أدخل اسم المستخدم الجديد\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        كلمة المرور الجديدة\n                      </label>\n                      <input\n                        type=\"password\"\n                        value={newPassword}\n                        onChange={(e) => setNewPassword(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أدخل كلمة المرور الجديدة\"\n                        required\n                      />\n                    </div>\n\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                        تأكيد كلمة المرور\n                      </label>\n                      <input\n                        type=\"password\"\n                        value={confirmPassword}\n                        onChange={(e) => setConfirmPassword(e.target.value)}\n                        className=\"w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500\"\n                        placeholder=\"أعد إدخال كلمة المرور\"\n                        required\n                      />\n                    </div>\n\n                    {passwordError && (\n                      <div className=\"bg-red-50 border border-red-200 rounded-lg p-3\">\n                        <p className=\"text-sm text-red-800\">{passwordError}</p>\n                      </div>\n                    )}\n\n                    <div className=\"flex gap-2\">\n                      <button\n                        type=\"button\"\n                        onClick={handleChangePassword}\n                        disabled={changePassword.isPending}\n                        className=\"flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold disabled:opacity-50\"\n                      >\n                        {changePassword.isPending ? 'جاري التغيير...' : 'حفظ التغييرات'}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setShowPasswordSection(false)\n                          setPasswordError('')\n                          setNewPassword('')\n                          setConfirmPassword('')\n                          setNewUsername('')\n                        }}\n                        className=\"px-4 py-2 border-2 border-gray-300 hover:border-gray-400 text-gray-700 rounded-lg font-semibold\"\n                      >\n                        إلغاء\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-red-50 border-2 border-red-200 rounded-lg p-6\">\n            <div className=\"flex items-start gap-3 mb-4\">\n              <AlertTriangle className=\"text-red-600 flex-shrink-0 mt-1\" size={24} />\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-red-900 mb-2\">\n                  تصفير قاعدة البيانات\n                </h3>\n                <p className=\"text-sm text-red-700 mb-4\">\n                  تحذير: سيتم حذف البيانات بشكل نهائي. هذا الإجراء لا يمكن التراجع عنه!\n                </p>\n                <p className=\"text-sm text-gray-700 mb-4\">\n                  استخدم هذا الخيار في نهاية العام الدراسي لتصفير النظام والبدء من جديد.\n                </p>\n              </div>\n            </div>\n\n            {!showResetConfirm ? (\n              <>\n                <div className=\"bg-white rounded-lg p-4 mb-4 space-y-3\">\n                  <p className=\"font-semibold text-gray-800 mb-3\">اختر البيانات المراد حذفها:</p>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.all}\n                      onChange={() => handleClearOptionChange('all')}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500\"\n                    />\n                    <span className=\"font-bold text-gray-900\">جميع البيانات</span>\n                  </label>\n                  \n                  <div className=\"border-t border-gray-200 my-2\"></div>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.students}\n                      onChange={() => handleClearOptionChange('students')}\n                      disabled={clearOptions.all}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 disabled:opacity-50\"\n                    />\n                    <span className={clearOptions.all ? 'text-gray-400' : 'text-gray-800'}>الطلاب</span>\n                  </label>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.teachers}\n                      onChange={() => handleClearOptionChange('teachers')}\n                      disabled={clearOptions.all}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 disabled:opacity-50\"\n                    />\n                    <span className={clearOptions.all ? 'text-gray-400' : 'text-gray-800'}>المعلمين</span>\n                  </label>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.specialStatuses}\n                      onChange={() => handleClearOptionChange('specialStatuses')}\n                      disabled={clearOptions.all}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 disabled:opacity-50\"\n                    />\n                    <span className={clearOptions.all ? 'text-gray-400' : 'text-gray-800'}>الحالات الخاصة</span>\n                  </label>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.visits}\n                      onChange={() => handleClearOptionChange('visits')}\n                      disabled={clearOptions.all}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 disabled:opacity-50\"\n                    />\n                    <span className={clearOptions.all ? 'text-gray-400' : 'text-gray-800'}>استقبال الطلاب</span>\n                  </label>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.permissions}\n                      onChange={() => handleClearOptionChange('permissions')}\n                      disabled={clearOptions.all}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 disabled:opacity-50\"\n                    />\n                    <span className={clearOptions.all ? 'text-gray-400' : 'text-gray-800'}>الاستئذانات</span>\n                  </label>\n                  \n                  <label className=\"flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition-colors\">\n                    <input\n                      type=\"checkbox\"\n                      checked={clearOptions.violations}\n                      onChange={() => handleClearOptionChange('violations')}\n                      disabled={clearOptions.all}\n                      className=\"w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500 disabled:opacity-50\"\n                    />\n                    <span className={clearOptions.all ? 'text-gray-400' : 'text-gray-800'}>المخالفات</span>\n                  </label>\n                </div>\n                \n                <button\n                  type=\"button\"\n                  onClick={() => setShowResetConfirm(true)}\n                  className=\"w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n                >\n                  <Trash2 size={20} />\n                  تصفير قاعدة البيانات\n                </button>\n              </>\n            ) : (\n              <div className=\"space-y-3\">\n                <div className=\"bg-yellow-100 border border-yellow-400 rounded-lg p-3\">\n                  <p className=\"text-sm font-bold text-yellow-900 text-center\">\n                    هل أنت متأكد من حذف البيانات المحددة؟\n                  </p>\n                </div>\n                <div className=\"flex gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={handleResetDatabase}\n                    disabled={clearDatabase.isPending}\n                    className=\"flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-3 rounded-lg transition-colors\"\n                  >\n                    {clearDatabase.isPending ? 'جاري الحذف...' : 'نعم، احذف البيانات المحددة'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowResetConfirm(false)}\n                    className=\"flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                  >\n                    إلغاء\n                  </button>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              type=\"submit\"\n              disabled={updateProfile.isPending}\n              className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Save size={20} />\n              {updateProfile.isPending ? 'جاري الحفظ...' : 'حفظ التعديلات'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":23432},"Erchad-1/client/src/App.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { useQuery, useMutation } from '@tanstack/react-query'\nimport { apiRequest, queryClient } from '@/lib/queryClient'\nimport { LoginPage } from './pages/LoginPage'\nimport { ProfileSettings } from './components/ProfileSettings'\nimport { formatPhoneForWhatsApp } from '@/lib/formatPhone'\nimport type { Student, SpecialStatus, TeacherProfile } from '@shared/schema'\nimport {\n  Home,\n  Users,\n  Heart,\n  AlertCircle,\n  UserCheck,\n  LogOut,\n  Settings,\n  GraduationCap,\n  Search,\n  User as UserIcon,\n  ChevronDown,\n  Download,\n  Upload,\n  List,\n  X,\n  Trash2,\n  Plus,\n  Star,\n  Clock,\n  AlertTriangle,\n  MoreVertical,\n  CheckCircle,\n  Printer,\n  Edit,\n  BookOpen,\n  Phone,\n  UserPlus,\n  Send,\n  PlusCircle,\n  UserSearch,\n  Calendar,\n  Lock,\n} from 'lucide-react'\n\ntype Page = 'home' | 'groups' | 'special-status' | 'absence' | 'reception' | 'permission' | 'teachers'\n\nfunction App() {\n  const [isLoggedIn, setIsLoggedIn] = useState(false)\n  const [currentPage, setCurrentPage] = useState<Page>('home')\n  const [searchTerm, setSearchTerm] = useState('')\n  const [showSettingsMenu, setShowSettingsMenu] = useState(false)\n  const [showSpecialStatusModal, setShowSpecialStatusModal] = useState(false)\n  const [newStatusName, setNewStatusName] = useState('')\n  const [showGroupsModal, setShowGroupsModal] = useState(false)\n  const [newGroupName, setNewGroupName] = useState('')\n  const [newGroupStage, setNewGroupStage] = useState('')\n  \n  // تعديل المجموعة\n  const [showEditGroupModal, setShowEditGroupModal] = useState(false)\n  const [selectedGroup, setSelectedGroup] = useState<any | null>(null)\n  const [editGroupData, setEditGroupData] = useState({ name: '', stage: '' })\n  const [showListSettingsModal, setShowListSettingsModal] = useState(false)\n  const [showExcelImportModal, setShowExcelImportModal] = useState(false)\n  const [showProfileSettingsModal, setShowProfileSettingsModal] = useState(false)\n  const [showLoginSettingsModal, setShowLoginSettingsModal] = useState(false)\n  \n  // حقول إعدادات الملف الشخصي\n  const [teacherName, setTeacherName] = useState('')\n  const [schoolName, setSchoolName] = useState('')\n  const [teacherPhone, setTeacherPhone] = useState('')\n  const [systemDescription, setSystemDescription] = useState('')\n  const [openMenuStudentId, setOpenMenuStudentId] = useState<string | null>(null)\n  \n  // حقول إعدادات تسجيل الدخول\n  const [newUsername, setNewUsername] = useState('admin')\n  const [newPassword, setNewPassword] = useState('')\n  const [confirmPassword, setConfirmPassword] = useState('')\n  const [loginSettingsError, setLoginSettingsError] = useState('')\n  \n  // السماح بدخول الفصل\n  const [showAllowEntryModal, setShowAllowEntryModal] = useState(false)\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  \n  // تعديل الطالب\n  const [showEditStudentModal, setShowEditStudentModal] = useState(false)\n  const [selectedStage, setSelectedStage] = useState('')\n  const [editStudentData, setEditStudentData] = useState({\n    name: '',\n    nationalId: '',\n    phone: '',\n    guardianPhone: '',\n    grade: '',\n    groupId: '',\n    specialStatusId: '',\n  })\n  \n  // طباعة بيانات الطالب\n  const [showPrintModal, setShowPrintModal] = useState(false)\n  const [printStudent, setPrintStudent] = useState<Student | null>(null)\n  \n  // المعلمين\n  const [showAddTeacherModal, setShowAddTeacherModal] = useState(false)\n  const [showEditTeacherModal, setShowEditTeacherModal] = useState(false)\n  const [selectedTeacher, setSelectedTeacher] = useState<any | null>(null)\n  const [teacherFormData, setTeacherFormData] = useState({\n    name: '',\n    phone: '',\n    specialization: '',\n  })\n  \n  // حالة المجموعات (مفتوحة/مغلقة) - افتراضياً جميع المجموعات مفتوحة\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set())\n  \n  // صفحة المجموعات\n  const [showSpecialStatusColumn, setShowSpecialStatusColumn] = useState(false)\n  const [expandedGroupsPage, setExpandedGroupsPage] = useState<Set<string>>(new Set())\n  \n  // طباعة المجموعة\n  const [showGroupPrintModal, setShowGroupPrintModal] = useState(false)\n  const [selectedGroupForPrint, setSelectedGroupForPrint] = useState<any | null>(null)\n  \n  // إعدادات القوائم - ما يظهر في الصفحة الرئيسية\n  const [listSettings, setListSettings] = useState({\n    showGroups: true,\n    showSpecialStatus: true,\n    showReception: true,\n    showPermissions: true,\n    showViolations: true,\n    showTeachers: true,\n  })\n  \n  // إرسال للمعلم\n  const [showSendToTeacherModal, setShowSendToTeacherModal] = useState(false)\n  const [selectedTeacherForSend, setSelectedTeacherForSend] = useState('')\n  const [selectedStageForSend, setSelectedStageForSend] = useState('')\n  const [selectedGroupsForSend, setSelectedGroupsForSend] = useState<Set<string>>(new Set())\n  \n  // طباعة المجموعة - الحالات الخاصة\n  const [showSpecialStatusPrintModal, setShowSpecialStatusPrintModal] = useState(false)\n  const [selectedGroupForSpecialPrint, setSelectedGroupForSpecialPrint] = useState<any | null>(null)\n  \n  // تأكيد حذف المجموعة\n  const [showDeleteGroupConfirm, setShowDeleteGroupConfirm] = useState(false)\n  const [groupToDelete, setGroupToDelete] = useState<any | null>(null)\n  \n  // استقبال الطلاب\n  const [receptionSearchTerm, setReceptionSearchTerm] = useState('')\n  const [selectedStudentForReception, setSelectedStudentForReception] = useState<Student | null>(null)\n  const [visitReason, setVisitReason] = useState('')\n  const [actionTaken, setActionTaken] = useState('')\n  const [referredTo, setReferredTo] = useState('')\n  const [additionalNotes, setAdditionalNotes] = useState('')\n  const [showDateFilterModal, setShowDateFilterModal] = useState(false)\n  const [filterDate, setFilterDate] = useState('')\n  const [dateFilterError, setDateFilterError] = useState('')\n  const [selectedStudentFilter, setSelectedStudentFilter] = useState<Student | null>(null)\n  const [studentSearchTerm, setStudentSearchTerm] = useState('')\n  \n  // الاستئذان\n  const [permissionSearchTerm, setPermissionSearchTerm] = useState('')\n  const [selectedStudentForPermission, setSelectedStudentForPermission] = useState<Student | null>(null)\n  const [permissionReason, setPermissionReason] = useState('')\n  const [permissionNotes, setPermissionNotes] = useState('')\n  const [showPermissionDateFilter, setShowPermissionDateFilter] = useState(false)\n  const [permissionFilterDate, setPermissionFilterDate] = useState('')\n  const [permissionDateFilterError, setPermissionDateFilterError] = useState('')\n  const [selectedPermissionStudentFilter, setSelectedPermissionStudentFilter] = useState<Student | null>(null)\n  const [permissionStudentSearchTerm, setPermissionStudentSearchTerm] = useState('')\n  \n  // المخالفات\n  const [violationSearchTerm, setViolationSearchTerm] = useState('')\n  const [selectedStudentForViolation, setSelectedStudentForViolation] = useState<Student | null>(null)\n  const [violationType, setViolationType] = useState('')\n  const [violationDescription, setViolationDescription] = useState('')\n  const [violationAction, setViolationAction] = useState('')\n  const [violationNotes, setViolationNotes] = useState('')\n  const [showViolationDateFilter, setShowViolationDateFilter] = useState(false)\n  const [violationFilterDate, setViolationFilterDate] = useState('')\n  \n  // فلاتر الصفحة الرئيسية\n  const [homeSpecialStatusFilter, setHomeSpecialStatusFilter] = useState<string>('all')\n  const [homeStageFilter, setHomeStageFilter] = useState<string>('all')\n  const [homeGroupFilter, setHomeGroupFilter] = useState<string>('all')\n  const [violationDateFilterError, setViolationDateFilterError] = useState('')\n  const [selectedViolationStudentFilter, setSelectedViolationStudentFilter] = useState<Student | null>(null)\n  const [violationStudentSearchTerm, setViolationStudentSearchTerm] = useState('')\n  \n  // أخطاء التحقق\n  const [permissionError, setPermissionError] = useState('')\n  const [violationError, setViolationError] = useState('')\n\n  // جلب البيانات من API\n  const { data: students = [], isLoading: studentsLoading } = useQuery<Student[]>({\n    queryKey: ['/api/students'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: groups = [] } = useQuery<any[]>({\n    queryKey: ['/api/groups'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: specialStatuses = [], isLoading: statusesLoading } = useQuery<SpecialStatus[]>({\n    queryKey: ['/api/special-statuses'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: profile, isLoading: profileLoading } = useQuery<TeacherProfile>({\n    queryKey: ['/api/teacher-profile'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: teachers = [] } = useQuery<any[]>({\n    queryKey: ['/api/teachers'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: studentVisits = [] } = useQuery<any[]>({\n    queryKey: ['/api/student-visits'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: studentPermissions = [], isLoading: isLoadingPermissions } = useQuery<any[]>({\n    queryKey: ['/api/student-permissions'],\n    enabled: isLoggedIn,\n  })\n\n  const { data: studentViolations = [], isLoading: isLoadingViolations } = useQuery<any[]>({\n    queryKey: ['/api/student-violations'],\n    enabled: isLoggedIn,\n  })\n\n  // إضافة حالة خاصة جديدة\n  const addSpecialStatus = useMutation({\n    mutationFn: (name: string) => apiRequest('/api/special-statuses', 'POST', { name }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/special-statuses'] })\n      setNewStatusName('')\n    },\n  })\n\n  // حذف حالة خاصة\n  const deleteSpecialStatus = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/special-statuses/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/special-statuses'] })\n    },\n  })\n\n  // إضافة مجموعة جديدة\n  const addGroup = useMutation({\n    mutationFn: (data: { name: string; stage: string }) => \n      apiRequest('/api/groups', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] })\n      setNewGroupName('')\n      setNewGroupStage('')\n    },\n  })\n\n  // تحديث مجموعة\n  const updateGroup = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: { name: string; stage: string } }) =>\n      apiRequest(`/api/groups/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] })\n      setShowEditGroupModal(false)\n      setSelectedGroup(null)\n    },\n  })\n\n  // حذف مجموعة\n  const deleteGroup = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/groups/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] })\n    },\n  })\n\n  useEffect(() => {\n    const loggedIn = localStorage.getItem('isLoggedIn') === 'true'\n    setIsLoggedIn(loggedIn)\n    \n    // تحميل إعدادات القوائم من localStorage\n    const savedSettings = localStorage.getItem('listSettings')\n    if (savedSettings) {\n      setListSettings(JSON.parse(savedSettings))\n    }\n  }, [])\n\n  // تحميل بيانات الملف الشخصي في الحقول عند فتح النافذة\n  useEffect(() => {\n    if (showProfileSettingsModal && profile) {\n      setTeacherName(profile.logoUrl || '')\n      setSchoolName(profile.schoolName || '')\n      setTeacherPhone('')\n      setSystemDescription(profile.name || '')\n    }\n  }, [showProfileSettingsModal, profile])\n  \n  // حفظ إعدادات القوائم عند التغيير\n  const updateListSettings = (newSettings: typeof listSettings) => {\n    setListSettings(newSettings)\n    localStorage.setItem('listSettings', JSON.stringify(newSettings))\n  }\n\n  // تحديث معلومات الملف الشخصي\n  const updateProfile = useMutation({\n    mutationFn: (data: { name?: string; phone?: string; schoolName?: string; logoUrl?: string }) => \n      apiRequest('/api/teacher-profile', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teacher-profile'] })\n    },\n  })\n\n  // تصفير قاعدة البيانات\n  const clearDatabase = useMutation({\n    mutationFn: () => apiRequest('/api/clear-database', 'POST'),\n    onSuccess: () => {\n      queryClient.invalidateQueries()\n    },\n  })\n\n  // إضافة طالب جديد\n  const createStudent = useMutation({\n    mutationFn: (data: any) => apiRequest('/api/students', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setShowEditStudentModal(false)\n      setSelectedStudent(null)\n    },\n  })\n\n  // تحديث بيانات الطالب\n  const updateStudent = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(`/api/students/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setShowEditStudentModal(false)\n      setSelectedStudent(null)\n    },\n  })\n\n  // حذف طالب\n  const deleteStudent = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/students/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n    },\n  })\n\n  // إضافة معلم\n  const addTeacher = useMutation({\n    mutationFn: (data: any) => apiRequest('/api/teachers', 'POST', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teachers'] })\n      setShowAddTeacherModal(false)\n      setTeacherFormData({ name: '', phone: '', specialization: '' })\n    },\n  })\n\n  // تحديث معلم\n  const updateTeacher = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: any }) => \n      apiRequest(`/api/teachers/${id}`, 'PATCH', data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teachers'] })\n      setShowEditTeacherModal(false)\n      setSelectedTeacher(null)\n    },\n  })\n\n  // حذف معلم\n  const deleteTeacher = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/teachers/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/teachers'] })\n    },\n  })\n\n  // إضافة زيارة طالب\n  const addStudentVisit = useMutation({\n    mutationFn: (visitData: any) => apiRequest('/api/student-visits', 'POST', visitData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-visits'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      // إعادة تعيين النموذج\n      setSelectedStudentForReception(null)\n      setVisitReason('')\n      setActionTaken('')\n      setReferredTo('')\n      setAdditionalNotes('')\n    },\n  })\n\n  // إضافة استئذان طالب\n  const addStudentPermission = useMutation({\n    mutationFn: (permissionData: any) => apiRequest('/api/student-permissions', 'POST', permissionData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-permissions'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setSelectedStudentForPermission(null)\n      setPermissionReason('')\n      setPermissionNotes('')\n      setPermissionError('')\n    },\n    onError: (error: any) => {\n      setPermissionError(error.message || 'حدث خطأ أثناء حفظ الاستئذان')\n    },\n  })\n\n  // إضافة مخالفة طالب\n  const addStudentViolation = useMutation({\n    mutationFn: (violationData: any) => apiRequest('/api/student-violations', 'POST', violationData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-violations'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n      setSelectedStudentForViolation(null)\n      setViolationType('')\n      setViolationDescription('')\n      setViolationAction('')\n      setViolationNotes('')\n      setViolationError('')\n    },\n    onError: (error: any) => {\n      setViolationError(error.message || 'حدث خطأ أثناء حفظ المخالفة')\n    },\n  })\n\n  // حذف زيارة طالب\n  const deleteStudentVisit = useMutation({\n    mutationFn: (id: string) => apiRequest(`/api/student-visits/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/student-visits'] })\n      queryClient.invalidateQueries({ queryKey: ['/api/students'] })\n    },\n  })\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      const target = event.target as HTMLElement\n      if (showSettingsMenu && !target.closest('.settings-menu-container')) {\n        setShowSettingsMenu(false)\n      }\n    }\n\n    document.addEventListener('mousedown', handleClickOutside)\n    return () => document.removeEventListener('mousedown', handleClickOutside)\n  }, [showSettingsMenu])\n\n  // المجموعات في الصفحة الرئيسية تبدأ مخفية (مطوية)\n\n  // فتح جميع المجموعات في صفحة المجموعات\n  useEffect(() => {\n    if (groups.length > 0 && expandedGroupsPage.size === 0) {\n      const allGroupIds = new Set(groups.map(g => g.id))\n      setExpandedGroupsPage(allGroupIds)\n    }\n  }, [groups.length])\n\n  const handleLogout = () => {\n    localStorage.removeItem('isLoggedIn')\n    localStorage.removeItem('userId')\n    setIsLoggedIn(false)\n    setCurrentPage('home')\n  }\n\n  const handleLogin = () => {\n    setIsLoggedIn(true)\n  }\n\n  // تسجيل الخروج التلقائي - مراقبة نشاط المستخدم\n  useEffect(() => {\n    if (!isLoggedIn) return\n\n    const autoLogoutMinutes = profile?.autoLogoutMinutes || 0\n\n    // إذا كانت الميزة معطلة، لا نفعل شيء\n    if (autoLogoutMinutes === 0) return\n\n    let logoutTimer: ReturnType<typeof setTimeout> | null = null\n    let isActive = true\n\n    const resetTimer = () => {\n      if (!isActive) return\n      if (logoutTimer) clearTimeout(logoutTimer)\n\n      logoutTimer = setTimeout(() => {\n        if (!isActive) return\n        handleLogout()\n        alert(`تم تسجيل الخروج تلقائياً بعد ${autoLogoutMinutes} دقيقة من عدم النشاط`)\n      }, autoLogoutMinutes * 60 * 1000)\n    }\n\n    // مراقبة نشاط المستخدم\n    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click']\n    events.forEach(event => {\n      document.addEventListener(event, resetTimer, true)\n    })\n\n    // بدء المؤقت\n    resetTimer()\n\n    // تنظيف عند unmount\n    return () => {\n      isActive = false\n      if (logoutTimer) clearTimeout(logoutTimer)\n      events.forEach(event => {\n        document.removeEventListener(event, resetTimer, true)\n      })\n    }\n  }, [isLoggedIn, profile?.autoLogoutMinutes])\n\n  if (!isLoggedIn) {\n    return <LoginPage onLogin={handleLogin} />\n  }\n\n  // حالة التحميل\n  if (studentsLoading || statusesLoading || profileLoading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50 flex items-center justify-center\" dir=\"rtl\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4\"></div>\n          <p className=\"text-xl text-gray-600 font-semibold\">جاري التحميل...</p>\n        </div>\n      </div>\n    )\n  }\n\n  // تصفية الطلاب بناءً على البحث والفلاتر\n  const filteredStudents = students.filter(student => {\n    // فلتر البحث\n    if (searchTerm.trim()) {\n      const search = searchTerm.toLowerCase()\n      const matchesSearch = (\n        student.name.toLowerCase().includes(search) ||\n        student.nationalId.includes(search) ||\n        (student.phone && student.phone.includes(search)) ||\n        (student.guardianPhone && student.guardianPhone.includes(search))\n      )\n      if (!matchesSearch) return false\n    }\n    \n    // فلتر الحالة الخاصة\n    if (homeSpecialStatusFilter !== 'all') {\n      if (student.specialStatusId !== homeSpecialStatusFilter) return false\n    }\n    \n    // فلتر المرحلة الدراسية\n    if (homeStageFilter !== 'all') {\n      const studentGroup = groups.find(g => g.id === student.groupId)\n      if (!studentGroup || studentGroup.stage !== homeStageFilter) return false\n    }\n    \n    // فلتر المجموعة\n    if (homeGroupFilter !== 'all') {\n      if (student.groupId !== homeGroupFilter) return false\n    }\n    \n    return true\n  })\n\n  const totalStudents = students.length\n  const totalTeachers = teachers.length\n  const permissions = students.filter(s => s.status === 'استئذان').length\n  const specialStatusCount = students.filter(s => s.specialStatusId !== null).length\n\n  const allNavItems = [\n    { id: 'home' as Page, label: 'الصفحة الرئيسية', icon: Home, alwaysShow: true },\n    { id: 'teachers' as Page, label: 'المعلمين', icon: GraduationCap, settingKey: 'showTeachers' },\n    { id: 'groups' as Page, label: 'المجموعات', icon: Users, settingKey: 'showGroups' },\n    { id: 'special-status' as Page, label: 'الحالات الخاصة', icon: Heart, settingKey: 'showSpecialStatus' },\n    { id: 'reception' as Page, label: 'استقبال الطلاب', icon: UserCheck, settingKey: 'showReception' },\n    { id: 'permission' as Page, label: 'الاستئذان', icon: LogOut, settingKey: 'showPermissions' },\n    { id: 'absence' as Page, label: 'المخالفات', icon: AlertCircle, settingKey: 'showViolations' },\n  ]\n\n  // تصفية القوائم بناءً على الإعدادات\n  const navItems = allNavItems.filter(item => {\n    if (item.alwaysShow) return true\n    if (!item.settingKey) return true\n    return listSettings[item.settingKey as keyof typeof listSettings]\n  })\n\n  // تنظيم الطلاب حسب المجموعات\n  const studentsByGroup = filteredStudents.reduce((acc, student) => {\n    const groupId = student.groupId || 'unassigned'\n    if (!acc[groupId]) {\n      acc[groupId] = []\n    }\n    acc[groupId].push(student)\n    return acc\n  }, {} as Record<string, Student[]>)\n\n  // ألوان المجموعات (6 ألوان متناوبة)\n  const groupColors = [\n    { bg: 'from-emerald-500 to-teal-600', light: 'bg-emerald-50', border: 'border-emerald-200' },\n    { bg: 'from-blue-500 to-cyan-600', light: 'bg-blue-50', border: 'border-blue-200' },\n    { bg: 'from-purple-500 to-pink-600', light: 'bg-purple-50', border: 'border-purple-200' },\n    { bg: 'from-orange-500 to-amber-600', light: 'bg-orange-50', border: 'border-orange-200' },\n    { bg: 'from-red-500 to-rose-600', light: 'bg-red-50', border: 'border-red-200' },\n    { bg: 'from-indigo-500 to-blue-600', light: 'bg-indigo-50', border: 'border-indigo-200' },\n  ]\n\n  // دالة toggle للمجموعة\n  const toggleGroup = (groupId: string) => {\n    const newExpanded = new Set(expandedGroups)\n    if (newExpanded.has(groupId)) {\n      newExpanded.delete(groupId)\n    } else {\n      newExpanded.add(groupId)\n    }\n    setExpandedGroups(newExpanded)\n  }\n\n  // دالة toggle للمجموعة في صفحة المجموعات\n  const toggleGroupPage = (groupId: string) => {\n    const newExpanded = new Set(expandedGroupsPage)\n    if (newExpanded.has(groupId)) {\n      newExpanded.delete(groupId)\n    } else {\n      newExpanded.add(groupId)\n    }\n    setExpandedGroupsPage(newExpanded)\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-green-50\" dir=\"rtl\">\n      {/* Header */}\n      <header className=\"bg-white shadow-lg border-b-4 border-blue-600\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"bg-gradient-to-br from-blue-600 to-blue-700 p-3 rounded-2xl shadow-lg\">\n                <Users className=\"text-white\" size={32} />\n              </div>\n              <div>\n                <h1 className=\"text-3xl font-bold text-gray-900\">\n                  {profile?.schoolName || 'نظام إدارة شاملة لبيانات الطلاب'}\n                </h1>\n                <p className=\"text-base text-gray-600 mt-1 font-medium\">\n                  {profile?.logoUrl || 'قم بإضافة عنوان الواجهة من الإعدادات'}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative settings-menu-container\">\n                <button\n                  onClick={() => setShowSettingsMenu(!showSettingsMenu)}\n                  className=\"flex items-center gap-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition-all hover:shadow-xl hover:scale-105\"\n                  data-testid=\"button-settings\"\n                >\n                  <Settings size={20} />\n                  <span>الإعدادات</span>\n                </button>\n\n                {showSettingsMenu && (\n                  <div className=\"absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-200 py-2 z-50\">\n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowExcelImportModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-green-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-import-excel\"\n                    >\n                      <Download size={18} className=\"text-green-600\" />\n                      <span className=\"font-semibold text-gray-700\">استيراد من Excel</span>\n                    </button>\n                    \n                    <button\n                      onClick={async () => {\n                        setShowSettingsMenu(false)\n                        try {\n                          // جلب جميع البيانات\n                          const [studentsData, groupsData, teachersData, visitsData, permissionsData, violationsData, profileData] = await Promise.all([\n                            fetch('/api/students').then(r => r.json()),\n                            fetch('/api/groups').then(r => r.json()),\n                            fetch('/api/teachers').then(r => r.json()),\n                            fetch('/api/student-visits').then(r => r.json()),\n                            fetch('/api/student-permissions').then(r => r.json()),\n                            fetch('/api/student-violations').then(r => r.json()),\n                            fetch('/api/teacher-profile').then(r => r.json())\n                          ])\n                          \n                          const exportData = {\n                            version: '1.0',\n                            exportDate: new Date().toISOString(),\n                            data: {\n                              students: studentsData,\n                              groups: groupsData,\n                              teachers: teachersData,\n                              visits: visitsData,\n                              permissions: permissionsData,\n                              violations: violationsData,\n                              profile: profileData\n                            }\n                          }\n                          \n                          // تحويل البيانات لـ JSON\n                          const jsonStr = JSON.stringify(exportData, null, 2)\n                          const blob = new Blob([jsonStr], { type: 'application/json' })\n                          const url = URL.createObjectURL(blob)\n                          \n                          // تحميل الملف\n                          const a = document.createElement('a')\n                          a.href = url\n                          a.download = `erchad-backup-${new Date().toISOString().split('T')[0]}.json`\n                          document.body.appendChild(a)\n                          a.click()\n                          document.body.removeChild(a)\n                          URL.revokeObjectURL(url)\n                          \n                          alert('✅ تم تصدير البيانات بنجاح!')\n                        } catch (error) {\n                          console.error('Error exporting data:', error)\n                          alert('❌ حدث خطأ أثناء تصدير البيانات')\n                        }\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-purple-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-export-data\"\n                    >\n                      <Download size={18} className=\"text-purple-600\" />\n                      <span className=\"font-semibold text-gray-700\">تصدير البيانات الكاملة</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        document.getElementById('import-data-file')?.click()\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-indigo-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-import-data\"\n                    >\n                      <Upload size={18} className=\"text-indigo-600\" />\n                      <span className=\"font-semibold text-gray-700\">استيراد البيانات الكاملة</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowGroupsModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-manage-groups\"\n                    >\n                      <Users size={18} className=\"text-blue-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة المجموعات</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowSpecialStatusModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-pink-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-manage-special-status\"\n                    >\n                      <Heart size={18} className=\"text-pink-600\" />\n                      <span className=\"font-semibold text-gray-700\">إدارة الحالات الخاصة</span>\n                    </button>\n\n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowListSettingsModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-purple-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-list-settings\"\n                    >\n                      <List size={18} className=\"text-purple-600\" />\n                      <span className=\"font-semibold text-gray-700\">إعدادات القوائم</span>\n                    </button>\n                    \n                    <button\n                      onClick={() => {\n                        setShowSettingsMenu(false)\n                        setShowLoginSettingsModal(true)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-green-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-login-settings\"\n                    >\n                      <Lock size={18} className=\"text-green-600\" />\n                      <span className=\"font-semibold text-gray-700\">إعدادات تسجيل الدخول</span>\n                    </button>\n                    \n                    <div className=\"border-t border-gray-200 my-2\"></div>\n                    \n                    <button\n                      onClick={() => {\n                        handleLogout()\n                        setShowSettingsMenu(false)\n                      }}\n                      className=\"w-full text-right px-4 py-3 hover:bg-red-50 transition-colors flex items-center gap-3\"\n                      data-testid=\"button-logout\"\n                    >\n                      <LogOut size={18} className=\"text-red-600\" />\n                      <span className=\"font-semibold text-red-600\">تسجيل الخروج</span>\n                    </button>\n                  </div>\n                )}\n              </div>\n\n              <button\n                onClick={() => setShowProfileSettingsModal(true)}\n                className=\"flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 px-4 py-3 rounded-xl font-bold shadow-lg border-2 border-gray-200 transition-all hover:shadow-xl\"\n                data-testid=\"button-profile\"\n              >\n                <div className=\"bg-gradient-to-br from-blue-500 to-blue-600 p-2 rounded-lg\">\n                  <UserIcon className=\"text-white\" size={20} />\n                </div>\n                {profile?.name ? (\n                  <span className=\"text-sm\">{profile.name}</span>\n                ) : (\n                  <span className=\"text-sm\">الملف الشخصي</span>\n                )}\n              </button>\n            </div>\n          </div>\n\n          {/* Stats Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mt-6\">\n            <div className=\"bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-total-students\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-blue-100 text-sm\">إجمالي الطلاب</p>\n                  <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-total-students\">{totalStudents}</p>\n                </div>\n                <Users size={40} className=\"text-blue-200\" />\n              </div>\n            </div>\n\n            <div className=\"bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-total-teachers\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-green-100 text-sm\">المعلمين</p>\n                  <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-total-teachers\">{totalTeachers}</p>\n                </div>\n                <GraduationCap size={40} className=\"text-green-200\" />\n              </div>\n            </div>\n\n            <div className=\"bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-permissions\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-orange-100 text-sm\">استئذانات</p>\n                  <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-permissions\">{permissions}</p>\n                </div>\n                <LogOut size={40} className=\"text-orange-200\" />\n              </div>\n            </div>\n\n            <div className=\"bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white shadow-lg\" data-testid=\"card-special-status\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-purple-100 text-sm\">حالات خاصة</p>\n                  <p className=\"text-3xl font-bold mt-1\" data-testid=\"text-special-status\">{specialStatusCount}</p>\n                </div>\n                <Heart size={40} className=\"text-purple-200\" />\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Navigation Tabs */}\n      <div className=\"bg-white border-b border-gray-200 shadow-sm\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex gap-1 overflow-x-auto\">\n            {navItems.map((item) => {\n              const Icon = item.icon\n              const isActive = currentPage === item.id\n              return (\n                <button\n                  key={item.id}\n                  onClick={() => setCurrentPage(item.id)}\n                  className={`flex items-center gap-2 px-6 py-4 font-bold transition-all whitespace-nowrap ${\n                    isActive\n                      ? 'text-blue-600 border-b-4 border-blue-600 bg-blue-50'\n                      : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'\n                  }`}\n                  data-testid={`nav-${item.id}`}\n                >\n                  <Icon size={20} />\n                  <span>{item.label}</span>\n                </button>\n              )\n            })}\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* صفحة المعلمين */}\n        {currentPage === 'teachers' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-6 shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n                    <GraduationCap className=\"text-white\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-white\">المعلمين</h2>\n                    <p className=\"text-blue-100 mt-1\">إجمالي المعلمين: {teachers.length}</p>\n                  </div>\n                </div>\n                <button\n                  onClick={() => setShowAddTeacherModal(true)}\n                  className=\"bg-white text-blue-600 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-50 transition-all shadow-md hover:shadow-lg\"\n                  data-testid=\"button-add-teacher\"\n                >\n                  <Plus size={20} />\n                  <span>إضافة معلم</span>\n                </button>\n              </div>\n            </div>\n\n            {/* قائمة المعلمين */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {teachers.map((teacher) => (\n                <div key={teacher.id} className=\"bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow\">\n                  {/* اسم المعلم */}\n                  <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 p-4 text-center\">\n                    <h3 className=\"text-2xl font-bold text-white\">{teacher.name}</h3>\n                  </div>\n\n                  {/* المعلومات */}\n                  <div className=\"p-4 space-y-3\">\n                    {/* الفصل الدراسي (التخصص) */}\n                    <div className=\"flex items-center gap-3 text-gray-700\">\n                      <BookOpen size={20} className=\"text-blue-600\" />\n                      <div>\n                        <p className=\"text-sm text-gray-500\">الفصل الدراسي</p>\n                        <p className=\"font-semibold\">{teacher.specialization || 'غير محدد'}</p>\n                      </div>\n                    </div>\n\n                    {/* رقم الجوال */}\n                    <div className=\"flex items-center gap-3 text-gray-700\">\n                      <Phone size={20} className=\"text-blue-600\" />\n                      <div>\n                        <p className=\"text-sm text-gray-500\">رقم الجوال</p>\n                        <p className=\"font-semibold\" dir=\"ltr\">{teacher.phone || 'غير محدد'}</p>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* الأزرار */}\n                  <div className=\"p-4 pt-0 flex gap-2\">\n                    <button\n                      onClick={() => {\n                        setSelectedTeacher(teacher)\n                        setTeacherFormData({\n                          name: teacher.name,\n                          phone: teacher.phone || '',\n                          specialization: teacher.specialization || '',\n                        })\n                        setShowEditTeacherModal(true)\n                      }}\n                      className=\"flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg font-semibold hover:bg-blue-100 transition-colors flex items-center justify-center gap-2\"\n                      data-testid={`button-edit-teacher-${teacher.id}`}\n                    >\n                      <Edit size={18} />\n                      <span>تعديل</span>\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (window.confirm(`هل أنت متأكد من حذف المعلم ${teacher.name}؟`)) {\n                          deleteTeacher.mutate(teacher.id)\n                        }\n                      }}\n                      disabled={deleteTeacher.isPending}\n                      className=\"flex-1 bg-red-50 text-red-600 py-2 rounded-lg font-semibold hover:bg-red-100 transition-colors flex items-center justify-center gap-2 disabled:opacity-50\"\n                      data-testid={`button-delete-teacher-${teacher.id}`}\n                    >\n                      <Trash2 size={18} />\n                      <span>{deleteTeacher.isPending ? 'جاري...' : 'حذف'}</span>\n                    </button>\n                  </div>\n                </div>\n              ))}\n            </div>\n\n            {/* حالة فارغة */}\n            {teachers.length === 0 && (\n              <div className=\"text-center py-16\">\n                <GraduationCap size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                <p className=\"text-xl text-gray-500 font-semibold\">لا يوجد معلمين</p>\n                <p className=\"text-gray-400 mt-2\">ابدأ بإضافة معلم جديد</p>\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* صفحة الحالات الخاصة */}\n        {currentPage === 'special-status' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 shadow-lg\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n                    <Heart className=\"text-white\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-white\">الحالات الخاصة</h2>\n                    <p className=\"text-purple-100 mt-1\">إجمالي الطلاب ذوي الحالات الخاصة: {specialStatusCount}</p>\n                  </div>\n                </div>\n                <div className=\"flex gap-3\">\n                  <div className=\"flex items-center gap-2 bg-white bg-opacity-20 px-4 py-2 rounded-lg\">\n                    <input\n                      type=\"checkbox\"\n                      id=\"show-special-status-details\"\n                      checked={showSpecialStatusColumn}\n                      onChange={(e) => setShowSpecialStatusColumn(e.target.checked)}\n                      className=\"w-5 h-5\"\n                      data-testid=\"checkbox-show-special-status-details\"\n                    />\n                    <label htmlFor=\"show-special-status-details\" className=\"text-white font-semibold cursor-pointer whitespace-nowrap\">\n                      إظهار تفاصيل الحالة\n                    </label>\n                  </div>\n                  <button\n                    onClick={() => window.print()}\n                    className=\"bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-50 transition-all shadow-md\"\n                    data-testid=\"button-print-all-special\"\n                  >\n                    <Printer size={20} />\n                    <span>طباعة الكل</span>\n                  </button>\n                  <button\n                    onClick={() => setShowSendToTeacherModal(true)}\n                    className=\"bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-50 transition-all shadow-md\"\n                    data-testid=\"button-send-to-teacher\"\n                  >\n                    <Send size={20} />\n                    <span>إرسال للمعلم</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* قائمة المجموعات */}\n            <div className=\"space-y-4\">\n              {groups\n                .filter(group => {\n                  // عرض فقط المجموعات التي تحتوي على طلاب لديهم حالات خاصة\n                  const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                  return groupStudents.length > 0\n                })\n                .map((group) => {\n                  const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                  \n                  return (\n                    <div key={group.id} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                      {/* رأس المجموعة */}\n                      <div className=\"bg-gradient-to-r from-purple-500 to-purple-600 p-4 flex items-center justify-between text-white\">\n                        <div className=\"text-left\">\n                          <h3 className=\"text-2xl font-bold\">\n                            {group.stage} - {group.name}\n                          </h3>\n                          <p className=\"text-purple-100 mt-1\">عدد الطلاب: {groupStudents.length}</p>\n                        </div>\n                        <button\n                          onClick={() => {\n                            setSelectedGroupForSpecialPrint(group)\n                            setShowSpecialStatusPrintModal(true)\n                          }}\n                          className=\"bg-white text-purple-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-50 transition-all\"\n                          data-testid={`button-print-group-${group.id}`}\n                        >\n                          <Printer size={18} />\n                          <span>طباعة</span>\n                        </button>\n                      </div>\n\n                      {/* جدول الطلاب */}\n                      <div className=\"overflow-x-auto\">\n                        <table className=\"w-full\">\n                          <thead className=\"bg-purple-50\">\n                            <tr>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">الاسم</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">السجل المدني</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">جوال الطالب</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">جوال ولي الأمر</th>\n                              <th className=\"px-6 py-4 text-right text-sm font-bold text-purple-900\">الحالة الخاصة</th>\n                            </tr>\n                          </thead>\n                          <tbody className=\"divide-y divide-gray-200\">\n                            {groupStudents.map((student) => {\n                              const specialStatus = specialStatuses.find(s => s.id === student.specialStatusId)\n                              return (\n                                <tr key={student.id} className=\"hover:bg-gray-50\">\n                                  <td className=\"px-6 py-4 text-right font-semibold text-gray-900\">{student.name}</td>\n                                  <td className=\"px-6 py-4 text-right text-gray-700\">{student.nationalId}</td>\n                                  <td className=\"px-6 py-4 text-right text-gray-700\" dir=\"ltr\">{student.phone || '-'}</td>\n                                  <td className=\"px-6 py-4 text-right text-gray-700\" dir=\"ltr\">{student.guardianPhone || '-'}</td>\n                                  <td className=\"px-6 py-4 text-right\">\n                                    <span className=\"bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold inline-block\">\n                                      {showSpecialStatusColumn ? (specialStatus?.name || 'غير محدد') : 'لديه حالة خاصة'}\n                                    </span>\n                                  </td>\n                                </tr>\n                              )\n                            })}\n                          </tbody>\n                        </table>\n                      </div>\n                    </div>\n                  )\n                })}\n\n              {/* حالة فارغة */}\n              {students.filter(s => s.specialStatusId).length === 0 && (\n                <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n                  <Heart size={64} className=\"mx-auto text-purple-300 mb-4\" />\n                  <p className=\"text-xl text-gray-500 font-semibold\">لا يوجد طلاب ذوي حالات خاصة</p>\n                  <p className=\"text-gray-400 mt-2\">يمكنك إضافة حالات خاصة من تعديل بيانات الطالب</p>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* صفحة المجموعات */}\n        {currentPage === 'groups' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"show-special-status\"\n                    checked={showSpecialStatusColumn}\n                    onChange={(e) => setShowSpecialStatusColumn(e.target.checked)}\n                    className=\"w-5 h-5 text-purple-600 border-purple-300 rounded focus:ring-purple-500\"\n                    data-testid=\"checkbox-show-special-status\"\n                  />\n                  <label htmlFor=\"show-special-status\" className=\"text-purple-600 font-semibold cursor-pointer\">\n                    إظهار تفاصيل الحالة\n                  </label>\n                </div>\n\n                <div className=\"flex gap-3\">\n                  <button\n                    onClick={() => {\n                      setEditStudentData({\n                        name: '',\n                        nationalId: '',\n                        phone: '',\n                        guardianPhone: '',\n                        grade: '',\n                        groupId: '',\n                        specialStatusId: '',\n                      })\n                      setSelectedStage('')\n                      setSelectedStudent(null)\n                      setShowEditStudentModal(true)\n                    }}\n                    className=\"bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg\"\n                    data-testid=\"button-add-student-page\"\n                  >\n                    <UserPlus size={20} />\n                    <span>إضافة طالب</span>\n                  </button>\n                  <button\n                    onClick={() => setShowGroupsModal(true)}\n                    className=\"bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg\"\n                    data-testid=\"button-manage-groups-page\"\n                  >\n                    <Users size={20} />\n                    <span>إدارة المجموعات</span>\n                  </button>\n                  <button\n                    onClick={() => window.print()}\n                    className=\"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg\"\n                    data-testid=\"button-print-all\"\n                  >\n                    <Printer size={20} />\n                    <span>طباعة الكل</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* قائمة المجموعات */}\n            <div className=\"space-y-4\">\n              {groups.length === 0 ? (\n                <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n                  <Users size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                  <p className=\"text-xl text-gray-500 font-semibold\">لا توجد مجموعات</p>\n                  <p className=\"text-gray-400 mt-2\">قم بإضافة مجموعات من الإعدادات</p>\n                </div>\n              ) : (\n                groups.map((group, groupIndex) => {\n                  const groupStudents = students.filter(s => s.groupId === group.id)\n                  const colorIndex = groupIndex % groupColors.length\n                  const colors = groupColors[colorIndex]\n                  const isExpanded = expandedGroupsPage.has(group.id)\n\n                  return (\n                    <div key={group.id} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                      {/* رأس المجموعة */}\n                      <div className={`bg-gradient-to-r ${colors.bg} p-4 flex items-center justify-between text-white`}>\n                        <button\n                          onClick={() => toggleGroupPage(group.id)}\n                          className=\"flex items-center gap-3 hover:opacity-90 transition-opacity\"\n                          data-testid={`button-toggle-group-page-${group.id}`}\n                        >\n                          <ChevronDown \n                            size={24} \n                            className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n                          />\n                          <h3 className=\"text-2xl font-bold\">\n                            {group.stage} - {group.name}\n                          </h3>\n                          <span className=\"bg-white bg-opacity-30 px-3 py-1 rounded-full text-sm font-semibold\">\n                            {groupStudents.length} طالب\n                          </span>\n                        </button>\n                      </div>\n\n                      {/* جدول الطلاب */}\n                      {isExpanded && (\n                        <div>\n                          {/* أزرار الإجراءات */}\n                          <div className=\"bg-gradient-to-r from-cyan-400 to-blue-500 p-3 flex gap-2 justify-end\">\n                            <button\n                              onClick={() => {\n                                setSelectedGroupForPrint(group)\n                                setShowGroupPrintModal(true)\n                              }}\n                              className=\"bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors flex items-center gap-2\"\n                              data-testid={`button-print-group-${group.id}`}\n                            >\n                              <Printer size={18} />\n                              <span>طباعة</span>\n                            </button>\n                          </div>\n\n                          {/* الجدول */}\n                          <div className=\"overflow-x-auto\">\n                            <table className=\"w-full\">\n                              <thead className=\"bg-gray-50\">\n                                <tr>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الاسم</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">السجل المدني</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال الطالب</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال ولي الأمر</th>\n                                  <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الحالة الخاصة</th>\n                                </tr>\n                              </thead>\n                              <tbody className=\"divide-y divide-gray-200\">\n                                {groupStudents.length === 0 ? (\n                                  <tr>\n                                    <td \n                                      colSpan={5}\n                                      className=\"px-4 py-8 text-center text-gray-500\"\n                                    >\n                                      لا يوجد طلاب في هذه المجموعة\n                                    </td>\n                                  </tr>\n                                ) : (\n                                  groupStudents.map((student) => {\n                                    const specialStatus = student.specialStatusId \n                                      ? specialStatuses.find(s => s.id === student.specialStatusId)\n                                      : null\n\n                                    return (\n                                      <tr key={student.id} className=\"hover:bg-gray-50\">\n                                        <td className=\"px-4 py-3 text-sm text-gray-900\">{student.name}</td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">{student.nationalId}</td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\" dir=\"ltr\">{student.phone || '-'}</td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\" dir=\"ltr\">{student.guardianPhone || '-'}</td>\n                                        <td className=\"px-4 py-3 text-sm\">\n                                          {specialStatus ? (\n                                            showSpecialStatusColumn ? (\n                                              <span className=\"bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-semibold\">\n                                                {specialStatus.name}\n                                              </span>\n                                            ) : (\n                                              <span className=\"bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-semibold\">\n                                                لديه حالة خاصة\n                                              </span>\n                                            )\n                                          ) : (\n                                            <span className=\"text-gray-400\">-</span>\n                                          )}\n                                        </td>\n                                      </tr>\n                                    )\n                                  })\n                                )}\n                              </tbody>\n                            </table>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  )\n                })\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* صفحة استقبال الطلاب */}\n        {currentPage === 'reception' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl p-6 shadow-sm\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-blue-200 bg-opacity-50 p-3 rounded-xl\">\n                    <UserCheck className=\"text-blue-700\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-blue-900\">استقبال الطلاب</h2>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* حقل البحث */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Search size={20} className=\"text-gray-600\" />\n                <h3 className=\"text-lg font-bold text-gray-800\">تسجيل زيارة</h3>\n              </div>\n              <div className=\"relative\">\n                <input\n                  type=\"text\"\n                  value={receptionSearchTerm}\n                  onChange={(e) => setReceptionSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-gray-200 focus:border-blue-400 focus:outline-none rounded-lg bg-gray-50\"\n                  data-testid=\"input-search-reception\"\n                />\n                \n                {/* نتائج البحث */}\n                {receptionSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(receptionSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(receptionSearchTerm)\n                      )\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedStudentForReception(student)\n                              setReceptionSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'}\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* معلومات الطالب المحدد */}\n            {selectedStudentForReception && (\n              <div className=\"bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl shadow-lg p-6\">\n                <h3 className=\"text-xl font-bold text-blue-900 mb-4 text-right\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-right\">\n                  <div>\n                    <span className=\"text-gray-700\">الاسم: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForReception.name}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">السجل المدني: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForReception.nationalId}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">الصف: </span>\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === selectedStudentForReception.groupId)?.stage || 'غير محدد'}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">عدد الزيارات السابقة: </span>\n                    <span className=\"font-bold text-blue-600\">{selectedStudentForReception.visitCount || 0}</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* نموذج تسجيل الزيارة */}\n            {selectedStudentForReception && (\n              <div className=\"bg-white rounded-xl shadow-lg p-4\">\n                <div className=\"space-y-3\">\n                  {/* سبب الزيارة / المشكلة */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      سبب الزيارة / المشكلة\n                    </label>\n                    <textarea\n                      value={visitReason}\n                      onChange={(e) => setVisitReason(e.target.value)}\n                      placeholder=\"اكتب سبب الزيارة أو وصف المشكلة...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none\"\n                      data-testid=\"textarea-visit-reason\"\n                    />\n                  </div>\n\n                  {/* الإجراء المتخذ */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      الإجراء المتخذ\n                    </label>\n                    <textarea\n                      value={actionTaken}\n                      onChange={(e) => setActionTaken(e.target.value)}\n                      placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none\"\n                      data-testid=\"textarea-action-taken\"\n                    />\n                  </div>\n\n                  {/* التحويل إلى */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      التحويل إلى\n                    </label>\n                    <select\n                      value={referredTo}\n                      onChange={(e) => setReferredTo(e.target.value)}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                      data-testid=\"select-referred-to\"\n                    >\n                      <option value=\"\">لا يوجد</option>\n                      <option value=\"المرشد الطلابي\">المرشد الطلابي</option>\n                      <option value=\"مدير المدرسة\">مدير المدرسة</option>\n                      <option value=\"ولي الأمر\">ولي الأمر</option>\n                      <option value=\"المعلم\">المعلم</option>\n                    </select>\n                  </div>\n\n                  {/* ملاحظات إضافية */}\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">\n                      ملاحظات إضافية (اختياري)\n                    </label>\n                    <textarea\n                      value={additionalNotes}\n                      onChange={(e) => setAdditionalNotes(e.target.value)}\n                      placeholder=\"ملاحظات إضافية...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right resize-none\"\n                      data-testid=\"textarea-additional-notes\"\n                    />\n                  </div>\n\n                  {/* أزرار الإلغاء والتسجيل */}\n                  <div className=\"flex gap-2 pt-1\">\n                    <button\n                      onClick={() => {\n                        setSelectedStudentForReception(null)\n                        setVisitReason('')\n                        setActionTaken('')\n                        setReferredTo('')\n                        setAdditionalNotes('')\n                      }}\n                      className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 rounded-lg transition-all text-sm\"\n                      data-testid=\"button-cancel-visit\"\n                    >\n                      إلغاء\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (!visitReason || !actionTaken) {\n                          alert('الرجاء تعبئة سبب الزيارة والإجراء المتخذ')\n                          return\n                        }\n                        \n                        const now = new Date()\n                        // حفظ التاريخ بصيغة ISO الميلادية (YYYY-MM-DD)\n                        const isoDate = now.toISOString().split('T')[0]\n                        \n                        addStudentVisit.mutate({\n                          studentId: selectedStudentForReception.id,\n                          visitDate: isoDate,\n                          reason: visitReason,\n                          actionTaken: actionTaken,\n                          referredTo: referredTo || 'لا يوجد',\n                          notes: additionalNotes,\n                        })\n                      }}\n                      disabled={addStudentVisit.isPending}\n                      className=\"flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-2.5 rounded-lg transition-all shadow-md disabled:opacity-50 text-sm\"\n                      data-testid=\"button-submit-visit\"\n                    >\n                      {addStudentVisit.isPending ? 'جاري التسجيل...' : 'تسجيل الزيارة'}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* سجل الزيارات الأخيرة */}\n            <div className=\"bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <div className=\"flex items-center gap-3\">\n                  <List size={24} className=\"text-green-700\" />\n                  <h3 className=\"text-2xl font-bold text-green-900\">سجل الزيارات الأخيرة</h3>\n                </div>\n                <button \n                  onClick={() => {\n                    setShowDateFilterModal(true)\n                    setDateFilterError('')\n                  }}\n                  className=\"bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                  data-testid=\"button-filter-date\"\n                >\n                  <Clock size={18} />\n                  <span>فلتر بالتاريخ</span>\n                </button>\n              </div>\n\n              {/* فلتر حسب طالب محدد */}\n              <div className=\"mb-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 shadow-sm border-2 border-purple-200\">\n                <div className=\"flex items-center gap-3 mb-3\">\n                  <UserCheck size={20} className=\"text-purple-700\" />\n                  <h4 className=\"font-bold text-purple-900\">عرض زيارات طالب محدد</h4>\n                </div>\n                <div className=\"relative\">\n                  <input\n                    type=\"text\"\n                    placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                    value={studentSearchTerm}\n                    onChange={(e) => setStudentSearchTerm(e.target.value)}\n                    className=\"w-full p-3 pr-10 border-2 border-purple-300 rounded-lg text-right focus:border-purple-500 focus:outline-none bg-white\"\n                    data-testid=\"input-search-student\"\n                  />\n                  <Search size={20} className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-purple-400\" />\n                </div>\n                \n                {/* نتائج البحث */}\n                {studentSearchTerm && (\n                  <div className=\"mt-2 max-h-48 overflow-y-auto bg-white border-2 border-gray-200 rounded-lg\">\n                    {students\n                      .filter(s => \n                        s.name.includes(studentSearchTerm) || \n                        s.nationalId?.includes(studentSearchTerm)\n                      )\n                      .slice(0, 5)\n                      .map(student => (\n                        <button\n                          key={student.id}\n                          onClick={() => {\n                            setSelectedStudentFilter(student)\n                            setStudentSearchTerm('')\n                          }}\n                          className=\"w-full p-3 text-right hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-0\"\n                          data-testid={`student-search-result-${student.id}`}\n                        >\n                          <div className=\"font-bold text-gray-900\">{student.name}</div>\n                          {student.nationalId && (\n                            <div className=\"text-sm text-gray-600\">السجل: {student.nationalId}</div>\n                          )}\n                        </button>\n                      ))}\n                  </div>\n                )}\n                \n                {/* الطالب المحدد */}\n                {selectedStudentFilter && (\n                  <div className=\"mt-3 bg-blue-50 border-2 border-blue-300 rounded-lg p-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"text-right\">\n                        <div className=\"font-bold text-blue-900 text-lg\">{selectedStudentFilter.name}</div>\n                        <div className=\"text-sm text-blue-700\">\n                          عرض {studentVisits.filter((v: any) => v.studentId === selectedStudentFilter.id).length} زيارة\n                        </div>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <button\n                          onClick={() => {\n                            setSelectedStudentForReception(selectedStudentFilter)\n                            setVisitReason('')\n                            setActionTaken('')\n                            setReferredTo('')\n                            setAdditionalNotes('')\n                          }}\n                          className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2\"\n                          data-testid=\"button-add-visit-for-student\"\n                        >\n                          <PlusCircle size={18} />\n                          <span>تسجيل زيارة جديدة</span>\n                        </button>\n                        <button\n                          onClick={() => setSelectedStudentFilter(null)}\n                          className=\"bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold\"\n                          data-testid=\"button-clear-student-filter\"\n                        >\n                          <X size={18} />\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* قائمة الزيارات */}\n              {(() => {\n                let filteredVisits = studentVisits\n                \n                // فلترة حسب الطالب المحدد\n                if (selectedStudentFilter) {\n                  filteredVisits = filteredVisits.filter((v: any) => v.studentId === selectedStudentFilter.id)\n                }\n                \n                // فلترة حسب التاريخ\n                if (filterDate) {\n                  filteredVisits = filteredVisits.filter((v: any) => v.visitDate === filterDate)\n                }\n                \n                if (filteredVisits.length === 0) {\n                  return (\n                    <div className=\"bg-white rounded-xl p-8 text-center\">\n                      <List size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                      <p className=\"text-xl text-gray-500 font-semibold\">\n                        {selectedStudentFilter && filterDate ? 'لا توجد زيارات للطالب في هذا التاريخ' :\n                         selectedStudentFilter ? 'لا توجد زيارات لهذا الطالب' :\n                         filterDate ? 'لا توجد زيارات في هذا التاريخ' : \n                         'لا توجد زيارات'}\n                      </p>\n                      <div className=\"flex gap-2 justify-center mt-4\">\n                        {filterDate && (\n                          <button\n                            onClick={() => setFilterDate('')}\n                            className=\"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-bold\"\n                            data-testid=\"button-clear-date-filter-empty\"\n                          >\n                            إلغاء فلتر التاريخ\n                          </button>\n                        )}\n                        {selectedStudentFilter && (\n                          <button\n                            onClick={() => setSelectedStudentFilter(null)}\n                            className=\"bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold\"\n                            data-testid=\"button-clear-student-filter-empty\"\n                          >\n                            إلغاء فلتر الطالب\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  )\n                }\n                \n                return (\n                  <div className=\"space-y-4\">\n                    {/* بانر فلتر الطالب */}\n                    {selectedStudentFilter && (\n                      <div className=\"bg-purple-50 border-2 border-purple-300 rounded-lg p-4 flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <UserCheck size={20} className=\"text-purple-600\" />\n                          <span className=\"font-bold text-purple-900\">عرض زيارات الطالب: {selectedStudentFilter.name}</span>\n                        </div>\n                        <button\n                          onClick={() => setSelectedStudentFilter(null)}\n                          className=\"bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2\"\n                          data-testid=\"button-clear-student-filter-banner\"\n                        >\n                          <X size={16} />\n                          <span>إلغاء</span>\n                        </button>\n                      </div>\n                    )}\n                    \n                    {/* بانر فلتر التاريخ */}\n                    {filterDate && (\n                      <div className=\"bg-blue-50 border-2 border-blue-300 rounded-lg p-4 flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <Clock size={20} className=\"text-blue-600\" />\n                          <span className=\"font-bold text-blue-900\">عرض زيارات تاريخ: {filterDate}</span>\n                        </div>\n                        <button\n                          onClick={() => setFilterDate('')}\n                          className=\"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2\"\n                          data-testid=\"button-clear-date-filter-banner\"\n                        >\n                          <X size={16} />\n                          <span>إلغاء</span>\n                        </button>\n                      </div>\n                    )}\n                    {filteredVisits.slice().reverse().map((visit: any) => {\n                    const student = students.find(s => s.id === visit.studentId)\n                    if (!student) return null\n                    \n                    const visitTime = new Date(visit.createdAt).toLocaleTimeString('ar-SA', {\n                      hour: '2-digit',\n                      minute: '2-digit',\n                      hour12: true\n                    })\n                    \n                    return (\n                      <div key={visit.id} className=\"bg-white rounded-xl p-6 shadow-md\" data-testid={`visit-card-${visit.id}`}>\n                        <div className=\"flex items-start justify-between mb-4\">\n                          <div className=\"flex-1\">\n                            <h4 className=\"text-xl font-bold text-gray-900 mb-2\">{student.name}</h4>\n                            <div className=\"flex items-center gap-4 text-sm text-gray-600\">\n                              <span>{visit.visitDate} هـ</span>\n                              <span>{visitTime}</span>\n                            </div>\n                          </div>\n                          <div className=\"flex gap-2\">\n                            {/* زر حذف */}\n                            <button\n                              onClick={() => {\n                                if (window.confirm('هل أنت متأكد من حذف هذه الزيارة؟')) {\n                                  deleteStudentVisit.mutate(visit.id)\n                                }\n                              }}\n                              disabled={deleteStudentVisit.isPending}\n                              className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors disabled:opacity-50\"\n                              data-testid={`button-delete-visit-${visit.id}`}\n                            >\n                              <Trash2 size={16} />\n                              <span>حذف</span>\n                            </button>\n                            \n                            {/* زر واتساب */}\n                            <button\n                              onClick={() => {\n                                const message = `\nزيارة طالب - ${student.name}\nالتاريخ: ${visit.visitDate}\nالوقت: ${visitTime}\n\nالسبب: ${visit.reason}\nالإجراء: ${visit.actionTaken}\n${visit.referredTo !== 'لا يوجد' ? `التحويل إلى: ${visit.referredTo}` : ''}\n${visit.notes ? `ملاحظات: ${visit.notes}` : ''}\n                                `.trim()\n                                \n                                const phone = formatPhoneForWhatsApp(student.guardianPhone)\n                                if (phone) {\n                                  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank')\n                                } else {\n                                  alert('لا يوجد رقم جوال لولي الأمر')\n                                }\n                              }}\n                              className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                              data-testid={`button-whatsapp-${visit.id}`}\n                            >\n                              <Phone size={16} />\n                              <span>واتساب</span>\n                            </button>\n                            \n                            {/* زر طباعة */}\n                            <button\n                              onClick={() => {\n                                const printContent = `\n                                  <div dir=\"rtl\" style=\"font-family: Arial; padding: 20px;\">\n                                    <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px;\">\n                                      <h1 style=\"color: #3b82f6; font-size: 24px; margin-bottom: 5px;\">${profile?.schoolName || 'المدرسة'}</h1>\n                                      <p style=\"color: #666; font-size: 16px; margin: 5px 0;\">المعلم: ${profile?.name || 'غير محدد'}</p>\n                                      <h2 style=\"color: #333; font-size: 20px; margin-top: 15px;\">تقرير زيارة طالب</h2>\n                                    </div>\n                                    <table style=\"width: 100%; border-collapse: collapse;\">\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">اسم الطالب</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${student.name}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">التاريخ</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.visitDate} هـ</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">الوقت</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visitTime}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">السبب</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.reason}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">الإجراء المتخذ</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.actionTaken}</td>\n                                      </tr>\n                                      <tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">التحويل إلى</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.referredTo}</td>\n                                      </tr>\n                                      ${visit.notes ? `<tr>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd; font-weight: bold; background: #f5f5f5;\">ملاحظات</td>\n                                        <td style=\"padding: 10px; border: 1px solid #ddd;\">${visit.notes}</td>\n                                      </tr>` : ''}\n                                    </table>\n                                    <div style=\"margin-top: 30px; text-align: center; color: #999; font-size: 12px;\">\n                                      <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>\n                                    </div>\n                                  </div>\n                                `\n                                const printWindow = window.open('', '', 'width=800,height=600')\n                                if (printWindow) {\n                                  printWindow.document.write(printContent)\n                                  printWindow.document.close()\n                                  printWindow.print()\n                                }\n                              }}\n                              className=\"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                              data-testid={`button-print-${visit.id}`}\n                            >\n                              <Printer size={16} />\n                              <span>طباعة</span>\n                            </button>\n                          </div>\n                        </div>\n                        \n                        <div className=\"space-y-2 text-right\">\n                          <div className=\"bg-gray-50 p-3 rounded-lg\">\n                            <span className=\"text-sm font-bold text-gray-700\">السبب: </span>\n                            <span className=\"text-gray-900\">{visit.reason}</span>\n                          </div>\n                          <div className=\"bg-gray-50 p-3 rounded-lg\">\n                            <span className=\"text-sm font-bold text-gray-700\">الإجراء: </span>\n                            <span className=\"text-gray-900\">{visit.actionTaken}</span>\n                          </div>\n                          {visit.referredTo !== 'لا يوجد' && (\n                            <div className=\"bg-blue-50 p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-blue-700\">التحويل إلى: </span>\n                              <span className=\"text-blue-900\">{visit.referredTo}</span>\n                            </div>\n                          )}\n                          {visit.notes && (\n                            <div className=\"bg-yellow-50 p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-yellow-700\">ملاحظات: </span>\n                              <span className=\"text-yellow-900\">{visit.notes}</span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )\n                  })}\n                  </div>\n                )\n              })()}\n            </div>\n          </div>\n        )}\n\n        {/* صفحة الاستئذان */}\n        {currentPage === 'permission' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-orange-50 to-orange-100 rounded-2xl p-6 shadow-sm\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-orange-200 bg-opacity-50 p-3 rounded-xl\">\n                    <LogOut className=\"text-orange-700\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-orange-900\">الاستئذان</h2>\n                    <p className=\"text-orange-700 mt-1\">إدارة خروج الطلاب والاستئذان</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* حقل البحث */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Search size={20} className=\"text-gray-600\" />\n                <h3 className=\"text-lg font-bold text-gray-800\">تسجيل استئذان</h3>\n              </div>\n              <div className=\"relative\">\n                <input\n                  type=\"text\"\n                  value={permissionSearchTerm}\n                  onChange={(e) => setPermissionSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-gray-200 focus:border-orange-400 focus:outline-none rounded-lg bg-gray-50\"\n                  data-testid=\"input-search-permission\"\n                />\n                \n                {/* نتائج البحث */}\n                {permissionSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(permissionSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(permissionSearchTerm)\n                      )\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedStudentForPermission(student)\n                              setPermissionSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-orange-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-permission-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'}\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* معلومات الطالب المحدد */}\n            {selectedStudentForPermission && (\n              <div className=\"bg-gradient-to-r from-orange-50 to-orange-100 rounded-2xl shadow-lg p-6\">\n                <h3 className=\"text-xl font-bold text-orange-900 mb-4 text-right\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-right\">\n                  <div>\n                    <span className=\"text-gray-700\">الاسم: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForPermission.name}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">السجل المدني: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForPermission.nationalId}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">الصف: </span>\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === selectedStudentForPermission.groupId)?.stage || 'غير محدد'}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">عدد الاستئذانات السابقة: </span>\n                    <span className=\"font-bold text-orange-600\">{selectedStudentForPermission.permissionCount || 0}</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* نموذج تسجيل الاستئذان */}\n            {selectedStudentForPermission && (\n              <div className=\"bg-white rounded-xl shadow-lg p-4\">\n                <h3 className=\"text-base font-bold text-orange-900 mb-3 text-right\">تفاصيل الاستئذان</h3>\n                <div className=\"space-y-3\">\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">سبب الاستئذان</label>\n                    <input\n                      type=\"text\"\n                      value={permissionReason}\n                      onChange={(e) => setPermissionReason(e.target.value)}\n                      placeholder=\"مثال: موعد طبي، ظرف عائلي...\"\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-right\"\n                      data-testid=\"input-permission-reason\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">ملاحظات (اختياري)</label>\n                    <textarea\n                      value={permissionNotes}\n                      onChange={(e) => setPermissionNotes(e.target.value)}\n                      placeholder=\"أي ملاحظات إضافية...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-right resize-none\"\n                      data-testid=\"textarea-permission-notes\"\n                    />\n                  </div>\n\n                  {/* رسالة خطأ */}\n                  {permissionError && (\n                    <div className=\"bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg text-right text-sm\" data-testid=\"error-permission\">\n                      {permissionError}\n                    </div>\n                  )}\n\n                  <div className=\"flex gap-2 pt-1\">\n                    <button\n                      onClick={() => {\n                        setSelectedStudentForPermission(null)\n                        setPermissionReason('')\n                        setPermissionNotes('')\n                        setPermissionError('')\n                      }}\n                      className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 rounded-lg transition-all text-sm\"\n                      data-testid=\"button-cancel-permission\"\n                    >\n                      إلغاء\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (!permissionReason || !permissionReason.trim()) {\n                          setPermissionError('الرجاء تعبئة سبب الاستئذان')\n                          return\n                        }\n                        setPermissionError('')\n                        \n                        // تخزين التاريخ بصيغة ISO الميلادية (YYYY-MM-DD)\n                        const today = new Date()\n                        const permissionDate = today.toISOString().split('T')[0]\n                        \n                        // أخذ الوقت الحالي تلقائياً\n                        const currentTime = today.toLocaleTimeString('ar-SA', { \n                          hour: '2-digit', \n                          minute: '2-digit',\n                          hour12: false \n                        })\n                        \n                        addStudentPermission.mutate({\n                          studentId: selectedStudentForPermission.id,\n                          reason: permissionReason,\n                          exitTime: currentTime,\n                          notes: permissionNotes || null,\n                          permissionDate: permissionDate\n                        })\n                      }}\n                      disabled={addStudentPermission.isPending}\n                      className=\"flex-1 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-bold py-2.5 rounded-lg transition-all shadow-md disabled:opacity-50 text-sm\"\n                      data-testid=\"button-submit-permission\"\n                    >\n                      {addStudentPermission.isPending ? 'جاري التسجيل...' : 'تسجيل الاستئذان'}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* عرض استئذانات طالب محدد */}\n            <div className=\"bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <div className=\"flex items-center gap-3\">\n                  <UserSearch size={24} className=\"text-purple-700\" />\n                  <h3 className=\"text-2xl font-bold text-purple-900\">عرض استئذانات طالب محدد</h3>\n                </div>\n                <button\n                  onClick={() => setShowPermissionDateFilter(true)}\n                  className=\"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                  data-testid=\"button-filter-permission-date\"\n                >\n                  <Calendar size={18} />\n                  <span>فلتر بالتاريخ</span>\n                </button>\n              </div>\n\n              {/* حقل البحث */}\n              <div className=\"relative mb-4\">\n                <input\n                  type=\"text\"\n                  value={permissionStudentSearchTerm}\n                  onChange={(e) => setPermissionStudentSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-purple-300 focus:border-purple-500 focus:outline-none rounded-lg bg-white\"\n                  data-testid=\"input-search-permission-student-filter\"\n                />\n                \n                {/* نتائج البحث */}\n                {permissionStudentSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-purple-300 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(permissionStudentSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(permissionStudentSearchTerm)\n                      )\n                      .slice(0, 5)\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedPermissionStudentFilter(student)\n                              setPermissionStudentSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-permission-filter-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'} • {student.permissionCount || 0} استئذان\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n\n              {/* بانر الطالب المحدد */}\n              {selectedPermissionStudentFilter && (\n                <div className=\"bg-purple-200 border-2 border-purple-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-right flex-1\">\n                      <div className=\"text-purple-900 font-bold text-lg mb-1\">\n                        عرض استئذانات: {selectedPermissionStudentFilter.name}\n                      </div>\n                      <div className=\"text-purple-700 text-sm\">\n                        عدد الاستئذانات: {selectedPermissionStudentFilter.permissionCount || 0}\n                      </div>\n                    </div>\n                    <button\n                      onClick={() => setSelectedPermissionStudentFilter(null)}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-permission-student-filter\"\n                    >\n                      إلغاء التصفية\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* بانر فلتر التاريخ */}\n              {permissionFilterDate && (\n                <div className=\"bg-blue-100 border-2 border-blue-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-blue-900 font-bold\">\n                      التاريخ: {new Date(permissionFilterDate).toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })}\n                    </div>\n                    <button\n                      onClick={() => setPermissionFilterDate('')}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-permission-date-filter\"\n                    >\n                      إلغاء فلتر التاريخ\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* سجل الاستئذانات */}\n              <div className=\"bg-white rounded-xl p-4\">\n                {isLoadingPermissions ? (\n                  <div className=\"text-center py-12\">\n                    <div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto mb-4\"></div>\n                    <p className=\"text-lg text-gray-600 font-semibold\">جاري تحميل الاستئذانات...</p>\n                  </div>\n                ) : (() => {\n                  let filteredPermissions = [...studentPermissions]\n                  \n                  // فلتر حسب الطالب المحدد\n                  if (selectedPermissionStudentFilter) {\n                    filteredPermissions = filteredPermissions.filter((p: any) => \n                      p.studentId === selectedPermissionStudentFilter.id\n                    )\n                  }\n                  \n                  // فلتر حسب التاريخ (المقارنة بصيغة ISO الميلادية)\n                  if (permissionFilterDate) {\n                    filteredPermissions = filteredPermissions.filter((p: any) => \n                      p.permissionDate === permissionFilterDate\n                    )\n                  }\n                  \n                  if (filteredPermissions.length === 0) {\n                    return (\n                      <div className=\"text-center py-12\">\n                        <LogOut size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                        <p className=\"text-xl text-gray-500 font-semibold\">لا توجد استئذانات</p>\n                        <p className=\"text-gray-400 mt-2\">\n                          {selectedPermissionStudentFilter || permissionFilterDate \n                            ? 'جرب فلاتر أخرى' \n                            : 'سيتم عرض الاستئذانات هنا بعد تسجيلها'}\n                        </p>\n                      </div>\n                    )\n                  }\n                  \n                  return (\n                    <div className=\"space-y-3\">\n                    {filteredPermissions.sort((a: any, b: any) => \n                      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                    ).map((permission: any) => {\n                      const student = students.find((s: Student) => s.id === permission.studentId)\n                      if (!student) return null\n                      \n                      // تحويل التاريخ الميلادي إلى هجري للعرض\n                      const permissionDateObj = new Date(permission.permissionDate)\n                      const hijriDate = permissionDateObj.toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })\n                      \n                      return (\n                        <div key={permission.id} className=\"bg-orange-50 border-2 border-orange-200 rounded-lg p-4\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div className=\"text-right flex-1\">\n                              <div className=\"font-bold text-lg text-gray-900\">{student.name}</div>\n                              <div className=\"text-sm text-gray-600 mt-1\">\n                                {hijriDate} • {permission.exitTime || 'لم يحدد الوقت'}\n                              </div>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => {\n                                  if (confirm('هل أنت متأكد من حذف هذا الاستئذان؟')) {\n                                    // TODO: Add delete mutation\n                                    alert('سيتم إضافة وظيفة الحذف قريباً')\n                                  }\n                                }}\n                                className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-delete-permission-${permission.id}`}\n                              >\n                                <span>🗑️</span>\n                                <span>حذف</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  if (!student.guardianPhone) {\n                                    alert('رقم جوال ولي الأمر غير مسجل')\n                                    return\n                                  }\n                                  \n                                  const phone = formatPhoneForWhatsApp(student.guardianPhone)\n                                  if (!phone) {\n                                    alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n                                    return\n                                  }\n                                  \n                                  const text = `استئذان: ${student.name}\\nالتاريخ: ${hijriDate}\\nالسبب: ${permission.reason}\\nالوقت: ${permission.exitTime || 'لم يحدد'}`\n                                  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank')\n                                }}\n                                className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-whatsapp-permission-${permission.id}`}\n                              >\n                                <span>📱</span>\n                                <span>واتساب</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  const printContent = `\n                                    <div class=\"print-content\" style=\"padding: 40px; font-family: Arial, sans-serif; direction: rtl;\">\n                                      <div style=\"text-align: center; margin-bottom: 40px; border-bottom: 3px solid #000; padding-bottom: 20px;\">\n                                        <h1 style=\"font-size: 28px; margin-bottom: 10px; font-weight: bold;\">${profile?.schoolName || 'المدرسة'}</h1>\n                                        <p style=\"font-size: 18px; color: #555;\">المعلم: ${profile?.name || 'غير محدد'}</p>\n                                      </div>\n                                      \n                                      <div style=\"margin-bottom: 30px;\">\n                                        <h2 style=\"font-size: 24px; text-align: center; background-color: #f97316; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px;\">استئذان طالب</h2>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fff3e0; padding: 25px; border-radius: 8px; border: 2px solid #f97316; margin-bottom: 20px;\">\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">اسم الطالب:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.name}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">السجل المدني:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.nationalId}</p>\n                                          </div>\n                                        </div>\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">التاريخ:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${hijriDate}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">وقت الخروج:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${permission.exitTime || 'لم يحدد'}</p>\n                                          </div>\n                                        </div>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fef3c7; padding: 20px; border-radius: 8px; border-right: 4px solid #f59e0b; margin-bottom: 20px;\">\n                                        <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">سبب الاستئذان:</p>\n                                        <p style=\"font-size: 18px; line-height: 1.6;\">${permission.reason}</p>\n                                      </div>\n                                      \n                                      ${permission.notes ? `\n                                        <div style=\"background-color: #e0f2fe; padding: 20px; border-radius: 8px; border-right: 4px solid #0ea5e9; margin-bottom: 30px;\">\n                                          <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">ملاحظات:</p>\n                                          <p style=\"font-size: 18px; line-height: 1.6;\">${permission.notes}</p>\n                                        </div>\n                                      ` : ''}\n                                      \n                                      <div style=\"margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;\">\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع المعلم</p>\n                                        </div>\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع ولي الأمر</p>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  `\n                                  const printWindow = window.open('', '', 'height=600,width=800')\n                                  printWindow.document.write('<html><head><title>طباعة استئذان</title>')\n                                  printWindow.document.write('</head><body>')\n                                  printWindow.document.write(printContent)\n                                  printWindow.document.write('</body></html>')\n                                  printWindow.document.close()\n                                  printWindow.print()\n                                }}\n                                className=\"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-print-permission-${permission.id}`}\n                              >\n                                <span>🖨️</span>\n                                <span>طباعة</span>\n                              </button>\n                            </div>\n                          </div>\n                          \n                          <div className=\"space-y-2 text-right\">\n                            <div className=\"bg-white p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-gray-700\">السبب: </span>\n                              <span className=\"text-gray-900\">{permission.reason}</span>\n                            </div>\n                            {permission.notes && (\n                              <div className=\"bg-yellow-50 p-3 rounded-lg\">\n                                <span className=\"text-sm font-bold text-yellow-700\">ملاحظات: </span>\n                                <span className=\"text-yellow-900\">{permission.notes}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      )\n                    })}\n                    </div>\n                  )\n                })()}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* صفحة المخالفات */}\n        {currentPage === 'absence' && (\n          <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-red-50 to-red-100 rounded-2xl p-6 shadow-sm\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-red-200 bg-opacity-50 p-3 rounded-xl\">\n                    <AlertCircle className=\"text-red-700\" size={32} />\n                  </div>\n                  <div>\n                    <h2 className=\"text-3xl font-bold text-red-900\">المخالفات</h2>\n                    <p className=\"text-red-700 mt-1\">تسجيل ومتابعة مخالفات الطلاب</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* حقل البحث */}\n            <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center gap-2 mb-4\">\n                <Search size={20} className=\"text-gray-600\" />\n                <h3 className=\"text-lg font-bold text-gray-800\">تسجيل مخالفة</h3>\n              </div>\n              <div className=\"relative\">\n                <input\n                  type=\"text\"\n                  value={violationSearchTerm}\n                  onChange={(e) => setViolationSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-gray-200 focus:border-red-400 focus:outline-none rounded-lg bg-gray-50\"\n                  data-testid=\"input-search-violation\"\n                />\n                \n                {/* نتائج البحث */}\n                {violationSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(violationSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(violationSearchTerm)\n                      )\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedStudentForViolation(student)\n                              setViolationSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-red-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-violation-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'}\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* معلومات الطالب المحدد */}\n            {selectedStudentForViolation && (\n              <div className=\"bg-gradient-to-r from-red-50 to-red-100 rounded-2xl shadow-lg p-6\">\n                <h3 className=\"text-xl font-bold text-red-900 mb-4 text-right\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-4 text-right\">\n                  <div>\n                    <span className=\"text-gray-700\">الاسم: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForViolation.name}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">السجل المدني: </span>\n                    <span className=\"font-bold text-gray-900\">{selectedStudentForViolation.nationalId}</span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">الصف: </span>\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === selectedStudentForViolation.groupId)?.stage || 'غير محدد'}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-gray-700\">عدد المخالفات السابقة: </span>\n                    <span className=\"font-bold text-red-600\">{selectedStudentForViolation.violationCount || 0}</span>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* نموذج تسجيل المخالفة */}\n            {selectedStudentForViolation && (\n              <div className=\"bg-white rounded-xl shadow-lg p-4\">\n                <h3 className=\"text-base font-bold text-red-900 mb-3 text-right\">تفاصيل المخالفة</h3>\n                <div className=\"space-y-3\">\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">نوع المخالفة</label>\n                    <select\n                      value={violationType}\n                      onChange={(e) => setViolationType(e.target.value)}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right\"\n                      data-testid=\"select-violation-type\"\n                    >\n                      <option value=\"\">اختر نوع المخالفة</option>\n                      <option value=\"تأخر\">تأخر عن الطابور</option>\n                      <option value=\"غياب\">غياب بدون عذر</option>\n                      <option value=\"سلوك\">سلوك غير لائق</option>\n                      <option value=\"واجب\">عدم حل الواجب</option>\n                      <option value=\"زي\">مخالفة الزي المدرسي</option>\n                      <option value=\"أخرى\">أخرى</option>\n                    </select>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">وصف المخالفة</label>\n                    <textarea\n                      value={violationDescription}\n                      onChange={(e) => setViolationDescription(e.target.value)}\n                      placeholder=\"اكتب تفاصيل المخالفة...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right resize-none\"\n                      data-testid=\"textarea-violation-description\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">الإجراء المتخذ</label>\n                    <select\n                      value={violationAction}\n                      onChange={(e) => setViolationAction(e.target.value)}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right\"\n                      data-testid=\"select-violation-action\"\n                    >\n                      <option value=\"\">اختر الإجراء</option>\n                      <option value=\"إنذار شفهي\">إنذار شفهي</option>\n                      <option value=\"إنذار كتابي\">إنذار كتابي</option>\n                      <option value=\"استدعاء ولي الأمر\">استدعاء ولي الأمر</option>\n                      <option value=\"حسم درجات\">حسم درجات السلوك</option>\n                      <option value=\"أخرى\">أخرى</option>\n                    </select>\n                  </div>\n\n                  <div>\n                    <label className=\"block text-xs font-medium text-gray-700 mb-1 text-right\">ملاحظات (اختياري)</label>\n                    <textarea\n                      value={violationNotes}\n                      onChange={(e) => setViolationNotes(e.target.value)}\n                      placeholder=\"أي ملاحظات إضافية...\"\n                      rows={2}\n                      className=\"w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-right resize-none\"\n                      data-testid=\"textarea-violation-notes\"\n                    />\n                  </div>\n\n                  {/* رسالة خطأ */}\n                  {violationError && (\n                    <div className=\"bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg text-right text-sm\" data-testid=\"error-violation\">\n                      {violationError}\n                    </div>\n                  )}\n\n                  <div className=\"flex gap-2 pt-1\">\n                    <button\n                      onClick={() => {\n                        setSelectedStudentForViolation(null)\n                        setViolationType('')\n                        setViolationDescription('')\n                        setViolationAction('')\n                        setViolationNotes('')\n                        setViolationError('')\n                      }}\n                      className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 rounded-lg transition-all text-sm\"\n                      data-testid=\"button-cancel-violation\"\n                    >\n                      إلغاء\n                    </button>\n                    <button\n                      onClick={() => {\n                        if (!violationType || !violationDescription.trim() || !violationAction) {\n                          setViolationError('الرجاء تعبئة جميع الحقول المطلوبة (نوع المخالفة، الوصف، والإجراء)')\n                          return\n                        }\n                        setViolationError('')\n                        \n                        // تخزين التاريخ بصيغة ISO الميلادية (YYYY-MM-DD)\n                        const today = new Date()\n                        const violationDate = today.toISOString().split('T')[0]\n                        \n                        addStudentViolation.mutate({\n                          studentId: selectedStudentForViolation.id,\n                          violationType: violationType,\n                          description: violationDescription,\n                          actionTaken: violationAction,\n                          notes: violationNotes || null,\n                          violationDate: violationDate\n                        })\n                      }}\n                      disabled={addStudentViolation.isPending}\n                      className=\"flex-1 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-2.5 rounded-lg transition-all shadow-md disabled:opacity-50 text-sm\"\n                      data-testid=\"button-submit-violation\"\n                    >\n                      {addStudentViolation.isPending ? 'جاري التسجيل...' : 'تسجيل المخالفة'}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* عرض مخالفات طالب محدد */}\n            <div className=\"bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl shadow-lg p-6\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <div className=\"flex items-center gap-3\">\n                  <UserSearch size={24} className=\"text-purple-700\" />\n                  <h3 className=\"text-2xl font-bold text-purple-900\">عرض مخالفات طالب محدد</h3>\n                </div>\n                <button\n                  onClick={() => setShowViolationDateFilter(true)}\n                  className=\"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors\"\n                  data-testid=\"button-filter-violation-date\"\n                >\n                  <Calendar size={18} />\n                  <span>فلتر بالتاريخ</span>\n                </button>\n              </div>\n\n              {/* حقل البحث */}\n              <div className=\"relative mb-4\">\n                <input\n                  type=\"text\"\n                  value={violationStudentSearchTerm}\n                  onChange={(e) => setViolationStudentSearchTerm(e.target.value)}\n                  placeholder=\"ابحث بالاسم أو السجل المدني...\"\n                  className=\"w-full px-6 py-4 text-lg border-2 border-purple-300 focus:border-purple-500 focus:outline-none rounded-lg bg-white\"\n                  data-testid=\"input-search-violation-student-filter\"\n                />\n                \n                {/* نتائج البحث */}\n                {violationStudentSearchTerm && (\n                  <div className=\"absolute top-full left-0 right-0 mt-2 bg-white border-2 border-purple-300 rounded-lg shadow-xl max-h-96 overflow-y-auto z-50\">\n                    {students\n                      .filter(s => \n                        s.name.toLowerCase().includes(violationStudentSearchTerm.toLowerCase()) ||\n                        s.nationalId.includes(violationStudentSearchTerm)\n                      )\n                      .slice(0, 5)\n                      .map(student => {\n                        const group = groups.find(g => g.id === student.groupId)\n                        return (\n                          <button\n                            key={student.id}\n                            onClick={() => {\n                              setSelectedViolationStudentFilter(student)\n                              setViolationStudentSearchTerm('')\n                            }}\n                            className=\"w-full px-6 py-4 text-right hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0\"\n                            data-testid={`search-result-violation-filter-${student.id}`}\n                          >\n                            <div className=\"font-bold text-gray-900\">{student.name}</div>\n                            <div className=\"text-sm text-gray-600 mt-1\">\n                              {student.nationalId} • {group?.stage || 'غير محدد'} • {student.violationCount || 0} مخالفة\n                            </div>\n                          </button>\n                        )\n                      })}\n                  </div>\n                )}\n              </div>\n\n              {/* بانر الطالب المحدد */}\n              {selectedViolationStudentFilter && (\n                <div className=\"bg-purple-200 border-2 border-purple-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-right flex-1\">\n                      <div className=\"text-purple-900 font-bold text-lg mb-1\">\n                        عرض مخالفات: {selectedViolationStudentFilter.name}\n                      </div>\n                      <div className=\"text-purple-700 text-sm\">\n                        عدد المخالفات: {selectedViolationStudentFilter.violationCount || 0}\n                      </div>\n                    </div>\n                    <button\n                      onClick={() => setSelectedViolationStudentFilter(null)}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-violation-student-filter\"\n                    >\n                      إلغاء التصفية\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* بانر فلتر التاريخ */}\n              {violationFilterDate && (\n                <div className=\"bg-blue-100 border-2 border-blue-400 rounded-xl p-4 mb-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-blue-900 font-bold\">\n                      التاريخ: {new Date(violationFilterDate).toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })}\n                    </div>\n                    <button\n                      onClick={() => setViolationFilterDate('')}\n                      className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition-colors\"\n                      data-testid=\"button-clear-violation-date-filter\"\n                    >\n                      إلغاء فلتر التاريخ\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {/* سجل المخالفات */}\n              <div className=\"bg-white rounded-xl p-4\">\n                {isLoadingViolations ? (\n                  <div className=\"text-center py-12\">\n                    <div className=\"animate-spin rounded-full h-16 w-16 border-b-2 border-red-600 mx-auto mb-4\"></div>\n                    <p className=\"text-lg text-gray-600 font-semibold\">جاري تحميل المخالفات...</p>\n                  </div>\n                ) : (() => {\n                  let filteredViolations = [...studentViolations]\n                  \n                  // فلتر حسب الطالب المحدد\n                  if (selectedViolationStudentFilter) {\n                    filteredViolations = filteredViolations.filter((v: any) => \n                      v.studentId === selectedViolationStudentFilter.id\n                    )\n                  }\n                  \n                  // فلتر حسب التاريخ (المقارنة بصيغة ISO الميلادية)\n                  if (violationFilterDate) {\n                    filteredViolations = filteredViolations.filter((v: any) => \n                      v.violationDate === violationFilterDate\n                    )\n                  }\n                  \n                  if (filteredViolations.length === 0) {\n                    return (\n                      <div className=\"text-center py-12\">\n                        <AlertCircle size={64} className=\"mx-auto text-gray-300 mb-4\" />\n                        <p className=\"text-xl text-gray-500 font-semibold\">لا توجد مخالفات</p>\n                        <p className=\"text-gray-400 mt-2\">\n                          {selectedViolationStudentFilter || violationFilterDate \n                            ? 'جرب فلاتر أخرى' \n                            : 'سيتم عرض المخالفات هنا بعد تسجيلها'}\n                        </p>\n                      </div>\n                    )\n                  }\n                  \n                  return (\n                    <div className=\"space-y-3\">\n                    {filteredViolations.sort((a: any, b: any) => \n                      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n                    ).map((violation: any) => {\n                      const student = students.find((s: Student) => s.id === violation.studentId)\n                      if (!student) return null\n                      \n                      // تحويل التاريخ الميلادي إلى هجري للعرض\n                      const violationDateObj = new Date(violation.violationDate)\n                      const hijriDate = violationDateObj.toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })\n                      \n                      return (\n                        <div key={violation.id} className=\"bg-red-50 border-2 border-red-200 rounded-lg p-4\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div className=\"text-right flex-1\">\n                              <div className=\"font-bold text-lg text-gray-900\">{student.name}</div>\n                              <div className=\"text-sm text-gray-600 mt-1\">\n                                {hijriDate} • {violation.violationType}\n                              </div>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => {\n                                  if (confirm('هل أنت متأكد من حذف هذه المخالفة؟')) {\n                                    // TODO: Add delete mutation\n                                    alert('سيتم إضافة وظيفة الحذف قريباً')\n                                  }\n                                }}\n                                className=\"bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-delete-violation-${violation.id}`}\n                              >\n                                <span>🗑️</span>\n                                <span>حذف</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  if (!student.guardianPhone) {\n                                    alert('رقم جوال ولي الأمر غير مسجل')\n                                    return\n                                  }\n                                  \n                                  const phone = formatPhoneForWhatsApp(student.guardianPhone)\n                                  if (!phone) {\n                                    alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n                                    return\n                                  }\n                                  \n                                  const text = `مخالفة: ${student.name}\\nالتاريخ: ${hijriDate}\\nالنوع: ${violation.violationType}\\nالوصف: ${violation.description}\\nالإجراء: ${violation.actionTaken}`\n                                  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(text)}`, '_blank')\n                                }}\n                                className=\"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-whatsapp-violation-${violation.id}`}\n                              >\n                                <span>📱</span>\n                                <span>واتساب</span>\n                              </button>\n                              <button\n                                onClick={() => {\n                                  const printContent = `\n                                    <div class=\"print-content\" style=\"padding: 40px; font-family: Arial, sans-serif; direction: rtl;\">\n                                      <div style=\"text-align: center; margin-bottom: 40px; border-bottom: 3px solid #000; padding-bottom: 20px;\">\n                                        <h1 style=\"font-size: 28px; margin-bottom: 10px; font-weight: bold;\">${profile?.schoolName || 'المدرسة'}</h1>\n                                        <p style=\"font-size: 18px; color: #555;\">المعلم: ${profile?.name || 'غير محدد'}</p>\n                                      </div>\n                                      \n                                      <div style=\"margin-bottom: 30px;\">\n                                        <h2 style=\"font-size: 24px; text-align: center; background-color: #dc2626; color: white; padding: 15px; border-radius: 8px; margin-bottom: 30px;\">إشعار مخالفة</h2>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fee2e2; padding: 25px; border-radius: 8px; border: 2px solid #dc2626; margin-bottom: 20px;\">\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">اسم الطالب:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.name}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">السجل المدني:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${student.nationalId}</p>\n                                          </div>\n                                        </div>\n                                        <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px;\">\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">التاريخ:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${hijriDate}</p>\n                                          </div>\n                                          <div>\n                                            <p style=\"font-size: 16px; color: #666; margin-bottom: 5px;\">نوع المخالفة:</p>\n                                            <p style=\"font-size: 20px; font-weight: bold;\">${violation.violationType}</p>\n                                          </div>\n                                        </div>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #fef3c7; padding: 20px; border-radius: 8px; border-right: 4px solid #f59e0b; margin-bottom: 20px;\">\n                                        <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">وصف المخالفة:</p>\n                                        <p style=\"font-size: 18px; line-height: 1.6;\">${violation.description}</p>\n                                      </div>\n                                      \n                                      <div style=\"background-color: #dbeafe; padding: 20px; border-radius: 8px; border-right: 4px solid #3b82f6; margin-bottom: 20px;\">\n                                        <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">الإجراء المتخذ:</p>\n                                        <p style=\"font-size: 18px; line-height: 1.6;\">${violation.actionTaken}</p>\n                                      </div>\n                                      \n                                      ${violation.notes ? `\n                                        <div style=\"background-color: #e0f2fe; padding: 20px; border-radius: 8px; border-right: 4px solid #0ea5e9; margin-bottom: 30px;\">\n                                          <p style=\"font-size: 16px; color: #666; margin-bottom: 8px;\">ملاحظات إضافية:</p>\n                                          <p style=\"font-size: 18px; line-height: 1.6;\">${violation.notes}</p>\n                                        </div>\n                                      ` : ''}\n                                      \n                                      <div style=\"margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;\">\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع المعلم</p>\n                                        </div>\n                                        <div style=\"text-align: center; border-top: 2px solid #000; padding-top: 10px;\">\n                                          <p style=\"font-size: 16px;\">توقيع ولي الأمر</p>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  `\n                                  const printWindow = window.open('', '', 'height=600,width=800')\n                                  printWindow.document.write('<html><head><title>طباعة مخالفة</title>')\n                                  printWindow.document.write('</head><body>')\n                                  printWindow.document.write(printContent)\n                                  printWindow.document.write('</body></html>')\n                                  printWindow.document.close()\n                                  printWindow.print()\n                                }}\n                                className=\"bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-colors\"\n                                data-testid={`button-print-violation-${violation.id}`}\n                              >\n                                <span>🖨️</span>\n                                <span>طباعة</span>\n                              </button>\n                            </div>\n                          </div>\n                          \n                          <div className=\"space-y-2 text-right\">\n                            <div className=\"bg-white p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-gray-700\">الوصف: </span>\n                              <span className=\"text-gray-900\">{violation.description}</span>\n                            </div>\n                            <div className=\"bg-blue-50 p-3 rounded-lg\">\n                              <span className=\"text-sm font-bold text-blue-700\">الإجراء المتخذ: </span>\n                              <span className=\"text-blue-900\">{violation.actionTaken}</span>\n                            </div>\n                            {violation.notes && (\n                              <div className=\"bg-yellow-50 p-3 rounded-lg\">\n                                <span className=\"text-sm font-bold text-yellow-700\">ملاحظات: </span>\n                                <span className=\"text-yellow-900\">{violation.notes}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      )\n                    })}\n                    </div>\n                  )\n                })()}\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* الصفحة الرئيسية */}\n        {currentPage === 'home' && (\n        <div className=\"flex gap-6\">\n          {/* Sidebar */}\n          <div className=\"w-72 flex-shrink-0\">\n            <div className=\"bg-white rounded-2xl shadow-lg p-6 sticky top-6\">\n              <div className=\"flex items-center gap-2 mb-6\">\n                <Settings size={20} className=\"text-gray-600\" />\n                <h2 className=\"text-xl font-bold text-gray-800\">التصفية</h2>\n              </div>\n\n              <div className=\"space-y-6\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    الحالات الخاصة\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={homeSpecialStatusFilter}\n                      onChange={(e) => setHomeSpecialStatusFilter(e.target.value)}\n                      className=\"w-full px-4 py-3 bg-yellow-50 border-2 border-yellow-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-yellow-400 text-center font-bold\"\n                      data-testid=\"select-special-status-filter\"\n                    >\n                      <option value=\"all\">الكل</option>\n                      {specialStatuses.map(status => (\n                        <option key={status.id} value={status.id}>\n                          {status.name}\n                        </option>\n                      ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    المرحلة الدراسية\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={homeStageFilter}\n                      onChange={(e) => {\n                        setHomeStageFilter(e.target.value)\n                        setHomeGroupFilter('all')\n                      }}\n                      className=\"w-full px-4 py-3 bg-blue-50 border-2 border-blue-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-400 text-center font-bold\"\n                      data-testid=\"select-stage-filter\"\n                    >\n                      <option value=\"all\">الكل</option>\n                      {Array.from(new Set(groups.map(g => g.stage))).map(stage => (\n                        <option key={stage} value={stage}>\n                          {stage}\n                        </option>\n                      ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    المجموعات\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={homeGroupFilter}\n                      onChange={(e) => setHomeGroupFilter(e.target.value)}\n                      disabled={homeStageFilter === 'all'}\n                      className=\"w-full px-4 py-3 bg-blue-50 border-2 border-blue-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-400 text-center font-bold disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100\"\n                      data-testid=\"select-group-filter\"\n                    >\n                      <option value=\"all\">الكل</option>\n                      {groups\n                        .filter(g => homeStageFilter === 'all' || g.stage === homeStageFilter)\n                        .map(group => (\n                          <option key={group.id} value={group.id}>\n                            {group.name}\n                          </option>\n                        ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n                \n                {/* زر إعادة تعيين الفلاتر */}\n                {(homeSpecialStatusFilter !== 'all' || homeStageFilter !== 'all' || homeGroupFilter !== 'all') && (\n                  <button\n                    onClick={() => {\n                      setHomeSpecialStatusFilter('all')\n                      setHomeStageFilter('all')\n                      setHomeGroupFilter('all')\n                    }}\n                    className=\"w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg transition-all\"\n                    data-testid=\"button-reset-filters\"\n                  >\n                    إعادة تعيين الفلاتر\n                  </button>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* Main Area */}\n          <div className=\"flex-1\">\n            <div className=\"bg-gradient-to-br from-teal-500 to-emerald-500 rounded-2xl shadow-xl p-8\">\n              <div className=\"flex items-center gap-3 mb-6\">\n                <Search className=\"text-white\" size={28} />\n                <h2 className=\"text-2xl font-bold text-white\">استفسار عن طالب</h2>\n              </div>\n\n              <div className=\"bg-white rounded-xl shadow-lg p-2\">\n                <input\n                  type=\"text\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  placeholder=\"ابحث عن طالب بالاسم، السجل المدني، أو رقم الجوال...\"\n                  className=\"w-full px-6 py-4 text-lg border-none focus:outline-none rounded-lg\"\n                  data-testid=\"input-search\"\n                />\n              </div>\n            </div>\n\n            {/* Students List - منظم حسب المجموعات */}\n            <div className=\"mt-6 space-y-4\">\n              {filteredStudents.length === 0 ? (\n                <div className=\"bg-white rounded-2xl shadow-lg p-8 text-center\">\n                  <Users className=\"mx-auto text-gray-400 mb-4\" size={48} />\n                  <h3 className=\"text-xl font-bold text-gray-800 mb-2\">\n                    {students.length === 0 ? 'لا يوجد طلاب' : 'لا توجد نتائج'}\n                  </h3>\n                  <p className=\"text-gray-600\">\n                    {students.length === 0 \n                      ? 'قم بإضافة طلاب من خلال استيراد Excel أو إضافة يدوية'\n                      : 'لم يتم العثور على طلاب بهذا الاسم أو الرقم'}\n                  </p>\n                </div>\n              ) : (\n                Object.entries(studentsByGroup).map(([groupId, groupStudents], groupIndex) => {\n                  const group = groups.find(g => g.id === groupId)\n                  const colorIndex = groupIndex % groupColors.length\n                  const colors = groupColors[colorIndex]\n                  const isExpanded = expandedGroups.has(groupId)\n                  \n                  // الحصول على اسم المجموعة المخصصة من أول طالب\n                  const customGroupName = groupStudents.length > 0 && groupStudents[0].grade \n                    ? groupStudents[0].grade \n                    : null\n\n                  return (\n                    <div key={groupId} className=\"bg-white rounded-2xl shadow-lg overflow-hidden\">\n                      {/* رأس المجموعة */}\n                      <button\n                        onClick={() => toggleGroup(groupId)}\n                        className={`w-full bg-gradient-to-r ${colors.bg} p-4 flex items-center justify-between text-white hover:opacity-90 transition-opacity`}\n                        data-testid={`button-toggle-group-${groupId}`}\n                      >\n                        <h3 className=\"text-xl font-bold\">\n                          {group \n                            ? customGroupName \n                              ? `${group.stage} - ${customGroupName}`\n                              : `${group.stage}`\n                            : 'بدون مجموعة'}\n                        </h3>\n                        <div className=\"flex items-center gap-3\">\n                          <span className=\"bg-white bg-opacity-30 px-4 py-1 rounded-full text-sm font-bold\">\n                            {groupStudents.length} طالب\n                          </span>\n                          <ChevronDown \n                            size={24} \n                            className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}\n                          />\n                        </div>\n                      </button>\n\n                      {/* قائمة الطلاب داخل المجموعة */}\n                      {isExpanded && (\n                        <div className=\"divide-y divide-gray-100 pb-64\">\n                          {groupStudents.map((student) => {\n                            const specialStatus = student.specialStatusId \n                              ? specialStatuses.find(s => s.id === student.specialStatusId)\n                              : null\n                            const hasSpecialStatus = !!specialStatus\n\n                            return (\n                              <div \n                                key={student.id} \n                                className={`p-4 transition-colors ${\n                                  hasSpecialStatus ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50'\n                                }`}\n                                data-testid={`student-card-${student.id}`}\n                              >\n                                <div className=\"flex items-start justify-between\">\n                                  <div className=\"flex-1\">\n                                    <div className=\"flex items-center gap-3 mb-2\">\n                                      <h4 className=\"text-lg font-bold text-gray-900\">{student.name}</h4>\n                                      {specialStatus && (\n                                        <span className=\"bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold\">\n                                          {specialStatus.name}\n                                        </span>\n                                      )}\n                                    </div>\n                                    \n                                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2 text-sm text-gray-600 mb-3\">\n                                      <div>\n                                        <span className=\"font-semibold\">السجل:</span> {student.nationalId}\n                                      </div>\n                                      <div>\n                                        <span className=\"font-semibold\">الصف:</span> {student.grade || 'غير محدد'}\n                                      </div>\n                                      <div>\n                                        <span className=\"font-semibold\">المجموعة:</span> {group?.name || 'غير محدد'}\n                                      </div>\n                                      <div>\n                                        <span className=\"font-semibold\">جوال:</span> {student.phone || 'غير محدد'}\n                                      </div>\n                                      <div className=\"md:col-span-2\">\n                                        <span className=\"font-semibold\">ولي أمر:</span> {student.guardianPhone || 'غير محدد'}\n                                      </div>\n                                    </div>\n\n                                    {/* الإحصائيات */}\n                                    <div className=\"flex gap-4 text-xs\">\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-gray-700\">عدد الزيارات:</span>\n                                        <span className=\"bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold\">{student.visitCount || 0}</span>\n                                      </div>\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-gray-700\">عدد المخالفات:</span>\n                                        <span className=\"bg-red-100 text-red-700 px-2 py-1 rounded font-bold\">{student.violationCount || 0}</span>\n                                      </div>\n                                      <div className=\"flex items-center gap-1\">\n                                        <span className=\"font-semibold text-gray-700\">عدد الاستئذانات:</span>\n                                        <span className=\"bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold\">{student.permissionCount || 0}</span>\n                                      </div>\n                                    </div>\n                                  </div>\n\n                                  {/* Three Dots Menu */}\n                                  <div className=\"relative\">\n                                    <button\n                                      onClick={() => setOpenMenuStudentId(openMenuStudentId === student.id ? null : student.id)}\n                                      className=\"p-2 hover:bg-gray-100 rounded-lg transition-colors\"\n                                      data-testid={`button-menu-${student.id}`}\n                                    >\n                                      <MoreVertical size={20} className=\"text-gray-600\" />\n                                    </button>\n\n                                    {openMenuStudentId === student.id && (\n                                      <div className=\"absolute left-0 top-full mt-2 bg-white rounded-xl shadow-2xl border-2 border-gray-300 py-1\" style={{ minWidth: '300px', zIndex: 999999 }}>\n                                        <button\n                                          onClick={() => {\n                                            setSelectedStudent(student)\n                                            setShowAllowEntryModal(true)\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-green-50 transition-colors flex items-center gap-3\"\n                                          data-testid={`button-allow-entry-${student.id}`}\n                                        >\n                                          <CheckCircle size={20} className=\"text-green-600\" />\n                                          <span className=\"text-base font-bold text-gray-800\">السماح بدخول الفصل</span>\n                                        </button>\n\n                                        <button\n                                          onClick={() => {\n                                            setPrintStudent(student)\n                                            setShowPrintModal(true)\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3\"\n                                          data-testid={`button-print-${student.id}`}\n                                        >\n                                          <Printer size={20} className=\"text-blue-600\" />\n                                          <span className=\"text-base font-bold text-gray-800\">طباعة بيانات الطالب</span>\n                                        </button>\n\n                                        <button\n                                          onClick={() => {\n                                            const studentGroup = groups.find(g => g.id === student.groupId)\n                                            setEditStudentData({\n                                              name: student.name,\n                                              nationalId: student.nationalId,\n                                              phone: student.phone || '',\n                                              guardianPhone: student.guardianPhone || '',\n                                              grade: student.grade,\n                                              groupId: student.groupId || '',\n                                              specialStatusId: student.specialStatusId || '',\n                                            })\n                                            setSelectedStage(studentGroup?.stage || '')\n                                            setSelectedStudent(student)\n                                            setShowEditStudentModal(true)\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-yellow-50 transition-colors flex items-center gap-3\"\n                                          data-testid={`button-edit-${student.id}`}\n                                        >\n                                          <Edit size={20} className=\"text-yellow-600\" />\n                                          <span className=\"text-base font-bold text-gray-800\">تعديل بيانات الطالب</span>\n                                        </button>\n\n                                        <button\n                                          onClick={() => {\n                                            if (window.confirm(`هل أنت متأكد من حذف الطالب ${student.name}؟\\n\\nسيتم حذف جميع بيانات الطالب نهائياً ولا يمكن التراجع عن هذا الإجراء.`)) {\n                                              deleteStudent.mutate(student.id)\n                                            }\n                                            setOpenMenuStudentId(null)\n                                          }}\n                                          disabled={deleteStudent.isPending}\n                                          className=\"w-full text-right px-4 py-3 hover:bg-red-50 transition-colors flex items-center gap-3 disabled:opacity-50\"\n                                          data-testid={`button-delete-${student.id}`}\n                                        >\n                                          <Trash2 size={20} className=\"text-red-600\" />\n                                          <span className=\"text-base font-bold text-red-600\">\n                                            {deleteStudent.isPending ? 'جاري الحذف...' : 'حذف الطالب'}\n                                          </span>\n                                        </button>\n                                      </div>\n                                    )}\n                                  </div>\n                                </div>\n                              </div>\n                            )\n                          })}\n                        </div>\n                      )}\n                    </div>\n                  )\n                })\n              )}\n            </div>\n          </div>\n        </div>\n        )}\n      </div>\n\n      {/* Footer */}\n      <footer className=\"bg-white border-t border-gray-200 py-6 mt-12\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"text-center\">\n            <p className=\"text-gray-600 font-medium\">\n              تصميم وتطوير: الأستاذ وائل الفيفي\n            </p>\n            <a\n              href=\"https://wa.me/966558890902\"\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"text-blue-600 hover:text-blue-700 mt-1 inline-flex items-center gap-2 transition-colors cursor-pointer\"\n            >\n              <span>📱</span>\n              <span dir=\"ltr\" className=\"font-semibold\">0558890902</span>\n            </a>\n          </div>\n        </div>\n      </footer>\n\n      {/* Modal: إرسال للمعلم */}\n      {showSendToTeacherModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white flex items-center gap-3\">\n                <Send size={28} />\n                إرسال للمعلم\n              </h2>\n              <button\n                onClick={() => {\n                  setShowSendToTeacherModal(false)\n                  setSelectedTeacherForSend('')\n                  setSelectedStageForSend('')\n                  setSelectedGroupsForSend(new Set())\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-send-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n              {/* رسالة توضيحية */}\n              <div className=\"bg-blue-50 border-2 border-blue-200 rounded-lg p-4\">\n                <p className=\"text-blue-800 text-center\">\n                  سيتم إرسال بيانات الطلاب ذوي الحالات الخاصة في المجموعة المحددة إلى المعلم عبر واتساب\n                </p>\n              </div>\n\n              {/* اختر المعلم */}\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اختر المعلم <span className=\"text-red-500\">*</span>\n                </label>\n                <select\n                  value={selectedTeacherForSend}\n                  onChange={(e) => setSelectedTeacherForSend(e.target.value)}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right\"\n                  data-testid=\"select-teacher-for-send\"\n                >\n                  <option value=\"\">اختر المعلم</option>\n                  {teachers.map((teacher: any) => (\n                    <option key={teacher.id} value={teacher.id}>\n                      {teacher.name} - {teacher.specialization || 'غير محدد'}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              {/* اختر المرحلة */}\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اختر المرحلة <span className=\"text-red-500\">*</span>\n                </label>\n                <select\n                  value={selectedStageForSend}\n                  onChange={(e) => {\n                    setSelectedStageForSend(e.target.value)\n                    setSelectedGroupsForSend(new Set())\n                  }}\n                  className=\"w-full px-4 py-3 border-2 border-yellow-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right\"\n                  data-testid=\"select-stage-for-send\"\n                >\n                  <option value=\"\">اختر المرحلة</option>\n                  {Array.from(new Set(groups.map((g: any) => g.stage))).map((stage: string) => (\n                    <option key={stage} value={stage}>\n                      {stage}\n                    </option>\n                  ))}\n                </select>\n              </div>\n\n              {/* اختر المجموعة */}\n              {selectedStageForSend && (\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    اختر المجموعة <span className=\"text-red-500\">*</span>\n                  </label>\n                  <div className=\"space-y-3 max-h-64 overflow-y-auto border-2 border-gray-300 rounded-lg p-4\">\n                    {groups\n                      .filter((group: any) => group.stage === selectedStageForSend)\n                      .filter((group: any) => {\n                        const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                        return groupStudents.length > 0\n                      })\n                      .map((group: any) => {\n                        const groupStudents = students.filter(s => s.groupId === group.id && s.specialStatusId)\n                        const isChecked = selectedGroupsForSend.has(group.id)\n                        \n                        return (\n                          <div\n                            key={group.id}\n                            className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              id={`group-${group.id}`}\n                              checked={isChecked}\n                              onChange={(e) => {\n                                const newSet = new Set(selectedGroupsForSend)\n                                if (e.target.checked) {\n                                  newSet.add(group.id)\n                                } else {\n                                  newSet.delete(group.id)\n                                }\n                                setSelectedGroupsForSend(newSet)\n                              }}\n                              className=\"w-5 h-5 text-purple-600 border-purple-300 rounded focus:ring-purple-500\"\n                              data-testid={`checkbox-group-${group.id}`}\n                            />\n                            <label\n                              htmlFor={`group-${group.id}`}\n                              className=\"flex-1 text-right mr-3 cursor-pointer\"\n                            >\n                              <span className=\"font-semibold text-gray-900\">{group.name}</span>\n                              <span className=\"text-gray-500 mr-2\">({groupStudents.length} طالب)</span>\n                            </label>\n                          </div>\n                        )\n                      })}\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowSendToTeacherModal(false)\n                  setSelectedTeacherForSend('')\n                  setSelectedStageForSend('')\n                  setSelectedGroupsForSend(new Set())\n                }}\n                className=\"flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                data-testid=\"button-cancel-send\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!selectedTeacherForSend || !selectedStageForSend || selectedGroupsForSend.size === 0) {\n                    alert('الرجاء تحديد المعلم والمرحلة والمجموعات')\n                    return\n                  }\n\n                  const selectedTeacher = teachers.find((t: any) => t.id === selectedTeacherForSend)\n                  if (!selectedTeacher || !selectedTeacher.phone) {\n                    alert('المعلم المحدد لا يحتوي على رقم جوال')\n                    return\n                  }\n\n                  // جمع بيانات الطلاب من المجموعات المحددة\n                  const selectedStudents = students.filter(s => \n                    s.groupId && selectedGroupsForSend.has(s.groupId) && s.specialStatusId\n                  )\n\n                  if (selectedStudents.length === 0) {\n                    alert('لا يوجد طلاب ذوي حالات خاصة في المجموعات المحددة')\n                    return\n                  }\n\n                  // تنسيق الرسالة\n                  const selectedTeacherName = teachers.find((t: any) => t.id === selectedTeacherForSend)?.name || 'المعلم'\n                  \n                  let message = `*اسم المعلم المرسل له:* ${selectedTeacherName}\\n\\n`\n                  \n                  Array.from(selectedGroupsForSend).forEach(groupId => {\n                    const group = groups.find((g: any) => g.id === groupId)\n                    const groupStudents = selectedStudents.filter(s => s.groupId === groupId)\n                    \n                    if (groupStudents.length > 0) {\n                      message += `*${selectedStageForSend} (${group?.name})*\\n`\n                      message += `*الحالات الخاصة:*\\n`\n                      \n                      groupStudents.forEach((student, index) => {\n                        message += `${index + 1} - ${student.name}\\n`\n                      })\n                      message += '\\n'\n                    }\n                  })\n\n                  // إرسال عبر واتساب\n                  const phoneNumber = formatPhoneForWhatsApp(selectedTeacher.phone)\n                  if (!phoneNumber) {\n                    alert('رقم جوال المعلم غير صالح. يرجى التأكد من إدخال الرقم الصحيح.')\n                    return\n                  }\n                  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`\n                  window.open(whatsappUrl, '_blank')\n\n                  // إغلاق النافذة\n                  setShowSendToTeacherModal(false)\n                  setSelectedTeacherForSend('')\n                  setSelectedStageForSend('')\n                  setSelectedGroupsForSend(new Set())\n                }}\n                disabled={!selectedTeacherForSend || !selectedStageForSend || selectedGroupsForSend.size === 0}\n                className=\"flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                data-testid=\"button-confirm-send\"\n              >\n                <Send size={20} />\n                إرسال عبر واتساب\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: طباعة المجموعة - الحالات الخاصة */}\n      {showSpecialStatusPrintModal && selectedGroupForSpecialPrint && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-700 p-6 rounded-t-2xl flex items-center justify-between print:hidden\">\n              <h2 className=\"text-2xl font-bold text-white flex items-center gap-3\">\n                <Printer size={28} />\n                طباعة الحالات الخاصة\n              </h2>\n              <button\n                onClick={() => {\n                  setShowSpecialStatusPrintModal(false)\n                  setSelectedGroupForSpecialPrint(null)\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-special-print-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content - للطباعة */}\n            <div className=\"flex-1 overflow-y-auto p-8\">\n              {/* معلومات المدرسة والمعلم */}\n              <div className=\"text-center mb-6\">\n                <h1 className=\"text-2xl font-bold text-gray-900\">\n                  {profile?.schoolName || 'المدرسة'}\n                </h1>\n                <p className=\"text-lg text-gray-700 mt-2\">\n                  المعلم: {profile?.name || 'غير محدد'}\n                </p>\n              </div>\n\n              {/* عدد الطلاب */}\n              <div className=\"text-right mb-4\">\n                <p className=\"text-lg font-bold text-gray-900\">\n                  عدد الطلاب: {students.filter(s => s.groupId === selectedGroupForSpecialPrint.id && s.specialStatusId).length}\n                </p>\n              </div>\n\n              {/* الجدول */}\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse\">\n                  <thead>\n                    <tr className=\"bg-gradient-to-r from-purple-500 to-purple-600 text-white\">\n                      <th className=\"border border-purple-600 px-4 py-3 text-right font-bold\">الاسم</th>\n                      <th className=\"border border-purple-600 px-4 py-3 text-right font-bold\">السجل المدني</th>\n                      <th className=\"border border-purple-600 px-4 py-3 text-right font-bold\">جوال الطالب</th>\n                      <th className=\"border border-purple-600 px-4 py-3 text-right font-bold\">جوال ولي الأمر</th>\n                      <th className=\"border border-purple-600 px-4 py-3 text-right font-bold\">الحالة الخاصة</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {students\n                      .filter(s => s.groupId === selectedGroupForSpecialPrint.id && s.specialStatusId)\n                      .map((student, index) => {\n                        const specialStatus = specialStatuses.find(s => s.id === student.specialStatusId)\n                        return (\n                          <tr key={student.id} className={index % 2 === 0 ? 'bg-white' : 'bg-purple-50'}>\n                            <td className=\"border border-purple-300 px-4 py-3 text-right font-semibold text-gray-900\">\n                              {student.name}\n                            </td>\n                            <td className=\"border border-purple-300 px-4 py-3 text-right text-gray-700\">\n                              {student.nationalId}\n                            </td>\n                            <td className=\"border border-purple-300 px-4 py-3 text-right text-gray-700\" dir=\"ltr\">\n                              {student.phone || '-'}\n                            </td>\n                            <td className=\"border border-purple-300 px-4 py-3 text-right text-gray-700\" dir=\"ltr\">\n                              {student.guardianPhone || '-'}\n                            </td>\n                            <td className=\"border border-purple-300 px-4 py-3 text-right\">\n                              <span className=\"text-purple-700 font-semibold\">\n                                {showSpecialStatusColumn ? (specialStatus?.name || 'غير محدد') : 'لديه حالة خاصة'}\n                              </span>\n                            </td>\n                          </tr>\n                        )\n                      })}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3 print:hidden\">\n              <button\n                onClick={() => {\n                  setShowSpecialStatusPrintModal(false)\n                  setSelectedGroupForSpecialPrint(null)\n                }}\n                className=\"flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition-colors\"\n                data-testid=\"button-cancel-special-print\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => window.print()}\n                className=\"flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 rounded-lg transition-all shadow-md flex items-center justify-center gap-2\"\n                data-testid=\"button-confirm-special-print\"\n              >\n                <Printer size={20} />\n                طباعة\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إعدادات تسجيل الدخول */}\n      {showLoginSettingsModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-green-600 to-emerald-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Lock size={28} className=\"text-white\" />\n                <h2 className=\"text-2xl font-bold text-white\">إعدادات تسجيل الدخول</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowLoginSettingsModal(false)\n                  setNewUsername('admin')\n                  setNewPassword('')\n                  setConfirmPassword('')\n                  setLoginSettingsError('')\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-login-settings\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              <p className=\"text-gray-600 mb-6 text-center text-sm\">\n                يمكنك تغيير اسم المستخدم وكلمة المرور من هنا\n              </p>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    اسم المستخدم الجديد\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={newUsername}\n                    onChange={(e) => setNewUsername(e.target.value)}\n                    placeholder=\"admin\"\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                    data-testid=\"input-new-username\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    كلمة المرور الجديدة\n                  </label>\n                  <input\n                    type=\"password\"\n                    value={newPassword}\n                    onChange={(e) => setNewPassword(e.target.value)}\n                    placeholder=\"أدخل كلمة المرور الجديدة\"\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                    data-testid=\"input-new-password\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    تأكيد كلمة المرور\n                  </label>\n                  <input\n                    type=\"password\"\n                    value={confirmPassword}\n                    onChange={(e) => setConfirmPassword(e.target.value)}\n                    placeholder=\"أعد إدخال كلمة المرور\"\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                    data-testid=\"input-confirm-password\"\n                  />\n                </div>\n\n                {loginSettingsError && (\n                  <div className=\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-right text-sm\" data-testid=\"error-login-settings\">\n                    {loginSettingsError}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowLoginSettingsModal(false)\n                  setNewUsername('admin')\n                  setNewPassword('')\n                  setConfirmPassword('')\n                  setLoginSettingsError('')\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-login-settings\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={async () => {\n                  // التحقق من البيانات\n                  if (!newUsername || !newUsername.trim()) {\n                    setLoginSettingsError('الرجاء إدخال اسم المستخدم')\n                    return\n                  }\n                  if (!newPassword || !newPassword.trim()) {\n                    setLoginSettingsError('الرجاء إدخال كلمة المرور')\n                    return\n                  }\n                  if (newPassword !== confirmPassword) {\n                    setLoginSettingsError('كلمة المرور غير متطابقة')\n                    return\n                  }\n                  \n                  setLoginSettingsError('')\n                  \n                  try {\n                    await apiRequest('/api/update-login-credentials', 'POST', {\n                      currentUsername: 'admin',\n                      newUsername: newUsername,\n                      newPassword: newPassword\n                    })\n                    \n                    alert('✅ تم تحديث بيانات تسجيل الدخول بنجاح!')\n                    setShowLoginSettingsModal(false)\n                    setNewUsername('admin')\n                    setNewPassword('')\n                    setConfirmPassword('')\n                  } catch (error) {\n                    setLoginSettingsError('حدث خطأ أثناء تحديث البيانات')\n                  }\n                }}\n                className=\"flex-1 bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-bold py-3 rounded-lg transition-all shadow-md\"\n                data-testid=\"button-save-login-settings\"\n              >\n                حفظ التغييرات\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إعدادات الملف الشخصي */}\n      {showProfileSettingsModal && (\n        <ProfileSettings onClose={() => setShowProfileSettingsModal(false)} />\n      )}\n\n      {/* Modal: استيراد من Excel */}\n      {showExcelImportModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-green-600 to-emerald-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">استيراد من Excel</h2>\n              <button\n                onClick={() => setShowExcelImportModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-excel-import\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n              \n              {/* استيراد بيانات الطلاب */}\n              <div className=\"border-2 border-blue-200 rounded-2xl p-6 bg-blue-50\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-xl font-bold text-gray-800\">استيراد بيانات الطلاب</h3>\n                  <Users className=\"text-blue-600\" size={24} />\n                </div>\n\n                <div className=\"bg-white rounded-lg p-4 mb-4\">\n                  <h4 className=\"font-bold text-gray-700 mb-3\">الأعمدة المطلوبة:</h4>\n                  <ol className=\"space-y-2 text-sm text-gray-600\">\n                    <li><strong>اسم الطالب</strong> - اسم الطالب الكامل</li>\n                    <li><strong>السجل المدني</strong> - رقم الهوية الوطنية</li>\n                    <li><strong>الصف</strong> - مثال: الصف الأول الثانوي</li>\n                    <li><strong>المجموعة</strong> - اسم المجموعة، مثال: مجموعة 1</li>\n                    <li><strong>جوال الطالب</strong> - رقم جوال الطالب (اختياري)</li>\n                    <li><strong>جوال ولي الأمر</strong> - رقم جوال ولي الأمر (اختياري)</li>\n                    <li><strong>الحالة</strong> - نشط أو استئذان (اختياري)</li>\n                  </ol>\n                </div>\n\n                <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4\">\n                  <h4 className=\"font-bold text-gray-800 mb-2\">ملاحظات مهمة:</h4>\n                  <ul className=\"space-y-1 text-sm text-gray-700\">\n                    <li>• المجموعات غير موجودة إذا لم تكن موجودة</li>\n                    <li>• إذا كان السجل المدني موجود، يتم تحديث بيانات الطالب</li>\n                    <li>• عمود \"جوال\" وولي الأمر اختياري، يمكن إضافة \"جوال\" وولي الأمر أو \"جوال ولي الأمر\"</li>\n                  </ul>\n                </div>\n\n                <input\n                  type=\"file\"\n                  accept=\".xlsx,.xls\"\n                  id=\"students-file-input\"\n                  className=\"hidden\"\n                  data-testid=\"input-students-file\"\n                />\n                <label\n                  htmlFor=\"students-file-input\"\n                  className=\"w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 rounded-lg transition-all shadow-md cursor-pointer flex items-center justify-center gap-2\"\n                >\n                  <Download size={20} />\n                  <span>استيراد ملف الطلاب</span>\n                </label>\n              </div>\n\n              {/* استيراد بيانات المعلمين */}\n              <div className=\"border-2 border-orange-200 rounded-2xl p-6 bg-orange-50\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-xl font-bold text-gray-800\">استيراد بيانات المعلمين</h3>\n                  <GraduationCap className=\"text-orange-600\" size={24} />\n                </div>\n\n                <div className=\"bg-white rounded-lg p-4 mb-4\">\n                  <h4 className=\"font-bold text-gray-700 mb-3\">الأعمدة المطلوبة:</h4>\n                  <ol className=\"space-y-2 text-sm text-gray-600\">\n                    <li><strong>اسم المعلم</strong> - اسم المعلم الكامل</li>\n                    <li><strong>رقم جوال المعلم</strong> - رقم جوال المعلم</li>\n                    <li><strong>التخصص</strong> - مثال: رياضيات، علوم، لغة عربية (اختياري)</li>\n                  </ol>\n                </div>\n\n                <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4\">\n                  <h4 className=\"font-bold text-gray-800 mb-2\">ملاحظات مهمة:</h4>\n                  <ul className=\"space-y-1 text-sm text-gray-700\">\n                    <li>• إذا كان رقم الجوال موجود، يتم تحديث بيانات المعلم</li>\n                    <li>• يتم تخطي المعلمين المكررين في الملف</li>\n                  </ul>\n                </div>\n\n                <input\n                  type=\"file\"\n                  accept=\".xlsx,.xls\"\n                  id=\"teachers-file-input\"\n                  className=\"hidden\"\n                  data-testid=\"input-teachers-file\"\n                />\n                <label\n                  htmlFor=\"teachers-file-input\"\n                  className=\"w-full bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-bold py-4 rounded-lg transition-all shadow-md cursor-pointer flex items-center justify-center gap-2\"\n                >\n                  <Download size={20} />\n                  <span>استيراد ملف المعلمين</span>\n                </label>\n              </div>\n\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إعدادات القوائم */}\n      {showListSettingsModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-purple-600 to-purple-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إعدادات القوائم</h2>\n              <button\n                onClick={() => setShowListSettingsModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-list-settings-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              <p className=\"text-gray-600 mb-6 text-right\">\n                اختر الأقسام التي تريد إظهارها في الصفحة الرئيسية\n              </p>\n\n              <div className=\"space-y-4\">\n                {/* المجموعات */}\n                <label className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border-2 border-gray-200\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      checked={listSettings.showGroups}\n                      onChange={(e) => updateListSettings({ ...listSettings, showGroups: e.target.checked })}\n                      className=\"w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-groups\"\n                    />\n                    <Users className=\"text-blue-600\" size={20} />\n                    <span className=\"text-lg font-semibold text-gray-800\">المجموعات</span>\n                  </div>\n                </label>\n\n                {/* الحالات الخاصة */}\n                <label className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border-2 border-gray-200\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      checked={listSettings.showSpecialStatus}\n                      onChange={(e) => updateListSettings({ ...listSettings, showSpecialStatus: e.target.checked })}\n                      className=\"w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-special-status\"\n                    />\n                    <Star className=\"text-yellow-600\" size={20} />\n                    <span className=\"text-lg font-semibold text-gray-800\">الحالات الخاصة</span>\n                  </div>\n                </label>\n\n                {/* استقبال الطلاب */}\n                <label className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border-2 border-gray-200\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      checked={listSettings.showReception}\n                      onChange={(e) => updateListSettings({ ...listSettings, showReception: e.target.checked })}\n                      className=\"w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-reception\"\n                    />\n                    <UserCheck className=\"text-green-600\" size={20} />\n                    <span className=\"text-lg font-semibold text-gray-800\">استقبال الطلاب</span>\n                  </div>\n                </label>\n\n                {/* الاستئذان */}\n                <label className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border-2 border-gray-200\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      checked={listSettings.showPermissions}\n                      onChange={(e) => updateListSettings({ ...listSettings, showPermissions: e.target.checked })}\n                      className=\"w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-permissions\"\n                    />\n                    <Clock className=\"text-orange-600\" size={20} />\n                    <span className=\"text-lg font-semibold text-gray-800\">الاستئذان</span>\n                  </div>\n                </label>\n\n                {/* المخالفات */}\n                <label className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border-2 border-gray-200\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      checked={listSettings.showViolations}\n                      onChange={(e) => updateListSettings({ ...listSettings, showViolations: e.target.checked })}\n                      className=\"w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-violations\"\n                    />\n                    <AlertTriangle className=\"text-red-600\" size={20} />\n                    <span className=\"text-lg font-semibold text-gray-800\">المخالفات</span>\n                  </div>\n                </label>\n\n                {/* المعلمين */}\n                <label className=\"flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-all border-2 border-gray-200\">\n                  <div className=\"flex items-center gap-3\">\n                    <input\n                      type=\"checkbox\"\n                      checked={listSettings.showTeachers}\n                      onChange={(e) => updateListSettings({ ...listSettings, showTeachers: e.target.checked })}\n                      className=\"w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500\"\n                      data-testid=\"checkbox-show-teachers\"\n                    />\n                    <Users className=\"text-indigo-600\" size={20} />\n                    <span className=\"text-lg font-semibold text-gray-800\">المعلمين</span>\n                  </div>\n                </label>\n              </div>\n\n              {/* زر الإغلاق */}\n              <button\n                onClick={() => setShowListSettingsModal(false)}\n                className=\"w-full mt-6 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-4 rounded-lg transition-all shadow-md\"\n                data-testid=\"button-close-list-settings\"\n              >\n                حفظ وإغلاق\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إدارة المراحل والمجموعات */}\n      {showGroupsModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-teal-600 to-emerald-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إدارة المراحل والمجموعات</h2>\n              <button\n                onClick={() => setShowGroupsModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-groups-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              {/* إضافة مجموعة جديدة */}\n              <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6 mb-6\">\n                <h3 className=\"text-xl font-bold text-gray-800 mb-4\">إضافة مجموعة جديدة</h3>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n                  {/* الصف (المرحلة) */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                      الصف (المرحلة)\n                    </label>\n                    <select\n                      value={newGroupStage}\n                      onChange={(e) => setNewGroupStage(e.target.value)}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                      data-testid=\"select-group-stage\"\n                    >\n                      <option value=\"\">مثال: الصف الأول الثانوي</option>\n                      <option value=\"الصف الأول الابتدائي\">الصف الأول الابتدائي</option>\n                      <option value=\"الصف الثاني الابتدائي\">الصف الثاني الابتدائي</option>\n                      <option value=\"الصف الثالث الابتدائي\">الصف الثالث الابتدائي</option>\n                      <option value=\"الصف الرابع الابتدائي\">الصف الرابع الابتدائي</option>\n                      <option value=\"الصف الخامس الابتدائي\">الصف الخامس الابتدائي</option>\n                      <option value=\"الصف السادس الابتدائي\">الصف السادس الابتدائي</option>\n                      <option value=\"الصف الأول المتوسط\">الصف الأول المتوسط</option>\n                      <option value=\"الصف الثاني المتوسط\">الصف الثاني المتوسط</option>\n                      <option value=\"الصف الثالث المتوسط\">الصف الثالث المتوسط</option>\n                      <option value=\"الصف الأول الثانوي\">الصف الأول الثانوي</option>\n                      <option value=\"الصف الثاني الثانوي\">الصف الثاني الثانوي</option>\n                      <option value=\"الصف الثالث الثانوي\">الصف الثالث الثانوي</option>\n                    </select>\n                  </div>\n\n                  {/* اسم المجموعة */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                      اسم المجموعة\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={newGroupName}\n                      onChange={(e) => setNewGroupName(e.target.value)}\n                      placeholder=\"مثال: مجموعة 1\"\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-right\"\n                      data-testid=\"input-group-name\"\n                    />\n                  </div>\n                </div>\n\n                <button\n                  onClick={() => {\n                    if (newGroupName.trim() && newGroupStage) {\n                      addGroup.mutate({ name: newGroupName.trim(), stage: newGroupStage })\n                    }\n                  }}\n                  disabled={!newGroupName.trim() || !newGroupStage || addGroup.isPending}\n                  className=\"w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                  data-testid=\"button-add-group\"\n                >\n                  <Plus size={20} />\n                  <span>{addGroup.isPending ? 'جاري الإضافة...' : 'إضافة المجموعة'}</span>\n                </button>\n              </div>\n\n              {/* قائمة المجموعات الموجودة - مجمعة حسب المراحل */}\n              <div>\n                <h3 className=\"text-xl font-bold text-gray-800 mb-4\">المجموعات الحالية</h3>\n                {groups.length === 0 ? (\n                  <p className=\"text-gray-500 text-center py-8\">لا توجد مجموعات</p>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {/* تجميع المجموعات حسب المراحل */}\n                    {Object.entries(\n                      groups.reduce((acc: any, group: any) => {\n                        if (!acc[group.stage]) {\n                          acc[group.stage] = []\n                        }\n                        acc[group.stage].push(group)\n                        return acc\n                      }, {})\n                    ).map(([stage, stageGroups]: [string, any], stageIndex) => {\n                      // ألوان مختلفة للمراحل\n                      const stageColors = [\n                        'from-emerald-500 to-teal-500',\n                        'from-blue-500 to-cyan-500',\n                        'from-purple-500 to-pink-500',\n                        'from-orange-500 to-amber-500',\n                        'from-red-500 to-rose-500',\n                        'from-indigo-500 to-blue-500',\n                      ]\n                      const colorClass = stageColors[stageIndex % stageColors.length]\n                      \n                      // عدد الطلاب في هذه المرحلة\n                      const stageStudentCount = students.filter((s: any) => \n                        stageGroups.some((g: any) => g.id === s.groupId)\n                      ).length\n\n                      return (\n                        <div key={stage} className=\"space-y-2\">\n                          {/* عنوان المرحلة */}\n                          <div className={`bg-gradient-to-r ${colorClass} rounded-lg p-4 flex items-center justify-between shadow-lg`}>\n                            <div className=\"flex items-center gap-3\">\n                              <Users className=\"text-white\" size={24} />\n                              <h4 className=\"text-xl font-bold text-white\">{stage}</h4>\n                            </div>\n                            <span className=\"text-white text-sm font-medium\">\n                              {stageStudentCount} طالب\n                            </span>\n                          </div>\n\n                          {/* المجموعات في هذه المرحلة */}\n                          <div className=\"space-y-2 pr-4\">\n                            {stageGroups.map((group: any) => {\n                              const groupStudentCount = students.filter((s: any) => s.groupId === group.id).length\n                              \n                              return (\n                                <div\n                                  key={group.id}\n                                  className=\"bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg p-4 hover:border-green-300 transition-all\"\n                                >\n                                  <div className=\"flex items-center justify-between\">\n                                    <div className=\"flex-1\">\n                                      <p className=\"text-lg font-bold text-gray-800\">{group.name}</p>\n                                      <p className=\"text-sm text-gray-600\">{groupStudentCount} طالب</p>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <button\n                                        onClick={() => {\n                                          setSelectedGroup(group)\n                                          setEditGroupData({ name: group.name, stage: group.stage })\n                                          setShowEditGroupModal(true)\n                                        }}\n                                        className=\"text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition-all\"\n                                        data-testid={`button-edit-group-${group.id}`}\n                                      >\n                                        <Edit size={18} />\n                                      </button>\n                                      <button\n                                        onClick={() => {\n                                          setGroupToDelete(group)\n                                          setShowDeleteGroupConfirm(true)\n                                        }}\n                                        className=\"text-red-600 hover:bg-red-100 p-2 rounded-lg transition-all\"\n                                        data-testid={`button-delete-group-${group.id}`}\n                                      >\n                                        <Trash2 size={18} />\n                                      </button>\n                                    </div>\n                                  </div>\n                                </div>\n                              )\n                            })}\n                          </div>\n                        </div>\n                      )\n                    })}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إدارة الحالات الخاصة */}\n      {showSpecialStatusModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إدارة الحالات الخاصة</h2>\n              <button\n                onClick={() => setShowSpecialStatusModal(false)}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-modal\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              {/* قائمة الحالات الخاصة */}\n              <div className=\"space-y-3 mb-6\">\n                {specialStatuses.length === 0 ? (\n                  <p className=\"text-gray-500 text-center py-8\">لا توجد حالات خاصة</p>\n                ) : (\n                  specialStatuses.map(status => (\n                    <div\n                      key={status.id}\n                      className=\"flex items-center justify-between bg-gray-50 border-2 border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-all\"\n                    >\n                      <span className=\"text-lg font-medium text-gray-800\">{status.name}</span>\n                      <button\n                        onClick={() => deleteSpecialStatus.mutate(status.id)}\n                        disabled={deleteSpecialStatus.isPending}\n                        className=\"text-red-600 hover:bg-red-50 p-2 rounded-lg transition-all disabled:opacity-50\"\n                        data-testid={`button-delete-status-${status.id}`}\n                      >\n                        <Trash2 size={20} />\n                      </button>\n                    </div>\n                  ))\n                )}\n              </div>\n\n              {/* إضافة حالة جديدة */}\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اسم الحالة الخاصة\n                </label>\n                <input\n                  type=\"text\"\n                  value={newStatusName}\n                  onChange={(e) => setNewStatusName(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && newStatusName.trim()) {\n                      addSpecialStatus.mutate(newStatusName.trim())\n                    }\n                  }}\n                  placeholder=\"أضف حالة جديدة...\"\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right\"\n                  data-testid=\"input-new-status-name\"\n                />\n              </div>\n\n              <button\n                onClick={() => {\n                  if (newStatusName.trim()) {\n                    addSpecialStatus.mutate(newStatusName.trim())\n                  }\n                }}\n                disabled={!newStatusName.trim() || addSpecialStatus.isPending}\n                className=\"w-full mt-4 bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-4 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                data-testid=\"button-add-status\"\n              >\n                <Plus size={20} />\n                <span>{addSpecialStatus.isPending ? 'جاري الإضافة...' : 'إضافة'}</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: طباعة بيانات الطالب */}\n      {showPrintModal && printStudent && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-gray-700 to-gray-800 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between print:hidden\">\n              <div className=\"flex items-center gap-3\">\n                <Printer size={28} />\n                <h2 className=\"text-2xl font-bold\">طباعة بيانات الطالب</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowPrintModal(false)\n                  setPrintStudent(null)\n                }}\n                className=\"text-white hover:bg-gray-900 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-print\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content - Print Area */}\n            <div id=\"print-area\" className=\"flex-1 overflow-y-auto p-4\" style={{ pageBreakAfter: 'avoid' }}>\n              {/* Header للطباعة */}\n              <div className=\"text-center mb-3 border-b-2 border-blue-500 pb-2\">\n                <p className=\"text-sm text-gray-600\">المعلم: {profile?.logoUrl || teacherName || 'غير محدد'}</p>\n                <h1 className=\"text-xl font-bold text-gray-800 mt-1\">\n                  {profile?.schoolName || schoolName || 'المدرسة'}\n                </h1>\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  {profile?.name || systemDescription || 'نظام الإرشاد الطلابي'}\n                </p>\n              </div>\n\n              {/* بيانات الطالب الأساسية */}\n              <div className=\"bg-blue-50 border-2 border-blue-300 rounded-lg p-2 mb-2\" style={{ pageBreakInside: 'avoid' }}>\n                <h2 className=\"text-sm font-bold text-blue-800 mb-1 flex items-center gap-1\">\n                  <UserIcon size={14} />\n                  البيانات الأساسية\n                </h2>\n                <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.name}</span>\n                    <span className=\"text-gray-600\">اسم الطالب:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.nationalId}</span>\n                    <span className=\"text-gray-600\">السجل المدني:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.phone || 'غير محدد'}</span>\n                    <span className=\"text-gray-600\">جوال الطالب:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-blue-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.guardianPhone || 'غير محدد'}</span>\n                    <span className=\"text-gray-600\">جوال ولي الأمر:</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* المعلومات الدراسية */}\n              <div className=\"bg-green-50 border-2 border-green-300 rounded-lg p-2 mb-2\" style={{ pageBreakInside: 'avoid' }}>\n                <h2 className=\"text-sm font-bold text-green-800 mb-1 flex items-center gap-1\">\n                  <GraduationCap size={14} />\n                  المعلومات الدراسية\n                </h2>\n                <div className=\"grid grid-cols-2 gap-1 text-xs\">\n                  <div className=\"flex justify-between border-b border-green-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">{printStudent.grade}</span>\n                    <span className=\"text-gray-600\">الصف:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-green-200 pb-1\">\n                    <span className=\"font-bold text-gray-900\">\n                      {groups.find(g => g.id === printStudent.groupId)?.name || 'غير محدد'}\n                    </span>\n                    <span className=\"text-gray-600\">المجموعة:</span>\n                  </div>\n                  <div className=\"flex justify-between border-b border-green-200 pb-1 col-span-2\">\n                    <span className=\"font-bold text-gray-900\">\n                      {printStudent.specialStatusId \n                        ? specialStatuses.find(s => s.id === printStudent.specialStatusId)?.name \n                        : 'لا يوجد'}\n                    </span>\n                    <span className=\"text-gray-600\">الحالة الخاصة:</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* الإحصائيات */}\n              <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-2 mb-2\" style={{ pageBreakInside: 'avoid' }}>\n                <h2 className=\"text-sm font-bold text-yellow-800 mb-1 flex items-center gap-1\">\n                  <AlertCircle size={14} />\n                  إحصائيات الطالب\n                </h2>\n                <div className=\"grid grid-cols-3 gap-2 text-center\">\n                  <div className=\"bg-white rounded-lg p-1 border-2 border-blue-200\">\n                    <div className=\"text-xl font-bold text-blue-600\">\n                      {printStudent.visitCount || 0}\n                    </div>\n                    <div className=\"text-xs text-gray-600 font-semibold\">عدد مرات الزيارة</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-1 border-2 border-red-200\">\n                    <div className=\"text-xl font-bold text-red-600\">\n                      {printStudent.violationCount || 0}\n                    </div>\n                    <div className=\"text-xs text-gray-600 font-semibold\">عدد المخالفات</div>\n                  </div>\n                  <div className=\"bg-white rounded-lg p-1 border-2 border-green-200\">\n                    <div className=\"text-xl font-bold text-green-600\">\n                      {printStudent.permissionCount || 0}\n                    </div>\n                    <div className=\"text-xs text-gray-600 font-semibold\">عدد مرات الاستئذان</div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Footer للطباعة */}\n              <div className=\"mt-2 pt-2 border-t-2 border-gray-300 text-center text-xs text-gray-500\" style={{ pageBreakInside: 'avoid' }}>\n                <p>تاريخ الطباعة: {new Date().toLocaleDateString('ar-SA')}</p>\n                <p className=\"mt-1\">نظام الإرشاد الطلابي - جميع الحقوق محفوظة</p>\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3 print:hidden\">\n              <button\n                onClick={() => {\n                  setShowPrintModal(false)\n                  setPrintStudent(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-print\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => window.print()}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md flex items-center justify-center gap-2\"\n                data-testid=\"button-do-print\"\n              >\n                <Printer size={20} />\n                <span>طباعة</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تعديل/إضافة الطالب */}\n      {showEditStudentModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold\">{selectedStudent ? 'تعديل الطالب' : 'إضافة طالب جديد'}</h2>\n              <button\n                onClick={() => {\n                  setShowEditStudentModal(false)\n                  setSelectedStudent(null)\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-edit-student\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                {/* اسم الطالب */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    اسم الطالب\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.name}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, name: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"الياس\"\n                    data-testid=\"input-edit-student-name\"\n                  />\n                </div>\n\n                {/* السجل المدني */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    السجل المدني\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.nationalId}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, nationalId: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"12564646\"\n                    data-testid=\"input-edit-student-national-id\"\n                  />\n                </div>\n\n                {/* جوال الطالب */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    جوال الطالب\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.phone}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, phone: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"555555465\"\n                    data-testid=\"input-edit-student-phone\"\n                  />\n                </div>\n\n                {/* جوال ولي الأمر */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    جوال ولي الأمر\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={editStudentData.guardianPhone}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, guardianPhone: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    placeholder=\"565464644\"\n                    data-testid=\"input-edit-student-guardian-phone\"\n                  />\n                </div>\n\n                {/* الصف */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    الصف\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={selectedStage}\n                      onChange={(e) => {\n                        setSelectedStage(e.target.value)\n                        // إعادة تعيين المجموعة عند تغيير الصف\n                        setEditStudentData({ \n                          ...editStudentData, \n                          groupId: '',\n                          grade: ''\n                        })\n                      }}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                      data-testid=\"select-edit-student-stage\"\n                    >\n                      <option value=\"\">-- اختر الصف --</option>\n                      {/* عرض المراحل الفريدة فقط */}\n                      {Array.from(new Set(groups.map((g: any) => g.stage))).map((stage: string) => (\n                        <option key={stage} value={stage}>\n                          {stage}\n                        </option>\n                      ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n\n                {/* المجموعة */}\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                    المجموعة\n                  </label>\n                  <div className=\"relative\">\n                    <select\n                      value={editStudentData.groupId}\n                      onChange={(e) => {\n                        const selectedGroup = groups.find((g: any) => g.id === e.target.value)\n                        setEditStudentData({ \n                          ...editStudentData, \n                          groupId: e.target.value,\n                          grade: selectedGroup?.name || ''\n                        })\n                      }}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                      data-testid=\"select-edit-student-group\"\n                      disabled={!selectedStage}\n                    >\n                      <option value=\"\">-- اختر المجموعة --</option>\n                      {/* عرض فقط المجموعات التي تطابق المرحلة المختارة */}\n                      {groups\n                        .filter((group: any) => group.stage === selectedStage)\n                        .map((group: any) => (\n                          <option key={group.id} value={group.id}>\n                            {group.name}\n                          </option>\n                        ))}\n                    </select>\n                    <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                  </div>\n                </div>\n              </div>\n\n              {/* الحالة الخاصة (اختياري) */}\n              <div className=\"mt-4\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  الحالة الخاصة (اختياري)\n                </label>\n                <div className=\"relative\">\n                  <select\n                    value={editStudentData.specialStatusId}\n                    onChange={(e) => setEditStudentData({ ...editStudentData, specialStatusId: e.target.value })}\n                    className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                    data-testid=\"select-edit-student-special-status\"\n                  >\n                    <option value=\"\">بدون حالة خاصة</option>\n                    {specialStatuses.map(status => (\n                      <option key={status.id} value={status.id}>\n                        {status.name}\n                      </option>\n                    ))}\n                  </select>\n                  <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                </div>\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowEditStudentModal(false)\n                  setSelectedStudent(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-edit-student\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!editStudentData.name.trim() || !editStudentData.nationalId.trim()) {\n                    alert('الرجاء إدخال اسم الطالب والسجل المدني')\n                    return\n                  }\n\n                  const studentData = {\n                    name: editStudentData.name,\n                    nationalId: editStudentData.nationalId,\n                    phone: editStudentData.phone || '',\n                    guardianPhone: editStudentData.guardianPhone,\n                    grade: editStudentData.grade,\n                    groupId: editStudentData.groupId || null,\n                    specialStatusId: editStudentData.specialStatusId || null,\n                  }\n\n                  if (selectedStudent) {\n                    // تعديل طالب موجود\n                    updateStudent.mutate({\n                      id: selectedStudent.id,\n                      data: studentData\n                    })\n                  } else {\n                    // إضافة طالب جديد\n                    createStudent.mutate(studentData)\n                  }\n                }}\n                disabled={updateStudent.isPending || createStudent.isPending}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-save-edit-student\"\n              >\n                {updateStudent.isPending || createStudent.isPending \n                  ? 'جاري الحفظ...' \n                  : selectedStudent ? 'تحديث الطالب' : 'حفظ الطالب'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: السماح بدخول الفصل */}\n      {showAllowEntryModal && selectedStudent && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <CheckCircle size={28} />\n                <h2 className=\"text-2xl font-bold\">السماح بدخول الفصل</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowAllowEntryModal(false)\n                  setSelectedStudent(null)\n                  setSelectedTeacherId('')\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-allow-entry\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-6 space-y-6\">\n              {/* معلومات الطالب */}\n              <div className=\"bg-blue-50 border-2 border-blue-200 rounded-xl p-4\">\n                <h3 className=\"text-lg font-bold text-gray-800 mb-3 text-right\">معلومات الطالب:</h3>\n                <div className=\"space-y-2 text-right\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">{selectedStudent.name}</span>\n                    <span className=\"text-gray-600\">الاسم:</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">{selectedStudent.nationalId}</span>\n                    <span className=\"text-gray-600\">السجل المدني:</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">\n                      {groups.find(g => g.id === selectedStudent.groupId)?.name || '-'}\n                    </span>\n                    <span className=\"text-gray-600\">الصف:</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-900 font-semibold\">-</span>\n                    <span className=\"text-gray-600\">المجموعة:</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* ملاحظة */}\n              <div className=\"bg-gray-50 border border-gray-200 rounded-xl p-4 text-center\">\n                <p className=\"text-gray-700\">سيتم إرسال رسالة للسماح بدخول الطالب للفصل إلى المعلم المختار عبر واتساب</p>\n              </div>\n\n              {/* اختر المعلم */}\n              <div>\n                <label className=\"block text-lg font-bold text-gray-800 mb-3 text-right\">اختر المعلم</label>\n                <div className=\"relative\">\n                  <select\n                    value={selectedTeacherId}\n                    onChange={(e) => setSelectedTeacherId(e.target.value)}\n                    className=\"w-full px-4 py-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-yellow-500 text-center font-bold text-lg\"\n                    data-testid=\"select-teacher-allow-entry\"\n                  >\n                    <option value=\"\">-- اختر المعلم --</option>\n                    {teachers.map((teacher: any) => (\n                      <option key={teacher.id} value={teacher.id}>\n                        {teacher.name}\n                      </option>\n                    ))}\n                  </select>\n                  <ChevronDown className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none\" size={20} />\n                </div>\n              </div>\n\n              {/* معاينة الرسالة */}\n              {selectedTeacherId && (\n                <div className=\"bg-gray-50 border border-gray-300 rounded-xl p-4\">\n                  <h3 className=\"text-lg font-bold text-gray-800 mb-3 text-right\">معاينة الرسالة:</h3>\n                  <div className=\"bg-white border border-gray-200 rounded-lg p-4 text-right space-y-1\">\n                    <p className=\"flex items-center gap-2 text-blue-600 font-bold\">\n                      <CheckCircle size={18} />\n                      السماح بدخول الطالب للفصل\n                    </p>\n                    <p>\n                      <span className=\"text-gray-700\">اسم الطالب: </span>\n                      <span className=\"font-bold text-gray-900\">{selectedStudent.name}</span>\n                    </p>\n                    <p>\n                      <span className=\"text-gray-700\">المرسل: </span>\n                      <span className=\"font-bold text-gray-900\">\n                        {profile?.name || teacherName} - {teacherPhone}\n                      </span>\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowAllowEntryModal(false)\n                  setSelectedStudent(null)\n                  setSelectedTeacherId('')\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-allow-entry\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!selectedTeacherId) {\n                    alert('الرجاء اختيار المعلم')\n                    return\n                  }\n\n                  const selectedTeacher = teachers.find((t: any) => t.id === selectedTeacherId)\n                  if (!selectedTeacher || !selectedTeacher.phone) {\n                    alert('رقم جوال المعلم غير متوفر')\n                    return\n                  }\n\n                  // بناء رسالة واتساب\n                  const message = `📚 *السماح بدخول الطالب للفصل*\\n\\nاسم الطالب: *${selectedStudent.name}*\\n\\nالمرسل: ${profile?.name || teacherName} - ${teacherPhone}`\n                  \n                  const phoneNumber = formatPhoneForWhatsApp(selectedTeacher.phone)\n                  if (!phoneNumber) {\n                    alert('رقم جوال المعلم غير صالح. يرجى التأكد من إدخال الرقم الصحيح.')\n                    return\n                  }\n                  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`\n                  window.open(whatsappUrl, '_blank')\n\n                  setShowAllowEntryModal(false)\n                  setSelectedStudent(null)\n                  setSelectedTeacherId('')\n                }}\n                disabled={!selectedTeacherId}\n                className=\"flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                data-testid=\"button-send-whatsapp\"\n              >\n                <span>إرسال عبر واتساب</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: إضافة معلم */}\n      {showAddTeacherModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">إضافة معلم جديد</h2>\n              <button\n                onClick={() => {\n                  setShowAddTeacherModal(false)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-add-teacher\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Form */}\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  اسم المعلم\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.name}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"أدخل اسم المعلم\"\n                  data-testid=\"input-teacher-name\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  التخصص / المادة\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.specialization}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, specialization: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"مثال: رياضيات، فيزياء، لغة عربية\"\n                  data-testid=\"input-teacher-specialization\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  رقم الجوال\n                </label>\n                <input\n                  type=\"tel\"\n                  value={teacherFormData.phone}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, phone: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"05XXXXXXXX\"\n                  dir=\"ltr\"\n                  data-testid=\"input-teacher-phone\"\n                />\n              </div>\n            </div>\n\n            {/* Actions */}\n            <div className=\"p-6 pt-0 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowAddTeacherModal(false)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-add-teacher\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!teacherFormData.name.trim()) {\n                    alert('الرجاء إدخال اسم المعلم')\n                    return\n                  }\n                  addTeacher.mutate({\n                    name: teacherFormData.name.trim(),\n                    phone: teacherFormData.phone.trim() || null,\n                    specialization: teacherFormData.specialization.trim() || null,\n                  })\n                }}\n                disabled={addTeacher.isPending || !teacherFormData.name.trim()}\n                className=\"flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-submit-add-teacher\"\n              >\n                {addTeacher.isPending ? 'جاري الإضافة...' : 'إضافة المعلم'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تعديل معلم */}\n      {showEditTeacherModal && selectedTeacher && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-yellow-500 to-yellow-600 p-6 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">تعديل بيانات المعلم</h2>\n              <button\n                onClick={() => {\n                  setShowEditTeacherModal(false)\n                  setSelectedTeacher(null)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all\"\n                data-testid=\"button-close-edit-teacher\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Form */}\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  اسم المعلم\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.name}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent\"\n                  placeholder=\"أدخل اسم المعلم\"\n                  data-testid=\"input-edit-teacher-name\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  التخصص / المادة\n                </label>\n                <input\n                  type=\"text\"\n                  value={teacherFormData.specialization}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, specialization: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent\"\n                  placeholder=\"مثال: رياضيات، فيزياء، لغة عربية\"\n                  data-testid=\"input-edit-teacher-specialization\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  رقم الجوال\n                </label>\n                <input\n                  type=\"tel\"\n                  value={teacherFormData.phone}\n                  onChange={(e) => setTeacherFormData({ ...teacherFormData, phone: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent\"\n                  placeholder=\"05XXXXXXXX\"\n                  dir=\"ltr\"\n                  data-testid=\"input-edit-teacher-phone\"\n                />\n              </div>\n            </div>\n\n            {/* Actions */}\n            <div className=\"p-6 pt-0 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowEditTeacherModal(false)\n                  setSelectedTeacher(null)\n                  setTeacherFormData({ name: '', phone: '', specialization: '' })\n                }}\n                className=\"flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-edit-teacher\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (!teacherFormData.name.trim()) {\n                    alert('الرجاء إدخال اسم المعلم')\n                    return\n                  }\n                  updateTeacher.mutate({\n                    id: selectedTeacher.id,\n                    data: {\n                      name: teacherFormData.name.trim(),\n                      phone: teacherFormData.phone.trim() || null,\n                      specialization: teacherFormData.specialization.trim() || null,\n                    },\n                  })\n                }}\n                disabled={updateTeacher.isPending || !teacherFormData.name.trim()}\n                className=\"flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-submit-edit-teacher\"\n              >\n                {updateTeacher.isPending ? 'جاري التحديث...' : 'حفظ التعديلات'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تعديل المجموعة */}\n      {showEditGroupModal && selectedGroup && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold\">تعديل المجموعة</h2>\n              <button\n                onClick={() => {\n                  setShowEditGroupModal(false)\n                  setSelectedGroup(null)\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-edit-group\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  اسم المجموعة\n                </label>\n                <input\n                  type=\"text\"\n                  value={editGroupData.name}\n                  onChange={(e) => setEditGroupData({ ...editGroupData, name: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                  placeholder=\"مثال: الأول الابتدائي\"\n                  data-testid=\"input-edit-group-name\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2 text-right\">\n                  المرحلة الدراسية\n                </label>\n                <input\n                  type=\"text\"\n                  value={editGroupData.stage}\n                  onChange={(e) => setEditGroupData({ ...editGroupData, stage: e.target.value })}\n                  className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right\"\n                  placeholder=\"مثال: الابتدائي\"\n                  data-testid=\"input-edit-group-stage\"\n                />\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowEditGroupModal(false)\n                  setSelectedGroup(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-edit-group\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  if (editGroupData.name.trim() && editGroupData.stage.trim()) {\n                    updateGroup.mutate({\n                      id: selectedGroup.id,\n                      data: {\n                        name: editGroupData.name.trim(),\n                        stage: editGroupData.stage.trim()\n                      }\n                    })\n                  }\n                }}\n                disabled={!editGroupData.name.trim() || !editGroupData.stage.trim() || updateGroup.isPending}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-save-edit-group\"\n              >\n                {updateGroup.isPending ? 'جاري التحديث...' : 'حفظ التعديلات'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: فلتر الزيارات بالتاريخ */}\n      {showDateFilterModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Clock size={24} />\n                <h2 className=\"text-2xl font-bold\">فلتر بالتاريخ</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowDateFilterModal(false)\n                  setDateFilterError('')\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-date-filter\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"p-6 space-y-4\">\n              <p className=\"text-gray-700 text-center mb-4\">\n                اختر التاريخ لعرض زيارات ذلك اليوم\n              </p>\n              \n              {/* Date Picker */}\n              <div className=\"space-y-3\">\n                <label className=\"block text-right font-bold text-gray-700\">\n                  اختر التاريخ من التقويم:\n                </label>\n                <input\n                  type=\"date\"\n                  onChange={(e) => {\n                    if (e.target.value) {\n                      // Parse date locally to avoid timezone issues\n                      const [year, month, day] = e.target.value.split('-').map(Number)\n                      const selectedDate = new Date(year, month - 1, day)\n                      \n                      // Convert to Hijri with Arabic locale\n                      let hijriDate = selectedDate.toLocaleDateString('ar-SA-u-ca-islamic', {\n                        year: 'numeric',\n                        month: '2-digit',\n                        day: '2-digit'\n                      })\n                      \n                      // Normalize to ASCII digits for comparison\n                      const normalizeDigits = (str: string) => {\n                        return str.replace(/[٠-٩]/g, (d) => \n                          String.fromCharCode(d.charCodeAt(0) - 1632 + 48)\n                        )\n                      }\n                      \n                      hijriDate = normalizeDigits(hijriDate)\n                      \n                      // Check if any visits match this date\n                      const matchingVisits = studentVisits.filter((v: any) => {\n                        const normalizedVisitDate = normalizeDigits(v.visitDate)\n                        return normalizedVisitDate === hijriDate\n                      })\n                      \n                      if (matchingVisits.length > 0) {\n                        setFilterDate(matchingVisits[0].visitDate)\n                        setDateFilterError('')\n                        setShowDateFilterModal(false)\n                      } else {\n                        // Show feedback but keep modal open\n                        setDateFilterError(`لا توجد زيارات في تاريخ ${hijriDate}. جرب تاريخ آخر أو اختر من القائمة أدناه.`)\n                      }\n                    }\n                  }}\n                  className=\"w-full p-3 border-2 border-gray-300 rounded-lg text-lg\"\n                  style={{ direction: 'ltr' }}\n                  data-testid=\"input-date-picker\"\n                />\n                \n                {/* رسالة الخطأ */}\n                {dateFilterError && (\n                  <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-right\" data-testid=\"error-no-visits-found\">\n                    <p className=\"text-yellow-800 font-semibold\">{dateFilterError}</p>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex items-center gap-2 my-4\">\n                <div className=\"flex-1 h-px bg-gray-300\"></div>\n                <span className=\"text-gray-500 text-sm\">أو اختر من التواريخ المتاحة</span>\n                <div className=\"flex-1 h-px bg-gray-300\"></div>\n              </div>\n              \n              {/* قائمة التواريخ المتاحة */}\n              <div className=\"max-h-64 overflow-y-auto space-y-2\">\n                {Array.from(new Set(studentVisits.map((v: any) => v.visitDate))).sort().reverse().map((date: string) => {\n                  const visitsCount = studentVisits.filter((v: any) => v.visitDate === date).length\n                  return (\n                    <button\n                      key={date}\n                      onClick={() => {\n                        setFilterDate(date)\n                        setShowDateFilterModal(false)\n                      }}\n                      className={`w-full p-4 rounded-lg text-right transition-all border-2 ${\n                        filterDate === date\n                          ? 'bg-blue-50 border-blue-500 text-blue-900'\n                          : 'bg-gray-50 border-gray-200 hover:bg-gray-100'\n                      }`}\n                      data-testid={`date-option-${date}`}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className=\"font-bold text-lg\">{date}</div>\n                          <div className=\"text-sm text-gray-600 mt-1\">\n                            {visitsCount} {visitsCount === 1 ? 'زيارة' : visitsCount === 2 ? 'زيارتان' : 'زيارات'}\n                          </div>\n                        </div>\n                        {filterDate === date && (\n                          <CheckCircle size={24} className=\"text-blue-600\" />\n                        )}\n                      </div>\n                    </button>\n                  )\n                })}\n              </div>\n\n              {filterDate && (\n                <button\n                  onClick={() => {\n                    setFilterDate('')\n                    setShowDateFilterModal(false)\n                  }}\n                  className=\"w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                  data-testid=\"button-clear-filter\"\n                >\n                  إلغاء الفلتر وعرض الكل\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: فلتر الاستئذانات بالتاريخ */}\n      {showPermissionDateFilter && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            <div className=\"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Clock size={24} />\n                <h2 className=\"text-2xl font-bold\">فلتر الاستئذانات بالتاريخ</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowPermissionDateFilter(false)\n                  setPermissionDateFilterError('')\n                }}\n                className=\"text-white hover:bg-orange-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-permission-date-filter\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-4\">\n              <p className=\"text-gray-700 text-center mb-4\">\n                اختر التاريخ لعرض استئذانات ذلك اليوم\n              </p>\n              \n              <div className=\"space-y-3\">\n                <label className=\"block text-right font-bold text-gray-700\">\n                  اختر التاريخ من التقويم:\n                </label>\n                <input\n                  type=\"date\"\n                  onChange={(e) => {\n                    if (e.target.value) {\n                      // حفظ التاريخ بصيغة ISO الميلادية مباشرة للمقارنة\n                      setPermissionFilterDate(e.target.value)\n                      setPermissionDateFilterError('')\n                      setShowPermissionDateFilter(false)\n                    }\n                  }}\n                  className=\"w-full p-3 border-2 border-gray-300 rounded-lg text-lg\"\n                  style={{ direction: 'ltr' }}\n                  data-testid=\"input-permission-date-picker\"\n                />\n                \n                {permissionDateFilterError && (\n                  <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-right\" data-testid=\"error-no-permissions-found\">\n                    <p className=\"text-yellow-800 font-semibold\">{permissionDateFilterError}</p>\n                  </div>\n                )}\n              </div>\n\n              {permissionFilterDate && (\n                <button\n                  onClick={() => {\n                    setPermissionFilterDate('')\n                    setShowPermissionDateFilter(false)\n                  }}\n                  className=\"w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                  data-testid=\"button-clear-permission-filter\"\n                >\n                  إلغاء الفلتر وعرض الكل\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: فلتر المخالفات بالتاريخ */}\n      {showViolationDateFilter && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            <div className=\"bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Clock size={24} />\n                <h2 className=\"text-2xl font-bold\">فلتر المخالفات بالتاريخ</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowViolationDateFilter(false)\n                  setViolationDateFilterError('')\n                }}\n                className=\"text-white hover:bg-red-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-violation-date-filter\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-4\">\n              <p className=\"text-gray-700 text-center mb-4\">\n                اختر التاريخ لعرض مخالفات ذلك اليوم\n              </p>\n              \n              <div className=\"space-y-3\">\n                <label className=\"block text-right font-bold text-gray-700\">\n                  اختر التاريخ من التقويم:\n                </label>\n                <input\n                  type=\"date\"\n                  onChange={(e) => {\n                    if (e.target.value) {\n                      // حفظ التاريخ بصيغة ISO الميلادية مباشرة للمقارنة\n                      setViolationFilterDate(e.target.value)\n                      setViolationDateFilterError('')\n                      setShowViolationDateFilter(false)\n                    }\n                  }}\n                  className=\"w-full p-3 border-2 border-gray-300 rounded-lg text-lg\"\n                  style={{ direction: 'ltr' }}\n                  data-testid=\"input-violation-date-picker\"\n                />\n                \n                {violationDateFilterError && (\n                  <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-right\" data-testid=\"error-no-violations-found\">\n                    <p className=\"text-yellow-800 font-semibold\">{violationDateFilterError}</p>\n                  </div>\n                )}\n              </div>\n\n              {violationFilterDate && (\n                <button\n                  onClick={() => {\n                    setViolationFilterDate('')\n                    setShowViolationDateFilter(false)\n                  }}\n                  className=\"w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                  data-testid=\"button-clear-violation-filter\"\n                >\n                  إلغاء الفلتر وعرض الكل\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: تأكيد حذف المجموعة */}\n      {showDeleteGroupConfirm && groupToDelete && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold\">تأكيد الحذف</h2>\n              <button\n                onClick={() => {\n                  setShowDeleteGroupConfirm(false)\n                  setGroupToDelete(null)\n                }}\n                className=\"text-white hover:bg-red-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-delete-confirm\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"p-6\">\n              <div className=\"flex flex-col items-center text-center mb-6\">\n                <div className=\"bg-red-100 text-red-600 p-4 rounded-full mb-4\">\n                  <AlertTriangle size={48} />\n                </div>\n                <h3 className=\"text-xl font-bold text-gray-900 mb-2\">\n                  هل أنت متأكد من حذف هذه المجموعة؟\n                </h3>\n                <p className=\"text-gray-700 mb-4\">\n                  <span className=\"font-bold text-red-600\">{groupToDelete.stage} - {groupToDelete.name}</span>\n                </p>\n                \n                {(() => {\n                  const studentsInGroup = students.filter(s => s.groupId === groupToDelete.id)\n                  if (studentsInGroup.length > 0) {\n                    return (\n                      <div className=\"bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 w-full\">\n                        <p className=\"text-yellow-900 font-bold mb-2\">\n                          ⚠️ تحذير: هذه المجموعة تحتوي على {studentsInGroup.length} طالب/طلاب\n                        </p>\n                        <p className=\"text-yellow-800 text-sm\">\n                          سيتم نقل الطلاب إلى \"بدون مجموعة\" ولن يتم حذفهم\n                        </p>\n                      </div>\n                    )\n                  }\n                  return null\n                })()}\n              </div>\n            </div>\n\n            {/* Footer */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3\">\n              <button\n                onClick={() => {\n                  setShowDeleteGroupConfirm(false)\n                  setGroupToDelete(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-delete-group\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => {\n                  deleteGroup.mutate(groupToDelete.id)\n                  setShowDeleteGroupConfirm(false)\n                  setGroupToDelete(null)\n                }}\n                disabled={deleteGroup.isPending}\n                className=\"flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 rounded-lg transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed\"\n                data-testid=\"button-confirm-delete-group\"\n              >\n                {deleteGroup.isPending ? 'جاري الحذف...' : 'نعم، احذف المجموعة'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Modal: طباعة المجموعة */}\n      {showGroupPrintModal && selectedGroupForPrint && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 print:bg-white print:block print:relative print:p-0\" dir=\"rtl\">\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col print:max-h-none print:shadow-none print:rounded-none print:max-w-none\">\n            {/* Header */}\n            <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between print:hidden\">\n              <div className=\"flex items-center gap-3\">\n                <Printer size={28} />\n                <h2 className=\"text-2xl font-bold\">طباعة بيانات المجموعة</h2>\n              </div>\n              <button\n                onClick={() => {\n                  setShowGroupPrintModal(false)\n                  setSelectedGroupForPrint(null)\n                }}\n                className=\"text-white hover:bg-blue-700 rounded-lg p-2 transition-all\"\n                data-testid=\"button-close-group-print\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            {/* Content */}\n            <div className=\"flex-1 overflow-y-auto p-8 print:overflow-visible print:p-4\">\n              {/* Header للطباعة */}\n              <div className=\"mb-6 text-center\">\n                <h1 className=\"text-3xl font-bold text-blue-600 mb-2\">\n                  {profile?.schoolName || 'المدرسة'}\n                </h1>\n                <h2 className=\"text-xl font-semibold text-gray-700 mb-1\">\n                  {selectedGroupForPrint.stage} - {selectedGroupForPrint.name}\n                </h2>\n                <p className=\"text-gray-600\">\n                  المعلم: {profile?.name || 'غير محدد'}\n                </p>\n                <p className=\"text-sm text-gray-500 mt-2\">\n                  تاريخ الطباعة: {new Date().toLocaleDateString('ar-SA')}\n                </p>\n              </div>\n\n              {/* الجدول */}\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border-collapse\">\n                  <thead>\n                    <tr className=\"bg-gradient-to-r from-blue-500 to-blue-600 text-white\">\n                      <th className=\"px-4 py-3 text-right font-bold border border-blue-400\">الاسم</th>\n                      <th className=\"px-4 py-3 text-right font-bold border border-blue-400\">السجل المدني</th>\n                      <th className=\"px-4 py-3 text-right font-bold border border-blue-400\">جوال الطالب</th>\n                      <th className=\"px-4 py-3 text-right font-bold border border-blue-400\">جوال ولي الأمر</th>\n                      <th className=\"px-4 py-3 text-right font-bold border border-blue-400\">الحالة الخاصة</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {students\n                      .filter(s => s.groupId === selectedGroupForPrint.id)\n                      .map((student, index) => {\n                        const specialStatus = specialStatuses.find(ss => ss.id === student.specialStatusId)\n                        return (\n                          <tr\n                            key={student.id}\n                            className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}\n                            data-testid={`print-row-${student.id}`}\n                          >\n                            <td className=\"px-4 py-3 border border-gray-300\">{student.name}</td>\n                            <td className=\"px-4 py-3 border border-gray-300\" dir=\"ltr\">{student.nationalId}</td>\n                            <td className=\"px-4 py-3 border border-gray-300\" dir=\"ltr\">{student.phone || '-'}</td>\n                            <td className=\"px-4 py-3 border border-gray-300\" dir=\"ltr\">{student.guardianPhone || '-'}</td>\n                            <td className=\"px-4 py-3 border border-gray-300\">\n                              {specialStatus ? specialStatus.name : '-'}\n                            </td>\n                          </tr>\n                        )\n                      })}\n                    {students.filter(s => s.groupId === selectedGroupForPrint.id).length === 0 && (\n                      <tr>\n                        <td colSpan={5} className=\"px-4 py-8 text-center text-gray-500 border border-gray-300\">\n                          لا يوجد طلاب في هذه المجموعة\n                        </td>\n                      </tr>\n                    )}\n                  </tbody>\n                </table>\n              </div>\n\n              {/* Footer للطباعة */}\n              <div className=\"mt-6 pt-4 border-t-2 border-gray-300 text-center text-sm text-gray-600\">\n                <p>نظام الإرشاد الطلابي - جميع الحقوق محفوظة</p>\n              </div>\n            </div>\n\n            {/* Footer - Buttons */}\n            <div className=\"border-t border-gray-200 px-6 py-4 flex gap-3 print:hidden\">\n              <button\n                onClick={() => {\n                  setShowGroupPrintModal(false)\n                  setSelectedGroupForPrint(null)\n                }}\n                className=\"flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition-all\"\n                data-testid=\"button-cancel-group-print\"\n              >\n                إلغاء\n              </button>\n              <button\n                onClick={() => window.print()}\n                className=\"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-md flex items-center justify-center gap-2\"\n                data-testid=\"button-do-group-print\"\n              >\n                <Printer size={20} />\n                <span>طباعة</span>\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Input مخفي لاستيراد البيانات */}\n      <input\n        type=\"file\"\n        id=\"import-data-file\"\n        accept=\".json\"\n        style={{ display: 'none' }}\n        onChange={async (e) => {\n          const file = e.target.files?.[0]\n          if (!file) return\n          \n          try {\n            const text = await file.text()\n            const importData = JSON.parse(text)\n            \n            if (!importData.version || !importData.data) {\n              alert('❌ ملف غير صحيح! الرجاء اختيار ملف نسخة احتياطية صحيح')\n              return\n            }\n            \n            const confirmed = confirm(\n              '⚠️ تحذير: سيتم استبدال جميع البيانات الحالية بالبيانات المستوردة.\\n\\nهل أنت متأكد من المتابعة؟'\n            )\n            \n            if (!confirmed) return\n            \n            // استيراد البيانات\n            const { data } = importData\n            \n            // إضافة البيانات عبر API\n            try {\n              // حذف البيانات الحالية أولاً (سيتم إضافة endpoints للحذف لاحقاً)\n              \n              // استيراد الملف الشخصي\n              if (data.profile) {\n                await apiRequest('/api/teacher-profile', 'POST', data.profile)\n              }\n              \n              // استيراد المجموعات\n              if (data.groups && data.groups.length > 0) {\n                for (const group of data.groups) {\n                  await apiRequest('/api/groups', 'POST', group)\n                }\n              }\n              \n              // استيراد الطلاب\n              if (data.students && data.students.length > 0) {\n                for (const student of data.students) {\n                  await apiRequest('/api/students', 'POST', student)\n                }\n              }\n              \n              // استيراد المعلمين\n              if (data.teachers && data.teachers.length > 0) {\n                for (const teacher of data.teachers) {\n                  await apiRequest('/api/teachers', 'POST', teacher)\n                }\n              }\n              \n              // استيراد الزيارات\n              if (data.visits && data.visits.length > 0) {\n                for (const visit of data.visits) {\n                  await apiRequest('/api/student-visits', 'POST', visit)\n                }\n              }\n              \n              // استيراد الاستئذانات\n              if (data.permissions && data.permissions.length > 0) {\n                for (const permission of data.permissions) {\n                  await apiRequest('/api/student-permissions', 'POST', permission)\n                }\n              }\n              \n              // استيراد المخالفات\n              if (data.violations && data.violations.length > 0) {\n                for (const violation of data.violations) {\n                  await apiRequest('/api/student-violations', 'POST', violation)\n                }\n              }\n              \n              // تحديث الكاش\n              queryClient.invalidateQueries()\n              \n              alert('✅ تم استيراد البيانات بنجاح!\\n\\nسيتم تحديث الصفحة الآن.')\n              window.location.reload()\n            } catch (error) {\n              console.error('Error importing data:', error)\n              alert('❌ حدث خطأ أثناء استيراد البيانات. قد تكون بعض البيانات مكررة.')\n            }\n          } catch (error) {\n            console.error('Error reading file:', error)\n            alert('❌ خطأ في قراءة الملف. تأكد من أنه ملف JSON صحيح')\n          }\n          \n          // إعادة تعيين input\n          e.target.value = ''\n        }}\n      />\n    </div>\n  )\n}\n\nexport default App\n","size_bytes":292045},"Erchad-1/replit.md":{"content":"# Overview\n\nErchad is a comprehensive student information management system designed for Arabic-speaking schools. It enables teachers and administrators to manage student data, groups/classes, attendance, permissions, violations, and generate reports. The system supports RTL layout, student reception tracking, absence management, special status monitoring, and teacher coordination. It aims to streamline administrative tasks and provide robust data management for educational institutions.\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## Frontend Architecture\n\n**Technology Stack:** React 18 with TypeScript, Vite, Wouter for routing, and React Query for server state management.\n**UI/UX:** Tailwind CSS for styling and Lucide-react for iconography. The design emphasizes consistency with professional, color-coded pages for different functionalities (e.g., orange for permissions, red for violations).\n**Form Handling:** React Hook Form with Zod for validation.\n**Data Layer:** Dual storage pattern using Supabase for real-time backend connectivity and Dexie (IndexedDB) for offline-first capabilities and local caching, implementing a sync pattern.\n**Date Handling:** All dates are stored in ISO Gregorian format (`YYYY-MM-DD`) and displayed to the user in Hijri calendar format. Date filtering is performed using ISO Gregorian dates.\n\n## Backend Architecture\n\n**Server Framework:** Express 5 on Node.js, serving API endpoints and integrating with Vite for development.\n**Database ORM:** Drizzle ORM for type-safe queries with Zod schema validation.\n**API Design:** RESTful endpoints with Zod schema validation for incoming requests.\n**Storage Abstraction:** An `IStorage` interface with `DbStorage` implementation allows for flexible storage backend changes.\n\n## Database Schema\n\n**Core Entities:** Students, Groups, Special Statuses, Teachers, and Teacher Groups (junction table).\n**Activity Tracking:** `student_visits`, `student_permissions`, `student_violations` tables.\n**System Tables:** `teacher_profile` and `login_credentials`.\n**Indexing:** Foreign keys, `created_at` timestamps, and `display_order` for sorting.\n\n## Authentication & Authorization\n\n**Authentication:** Credential-based login using the `login_credentials` table.\n**Session Management:** `localStorage` for login state.\n**Password Reset:** Token-based mechanism with a time-limited 6-digit code.\n**Auto-Logout:** Configurable automatic logout based on user inactivity, with options for various durations.\n**Security Note:** Current password handling needs enhancement (proper hashing).\n\n## Key Features\n\n- **Advanced Filtering:** Dynamic filters on the main page for special statuses, academic stages, and groups, with intelligent dependencies and a reset option.\n- **Database Management:** API endpoint and UI for clearing all student, teacher, and group data. Backup and restore functionality for exporting/importing all system data as JSON.\n- **Permission and Violation Management:** Dedicated pages for recording and viewing student permissions and violations, including student search, details display, and historical data filtering.\n- **WhatsApp Integration:** Standardized phone number formatting (`formatPhoneForWhatsApp` utility) for seamless WhatsApp communication. All WhatsApp links use the format `https://wa.me/966XXXXXXXXX?text=...` with double validation: checks for phone number presence and validates formatted output. Clear error messages guide users to correct invalid phone numbers in student data. Supports various input formats: 0555..., 966555..., +966..., 00966..., 9660555...\n\n# External Dependencies\n\n## Database Services\n\n**Neon PostgreSQL:** Primary production database for serverless PostgreSQL.\n**Supabase:** Used by frontend components for real-time subscriptions and authentication.\n**IndexedDB (via Dexie):** Browser-based storage for offline functionality and local caching.\n\n## Third-Party Libraries\n\n**Data Management:** `xlsx` for Excel import/export.\n**UI Components:** Lucide-react for icons.\n**Form Management:** React Hook Form with Hookform Resolvers and Zod.\n**Development Tools:** TypeScript, ESLint, Vite, tsx.\n\n## Environment Variables\n\n- `DATABASE_URL`: Neon PostgreSQL connection string.\n- `VITE_SUPABASE_URL`: Supabase project URL (frontend).\n- `VITE_SUPABASE_ANON_KEY`: Supabase anonymous key (frontend).","size_bytes":4394},"Erchad-1/client/src/pages/TeachersPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Teacher, Group, TeacherGroup } from '../types'\nimport { Users, Plus, Edit2, Trash2, BookOpen } from 'lucide-react'\n\ninterface TeacherWithGroups extends Teacher {\n  teacher_groups?: TeacherGroup[]\n  groups?: Group[]\n}\n\nexport function TeachersPage() {\n  const [teachers, setTeachers] = useState<TeacherWithGroups[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [loading, setLoading] = useState(true)\n  const [showModal, setShowModal] = useState(false)\n  const [editingTeacher, setEditingTeacher] = useState<Teacher | null>(null)\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  const fetchData = async () => {\n    setLoading(true)\n\n    const [teachersRes, groupsRes, teacherGroupsRes] = await Promise.all([\n      supabase.from('teachers').select('*').order('name'),\n      supabase.from('groups').select('*').order('name'),\n      supabase.from('teacher_groups').select('*, groups(*)')\n    ])\n\n    if (groupsRes.data) setGroups(groupsRes.data)\n\n    if (teachersRes.data) {\n      const teachersWithGroups = teachersRes.data.map(teacher => ({\n        ...teacher,\n        groups: teacherGroupsRes.data\n          ?.filter(tg => tg.teacher_id === teacher.id)\n          .map(tg => tg.groups)\n          .filter(Boolean) as Group[]\n      }))\n      setTeachers(teachersWithGroups)\n    }\n\n    setLoading(false)\n  }\n\n  const handleAddNew = () => {\n    setEditingTeacher(null)\n    setShowModal(true)\n  }\n\n  const handleEdit = (teacher: Teacher) => {\n    setEditingTeacher(teacher)\n    setShowModal(true)\n  }\n\n  const handleDelete = async (teacherId: string) => {\n    if (!confirm('هل أنت متأكد من حذف هذا المعلم؟')) return\n\n    const { error } = await supabase\n      .from('teachers')\n      .delete()\n      .eq('id', teacherId)\n\n    if (error) {\n      alert('حدث خطأ أثناء الحذف')\n      console.error(error)\n    } else {\n      fetchData()\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-r from-blue-600 to-blue-500 rounded-2xl shadow-lg p-8 text-white\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n              <Users size={32} />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold\">المعلمين</h1>\n              <p className=\"text-blue-100 text-lg mt-1\">\n                إجمالي المعلمين: {teachers.length}\n              </p>\n            </div>\n          </div>\n          <button\n            onClick={handleAddNew}\n            className=\"flex items-center gap-2 px-6 py-3 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition-all hover:shadow-md\"\n          >\n            <Plus size={20} />\n            <span>إضافة معلم</span>\n          </button>\n        </div>\n      </div>\n\n      {loading ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center\">\n          <p className=\"text-gray-500 text-lg\">جاري التحميل...</p>\n        </div>\n      ) : teachers.length === 0 ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200\">\n          <Users className=\"mx-auto text-gray-300 mb-4\" size={64} />\n          <p className=\"text-gray-500 text-xl mb-4\">لا يوجد معلمين</p>\n          <button\n            onClick={handleAddNew}\n            className=\"inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors\"\n          >\n            <Plus size={20} />\n            <span>إضافة أول معلم</span>\n          </button>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {teachers.map((teacher) => (\n            <div\n              key={teacher.id}\n              className=\"bg-white rounded-xl shadow-md hover:shadow-xl transition-all border border-gray-200 overflow-hidden\"\n            >\n              <div className=\"bg-gradient-to-r from-blue-500 to-blue-400 p-4\">\n                <h3 className=\"text-xl font-bold text-white\">{teacher.name}</h3>\n              </div>\n\n              <div className=\"p-6 space-y-4\">\n                <div className=\"flex items-start gap-3\">\n                  <BookOpen className=\"text-blue-600 mt-0.5 flex-shrink-0\" size={18} />\n                  <div>\n                    <p className=\"text-xs text-gray-500 mb-0.5\">المقرر الدراسي</p>\n                    <p className=\"text-sm font-semibold text-gray-800\">{teacher.specialization}</p>\n                  </div>\n                </div>\n\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"w-5 h-5 flex items-center justify-center text-blue-600 flex-shrink-0\">\n                    <span className=\"text-lg\">📱</span>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-gray-500 mb-0.5\">رقم الجوال</p>\n                    <p className=\"text-sm font-semibold text-gray-800\">{teacher.phone}</p>\n                  </div>\n                </div>\n\n                {teacher.groups && teacher.groups.length > 0 && (\n                  <div className=\"pt-3 border-t border-gray-100\">\n                    <p className=\"text-xs text-gray-500 mb-2\">المجموعات</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {teacher.groups.map((group) => (\n                        <span\n                          key={group.id}\n                          className=\"px-2 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-lg\"\n                        >\n                          {group.name}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"flex gap-2 pt-4 border-t border-gray-100\">\n                  <button\n                    onClick={() => handleEdit(teacher)}\n                    className=\"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-medium hover:bg-blue-100 transition-colors\"\n                  >\n                    <Edit2 size={16} />\n                    <span>تعديل</span>\n                  </button>\n                  <button\n                    onClick={() => handleDelete(teacher.id)}\n                    className=\"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg font-medium hover:bg-red-100 transition-colors\"\n                  >\n                    <Trash2 size={16} />\n                    <span>حذف</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {showModal && (\n        <TeacherFormModal\n          teacher={editingTeacher}\n          groups={groups}\n          onClose={() => setShowModal(false)}\n          onSave={fetchData}\n        />\n      )}\n    </div>\n  )\n}\n\ninterface TeacherFormModalProps {\n  teacher: Teacher | null\n  groups: Group[]\n  onClose: () => void\n  onSave: () => void\n}\n\nfunction TeacherFormModal({ teacher, groups, onClose, onSave }: TeacherFormModalProps) {\n  const [name, setName] = useState(teacher?.name || '')\n  const [phone, setPhone] = useState(teacher?.phone || '')\n  const [specialization, setSpecialization] = useState(teacher?.specialization || '')\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])\n  const [loading, setLoading] = useState(false)\n  const [loadingGroups, setLoadingGroups] = useState(true)\n\n  useEffect(() => {\n    if (teacher) {\n      fetchTeacherGroups()\n    } else {\n      setLoadingGroups(false)\n    }\n  }, [teacher])\n\n  const fetchTeacherGroups = async () => {\n    if (!teacher) return\n\n    const { data } = await supabase\n      .from('teacher_groups')\n      .select('group_id')\n      .eq('teacher_id', teacher.id)\n\n    if (data) {\n      setSelectedGroupIds(data.map(tg => tg.group_id))\n    }\n    setLoadingGroups(false)\n  }\n\n  const toggleGroup = (groupId: string) => {\n    if (selectedGroupIds.includes(groupId)) {\n      setSelectedGroupIds(selectedGroupIds.filter(id => id !== groupId))\n    } else {\n      setSelectedGroupIds([...selectedGroupIds, groupId])\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!name.trim() || !phone.trim() || !specialization.trim()) {\n      alert('الرجاء تعبئة جميع الحقول المطلوبة')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      if (teacher) {\n        const { error: updateError } = await supabase\n          .from('teachers')\n          .update({\n            name: name.trim(),\n            phone: phone.trim(),\n            specialization: specialization.trim()\n          })\n          .eq('id', teacher.id)\n\n        if (updateError) {\n          console.error('Update error:', updateError)\n          throw new Error(`فشل تحديث المعلم: ${updateError.message}`)\n        }\n\n        const { error: deleteError } = await supabase\n          .from('teacher_groups')\n          .delete()\n          .eq('teacher_id', teacher.id)\n\n        if (deleteError) {\n          console.error('Delete groups error:', deleteError)\n        }\n\n        if (selectedGroupIds.length > 0) {\n          const teacherGroupsData = selectedGroupIds.map(groupId => ({\n            teacher_id: teacher.id,\n            group_id: groupId,\n          }))\n\n          const { error: groupsError } = await supabase\n            .from('teacher_groups')\n            .insert(teacherGroupsData)\n\n          if (groupsError) {\n            console.error('Insert groups error:', groupsError)\n            throw new Error(`فشل ربط المجموعات: ${groupsError.message}`)\n          }\n        }\n      } else {\n        const { data: newTeacher, error: insertError } = await supabase\n          .from('teachers')\n          .insert({\n            name: name.trim(),\n            phone: phone.trim(),\n            specialization: specialization.trim()\n          })\n          .select()\n          .single()\n\n        if (insertError) {\n          console.error('Insert error:', insertError)\n          throw new Error(`فشل إضافة المعلم: ${insertError.message}`)\n        }\n\n        if (newTeacher && selectedGroupIds.length > 0) {\n          const teacherGroupsData = selectedGroupIds.map(groupId => ({\n            teacher_id: newTeacher.id,\n            group_id: groupId,\n          }))\n\n          const { error: groupsError } = await supabase\n            .from('teacher_groups')\n            .insert(teacherGroupsData)\n\n          if (groupsError) {\n            console.error('Insert groups error:', groupsError)\n            throw new Error(`فشل ربط المجموعات: ${groupsError.message}`)\n          }\n        }\n      }\n\n      onSave()\n      onClose()\n    } catch (error: any) {\n      console.error('Error saving teacher:', error)\n      const errorMessage = error?.message || 'حدث خطأ غير معروف'\n      alert(`حدث خطأ أثناء الحفظ:\\n${errorMessage}`)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <h2 className=\"text-2xl font-bold text-gray-900\">\n            {teacher ? 'تعديل بيانات المعلم' : 'إضافة معلم جديد'}\n          </h2>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            ✕\n          </button>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اسم المعلم <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"مثال: أ. محمد أحمد\"\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              رقم الجوال <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"tel\"\n              value={phone}\n              onChange={(e) => setPhone(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"05xxxxxxxx\"\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              المقرر الدراسي <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              value={specialization}\n              onChange={(e) => setSpecialization(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"مثال: رياضيات، لغة عربية، علوم\"\n              required\n            />\n          </div>\n\n          {loadingGroups ? (\n            <div className=\"text-center py-4 text-gray-500\">جاري تحميل المجموعات...</div>\n          ) : groups.length > 0 ? (\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-3\">\n                المجموعات التي يدرسها (اختياري)\n              </label>\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4\">\n                {groups.map((group) => {\n                  const isSelected = selectedGroupIds.includes(group.id)\n                  return (\n                    <button\n                      key={group.id}\n                      type=\"button\"\n                      onClick={() => toggleGroup(group.id)}\n                      className={`p-3 rounded-lg border-2 transition-all text-sm font-medium ${\n                        isSelected\n                          ? 'bg-blue-50 border-blue-500 text-blue-900'\n                          : 'bg-gray-50 border-gray-300 text-gray-700 hover:border-gray-400'\n                      }`}\n                    >\n                      {group.name}\n                    </button>\n                  )\n                })}\n              </div>\n            </div>\n          ) : null}\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg transition-colors\"\n            >\n              {loading ? 'جاري الحفظ...' : teacher ? 'حفظ التعديلات' : 'إضافة المعلم'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":15817},"client/src/components/StudentForm.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Group, SpecialStatus, Student } from '../types'\nimport { Plus, X } from 'lucide-react'\n\ninterface StudentFormProps {\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n  onStudentAdded: () => void\n  editingStudent?: Student\n  onEditingStudentChange: (student?: Student) => void\n}\n\nexport function StudentForm({\n  groups,\n  specialStatuses,\n  onStudentAdded,\n  editingStudent,\n  onEditingStudentChange,\n}: StudentFormProps) {\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [formData, setFormData] = useState({\n    name: '',\n    national_id: '',\n    phone: '',\n    guardian_phone: '',\n    grade: '',\n    group_id: '',\n    special_status_id: '',\n  })\n\n  useEffect(() => {\n    if (editingStudent) {\n      setFormData({\n        name: editingStudent.name,\n        national_id: editingStudent.national_id,\n        phone: editingStudent.phone,\n        guardian_phone: editingStudent.guardian_phone,\n        grade: editingStudent.grade,\n        group_id: editingStudent.group_id,\n        special_status_id: editingStudent.special_status_id || '',\n      })\n    }\n  }, [editingStudent])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      if (!formData.group_id) {\n        setError('يجب اختيار مجموعة')\n        setLoading(false)\n        return\n      }\n\n      const data = {\n        name: formData.name,\n        national_id: formData.national_id,\n        phone: formData.phone,\n        guardian_phone: formData.guardian_phone,\n        grade: formData.grade,\n        group_id: formData.group_id,\n        special_status_id: formData.special_status_id || null,\n      }\n\n      if (editingStudent) {\n        const { error: updateError } = await supabase\n          .from('students')\n          .update(data)\n          .eq('id', editingStudent.id)\n\n        if (updateError) throw updateError\n      } else {\n        const { error: insertError } = await supabase\n          .from('students')\n          .insert(data)\n\n        if (insertError) throw insertError\n      }\n\n      setFormData({\n        name: '',\n        national_id: '',\n        phone: '',\n        guardian_phone: '',\n        grade: '',\n        group_id: '',\n        special_status_id: '',\n      })\n      onEditingStudentChange(undefined)\n      onStudentAdded()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <h2 className=\"text-xl font-bold text-gray-800\">\n          {editingStudent ? 'تعديل الطالب' : 'إضافة طالب جديد'}\n        </h2>\n        {editingStudent && (\n          <button\n            onClick={() => onEditingStudentChange(undefined)}\n            className=\"text-gray-500 hover:text-gray-700\"\n          >\n            <X size={24} />\n          </button>\n        )}\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded\">\n          {error}\n        </div>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              اسم الطالب\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              السجل المدني\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.national_id}\n              onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              جوال الطالب\n            </label>\n            <input\n              type=\"tel\"\n              required\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              جوال ولي الأمر\n            </label>\n            <input\n              type=\"tel\"\n              required\n              value={formData.guardian_phone}\n              onChange={(e) => setFormData({ ...formData, guardian_phone: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              الصف\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.grade}\n              onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              المجموعة\n            </label>\n            <select\n              required\n              value={formData.group_id}\n              onChange={(e) => setFormData({ ...formData, group_id: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"\">اختر مجموعة</option>\n              {groups.map((group) => (\n                <option key={group.id} value={group.id}>\n                  {group.name}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              الحالة الخاصة (اختياري)\n            </label>\n            <select\n              value={formData.special_status_id}\n              onChange={(e) =>\n                setFormData({ ...formData, special_status_id: e.target.value })\n              }\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"\">بدون حالة خاصة</option>\n              {specialStatuses.map((status) => (\n                <option key={status.id} value={status.id}>\n                  {status.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        </div>\n\n        <button\n          type=\"submit\"\n          disabled={loading}\n          className=\"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2\"\n        >\n          <Plus size={20} />\n          {loading\n            ? 'جاري...'\n            : editingStudent\n              ? 'تحديث الطالب'\n              : 'إضافة الطالب'}\n        </button>\n      </form>\n    </div>\n  )\n}\n","size_bytes":7960},"Erchad-1/client/src/components/SendToTeacherModal.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { X, Send } from 'lucide-react'\nimport { Teacher, Group, Student } from '../types'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface SendToTeacherModalProps {\n  isOpen: boolean\n  onClose: () => void\n  specialStatusStudents: Student[]\n}\n\nexport function SendToTeacherModal({\n  isOpen,\n  onClose,\n  specialStatusStudents,\n}: SendToTeacherModalProps) {\n  const [teachers, setTeachers] = useState<Teacher[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [allGroups, setAllGroups] = useState<Group[]>([])\n  const [stages, setStages] = useState<string[]>([])\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  const [selectedStage, setSelectedStage] = useState('')\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])\n  const [loading, setLoading] = useState(false)\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchTeachers()\n      fetchGroups()\n    }\n  }, [isOpen])\n\n  const fetchTeachers = async () => {\n    const { data } = await supabase\n      .from('teachers')\n      .select('*')\n      .order('name')\n\n    if (data) setTeachers(data)\n  }\n\n  const fetchGroups = async () => {\n    const { data } = await supabase\n      .from('groups')\n      .select('*')\n      .order('display_order')\n\n    if (data) {\n      setAllGroups(data)\n      const uniqueStages = [...new Set(data.map(g => g.stage))]\n      setStages(uniqueStages)\n    }\n  }\n\n  useEffect(() => {\n    if (selectedStage) {\n      const stageGroups = allGroups.filter(g => g.stage === selectedStage)\n      setGroups(stageGroups)\n      setSelectedGroupIds([])\n    } else {\n      setGroups([])\n      setSelectedGroupIds([])\n    }\n  }, [selectedStage, allGroups])\n\n  const toggleGroup = (groupId: string) => {\n    if (selectedGroupIds.includes(groupId)) {\n      setSelectedGroupIds(selectedGroupIds.filter(id => id !== groupId))\n    } else {\n      setSelectedGroupIds([...selectedGroupIds, groupId])\n    }\n  }\n\n\n  const handleSend = async () => {\n    if (!selectedTeacherId) {\n      alert('الرجاء اختيار المعلم')\n      return\n    }\n\n    if (!selectedStage) {\n      alert('الرجاء اختيار المرحلة')\n      return\n    }\n\n    if (selectedGroupIds.length === 0) {\n      alert('الرجاء اختيار مجموعة واحدة على الأقل')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const teacher = teachers.find(t => t.id === selectedTeacherId)\n      if (!teacher) return\n\n      // فلتر الطلاب حسب المجموعات المختارة\n      const filteredStudents = specialStatusStudents.filter(\n        student => selectedGroupIds.includes(student.group_id)\n      )\n\n      if (filteredStudents.length === 0) {\n        alert('لا يوجد طلاب ذوي حالات خاصة في المجموعات المختارة')\n        setLoading(false)\n        return\n      }\n\n      // إنشاء رسالة واتساب\n      let message = ''\n      const selectedGroups = allGroups.filter(g => selectedGroupIds.includes(g.id))\n\n      message += `*الحالات الخاصة - ${selectedStage}*\\n\\n`\n\n      // تجميع الطلاب حسب المجموعة\n      selectedGroups.forEach((group) => {\n        const groupStudents = filteredStudents.filter(s => s.group_id === group.id)\n        if (groupStudents.length > 0) {\n          message += `📚 *${group.name}*\\n`\n          groupStudents.forEach((student, index) => {\n            message += `${index + 1}. *${student.name}*\\n`\n            message += `   الحالة: ${student.special_status?.name || '-'}\\n`\n            message += `   جوال الطالب: ${student.phone || '-'}\\n`\n            message += `   جوال ولي الأمر: ${student.guardian_phone || '-'}\\n\\n`\n          })\n          message += '\\n'\n        }\n      })\n\n      // فتح واتساب\n      const encodedMessage = encodeURIComponent(message)\n      const phoneNumber = formatPhoneForWhatsApp(teacher.phone)\n      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`\n\n      window.open(whatsappUrl, '_blank')\n\n      onClose()\n    } catch (error) {\n      console.error('Error sending to teacher:', error)\n      alert('حدث خطأ أثناء الإرسال')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (!isOpen) return null\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Send className=\"text-green-600\" size={24} />\n            <h2 className=\"text-2xl font-bold text-gray-900\">إرسال للمعلم</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n            <p className=\"text-sm text-blue-800\">\n              سيتم إرسال بيانات الطلاب ذوي الحالات الخاصة في المجموعة المحددة إلى المعلم عبر واتساب\n            </p>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المعلم <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              value={selectedTeacherId}\n              onChange={(e) => setSelectedTeacherId(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n            >\n              <option value=\"\">-- اختر المعلم --</option>\n              {teachers.map((teacher) => (\n                <option key={teacher.id} value={teacher.id}>\n                  {teacher.name} - {teacher.specialization}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المرحلة <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              value={selectedStage}\n              onChange={(e) => setSelectedStage(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n            >\n              <option value=\"\">-- اختر المرحلة --</option>\n              {stages.map((stage) => (\n                <option key={stage} value={stage}>\n                  {stage}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المجموعة <span className=\"text-red-500\">*</span>\n            </label>\n            {!selectedStage ? (\n              <div className=\"bg-gray-50 border border-gray-300 rounded-lg p-4 text-center\">\n                <p className=\"text-sm text-gray-500\">اختر المرحلة أولاً</p>\n              </div>\n            ) : groups.length === 0 ? (\n              <div className=\"bg-gray-50 border border-gray-300 rounded-lg p-4 text-center\">\n                <p className=\"text-sm text-gray-500\">لا توجد مجموعات في هذه المرحلة</p>\n              </div>\n            ) : (\n              <div className=\"border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto space-y-2\">\n                {groups.map((group) => {\n                  const isSelected = selectedGroupIds.includes(group.id)\n                  const studentsCount = specialStatusStudents.filter(s => s.group_id === group.id).length\n                  return (\n                    <label\n                      key={group.id}\n                      className={`flex items-center gap-3 p-3 rounded-lg border-2 transition-all cursor-pointer ${\n                        isSelected\n                          ? 'bg-green-50 border-green-500'\n                          : 'bg-white border-gray-200 hover:border-gray-300'\n                      }`}\n                    >\n                      <input\n                        type=\"checkbox\"\n                        checked={isSelected}\n                        onChange={() => toggleGroup(group.id)}\n                        className=\"w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500\"\n                      />\n                      <div className=\"flex-1\">\n                        <span className={`font-medium ${\n                          isSelected ? 'text-green-900' : 'text-gray-900'\n                        }`}>\n                          {group.name}\n                        </span>\n                        {studentsCount > 0 && (\n                          <span className=\"text-xs text-gray-500 mr-2\">\n                            ({studentsCount} طالب)\n                          </span>\n                        )}\n                      </div>\n                    </label>\n                  )\n                })}\n              </div>\n            )}\n            {selectedGroupIds.length > 0 && (\n              <p className=\"text-xs text-green-600 mt-2\">\n                تم اختيار {selectedGroupIds.length} مجموعة\n              </p>\n            )}\n          </div>\n\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              onClick={handleSend}\n              disabled={loading || !selectedTeacherId || !selectedStage || selectedGroupIds.length === 0}\n              className=\"flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Send size={20} />\n              {loading ? 'جاري الإرسال...' : 'إرسال عبر واتساب'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":10551},"client/src/components/SearchBar.tsx":{"content":"import { Search } from 'lucide-react'\n\ninterface SearchBarProps {\n  value: string\n  onChange: (value: string) => void\n  placeholder?: string\n}\n\nexport function SearchBar({\n  value,\n  onChange,\n  placeholder = 'ابحث عن طالب...',\n}: SearchBarProps) {\n  return (\n    <div className=\"relative\">\n      <Search className=\"absolute right-3 top-3 text-gray-400\" size={20} />\n      <input\n        type=\"text\"\n        placeholder={placeholder}\n        value={value}\n        onChange={(e) => onChange(e.target.value)}\n        className=\"w-full pr-10 pl-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n      />\n    </div>\n  )\n}\n","size_bytes":672},"client/src/pages/TeachersPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Teacher, Group, TeacherGroup } from '../types'\nimport { Users, Plus, Edit2, Trash2, BookOpen } from 'lucide-react'\n\ninterface TeacherWithGroups extends Teacher {\n  teacher_groups?: TeacherGroup[]\n  groups?: Group[]\n}\n\nexport function TeachersPage() {\n  const [teachers, setTeachers] = useState<TeacherWithGroups[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [loading, setLoading] = useState(true)\n  const [showModal, setShowModal] = useState(false)\n  const [editingTeacher, setEditingTeacher] = useState<Teacher | null>(null)\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  const fetchData = async () => {\n    setLoading(true)\n\n    const [teachersRes, groupsRes, teacherGroupsRes] = await Promise.all([\n      supabase.from('teachers').select('*').order('name'),\n      supabase.from('groups').select('*').order('name'),\n      supabase.from('teacher_groups').select('*, groups(*)')\n    ])\n\n    if (groupsRes.data) setGroups(groupsRes.data)\n\n    if (teachersRes.data) {\n      const teachersWithGroups = teachersRes.data.map(teacher => ({\n        ...teacher,\n        groups: teacherGroupsRes.data\n          ?.filter(tg => tg.teacher_id === teacher.id)\n          .map(tg => tg.groups)\n          .filter(Boolean) as Group[]\n      }))\n      setTeachers(teachersWithGroups)\n    }\n\n    setLoading(false)\n  }\n\n  const handleAddNew = () => {\n    setEditingTeacher(null)\n    setShowModal(true)\n  }\n\n  const handleEdit = (teacher: Teacher) => {\n    setEditingTeacher(teacher)\n    setShowModal(true)\n  }\n\n  const handleDelete = async (teacherId: string) => {\n    if (!confirm('هل أنت متأكد من حذف هذا المعلم؟')) return\n\n    const { error } = await supabase\n      .from('teachers')\n      .delete()\n      .eq('id', teacherId)\n\n    if (error) {\n      alert('حدث خطأ أثناء الحذف')\n      console.error(error)\n    } else {\n      fetchData()\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-r from-blue-600 to-blue-500 rounded-2xl shadow-lg p-8 text-white\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-white bg-opacity-20 p-3 rounded-xl\">\n              <Users size={32} />\n            </div>\n            <div>\n              <h1 className=\"text-3xl font-bold\">المعلمين</h1>\n              <p className=\"text-blue-100 text-lg mt-1\">\n                إجمالي المعلمين: {teachers.length}\n              </p>\n            </div>\n          </div>\n          <button\n            onClick={handleAddNew}\n            className=\"flex items-center gap-2 px-6 py-3 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50 transition-all hover:shadow-md\"\n          >\n            <Plus size={20} />\n            <span>إضافة معلم</span>\n          </button>\n        </div>\n      </div>\n\n      {loading ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center\">\n          <p className=\"text-gray-500 text-lg\">جاري التحميل...</p>\n        </div>\n      ) : teachers.length === 0 ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-16 text-center border border-gray-200\">\n          <Users className=\"mx-auto text-gray-300 mb-4\" size={64} />\n          <p className=\"text-gray-500 text-xl mb-4\">لا يوجد معلمين</p>\n          <button\n            onClick={handleAddNew}\n            className=\"inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors\"\n          >\n            <Plus size={20} />\n            <span>إضافة أول معلم</span>\n          </button>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n          {teachers.map((teacher) => (\n            <div\n              key={teacher.id}\n              className=\"bg-white rounded-xl shadow-md hover:shadow-xl transition-all border border-gray-200 overflow-hidden\"\n            >\n              <div className=\"bg-gradient-to-r from-blue-500 to-blue-400 p-4\">\n                <h3 className=\"text-xl font-bold text-white\">{teacher.name}</h3>\n              </div>\n\n              <div className=\"p-6 space-y-4\">\n                <div className=\"flex items-start gap-3\">\n                  <BookOpen className=\"text-blue-600 mt-0.5 flex-shrink-0\" size={18} />\n                  <div>\n                    <p className=\"text-xs text-gray-500 mb-0.5\">المقرر الدراسي</p>\n                    <p className=\"text-sm font-semibold text-gray-800\">{teacher.specialization}</p>\n                  </div>\n                </div>\n\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"w-5 h-5 flex items-center justify-center text-blue-600 flex-shrink-0\">\n                    <span className=\"text-lg\">📱</span>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-gray-500 mb-0.5\">رقم الجوال</p>\n                    <p className=\"text-sm font-semibold text-gray-800\">{teacher.phone}</p>\n                  </div>\n                </div>\n\n                {teacher.groups && teacher.groups.length > 0 && (\n                  <div className=\"pt-3 border-t border-gray-100\">\n                    <p className=\"text-xs text-gray-500 mb-2\">المجموعات</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {teacher.groups.map((group) => (\n                        <span\n                          key={group.id}\n                          className=\"px-2 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-lg\"\n                        >\n                          {group.name}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"flex gap-2 pt-4 border-t border-gray-100\">\n                  <button\n                    onClick={() => handleEdit(teacher)}\n                    className=\"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-medium hover:bg-blue-100 transition-colors\"\n                  >\n                    <Edit2 size={16} />\n                    <span>تعديل</span>\n                  </button>\n                  <button\n                    onClick={() => handleDelete(teacher.id)}\n                    className=\"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg font-medium hover:bg-red-100 transition-colors\"\n                  >\n                    <Trash2 size={16} />\n                    <span>حذف</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {showModal && (\n        <TeacherFormModal\n          teacher={editingTeacher}\n          groups={groups}\n          onClose={() => setShowModal(false)}\n          onSave={fetchData}\n        />\n      )}\n    </div>\n  )\n}\n\ninterface TeacherFormModalProps {\n  teacher: Teacher | null\n  groups: Group[]\n  onClose: () => void\n  onSave: () => void\n}\n\nfunction TeacherFormModal({ teacher, groups, onClose, onSave }: TeacherFormModalProps) {\n  const [name, setName] = useState(teacher?.name || '')\n  const [phone, setPhone] = useState(teacher?.phone || '')\n  const [specialization, setSpecialization] = useState(teacher?.specialization || '')\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])\n  const [loading, setLoading] = useState(false)\n  const [loadingGroups, setLoadingGroups] = useState(true)\n\n  useEffect(() => {\n    if (teacher) {\n      fetchTeacherGroups()\n    } else {\n      setLoadingGroups(false)\n    }\n  }, [teacher])\n\n  const fetchTeacherGroups = async () => {\n    if (!teacher) return\n\n    const { data } = await supabase\n      .from('teacher_groups')\n      .select('group_id')\n      .eq('teacher_id', teacher.id)\n\n    if (data) {\n      setSelectedGroupIds(data.map(tg => tg.group_id))\n    }\n    setLoadingGroups(false)\n  }\n\n  const toggleGroup = (groupId: string) => {\n    if (selectedGroupIds.includes(groupId)) {\n      setSelectedGroupIds(selectedGroupIds.filter(id => id !== groupId))\n    } else {\n      setSelectedGroupIds([...selectedGroupIds, groupId])\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!name.trim() || !phone.trim() || !specialization.trim()) {\n      alert('الرجاء تعبئة جميع الحقول المطلوبة')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      if (teacher) {\n        const { error: updateError } = await supabase\n          .from('teachers')\n          .update({\n            name: name.trim(),\n            phone: phone.trim(),\n            specialization: specialization.trim()\n          })\n          .eq('id', teacher.id)\n\n        if (updateError) {\n          console.error('Update error:', updateError)\n          throw new Error(`فشل تحديث المعلم: ${updateError.message}`)\n        }\n\n        const { error: deleteError } = await supabase\n          .from('teacher_groups')\n          .delete()\n          .eq('teacher_id', teacher.id)\n\n        if (deleteError) {\n          console.error('Delete groups error:', deleteError)\n        }\n\n        if (selectedGroupIds.length > 0) {\n          const teacherGroupsData = selectedGroupIds.map(groupId => ({\n            teacher_id: teacher.id,\n            group_id: groupId,\n          }))\n\n          const { error: groupsError } = await supabase\n            .from('teacher_groups')\n            .insert(teacherGroupsData)\n\n          if (groupsError) {\n            console.error('Insert groups error:', groupsError)\n            throw new Error(`فشل ربط المجموعات: ${groupsError.message}`)\n          }\n        }\n      } else {\n        const { data: newTeacher, error: insertError } = await supabase\n          .from('teachers')\n          .insert({\n            name: name.trim(),\n            phone: phone.trim(),\n            specialization: specialization.trim()\n          })\n          .select()\n          .single()\n\n        if (insertError) {\n          console.error('Insert error:', insertError)\n          throw new Error(`فشل إضافة المعلم: ${insertError.message}`)\n        }\n\n        if (newTeacher && selectedGroupIds.length > 0) {\n          const teacherGroupsData = selectedGroupIds.map(groupId => ({\n            teacher_id: newTeacher.id,\n            group_id: groupId,\n          }))\n\n          const { error: groupsError } = await supabase\n            .from('teacher_groups')\n            .insert(teacherGroupsData)\n\n          if (groupsError) {\n            console.error('Insert groups error:', groupsError)\n            throw new Error(`فشل ربط المجموعات: ${groupsError.message}`)\n          }\n        }\n      }\n\n      onSave()\n      onClose()\n    } catch (error: any) {\n      console.error('Error saving teacher:', error)\n      const errorMessage = error?.message || 'حدث خطأ غير معروف'\n      alert(`حدث خطأ أثناء الحفظ:\\n${errorMessage}`)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <h2 className=\"text-2xl font-bold text-gray-900\">\n            {teacher ? 'تعديل بيانات المعلم' : 'إضافة معلم جديد'}\n          </h2>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            ✕\n          </button>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اسم المعلم <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"مثال: أ. محمد أحمد\"\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              رقم الجوال <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"tel\"\n              value={phone}\n              onChange={(e) => setPhone(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"05xxxxxxxx\"\n              required\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              المقرر الدراسي <span className=\"text-red-500\">*</span>\n            </label>\n            <input\n              type=\"text\"\n              value={specialization}\n              onChange={(e) => setSpecialization(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              placeholder=\"مثال: رياضيات، لغة عربية، علوم\"\n              required\n            />\n          </div>\n\n          {loadingGroups ? (\n            <div className=\"text-center py-4 text-gray-500\">جاري تحميل المجموعات...</div>\n          ) : groups.length > 0 ? (\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-3\">\n                المجموعات التي يدرسها (اختياري)\n              </label>\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4\">\n                {groups.map((group) => {\n                  const isSelected = selectedGroupIds.includes(group.id)\n                  return (\n                    <button\n                      key={group.id}\n                      type=\"button\"\n                      onClick={() => toggleGroup(group.id)}\n                      className={`p-3 rounded-lg border-2 transition-all text-sm font-medium ${\n                        isSelected\n                          ? 'bg-blue-50 border-blue-500 text-blue-900'\n                          : 'bg-gray-50 border-gray-300 text-gray-700 hover:border-gray-400'\n                      }`}\n                    >\n                      {group.name}\n                    </button>\n                  )\n                })}\n              </div>\n            </div>\n          ) : null}\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg transition-colors\"\n            >\n              {loading ? 'جاري الحفظ...' : teacher ? 'حفظ التعديلات' : 'إضافة المعلم'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","size_bytes":15817},"client/src/components/EditStudentModal.tsx":{"content":"import { useState } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Group, SpecialStatus, Student } from '../types'\nimport { X } from 'lucide-react'\n\ninterface EditStudentModalProps {\n  student: Student\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n  onClose: () => void\n  onStudentUpdated: () => void\n}\n\nexport function EditStudentModal({\n  student,\n  groups,\n  specialStatuses,\n  onClose,\n  onStudentUpdated,\n}: EditStudentModalProps) {\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [formData, setFormData] = useState({\n    name: student.name,\n    national_id: student.national_id,\n    phone: student.phone,\n    guardian_phone: student.guardian_phone,\n    grade: student.grade,\n    group_id: student.group_id,\n    special_status_id: student.special_status_id || '',\n  })\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      const data = {\n        name: formData.name,\n        national_id: formData.national_id,\n        phone: formData.phone,\n        guardian_phone: formData.guardian_phone,\n        grade: formData.grade,\n        group_id: formData.group_id,\n        special_status_id: formData.special_status_id || null,\n      }\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update(data)\n        .eq('id', student.id)\n\n      if (updateError) throw updateError\n\n      onStudentUpdated()\n      onClose()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"fixed inset-0 bg-white z-50 overflow-y-auto\">\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-gray-50\">\n        <div className=\"max-w-4xl mx-auto p-6\">\n          <div className=\"bg-white rounded-2xl shadow-xl overflow-hidden\">\n            <div className=\"bg-gradient-to-r from-blue-600 to-blue-700 px-8 py-6 flex items-center justify-between\">\n              <h2 className=\"text-2xl font-bold text-white\">تعديل الطالب</h2>\n              <button\n                onClick={onClose}\n                className=\"text-white hover:bg-white/20 p-2 rounded-lg transition-colors\"\n              >\n                <X size={28} />\n              </button>\n            </div>\n\n            <div className=\"p-8\">\n              {error && (\n                <div className=\"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg\">\n                  {error}\n                </div>\n              )}\n\n              <form onSubmit={handleSubmit} className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      اسم الطالب\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.name}\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      السجل المدني\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.national_id}\n                      onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      جوال الطالب\n                    </label>\n                    <input\n                      type=\"tel\"\n                      required\n                      value={formData.phone}\n                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      جوال ولي الأمر\n                    </label>\n                    <input\n                      type=\"tel\"\n                      required\n                      value={formData.guardian_phone}\n                      onChange={(e) => setFormData({ ...formData, guardian_phone: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الصف\n                    </label>\n                    <input\n                      type=\"text\"\n                      required\n                      value={formData.grade}\n                      onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      المجموعة\n                    </label>\n                    <select\n                      required\n                      value={formData.group_id}\n                      onChange={(e) => setFormData({ ...formData, group_id: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white\"\n                    >\n                      <option value=\"\">اختر مجموعة</option>\n                      {groups.map((group) => (\n                        <option key={group.id} value={group.id}>\n                          {group.name}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n\n                  <div className=\"md:col-span-2\">\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الحالة الخاصة (اختياري)\n                    </label>\n                    <select\n                      value={formData.special_status_id}\n                      onChange={(e) =>\n                        setFormData({ ...formData, special_status_id: e.target.value })\n                      }\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg bg-white\"\n                    >\n                      <option value=\"\">بدون حالة خاصة</option>\n                      {specialStatuses.map((status) => (\n                        <option key={status.id} value={status.id}>\n                          {status.name}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-4 pt-6\">\n                  <button\n                    type=\"submit\"\n                    disabled={loading}\n                    className=\"flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-4 px-6 rounded-xl text-lg shadow-lg hover:shadow-xl transition-all\"\n                  >\n                    {loading ? 'جاري الحفظ...' : 'تحديث الطالب'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={onClose}\n                    className=\"px-8 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl text-lg transition-colors\"\n                  >\n                    إلغاء\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":8793},"Erchad-1/server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes.js\";\nimport { setupVite } from \"./vite.js\";\nimport { createServer } from \"http\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      console.log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = createServer(app);\n\n  registerRoutes(app);\n  await setupVite(app, server);\n\n  const PORT = 5000;\n  server.listen(PORT, \"0.0.0.0\", () => {\n    console.log(`Server running on port ${PORT}`);\n  });\n})();\n","size_bytes":1306},"Erchad-1/DONE.md":{"content":"# ✅ ما تم إنجازه\n\n## التاريخ: 4 نوفمبر 2025\n\n## 🎉 النتيجة النهائية\n\nتم إعادة إنشاء الواجهة الرئيسية بالكامل لتطابق التصميم الأصلي مع دمج كامل مع البنية التحتية الجديدة (PostgreSQL + React Query)\n\n## 📋 ما تم تنفيذه\n\n### 1. صفحة تسجيل الدخول (LoginPage.tsx) ✅\n- تصميم مطابق للنسخة الأصلية\n- استخدام React Query بدلاً من Supabase\n- دعم الحساب المخفي (Wael)\n- إزالة جميع استيرادات Supabase و IndexedDB\n\n### 2. الصفحة الرئيسية (App.tsx) ✅\nتم إنشاء الواجهة الكاملة بالضبط كما في الصورة المرفقة:\n\n#### الهيدر:\n- ✅ العنوان الديناميكي (يعرض اسم المدرسة أو الوصف الافتراضي)\n- ✅ أيقونة المستخدمين\n- ✅ زر الإعدادات مع قائمة منسدلة\n- ✅ زر الملف الشخصي\n\n#### بطاقات الإحصائيات (4 بطاقات):\n- ✅ **أزرق**: إجمالي الطلاب\n- ✅ **أخضر**: المعلمين\n- ✅ **برتقالي**: الاستئذانات\n- ✅ **بنفسجي**: الحالات الخاصة\n\n#### شريط التنقل (7 أزرار):\n- ✅ الصفحة الرئيسية\n- ✅ المعلمين\n- ✅ المجموعات\n- ✅ الحالات الخاصة\n- ✅ استقبال الطلاب\n- ✅ الاستئذان\n- ✅ المخالفات\n\n#### الشريط الجانبي:\n- ✅ قسم التصفية\n- ✅ منسدل الحالات الخاصة (يعرض بيانات حقيقية من API)\n- ✅ منسدل حالة الطالب\n- ✅ زر \"جميع المجموعات\"\n\n#### المنطقة الرئيسية:\n- ✅ بطاقة بحث باللون الفيروزي/الأخضر\n- ✅ عنوان \"استفسار عن طالب\"\n- ✅ حقل بحث كبير\n\n#### الفوتر:\n- ✅ \"تصميم وتطوير: الأستاذ وائل الشيخي\"\n- ✅ رقم الهاتف: 0558890902\n\n### 3. التكامل مع API ✅\n- استخدام `useQuery` لجلب البيانات من API الجديد:\n  - `/api/students` - قائمة الطلاب\n  - `/api/special-statuses` - الحالات الخاصة\n  - `/api/teacher-profile` - ملف المعلم والمدرسة\n- تحديث الإحصائيات في الوقت الفعلي\n- إزالة جميع استيرادات Supabase\n\n### 4. الملفات التوجيهية ✅\n- ✅ `MIGRATION_GUIDE.md` - دليل شامل مع أمثلة\n- ✅ `TODO_MIGRATION.md` - قائمة مفصلة بالمكونات المتبقية\n- ✅ تحديث `replit.md` بحالة الترحيل\n\n## 🎨 التصميم\n\nالواجهة مطابقة بنسبة 100% للصورة المرفقة مع:\n- ✅ الألوان الصحيحة (أزرق، أخضر، برتقالي، بنفسجي)\n- ✅ الترتيب الصحيح للعناصر\n- ✅ الخطوط والأيقونات المطابقة\n- ✅ RTL (من اليمين لليسار) للعربية\n- ✅ الظلال والتدرجات اللونية\n\n## 🔧 التقنيات المستخدمة\n\n- **Frontend**: React 18 + TypeScript\n- **State Management**: React Query (TanStack Query v5)\n- **Styling**: Tailwind CSS\n- **Icons**: Lucide React\n- **Backend**: Express 5 + Drizzle ORM\n- **Database**: Neon PostgreSQL\n\n## 📝 الملاحظات\n\n1. **الواجهة جاهزة** لكن الوظائف الفرعية (البحث، التصفية، الصفحات الأخرى) تحتاج تطوير\n2. **المكونات القديمة** لا تزال موجودة في `components/` وتحتاج ترحيل\n3. **الصفحات الفرعية** (TeachersPage, GroupsPage, إلخ) تحتاج ترحيل\n4. **راجع TODO_MIGRATION.md** لقائمة كاملة بالمهام المتبقية\n\n## 🚀 كيفية الاستخدام\n\n1. سجل الدخول باستخدام:\n   - اسم المستخدم: `admin`\n   - كلمة المرور: `admin123`\n\n2. ستظهر الصفحة الرئيسية الكاملة مع جميع العناصر\n\n3. للبدء بترحيل المكونات الأخرى، راجع `MIGRATION_GUIDE.md`\n\n## ✨ النتيجة\n\nالتطبيق الآن يعمل بكامل الواجهة الأصلية مع بنية تحتية حديثة ومستقرة، جاهز لإضافة الوظائف المتبقية واحدة تلو الأخرى.\n","size_bytes":4444},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL must be set\");\n}\n\nexport default defineConfig({\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":278},"Erchad-1/MIGRATION_STATUS.md":{"content":"# Migration Status - Bolt to Replit\n\n## ✅ Completed\n\n### Backend Infrastructure\n1. **Database Schema** - All tables defined in `shared/schema.ts`:\n   - students, groups, special_statuses, teachers, teacher_groups\n   - student_visits, student_permissions, student_violations\n   - teacher_profile, login_credentials\n\n2. **Database Setup** - Neon PostgreSQL configured and schema pushed successfully\n\n3. **Storage Layer** - `server/dbStorage.ts` implements all CRUD operations for:\n   - Students (including bulk import)\n   - Groups\n   - Special Statuses\n   - Teachers & Teacher Groups\n   - Student Visits, Permissions, Violations\n   - Teacher Profile\n   - Login Credentials\n\n4. **API Routes** - `server/routes.ts` provides REST endpoints:\n   - `/api/groups` - GET, POST, PATCH, DELETE\n   - `/api/special-statuses` - GET, POST, DELETE\n   - `/api/students` - GET, POST, PATCH, DELETE, bulk POST\n   - `/api/teachers` - GET, POST, PATCH, DELETE\n   - `/api/teacher-groups` - GET, POST, DELETE\n   - `/api/student-visits` - GET, POST, DELETE\n   - `/api/student-permissions` - GET, POST, DELETE\n   - `/api/student_violations` - GET, POST, DELETE\n   - `/api/teacher-profile` - GET, POST\n   - `/api/login` - POST\n   - `/api/init-login` - POST\n\n5. **Server Setup** - Express server running on port 5000\n   - Vite dev server integrated\n   - Hot Module Replacement (HMR) working\n   - Request logging enabled\n\n6. **Client Infrastructure**\n   - React Query setup with `@tanstack/react-query`\n   - Query client configured in `client/src/lib/queryClient.ts`\n   - Default fetcher and mutation helper (apiRequest) ready\n\n## 🔨 Next Steps (User Action Required)\n\n### Frontend Component Migration\n\nThe existing components in `client/src/components/` and `client/src/pages/` still use:\n- Supabase client (`client/src/lib/supabase.ts`)\n- IndexedDB (Dexie) (`client/src/lib/db.ts`)\n\nThese need to be updated to use the new API routes. For each component:\n\n1. **Replace Supabase calls** with React Query hooks:\n   ```typescript\n   // Old (Supabase)\n   const { data } = await supabase.from('students').select('*')\n   \n   // New (React Query)\n   const { data, isLoading } = useQuery({ queryKey: ['/api/students'] })\n   ```\n\n2. **Replace IndexedDB** with API mutations:\n   ```typescript\n   // Old (IndexedDB)\n   await db.students.add(student)\n   \n   // New (API)\n   await apiRequest('/api/students', 'POST', student)\n   ```\n\n3. **Update imports**:\n   ```typescript\n   // Remove\n   import { supabase } from '@/lib/supabase'\n   import { db } from '@/lib/db'\n   \n   // Add\n   import { useQuery, useMutation } from '@tanstack/react-query'\n   import { apiRequest, queryClient } from '@/lib/queryClient'\n   ```\n\n### Files to Update\n\n**Main App**: `client/src/App.tsx`\n- Remove Supabase fetchData function\n- Use React Query to fetch groups, statuses, students, teachers, profile\n- Update all state management to use server data\n\n**Components**:\n- `StudentForm.tsx` - Use mutations for creating/updating students\n- `StudentsList.tsx` - Use queries for students, mutations for delete\n- `ExcelImport.tsx` - Use bulk students endpoint\n- `EditStudentModal.tsx` - Use student mutation\n- `ManageModal.tsx` - Use groups/statuses mutations\n- `ProfileSettings.tsx` - Use teacher profile endpoint\n- `SendToTeacherModal.tsx` - Use teachers endpoint\n\n**Pages**:\n- `TeachersPage.tsx` - Use teachers API\n- `GroupsPage.tsx` - Use groups API\n- `GroupsManagementPage.tsx` - Use groups API\n- `SpecialStatusPage.tsx` - Use special statuses + students API\n- `AbsencePage.tsx` - Use violations API\n- `ReceptionPage.tsx` - Use visits API\n- `PermissionPage.tsx` - Use permissions API\n- `LoginPage.tsx` - Use login API\n\n### Clean Up\n\nAfter migration:\n1. Remove `client/src/lib/supabase.ts`\n2. Remove `client/src/lib/db.ts` (Dexie)\n3. Remove `@supabase/supabase-js` dependency\n4. Remove `dexie` dependency\n5. Remove `supabase/` directory\n\n## 📝 Example Migration Pattern\n\nHere's a complete example for the Groups page:\n\n```typescript\n// client/src/pages/GroupsPage.tsx\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport type { Group } from '@shared/schema';\n\nexport function GroupsPage() {\n  // Fetch groups\n  const { data: groups = [], isLoading } = useQuery<Group[]>({\n    queryKey: ['/api/groups']\n  });\n\n  // Create group mutation\n  const createGroup = useMutation({\n    mutationFn: (group: { name: string; stage: string; displayOrder?: number }) =>\n      apiRequest('/api/groups', 'POST', group),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] });\n    }\n  });\n\n  // Delete group mutation\n  const deleteGroup = useMutation({\n    mutationFn: (id: string) =>\n      apiRequest(`/api/groups/${id}`, 'DELETE'),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/groups'] });\n    }\n  });\n\n  if (isLoading) return <div>Loading...</div>;\n\n  return (\n    <div>\n      {groups.map(group => (\n        <div key={group.id}>\n          {group.name} - {group.stage}\n          <button onClick={() => deleteGroup.mutate(group.id)}>\n            Delete\n          </button>\n        </div>\n      ))}\n    </div>\n  );\n}\n```\n\n## 🚀 Running the Project\n\n```bash\n# Development\nnpm run dev\n\n# Production build\nnpm run build\n\n# Production start\nnpm run start\n\n# Database push (after schema changes)\nnpm run db:push\n```\n\n## 📦 Technology Stack\n\n- **Frontend**: React + Vite + TanStack Query\n- **Backend**: Express.js + TypeScript\n- **Database**: Neon PostgreSQL (via Replit)\n- **ORM**: Drizzle ORM\n- **Validation**: Zod\n- **Styling**: Tailwind CSS\n\n## 🔐 Environment Variables\n\nThe following are automatically configured by Replit:\n- `DATABASE_URL` - PostgreSQL connection string\n- `PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE`\n\n## ⚠️ Important Notes\n\n1. **Default Login Credentials**: The system initializes with username `admin` and password `admin123`. You should change this in production.\n\n2. **Port Configuration**: The server runs on port 5000 to work with Replit's webview.\n\n3. **Path Aliases**: Use `@/` for client code, `@shared/` for shared types.\n\n4. **TypeScript**: All types are inferred from the Drizzle schema for type safety.\n","size_bytes":6226},"server/dbStorage.ts":{"content":"import { db } from \"./db.js\";\nimport { eq, desc, sql } from \"drizzle-orm\";\nimport {\n  students, groups, specialStatuses, teachers, teacherGroups,\n  studentVisits, studentPermissions, studentViolations,\n  teacherProfile, loginCredentials,\n  type Student, type InsertStudent,\n  type Group, type InsertGroup,\n  type SpecialStatus, type InsertSpecialStatus,\n  type Teacher, type InsertTeacher,\n  type TeacherGroup, type InsertTeacherGroup,\n  type StudentVisit, type InsertStudentVisit,\n  type StudentPermission, type InsertStudentPermission,\n  type StudentViolation, type InsertStudentViolation,\n  type TeacherProfile, type InsertTeacherProfile,\n  type LoginCredentials, type InsertLoginCredentials\n} from \"../shared/schema.js\";\nimport type { IStorage } from \"./storage.js\";\n\nexport class DbStorage implements IStorage {\n  async getGroups(): Promise<Group[]> {\n    return await db.select().from(groups).orderBy(groups.stage, groups.displayOrder);\n  }\n\n  async getGroupById(id: string): Promise<Group | undefined> {\n    const result = await db.select().from(groups).where(eq(groups.id, id));\n    return result[0];\n  }\n\n  async createGroup(group: InsertGroup): Promise<Group> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(groups).values({ ...group, id }).returning();\n    return result[0];\n  }\n\n  async updateGroup(id: string, group: Partial<InsertGroup>): Promise<Group | undefined> {\n    const result = await db.update(groups).set(group).where(eq(groups.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteGroup(id: string): Promise<boolean> {\n    try {\n      // أولاً: إزالة ارتباط الطلاب بالمجموعة\n      await db.update(students)\n        .set({ groupId: null })\n        .where(eq(students.groupId, id));\n      \n      // ثانياً: إزالة ارتباط المعلمين بالمجموعة\n      await db.delete(teacherGroups).where(eq(teacherGroups.groupId, id));\n      \n      // ثالثاً: حذف المجموعة\n      const result = await db.delete(groups).where(eq(groups.id, id));\n      return result.rowCount ? result.rowCount > 0 : false;\n    } catch (error) {\n      console.error('Error deleting group:', error);\n      return false;\n    }\n  }\n\n  async getSpecialStatuses(): Promise<SpecialStatus[]> {\n    return await db.select().from(specialStatuses).orderBy(specialStatuses.name);\n  }\n\n  async getSpecialStatusById(id: string): Promise<SpecialStatus | undefined> {\n    const result = await db.select().from(specialStatuses).where(eq(specialStatuses.id, id));\n    return result[0];\n  }\n\n  async createSpecialStatus(status: InsertSpecialStatus): Promise<SpecialStatus> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(specialStatuses).values({ ...status, id }).returning();\n    return result[0];\n  }\n\n  async updateSpecialStatus(id: string, status: Partial<InsertSpecialStatus>): Promise<SpecialStatus | undefined> {\n    const result = await db.update(specialStatuses).set(status).where(eq(specialStatuses.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteSpecialStatus(id: string): Promise<boolean> {\n    const result = await db.delete(specialStatuses).where(eq(specialStatuses.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getStudents(): Promise<Student[]> {\n    return await db.select().from(students).orderBy(students.name);\n  }\n\n  async getStudentById(id: string): Promise<Student | undefined> {\n    const result = await db.select().from(students).where(eq(students.id, id));\n    return result[0];\n  }\n\n  async createStudent(student: InsertStudent): Promise<Student> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const result = await db.insert(students).values({ ...student, id, createdAt: now, updatedAt: now }).returning();\n    return result[0];\n  }\n\n  async updateStudent(id: string, student: Partial<InsertStudent>): Promise<Student | undefined> {\n    const now = new Date();\n    const result = await db.update(students).set({ ...student, updatedAt: now }).where(eq(students.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteStudent(id: string): Promise<boolean> {\n    const result = await db.delete(students).where(eq(students.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async createManyStudents(studentsData: InsertStudent[]): Promise<Student[]> {\n    const now = new Date();\n    const studentsWithIds = studentsData.map(s => ({\n      ...s,\n      id: crypto.randomUUID(),\n      createdAt: now,\n      updatedAt: now\n    }));\n    const result = await db.insert(students).values(studentsWithIds).returning();\n    return result;\n  }\n\n  async getTeachers(): Promise<Teacher[]> {\n    return await db.select().from(teachers).orderBy(teachers.name);\n  }\n\n  async getTeacherById(id: string): Promise<Teacher | undefined> {\n    const result = await db.select().from(teachers).where(eq(teachers.id, id));\n    return result[0];\n  }\n\n  async createTeacher(teacher: InsertTeacher): Promise<Teacher> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const result = await db.insert(teachers).values({ ...teacher, id, createdAt: now, updatedAt: now }).returning();\n    return result[0];\n  }\n\n  async updateTeacher(id: string, teacher: Partial<InsertTeacher>): Promise<Teacher | undefined> {\n    const now = new Date();\n    const result = await db.update(teachers).set({ ...teacher, updatedAt: now }).where(eq(teachers.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteTeacher(id: string): Promise<boolean> {\n    const result = await db.delete(teachers).where(eq(teachers.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getTeacherGroups(): Promise<TeacherGroup[]> {\n    return await db.select().from(teacherGroups);\n  }\n\n  async getTeacherGroupsByTeacherId(teacherId: string): Promise<TeacherGroup[]> {\n    return await db.select().from(teacherGroups).where(eq(teacherGroups.teacherId, teacherId));\n  }\n\n  async createTeacherGroup(teacherGroup: InsertTeacherGroup): Promise<TeacherGroup> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(teacherGroups).values({ ...teacherGroup, id }).returning();\n    return result[0];\n  }\n\n  async deleteTeacherGroup(id: string): Promise<boolean> {\n    const result = await db.delete(teacherGroups).where(eq(teacherGroups.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getStudentVisits(): Promise<StudentVisit[]> {\n    return await db.select().from(studentVisits).orderBy(desc(studentVisits.visitDate));\n  }\n\n  async getStudentVisitsByStudentId(studentId: string): Promise<StudentVisit[]> {\n    return await db.select().from(studentVisits).where(eq(studentVisits.studentId, studentId)).orderBy(desc(studentVisits.visitDate));\n  }\n\n  async createStudentVisit(visit: InsertStudentVisit): Promise<StudentVisit> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(studentVisits).values({ ...visit, id }).returning();\n    \n    // تحديث عداد الزيارات للطالب (atomic increment لتجنب race conditions)\n    if (visit.studentId) {\n      await db.update(students)\n        .set({ visitCount: sql`COALESCE(${students.visitCount}, 0) + 1` })\n        .where(eq(students.id, visit.studentId));\n    }\n    \n    return result[0];\n  }\n\n  async deleteStudentVisit(id: string): Promise<boolean> {\n    try {\n      // جلب الزيارة أولاً لمعرفة الطالب\n      const visits = await db.select().from(studentVisits).where(eq(studentVisits.id, id));\n      const visit = visits[0];\n      \n      if (!visit) return false;\n      \n      // حذف الزيارة\n      const result = await db.delete(studentVisits).where(eq(studentVisits.id, id));\n      \n      // تحديث عداد الزيارات للطالب (تقليل بواحد)\n      if (visit.studentId && result.rowCount && result.rowCount > 0) {\n        await db.update(students)\n          .set({ visitCount: sql`GREATEST(COALESCE(${students.visitCount}, 0) - 1, 0)` })\n          .where(eq(students.id, visit.studentId));\n      }\n      \n      return result.rowCount ? result.rowCount > 0 : false;\n    } catch (error) {\n      console.error('Error deleting student visit:', error);\n      return false;\n    }\n  }\n\n  async getStudentPermissions(): Promise<StudentPermission[]> {\n    return await db.select().from(studentPermissions).orderBy(desc(studentPermissions.permissionDate));\n  }\n\n  async getStudentPermissionsByStudentId(studentId: string): Promise<StudentPermission[]> {\n    return await db.select().from(studentPermissions).where(eq(studentPermissions.studentId, studentId)).orderBy(desc(studentPermissions.permissionDate));\n  }\n\n  async createStudentPermission(permission: InsertStudentPermission): Promise<StudentPermission> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(studentPermissions).values({ ...permission, id }).returning();\n    return result[0];\n  }\n\n  async deleteStudentPermission(id: string): Promise<boolean> {\n    const result = await db.delete(studentPermissions).where(eq(studentPermissions.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getStudentViolations(): Promise<StudentViolation[]> {\n    return await db.select().from(studentViolations).orderBy(desc(studentViolations.violationDate));\n  }\n\n  async getStudentViolationsByStudentId(studentId: string): Promise<StudentViolation[]> {\n    return await db.select().from(studentViolations).where(eq(studentViolations.studentId, studentId)).orderBy(desc(studentViolations.violationDate));\n  }\n\n  async createStudentViolation(violation: InsertStudentViolation): Promise<StudentViolation> {\n    const id = crypto.randomUUID();\n    const result = await db.insert(studentViolations).values({ ...violation, id }).returning();\n    return result[0];\n  }\n\n  async deleteStudentViolation(id: string): Promise<boolean> {\n    const result = await db.delete(studentViolations).where(eq(studentViolations.id, id));\n    return result.rowCount ? result.rowCount > 0 : false;\n  }\n\n  async getTeacherProfile(): Promise<TeacherProfile | undefined> {\n    const result = await db.select().from(teacherProfile);\n    return result[0];\n  }\n\n  async createOrUpdateTeacherProfile(profile: InsertTeacherProfile): Promise<TeacherProfile> {\n    const existing = await this.getTeacherProfile();\n    if (existing) {\n      const result = await db.update(teacherProfile).set(profile).where(eq(teacherProfile.id, existing.id)).returning();\n      return result[0];\n    } else {\n      const id = crypto.randomUUID();\n      const result = await db.insert(teacherProfile).values({ ...profile, id }).returning();\n      return result[0];\n    }\n  }\n\n  async getLoginCredentials(username: string): Promise<LoginCredentials | undefined> {\n    const result = await db.select().from(loginCredentials).where(eq(loginCredentials.username, username));\n    return result[0];\n  }\n\n  async createLoginCredentials(credentials: InsertLoginCredentials): Promise<LoginCredentials> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const result = await db.insert(loginCredentials).values({ ...credentials, id, createdAt: now, updatedAt: now }).returning();\n    return result[0];\n  }\n\n  async updateLoginCredentials(id: string, credentials: Partial<InsertLoginCredentials>): Promise<LoginCredentials | undefined> {\n    const now = new Date();\n    const result = await db.update(loginCredentials).set({ ...credentials, updatedAt: now }).where(eq(loginCredentials.id, id)).returning();\n    return result[0];\n  }\n\n  async clearDatabase(): Promise<void> {\n    // حذف جميع البيانات من الجداول بالترتيب الصحيح\n    await db.delete(studentViolations);\n    await db.delete(studentPermissions);\n    await db.delete(studentVisits);\n    await db.delete(teacherGroups);\n    await db.delete(students);\n    await db.delete(teachers);\n    await db.delete(specialStatuses);\n    await db.delete(groups);\n  }\n\n  async createPasswordResetToken(username: string): Promise<{ token: string, expiresAt: string } | null> {\n    const user = await this.getLoginCredentials(username);\n    if (!user) return null;\n\n    // إنشاء رمز عشوائي مكون من 6 أرقام\n    const token = Math.floor(100000 + Math.random() * 900000).toString();\n    \n    // انتهاء الرمز بعد ساعة واحدة\n    const expiresAt = new Date(Date.now() + 60 * 60 * 1000).toISOString();\n\n    await db.update(loginCredentials)\n      .set({ resetToken: token, resetTokenExpires: expiresAt, updatedAt: new Date() })\n      .where(eq(loginCredentials.id, user.id));\n\n    return { token, expiresAt };\n  }\n\n  async verifyPasswordResetToken(username: string, token: string): Promise<boolean> {\n    const user = await this.getLoginCredentials(username);\n    if (!user || !user.resetToken || !user.resetTokenExpires) return false;\n\n    // التحقق من صحة الرمز\n    if (user.resetToken !== token) return false;\n\n    // التحقق من عدم انتهاء صلاحية الرمز\n    const expiresAt = new Date(user.resetTokenExpires);\n    if (expiresAt < new Date()) return false;\n\n    return true;\n  }\n\n  async resetPassword(username: string, token: string, newPassword: string): Promise<boolean> {\n    const isValid = await this.verifyPasswordResetToken(username, token);\n    if (!isValid) return false;\n\n    const user = await this.getLoginCredentials(username);\n    if (!user) return false;\n\n    // تحديث كلمة المرور وحذف الرمز\n    await db.update(loginCredentials)\n      .set({ \n        passwordHash: newPassword, \n        resetToken: null, \n        resetTokenExpires: null,\n        updatedAt: new Date() \n      })\n      .where(eq(loginCredentials.id, user.id));\n\n    return true;\n  }\n}\n\nexport const storage = new DbStorage();\n","size_bytes":13851},"Erchad-1/server/storage.ts":{"content":"import type {\n  Student, InsertStudent,\n  Group, InsertGroup,\n  SpecialStatus, InsertSpecialStatus,\n  Teacher, InsertTeacher,\n  TeacherGroup, InsertTeacherGroup,\n  StudentVisit, InsertStudentVisit,\n  StudentPermission, InsertStudentPermission,\n  StudentViolation, InsertStudentViolation,\n  TeacherProfile, InsertTeacherProfile,\n  LoginCredentials, InsertLoginCredentials\n} from \"../shared/schema.js\";\n\nexport interface IStorage {\n  // Groups\n  getGroups(): Promise<Group[]>;\n  getGroupById(id: string): Promise<Group | undefined>;\n  createGroup(group: InsertGroup): Promise<Group>;\n  updateGroup(id: string, group: Partial<InsertGroup>): Promise<Group | undefined>;\n  deleteGroup(id: string): Promise<boolean>;\n\n  // Special Statuses\n  getSpecialStatuses(): Promise<SpecialStatus[]>;\n  getSpecialStatusById(id: string): Promise<SpecialStatus | undefined>;\n  createSpecialStatus(status: InsertSpecialStatus): Promise<SpecialStatus>;\n  updateSpecialStatus(id: string, status: Partial<InsertSpecialStatus>): Promise<SpecialStatus | undefined>;\n  deleteSpecialStatus(id: string): Promise<boolean>;\n\n  // Students\n  getStudents(): Promise<Student[]>;\n  getStudentById(id: string): Promise<Student | undefined>;\n  createStudent(student: InsertStudent): Promise<Student>;\n  updateStudent(id: string, student: Partial<InsertStudent>): Promise<Student | undefined>;\n  deleteStudent(id: string): Promise<boolean>;\n  createManyStudents(students: InsertStudent[]): Promise<Student[]>;\n\n  // Teachers\n  getTeachers(): Promise<Teacher[]>;\n  getTeacherById(id: string): Promise<Teacher | undefined>;\n  createTeacher(teacher: InsertTeacher): Promise<Teacher>;\n  updateTeacher(id: string, teacher: Partial<InsertTeacher>): Promise<Teacher | undefined>;\n  deleteTeacher(id: string): Promise<boolean>;\n\n  // Teacher Groups\n  getTeacherGroups(): Promise<TeacherGroup[]>;\n  getTeacherGroupsByTeacherId(teacherId: string): Promise<TeacherGroup[]>;\n  createTeacherGroup(teacherGroup: InsertTeacherGroup): Promise<TeacherGroup>;\n  deleteTeacherGroup(id: string): Promise<boolean>;\n\n  // Student Visits\n  getStudentVisits(): Promise<StudentVisit[]>;\n  getStudentVisitsByStudentId(studentId: string): Promise<StudentVisit[]>;\n  createStudentVisit(visit: InsertStudentVisit): Promise<StudentVisit>;\n  deleteStudentVisit(id: string): Promise<boolean>;\n\n  // Student Permissions\n  getStudentPermissions(): Promise<StudentPermission[]>;\n  getStudentPermissionsByStudentId(studentId: string): Promise<StudentPermission[]>;\n  createStudentPermission(permission: InsertStudentPermission): Promise<StudentPermission>;\n  deleteStudentPermission(id: string): Promise<boolean>;\n\n  // Student Violations\n  getStudentViolations(): Promise<StudentViolation[]>;\n  getStudentViolationsByStudentId(studentId: string): Promise<StudentViolation[]>;\n  createStudentViolation(violation: InsertStudentViolation): Promise<StudentViolation>;\n  deleteStudentViolation(id: string): Promise<boolean>;\n\n  // Teacher Profile\n  getTeacherProfile(): Promise<TeacherProfile | undefined>;\n  createOrUpdateTeacherProfile(profile: InsertTeacherProfile): Promise<TeacherProfile>;\n\n  // Login Credentials\n  getLoginCredentials(username: string): Promise<LoginCredentials | undefined>;\n  createLoginCredentials(credentials: InsertLoginCredentials): Promise<LoginCredentials>;\n  updateLoginCredentials(id: string, credentials: Partial<InsertLoginCredentials>): Promise<LoginCredentials | undefined>;\n  \n  // Password Reset\n  createPasswordResetToken(username: string): Promise<{ token: string, expiresAt: string } | null>;\n  verifyPasswordResetToken(username: string, token: string): Promise<boolean>;\n  resetPassword(username: string, token: string, newPassword: string): Promise<boolean>;\n\n  // Clear Database\n  clearDatabase(): Promise<void>;\n}\n","size_bytes":3783},"client/src/components/SendToTeacherModal.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { X, Send } from 'lucide-react'\nimport { Teacher, Group, Student } from '../types'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface SendToTeacherModalProps {\n  isOpen: boolean\n  onClose: () => void\n  specialStatusStudents: Student[]\n}\n\nexport function SendToTeacherModal({\n  isOpen,\n  onClose,\n  specialStatusStudents,\n}: SendToTeacherModalProps) {\n  const [teachers, setTeachers] = useState<Teacher[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [allGroups, setAllGroups] = useState<Group[]>([])\n  const [stages, setStages] = useState<string[]>([])\n  const [selectedTeacherId, setSelectedTeacherId] = useState('')\n  const [selectedStage, setSelectedStage] = useState('')\n  const [selectedGroupIds, setSelectedGroupIds] = useState<string[]>([])\n  const [loading, setLoading] = useState(false)\n  const [counselorName, setCounselorName] = useState('')\n  const [counselorPhone, setCounselorPhone] = useState('')\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchTeachers()\n      fetchGroups()\n      fetchCounselorInfo()\n    }\n  }, [isOpen])\n\n  const fetchCounselorInfo = async () => {\n    const { data } = await supabase\n      .from('teacher_profile')\n      .select('name, phone')\n      .maybeSingle()\n\n    if (data) {\n      setCounselorName(data.name || '')\n      setCounselorPhone(data.phone || '')\n    }\n  }\n\n  const fetchTeachers = async () => {\n    const { data } = await supabase\n      .from('teachers')\n      .select('*')\n      .order('name')\n\n    if (data) setTeachers(data)\n  }\n\n  const fetchGroups = async () => {\n    const { data } = await supabase\n      .from('groups')\n      .select('*')\n      .order('display_order')\n\n    if (data) {\n      setAllGroups(data)\n      const uniqueStages = [...new Set(data.map(g => g.stage))]\n      setStages(uniqueStages)\n    }\n  }\n\n  useEffect(() => {\n    if (selectedStage) {\n      const stageGroups = allGroups.filter(g => g.stage === selectedStage)\n      setGroups(stageGroups)\n      setSelectedGroupIds([])\n    } else {\n      setGroups([])\n      setSelectedGroupIds([])\n    }\n  }, [selectedStage, allGroups])\n\n  const toggleGroup = (groupId: string) => {\n    if (selectedGroupIds.includes(groupId)) {\n      setSelectedGroupIds(selectedGroupIds.filter(id => id !== groupId))\n    } else {\n      setSelectedGroupIds([...selectedGroupIds, groupId])\n    }\n  }\n\n\n  const handleSend = async () => {\n    if (!selectedTeacherId) {\n      alert('الرجاء اختيار المعلم')\n      return\n    }\n\n    if (!selectedStage) {\n      alert('الرجاء اختيار المرحلة')\n      return\n    }\n\n    if (selectedGroupIds.length === 0) {\n      alert('الرجاء اختيار مجموعة واحدة على الأقل')\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      const teacher = teachers.find(t => t.id === selectedTeacherId)\n      if (!teacher) return\n\n      // فلتر الطلاب حسب المجموعات المختارة\n      const filteredStudents = specialStatusStudents.filter(\n        student => selectedGroupIds.includes(student.group_id)\n      )\n\n      if (filteredStudents.length === 0) {\n        alert('لا يوجد طلاب ذوي حالات خاصة في المجموعات المختارة')\n        setLoading(false)\n        return\n      }\n\n      // إنشاء رسالة واتساب\n      let message = ''\n      const selectedGroups = allGroups.filter(g => selectedGroupIds.includes(g.id))\n\n      message += `*الحالات الخاصة - ${selectedStage}*\\n\\n`\n\n      // تجميع الطلاب حسب المجموعة\n      selectedGroups.forEach((group) => {\n        const groupStudents = filteredStudents.filter(s => s.group_id === group.id)\n        if (groupStudents.length > 0) {\n          message += `📚 *${group.name}*\\n`\n          groupStudents.forEach((student, index) => {\n            message += `${index + 1}. *${student.name}*\\n`\n            message += `   الحالة: ${student.special_status?.name || '-'}\\n`\n            message += `   جوال الطالب: ${student.phone || '-'}\\n`\n            message += `   جوال ولي الأمر: ${student.guardian_phone || '-'}\\n\\n`\n          })\n          message += '\\n'\n        }\n      })\n\n      message += `\\n${counselorName ? counselorName : 'مسؤول النظام'}`\n      if (counselorPhone) {\n        message += `\\n📱 ${counselorPhone}`\n      }\n\n      // فتح واتساب\n      const encodedMessage = encodeURIComponent(message)\n      const phoneNumber = formatPhoneForWhatsApp(teacher.phone)\n      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`\n\n      window.open(whatsappUrl, '_blank')\n\n      onClose()\n    } catch (error) {\n      console.error('Error sending to teacher:', error)\n      alert('حدث خطأ أثناء الإرسال')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  if (!isOpen) return null\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Send className=\"text-green-600\" size={24} />\n            <h2 className=\"text-2xl font-bold text-gray-900\">إرسال للمعلم</h2>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-500 hover:text-gray-700 transition-colors\"\n          >\n            <X size={24} />\n          </button>\n        </div>\n\n        <div className=\"p-6 space-y-6\">\n          <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n            <p className=\"text-sm text-blue-800\">\n              سيتم إرسال بيانات الطلاب ذوي الحالات الخاصة في المجموعة المحددة إلى المعلم عبر واتساب\n            </p>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المعلم <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              value={selectedTeacherId}\n              onChange={(e) => setSelectedTeacherId(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n            >\n              <option value=\"\">-- اختر المعلم --</option>\n              {teachers.map((teacher) => (\n                <option key={teacher.id} value={teacher.id}>\n                  {teacher.name} - {teacher.specialization}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المرحلة <span className=\"text-red-500\">*</span>\n            </label>\n            <select\n              value={selectedStage}\n              onChange={(e) => setSelectedStage(e.target.value)}\n              className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n            >\n              <option value=\"\">-- اختر المرحلة --</option>\n              {stages.map((stage) => (\n                <option key={stage} value={stage}>\n                  {stage}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              اختر المجموعة <span className=\"text-red-500\">*</span>\n            </label>\n            {!selectedStage ? (\n              <div className=\"bg-gray-50 border border-gray-300 rounded-lg p-4 text-center\">\n                <p className=\"text-sm text-gray-500\">اختر المرحلة أولاً</p>\n              </div>\n            ) : groups.length === 0 ? (\n              <div className=\"bg-gray-50 border border-gray-300 rounded-lg p-4 text-center\">\n                <p className=\"text-sm text-gray-500\">لا توجد مجموعات في هذه المرحلة</p>\n              </div>\n            ) : (\n              <div className=\"border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto space-y-2\">\n                {groups.map((group) => {\n                  const isSelected = selectedGroupIds.includes(group.id)\n                  const studentsCount = specialStatusStudents.filter(s => s.group_id === group.id).length\n                  return (\n                    <label\n                      key={group.id}\n                      className={`flex items-center gap-3 p-3 rounded-lg border-2 transition-all cursor-pointer ${\n                        isSelected\n                          ? 'bg-green-50 border-green-500'\n                          : 'bg-white border-gray-200 hover:border-gray-300'\n                      }`}\n                    >\n                      <input\n                        type=\"checkbox\"\n                        checked={isSelected}\n                        onChange={() => toggleGroup(group.id)}\n                        className=\"w-5 h-5 text-green-600 border-gray-300 rounded focus:ring-green-500\"\n                      />\n                      <div className=\"flex-1\">\n                        <span className={`font-medium ${\n                          isSelected ? 'text-green-900' : 'text-gray-900'\n                        }`}>\n                          {group.name}\n                        </span>\n                        {studentsCount > 0 && (\n                          <span className=\"text-xs text-gray-500 mr-2\">\n                            ({studentsCount} طالب)\n                          </span>\n                        )}\n                      </div>\n                    </label>\n                  )\n                })}\n              </div>\n            )}\n            {selectedGroupIds.length > 0 && (\n              <p className=\"text-xs text-green-600 mt-2\">\n                تم اختيار {selectedGroupIds.length} مجموعة\n              </p>\n            )}\n          </div>\n\n\n          <div className=\"flex gap-3 pt-4\">\n            <button\n              onClick={handleSend}\n              disabled={loading || !selectedTeacherId || !selectedStage || selectedGroupIds.length === 0}\n              className=\"flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n            >\n              <Send size={20} />\n              {loading ? 'جاري الإرسال...' : 'إرسال عبر واتساب'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"px-6 py-3 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-medium rounded-lg transition-colors\"\n            >\n              إلغاء\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":11129},"client/src/lib/formatPhone.ts":{"content":"/**\n * تنسيق رقم الجوال للاستخدام في واتساب\n * يزيل جميع الأحرف غير الرقمية\n * يزيل رمز الدولة 966 إن وجد\n * يزيل جميع الأصفار من البداية\n * يضيف رمز الدولة 966 (السعودية)\n * \n * @param phone رقم الجوال (مثال: 0555555555 أو 9660555555555 أو 00966555555555)\n * @returns رقم منسق للواتساب (مثال: 966555555555) أو نص فارغ إذا كان الرقم غير صالح\n */\nexport function formatPhoneForWhatsApp(phone: string | undefined | null): string {\n  if (!phone) return ''\n  \n  // إزالة جميع الأحرف غير الرقمية\n  let cleaned = phone.replace(/\\D/g, '')\n  \n  // إزالة جميع الأصفار من البداية (للتعامل مع 00966...)\n  cleaned = cleaned.replace(/^0+/, '')\n  \n  // إزالة 966 إذا كانت موجودة بالفعل\n  if (cleaned.startsWith('966')) {\n    cleaned = cleaned.substring(3)\n  }\n  \n  // إزالة الأصفار من البداية مرة أخرى (للتعامل مع 9660...)\n  cleaned = cleaned.replace(/^0+/, '')\n  \n  // إذا كان الرقم فارغاً بعد التنظيف، إرجاع نص فارغ\n  if (!cleaned) return ''\n  \n  // إضافة رمز الدولة 966\n  return '966' + cleaned\n}\n","size_bytes":1339},"Erchad-1/client/src/components/StudentsList.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { Student, SpecialStatus, SchoolInfo } from '../types'\nimport { supabase } from '../lib/supabase'\nimport { Trash2, Edit2, MoreVertical, Printer, DoorOpen } from 'lucide-react'\nimport { AllowClassEntryModal } from './AllowClassEntryModal'\n\ninterface StudentsListProps {\n  students: Student[]\n  groupName: string\n  specialStatuses: SpecialStatus[]\n  onStudentDeleted: () => void\n  onEditStudent: (student: Student) => void\n}\n\nexport function StudentsList({\n  students,\n  groupName,\n  specialStatuses,\n  onStudentDeleted,\n  onEditStudent,\n}: StudentsListProps) {\n  const [expandedId, setExpandedId] = useState<string | null>(null)\n  const [loadingDelete, setLoadingDelete] = useState<string | null>(null)\n  const [schoolInfo, setSchoolInfo] = useState<SchoolInfo | null>(null)\n  const [showAllowEntryModal, setShowAllowEntryModal] = useState(false)\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n\n  useEffect(() => {\n    fetchSchoolInfo()\n  }, [])\n\n  const fetchSchoolInfo = async () => {\n    const { data } = await supabase\n      .from('school_info')\n      .select('*')\n      .limit(1)\n      .maybeSingle()\n\n    if (data) setSchoolInfo(data)\n  }\n\n\n  const handleDelete = async (studentId: string) => {\n    if (!window.confirm('هل أنت متأكد من حذف هذا الطالب؟')) return\n\n    setLoadingDelete(studentId)\n    try {\n      const { error } = await supabase\n        .from('students')\n        .delete()\n        .eq('id', studentId)\n\n      if (error) throw error\n      onStudentDeleted()\n    } finally {\n      setLoadingDelete(null)\n    }\n  }\n\n\n  const handleMoveStudent = async (\n    studentId: string,\n    currentGroupId: string,\n    newGroupId: string\n  ) => {\n    if (!newGroupId || newGroupId === currentGroupId) return\n\n    try {\n      const { error } = await supabase\n        .from('students')\n        .update({ group_id: newGroupId })\n        .eq('id', studentId)\n\n      if (error) throw error\n      onStudentDeleted()\n    } finally {\n      setExpandedId(null)\n    }\n  }\n\n  const getSpecialStatusName = (statusId: string | null) => {\n    if (!statusId) return '-'\n    return specialStatuses.find((s) => s.id === statusId)?.name || '-'\n  }\n\n  const printStudent = async (student: Student) => {\n    const specialStatusName = student.special_status_id\n      ? getSpecialStatusName(student.special_status_id)\n      : 'لا يوجد'\n    const groupName = student.group?.name || '-'\n    const now = new Date()\n    const date = now.toLocaleDateString('ar-SA')\n    const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })\n\n    // Fetch teacher name and school name\n    const { data: teacherProfile } = await supabase\n      .from('teacher_profile')\n      .select('*')\n      .maybeSingle()\n\n    const teacherName = teacherProfile?.name || ''\n    const schoolName = teacherProfile?.school_name || schoolInfo?.school_name || 'اسم المدرسة'\n\n\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>بيانات الطالب - ${student.name}</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n\n            @page {\n              size: A4;\n              margin: 15mm;\n            }\n\n            body {\n              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n              background: white;\n              color: #1a1a1a;\n              line-height: 1.4;\n              font-size: 13px;\n            }\n\n            .page-container {\n              max-width: 210mm;\n              margin: 0 auto;\n              background: white;\n            }\n\n            .header {\n              background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);\n              color: white;\n              padding: 15px 20px;\n              text-align: center;\n              border-radius: 8px 8px 0 0;\n            }\n\n            .header h1 {\n              font-size: 22px;\n              margin-bottom: 4px;\n              font-weight: 700;\n            }\n\n            .header .school-name {\n              font-size: 16px;\n              margin-bottom: 8px;\n              opacity: 0.95;\n              font-weight: 500;\n            }\n\n            .header .meta {\n              font-size: 11px;\n              opacity: 0.9;\n              margin-top: 6px;\n            }\n\n            .content {\n              padding: 20px;\n            }\n\n            .student-name-section {\n              background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);\n              border: 2px solid #3b82f6;\n              border-radius: 8px;\n              padding: 12px;\n              margin-bottom: 15px;\n              text-align: center;\n            }\n\n            .student-name-section h2 {\n              color: #1e40af;\n              font-size: 20px;\n              font-weight: 700;\n            }\n\n            .info-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 10px;\n              margin-bottom: 15px;\n            }\n\n            .info-item {\n              background: #f9fafb;\n              border: 1px solid #e5e7eb;\n              border-radius: 6px;\n              padding: 10px;\n            }\n\n            .info-label {\n              font-size: 11px;\n              color: #6b7280;\n              font-weight: 600;\n              margin-bottom: 4px;\n            }\n\n            .info-value {\n              font-size: 14px;\n              color: #111827;\n              font-weight: 600;\n            }\n\n\n            .footer {\n              background: #f9fafb;\n              padding: 15px 20px;\n              border-top: 2px solid #e5e7eb;\n              margin-top: 15px;\n            }\n\n            .footer-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 20px;\n            }\n\n            .signature-box {\n              text-align: center;\n            }\n\n            .signature-label {\n              font-size: 12px;\n              color: #6b7280;\n              font-weight: 600;\n              margin-bottom: 6px;\n            }\n\n            .signature-line {\n              border-top: 2px solid #374151;\n              width: 150px;\n              margin: 30px auto 8px;\n            }\n\n            .signature-name {\n              font-size: 14px;\n              color: #111827;\n              font-weight: 600;\n            }\n\n            .print-info {\n              text-align: center;\n              color: #9ca3af;\n              font-size: 10px;\n              margin-top: 15px;\n              padding-top: 15px;\n              border-top: 1px solid #e5e7eb;\n            }\n\n            @media print {\n              body {\n                background: white;\n              }\n\n              .page-container {\n                border: none;\n                border-radius: 0;\n              }\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"page-container\">\n            <div class=\"header\">\n              <div class=\"school-name\">${schoolName}</div>\n              <h1>بطاقة بيانات الطالب</h1>\n              <div class=\"meta\">طُبع بتاريخ: ${date} - الساعة: ${time}${teacherName ? ' - بواسطة: ' + teacherName : ''}</div>\n            </div>\n\n            <div class=\"content\">\n              <div class=\"student-name-section\">\n                <h2>${student.name}</h2>\n              </div>\n\n              <div class=\"info-grid\">\n                <div class=\"info-item\">\n                  <div class=\"info-label\">السجل المدني</div>\n                  <div class=\"info-value\">${student.national_id}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الصف الدراسي</div>\n                  <div class=\"info-value\">${student.grade}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الفصل</div>\n                  <div class=\"info-value\">${groupName}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">جوال الطالب</div>\n                  <div class=\"info-value\">${student.phone}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">جوال ولي الأمر</div>\n                  <div class=\"info-value\">${student.guardian_phone}</div>\n                </div>\n\n                <div class=\"info-item\">\n                  <div class=\"info-label\">الظروف الخاصة</div>\n                  <div class=\"info-value\">${specialStatusName}</div>\n                </div>\n              </div>\n\n            </div>\n\n            <div class=\"footer\">\n              <div class=\"footer-grid\">\n                <div class=\"signature-box\">\n                  <div class=\"signature-label\">المرشد الطلابي</div>\n                  <div class=\"signature-name\">${teacherName || 'اسم المرشد الطلابي'}</div>\n                  <div class=\"signature-line\"></div>\n                  <div style=\"font-size: 11px; color: #6b7280;\">التوقيع</div>\n                </div>\n\n                <div class=\"signature-box\">\n                  <div class=\"signature-label\">الإدارة</div>\n                  <div class=\"signature-line\"></div>\n                  <div style=\"font-size: 11px; color: #6b7280;\">التوقيع والختم</div>\n                </div>\n              </div>\n\n              <div class=\"print-info\">\n                هذه الوثيقة صادرة من الإرشاد الطلابي\n              </div>\n            </div>\n          </div>\n\n          <script>\n            window.onload = () => {\n              setTimeout(() => {\n                window.print();\n                window.onafterprint = () => window.close();\n              }, 250);\n            };\n          </script>\n        </body>\n      </html>\n    `)\n    printWindow.document.close()\n  }\n\n  if (students.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-8 text-center\">\n        <p className=\"text-gray-500\">لا توجد طلاب في {groupName}</p>\n      </div>\n    )\n  }\n\n  const groupColors = [\n    { bg: 'bg-blue-50', border: 'border-blue-200', header: 'bg-gradient-to-r from-blue-400 to-blue-500', text: 'text-blue-900' },\n    { bg: 'bg-green-50', border: 'border-green-200', header: 'bg-gradient-to-r from-green-400 to-green-500', text: 'text-green-900' },\n    { bg: 'bg-orange-50', border: 'border-orange-200', header: 'bg-gradient-to-r from-orange-400 to-orange-500', text: 'text-orange-900' },\n    { bg: 'bg-teal-50', border: 'border-teal-200', header: 'bg-gradient-to-r from-teal-400 to-teal-500', text: 'text-teal-900' },\n    { bg: 'bg-pink-50', border: 'border-pink-200', header: 'bg-gradient-to-r from-pink-400 to-pink-500', text: 'text-pink-900' },\n    { bg: 'bg-cyan-50', border: 'border-cyan-200', header: 'bg-gradient-to-r from-cyan-400 to-cyan-500', text: 'text-cyan-900' },\n  ]\n\n  const groupIndex = groupName.charCodeAt(0) % groupColors.length\n  const colors = groupColors[groupIndex]\n\n  return (\n    <div className=\"space-y-2\">\n        <div className={`${colors.header} text-white px-4 py-3 rounded-lg shadow-md mb-4`}>\n          <h3 className=\"text-lg font-bold flex items-center justify-between\">\n            <span>{groupName}</span>\n            <span className=\"bg-white/20 px-3 py-1 rounded-full text-sm\">{students.length} طالب</span>\n          </h3>\n        </div>\n        <div className=\"space-y-2\">\n          {students.map((student) => {\n            const hasSpecialStatus = student.special_status_id !== null\n            const bgColorClass = hasSpecialStatus\n              ? 'bg-amber-50 border-amber-200'\n              : `${colors.bg} ${colors.border}`\n\n            return (\n          <div\n            key={student.id}\n            className={`${bgColorClass} rounded-lg shadow-sm border-2 hover:shadow-md transition-shadow`}\n          >\n            <div className=\"p-4\">\n              <div className=\"flex items-start justify-between mb-2\">\n                <div className=\"flex-1\">\n                  <h4 className=\"font-bold text-gray-800\">{student.name}</h4>\n                  <p className=\"text-sm text-gray-600\">السجل: {student.national_id}</p>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {student.status === 'استئذان' && (\n                    <span className=\"px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800\">\n                      استئذان\n                    </span>\n                  )}\n                  {student.special_status_id && (\n                    <span className=\"px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800\">\n                      {getSpecialStatusName(student.special_status_id)}\n                    </span>\n                  )}\n                  <button\n                    onClick={() => setExpandedId(expandedId === student.id ? null : student.id)}\n                    className=\"p-1 hover:bg-gray-100 rounded\"\n                  >\n                    <MoreVertical size={20} />\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-gray-600 mb-2\">\n                <div>الصف: {student.grade}</div>\n                <div>جوال: {student.phone}</div>\n                <div>ولي أمر: {student.guardian_phone}</div>\n              </div>\n\n              {expandedId === student.id && (\n                <div className=\"mt-4 pt-4 border-t border-gray-200 space-y-2\">\n                  <button\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setShowAllowEntryModal(true)\n                      setExpandedId(null)\n                    }}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white rounded font-medium text-sm shadow-sm\"\n                  >\n                    <DoorOpen size={16} />\n                    السماح بدخول الفصل\n                  </button>\n\n                  <button\n                    onClick={() => printStudent(student)}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 text-slate-800 rounded font-medium text-sm border border-slate-300 shadow-sm\"\n                  >\n                    <Printer size={16} />\n                    طباعة بيانات الطالب\n                  </button>\n\n                  <button\n                    onClick={() => {\n                      setExpandedId(null)\n                      onEditStudent(student)\n                    }}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-amber-100 to-yellow-100 hover:from-amber-200 hover:to-yellow-200 text-amber-900 rounded font-medium text-sm border border-amber-300 shadow-sm\"\n                  >\n                    <Edit2 size={16} />\n                    تعديل\n                  </button>\n\n                  <button\n                    onClick={() => handleDelete(student.id)}\n                    disabled={loadingDelete === student.id}\n                    className=\"w-full flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-red-100 to-rose-100 hover:from-red-200 hover:to-rose-200 text-red-700 rounded font-medium text-sm border border-red-300 shadow-sm disabled:opacity-50\"\n                  >\n                    <Trash2 size={16} />\n                    {loadingDelete === student.id ? 'جاري...' : 'حذف'}\n                  </button>\n                </div>\n              )}\n            </div>\n          </div>\n            )\n          })}\n      </div>\n\n      <AllowClassEntryModal\n        isOpen={showAllowEntryModal}\n        onClose={() => {\n          setShowAllowEntryModal(false)\n          setSelectedStudent(null)\n        }}\n        student={selectedStudent}\n      />\n    </div>\n  )\n}\n","size_bytes":16391},"Erchad-1/client/src/components/FiltersPanel.tsx":{"content":"import { SpecialStatus } from '../types'\nimport { ChevronDown } from 'lucide-react'\nimport { useState } from 'react'\n\ninterface FiltersPanelProps {\n  specialStatuses: SpecialStatus[]\n  filter: {\n    type: 'status' | 'special_status' | null\n    value: string\n  } | null\n  onFilterChange: (filter: any) => void\n}\n\nexport function FiltersPanel({\n  specialStatuses,\n  filter,\n  onFilterChange,\n}: FiltersPanelProps) {\n  const [isSpecialStatusOpen, setIsSpecialStatusOpen] = useState(false)\n  const [isStudentStatusOpen, setIsStudentStatusOpen] = useState(false)\n\n  const getSpecialStatusLabel = () => {\n    if (!filter || filter.type !== 'special_status') return 'الكل'\n    if (filter.value === 'none') return 'بدون حالة خاصة'\n    const status = specialStatuses.find((s) => s.id === filter.value)\n    return status?.name || 'الكل'\n  }\n\n  const getStudentStatusLabel = () => {\n    if (!filter || filter.type !== 'status') return 'الكل'\n    return filter.value\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <div className=\"space-y-3\">\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            الحالات الخاصة\n          </label>\n          <div className=\"relative\">\n            <button\n              onClick={() => setIsSpecialStatusOpen(!isSpecialStatusOpen)}\n              className=\"w-full px-3 py-2 border border-orange-300 rounded-lg text-right text-sm font-medium bg-orange-50 hover:bg-orange-100 flex items-center justify-between\"\n            >\n              <span>{getSpecialStatusLabel()}</span>\n              <ChevronDown\n                size={16}\n                className={`transition-transform ${isSpecialStatusOpen ? 'rotate-180' : ''}`}\n              />\n            </button>\n            {isSpecialStatusOpen && (\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto\">\n                <button\n                  onClick={() => {\n                    onFilterChange(null)\n                    setIsSpecialStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                    filter === null ? 'bg-orange-100 text-orange-800' : 'text-gray-700'\n                  }`}\n                >\n                  الكل\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'special_status', value: 'none' })\n                    setIsSpecialStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                    filter?.type === 'special_status' && filter?.value === 'none'\n                      ? 'bg-orange-100 text-orange-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  بدون حالة خاصة\n                </button>\n                {specialStatuses.map((status) => (\n                  <button\n                    key={status.id}\n                    onClick={() => {\n                      onFilterChange({ type: 'special_status', value: status.id })\n                      setIsSpecialStatusOpen(false)\n                    }}\n                    className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-orange-100 ${\n                      filter?.type === 'special_status' && filter?.value === status.id\n                        ? 'bg-orange-100 text-orange-800'\n                        : 'text-gray-700'\n                    }`}\n                  >\n                    {status.name}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            حالة الطالب\n          </label>\n          <div className=\"relative\">\n            <button\n              onClick={() => setIsStudentStatusOpen(!isStudentStatusOpen)}\n              className=\"w-full px-3 py-2 border border-teal-300 rounded-lg text-right text-sm font-medium bg-teal-50 hover:bg-teal-100 flex items-center justify-between\"\n            >\n              <span>{getStudentStatusLabel()}</span>\n              <ChevronDown\n                size={16}\n                className={`transition-transform ${isStudentStatusOpen ? 'rotate-180' : ''}`}\n              />\n            </button>\n            {isStudentStatusOpen && (\n              <div className=\"absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10\">\n                <button\n                  onClick={() => {\n                    onFilterChange(null)\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter === null ? 'bg-teal-100 text-teal-800' : 'text-gray-700'\n                  }`}\n                >\n                  الكل\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'status', value: 'نشط' })\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter?.type === 'status' && filter?.value === 'نشط'\n                      ? 'bg-teal-100 text-teal-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  نشط\n                </button>\n                <button\n                  onClick={() => {\n                    onFilterChange({ type: 'status', value: 'استئذان' })\n                    setIsStudentStatusOpen(false)\n                  }}\n                  className={`w-full px-3 py-2 text-right text-sm font-medium hover:bg-teal-100 ${\n                    filter?.type === 'status' && filter?.value === 'استئذان'\n                      ? 'bg-teal-100 text-teal-800'\n                      : 'text-gray-700'\n                  }`}\n                >\n                  استئذان\n                </button>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","size_bytes":6383},"client/src/lib/queryClient.ts":{"content":"import { QueryClient } from \"@tanstack/react-query\";\n\nasync function throwIfError(response: Response) {\n  if (!response.ok) {\n    const body = await response.text();\n    throw new Error(`${response.status}: ${body}`);\n  }\n}\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: async ({ queryKey }) => {\n        const response = await fetch(queryKey[0] as string);\n        await throwIfError(response);\n        return response.json();\n      },\n      staleTime: 1000 * 60 * 5,\n      refetchOnWindowFocus: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n\ntype RequestMethod = \"GET\" | \"POST\" | \"PUT\" | \"PATCH\" | \"DELETE\";\n\nexport async function apiRequest(\n  url: string,\n  method: RequestMethod = \"GET\",\n  data?: any\n) {\n  const options: RequestInit = {\n    method,\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n  };\n\n  if (data) {\n    options.body = JSON.stringify(data);\n  }\n\n  const response = await fetch(url, options);\n  await throwIfError(response);\n  return response.json();\n}\n","size_bytes":1061},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes.js\";\nimport { setupVite } from \"./vite.js\";\nimport { createServer } from \"http\";\n\nconst app = express();\napp.use(express.json());\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      console.log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = createServer(app);\n\n  registerRoutes(app);\n  await setupVite(app, server);\n\n  const PORT = 5000;\n  server.listen(PORT, \"0.0.0.0\", () => {\n    console.log(`Server running on port ${PORT}`);\n  });\n})();\n","size_bytes":1306},"Erchad-1/client/src/components/StudentForm.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { Group, SpecialStatus, Student } from '../types'\nimport { Plus, X } from 'lucide-react'\n\ninterface StudentFormProps {\n  groups: Group[]\n  specialStatuses: SpecialStatus[]\n  onStudentAdded: () => void\n  editingStudent?: Student\n  onEditingStudentChange: (student?: Student) => void\n}\n\nexport function StudentForm({\n  groups,\n  specialStatuses,\n  onStudentAdded,\n  editingStudent,\n  onEditingStudentChange,\n}: StudentFormProps) {\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [formData, setFormData] = useState({\n    name: '',\n    national_id: '',\n    phone: '',\n    guardian_phone: '',\n    grade: '',\n    group_id: '',\n    special_status_id: '',\n  })\n\n  useEffect(() => {\n    if (editingStudent) {\n      setFormData({\n        name: editingStudent.name,\n        national_id: editingStudent.national_id,\n        phone: editingStudent.phone,\n        guardian_phone: editingStudent.guardian_phone,\n        grade: editingStudent.grade,\n        group_id: editingStudent.group_id,\n        special_status_id: editingStudent.special_status_id || '',\n      })\n    }\n  }, [editingStudent])\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setError('')\n    setLoading(true)\n\n    try {\n      if (!formData.group_id) {\n        setError('يجب اختيار مجموعة')\n        setLoading(false)\n        return\n      }\n\n      const data = {\n        name: formData.name,\n        national_id: formData.national_id,\n        phone: formData.phone,\n        guardian_phone: formData.guardian_phone,\n        grade: formData.grade,\n        group_id: formData.group_id,\n        special_status_id: formData.special_status_id || null,\n      }\n\n      if (editingStudent) {\n        const { error: updateError } = await supabase\n          .from('students')\n          .update(data)\n          .eq('id', editingStudent.id)\n\n        if (updateError) throw updateError\n      } else {\n        const { error: insertError } = await supabase\n          .from('students')\n          .insert(data)\n\n        if (insertError) throw insertError\n      }\n\n      setFormData({\n        name: '',\n        national_id: '',\n        phone: '',\n        guardian_phone: '',\n        grade: '',\n        group_id: '',\n        special_status_id: '',\n      })\n      onEditingStudentChange(undefined)\n      onStudentAdded()\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'حدث خطأ ما')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <h2 className=\"text-xl font-bold text-gray-800\">\n          {editingStudent ? 'تعديل الطالب' : 'إضافة طالب جديد'}\n        </h2>\n        {editingStudent && (\n          <button\n            onClick={() => onEditingStudentChange(undefined)}\n            className=\"text-gray-500 hover:text-gray-700\"\n          >\n            <X size={24} />\n          </button>\n        )}\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded\">\n          {error}\n        </div>\n      )}\n\n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              اسم الطالب\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.name}\n              onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              السجل المدني\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.national_id}\n              onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              جوال الطالب\n            </label>\n            <input\n              type=\"tel\"\n              required\n              value={formData.phone}\n              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              جوال ولي الأمر\n            </label>\n            <input\n              type=\"tel\"\n              required\n              value={formData.guardian_phone}\n              onChange={(e) => setFormData({ ...formData, guardian_phone: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              الصف\n            </label>\n            <input\n              type=\"text\"\n              required\n              value={formData.grade}\n              onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              المجموعة\n            </label>\n            <select\n              required\n              value={formData.group_id}\n              onChange={(e) => setFormData({ ...formData, group_id: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"\">اختر مجموعة</option>\n              {groups.map((group) => (\n                <option key={group.id} value={group.id}>\n                  {group.name}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              الحالة الخاصة (اختياري)\n            </label>\n            <select\n              value={formData.special_status_id}\n              onChange={(e) =>\n                setFormData({ ...formData, special_status_id: e.target.value })\n              }\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"\">بدون حالة خاصة</option>\n              {specialStatuses.map((status) => (\n                <option key={status.id} value={status.id}>\n                  {status.name}\n                </option>\n              ))}\n            </select>\n          </div>\n        </div>\n\n        <button\n          type=\"submit\"\n          disabled={loading}\n          className=\"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2\"\n        >\n          <Plus size={20} />\n          {loading\n            ? 'جاري...'\n            : editingStudent\n              ? 'تحديث الطالب'\n              : 'إضافة الطالب'}\n        </button>\n      </form>\n    </div>\n  )\n}\n","size_bytes":7960},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer } from \"vite\";\n\nexport async function setupVite(app: Express, server: any) {\n  const vite = await createViteServer({\n    server: {\n      middlewareMode: true,\n      hmr: { server },\n    },\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  \n  // Catch-all route for SPA - must be last\n  app.use(async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientPath = path.resolve(process.cwd(), \"client\");\n      let template = fs.readFileSync(\n        path.resolve(clientPath, \"index.html\"),\n        \"utf-8\",\n      );\n\n      template = await vite.transformIndexHtml(url, template);\n      \n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(template);\n    } catch (e: any) {\n      vite.ssrFixStacktrace(e);\n      next(e);\n    }\n  });\n}\n","size_bytes":919},"Erchad-1/client/src/components/ExcelImport.tsx":{"content":"import { useState, useRef } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db } from '../lib/db'\nimport { Upload, AlertCircle, Users, GraduationCap } from 'lucide-react'\nimport * as XLSX from 'xlsx'\n\ninterface ExcelImportProps {\n  groups?: Array<{ id: string; name: string }>\n  onImportComplete: () => void\n}\n\ntype ImportType = 'students' | 'teachers'\n\nexport function ExcelImport({ groups, onImportComplete }: ExcelImportProps) {\n  const studentsFileInputRef = useRef<HTMLInputElement>(null)\n  const teachersFileInputRef = useRef<HTMLInputElement>(null)\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState('')\n  const [success, setSuccess] = useState('')\n\n  const handleStudentsImport = async (\n    event: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const arrayBuffer = await file.arrayBuffer()\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const sheetName = workbook.SheetNames[0]\n      const worksheet = workbook.Sheets[sheetName]\n      const data = XLSX.utils.sheet_to_json(worksheet)\n\n      if (!data || data.length === 0) {\n        throw new Error('الملف فارغ أو صيغته غير صحيحة')\n      }\n\n      // التحقق من وجود الأعمدة المطلوبة للطلاب\n      const requiredColumns = ['اسم الطالب', 'السجل المدني', 'الصف', 'المجموعة']\n      const firstRow = data[0] as any\n      const missingColumns = requiredColumns.filter(col => !(col in firstRow))\n\n      if (missingColumns.length > 0) {\n        throw new Error(`الملف يفتقد الأعمدة التالية: ${missingColumns.join('، ')}\\n\\nالأعمدة المطلوبة:\\n- اسم الطالب\\n- السجل المدني\\n- الصف\\n- المجموعة\\n- جوال الطالب (اختياري)\\n- جوال ولي الامر (اختياري)\\n- الحالة (اختياري)`)\n      }\n\n      // استخراج المجموعات الفريدة مع المراحل من الملف\n      const uniqueGroups = [\n        ...new Map(\n          data\n            .filter((row: any) => row['المجموعة'] && row['الصف'])\n            .map((row: any) => {\n              const stage = String(row['الصف'] || '').trim()\n              const name = String(row['المجموعة'] || '').trim()\n              return [`${stage}|${name}`, { stage, name }]\n            })\n            .filter(([key, group]: any) => group.stage && group.name)\n        ).values(),\n      ]\n\n      // جلب المجموعات الموجودة حالياً\n      const { data: existingGroups, error: fetchError } = await supabase\n        .from('groups')\n        .select('id, name, stage')\n\n      if (fetchError) throw fetchError\n\n      const existingGroupsMap = new Map(\n        (existingGroups || []).map((g) => [`${g.stage}|${g.name}`, g.id])\n      )\n\n      // إنشاء المجموعات الجديدة فقط\n      const newGroups = uniqueGroups.filter(\n        (group) => !existingGroupsMap.has(`${group.stage}|${group.name}`)\n      )\n\n      if (newGroups.length > 0) {\n        for (const group of newGroups) {\n          try {\n            const newId = crypto.randomUUID()\n            const newGroup = {\n              id: newId,\n              stage: group.stage,\n              name: group.name,\n              display_order: 0,\n              created_at: new Date().toISOString()\n            }\n\n            const { error: insertGroupError } = await supabase\n              .from('groups')\n              .insert(newGroup)\n\n            if (insertGroupError) {\n              console.error('Error creating group:', insertGroupError)\n              throw new Error(`فشل في إنشاء المجموعة \"${group.name}\" في \"${group.stage}\": ${insertGroupError.message}`)\n            }\n\n            existingGroupsMap.set(`${group.stage}|${group.name}`, newId)\n            await db.groups.put(newGroup)\n          } catch (err) {\n            console.error('Error in group creation:', err)\n            throw err\n          }\n        }\n      }\n\n      // جلب الطلاب الموجودين للتحقق من التحديث أو الإضافة\n      const { data: existingStudents, error: studentsError } = await supabase\n        .from('students')\n        .select('id, national_id')\n\n      if (studentsError) throw studentsError\n\n      const existingStudentsMap = new Map(\n        (existingStudents || []).map((s) => [s.national_id, s.id])\n      )\n\n      const insertData: any[] = []\n      const updateData: any[] = []\n      const seenNationalIds = new Set<string>()\n      const duplicatesInFile: string[] = []\n\n      data\n        .filter((row: any) => row['اسم الطالب'] && row['السجل المدني'])\n        .forEach((row: any) => {\n          const stage = String(row['الصف'] || '').trim()\n          const groupName = String(row['المجموعة'] || '').trim()\n\n          if (!stage || !groupName) {\n            console.warn('تخطي طالب بدون صف أو مجموعة:', row)\n            return\n          }\n\n          const groupKey = `${stage}|${groupName}`\n          const groupId = existingGroupsMap.get(groupKey)\n\n          if (!groupId) {\n            console.error('المجموعة غير موجودة:', { stage, groupName, groupKey })\n            console.error('المجموعات المتاحة:', Array.from(existingGroupsMap.keys()))\n            throw new Error(`المجموعة \"${groupName}\" في \"${stage}\" غير موجودة`)\n          }\n\n          const nationalId = String(row['السجل المدني']).trim()\n\n          // التحقق من التكرار في الملف نفسه\n          if (seenNationalIds.has(nationalId)) {\n            duplicatesInFile.push(`${String(row['اسم الطالب']).trim()} (${nationalId})`)\n            return\n          }\n          seenNationalIds.add(nationalId)\n\n          const studentData = {\n            name: String(row['اسم الطالب']).trim(),\n            national_id: nationalId,\n            phone: row['جوال الطالب'] ? String(row['جوال الطالب']).trim() : null,\n            guardian_phone: (row['جوال ولي الامر'] || row['جوالي ولي الامر'] || row['جوال ولي الأمر'])\n              ? String(row['جوال ولي الامر'] || row['جوالي ولي الامر'] || row['جوال ولي الأمر']).trim()\n              : null,\n            grade: stage,\n            group_id: groupId,\n            status: row['الحالة'] && String(row['الحالة']).trim() === 'استئذان' ? 'استئذان' : 'نشط',\n            special_status_id: null,\n          }\n\n          const existingStudentId = existingStudentsMap.get(nationalId)\n          if (existingStudentId) {\n            updateData.push({ id: existingStudentId, ...studentData })\n          } else {\n            insertData.push(studentData)\n          }\n        })\n\n      // إذا كان هناك تكرارات في الملف، اعرض تحذير\n      if (duplicatesInFile.length > 0) {\n        console.warn('طلاب مكررين في الملف:', duplicatesInFile)\n        setError(`تنبيه: تم تخطي ${duplicatesInFile.length} طالب مكرر في الملف:\\n${duplicatesInFile.slice(0, 5).join('\\n')}${duplicatesInFile.length > 5 ? '\\n...' : ''}`)\n      }\n\n      // إضافة الطلاب الجدد واحد بواحد\n      let insertedCount = 0\n      let skippedCount = 0\n\n      for (const studentData of insertData) {\n        try {\n          const { data: insertedStudent, error: insertError } = await supabase\n            .from('students')\n            .insert(studentData)\n            .select()\n            .maybeSingle()\n\n          if (insertError) {\n            if (insertError.code === '23505' && insertError.message.includes('students_national_id_key')) {\n              console.warn(`طالب موجود مسبقاً: ${studentData.name} (${studentData.national_id})`)\n              skippedCount++\n              continue\n            }\n            throw insertError\n          }\n\n          if (insertedStudent) {\n            insertedCount++\n            await db.students.put(insertedStudent)\n          }\n        } catch (err) {\n          console.error('خطأ في إضافة الطالب:', studentData.name, err)\n          skippedCount++\n        }\n      }\n\n      // تحديث الطلاب الموجودين\n      let updatedCount = 0\n      for (const student of updateData) {\n        const { id, ...updateFields } = student\n        const { error: updateError } = await supabase\n          .from('students')\n          .update(updateFields)\n          .eq('id', id)\n\n        if (!updateError) {\n          updatedCount++\n          await db.students.update(id, updateFields)\n        }\n      }\n\n      // رسالة النجاح\n      const messages: string[] = []\n\n      if (insertedCount > 0) {\n        messages.push(`تم إضافة ${insertedCount} طالب جديد`)\n      }\n\n      if (updatedCount > 0) {\n        messages.push(`تم تحديث ${updatedCount} طالب`)\n      }\n\n      if (skippedCount > 0) {\n        messages.push(`تم تخطي ${skippedCount} طالب موجود مسبقاً`)\n      }\n\n      if (newGroups.length > 0) {\n        messages.push(`تم إنشاء ${newGroups.length} مجموعة جديدة`)\n      }\n\n      setSuccess(\n        messages.length > 0 ? messages.join(' • ') : 'تمت العملية بنجاح'\n      )\n      if (studentsFileInputRef.current) {\n        studentsFileInputRef.current.value = ''\n      }\n      onImportComplete()\n    } catch (err) {\n      console.error('خطأ في استيراد الطلاب:', err)\n      const errorMessage = err instanceof Error ? err.message : 'حدث خطأ ما'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleTeachersImport = async (\n    event: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const file = event.target.files?.[0]\n    if (!file) return\n\n    setLoading(true)\n    setError('')\n    setSuccess('')\n\n    try {\n      const arrayBuffer = await file.arrayBuffer()\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const sheetName = workbook.SheetNames[0]\n      const worksheet = workbook.Sheets[sheetName]\n      const data = XLSX.utils.sheet_to_json(worksheet)\n\n      if (!data || data.length === 0) {\n        throw new Error('الملف فارغ أو صيغته غير صحيحة')\n      }\n\n      // التحقق من وجود الأعمدة المطلوبة للمعلمين\n      const requiredColumns = ['اسم المعلم', 'رقم جوال المعلم']\n      const firstRow = data[0] as any\n      const missingColumns = requiredColumns.filter(col => !(col in firstRow))\n\n      if (missingColumns.length > 0) {\n        throw new Error(`الملف يفتقد الأعمدة التالية: ${missingColumns.join('، ')}\\n\\nالأعمدة المطلوبة:\\n- اسم المعلم\\n- رقم جوال المعلم\\n- التخصص (اختياري)`)\n      }\n\n      // استيراد المعلمين\n      const teachersData = data\n        .filter((row: any) => row['اسم المعلم'] && row['رقم جوال المعلم'])\n        .map((row: any) => ({\n          name: String(row['اسم المعلم']).trim(),\n          phone: String(row['رقم جوال المعلم']).trim(),\n          specialization: row['التخصص'] ? String(row['التخصص']).trim() : '',\n        }))\n\n      // إزالة المعلمين المكررين في الملف\n      const uniqueTeachersMap = new Map()\n      teachersData.forEach((teacher: any) => {\n        const key = teacher.phone\n        if (!uniqueTeachersMap.has(key)) {\n          uniqueTeachersMap.set(key, teacher)\n        }\n      })\n      const uniqueTeachers = Array.from(uniqueTeachersMap.values())\n\n      let addedCount = 0\n      let updatedCount = 0\n      let skippedCount = 0\n\n      for (const teacher of uniqueTeachers) {\n        const { data: existingTeacher } = await supabase\n          .from('teachers')\n          .select('*')\n          .eq('phone', teacher.phone)\n          .maybeSingle()\n\n        if (!existingTeacher) {\n          const { data: newTeacher, error: insertError } = await supabase\n            .from('teachers')\n            .insert(teacher)\n            .select()\n            .maybeSingle()\n\n          if (!insertError && newTeacher) {\n            await db.teachers.put(newTeacher)\n            addedCount++\n          } else {\n            skippedCount++\n          }\n        } else {\n          const { error: updateError } = await supabase\n            .from('teachers')\n            .update({ name: teacher.name, specialization: teacher.specialization })\n            .eq('phone', teacher.phone)\n\n          if (!updateError) {\n            await db.teachers.update(existingTeacher.id, {\n              name: teacher.name,\n              specialization: teacher.specialization\n            })\n            updatedCount++\n          }\n        }\n      }\n\n      // رسالة النجاح\n      const messages: string[] = []\n\n      if (addedCount > 0) {\n        messages.push(`تم إضافة ${addedCount} معلم جديد`)\n      }\n\n      if (updatedCount > 0) {\n        messages.push(`تم تحديث ${updatedCount} معلم`)\n      }\n\n      if (skippedCount > 0) {\n        messages.push(`تم تخطي ${skippedCount} معلم`)\n      }\n\n      setSuccess(\n        messages.length > 0 ? messages.join(' • ') : 'تمت العملية بنجاح'\n      )\n      if (teachersFileInputRef.current) {\n        teachersFileInputRef.current.value = ''\n      }\n      onImportComplete()\n    } catch (err) {\n      console.error('خطأ في استيراد المعلمين:', err)\n      const errorMessage = err instanceof Error ? err.message : 'حدث خطأ ما'\n      setError(errorMessage)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-6 mb-6\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <Upload size={24} className=\"text-blue-600\" />\n        <h2 className=\"text-xl font-bold text-gray-800\">استيراد من Excel</h2>\n      </div>\n\n      {error && (\n        <div className=\"mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded flex items-start gap-2\">\n          <AlertCircle size={20} className=\"flex-shrink-0 mt-0.5\" />\n          <div>\n            <p className=\"font-medium\">خطأ:</p>\n            <p className=\"text-sm whitespace-pre-line\">{error}</p>\n          </div>\n        </div>\n      )}\n\n      {success && (\n        <div className=\"mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded\">\n          {success}\n        </div>\n      )}\n\n      {/* قسم استيراد الطلاب */}\n      <div className=\"mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-lg border-2 border-blue-300\">\n        <h3 className=\"text-lg font-bold text-blue-900 mb-3 flex items-center gap-2\">\n          <GraduationCap size={20} />\n          استيراد بيانات الطلاب\n        </h3>\n\n        <div className=\"bg-white rounded-lg p-3 mb-3\">\n          <p className=\"text-sm font-bold text-emerald-700 mb-2\">الأعمدة المطلوبة:</p>\n          <div className=\"grid grid-cols-1 gap-1 text-xs text-gray-700\">\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">1.</span>\n              <span><strong>اسم الطالب</strong> - اسم الطالب الكامل</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">2.</span>\n              <span><strong>السجل المدني</strong> - رقم الهوية الوطنية</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">3.</span>\n              <span><strong>الصف</strong> - مثل: الصف الأول الثانوي</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">4.</span>\n              <span><strong>المجموعة</strong> - اسم المجموعة مثل: مجموعة 1</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">5.</span>\n              <span><strong>جوال الطالب</strong> - رقم جوال الطالب (اختياري)</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">6.</span>\n              <span><strong>جوال ولي الامر</strong> - رقم جوال ولي الأمر (اختياري)</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-blue-600\">7.</span>\n              <span><strong>الحالة</strong> - نشط أو استئذان (اختياري)</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg mb-3\">\n          <p className=\"text-sm font-bold text-yellow-900 mb-2\">ملاحظات مهمة</p>\n          <ul className=\"text-xs text-yellow-800 mr-4 space-y-1\">\n            <li>• المجموعات يتم إنشاؤها تلقائياً إذا لم تكن موجودة</li>\n            <li>• إذا كان السجل المدني موجود، يتم تحديث بيانات الطالب</li>\n            <li>• عمود \"جوال ولي الامر\" يقبل أيضاً: \"جوالي ولي الامر\" أو \"جوال ولي الأمر\"</li>\n          </ul>\n        </div>\n\n        <input\n          ref={studentsFileInputRef}\n          type=\"file\"\n          accept=\".xlsx,.xls,.csv\"\n          onChange={handleStudentsImport}\n          disabled={loading}\n          className=\"hidden\"\n        />\n\n        <button\n          onClick={() => studentsFileInputRef.current?.click()}\n          disabled={loading}\n          className=\"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n        >\n          <GraduationCap size={20} />\n          {loading ? 'جاري الاستيراد...' : 'استيراد ملف الطلاب'}\n        </button>\n      </div>\n\n      {/* قسم استيراد المعلمين */}\n      <div className=\"p-4 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border-2 border-orange-300\">\n        <h3 className=\"text-lg font-bold text-orange-900 mb-3 flex items-center gap-2\">\n          <Users size={20} />\n          استيراد بيانات المعلمين\n        </h3>\n\n        <div className=\"bg-white rounded-lg p-3 mb-3\">\n          <p className=\"text-sm font-bold text-orange-700 mb-2\">الأعمدة المطلوبة:</p>\n          <div className=\"grid grid-cols-1 gap-1 text-xs text-gray-700\">\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">1.</span>\n              <span><strong>اسم المعلم</strong> - اسم المعلم الكامل</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">2.</span>\n              <span><strong>رقم جوال المعلم</strong> - رقم جوال المعلم</span>\n            </div>\n            <div className=\"flex gap-2\">\n              <span className=\"font-semibold text-orange-600\">3.</span>\n              <span><strong>التخصص</strong> - مثل: رياضيات، علوم، لغة عربية (اختياري)</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"mt-3 p-3 bg-yellow-50 border-2 border-yellow-400 rounded-lg mb-3\">\n          <p className=\"text-sm font-bold text-yellow-900 mb-2\">ملاحظات مهمة</p>\n          <ul className=\"text-xs text-yellow-800 mr-4 space-y-1\">\n            <li>• إذا كان رقم الجوال موجود، يتم تحديث بيانات المعلم</li>\n            <li>• يتم تخطي المعلمين المكررين في الملف</li>\n          </ul>\n        </div>\n\n        <input\n          ref={teachersFileInputRef}\n          type=\"file\"\n          accept=\".xlsx,.xls,.csv\"\n          onChange={handleTeachersImport}\n          disabled={loading}\n          className=\"hidden\"\n        />\n\n        <button\n          onClick={() => teachersFileInputRef.current?.click()}\n          disabled={loading}\n          className=\"w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-medium py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors\"\n        >\n          <Users size={20} />\n          {loading ? 'جاري الاستيراد...' : 'استيراد ملف المعلمين'}\n        </button>\n      </div>\n    </div>\n  )\n}\n","size_bytes":20935},"Erchad-1/client/src/main.tsx":{"content":"import { StrictMode } from 'react';\nimport { createRoot } from 'react-dom/client';\nimport { QueryClientProvider } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport App from './App.tsx';\nimport './index.css';\n\ncreateRoot(document.getElementById('root')!).render(\n  <StrictMode>\n    <QueryClientProvider client={queryClient}>\n      <App />\n    </QueryClientProvider>\n  </StrictMode>\n);\n","size_bytes":420},"Erchad-1/README.md":{"content":"Erchad\n","size_bytes":7},"Erchad-1/shared/schema.ts":{"content":"import { pgTable, varchar, text, integer, boolean, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const groups = pgTable(\"groups\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  stage: varchar(\"stage\").notNull(),\n  displayOrder: integer(\"display_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertGroupSchema = createInsertSchema(groups).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertGroup = z.infer<typeof insertGroupSchema>;\nexport type Group = typeof groups.$inferSelect;\n\nexport const specialStatuses = pgTable(\"special_statuses\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertSpecialStatusSchema = createInsertSchema(specialStatuses).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertSpecialStatus = z.infer<typeof insertSpecialStatusSchema>;\nexport type SpecialStatus = typeof specialStatuses.$inferSelect;\n\nexport const students = pgTable(\"students\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  nationalId: varchar(\"national_id\").notNull(),\n  phone: varchar(\"phone\").notNull(),\n  guardianPhone: varchar(\"guardian_phone\").notNull(),\n  grade: varchar(\"grade\").notNull(),\n  groupId: varchar(\"group_id\").references(() => groups.id),\n  status: varchar(\"status\").notNull().default(\"نشط\"),\n  specialStatusId: varchar(\"special_status_id\").references(() => specialStatuses.id),\n  visitCount: integer(\"visit_count\").default(0),\n  permissionCount: integer(\"permission_count\").default(0),\n  violationCount: integer(\"violation_count\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentSchema = createInsertSchema(students).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InsertStudent = z.infer<typeof insertStudentSchema>;\nexport type Student = typeof students.$inferSelect;\n\nexport const teachers = pgTable(\"teachers\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").notNull(),\n  phone: varchar(\"phone\").notNull(),\n  specialization: varchar(\"specialization\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertTeacherSchema = createInsertSchema(teachers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InsertTeacher = z.infer<typeof insertTeacherSchema>;\nexport type Teacher = typeof teachers.$inferSelect;\n\nexport const teacherGroups = pgTable(\"teacher_groups\", {\n  id: varchar(\"id\").primaryKey(),\n  teacherId: varchar(\"teacher_id\").references(() => teachers.id),\n  groupId: varchar(\"group_id\").references(() => groups.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertTeacherGroupSchema = createInsertSchema(teacherGroups).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertTeacherGroup = z.infer<typeof insertTeacherGroupSchema>;\nexport type TeacherGroup = typeof teacherGroups.$inferSelect;\n\nexport const studentVisits = pgTable(\"student_visits\", {\n  id: varchar(\"id\").primaryKey(),\n  studentId: varchar(\"student_id\").references(() => students.id),\n  visitDate: varchar(\"visit_date\").notNull(),\n  reason: text(\"reason\").notNull(),\n  actionTaken: text(\"action_taken\").notNull(),\n  referredTo: varchar(\"referred_to\").notNull().default(\"لا يوجد\"),\n  notes: text(\"notes\").default(\"\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentVisitSchema = createInsertSchema(studentVisits).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertStudentVisit = z.infer<typeof insertStudentVisitSchema>;\nexport type StudentVisit = typeof studentVisits.$inferSelect;\n\nexport const studentPermissions = pgTable(\"student_permissions\", {\n  id: varchar(\"id\").primaryKey(),\n  studentId: varchar(\"student_id\").references(() => students.id),\n  permissionDate: varchar(\"permission_date\").notNull(),\n  exitTime: varchar(\"exit_time\"),\n  reason: text(\"reason\").notNull(),\n  guardianNotified: boolean(\"guardian_notified\").default(false),\n  notes: text(\"notes\").default(\"\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentPermissionSchema = createInsertSchema(studentPermissions).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertStudentPermission = z.infer<typeof insertStudentPermissionSchema>;\nexport type StudentPermission = typeof studentPermissions.$inferSelect;\n\nexport const studentViolations = pgTable(\"student_violations\", {\n  id: varchar(\"id\").primaryKey(),\n  studentId: varchar(\"student_id\").references(() => students.id),\n  violationDate: varchar(\"violation_date\").notNull(),\n  violationType: varchar(\"violation_type\").notNull(),\n  description: text(\"description\").default(\"\"),\n  actionTaken: text(\"action_taken\").default(\"\"),\n  notes: text(\"notes\").default(\"\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertStudentViolationSchema = createInsertSchema(studentViolations).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertStudentViolation = z.infer<typeof insertStudentViolationSchema>;\nexport type StudentViolation = typeof studentViolations.$inferSelect;\n\nexport const teacherProfile = pgTable(\"teacher_profile\", {\n  id: varchar(\"id\").primaryKey(),\n  name: varchar(\"name\").default(\"\"),\n  schoolName: varchar(\"school_name\").default(\"\"),\n  systemTitle: varchar(\"system_title\").default(\"\"),\n  logoUrl: varchar(\"logo_url\").default(\"\"),\n  autoLogoutMinutes: integer(\"auto_logout_minutes\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const insertTeacherProfileSchema = createInsertSchema(teacherProfile).omit({\n  id: true,\n  createdAt: true,\n});\nexport type InsertTeacherProfile = z.infer<typeof insertTeacherProfileSchema>;\nexport type TeacherProfile = typeof teacherProfile.$inferSelect;\n\nexport const loginCredentials = pgTable(\"login_credentials\", {\n  id: varchar(\"id\").primaryKey(),\n  username: varchar(\"username\").notNull().unique(),\n  passwordHash: varchar(\"password_hash\").notNull(),\n  resetToken: varchar(\"reset_token\"),\n  resetTokenExpires: varchar(\"reset_token_expires\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertLoginCredentialsSchema = createInsertSchema(loginCredentials).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\nexport type InsertLoginCredentials = z.infer<typeof insertLoginCredentialsSchema>;\nexport type LoginCredentials = typeof loginCredentials.$inferSelect;\n","size_bytes":6839},"client/src/pages/ReceptionPage.tsx":{"content":"import { useState, useEffect } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { db, StudentVisit } from '../lib/db'\nimport { Student } from '../types'\nimport { UserCheck, Search, FileText, Printer, Send, Calendar, Filter } from 'lucide-react'\nimport { formatPhoneForWhatsApp } from '../lib/formatPhone'\n\ninterface VisitWithStudent extends StudentVisit {\n  student?: {\n    name: string\n    national_id: string\n    guardian_phone: string\n    visit_count: number\n  }\n}\n\nexport function ReceptionPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [visits, setVisits] = useState<VisitWithStudent[]>([])\n  const [searchTerm, setSearchTerm] = useState('')\n  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null)\n  const [dateFilter, setDateFilter] = useState('')\n  const [showFilters, setShowFilters] = useState(false)\n  const [formData, setFormData] = useState({\n    reason: '',\n    action_taken: '',\n    referred_to: 'لا يوجد' as const,\n    notes: ''\n  })\n  const [loading, setLoading] = useState(false)\n  const [teacherName, setTeacherName] = useState('')\n\n  useEffect(() => {\n    fetchStudents()\n    fetchVisits()\n    fetchTeacherProfile()\n  }, [])\n\n  async function fetchTeacherProfile() {\n    const profile = await db.teacher_profile.toCollection().first()\n    if (profile?.name) {\n      setTeacherName(profile.name)\n    }\n  }\n\n  async function fetchStudents() {\n    // جلب الطلاب من Supabase أولاً\n    const { data: supabaseStudents } = await supabase\n      .from('students')\n      .select('*')\n      .order('name')\n\n    // مزامنة مع IndexedDB\n    if (supabaseStudents && supabaseStudents.length > 0) {\n      await db.students.clear()\n      for (const student of supabaseStudents) {\n        await db.students.put(student)\n      }\n    }\n\n    // جلب المجموعات والحالات\n    const { data: supabaseGroups } = await supabase.from('groups').select('*')\n    const { data: supabaseStatuses } = await supabase.from('special_statuses').select('*')\n\n    // مزامنة المجموعات\n    if (supabaseGroups && supabaseGroups.length > 0) {\n      await db.groups.clear()\n      for (const group of supabaseGroups) {\n        await db.groups.put(group)\n      }\n    }\n\n    // مزامنة الحالات الخاصة\n    if (supabaseStatuses && supabaseStatuses.length > 0) {\n      await db.special_statuses.clear()\n      for (const status of supabaseStatuses) {\n        await db.special_statuses.put(status)\n      }\n    }\n\n    // قراءة من IndexedDB بعد المزامنة\n    const allStudents = await db.students.toArray()\n    const groups = await db.groups.toArray()\n    const statuses = await db.special_statuses.toArray()\n\n    const studentsWithRelations = allStudents.map(student => {\n      const group = groups.find(g => g.id === student.group_id)\n      const special_status = statuses.find(s => s.id === student.special_status_id)\n      return {\n        ...student,\n        group: group ? { name: group.name } : undefined,\n        special_status: special_status ? { name: special_status.name } : undefined\n      }\n    })\n\n    setStudents(studentsWithRelations as Student[])\n  }\n\n  async function fetchVisits(filterDate?: string) {\n    try {\n      let query = supabase\n        .from('student_visits')\n        .select('*')\n        .order('visit_date', { ascending: false })\n\n      if (filterDate) {\n        const startOfDay = new Date(filterDate)\n        startOfDay.setHours(0, 0, 0, 0)\n        const endOfDay = new Date(filterDate)\n        endOfDay.setHours(23, 59, 59, 999)\n\n        query = query\n          .gte('visit_date', startOfDay.toISOString())\n          .lte('visit_date', endOfDay.toISOString())\n      } else {\n        query = query.limit(50)\n      }\n\n      const { data: visitsData } = await query\n      const { data: studentsData } = await supabase.from('students').select('*')\n\n      const allStudents = studentsData || []\n\n      const visitsWithStudents = (visitsData || []).map((visit) => {\n        const student = allStudents.find(s => s.id === visit.student_id)\n        return {\n          ...visit,\n          student: student ? {\n            name: student.name,\n            national_id: student.national_id,\n            guardian_phone: student.guardian_phone,\n            visit_count: student.visit_count || 0\n          } : undefined\n        }\n      })\n\n      setVisits(visitsWithStudents)\n\n      if (visitsData) {\n        await db.student_visits.bulkPut(visitsData.map(v => ({\n          id: v.id,\n          student_id: v.student_id,\n          visit_date: v.visit_date,\n          reason: v.reason,\n          action_taken: v.action_taken,\n          referred_to: v.referred_to,\n          notes: v.notes || '',\n          created_at: v.created_at\n        })))\n      }\n    } catch (error) {\n      console.error('Error fetching visits:', error)\n    }\n  }\n\n  async function handleSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    if (!selectedStudent) return\n\n    setLoading(true)\n    try {\n      const visitDate = new Date().toISOString()\n      const currentCount = selectedStudent.visit_count || 0\n\n      const { data: visitData, error: visitError } = await supabase\n        .from('student_visits')\n        .insert({\n          student_id: selectedStudent.id,\n          visit_date: visitDate,\n          reason: formData.reason,\n          action_taken: formData.action_taken,\n          referred_to: formData.referred_to,\n          notes: formData.notes\n        })\n        .select()\n        .single()\n\n      if (visitError) throw visitError\n\n      const { error: updateError } = await supabase\n        .from('students')\n        .update({ visit_count: currentCount + 1 })\n        .eq('id', selectedStudent.id)\n\n      if (updateError) throw updateError\n\n      if (visitData) {\n        await db.student_visits.add({\n          id: visitData.id,\n          student_id: visitData.student_id,\n          visit_date: visitData.visit_date,\n          reason: visitData.reason,\n          action_taken: visitData.action_taken,\n          referred_to: visitData.referred_to,\n          notes: visitData.notes || '',\n          created_at: visitData.created_at\n        })\n      }\n\n      await db.students.update(selectedStudent.id, {\n        visit_count: currentCount + 1\n      })\n\n      alert('تم تسجيل الزيارة بنجاح')\n      setFormData({ reason: '', action_taken: '', referred_to: 'لا يوجد', notes: '' })\n      setSelectedStudent(null)\n      fetchStudents()\n      fetchVisits(dateFilter)\n    } catch (error) {\n      console.error('Error saving visit:', error)\n      alert('حدث خطأ أثناء الحفظ')\n    }\n    setLoading(false)\n  }\n\n  async function printVisit(visit: VisitWithStudent) {\n    const printWindow = window.open('', '', 'width=800,height=600')\n    if (!printWindow) return\n\n    const visitDate = new Date(visit.visit_date)\n    const hijriDate = visitDate.toLocaleDateString('ar-SA-u-ca-islamic', {\n      year: 'numeric',\n      month: 'numeric',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    }).replace(/\\u200f/g, '')\n\n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html dir=\"rtl\">\n        <head>\n          <title>تقرير زيارة طالب</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            @page { margin: 2cm; }\n            body { \n              font-family: 'Arial', sans-serif; \n              padding: 40px; \n              margin: 0;\n            }\n            .header { \n              text-align: center; \n              margin-bottom: 10px;\n            }\n            .header-line {\n              font-size: 14px;\n              color: #374151;\n              margin: 3px 0;\n            }\n            .title {\n              font-size: 16px;\n              font-weight: bold;\n              text-align: center;\n              margin: 15px 0;\n            }\n            .divider {\n              border-bottom: 2px solid #000;\n              margin: 15px 0 25px 0;\n            }\n            table {\n              width: 100%;\n              border-collapse: collapse;\n              margin: 20px 0;\n            }\n            td {\n              padding: 12px;\n              border-bottom: 1px solid #e5e7eb;\n              font-size: 14px;\n            }\n            .label-cell {\n              text-align: right;\n              font-weight: bold;\n              color: #1f2937;\n              width: 30%;\n            }\n            .value-cell {\n              text-align: right;\n              color: #374151;\n            }\n            .footer {\n              text-align: center;\n              margin-top: 40px;\n              font-size: 12px;\n              color: #6b7280;\n            }\n            @media print { \n              body { padding: 20px; } \n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"header\">\n            <div class=\"header-line\">نظام المشرف الصحي المدرسي</div>\n            <div class=\"header-line\">المرشد الطلابي: ${teacherName || 'اسم المعلم'}</div>\n            <div class=\"header-line\" style=\"font-weight: bold;\">تقرير زيارة طالب</div>\n          </div>\n          \n          <div class=\"divider\"></div>\n          \n          <table>\n            <tr>\n              <td class=\"label-cell\">نوع الحضور</td>\n              <td class=\"value-cell\">حضر</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">التاريخ</td>\n              <td class=\"value-cell\">${hijriDate}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">اسم الطالب</td>\n              <td class=\"value-cell\">${visit.student?.name || ''}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">السجل المدني</td>\n              <td class=\"value-cell\">${visit.student?.national_id || ''}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">سبب الزيارة</td>\n              <td class=\"value-cell\">${visit.reason}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">الإجراء المتخذ</td>\n              <td class=\"value-cell\">${visit.action_taken}</td>\n            </tr>\n            <tr>\n              <td class=\"label-cell\">التحويل إلى</td>\n              <td class=\"value-cell\">${visit.referred_to}</td>\n            </tr>\n            ${visit.notes ? `\n            <tr>\n              <td class=\"label-cell\">ملاحظات</td>\n              <td class=\"value-cell\">${visit.notes}</td>\n            </tr>\n            ` : ''}\n          </table>\n          \n          <div class=\"footer\">\n            تم الإنشاء بتاريخ: ${new Date().toLocaleDateString('ar-SA-u-ca-islamic')}\n          </div>\n          \n          <script>window.print(); window.onafterprint = () => window.close();</script>\n        </body>\n      </html>\n    `)\n  }\n\n  function sendWhatsApp(visit: VisitWithStudent) {\n    if (!visit.student?.guardian_phone) {\n      alert('رقم جوال ولي الأمر غير مسجل')\n      return\n    }\n\n    const phone = formatPhoneForWhatsApp(visit.student.guardian_phone)\n    if (!phone) {\n      alert('رقم جوال ولي الأمر غير صالح. يرجى التأكد من إدخال الرقم الصحيح في بيانات الطالب.')\n      return\n    }\n\n    const message = `السلام عليكم ورحمة الله وبركاته\n\nعزيزي ولي أمر الطالب: ${visit.student.name}\n\nنود إعلامكم بأن الطالب قد حضر إلى الإرشاد الطلابي بتاريخ: ${new Date(visit.visit_date).toLocaleDateString('ar-SA')}\n\nسبب الزيارة: ${visit.reason}\nالإجراء المتخذ: ${visit.action_taken}\n${visit.referred_to !== 'لا يوجد' ? `تم التحويل إلى: ${visit.referred_to}` : ''}\n\nللاستفسار يرجى التواصل مع الموجه الطلابي.\n\nمع تحيات إدارة المدرسة\n${teacherName ? teacherName : 'مسؤول النظام'}`\n\n    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`\n    window.open(whatsappUrl, '_blank')\n  }\n\n  const filteredStudents = students.filter(s =>\n    s.name.includes(searchTerm) || s.national_id.includes(searchTerm)\n  )\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex items-center gap-3 mb-6\">\n          <UserCheck size={28} className=\"text-blue-600\" />\n          <h2 className=\"text-2xl font-bold text-gray-800\">استقبال الطلاب</h2>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div>\n            <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n              <Search size={16} className=\"inline ml-1\" />\n              البحث عن طالب\n            </label>\n            <input\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"ابحث بالاسم أو السجل المدني...\"\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n            />\n\n            {searchTerm && (\n              <div className=\"mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg\">\n                {filteredStudents.map(student => (\n                  <button\n                    key={student.id}\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedStudent(student)\n                      setSearchTerm('')\n                    }}\n                    className=\"w-full text-right px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-0 transition-colors\"\n                  >\n                    <div className=\"font-semibold text-gray-800\">{student.name}</div>\n                    <div className=\"text-sm text-gray-600\">\n                      {student.national_id} - {student.group?.name}\n                    </div>\n                    <div className=\"text-xs text-blue-600 font-semibold mt-1\">\n                      عدد الزيارات: {student.visit_count || 0}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {selectedStudent && (\n            <>\n              <div className=\"bg-blue-50 rounded-lg p-4 border border-blue-200\">\n                <h3 className=\"font-bold text-blue-900 mb-2\">الطالب المحدد:</h3>\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div><span className=\"font-semibold\">الاسم:</span> {selectedStudent.name}</div>\n                  <div><span className=\"font-semibold\">السجل المدني:</span> {selectedStudent.national_id}</div>\n                  <div><span className=\"font-semibold\">الفصل:</span> {selectedStudent.group?.name}</div>\n                  <div><span className=\"font-semibold\">الصف:</span> {selectedStudent.grade}</div>\n                  <div className=\"col-span-2\">\n                    <span className=\"font-semibold\">عدد الزيارات السابقة:</span>\n                    <span className=\"text-blue-600 font-bold mr-2\">{selectedStudent.visit_count || 0}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  سبب الزيارة / المشكلة\n                </label>\n                <textarea\n                  required\n                  value={formData.reason}\n                  onChange={(e) => setFormData({ ...formData, reason: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب سبب الزيارة أو وصف المشكلة...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  الإجراء المتخذ\n                </label>\n                <textarea\n                  required\n                  value={formData.action_taken}\n                  onChange={(e) => setFormData({ ...formData, action_taken: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={3}\n                  placeholder=\"اكتب الإجراء الذي تم اتخاذه...\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  التحويل إلى\n                </label>\n                <select\n                  value={formData.referred_to}\n                  onChange={(e) => setFormData({ ...formData, referred_to: e.target.value as any })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                >\n                  <option value=\"لا يوجد\">لا يوجد</option>\n                  <option value=\"مشرف صحي\">مشرف صحي</option>\n                  <option value=\"وكيل\">وكيل</option>\n                  <option value=\"مدير\">مدير</option>\n                  <option value=\"معلم\">معلم</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  ملاحظات إضافية (اختياري)\n                </label>\n                <textarea\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  rows={2}\n                  placeholder=\"ملاحظات إضافية...\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                {loading ? 'جاري الحفظ...' : 'تسجيل الزيارة'}\n              </button>\n            </>\n          )}\n        </form>\n      </div>\n\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-xl font-bold text-gray-800 flex items-center gap-2\">\n            <FileText size={24} />\n            سجل الزيارات {dateFilter ? 'المفلترة' : 'الأخيرة'}\n          </h3>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center gap-2 px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition-colors\"\n          >\n            <Filter size={16} />\n            فلتر بالتاريخ\n          </button>\n        </div>\n\n        {showFilters && (\n          <div className=\"mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200\">\n            <div className=\"flex gap-3 items-end\">\n              <div className=\"flex-1\">\n                <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                  <Calendar size={16} className=\"inline ml-1\" />\n                  اختر التاريخ\n                </label>\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n              <button\n                onClick={() => fetchVisits(dateFilter)}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors\"\n              >\n                تطبيق الفلتر\n              </button>\n              <button\n                onClick={() => {\n                  setDateFilter('')\n                  fetchVisits()\n                }}\n                className=\"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors\"\n              >\n                إعادة تعيين\n              </button>\n            </div>\n            {dateFilter && (\n              <p className=\"text-sm text-blue-600 font-semibold mt-3\">\n                عرض الزيارات في: {new Date(dateFilter).toLocaleDateString('ar-SA')}\n              </p>\n            )}\n          </div>\n        )}\n\n        {visits.length === 0 ? (\n          <p className=\"text-center text-gray-500 py-8\">لا توجد زيارات {dateFilter ? 'في هذا التاريخ' : ''}</p>\n        ) : (\n          <div className=\"space-y-3\">\n            {visits.map(visit => (\n            <div key={visit.id} className=\"border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors\">\n              <div className=\"flex justify-between items-start mb-3\">\n                <div>\n                  <h4 className=\"font-bold text-gray-800\">{visit.student?.name}</h4>\n                  <p className=\"text-sm text-gray-600\">\n                    {new Date(visit.visit_date).toLocaleString('ar-SA')}\n                  </p>\n                </div>\n                <div className=\"flex gap-2\">\n                  <button\n                    onClick={() => printVisit(visit)}\n                    className=\"px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                  >\n                    <Printer size={16} />\n                    طباعة\n                  </button>\n                  <button\n                    onClick={() => sendWhatsApp(visit)}\n                    className=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-1\"\n                  >\n                    <Send size={16} />\n                    واتساب\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"space-y-2 text-sm\">\n                <div><span className=\"font-semibold\">السبب:</span> {visit.reason}</div>\n                <div><span className=\"font-semibold\">الإجراء:</span> {visit.action_taken}</div>\n                {visit.referred_to !== 'لا يوجد' && (\n                  <div className=\"text-orange-600 font-semibold\">\n                    تم التحويل إلى: {visit.referred_to}\n                  </div>\n                )}\n                {visit.notes && (\n                  <div className=\"text-gray-600\">\n                    <span className=\"font-semibold\">ملاحظات:</span> {visit.notes}\n                  </div>\n                )}\n              </div>\n            </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","size_bytes":23322},"client/src/pages/GroupsPage.tsx":{"content":"import { useEffect, useState } from 'react'\nimport { db } from '../lib/db'\nimport { supabase } from '../lib/supabase'\nimport { Student, Group, SpecialStatus } from '../types'\nimport { Users, Printer, UserPlus, X, Plus, ChevronDown, ChevronUp, Layers } from 'lucide-react'\n\nexport function GroupsPage() {\n  const [students, setStudents] = useState<Student[]>([])\n  const [groups, setGroups] = useState<Group[]>([])\n  const [specialStatuses, setSpecialStatuses] = useState<SpecialStatus[]>([])\n  const [loading, setLoading] = useState(true)\n  const [schoolName, setSchoolName] = useState('')\n  const [teacherName, setTeacherName] = useState('')\n  const [selectedGroupId, setSelectedGroupId] = useState<string | null>(null)\n  const [showAddStudentModal, setShowAddStudentModal] = useState(false)\n  const [showManageGroupsModal, setShowManageGroupsModal] = useState(false)\n  const [expandedStages, setExpandedStages] = useState<Set<string>>(new Set())\n  const [formData, setFormData] = useState({\n    name: '',\n    national_id: '',\n    phone: '',\n    guardian_phone: '',\n    grade: '',\n    special_status_id: '',\n  })\n  const [groupFormData, setGroupFormData] = useState({\n    stage: '',\n    name: '',\n  })\n  const [formError, setFormError] = useState('')\n  const [formLoading, setFormLoading] = useState(false)\n  const [showStatusDetails, setShowStatusDetails] = useState(false)\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  const fetchData = async () => {\n    try {\n      setLoading(true)\n      const [groupsData, studentsData, statusesData] = await Promise.all([\n        db.groups.toArray(),\n        db.students.toArray(),\n        db.special_statuses.toArray(),\n      ])\n\n      // Fetch school info from Supabase\n      const profileRes = await supabase.from('teacher_profile').select('*').maybeSingle()\n      if (profileRes.data) {\n        setSchoolName(profileRes.data.school_name || '')\n        setTeacherName(profileRes.data.name || '')\n      }\n\n      // Sort groups by stage and display_order\n      const sortedGroups = groupsData.sort((a, b) => {\n        const stageA = stageOrder[a.stage] || 999\n        const stageB = stageOrder[b.stage] || 999\n        if (stageA !== stageB) return stageA - stageB\n        return (a.display_order || 999) - (b.display_order || 999)\n      })\n      setGroups(sortedGroups)\n      setStudents(studentsData as Student[])\n      setSpecialStatuses(statusesData)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  // Define stage order\n  const stageOrder: Record<string, number> = {\n    'الصف الاول الثانوي': 1,\n    'الصف الثاني الثانوي': 2,\n    'الصف الثالث الثانوي': 3,\n  }\n\n  const groupedByStage = groups.reduce((acc, group) => {\n    if (!acc[group.stage]) {\n      acc[group.stage] = []\n    }\n    acc[group.stage].push(group)\n    return acc\n  }, {} as Record<string, Group[]>)\n\n  // Sort stages by defined order and sort groups within each stage\n  const sortedStages = Object.entries(groupedByStage)\n    .sort((a, b) => {\n      const orderA = stageOrder[a[0]] || 999\n      const orderB = stageOrder[b[0]] || 999\n      return orderA - orderB\n    })\n    .map(([stage, stageGroups]) => [\n      stage,\n      stageGroups.sort((a, b) => (a.display_order || 999) - (b.display_order || 999))\n    ] as [string, Group[]])\n\n  const toggleStage = (stage: string) => {\n    setExpandedStages((prev) => {\n      const next = new Set(prev)\n      if (next.has(stage)) {\n        next.delete(stage)\n      } else {\n        next.add(stage)\n      }\n      return next\n    })\n  }\n\n  const handlePrintAll = () => {\n    const hijriDate = new Date().toLocaleDateString('ar-SA-u-ca-islamic', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    }).replace(/\\u200f/g, '')\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>جميع المجموعات</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            @page { margin: 2cm; }\n            body { font-family: 'Arial', sans-serif; padding: 0; margin: 0; }\n            .print-page { page-break-after: always; padding: 20px; }\n            .print-page:last-child { page-break-after: auto; }\n            .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #2563eb; padding-bottom: 15px; }\n            .header h1 { color: #1f2937; margin: 0 0 8px 0; font-size: 36px; font-weight: bold; }\n            .header-info { color: #6b7280; font-size: 14px; margin: 5px 0; }\n            .title-bar { background-color: #16a34a; color: white; text-align: center; padding: 12px; margin: 20px 0; border-radius: 8px; }\n            .title-bar h2 { margin: 0; font-size: 24px; font-weight: bold; }\n            .stage-title { color: #1f2937; font-size: 22px; font-weight: bold; border-bottom: 3px solid #16a34a; display: inline-block; padding-bottom: 5px; margin: 15px 0 10px 0; }\n            .group-title { color: #1e40af; font-size: 18px; font-weight: bold; margin: 10px 0 5px 0; }\n            .group-info { color: #6b7280; font-size: 12px; margin-bottom: 10px; }\n            table { width: 100%; border-collapse: collapse; margin-top: 15px; }\n            th { background-color: #2563eb; color: white; padding: 10px; text-align: center; font-weight: bold; border: 1px solid #1e40af; }\n            td { border: 1px solid #d1d5db; padding: 8px; text-align: center; }\n            tr:nth-child(even) { background-color: #f9fafb; }\n            tr:nth-child(odd) { background-color: white; }\n          </style>\n        </head>\n        <body>\n          ${sortedStages.map(([stage, stageGroups]) => \n            stageGroups.map((group, groupIndex) => {\n              const groupStudents = students.filter(s => s.group_id === group.id)\n              return `\n                <div class=\"print-page\">\n                  <!-- Header -->\n                  <div class=\"header\">\n                    <h1>${schoolName || 'اسم المدرسة'}</h1>\n                    <p class=\"header-info\">المرشد الطلابي: ${teacherName || 'اسم المعلم'}</p>\n                    <p class=\"header-info\">التاريخ: ${hijriDate}</p>\n                  </div>\n                  \n                  <!-- Title Bar -->\n                  <div class=\"title-bar\">\n                    <h2>جميع المجموعات</h2>\n                  </div>\n                  \n                  <!-- Stage Title -->\n                  <div style=\"text-align: right;\">\n                    <h3 class=\"stage-title\">${stage}</h3>\n                  </div>\n                  \n                  <!-- Group Title -->\n                  <h4 class=\"group-title\">${group.name}</h4>\n                  <p class=\"group-info\">عدد الطلاب: ${groupStudents.length}</p>\n                  \n                  <!-- Table -->\n                  <table>\n                    <thead>\n                      <tr>\n                        <th>الاسم</th>\n                        <th>السجل المدني</th>\n                        <th>جوال الطالب</th>\n                        <th>جوال ولي الأمر</th>\n                        <th>الحالة الخاصة</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      ${groupStudents\n                        .map((student) => {\n                          const status = specialStatuses.find(s => s.id === student.special_status_id)\n                          const statusText = student.special_status_id\n                            ? (showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة')\n                            : '-'\n                          return `\n                            <tr>\n                              <td>${student.name}</td>\n                              <td>${student.national_id}</td>\n                              <td>${student.phone || '-'}</td>\n                              <td>${student.guardian_phone || '-'}</td>\n                              <td>${statusText}</td>\n                            </tr>\n                          `\n                        })\n                        .join('')}\n                    </tbody>\n                  </table>\n                </div>\n              `\n            }).join('')\n          ).join('')}\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handlePrint = (group: Group, groupStudents: Student[]) => {\n    const hijriDate = new Date().toLocaleDateString('ar-SA-u-ca-islamic', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    }).replace(/\\u200f/g, '')\n\n    const printContent = `\n      <html dir=\"rtl\">\n        <head>\n          <title>طلاب ${group.name}</title>\n          <meta charset=\"UTF-8\">\n          <style>\n            @page { margin: 2cm; }\n            body { font-family: 'Arial', sans-serif; padding: 20px; margin: 0; }\n            .header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #2563eb; padding-bottom: 15px; }\n            .header h1 { color: #1f2937; margin: 0 0 8px 0; font-size: 36px; font-weight: bold; }\n            .header-info { color: #6b7280; font-size: 14px; margin: 5px 0; }\n            .title-bar { background-color: #16a34a; color: white; text-align: center; padding: 12px; margin: 20px 0; border-radius: 8px; }\n            .title-bar h2 { margin: 0; font-size: 24px; font-weight: bold; }\n            .stage-title { color: #1f2937; font-size: 22px; font-weight: bold; border-bottom: 3px solid #16a34a; display: inline-block; padding-bottom: 5px; margin: 15px 0 10px 0; }\n            .group-title { color: #1e40af; font-size: 18px; font-weight: bold; margin: 10px 0 5px 0; }\n            .group-info { color: #6b7280; font-size: 12px; margin-bottom: 10px; }\n            table { width: 100%; border-collapse: collapse; margin-top: 15px; }\n            th { background-color: #2563eb; color: white; padding: 10px; text-align: center; font-weight: bold; border: 1px solid #1e40af; }\n            td { border: 1px solid #d1d5db; padding: 8px; text-align: center; }\n            tr:nth-child(even) { background-color: #f9fafb; }\n            tr:nth-child(odd) { background-color: white; }\n          </style>\n        </head>\n        <body>\n          <!-- Header -->\n          <div class=\"header\">\n            <h1>${schoolName || 'اسم المدرسة'}</h1>\n            <p class=\"header-info\">المرشد الطلابي: ${teacherName || 'اسم المعلم'}</p>\n            <p class=\"header-info\">التاريخ: ${hijriDate}</p>\n          </div>\n          \n          <!-- Title Bar -->\n          <div class=\"title-bar\">\n            <h2>جميع المجموعات</h2>\n          </div>\n          \n          <!-- Stage Title -->\n          <div style=\"text-align: right;\">\n            <h3 class=\"stage-title\">${group.stage}</h3>\n          </div>\n          \n          <!-- Group Title -->\n          <h4 class=\"group-title\">${group.name}</h4>\n          <p class=\"group-info\">عدد الطلاب: ${groupStudents.length}</p>\n          \n          <!-- Table -->\n          <table>\n            <thead>\n              <tr>\n                <th>الاسم</th>\n                <th>السجل المدني</th>\n                <th>جوال الطالب</th>\n                <th>جوال ولي الأمر</th>\n                <th>الحالة الخاصة</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${groupStudents\n                .map((student) => {\n                  const status = specialStatuses.find(s => s.id === student.special_status_id)\n                  const statusText = student.special_status_id\n                    ? (showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة')\n                    : '-'\n                  return `\n                    <tr>\n                      <td>${student.name}</td>\n                      <td>${student.national_id}</td>\n                      <td>${student.phone || '-'}</td>\n                      <td>${student.guardian_phone || '-'}</td>\n                      <td>${statusText}</td>\n                    </tr>\n                  `\n                })\n                .join('')}\n            </tbody>\n          </table>\n        </body>\n      </html>\n    `\n\n    const printWindow = window.open('', '_blank')\n    if (printWindow) {\n      printWindow.document.write(printContent)\n      printWindow.document.close()\n      printWindow.print()\n    }\n  }\n\n  const handleAddStudent = (groupId: string) => {\n    setSelectedGroupId(groupId)\n    setShowAddStudentModal(true)\n    setFormData({\n      name: '',\n      national_id: '',\n      phone: '',\n      guardian_phone: '',\n      grade: '',\n      special_status_id: '',\n    })\n    setFormError('')\n  }\n\n  const handleCloseModal = () => {\n    setShowAddStudentModal(false)\n    setSelectedGroupId(null)\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setFormError('')\n\n    if (!formData.name || !formData.national_id || !selectedGroupId) {\n      setFormError('يرجى ملء جميع الحقول المطلوبة')\n      return\n    }\n\n    try {\n      setFormLoading(true)\n\n      const newId = crypto.randomUUID()\n      await db.students.add({\n        id: newId,\n        ...formData,\n        group_id: selectedGroupId,\n        special_status_id: formData.special_status_id || null,\n        status: 'نشط',\n        visit_count: 0,\n        permission_count: 0,\n        violation_count: 0,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString(),\n      } as any)\n\n      handleCloseModal()\n      fetchData()\n    } catch (err) {\n      setFormError(err instanceof Error ? err.message : 'حدث خطأ')\n    } finally {\n      setFormLoading(false)\n    }\n  }\n\n  const handleAddGroup = async () => {\n    if (!groupFormData.stage || !groupFormData.name) {\n      alert('يرجى ملء جميع الحقول')\n      return\n    }\n\n    try {\n      const newId = crypto.randomUUID()\n      await db.groups.add({\n        id: newId,\n        stage: groupFormData.stage,\n        name: groupFormData.name,\n        created_at: new Date().toISOString(),\n      })\n\n      setGroupFormData({ stage: '', name: '' })\n      fetchData()\n      alert('تم إضافة المجموعة بنجاح')\n    } catch (error) {\n      console.error('Error adding group:', error)\n      alert('حدث خطأ أثناء إضافة المجموعة')\n    }\n  }\n\n  const handleDeleteGroup = async (groupId: string) => {\n    const studentsInGroup = students.filter(s => s.group_id === groupId)\n\n    if (studentsInGroup.length > 0) {\n      alert('لا يمكن حذف مجموعة تحتوي على طلاب. يرجى نقل الطلاب أولاً.')\n      return\n    }\n\n    if (confirm('هل أنت متأكد من حذف هذه المجموعة؟')) {\n      try {\n        await db.groups.delete(groupId)\n        fetchData()\n        alert('تم حذف المجموعة بنجاح')\n      } catch (error) {\n        console.error('Error deleting group:', error)\n        alert('حدث خطأ أثناء حذف المجموعة')\n      }\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-2xl shadow-lg p-6 border border-gray-200\">\n        <div className=\"flex items-center justify-between flex-wrap gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <button\n              onClick={() => setShowAddStudentModal(true)}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all hover:shadow-lg\"\n              data-testid=\"button-add-student\"\n            >\n              <UserPlus size={20} />\n              <span>إضافة طالب</span>\n            </button>\n            <button\n              onClick={handlePrintAll}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-semibold hover:from-cyan-700 hover:to-blue-700 transition-all hover:shadow-lg\"\n            >\n              <Printer size={20} />\n              <span>طباعة الكل</span>\n            </button>\n            <button\n              onClick={() => setShowManageGroupsModal(true)}\n              className=\"flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-xl font-semibold hover:from-emerald-700 hover:to-teal-700 transition-all hover:shadow-lg\"\n            >\n              <Layers size={20} />\n              <span>إدارة المجموعات</span>\n            </button>\n          </div>\n          <label className=\"flex items-center gap-3 bg-gradient-to-r from-purple-50 to-pink-50 px-4 py-3 rounded-xl cursor-pointer hover:from-purple-100 hover:to-pink-100 transition-all border-2 border-purple-200\">\n            <input\n              type=\"checkbox\"\n              checked={showStatusDetails}\n              onChange={(e) => setShowStatusDetails(e.target.checked)}\n              className=\"w-5 h-5 rounded cursor-pointer\"\n            />\n            <span className=\"text-purple-700 font-semibold\">إظهار تفاصيل الحالة</span>\n          </label>\n        </div>\n      </div>\n\n      {Object.keys(groupedByStage).length === 0 ? (\n        <div className=\"bg-white rounded-2xl shadow-lg p-12 text-center\">\n          <Users className=\"mx-auto mb-4 text-gray-300\" size={64} />\n          <h3 className=\"text-xl font-bold text-gray-700 mb-2\">لا توجد مجموعات</h3>\n          <p className=\"text-gray-500\">قم بإضافة مجموعات من خلال زر \"إدارة المجموعات\"</p>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {sortedStages.map(([stage, stageGroups]) => {\n            const isExpanded = expandedStages.has(stage)\n            const totalStudents = stageGroups.reduce((sum, group) => {\n              return sum + students.filter(s => s.group_id === group.id).length\n            }, 0)\n\n            return (\n              <div key={stage} className=\"bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200\">\n                <button\n                  onClick={() => toggleStage(stage)}\n                  className=\"w-full bg-gradient-to-r from-emerald-500 to-teal-500 p-6 flex items-center justify-between hover:from-emerald-600 hover:to-teal-600 transition-all shadow-md\"\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <Layers size={28} className=\"text-white\" />\n                    <div className=\"text-right\">\n                      <h2 className=\"text-2xl font-bold text-white\">{stage}</h2>\n                      <p className=\"text-emerald-50 text-sm\">\n                        {stageGroups.length} مجموعة • {totalStudents} طالب\n                      </p>\n                    </div>\n                  </div>\n                  {isExpanded ? (\n                    <ChevronUp size={28} className=\"text-white\" />\n                  ) : (\n                    <ChevronDown size={28} className=\"text-white\" />\n                  )}\n                </button>\n\n                {isExpanded && (\n                  <div className=\"p-4 space-y-4\">\n                    {stageGroups.map((group) => {\n                      const groupStudents = students.filter(s => s.group_id === group.id)\n                      return (\n                        <div key={group.id} className=\"border-2 border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow\">\n                          <div className=\"bg-gradient-to-r from-cyan-500 to-blue-500 p-4 flex items-center justify-between\">\n                            <div>\n                              <h3 className=\"text-xl font-bold text-white\">{group.name}</h3>\n                              <p className=\"text-cyan-50 text-sm\">عدد الطلاب: {groupStudents.length}</p>\n                            </div>\n                            <div className=\"flex gap-2\">\n                              <button\n                                onClick={() => handlePrint(group, groupStudents)}\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white text-cyan-700 rounded-lg font-semibold hover:bg-cyan-50 transition-all text-sm shadow-sm\"\n                              >\n                                <Printer size={18} />\n                                طباعة\n                              </button>\n                              <button\n                                onClick={() => handleAddStudent(group.id)}\n                                className=\"flex items-center gap-2 px-4 py-2 bg-white text-cyan-700 rounded-lg font-semibold hover:bg-cyan-50 transition-all text-sm shadow-sm\"\n                              >\n                                <UserPlus size={18} />\n                                إضافة طالب\n                              </button>\n                            </div>\n                          </div>\n\n                          {groupStudents.length === 0 ? (\n                            <div className=\"p-8 text-center text-gray-500 bg-gray-50\">\n                              <Users className=\"mx-auto mb-2 text-gray-300\" size={36} />\n                              <p>لا يوجد طلاب في هذه المجموعة</p>\n                            </div>\n                          ) : (\n                            <div className=\"overflow-x-auto\">\n                              <table className=\"w-full\">\n                                <thead className=\"bg-gray-50 border-b-2 border-gray-200\">\n                                  <tr>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الاسم</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">السجل المدني</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال الطالب</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">جوال ولي الأمر</th>\n                                    <th className=\"px-4 py-3 text-right text-sm font-bold text-gray-700\">الحالة الخاصة</th>\n                                  </tr>\n                                </thead>\n                                <tbody className=\"divide-y divide-gray-200\">\n                                  {groupStudents.map((student) => {\n                                    const status = specialStatuses.find(\n                                      (s) => s.id === student.special_status_id\n                                    )\n                                    return (\n                                      <tr key={student.id} className=\"hover:bg-blue-50 transition-colors\">\n                                        <td className=\"px-4 py-3 text-sm font-medium text-gray-900\">\n                                          {student.name}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.national_id}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.phone}\n                                        </td>\n                                        <td className=\"px-4 py-3 text-sm text-gray-600\">\n                                          {student.guardian_phone}\n                                        </td>\n                                        <td className=\"px-4 py-3\">\n                                          {student.special_status_id ? (\n                                            <span className=\"inline-flex px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800\">\n                                              {showStatusDetails ? (status?.name || 'لديه حالة خاصة') : 'لديه حالة خاصة'}\n                                            </span>\n                                          ) : (\n                                            <span className=\"text-gray-400\">-</span>\n                                          )}\n                                        </td>\n                                      </tr>\n                                    )\n                                  })}\n                                </tbody>\n                              </table>\n                            </div>\n                          )}\n                        </div>\n                      )\n                    })}\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n\n      {showAddStudentModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"sticky top-0 bg-gradient-to-r from-cyan-600 to-blue-600 p-6 flex items-center justify-between\">\n              <h3 className=\"text-2xl font-bold text-white\">إضافة طالب جديد</h3>\n              <button\n                onClick={handleCloseModal}\n                className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n              {formError && (\n                <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg\">\n                  {formError}\n                </div>\n              )}\n\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الاسم الكامل *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.name}\n                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"أدخل اسم الطالب\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    السجل المدني *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.national_id}\n                    onChange={(e) =>\n                      setFormData({ ...formData, national_id: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"رقم السجل المدني\"\n                    required\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الصف\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.grade}\n                    onChange={(e) => setFormData({ ...formData, grade: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"مثال: الأول متوسط\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    جوال الطالب\n                  </label>\n                  <input\n                    type=\"tel\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"05xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    جوال ولي الأمر\n                  </label>\n                  <input\n                    type=\"tel\"\n                    value={formData.guardian_phone}\n                    onChange={(e) =>\n                      setFormData({ ...formData, guardian_phone: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                    placeholder=\"05xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                    الحالة الخاصة\n                  </label>\n                  <select\n                    value={formData.special_status_id}\n                    onChange={(e) =>\n                      setFormData({ ...formData, special_status_id: e.target.value })\n                    }\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent\"\n                  >\n                    <option value=\"\">لا يوجد</option>\n                    {specialStatuses.map((status) => (\n                      <option key={status.id} value={status.id}>\n                        {status.name}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              </div>\n\n              <div className=\"flex gap-3 pt-4\">\n                <button\n                  type=\"submit\"\n                  disabled={formLoading}\n                  className=\"flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-cyan-700 hover:to-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-md\"\n                >\n                  {formLoading ? 'جاري الحفظ...' : 'حفظ الطالب'}\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCloseModal}\n                  className=\"px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-50 transition-colors\"\n                >\n                  إلغاء\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n\n      {showManageGroupsModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"sticky top-0 bg-gradient-to-r from-emerald-600 to-teal-600 p-6 flex items-center justify-between\">\n              <h3 className=\"text-2xl font-bold text-white\">إدارة المراحل والمجموعات</h3>\n              <button\n                onClick={() => setShowManageGroupsModal(false)}\n                className=\"text-white hover:bg-white/20 rounded-lg p-2 transition-colors\"\n              >\n                <X size={24} />\n              </button>\n            </div>\n\n            <div className=\"p-6 space-y-6\">\n              <div className=\"bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl p-6 border-2 border-emerald-200\">\n                <h4 className=\"text-lg font-bold text-gray-900 mb-4\">إضافة مجموعة جديدة</h4>\n                <div className=\"grid md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      الصف (المرحلة)\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={groupFormData.stage}\n                      onChange={(e) => setGroupFormData({ ...groupFormData, stage: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"مثال: الصف الأول الثانوي\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-semibold text-gray-700 mb-2\">\n                      اسم المجموعة\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={groupFormData.name}\n                      onChange={(e) => setGroupFormData({ ...groupFormData, name: e.target.value })}\n                      className=\"w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500\"\n                      placeholder=\"مثال: مجموعة 1\"\n                    />\n                  </div>\n                </div>\n                <button\n                  onClick={handleAddGroup}\n                  className=\"mt-4 w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 shadow-md\"\n                >\n                  <Plus size={20} />\n                  إضافة المجموعة\n                </button>\n              </div>\n\n              <div>\n                <h4 className=\"text-lg font-bold text-gray-900 mb-4\">المجموعات الحالية</h4>\n                {Object.entries(groupedByStage).map(([stage, stageGroups]) => (\n                  <div key={stage} className=\"mb-6\">\n                    <h5 className=\"text-md font-bold text-emerald-800 mb-3 flex items-center gap-2 bg-gradient-to-r from-emerald-100 to-teal-100 px-4 py-2 rounded-lg\">\n                      <Layers size={20} />\n                      {stage}\n                    </h5>\n                    <div className=\"grid md:grid-cols-2 gap-3\">\n                      {stageGroups.map((group) => {\n                        const studentCount = students.filter(s => s.group_id === group.id).length\n                        return (\n                          <div\n                            key={group.id}\n                            className=\"bg-gray-50 rounded-lg p-4 flex items-center justify-between border border-gray-200\"\n                          >\n                            <div>\n                              <p className=\"font-semibold text-gray-900\">{group.name}</p>\n                              <p className=\"text-sm text-gray-600\">{studentCount} طالب</p>\n                            </div>\n                            <button\n                              onClick={() => handleDeleteGroup(group.id)}\n                              disabled={studentCount > 0}\n                              className=\"text-red-600 hover:text-red-700 disabled:text-gray-400 disabled:cursor-not-allowed\"\n                              title={studentCount > 0 ? 'لا يمكن حذف مجموعة تحتوي على طلاب' : 'حذف المجموعة'}\n                            >\n                              <X size={20} />\n                            </button>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","size_bytes":36173},"Erchad-1/tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nexport default {\n  content: ['./client/index.html', './client/src/**/*.{js,ts,jsx,tsx}'],\n  theme: {\n    extend: {},\n  },\n  plugins: [],\n};\n","size_bytes":184},"replit.md":{"content":"# Overview\n\nErchad is a comprehensive student information management system designed for Arabic-speaking schools. The application enables teachers and administrators to manage student data, groups/classes, attendance, permissions, violations, and special status tracking. The system is designed with an RTL (right-to-left) interface and supports bilingual date handling (Gregorian for storage, Hijri for display). **The system works completely offline using IndexedDB (browser-based local database) with permanent data storage - no internet or external database required.**\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## Frontend Architecture\n\n**Technology Stack:** React 18 with TypeScript, built using Vite as the build tool and development server. Wouter is used for client-side routing.\n\n**State Management:** The application uses React Query (`@tanstack/react-query`) for server state management, providing automatic caching, background refetching, and optimistic updates. The query client is configured with a 5-minute stale time and disabled window focus refetching.\n\n**UI Framework:** Tailwind CSS provides utility-first styling with RTL support. Lucide-react supplies iconography. The design uses color-coded pages (blue for students, orange for permissions, red for violations) for visual organization.\n\n**Form Handling:** React Hook Form with Zod validation via `@hookform/resolvers` manages form state and validation.\n\n**Data Layer:** The application uses IndexedDB exclusively for data storage via a custom Supabase-compatible wrapper (`client/src/lib/indexedDBWrapper.ts`). This allows the application to work 100% offline while maintaining compatibility with existing Supabase-style API calls throughout the codebase. All data is stored permanently in the browser's IndexedDB until explicitly deleted by the user.\n\n**Date Handling:** All dates are stored in ISO Gregorian format (`YYYY-MM-DD`) and displayed to users in Hijri calendar format.\n\n**Problem Addressed:** Managing student data in Arabic-speaking educational institutions with complete offline capability and permanent local storage without requiring external databases or internet connectivity.\n\n**Chosen Solution:** IndexedDB with Supabase-compatible API wrapper provides permanent offline storage while maintaining code compatibility and simplicity.\n\n## Backend Architecture\n\n**Server Framework:** Express 5.x running on Node.js serves the Vite development server and static assets. The server provides API endpoints primarily for potential future enhancements, but the application currently operates entirely client-side using IndexedDB.\n\n**Storage Implementation:** The application uses an in-memory storage implementation (`server/memStorage.ts`) that implements the `IStorage` interface from `server/storage.ts`. This server-side storage is temporary and resets on server restart, as the primary data persistence happens in the browser's IndexedDB.\n\n**API Design:** RESTful endpoints follow standard conventions with Zod schema validation. The API provides CRUD operations for all entities, but these are currently not used by the frontend which operates directly on IndexedDB.\n\n**Request Logging:** Custom middleware logs all API requests with method, path, status code, duration, and truncated response body for debugging.\n\n**Development Integration:** Vite middleware is integrated into Express for HMR support and single-port development workflow.\n\n**Problem Addressed:** Providing a simple local development server for the frontend while maintaining flexibility for potential future server-side features.\n\n**Chosen Solution:** Express with in-memory storage provides a lightweight server for development without requiring external database setup.\n\n**Trade-offs:** Server-side data is temporary and resets on restart. Primary data persistence is in the browser's IndexedDB.\n\n## Database Schema (IndexedDB)\n\n**Core Entities:**\n- `students` - Student records with name, IDs, contact info, group assignment, special status, and activity counters\n- `groups` - Class/group definitions with stage and display order\n- `special_statuses` - Custom status categories (e.g., medical conditions, special needs)\n- `teachers` - Teacher records with contact information\n- `teacher_groups` - Junction table mapping teachers to groups they oversee\n\n**Activity Tracking Tables:**\n- `student_visits` - Records of student visits to counselor/administration\n- `student_permissions` - Permission/leave requests with guardian notification tracking\n- `student_violations` - Disciplinary incidents and actions taken\n\n**System Tables:**\n- `teacher_profile` - Single-row table for counselor/administrator profile and school settings\n- `login_credentials` - Authentication credentials with password reset token support\n\n**Indexing Strategy:** IndexedDB indexes are defined in `client/src/lib/db.ts` using Dexie schema. Indexes enable efficient querying by ID, student_id, group_id, dates, and other frequently accessed fields.\n\n**Problem Addressed:** Need for local data persistence with support for Arabic text and complex querying without requiring external database setup.\n\n**Chosen Solution:** IndexedDB via Dexie provides permanent browser-based storage with a SQL-like query interface, supporting all necessary data operations offline.\n\n## Authentication & Authorization\n\n**Authentication Method:** Simple credential-based login using `login_credentials` table. Username and password are validated against stored credentials.\n\n**Session Management:** Login state is persisted in `localStorage` with keys `isLoggedIn` and `userId`.\n\n**Hidden Account:** A hardcoded \"master admin\" account exists (username: `Wael`, password: `0558890902`) that bypasses database authentication.\n\n**Password Reset:** Token-based password reset mechanism generates a 6-digit code with time-limited validity stored in `reset_token` and `reset_token_expires` fields.\n\n**Auto-Logout:** Configurable automatic logout based on user inactivity duration (stored in `teacher_profile.autoLogoutMinutes`), with options for various time periods.\n\n**Security Considerations:** Current implementation stores passwords in plain text or simple hashing. This needs enhancement with proper password hashing (bcrypt/argon2) before production use.\n\n**Problem Addressed:** Need for simple, Arabic-friendly authentication for single-school deployment.\n\n**Chosen Solution:** Credential-based auth with localStorage persistence provides simplicity for small-scale deployment.\n\n**Limitations:** No role-based access control, weak password security, client-side session management vulnerable to XSS.\n\n## Key Features\n\n**Advanced Filtering:** Dynamic filtering on main page by special status, student status, academic stage, and group with intelligent dependency management and reset functionality.\n\n**Database Management:** API endpoint and UI for clearing all student, teacher, and group data. Backup and restore functionality exports/imports all system data as JSON.\n\n**Permission and Violation Tracking:** Dedicated pages for recording and viewing student permissions and violations with student search, detail display, date filtering, and historical data views.\n\n**WhatsApp Integration:** Standardized phone number formatting (`formatPhoneForWhatsApp` utility) for seamless WhatsApp communication. All WhatsApp links use format `https://wa.me/966XXXXXXXXX?text=...` with pre-filled messages.\n\n**Excel Import/Export:** Bulk student and teacher import from Excel files using `xlsx` library with column validation and error reporting.\n\n**Print Functionality:** Print-optimized views for student lists, special status reports, and activity records with RTL layout support.\n\n**Migration Pattern:** Components should use `useQuery` for data fetching and `useMutation` for data modifications, replacing direct Supabase/IndexedDB calls. The `apiRequest` helper function in `queryClient.ts` simplifies API calls with automatic error handling.\n\n# External Dependencies\n\n## Local Storage Only\n\n**No External Database Required:** The application does not require PostgreSQL, Supabase, or any external database. All packages related to Neon PostgreSQL (`@neondatabase/serverless`) and Drizzle are installed but not actively used - the application operates entirely on IndexedDB in the browser.\n\n**Environment Variables:** The system does not require `DATABASE_URL`, `VITE_SUPABASE_URL`, or `VITE_SUPABASE_ANON_KEY`. The application will work with default placeholder values.\n\n**Data Persistence:** All data persists permanently in the browser's IndexedDB storage until manually deleted through the application's \"Clear Database\" feature.\n\n## Primary Data Storage\n\n**IndexedDB via Dexie:** The application uses Dexie (IndexedDB wrapper) as the primary and only data storage mechanism. All data is stored permanently in the browser's IndexedDB until explicitly deleted.\n\n**Supabase Compatibility Layer:** `client/src/lib/indexedDBWrapper.ts` provides a Supabase-compatible API that translates Supabase-style queries into IndexedDB operations. This allows existing code to work without modification while using only local storage. The `@supabase/supabase-js` package is still installed but not used - the application redirects all \"Supabase\" calls to IndexedDB through the wrapper.\n\n## File Processing\n\n**XLSX:** `xlsx` library handles Excel file parsing and generation for student/teacher bulk import/export features.\n\n## UI & Utilities\n\n**Lucide React:** Icon library providing consistent iconography throughout the application.\n\n**React Hook Form:** Form state management with `@hookform/resolvers` for Zod schema integration.\n\n**Zod:** Runtime type validation for forms, API requests, and database schemas via `drizzle-zod`.\n\n## Development Tools\n\n**TypeScript:** Strict type checking enabled with separate tsconfig files for client (`tsconfig.app.json`) and server (`tsconfig.node.json`).\n\n**ESLint:** Code linting with React-specific rules and TypeScript support.\n\n**TSX:** TypeScript execution environment for running server code directly without compilation step.\n\n**Path Aliases:** Configured in both tsconfig files - `@/*` for client source, `@shared/*` for shared schema, `@assets/*` for attached assets.","size_bytes":10281},"server/memStorage.ts":{"content":"import type {\n  Student, InsertStudent,\n  Group, InsertGroup,\n  SpecialStatus, InsertSpecialStatus,\n  Teacher, InsertTeacher,\n  TeacherGroup, InsertTeacherGroup,\n  StudentVisit, InsertStudentVisit,\n  StudentPermission, InsertStudentPermission,\n  StudentViolation, InsertStudentViolation,\n  TeacherProfile, InsertTeacherProfile,\n  LoginCredentials, InsertLoginCredentials\n} from \"../shared/schema.js\";\nimport type { IStorage } from \"./storage.js\";\n\nexport class MemStorage implements IStorage {\n  private groups: Map<string, Group> = new Map();\n  private specialStatuses: Map<string, SpecialStatus> = new Map();\n  private students: Map<string, Student> = new Map();\n  private teachers: Map<string, Teacher> = new Map();\n  private teacherGroups: Map<string, TeacherGroup> = new Map();\n  private studentVisits: Map<string, StudentVisit> = new Map();\n  private studentPermissions: Map<string, StudentPermission> = new Map();\n  private studentViolations: Map<string, StudentViolation> = new Map();\n  private teacherProfileData: TeacherProfile | undefined = undefined;\n  private credentials: Map<string, LoginCredentials> = new Map();\n\n  // Groups\n  async getGroups(): Promise<Group[]> {\n    return Array.from(this.groups.values()).sort((a, b) => {\n      if (a.stage !== b.stage) return a.stage.localeCompare(b.stage);\n      return (a.displayOrder || 0) - (b.displayOrder || 0);\n    });\n  }\n\n  async getGroupById(id: string): Promise<Group | undefined> {\n    return this.groups.get(id);\n  }\n\n  async createGroup(group: InsertGroup): Promise<Group> {\n    const id = crypto.randomUUID();\n    const createdAt = new Date();\n    const newGroup: Group = { \n      id,\n      name: group.name,\n      stage: group.stage,\n      displayOrder: group.displayOrder || null,\n      createdAt\n    };\n    this.groups.set(id, newGroup);\n    return newGroup;\n  }\n\n  async updateGroup(id: string, group: Partial<InsertGroup>): Promise<Group | undefined> {\n    const existing = this.groups.get(id);\n    if (!existing) return undefined;\n    const updated = { ...existing, ...group };\n    this.groups.set(id, updated);\n    return updated;\n  }\n\n  async deleteGroup(id: string): Promise<boolean> {\n    const deleted = this.groups.delete(id);\n    if (deleted) {\n      // إزالة ارتباط الطلاب بالمجموعة\n      for (const [studentId, student] of this.students.entries()) {\n        if (student.groupId === id) {\n          this.students.set(studentId, { ...student, groupId: null });\n        }\n      }\n      // إزالة ارتباط المعلمين بالمجموعة\n      for (const [tgId, tg] of this.teacherGroups.entries()) {\n        if (tg.groupId === id) {\n          this.teacherGroups.delete(tgId);\n        }\n      }\n    }\n    return deleted;\n  }\n\n  // Special Statuses\n  async getSpecialStatuses(): Promise<SpecialStatus[]> {\n    return Array.from(this.specialStatuses.values()).sort((a, b) => \n      a.name.localeCompare(b.name)\n    );\n  }\n\n  async getSpecialStatusById(id: string): Promise<SpecialStatus | undefined> {\n    return this.specialStatuses.get(id);\n  }\n\n  async createSpecialStatus(status: InsertSpecialStatus): Promise<SpecialStatus> {\n    const id = crypto.randomUUID();\n    const createdAt = new Date();\n    const newStatus: SpecialStatus = { ...status, id, createdAt };\n    this.specialStatuses.set(id, newStatus);\n    return newStatus;\n  }\n\n  async updateSpecialStatus(id: string, status: Partial<InsertSpecialStatus>): Promise<SpecialStatus | undefined> {\n    const existing = this.specialStatuses.get(id);\n    if (!existing) return undefined;\n    const updated = { ...existing, ...status };\n    this.specialStatuses.set(id, updated);\n    return updated;\n  }\n\n  async deleteSpecialStatus(id: string): Promise<boolean> {\n    return this.specialStatuses.delete(id);\n  }\n\n  // Students\n  async getStudents(): Promise<Student[]> {\n    return Array.from(this.students.values()).sort((a, b) => \n      a.name.localeCompare(b.name)\n    );\n  }\n\n  async getStudentById(id: string): Promise<Student | undefined> {\n    return this.students.get(id);\n  }\n\n  async createStudent(student: InsertStudent): Promise<Student> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const newStudent: Student = { \n      name: student.name,\n      nationalId: student.nationalId,\n      phone: student.phone,\n      guardianPhone: student.guardianPhone,\n      grade: student.grade,\n      groupId: student.groupId || null,\n      status: student.status || 'نشط',\n      specialStatusId: student.specialStatusId || null,\n      visitCount: student.visitCount || 0,\n      permissionCount: student.permissionCount || 0,\n      violationCount: student.violationCount || 0,\n      id, \n      createdAt: now, \n      updatedAt: now\n    };\n    this.students.set(id, newStudent);\n    return newStudent;\n  }\n\n  async updateStudent(id: string, student: Partial<InsertStudent>): Promise<Student | undefined> {\n    const existing = this.students.get(id);\n    if (!existing) return undefined;\n    const now = new Date();\n    const updated = { ...existing, ...student, updatedAt: now };\n    this.students.set(id, updated);\n    return updated;\n  }\n\n  async deleteStudent(id: string): Promise<boolean> {\n    return this.students.delete(id);\n  }\n\n  async createManyStudents(studentsData: InsertStudent[]): Promise<Student[]> {\n    const now = new Date();\n    const newStudents = studentsData.map(s => {\n      const id = crypto.randomUUID();\n      const student: Student = {\n        name: s.name,\n        nationalId: s.nationalId,\n        phone: s.phone,\n        guardianPhone: s.guardianPhone,\n        grade: s.grade,\n        groupId: s.groupId || null,\n        status: s.status || 'نشط',\n        specialStatusId: s.specialStatusId || null,\n        visitCount: s.visitCount || 0,\n        permissionCount: s.permissionCount || 0,\n        violationCount: s.violationCount || 0,\n        id,\n        createdAt: now,\n        updatedAt: now\n      };\n      this.students.set(id, student);\n      return student;\n    });\n    return newStudents;\n  }\n\n  // Teachers\n  async getTeachers(): Promise<Teacher[]> {\n    return Array.from(this.teachers.values()).sort((a, b) => \n      a.name.localeCompare(b.name)\n    );\n  }\n\n  async getTeacherById(id: string): Promise<Teacher | undefined> {\n    return this.teachers.get(id);\n  }\n\n  async createTeacher(teacher: InsertTeacher): Promise<Teacher> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const newTeacher: Teacher = { ...teacher, id, createdAt: now, updatedAt: now };\n    this.teachers.set(id, newTeacher);\n    return newTeacher;\n  }\n\n  async updateTeacher(id: string, teacher: Partial<InsertTeacher>): Promise<Teacher | undefined> {\n    const existing = this.teachers.get(id);\n    if (!existing) return undefined;\n    const updated = { ...existing, ...teacher };\n    this.teachers.set(id, updated);\n    return updated;\n  }\n\n  async deleteTeacher(id: string): Promise<boolean> {\n    return this.teachers.delete(id);\n  }\n\n  // Teacher Groups\n  async getTeacherGroups(): Promise<TeacherGroup[]> {\n    return Array.from(this.teacherGroups.values());\n  }\n\n  async getTeacherGroupsByTeacherId(teacherId: string): Promise<TeacherGroup[]> {\n    return Array.from(this.teacherGroups.values()).filter(tg => tg.teacherId === teacherId);\n  }\n\n  async createTeacherGroup(teacherGroup: InsertTeacherGroup): Promise<TeacherGroup> {\n    const id = crypto.randomUUID();\n    const createdAt = new Date();\n    const newTG: TeacherGroup = { \n      id, \n      teacherId: teacherGroup.teacherId || null,\n      groupId: teacherGroup.groupId || null,\n      createdAt\n    };\n    this.teacherGroups.set(id, newTG);\n    return newTG;\n  }\n\n  async deleteTeacherGroup(id: string): Promise<boolean> {\n    return this.teacherGroups.delete(id);\n  }\n\n  // Student Visits\n  async getStudentVisits(): Promise<StudentVisit[]> {\n    return Array.from(this.studentVisits.values()).sort((a, b) => \n      new Date(b.visitDate).getTime() - new Date(a.visitDate).getTime()\n    );\n  }\n\n  async getStudentVisitsByStudentId(studentId: string): Promise<StudentVisit[]> {\n    return Array.from(this.studentVisits.values())\n      .filter(v => v.studentId === studentId)\n      .sort((a, b) => new Date(b.visitDate).getTime() - new Date(a.visitDate).getTime());\n  }\n\n  async createStudentVisit(visit: InsertStudentVisit): Promise<StudentVisit> {\n    const id = crypto.randomUUID();\n    const createdAt = new Date();\n    const newVisit: StudentVisit = { \n      id,\n      studentId: visit.studentId || null,\n      visitDate: visit.visitDate,\n      reason: visit.reason,\n      actionTaken: visit.actionTaken,\n      referredTo: visit.referredTo || 'لا يوجد',\n      notes: visit.notes || null,\n      createdAt\n    };\n    this.studentVisits.set(id, newVisit);\n    \n    // تحديث عداد الزيارات للطالب\n    if (visit.studentId) {\n      const student = this.students.get(visit.studentId);\n      if (student) {\n        this.students.set(visit.studentId, {\n          ...student,\n          visitCount: (student.visitCount || 0) + 1\n        });\n      }\n    }\n    \n    return newVisit;\n  }\n\n  async deleteStudentVisit(id: string): Promise<boolean> {\n    const visit = this.studentVisits.get(id);\n    const deleted = this.studentVisits.delete(id);\n    \n    if (deleted && visit && visit.studentId) {\n      // تحديث عداد الزيارات للطالب\n      const student = this.students.get(visit.studentId);\n      if (student && (student.visitCount || 0) > 0) {\n        this.students.set(visit.studentId, {\n          ...student,\n          visitCount: (student.visitCount || 1) - 1\n        });\n      }\n    }\n    \n    return deleted;\n  }\n\n  // Student Permissions\n  async getStudentPermissions(): Promise<StudentPermission[]> {\n    return Array.from(this.studentPermissions.values()).sort((a, b) => \n      new Date(b.permissionDate).getTime() - new Date(a.permissionDate).getTime()\n    );\n  }\n\n  async getStudentPermissionsByStudentId(studentId: string): Promise<StudentPermission[]> {\n    return Array.from(this.studentPermissions.values())\n      .filter(p => p.studentId === studentId)\n      .sort((a, b) => new Date(b.permissionDate).getTime() - new Date(a.permissionDate).getTime());\n  }\n\n  async createStudentPermission(permission: InsertStudentPermission): Promise<StudentPermission> {\n    const id = crypto.randomUUID();\n    const createdAt = new Date();\n    const newPermission: StudentPermission = { \n      id,\n      studentId: permission.studentId || null,\n      permissionDate: permission.permissionDate,\n      exitTime: permission.exitTime || null,\n      reason: permission.reason,\n      guardianNotified: permission.guardianNotified || null,\n      notes: permission.notes || null,\n      createdAt\n    };\n    this.studentPermissions.set(id, newPermission);\n    \n    // تحديث عداد الاستئذانات للطالب\n    if (permission.studentId) {\n      const student = this.students.get(permission.studentId);\n      if (student) {\n        this.students.set(permission.studentId, {\n          ...student,\n          permissionCount: (student.permissionCount || 0) + 1\n        });\n      }\n    }\n    \n    return newPermission;\n  }\n\n  async deleteStudentPermission(id: string): Promise<boolean> {\n    const permission = this.studentPermissions.get(id);\n    const deleted = this.studentPermissions.delete(id);\n    \n    if (deleted && permission && permission.studentId) {\n      // تحديث عداد الاستئذانات للطالب\n      const student = this.students.get(permission.studentId);\n      if (student && (student.permissionCount || 0) > 0) {\n        this.students.set(permission.studentId, {\n          ...student,\n          permissionCount: (student.permissionCount || 1) - 1\n        });\n      }\n    }\n    \n    return deleted;\n  }\n\n  // Student Violations\n  async getStudentViolations(): Promise<StudentViolation[]> {\n    return Array.from(this.studentViolations.values()).sort((a, b) => \n      new Date(b.violationDate).getTime() - new Date(a.violationDate).getTime()\n    );\n  }\n\n  async getStudentViolationsByStudentId(studentId: string): Promise<StudentViolation[]> {\n    return Array.from(this.studentViolations.values())\n      .filter(v => v.studentId === studentId)\n      .sort((a, b) => new Date(b.violationDate).getTime() - new Date(a.violationDate).getTime());\n  }\n\n  async createStudentViolation(violation: InsertStudentViolation): Promise<StudentViolation> {\n    const id = crypto.randomUUID();\n    const createdAt = new Date();\n    const newViolation: StudentViolation = { \n      id,\n      studentId: violation.studentId || null,\n      violationDate: violation.violationDate,\n      violationType: violation.violationType,\n      description: violation.description || null,\n      actionTaken: violation.actionTaken || null,\n      notes: violation.notes || null,\n      createdAt\n    };\n    this.studentViolations.set(id, newViolation);\n    \n    // تحديث عداد المخالفات للطالب\n    if (violation.studentId) {\n      const student = this.students.get(violation.studentId);\n      if (student) {\n        this.students.set(violation.studentId, {\n          ...student,\n          violationCount: (student.violationCount || 0) + 1\n        });\n      }\n    }\n    \n    return newViolation;\n  }\n\n  async deleteStudentViolation(id: string): Promise<boolean> {\n    const violation = this.studentViolations.get(id);\n    const deleted = this.studentViolations.delete(id);\n    \n    if (deleted && violation && violation.studentId) {\n      // تحديث عداد المخالفات للطالب\n      const student = this.students.get(violation.studentId);\n      if (student && (student.violationCount || 0) > 0) {\n        this.students.set(violation.studentId, {\n          ...student,\n          violationCount: (student.violationCount || 1) - 1\n        });\n      }\n    }\n    \n    return deleted;\n  }\n\n  // Teacher Profile\n  async getTeacherProfile(): Promise<TeacherProfile | undefined> {\n    return this.teacherProfileData;\n  }\n\n  async createOrUpdateTeacherProfile(profile: InsertTeacherProfile): Promise<TeacherProfile> {\n    const id = this.teacherProfileData?.id || crypto.randomUUID();\n    const createdAt = this.teacherProfileData?.createdAt || new Date();\n    this.teacherProfileData = { \n      id,\n      name: profile.name || null,\n      phone: profile.phone || null,\n      schoolName: profile.schoolName || null,\n      systemTitle: profile.systemTitle || null,\n      logoUrl: profile.logoUrl || null,\n      autoLogoutMinutes: profile.autoLogoutMinutes || null,\n      createdAt\n    };\n    return this.teacherProfileData;\n  }\n\n  // Login Credentials\n  async getLoginCredentials(username: string): Promise<LoginCredentials | undefined> {\n    return Array.from(this.credentials.values()).find(c => c.username === username);\n  }\n\n  async createLoginCredentials(credentials: InsertLoginCredentials): Promise<LoginCredentials> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    const newCredentials: LoginCredentials = { \n      id,\n      username: credentials.username,\n      passwordHash: credentials.passwordHash,\n      resetToken: credentials.resetToken || null,\n      resetTokenExpires: credentials.resetTokenExpires || null,\n      createdAt: now,\n      updatedAt: now\n    };\n    this.credentials.set(id, newCredentials);\n    return newCredentials;\n  }\n\n  async updateLoginCredentials(id: string, credentials: Partial<InsertLoginCredentials>): Promise<LoginCredentials | undefined> {\n    const existing = this.credentials.get(id);\n    if (!existing) return undefined;\n    const updated = { ...existing, ...credentials };\n    this.credentials.set(id, updated);\n    return updated;\n  }\n\n  // Password Reset\n  async createPasswordResetToken(username: string): Promise<{ token: string, expiresAt: string } | null> {\n    const credential = Array.from(this.credentials.values()).find(c => c.username === username);\n    if (!credential) return null;\n\n    const token = Math.floor(100000 + Math.random() * 900000).toString();\n    const expiresAt = new Date(Date.now() + 15 * 60 * 1000).toISOString();\n\n    this.credentials.set(credential.id, {\n      ...credential,\n      resetToken: token,\n      resetTokenExpires: expiresAt\n    });\n\n    return { token, expiresAt };\n  }\n\n  async verifyPasswordResetToken(username: string, token: string): Promise<boolean> {\n    const credential = Array.from(this.credentials.values()).find(c => c.username === username);\n    if (!credential || !credential.resetToken || !credential.resetTokenExpires) return false;\n\n    const isValid = credential.resetToken === token && \n                   new Date(credential.resetTokenExpires) > new Date();\n    return isValid;\n  }\n\n  async resetPassword(username: string, token: string, newPassword: string): Promise<boolean> {\n    const isValid = await this.verifyPasswordResetToken(username, token);\n    if (!isValid) return false;\n\n    const credential = Array.from(this.credentials.values()).find(c => c.username === username);\n    if (!credential) return false;\n\n    this.credentials.set(credential.id, {\n      ...credential,\n      passwordHash: newPassword,\n      resetToken: null,\n      resetTokenExpires: null\n    });\n\n    return true;\n  }\n\n  // Clear Database\n  async clearDatabase(): Promise<void> {\n    this.students.clear();\n    this.teachers.clear();\n    this.groups.clear();\n    this.teacherGroups.clear();\n    this.studentVisits.clear();\n    this.studentPermissions.clear();\n    this.studentViolations.clear();\n    this.specialStatuses.clear();\n    this.credentials.clear();\n    this.teacherProfileData = undefined;\n  }\n\n  // Import Data (preserves IDs)\n  async importData(data: any): Promise<void> {\n    try {\n      // استيراد الملف الشخصي\n      if (data.profile) {\n        this.teacherProfileData = data.profile;\n      }\n\n      // إنشاء حساب admin افتراضي\n      const adminId = crypto.randomUUID();\n      const now = new Date();\n      this.credentials.set(adminId, {\n        id: adminId,\n        username: 'admin',\n        passwordHash: 'admin123',\n        resetToken: null,\n        resetTokenExpires: null,\n        createdAt: now,\n        updatedAt: now\n      });\n\n      // استيراد الحالات الخاصة\n      if (data.special_statuses && Array.isArray(data.special_statuses)) {\n        for (const status of data.special_statuses) {\n          if (!status || !status.id) {\n            throw new Error('Invalid special status record: missing id');\n          }\n          this.specialStatuses.set(status.id, status);\n        }\n      }\n\n      // استيراد المجموعات\n      if (data.groups && Array.isArray(data.groups)) {\n        for (const group of data.groups) {\n          if (!group || !group.id) {\n            throw new Error('Invalid group record: missing id');\n          }\n          this.groups.set(group.id, group);\n        }\n      }\n\n      // استيراد الطلاب\n      if (data.students && Array.isArray(data.students)) {\n        for (const student of data.students) {\n          if (!student || !student.id) {\n            throw new Error('Invalid student record: missing id');\n          }\n          this.students.set(student.id, student);\n        }\n      }\n\n      // استيراد المعلمين\n      if (data.teachers && Array.isArray(data.teachers)) {\n        for (const teacher of data.teachers) {\n          if (!teacher || !teacher.id) {\n            throw new Error('Invalid teacher record: missing id');\n          }\n          this.teachers.set(teacher.id, teacher);\n        }\n      }\n\n      // استيراد ربط المعلمين بالمجموعات\n      if (data.teacher_groups && Array.isArray(data.teacher_groups)) {\n        for (const tg of data.teacher_groups) {\n          if (!tg || !tg.id) {\n            throw new Error('Invalid teacher_group record: missing id');\n          }\n          this.teacherGroups.set(tg.id, tg);\n        }\n      }\n\n      // استيراد الزيارات\n      if (data.visits && Array.isArray(data.visits)) {\n        for (const visit of data.visits) {\n          if (!visit || !visit.id) {\n            throw new Error('Invalid visit record: missing id');\n          }\n          this.studentVisits.set(visit.id, visit);\n        }\n      }\n\n      // استيراد الاستئذانات\n      if (data.permissions && Array.isArray(data.permissions)) {\n        for (const permission of data.permissions) {\n          if (!permission || !permission.id) {\n            throw new Error('Invalid permission record: missing id');\n          }\n          this.studentPermissions.set(permission.id, permission);\n        }\n      }\n\n      // استيراد المخالفات\n      if (data.violations && Array.isArray(data.violations)) {\n        for (const violation of data.violations) {\n          if (!violation || !violation.id) {\n            throw new Error('Invalid violation record: missing id');\n          }\n          this.studentViolations.set(violation.id, violation);\n        }\n      }\n    } catch (error) {\n      // في حالة حدوث خطأ، سيتم رمي exception لـ endpoint\n      throw error;\n    }\n  }\n}\n\nexport const storage = new MemStorage();\n","size_bytes":21146},"client/src/lib/indexedDBWrapper.ts":{"content":"import { db } from './db'\n\n// نوع البيانات المرجعة من Supabase\ntype SupabaseResponse<T> = {\n  data: T | null\n  error: any\n}\n\n// بناء الاستعلام - يحاكي Supabase Query Builder\nclass QueryBuilder<T = any> {\n  private tableName: string\n  private filters: Array<(item: any) => boolean> = []\n  private orderByField?: string\n  private orderDirection: 'asc' | 'desc' = 'asc'\n  private selectedFields: string = '*'\n  private limitValue?: number\n\n  constructor(tableName: string) {\n    this.tableName = tableName\n  }\n\n  select(fields: string = '*'): this {\n    this.selectedFields = fields\n    return this\n  }\n\n  eq(field: string, value: any): this {\n    this.filters.push((item) => item[field] === value)\n    return this\n  }\n\n  neq(field: string, value: any): this {\n    this.filters.push((item) => item[field] !== value)\n    return this\n  }\n\n  gte(field: string, value: any): this {\n    this.filters.push((item) => {\n      const itemValue = item[field]\n      if (itemValue instanceof Date || typeof itemValue === 'string') {\n        return new Date(itemValue) >= new Date(value)\n      }\n      return itemValue >= value\n    })\n    return this\n  }\n\n  lte(field: string, value: any): this {\n    this.filters.push((item) => {\n      const itemValue = item[field]\n      if (itemValue instanceof Date || typeof itemValue === 'string') {\n        return new Date(itemValue) <= new Date(value)\n      }\n      return itemValue <= value\n    })\n    return this\n  }\n\n  gt(field: string, value: any): this {\n    this.filters.push((item) => {\n      const itemValue = item[field]\n      if (itemValue instanceof Date || typeof itemValue === 'string') {\n        return new Date(itemValue) > new Date(value)\n      }\n      return itemValue > value\n    })\n    return this\n  }\n\n  lt(field: string, value: any): this {\n    this.filters.push((item) => {\n      const itemValue = item[field]\n      if (itemValue instanceof Date || typeof itemValue === 'string') {\n        return new Date(itemValue) < new Date(value)\n      }\n      return itemValue < value\n    })\n    return this\n  }\n\n  order(field: string, options?: { ascending?: boolean }): this {\n    this.orderByField = field\n    this.orderDirection = options?.ascending === false ? 'desc' : 'asc'\n    return this\n  }\n\n  limit(count: number): this {\n    this.limitValue = count\n    return this\n  }\n\n  // تنفيذ الاستعلام وإرجاع النتائج\n  async execute(): Promise<SupabaseResponse<T[]>> {\n    try {\n      const table = this.getTable()\n      let items = await table.toArray()\n\n      // تطبيق الفلاتر\n      for (const filter of this.filters) {\n        items = items.filter(filter)\n      }\n\n      // الترتيب\n      if (this.orderByField) {\n        items.sort((a, b) => {\n          const aVal = a[this.orderByField!]\n          const bVal = b[this.orderByField!]\n          \n          let comparison = 0\n          if (aVal < bVal) comparison = -1\n          if (aVal > bVal) comparison = 1\n          \n          return this.orderDirection === 'asc' ? comparison : -comparison\n        })\n      }\n\n      // التحديد (Limit)\n      if (this.limitValue) {\n        items = items.slice(0, this.limitValue)\n      }\n\n      return { data: items as T[], error: null }\n    } catch (error) {\n      console.error('IndexedDB query error:', error)\n      return { data: null, error }\n    }\n  }\n\n  // للحصول على عنصر واحد فقط\n  async maybeSingle(): Promise<SupabaseResponse<T>> {\n    try {\n      const result = await this.execute()\n      if (result.error) return { data: null, error: result.error }\n      return { \n        data: result.data && result.data.length > 0 ? result.data[0] as T : null, \n        error: null \n      }\n    } catch (error) {\n      return { data: null, error }\n    }\n  }\n\n  async single(): Promise<SupabaseResponse<T>> {\n    return this.maybeSingle()\n  }\n\n  // الإدراج\n  async insert(data: any): Promise<SupabaseResponse<T>> {\n    try {\n      const table = this.getTable()\n      \n      // التعامل مع الإدراج المتعدد\n      if (Array.isArray(data)) {\n        const ids = await Promise.all(\n          data.map(async (item) => {\n            const id = item.id || crypto.randomUUID()\n            const now = new Date().toISOString()\n            const record = {\n              ...item,\n              id,\n              created_at: item.created_at || now,\n              updated_at: item.updated_at || now\n            }\n            await table.put(record)\n            return record\n          })\n        )\n        return { data: ids as any, error: null }\n      } else {\n        // إدراج واحد\n        const id = data.id || crypto.randomUUID()\n        const now = new Date().toISOString()\n        const record = {\n          ...data,\n          id,\n          created_at: data.created_at || now,\n          updated_at: data.updated_at || now\n        }\n        await table.put(record)\n        return { data: record as T, error: null }\n      }\n    } catch (error) {\n      console.error('IndexedDB insert error:', error)\n      return { data: null, error }\n    }\n  }\n\n  // التحديث\n  async update(data: any): Promise<SupabaseResponse<T>> {\n    try {\n      const table = this.getTable()\n      let items = await table.toArray()\n\n      // تطبيق الفلاتر لإيجاد العناصر المطلوب تحديثها\n      for (const filter of this.filters) {\n        items = items.filter(filter)\n      }\n\n      const now = new Date().toISOString()\n      const updatedItems = await Promise.all(\n        items.map(async (item) => {\n          const updated = {\n            ...item,\n            ...data,\n            updated_at: now\n          }\n          await table.put(updated)\n          return updated\n        })\n      )\n\n      return { \n        data: updatedItems.length > 0 ? updatedItems[0] as T : null, \n        error: null \n      }\n    } catch (error) {\n      console.error('IndexedDB update error:', error)\n      return { data: null, error }\n    }\n  }\n\n  // الحذف\n  async delete(): Promise<SupabaseResponse<null>> {\n    try {\n      const table = this.getTable()\n      let items = await table.toArray()\n\n      // تطبيق الفلاتر لإيجاد العناصر المطلوب حذفها\n      for (const filter of this.filters) {\n        items = items.filter(filter)\n      }\n\n      await Promise.all(\n        items.map((item) => table.delete(item.id))\n      )\n\n      return { data: null, error: null }\n    } catch (error) {\n      console.error('IndexedDB delete error:', error)\n      return { data: null, error }\n    }\n  }\n\n  // الحصول على الجدول المناسب من IndexedDB\n  private getTable() {\n    switch (this.tableName) {\n      case 'students':\n        return db.students\n      case 'groups':\n        return db.groups\n      case 'special_statuses':\n        return db.special_statuses\n      case 'student_visits':\n        return db.student_visits\n      case 'student_permissions':\n        return db.student_permissions\n      case 'student_violations':\n        return db.student_violations\n      case 'teachers':\n        return db.teachers\n      case 'teacher_groups':\n        return db.teacher_groups\n      case 'teacher_profile':\n        return db.teacher_profile\n      case 'login_credentials':\n        return db.login_credentials\n      default:\n        throw new Error(`Unknown table: ${this.tableName}`)\n    }\n  }\n}\n\n// محاكاة Supabase Client\nexport class IndexedDBClient {\n  from(tableName: string) {\n    const builder = new QueryBuilder(tableName)\n    \n    // إنشاء proxy يدعم chaining كامل\n    const createChainableBuilder = (currentBuilder: QueryBuilder) => {\n      return new Proxy(currentBuilder, {\n        get(target: any, prop: string) {\n          // إذا كان method موجود في QueryBuilder\n          if (prop in target && typeof target[prop] === 'function') {\n            return (...args: any[]) => {\n              const result = target[prop](...args)\n              // إرجاع proxy جديد للسماح بالـ chaining\n              if (result === target) {\n                return createChainableBuilder(result)\n              }\n              return result\n            }\n          }\n          \n          // دعم خاص لـ then للسماح بـ Promise behavior\n          if (prop === 'then') {\n            return (resolve: any, reject: any) => target.execute().then(resolve, reject)\n          }\n          \n          return target[prop]\n        }\n      })\n    }\n    \n    return {\n      select: (fields?: string) => {\n        const selectBuilder = builder.select(fields || '*')\n        return createChainableBuilder(selectBuilder)\n      },\n      insert: (data: any) => {\n        const insertPromise = builder.insert(data)\n        return {\n          select: (fields?: string) => {\n            return {\n              maybeSingle: () => insertPromise,\n              single: () => insertPromise,\n              then: (resolve: any, reject: any) => insertPromise.then(resolve, reject)\n            }\n          },\n          then: (resolve: any, reject: any) => insertPromise.then(resolve, reject)\n        }\n      },\n      update: (data: any) => {\n        return {\n          eq: (field: string, value: any) => {\n            builder.eq(field, value)\n            const updatePromise = builder.update(data)\n            return {\n              select: (fields?: string) => {\n                return {\n                  maybeSingle: () => updatePromise,\n                  single: () => updatePromise,\n                  then: (resolve: any, reject: any) => updatePromise.then(resolve, reject)\n                }\n              },\n              then: (resolve: any, reject: any) => updatePromise.then(resolve, reject)\n            }\n          },\n          then: (resolve: any, reject: any) => builder.update(data).then(resolve, reject)\n        }\n      },\n      delete: () => {\n        return {\n          eq: (field: string, value: any) => {\n            builder.eq(field, value)\n            const deletePromise = builder.delete()\n            return {\n              then: (resolve: any, reject: any) => deletePromise.then(resolve, reject)\n            }\n          },\n          then: (resolve: any, reject: any) => builder.delete().then(resolve, reject)\n        }\n      }\n    }\n  }\n}\n\nexport const indexedDBClient = new IndexedDBClient()\n","size_bytes":10351},"server/pgStorage.ts":{"content":"import { drizzle } from 'drizzle-orm/neon-serverless';\nimport { Pool, neonConfig } from '@neondatabase/serverless';\nimport { eq, asc, sql } from 'drizzle-orm';\nimport * as schema from '../shared/schema.js';\nimport ws from 'ws';\n\nneonConfig.webSocketConstructor = ws;\nimport type {\n  Student, InsertStudent,\n  Group, InsertGroup,\n  SpecialStatus, InsertSpecialStatus,\n  Teacher, InsertTeacher,\n  TeacherGroup, InsertTeacherGroup,\n  StudentVisit, InsertStudentVisit,\n  StudentPermission, InsertStudentPermission,\n  StudentViolation, InsertStudentViolation,\n  TeacherProfile, InsertTeacherProfile,\n  LoginCredentials, InsertLoginCredentials\n} from \"../shared/schema.js\";\nimport type { IStorage } from \"./storage.js\";\n\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\nconst db = drizzle(pool, { schema });\n\nexport class PgStorage implements IStorage {\n  // Groups\n  async getGroups(): Promise<Group[]> {\n    return await db.select().from(schema.groups).orderBy(asc(schema.groups.stage), asc(schema.groups.displayOrder));\n  }\n\n  async getGroupById(id: string): Promise<Group | undefined> {\n    const results = await db.select().from(schema.groups).where(eq(schema.groups.id, id));\n    return results[0];\n  }\n\n  async createGroup(group: InsertGroup): Promise<Group> {\n    const id = crypto.randomUUID();\n    const results = await db.insert(schema.groups).values({ ...group, id }).returning();\n    return results[0];\n  }\n\n  async updateGroup(id: string, group: Partial<InsertGroup>): Promise<Group | undefined> {\n    const results = await db.update(schema.groups).set(group).where(eq(schema.groups.id, id)).returning();\n    return results[0];\n  }\n\n  async deleteGroup(id: string): Promise<boolean> {\n    // تحديث الطلاب المرتبطين\n    await db.update(schema.students).set({ groupId: null }).where(eq(schema.students.groupId, id));\n    // حذف ارتباطات المعلمين\n    await db.delete(schema.teacherGroups).where(eq(schema.teacherGroups.groupId, id));\n    // حذف المجموعة\n    const results = await db.delete(schema.groups).where(eq(schema.groups.id, id)).returning();\n    return results.length > 0;\n  }\n\n  // Special Statuses\n  async getSpecialStatuses(): Promise<SpecialStatus[]> {\n    return await db.select().from(schema.specialStatuses).orderBy(asc(schema.specialStatuses.name));\n  }\n\n  async getSpecialStatusById(id: string): Promise<SpecialStatus | undefined> {\n    const results = await db.select().from(schema.specialStatuses).where(eq(schema.specialStatuses.id, id));\n    return results[0];\n  }\n\n  async createSpecialStatus(status: InsertSpecialStatus): Promise<SpecialStatus> {\n    const id = crypto.randomUUID();\n    const results = await db.insert(schema.specialStatuses).values({ ...status, id }).returning();\n    return results[0];\n  }\n\n  async updateSpecialStatus(id: string, status: Partial<InsertSpecialStatus>): Promise<SpecialStatus | undefined> {\n    const results = await db.update(schema.specialStatuses).set(status).where(eq(schema.specialStatuses.id, id)).returning();\n    return results[0];\n  }\n\n  async deleteSpecialStatus(id: string): Promise<boolean> {\n    const results = await db.delete(schema.specialStatuses).where(eq(schema.specialStatuses.id, id)).returning();\n    return results.length > 0;\n  }\n\n  // Students\n  async getStudents(): Promise<Student[]> {\n    return await db.select().from(schema.students).orderBy(asc(schema.students.name));\n  }\n\n  async getStudentById(id: string): Promise<Student | undefined> {\n    const results = await db.select().from(schema.students).where(eq(schema.students.id, id));\n    return results[0];\n  }\n\n  async createStudent(student: InsertStudent): Promise<Student> {\n    const id = crypto.randomUUID();\n    const results = await db.insert(schema.students).values({ ...student, id }).returning();\n    return results[0];\n  }\n\n  async updateStudent(id: string, student: Partial<InsertStudent>): Promise<Student | undefined> {\n    const results = await db.update(schema.students).set({ ...student, updatedAt: new Date() }).where(eq(schema.students.id, id)).returning();\n    return results[0];\n  }\n\n  async deleteStudent(id: string): Promise<boolean> {\n    // حذف السجلات المرتبطة\n    await db.delete(schema.studentVisits).where(eq(schema.studentVisits.studentId, id));\n    await db.delete(schema.studentPermissions).where(eq(schema.studentPermissions.studentId, id));\n    await db.delete(schema.studentViolations).where(eq(schema.studentViolations.studentId, id));\n    // حذف الطالب\n    const results = await db.delete(schema.students).where(eq(schema.students.id, id)).returning();\n    return results.length > 0;\n  }\n\n  async createManyStudents(students: InsertStudent[]): Promise<Student[]> {\n    const studentsWithIds = students.map(s => ({\n      ...s,\n      id: crypto.randomUUID()\n    }));\n    return await db.insert(schema.students).values(studentsWithIds).returning();\n  }\n\n  // Teachers\n  async getTeachers(): Promise<Teacher[]> {\n    return await db.select().from(schema.teachers).orderBy(asc(schema.teachers.name));\n  }\n\n  async getTeacherById(id: string): Promise<Teacher | undefined> {\n    const results = await db.select().from(schema.teachers).where(eq(schema.teachers.id, id));\n    return results[0];\n  }\n\n  async createTeacher(teacher: InsertTeacher): Promise<Teacher> {\n    const id = crypto.randomUUID();\n    const results = await db.insert(schema.teachers).values({ ...teacher, id }).returning();\n    return results[0];\n  }\n\n  async updateTeacher(id: string, teacher: Partial<InsertTeacher>): Promise<Teacher | undefined> {\n    const results = await db.update(schema.teachers).set({ ...teacher, updatedAt: new Date() }).where(eq(schema.teachers.id, id)).returning();\n    return results[0];\n  }\n\n  async deleteTeacher(id: string): Promise<boolean> {\n    await db.delete(schema.teacherGroups).where(eq(schema.teacherGroups.teacherId, id));\n    const results = await db.delete(schema.teachers).where(eq(schema.teachers.id, id)).returning();\n    return results.length > 0;\n  }\n\n  // Teacher Groups\n  async getTeacherGroups(): Promise<TeacherGroup[]> {\n    return await db.select().from(schema.teacherGroups);\n  }\n\n  async getTeacherGroupsByTeacherId(teacherId: string): Promise<TeacherGroup[]> {\n    return await db.select().from(schema.teacherGroups).where(eq(schema.teacherGroups.teacherId, teacherId));\n  }\n\n  async createTeacherGroup(teacherGroup: InsertTeacherGroup): Promise<TeacherGroup> {\n    const id = crypto.randomUUID();\n    const results = await db.insert(schema.teacherGroups).values({ ...teacherGroup, id }).returning();\n    return results[0];\n  }\n\n  async deleteTeacherGroup(id: string): Promise<boolean> {\n    const results = await db.delete(schema.teacherGroups).where(eq(schema.teacherGroups.id, id)).returning();\n    return results.length > 0;\n  }\n\n  // Student Visits\n  async getStudentVisits(): Promise<StudentVisit[]> {\n    return await db.select().from(schema.studentVisits).orderBy(asc(schema.studentVisits.visitDate));\n  }\n\n  async getStudentVisitsByStudentId(studentId: string): Promise<StudentVisit[]> {\n    return await db.select().from(schema.studentVisits).where(eq(schema.studentVisits.studentId, studentId));\n  }\n\n  async createStudentVisit(visit: InsertStudentVisit): Promise<StudentVisit> {\n    return await db.transaction(async (tx) => {\n      const id = crypto.randomUUID();\n      const results = await tx.insert(schema.studentVisits).values({ ...visit, id }).returning();\n      \n      // تحديث عداد الزيارات للطالب بشكل ذري (مع معالجة NULL)\n      if (visit.studentId) {\n        await tx.update(schema.students)\n          .set({ visitCount: sql`COALESCE(visit_count, 0) + 1` })\n          .where(eq(schema.students.id, visit.studentId));\n      }\n      \n      return results[0];\n    });\n  }\n\n  async deleteStudentVisit(id: string): Promise<boolean> {\n    return await db.transaction(async (tx) => {\n      // الحصول على معرف الطالب قبل الحذف\n      const visitToDelete = await tx.select().from(schema.studentVisits).where(eq(schema.studentVisits.id, id));\n      if (visitToDelete.length === 0) return false;\n      \n      const studentId = visitToDelete[0].studentId;\n      const results = await tx.delete(schema.studentVisits).where(eq(schema.studentVisits.id, id)).returning();\n      \n      // تقليل عداد الزيارات (مع حماية من NULL والسالب)\n      if (studentId) {\n        await tx.update(schema.students)\n          .set({ visitCount: sql`GREATEST(0, COALESCE(visit_count, 0) - 1)` })\n          .where(eq(schema.students.id, studentId));\n      }\n      \n      return results.length > 0;\n    });\n  }\n\n  // Student Permissions\n  async getStudentPermissions(): Promise<StudentPermission[]> {\n    return await db.select().from(schema.studentPermissions).orderBy(asc(schema.studentPermissions.permissionDate));\n  }\n\n  async getStudentPermissionsByStudentId(studentId: string): Promise<StudentPermission[]> {\n    return await db.select().from(schema.studentPermissions).where(eq(schema.studentPermissions.studentId, studentId));\n  }\n\n  async createStudentPermission(permission: InsertStudentPermission): Promise<StudentPermission> {\n    return await db.transaction(async (tx) => {\n      const id = crypto.randomUUID();\n      const results = await tx.insert(schema.studentPermissions).values({ ...permission, id }).returning();\n      \n      // تحديث عداد الاستئذانات وحالة الطالب بشكل ذري\n      if (permission.studentId) {\n        await tx.update(schema.students)\n          .set({ \n            permissionCount: sql`COALESCE(permission_count, 0) + 1`,\n            status: \"استئذان\"\n          })\n          .where(eq(schema.students.id, permission.studentId));\n      }\n      \n      return results[0];\n    });\n  }\n\n  async deleteStudentPermission(id: string): Promise<boolean> {\n    return await db.transaction(async (tx) => {\n      // الحصول على معرف الطالب قبل الحذف\n      const permissionToDelete = await tx.select().from(schema.studentPermissions).where(eq(schema.studentPermissions.id, id));\n      if (permissionToDelete.length === 0) return false;\n      \n      const studentId = permissionToDelete[0].studentId;\n      const results = await tx.delete(schema.studentPermissions).where(eq(schema.studentPermissions.id, id)).returning();\n      \n      // تقليل عداد الاستئذانات (مع حماية من NULL والسالب)\n      if (studentId) {\n        await tx.update(schema.students)\n          .set({ permissionCount: sql`GREATEST(0, COALESCE(permission_count, 0) - 1)` })\n          .where(eq(schema.students.id, studentId));\n      }\n      \n      return results.length > 0;\n    });\n  }\n\n  // Student Violations\n  async getStudentViolations(): Promise<StudentViolation[]> {\n    return await db.select().from(schema.studentViolations).orderBy(asc(schema.studentViolations.violationDate));\n  }\n\n  async getStudentViolationsByStudentId(studentId: string): Promise<StudentViolation[]> {\n    return await db.select().from(schema.studentViolations).where(eq(schema.studentViolations.studentId, studentId));\n  }\n\n  async createStudentViolation(violation: InsertStudentViolation): Promise<StudentViolation> {\n    return await db.transaction(async (tx) => {\n      const id = crypto.randomUUID();\n      const results = await tx.insert(schema.studentViolations).values({ ...violation, id }).returning();\n      \n      // تحديث عداد المخالفات للطالب بشكل ذري (مع معالجة NULL)\n      if (violation.studentId) {\n        await tx.update(schema.students)\n          .set({ violationCount: sql`COALESCE(violation_count, 0) + 1` })\n          .where(eq(schema.students.id, violation.studentId));\n      }\n      \n      return results[0];\n    });\n  }\n\n  async deleteStudentViolation(id: string): Promise<boolean> {\n    return await db.transaction(async (tx) => {\n      // الحصول على معرف الطالب قبل الحذف\n      const violationToDelete = await tx.select().from(schema.studentViolations).where(eq(schema.studentViolations.id, id));\n      if (violationToDelete.length === 0) return false;\n      \n      const studentId = violationToDelete[0].studentId;\n      const results = await tx.delete(schema.studentViolations).where(eq(schema.studentViolations.id, id)).returning();\n      \n      // تقليل عداد المخالفات (مع حماية من NULL والسالب)\n      if (studentId) {\n        await tx.update(schema.students)\n          .set({ violationCount: sql`GREATEST(0, COALESCE(violation_count, 0) - 1)` })\n          .where(eq(schema.students.id, studentId));\n      }\n      \n      return results.length > 0;\n    });\n  }\n\n  // Teacher Profile\n  async getTeacherProfile(): Promise<TeacherProfile | undefined> {\n    const results = await db.select().from(schema.teacherProfile).limit(1);\n    return results[0];\n  }\n\n  async createOrUpdateTeacherProfile(profile: InsertTeacherProfile): Promise<TeacherProfile> {\n    const existing = await this.getTeacherProfile();\n    if (existing) {\n      const results = await db.update(schema.teacherProfile).set(profile).where(eq(schema.teacherProfile.id, existing.id)).returning();\n      return results[0];\n    } else {\n      const id = crypto.randomUUID();\n      const results = await db.insert(schema.teacherProfile).values({ ...profile, id }).returning();\n      return results[0];\n    }\n  }\n\n  // Login Credentials\n  async getLoginCredentials(username: string): Promise<LoginCredentials | undefined> {\n    const results = await db.select().from(schema.loginCredentials).where(eq(schema.loginCredentials.username, username));\n    return results[0];\n  }\n\n  async createLoginCredentials(credentials: InsertLoginCredentials): Promise<LoginCredentials> {\n    const id = crypto.randomUUID();\n    const results = await db.insert(schema.loginCredentials).values({ ...credentials, id }).returning();\n    return results[0];\n  }\n\n  async updateLoginCredentials(id: string, credentials: Partial<InsertLoginCredentials>): Promise<LoginCredentials | undefined> {\n    const results = await db.update(schema.loginCredentials).set({ ...credentials, updatedAt: new Date() }).where(eq(schema.loginCredentials.id, id)).returning();\n    return results[0];\n  }\n\n  // Password Reset\n  async createPasswordResetToken(username: string): Promise<{ token: string, expiresAt: string } | null> {\n    const user = await this.getLoginCredentials(username);\n    if (!user) return null;\n\n    const token = Math.floor(100000 + Math.random() * 900000).toString();\n    const expiresAt = new Date(Date.now() + 30 * 60 * 1000).toISOString();\n\n    await this.updateLoginCredentials(user.id, {\n      resetToken: token,\n      resetTokenExpires: expiresAt\n    });\n\n    return { token, expiresAt };\n  }\n\n  async verifyPasswordResetToken(username: string, token: string): Promise<boolean> {\n    const user = await this.getLoginCredentials(username);\n    if (!user || !user.resetToken || !user.resetTokenExpires) return false;\n\n    const now = new Date();\n    const expiryDate = new Date(user.resetTokenExpires);\n\n    return user.resetToken === token && now < expiryDate;\n  }\n\n  async resetPassword(username: string, token: string, newPassword: string): Promise<boolean> {\n    const isValid = await this.verifyPasswordResetToken(username, token);\n    if (!isValid) return false;\n\n    const user = await this.getLoginCredentials(username);\n    if (!user) return false;\n\n    await this.updateLoginCredentials(user.id, {\n      passwordHash: newPassword,\n      resetToken: null,\n      resetTokenExpires: null\n    });\n\n    return true;\n  }\n\n  // Clear Database\n  async clearDatabase(): Promise<void> {\n    await db.delete(schema.studentViolations);\n    await db.delete(schema.studentPermissions);\n    await db.delete(schema.studentVisits);\n    await db.delete(schema.teacherGroups);\n    await db.delete(schema.students);\n    await db.delete(schema.teachers);\n    await db.delete(schema.groups);\n    await db.delete(schema.specialStatuses);\n  }\n\n  // Import Data (preserves IDs)\n  async importData(data: any): Promise<void> {\n    if (data.groups?.length) {\n      await db.insert(schema.groups).values(data.groups);\n    }\n    if (data.specialStatuses?.length) {\n      await db.insert(schema.specialStatuses).values(data.specialStatuses);\n    }\n    if (data.teachers?.length) {\n      await db.insert(schema.teachers).values(data.teachers);\n    }\n    if (data.students?.length) {\n      await db.insert(schema.students).values(data.students);\n    }\n    if (data.teacherGroups?.length) {\n      await db.insert(schema.teacherGroups).values(data.teacherGroups);\n    }\n    if (data.studentVisits?.length) {\n      await db.insert(schema.studentVisits).values(data.studentVisits);\n    }\n    if (data.studentPermissions?.length) {\n      await db.insert(schema.studentPermissions).values(data.studentPermissions);\n    }\n    if (data.studentViolations?.length) {\n      await db.insert(schema.studentViolations).values(data.studentViolations);\n    }\n    if (data.teacherProfile) {\n      await db.insert(schema.teacherProfile).values(data.teacherProfile);\n    }\n  }\n}\n","size_bytes":17171}},"version":2}